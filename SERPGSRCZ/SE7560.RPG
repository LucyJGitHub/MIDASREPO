     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE CO generation trades and depot movements')    *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  RPG/SE7560 - SE CO Generates Trades and Depot Movements      *
      *                                                               *
      *  Function:  This Program Generate Trades for Book records     *
      *  (COB)      with the actual stock allocation different than   *
      *             zero and Depot Movements for all Customers        *
      *             records with the actual stock allocation          *
      *             different than zero.                              *
      *                                                               *
      *  Called by: SEC7560 - Generate Trades & Depot Movements       *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. 248698             Date 01Jun20               *
      *  Prev Amend No. 258814             Date 22May20               *
      *                 MD046248           Date 27Oct17               *
      *                 226449             Date 24Jun15               *
      *                 MD034776           Date 09Jul15               *
      *                 AR1067108          Date 11Dec12               *
      *                 AR1001183A         Date 20Nov12               *
      *                 CCB020             Date 06Aug12               *
      *                 AR850932           Date 14Nov11               *
      *                 CRE073             Date 06Dec10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 234300             Date 29Sep06               *
      *                 240016             Date 24May06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027A            Date 06May06               *
      *                 CSD027             Date 09Dec05               *
      *                 CER001             Date 25Apr05               *
      *                 CSE075             Date 17Nov05               *
      *                 235041             Date 20Jul05               *
      *                 234829             Date 08Jul05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 229857             Date 07Oct04               *
      *                 221751             Date 09OCT03               *
      *                 221680             Date 03OCT03               *
      *                 220219             Date 12Aug03
      *                 216944             Date 30Apr03               *
      *                 215278             Date 17MAR03               *
      *                 226570             Date 27Jun04               *
      *                 219634             Date 21Aug03
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 194370             Date 12Jul01               *
      *                 CAS006             Date 21Jan03               *
      *                 217310             Date 21Jan03               *
      *                 CSE039             Date 23Apr03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 186486             Date 11Apr02               *
      * Midas Release 4.01.01 ----------------------------------------*
      *                 207006             Date 18Jun02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 193662             Date 30Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 193752             Date 27Jun01               *
      *                 190204             Date 31May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 16May01               *
      *                 183579             Date 31Jan01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 179732             Date 15Jun00               *
      *                 CSE020             Date 21Mar00               *
      *                 161732             Date 21Mar00               *
      *                 088864             Date 20Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE015             Date 06Dec99               *
      *                 CSE017             Date 20Oct99               *
      *                 CSE012             Date 16Aug99               *
      *                 CPB001             Date 07Sep99               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 166599             Date 06SEP99               *
      *                 165216             Date 13SEP99               *
      *                 161746             Date 12Jul99               *
      *                 161910             Date 29Jun99               *
      *                 163065             Date 25Jun99               *
      *                 162290             Date 08Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 158451             Date 02Apr99               *
      *                 CPL002             Date 08Mar99               *
      *                 CAC005             Date 23Nov98               *
      *                 148404             Date 23Nov98               *
      *                 145872             Date 24Nov98               *
      *                 152873             Date 18Jan99               *
      *                 153345             DATE 18Jan99               *
      *                 151945             DATE 06Jan99               *
      *                 152589             Date 06Jan99               *
      *                 151954             Date 05Jan99               *
      *                 151931             Date 30Dec98               *
      *                 151356             Date 28Dec98               *
      *                 151062             Date 22Dec98               *
      *                 151173             Date 18Dec98               *
      *                 150272             Date 10Dec98               *
      *                 150140             Date 10Dec98               *
      *                 150004             Date 09Dec98               *
      *                 148959             Date 09Dec98               *
      *                 148741             Date 25Nov98               *
      *                 148661             Date 24Nov98               *
      *                 148246             Date 19Nov98               *
      *                 147104             Date 11Nov98               *
      *                 147102             Date 11Nov98               *
      *                 137881             Date 08Jul98               *
      *                 136931             Date 19Jun98               *
      *                 CEU017             Date 05Mar98               *
      *                 CSE007   *CREATE   Date 19Jan98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  248698 - Rounding discrepancies on some SE reports. Applied  *
      *           fix 228682.                                         *
      *  228682 - Recompiled due to ZCNSDZ1 changes. Applied 176594.  *
      *  258814 - Wrong walk out position generated by system when    *
      *           Corp. action processing type = 'EX'. Remove 161732. *      
      *  MD046248 - Finastra Rebranding                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  MD034776 - Reverse AR1001183A to allow negative interest     *
      *             rate. (Recompile)                                 *
      *  AR1067108 - PMC1140 Component failed during Clean COB        *
      *              Applied fix AR1001183A                           *
      *  AR1001183A - Coupon rate was still used in computation of    *
      *              interest instead of using the details in FRN tab *
      *              (Reopen) (Recompile)                             *
      *  CCB020 - COB Restructure - Secondary COB Infrastructure      *
      *  AR850932 - SEC7560 00001 Database error in SE7560, file      *
      *           SECONCL0, at 015, key                               *
      *           Incorrect corporate action reference used for chain *
      *           in file SECONCPD. Use reference from field MACORF   *
      *           instead of MSCORF. Applied fix 185017.              *
      *  185017 - Data base in PGM - SE7560 - File name SECONCLO key  *
      *           001622.                                             *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  240016 - Should not add an In Depot to a date field.         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027A - Conversion Of Customer Number to Alpha             *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CER001 - LUX Upgrade to MidasPlus                            *
      *  CSE075 - US Enhanced Treasury Upgrade to MidasPlus           *
      *           (Recompile)                                         *
      *  235041 - Speculative fixes from SE4860                       *
      *  234829 - For EU Tax write to ETCPOSND and set up new fields  *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  229857 - Recompiled due to change in ZYLDZ2.                 *
      *  221751 - DON'T GENERATE A DEPOT MOVEMENT IF NOMINAL IS 0.    *
      *  221680 - WHEN REVERSING A CORPORATE INPUT TODAY CHANGE       *
      *           RECI TO '*'.                                        *
      *  220219 - Don't replicate if generated in I/C                 *
      *  216944 - New depot movement generated instead of reversing   *
      *           original after reversing corp action. Fix is to     *
      *           reverse original transaction when reversing a corp  *
      *           action.                                             *
      *         - Update Dptmvd file if record not already deleted.   *
      *  215278 - For type 'CR', walk-out and trade sale on old posi- *
      *           tion must be processed only once when a walk-in and *
      *           Trade purchase have to be created for each new posi-*
      *           tion. This must be done for subr. #PRCRA too.       *
      *           Core Fix 186486 reviewed and completed.             *
      *  219634 - WHEN REVERSING A CORPORATE COUNT THE DELETED RECORDS*
      *           AND UPDATE THE TRAILER ACCORDINGLY.                 *
      *  226570 - Recompiled due to change in ZYLDZ2.                 *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  217310 - A default timestamp string is required when         *
      *           writing Trade and/or Trade Extension Details.       *
      *  CSE039 - Automatic Settlement of Trades - Write to Movement  *
      *           Status file SEMVTSPD                                *
      *  186486 - For processing type 'CR', walk-out and trade sale   *
      *           on old position must be processed only one time     *
      *           when a walk-in and a trade purchase have to be      *
      *           created for each new position.                      *
      *  207006 - Add Counterparty & Market Centre to SSI             *
      *  CPK015 - Release 4.01 Packaging:                             *
      *           - A default timestamp string is required for WRITE. *
      *         - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed ZYLDZ2.                      *
      *  193662 - Nominal positions on trades and depot movements     *
      *           generated by offers (subscription and purchase)     *
      *           should be based on the actual stock allocations.    *
      *  193752 - Database error 40 occurs when generating depot      *
      *           movement for customer (Cust/Book indicator is 'C'). *
      *           Movement Subtype (MSTP field) should be defaulted   *
      *           with Corporate Action Trade Subtype if not blank.   *
      *           Else, use Default Portfolio Subtype from ICD.       *
      *  190204 - Recompiled due to changes in PF/SECODVPD.           *
      *  CSD006 - Market Data Feed (recompile)                        *
      *  183579 - Set up Movement Subtype on Depot Movements file.    *
      *  CSE023 - Treaty Withholding Tax (Recompiled)                 *
      *  179732 - Upgrade Profit centre default matrix to use the     *
      *           correct customer number and a value for the account *
      *           officer.                                            *
      *  CSE020 - Corporate Actions Domino Effect Processing          *
      *           (Recompiled due to changes in PF/SECORFPD)          *
      *  161732 - Corporate Actions Exercise and Conversion -         *
      *           Part Stock/Keep Rest Calculation                    *
      *           (Recompiled due to changes in PF/SECOEXPD)          *
      *  088864 - Recompile over amended /COPY ZPCINTZ1               *
      *  CSE015 - Forward Valued Depot Movement                       *
      *  CSE017 - Cum/Ex Indicator on Depot Movements                 *
      *  CSE012 - SE Depot Movement Narratives (Recompiled).          *
      *  CPB001 - Meridian DBA Middleware Replication Customization.  *
      *           Midas/TOF Interface.                                *
      *         - 'Private Banking' Module                            *
      *  166599 - For offers to exchange, Walk Out and Trade Sale on  *
      *           old positions should be calcd at current AV. Price  *
      *           and not with the Av price as adjusted for the Corp. *
      *           Reorgansiation which is used for Walk In and Trade  *
      *           Purchase on new Positions.                          *
      *  165216 - For Spin-Off,Walk-Out and Trade Sale on Old Position*
      *           must be processed only once when a walk-in and      *
      *           Trade purchase have to be created for each new posn *
      *  161746 - Average Price Option 'I' has been added in SE7505.  *
      *           (SECORGPD/MFAVOP)                                   *
      *           Manage it as option 'C' in this program and in      *
      *           SE7560 SE7561 SE7590 SE7591                         *
      *           ( SEINS-BBN20520 & GBSEUSRMSG/CO00175 changed too ) *
      *  161910 - Market Price Used Instead of Discounted Market      *
      *           Price                                               *
      *  163065 - Average price was wrongly calculated.               *
      *  162290 - Average price was zero due wrong charging of AVPR   *
      *           ( array )                                           *
      *  158451 - Review Transactions (TS and WO) for Processing Type *
      *           'OF' with Offer Type 'E'xchange                     *
      *  CPL002 - Midas-Plato Interface (Recompiled)                  *
      *  CAC005 - Profit Centre Accounting - SE Enhancement           *
      *  148404 - Corporate Actions (other processing type than 'CC') *
      *           Trades/Depot movements generated with negative      *
      *           Amounts. TS --> TP, TP --> TS, WI --> WO, WO --> WI *
      *  145872 - Corporate Actions: '% to Exchange' added for        *
      *           Exchange Offer ('OF').                              *
      *  152873 - To avoid problem with reversal processing, Depot    *
      *           reference must be unique anyway.                    *
      *  153345 - Exchange rate is not exactly the same with that in  *
      *           the EURO Exchange Rate. Use the EURO exchange rate  *
      *           from SDCURRPD if the Settlement Ccy is EUR and      *
      *           Nominal Ccy is an 'IN' Ccy or Nominal Ccy is EUR    *
      *           and Settlement Ccy is an 'IN' Ccy.                  *
      *  151945 - Recompiled Over changed ZDYYRZ3 .                   *
      *  152589 - When retrieve Book Last Average Price, access file  *
      *           BKPHD with complete key, add Trade/Value Date       *
      *           Position. Before, Last Average Price was always     *
      *           retrieve for Value Date Position.                   *
      *  151954 - Base ccy rate should be rate of SETTL ccy and not   *
      *           NOM ccy rate.                                       *
      *  151931 - Review Average Price Calculation when CEU002 *OFF   *
      *  151356 - Incorrect Trades generated if Trade Basis is 'Y'    *
      *  151062 - Review setup of field TMDI (Mult./Div. Indicator)   *
      *  151173 - Purchased interest must be calculated from VALUE    *
      *           DATE not from Event Control Date                    *
      *           No trade must be generated as ex-coupon             *
      *           Wrong currency decimal places used for purchased    *
      *           interest calculation                                *
      *  150272 - Problem with Amount greater than 99,999,999,999.    *
      *           Fields NOML from PF/TRADSD and DPNA from PF/DPTMVD  *
      *           are defined as 11,0 ! Split the Amount into 2 Trades*
      *           or 2 Depot Movements OR MORE ...                    *
      *  150140 - No confirmations for WI/WO produced from SE Reden.  *
      *  150004 - After Redenomination, for Short Positions, the Book *
      *           Price is reset to 0                                 *
      *  148959 - Incorrect setting up of settlement currency for     *
      *           SE redenomination for system without customer       *
      *           portfolio. Settlement currency for both trades      *
      *           should be currency from the old security.           *
      *  148741 - DB error in SE1460, file CLINTSE, at 12, key 000000 *
      *           Complete GEMS 147104 !!!                            *
      *  148661 - To calculate purchased interest the coupon rate     *
      *           is necessary, move some lines of coding to use the  *
      *           correct coupon rate                                 *
      *  148246 - Trades/Depot movements generated with negative      *
      *           Amounts. TS --> TP, TP --> TS, WI --> WO, WO --> WI *
      *  147104 - Invalid setup of clearance type when depot reference*
      *           is 'Cedel'. It must be '4' instead of '2'.          *
      *           It avoids DB error in SE1460, file CLINTSE, at 12,  *
      *           key '000000'.                                       *
      *  147102 - Market Price is incorrectly calculated when number  *
      *           of decimal positions of the 'old' security is not 0 *
      *  137881 - Corporate Actions: Generation of Trades/Depot Mvts  *
      *           - Processing for 'NC' was never executed.           *
      *           - No Trades/Depot Movements for 'NF' events.        *
      *           - Review calculation of Average Prices for 'CR'.    *
      *           - For 'NC', use the book price of the old position *
      *             for both sides.                                  *
      *  136931 - (1) Array Index Error on POWER8 with index equal 9; *
      *           Nominal Decimal Places can be from 0 to 4 !!!       *
      *           (2) If no record found on Customer Position File,   *
      *           Use Market Price of the Security (No more Db Error) *
      *           (3) For the Dummy Customer, use the Market Price    *
      *           or the Compensation Price depending of the Market   *
      *           Price Indicator retrieved on PF/SECOCCPD            *
      *           (4) Set record to 'C'omplete when Corporate Ref.    *
      *           is authorised and no position exists. For 'CC' only *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007 - Corporate Actions                                   *
      *                                                               *
      *****************************************************************
      *
     FPMPORTLLIF  E           K        DISK         KINFSR *PSSR
      ***  PM Live Portfolio Definition Details
      *
     FSECTY   UF  E           K        DISK         KINFSR *PSSR
      ***  Securities Details
      *
     FINVTP   IF  E           K        DISK
      ***  Investment type details
     F                                              KINFSR *PSSR
      *
     FTNRAN   UF  E           K        DISK         KINFSR *PSSR
      ***  Trade Number Range File
      *
     FTRADHS  IF  E           K        DISK         KINFSR *PSSR
      ***  Trades and Historic Trades
     F            TRADSDF                           KRENAMETRADSDF1
      *
     F*DPTMV***IF**E           K        DISK         KINFSR *PSSR                             216944
     FDPTMV   UF  E           K        DISK         KINFSR *PSSR                              216944
      ***  Depot Movements
     F            DPTMVDF                           KRENAMEDPTMVDF2
      *
     FDPTMVDL1IF  E           K        DISK         KINFSR *PSSR
      ***  Depot Movements
     F            DPTMVDF                           KRENAMEDPTMVDF1
      *
     FSECORFL2UF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Reference                          Prefix - MA
      *
     FSECOFRL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Free Allocations                   Prefix - ME
      *
     FSECORGL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Rights                             Prefix - MF
      *
     FSECOOFL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Exchange Offers                    Prefix - MI
      *
     FSECOEXL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Exercises and Conversions          Prefix - MJ
      *
     FSECOCRL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Corp. Reorganisation               Prefix - MH
      *
     FSECODRL0UF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Depots references file             Prefix - MS
      *
     FSECOALL0UF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Allocations file                   Prefix - MC
     F            SECOALD0                          KRENAMESECOALR0
      *
     FSECOALL3IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Allocations file                   Prefix - MC
     F            SECOALD0                          KRENAMESECOALR3
      *
     FSECOALL5UF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Allocations file                   Prefix - MC
     F            SECOALD0                          KRENAMESECOALR5
      *
     FSECOATL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Type file details                  Prefix - MM
      *
     FSECODVL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Dividends Events file details      Prefix - MD
      *
     FSECODPL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Depots file                        Prefix - MB
      *
     FSECONCL0UF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Name Changes                       Prefix - ML
      *
     FSECOCCL0IF  E           K        DISK         KINFSR *PSSR          CEU017
      ***  SE CO Currency Change                    Prefix - NA           CEU017
      *                                                                   CEU017
     FSEPCBD  UF  E           K        DISK         KINFSR *PSSR A
      ***  SE Book Position Profit Center
      *
     FCPOSC   IF  E           K        DISK         KINFSR *PSSR
      ***  SE Cust Posn by Branch, Sec & Cus.
      *
     FBKPHD   IF  E           K        DISK         KINFSR *PSSR
      ***  SE Book Postion Headers
      *
     FSEPCCD  UF  E           K        DISK         KINFSR *PSSR A
      ***  SE Customer Position Profit Center
      *
     FSEPCA   UF  E                    DISK         KINFSR *PSSR
      ***  SE Position Profit Center Audit
      *
     FSEDEV   IF  E           K        DISK         KINFSR *PSSR
      ***
      *
     FSECEO   IF  E           K        DISK         KINFSR *PSSR
      ***
     F            SEDEVDF                           KRENAMESEDEVDO
     F            SNDEVDF                           KRENAMESNDEVDO
      *
     FTRADSA  UF  E                    DISK         KINFSR *PSSR
      ***  SE Trades audit
      *
     FDPTMVA  UF  E                    DISK         KINFSR *PSSR
      ***  SE Depot movements audit
      *
     FPOSETA  UF  E                    DISK         KINFSR *PSSR
      ***  SE Position Settlements - Audit
      *
     FPOSET1  UF  E           K        DISK         KINFSR *PSSR
      ***  SE Position Settlements - Details
      *
     FTRADS   UF  E           K        DISK         KINFSR *PSSR A
      ***  SE Trades details
      *
     FDPTMVD  O   E           K        DISK         KINFSR *PSSR
      ***  SE Depot Movements details
     F/COPY WNCPYSRC,SE7560F002
      *
     FDPTMVDY1UF  E           K        DISK         KINFSR *PSSR A    UC
      ***  SE Depot Movements Extended File
      *
     FTRADSDY1UF  E           K        DISK         KINFSR *PSSR A    UC
      ***  SE Trades details Extended File
     FETCPOSNDO   E           K        DISK         KINFSR *PSSR                              234829
     F            ETCPOSNDF                         KRENAMEETCPOSF                            234829
      ***  SE EU Tax positions file                                                           234829
     F/COPY WNCPYSRC,SE7560F003
      *
     FSEMVTSL1IF  E           K        DISK         KINFSR *PSSR A        CSE039
      ***  Movement Status                                                CSE039
     FSE7560AUO   E                    PRINTER      KINFSR *PSSR
      ***  Program run control report
     F                                              KINFDS SPOOLU
     F/COPY WNCPYSRC,SE7560F001
     FSETRX1PDUF  E           K        DISK         KINFSR *PSSR A    UC                      CER001
      *                                                                                       CER001
      ** IML ER Trades Details - Extension file                                               CER001
      *                                                                                       CER001
     FSEDPX1PDUF  E           K        DISK         KINFSR *PSSR A    UC                      CER001
      *                                                                                       CER001
      ** IML ER Depot Movements - Extension Detail                                            CER001
      *                                                                                       CER001
     FERLUICL1IF  E           K        DISK         KINFSR *PSSR      UC                      CER001
      *                                                                                       CER001
      ** ER ICD                                                                               CER001
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *
     E                    SECUR      20 10
      ***  Retrieve the Security from PF/SECOCRPD
      *
     E                    MPRICE     20 16
      ***  Retrieve Market Price from PF/SECOCRPD
      *
     E                    NPR        20 15 8
      ***  Market Price from PF/SECOCRPD converted on numeric field
      *
     E                    NSEC       22 10
      ***  Array Security for the Calculated Average Price (1) & (2)
      *
     E*****               NOMI       22 15 0                              137881
     E                    NOMI       22 23 8                              137881
      ***  Array Nominal for the Calculated Average Price (1) & (2)
      *
     E*****               MARK       22 15 0                              137881
     E                    MARK       22 23 8                              137881
      ***  Array Market Price for the Calculated Average Price (1) & (2)
      *
     E*****               AVPR       22 15 0                              137881
     E                    AVPR       22 23 8                              137881
      ***  Average price for each new Security on processing type 'CR'
      *
     E/COPY ZSRSRC,ZALIGNZ1
     E/COPY ZSRSRC,ZASIGNZ1
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZHOLE
     E/COPY ZSRSRC,ZACCRZ0
     E                    POWER8  1   8  8 4             POWER8 ARRAY
     E                    POWER   1   7  7 3             POWER ARRAY
      *
      ***  Compile with 2 levels /copy
      *
      /COPY ZSRSRC,ZDAYSZ1
      /COPY ZSRSRC,ZDATE2Z1
     E/COPY WNCPYSRC,SE7560E001
     E                    STAMP   1   1 26                                                    CPK015
      ** Array containing dummy timestamp                                                     CPK015
     E                    CPY@    1   1 80
      ***  Copyrigth Array
      *
     E                    POWER9  1   9  9 4             POWER9 ARRAY     136931
     E                    TMMP    1   1 26               TIMESTAMP        CSE039
     E                    @FNXA      40 10                                                    234829
     E                    @MIXA      40  7                                                    234829
     E                    @MDXA      40 45                                                    234829
      *****************************************************************
      /EJECT
      *****************************************************************
      *
     ISEPCCDF                                                             CAC003
      ***  Rename Portfolio Reference Field                               CAC003
      *                                                                   CAC003
     I              PTFR                            PTFRXX                CAC003
     IBKPHDDF                                                             CSE017
     I              DPAP                            DPAPX                 CSE017
      *                                                                   CAC003
      **  Rename Security Replication Indicator.                          CPB001
     ISECTYDF                                                             CPB001
     I              REPI                            SEREPI                CPB001
      *                                                                   CPB001
      **  Rename Trade Replication Indicator.                             CPB001
     ITRADSDF                                                             CPB001
     I              REPI                            TRREPI                CPB001
      *                                                                   CPB001
     I**MPHAS*****E DSMPHAS                                                            220219 CCB020
     I**********    MPHAS                           PHASE                              220219 CCB020
      *                                                                                       220219
     ILDA       E DSLDA
      ***  Data structure for database error
      *
     ISPOOLU      DS
      ***  File information data structure
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
     I            DS
      ***  Working DS for Settlement Account
     I                                        1   6 WWCUST
     I**********                              7  10 WWSTAC                                    CGL029
     I**********                             11  12 WWSTSQ                                    CGL029
     I**********                              1  12 WWPAAC                                    CGL029
     I                                        7  16 WWSTAC                                    CGL029
     I                                       17  18 WWSTSQ                                    CGL029
     I                                        1  18 WWPAAC                                    CGL029
      *
     IWWCOOP      DS
      ***  Working DS for Database Error on LF/SECODVL0
     I                                        1   6 WKCOR2
     I                                        7   80WKOPT2
     IWWCOSC      DS
      ***  Working DS for Database Error on LF/CPOSC
     I                                        1   3 WCBRCD
     I                                        4  13 WCSESN
     I**********                             14  190WCCNUM                                    CSD027
     I                                       14  19 WCCNUM                                    CSD027
     IW2DPMV      DS
      ***  Working DS for Database Error on LF/DPTMV
     I                                        1  10 WKSES1
     I                                       11  16 WKTRRF
     I/COPY WNCPYSRC,SE7560I003
      *
     IWWINV       DS
      ***  Working DS for Database Error on LF/INVTP
     I                                        1   3 WKNMCY
     I                                        4   6 WKSITP
      *
     IWWPOSE      DS
      ***  Working DS for Database Error on LF/POSET1
     I                                        1   3 WKBRCD
     I                                        4  13 WKSESN
     I**********                             14  190WKDDPT                                    CSD027
     I                                       14  19 WKDDPT                                    CSD027
     I                                       20  240WKALEF
     I                                       25  26 WKEVTY
     I                                       27  30 WKPTFR
     I                                       31  350WKTNLU
      *
     IDNART       DS
      ***  Data structure for "Depot Narrative" ON LF/DPTMV
     I                                        1  35 WWDNAR
     I                                        1  35 WWTEXT
     I                                       18  23 WWCROF
     I                                       30  31 WWCOAT
      *
     IPSDS       SDS
      ***  Program Status Data Structure
     I                                      254 263 USER
      *
     I            DS
     I                                        1  140SDATI
     I                                        1   20SDD
     I                                        3   40SMM
     I                                        5   60SCC
     I                                        7   80SYY
     I                                        9  140STIME
     I            DS                                                                          234829
     I**********                              1   60DPBN                              234829 CSD027A
     I                                        1   6 DPBN                                     CSD027A
     I                                        1   6 @DPBN                                     234829
      *
     I            DS
      ***  DATA STRUCTURE FOR NUMERIC FIELDS TO NUMERIC ARRAY MOVES
      ***                                     1 300 APR
      ***                                     1 300 NPR
      *
     INWRCD     E DSSECOALL5
      ***  Current master file fields
      *
     ISVRCD       DS                            230
      ***  Stored master file fields
      *
      ***  Compile with 2 Levels /COPY
     I/COPY WNCPYSRC,SE7560I001
      *
     I/COPY ZSRSRC,ZNCDZ2
     I/COPY ZSRSRC,ZYLDZ1
     I/COPY ZSRSRC,ZHOLI
     I/COPY WNCPYSRC,SE7560I002
      *
     ISDBANK    E DSSDBANKPD
      ***  Dummy record format for access to Bank Details
      *
     ISCSARD    E DSSCSARDPD                                                                  CAS006
      ** Switchable Feature Details Data Structure                                            CAS006
      *                                                                                       CAS006
     ISDSECS    E DSSDSECSPD
      ***  Dummy record format for access to Securities Clients
      *
     ISDMMOD    E DSSDMMODPD
      ***  Dummy record format for access to Midas Module
      *
     ISDCURR    E DSSDCURRPD
      ***  Dummy record format for access to Currency Details
      *
     ISDPLCS    E DSSDPLCSPD
      ***  Dummy record format for access to PM Special Customer Details
      *
     ISDBRCH    E DSSDBRCHPD
      ***  Dummy record format for access to Branch Details
      *
     ISDGELR    E DSSDGELRPD
     I              QQACCD                          QQACD1                                    CGL029
      ***  Dummy record format for access to General Ledger Details
      *
     ISDSTRD    E DSSDSTRDPD
      ***  Dummy record format for access to Securities Trading Data
      *                                                                   CPB001
     ISDCUST    E DSSDCUSTPD                                              CPB001
     I              QQDFAC                          #DFAC1                                    CGL029
      ***  Dummy record format for access to Customer Details.            CPB001
     I*
     IDSFDY     E DSDSFDY
      ***  First DS for access programs, short data structure
      *
     IDSSDY     E DSDSSDY
      ***  Second DS for access programs, long data structure
      *
     IDSLDY     E DSDSLDY                                                 CPB001
      ***  Third DS for access programs, very long data structure         CPB001
      *                                                                   CPB001
     IETCPOS    E DSETCPOSND                                                                  234829
     I              PTFR                            EPTFR                                     234829
     I              TMST                            ETMST                                     234829
      ***  Dummy record format for access to Branch Details                                   234829
     I@TRDDS    E DSTRADSD                                                                    234829
     I              RECI                            RECIT                                     234829
     I              CHTP                            CHTPT                                     234829
     I              TNLU                            TNLUT                                     234829
     I              LCD                             LCDT                                      234829
      ** Security Details Data Structure                                                      234829
     I@SECTY    E DSSECTYD                                                                    234829
     I              RECI                            RECIA                                     234829
     I              NMCY                            NMCYA                                     234829
     I              ZZ005                           ZZ005A                                    234829
     I              CHTP                            CHTPA                                     234829
     I              TNLU                            TNLUA                                     234829
     I              REPI                            REPIA                                     234829
     I              REPA                            REPAA                                     234829
     I              LCD                             LCDTA                                     234829
     I              FRNT                            FRNTA                                     234829
     I              TMST                            TMSTA                                     234829
     I              CD01                            CD01A                                     234829
     I              CD02                            CD02A                                     234829
     I              CD03                            CD03A                                     234829
     I              CD04                            CD04A                                     234829
     I              CD05                            CD05A                                     234829
     I              CD06                            CD06A                                     234829
     I              CD07                            CD07A                                     234829
     I              CD08                            CD08A                                     234829
     I              CD09                            CD09A                                     234829
     I              CD10                            CD10A                                     234829
     I              CD11                            CD11A                                     234829
     I              CD12                            CD12A                                     234829
     I              CR01                            CR01A                                     234829
     I              CR02                            CR02A                                     234829
     I              CR03                            CR03A                                     234829
     I              CR04                            CR04A                                     234829
     I              CR05                            CR05A                                     234829
     I              CR06                            CR06A                                     234829
     I              CR07                            CR07A                                     234829
     I              CR08                            CR08A                                     234829
     I              CR09                            CR09A                                     234829
     I              CR10                            CR10A                                     234829
     I              CR11                            CR11A                                     234829
     I              CR12                            CR12A                                     234829
     I              SEZONE                          SEZONA                                    234829
     I@SEVDP    E DSSEVDPMVPD                                                                 234829
     I              RECI                            RECIV                                     234829
     I              ORBR                            ORBRV                                     234829
     I              TACI                            TACIV                                     234829
     I              ORED                            OREDV                                     234829
     I              LCD                             LCDV                                      234829
     I              CHTP                            CHTPV                                     234829
     I              TNLU                            TNLUV                                     234829
     I              SPXR                            SPXRV                                     234829
     I              SPMD                            SPMDV                                     234829
     I              PTFR                            PTFRV                                     234829
     I              COAF                            COAFV                                     234829
     I              ACIN                            ACINV                                     234829
     I              REPI                            REPIV                                     234829
     I              DPAP                            DPAPV                                     234829
     I              FSPR                            FSPRV                                     234829
     I              FSPP                            FSPPV                                     234829
     I              DPBN                            DPBNV                                     234829
      /COPY ZSRSRC,ZTNLU1Z1
     ICPYR@#      DS
      ***  Data structure for compilation  - COPYRIGHT INSERTION
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *
     I              'CORPORATE ACTION nnn-C         DNARR
     I              'nnn TYPE mm    '
      *** Posting narrative Array --> GEFEPP/PF
     I              'SEVSEFSPR3'          C         SEVFSP                                    234829
     I              'SEETCPUPD'           C         SEETCP                                    234829
     I              'SEVOPUINT'           C         SEVOPI                                    234829
     I              'SEETCPRTV'           C         SEETRT                                    234829
      *
     C/EJECT
      *****************************************************************
      /EJECT
      *****************************************************************
      *                M A I N     P R O C E S S I N G                *
      *****************************************************************
      *
      ***  Access first record (By read) In CO Reference Rtv Idx
      *
     C           *LOVAL    SETLLSECORFL2
     C                     READ SECORFL2                 44
      *
      ***  Do while end of file is not reached
      *
     C           *IN44     DOWEQ*OFF
      *
      ***  If "Security Shortname" is not equal to "Saved Security"
      ***  Access to Security Details
      *
     C           MASESN    IFNE WOSESN
     C                     MOVELMASESN    WOSESN    P
     C                     MOVELMASESN    WKSESN    P
     C                     EXSR #SECTO
     C                     ENDIF
      *
      ***  If Last Change Type is NOT a reversal
      ***  and Last Change Date is lower than control date
      *
     C           MACHTP    IFNE 'R'
      *
     C                     MOVELMACORF    KWCORF    P      CA Reference Number
      *
      ***  Access LF/SECODRL0 with reference in order to obtain
      ***  the depots linked to the Corporate Action
      *
     C           KWCORF    SETLLSECODRL0
     C           KWCORF    READESECODRL0                 45
      *
     C           *IN45     IFEQ *OFF
      *
      ***  Do while end of file is not reached
      *
     C           *IN45     DOWEQ*OFF
      *
      ***  If Status Corporate Action (MSCOST) is equal to 'S' or 'X'
      *
     C           MSCOST    IFEQ 'S'
     C           MSCOST    OREQ 'X'
      *
      ***  Check the processing type
      *
     C********             SELEC                                          137881
      *
      ***  Processing type is not 'NF' (Non Financial)
      *
     C********   MAPTYP    WHNE 'NF'                                      137881
     C           MAPTYP    IFNE 'NF'                                      137881
      *
      ***  Process depot record depending on processing type
      *
     C           MATDDT    IFLE WWECD
     C/COPY WNCPYSRC,SEH00026
     C                     EXSR #PDPTY
     C                     ENDIF
      *                                                                   137881
     C                     ELSE                                           137881
     C                     MOVE 'Y'       MSEVNI                          137881
     C                     ENDIF                                          137881
      *
      ***  Processing type is equal to 'NC' (Name Changes)
      *
     C********   MAPTYP    WHEQ 'NC'                                      137881
     C           MAPTYP    IFEQ 'NC'                                      137881
      *
      ***  Process Name changes
      *
     C           MAALEF    IFLE WWECD
     C                     EXSR #PDNCH
     C                     ENDIF
     C                     ENDIF                                          137881
     C********             ENDSL                           Check Proc. Typ137881
      *
      ***  Update Corporate Actions - References record
      *
     C                     UPDATSECODRD0
     C                     ENDIF                           Status 'S' or 'X'
      *
      ***  Read Next Corporate Action Reference
      *
     C           KWCORF    READESECODRL0                 45
     C                     ENDDO                           *IN45=*OFF
      *
     C                     ELSE                            *IN45=*ON
      *
      ***  Processing type is 'NC' and status is 'X' (authorised)
      *
     C           MAPTYP    IFEQ 'NC'
     C           MASTAT    ANDEQ'X'
      *
      ***  Process Name changes
      *
     C           MAALEF    IFLE WWECD
     C                     EXSR #PDNCH
      *
      ***  Update PF/SECORFPD Corporate Action Reference
      *
     C                     MOVE 'C'       MASTAT
     C                     UPDATSECORFD0
     C                     ENDIF
     C                     ENDIF
      *
      ***  Status is 'X' (authorised)                                     136931
      ***  and no record found on LF/SECODRL0                             136931
      *                                                                   136931
     C           MASTAT    IFEQ 'X'                                       136931
     C           MAPTYP    ANDEQ'CC'                                      136931
      *                                                                   136931
      ***  Update PF/SECORFPD Corporate Action Reference                  136931
      *                                                                   136931
     C           MAALEF    IFLE WWECD                                     136931
     C           MATDDT    ANDLEWWECD                                     136931
     C           MAEVDT    ANDLEWWECD                                     136931
     C           MACOPD    ANDLEZZDNWD                                    136931
     C                     MOVE 'C'       MASTAT                          136931
     C                     UPDATSECORFD0                                  136931
     C                     ENDIF                                          136931
     C                     ENDIF                                          136931
     C                     ENDIF                           *IN45=*ON
     C                     ENDIF                           Not Reversal
      *
      ***  If Last change type = 'R' and last change date = run date
      ***  and processing type is not 'NC'
      *
     C           MACHTP    IFEQ 'R'
     C           MALCD     ANDEQBJRDNB
     C           MAPTYP    ANDNE'NC'
      *
     C                     MOVELMACORF    KWCORF    P      CA Reference Number
      *
     C           MASESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD32        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 32 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVELMASESN    DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Reset to zeros/blanks 'Sec. Red. Replaced by Shortname' & 'Sec. Red. Bulk Reference'
     C                     MOVE *BLANKS   SRRB
     C                     Z-ADD*ZEROS    SRBK
     C                     UPDATSECTYDF
      *
      ***  Access LF/SECODRL0 with reference in order to obtain
      ***  the depots linked to the Corporate Action
      *
     C           KWCORF    SETLLSECODRL0
     C           KWCORF    READESECODRL0                 45
      *
      ***  Do while end of file is not reached
      *
     C           *IN45     DOWEQ*OFF
      *
      ***  If Status Corporate Action (MSCOST) is equal to 'R'
      *
     C           MSCOST    IFEQ 'R'
     C                     EXSR #POSRV
     C                     EXSR #TDRVR
     C                     ENDIF                           status
      *
      ***  Read next record
      *
     C           KWCORF    READESECODRL0                 45
     C                     ENDDO                           *IN45=*OFF
     C                     ENDIF                           Reversal
      *
      ***  Access next record in CA References file
      *
     C                     READ SECORFL2                 44
      *
     C                     ENDDO                           *IN44=*OFF
     C/COPY WNCPYSRC,SE7560C011
      *
      ***  Termination processing
      *
     C                     EXSR #TERPR
      *
      *****************************************************************
     C/COPY WNCPYSRC,SE7560C012
      /EJECT
      *****************************************************************
      *  #PDPTY -  Process Depot records for processing type          *
      *  ------    Other than 'NF'                                    *
      *  Called by : Main processing                                  *
      *  Calls     : #POSET                                           *
      *****************************************************************
      *
     C           #PDPTY    BEGSR
      *
      ***  If "Trades/Depot Movements Indicator" is NOT 'Y'
      *
     C           MSEVNI    IFNE 'Y'
      *
      ***  Reset array SECUR (20 * 10A) to blanks
      ***  Reset array MPRICE (20 * 16A) to blanks
      *
     C                     MOVEA*BLANKS   SECUR
     C                     MOVEA*BLANKS   MPRICE
     C                     MOVE 'Y'       WFIRST  1
      *
      ***  Access to Stock Allocation with same Corporate Action Reference,
      ***  same branch, same depot
      ***  (LF only select records with actual stock allocation non zero)
     C                     MOVEL*BLANKS   WXBOOK  2                       186486
      *
     C                     MOVE MSCORF    WKCORF    P      CA Reference
     C                     MOVE MSBRCD    WKBRCD    P      Branch
     C**********           Z-ADDMSDDPT    WKDDPT           Depot                              CSD027
     C                     MOVE MSDDPT    WKDDPT           Depot                              CSD027
      *
     C           KWCOAL    SETLLSECOALL5
     C           KWCOAL    READESECOALL5                 46
      *
     C           *IN46     DOWEQ*OFF
      *
     C                     MOVE *BLANKS   WWTRR1  6
     C                     MOVE *BLANKS   WWTRR2  6
     C                     MOVE *BLANKS   WWTRR3  6
      *
      ***  Access to logical file depends on processing type
      *
     C                     EXSR #SELLF
      *
      ***  Retrieve the current average price
      *
     C           MAPTYP    IFEQ 'FR'
     C           MEADRE    ANDEQ'R'
     C           MAPTYP    OREQ 'CR'
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'EX'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C           MAPTYP    OREQ 'NC'
      *
     C                     EXSR #CUAVP
      *
      ***  Retrieve the current average price
      *
     C           MAPTYP    IFEQ 'CR'
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C*****      MAPTYP    OREQ 'NC'                                      137881
      *
      ***  If processing type is 'CR' Move Security file into workfield
      ***  and Market price file into workfield
      *
     C           MAPTYP    IFEQ 'CR'
     C           WFIRST    ANDEQ'Y'
     C                     MOVE 'N'       WFIRST
     C                     MOVEAMHSECA    SECUR
     C                     MOVEAMHMKTP    MPRICE
      *
      ***  Convert the market price from file to numeric array
      *
     C                     MOVEA*ZERO     NPR
     C                     Z-ADD1         X       20
      *
     C           X         DOWLT21
     C           MPRICE,X  IFNE *BLANKS
     C                     MOVE MPRICE,X  NPR,X                           137881
     C*****                MOVE MPRICE,X  ZFIELD                          137881
     C*****                Z-ADD8         ZADEC                           137881
     C*****      15        SUB  8         ZADIG                           137881
     C*****                MOVE *OFF      *IN99                           137881
     C*****                EXSR ZALIGN                                    137881
      *****                                                               137881
     C*****      *IN99     IFEQ *ON                                       137881
     C*****                Z-ADD*ZEROS    NPR,X                           137881
     C*****                ELSE                                           137881
     C*****                MOVE ZFIELD    NPR,X                           137881
     C*****                ENDIF                                          137881
     C*****                ADD  1         X                               136931
     C                     ENDIF
     C                     ADD  1         X                               136931
     C                     ENDDO
     C                     ENDIF
      *
     C                     EXSR #CAAVP
     C                     ENDIF
     C                     ENDIF
      *
      ***  Generate Trades/Depot Movements depending on Processing Type
      *
     C                     SELEC
      *
      ***  Processing type 'DV'
      *
     C           MAPTYP    WHEQ 'DV'
     C                     EXSR #PRDV
      *
      ***  Processing type 'FR'
      *
     C           MAPTYP    WHEQ 'FR'
     C                     EXSR #PRFR
      *
      ***  Processing type 'CR'
      *
     C           MAPTYP    WHEQ 'CR'
     C                     EXSR #PRCR
      *                                                                   CEU017
      ***  Processing type 'CC'                                           CEU017
      *                                                                   CEU017
     C           MAPTYP    WHEQ 'CC'                                      CEU017
     C                     EXSR #PRCC                                     CEU017
      *
      ***  Processing type 'CE'
      *
     C           MAPTYP    WHEQ 'CE'
     C                     EXSR #PRCE
      *
      ***  Processing type 'OF'
      *
     C           MAPTYP    WHEQ 'OF'
     C                     EXSR #PROF
      *
      ***  Processing type 'EX'
      *
     C           MAPTYP    WHEQ 'EX'
     C                     EXSR #PREX
      *
      ***  Processing type 'RG'
      *
     C           MAPTYP    WHEQ 'RG'
     C                     EXSR #PRRG
      *
      ***  Processing type 'NC'
      *
     C           MAPTYP    WHEQ 'NC'
     C                     EXSR #PRNC
     C                     ENDSL                           Check proc. type
      *
      ***  Update "Transaction Reference" from PF/SECOALPD
      *
     C                     MOVE WWTRR1    MCTRRF
     C                     MOVE WWTRR2    MCTRR2
     C                     MOVE WWTRR3    MCTRR3
      *
      ***  Update Stock Allocation
      *
     C                     UPDATSECOALR5
      *
      ***  Access next Stock Allocation
      *
     C           KWCOAL    READESECOALL5                 46
     C                     ENDDO                           *IN46=*OFF
      *
      ***  Setup Trade/Depot Movement indicator to 'Y'
      *
     C                     MOVE 'Y'       MSEVNI
     C                     ENDIF                           MSEVNI<>'Y'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #TDRVR -  Pocess Trades and Depot Movements Reversal         *
      *  ------                                                       *
      *  Called by : Main processing                                  *
      ***Calls*****:*#ADPMV*#WDPMV*#UTRAD******************************                       216944
      *  Calls     : #ADPMV #WDPMV #UDPMV #UTRAD                      *                       216944
      *****************************************************************
      *
     C           #TDRVR    BEGSR
      *
      ***  If "Trades/Depot Movement indicator" is 'Y'
      *
     C           MSEVNI    IFEQ 'Y'
      *
      ***  Access to Allocation Retrieve idx with same Coporate Action Reference
      *
     C                     MOVE MSCORF    WKCORF    P      CA Reference
     C                     MOVE MSBRCD    WWBRCD    P      Branch
     C**********           Z-ADDMSDDPT    WWDDPT           Depot                              CSD027
     C                     MOVE MSDDPT    WWDDPT           Depot                              CSD027
      *
     C           WKCORF    SETLLSECOALL0
     C           WKCORF    READESECOALL0                 46
      *
     C           *IN46     DOWEQ*OFF
      *
     C           MCBRCD    IFEQ WWBRCD
     C           MCDDPT    ANDEQWWDDPT
      *
      ***  If "Transaction Reference MCTRRF" is not equal to zeros
      *
     C           MCTRRF    IFNE *BLANKS
     C           MCTRRF    ANDNE'000000'
     C           MCRVRF    ANDEQ*BLANKS
      *
      ***  Check "Customer/Book indicator"
      *
     C                     SELEC
     C           MCCOTP    WHEQ 'C'                        Customer
      *
      ***  Access Depot Movements with Transaction Reference
      *
     C                     MOVELMCSESN    WKSESN    P      Security
     C                     MOVE MCTRRF    WKTRRF           Transaction Reference
      *
     C                     EXSR #ADPMV
      *                                                                                       216944
     C           CSE018    IFEQ 'N'                                                           216944
      *
      ***  Retrieve a new Depot Reference
      *
     C                     MOVE WWNTR2    WKTRRF  6        Reference
      *
     C                     EXSR #DPTNB
      *
     C                     MOVE 'R'       WALLOC           Reversal
     C                     MOVE WWNTR2    DPRN             Reference
     C                     ADD  1         WWNTR2
      *
     C           WDPMV     IFEQ 'WI'
     C                     MOVE 'WO'      DPMV
     C**********           Z-ADDWDPID     DPOD                                                CSD027
     C                     MOVE WDPID     DPOD                                                CSD027
     C                     Z-ADDWDPMD     DPDO
     C**********           Z-ADD*ZERO     DPID                                                CSD027
     C                     MOVE *BLANKS   DPID                                                CSD027
     C                     Z-ADD*ZERO     DPMD
     C                     ELSE
     C                     MOVE 'WI'      DPMV
     C**********           Z-ADDWDPOD     DPID                                                CSD027
     C                     MOVE WDPOD     DPID                                                CSD027
     C                     Z-ADDWDPDO     DPMD
     C**********           Z-ADD*ZERO     DPOD                                                CSD027
     C                     MOVE *BLANKS   DPOD                                                CSD027
     C                     Z-ADD*ZERO     DPDO
     C                     ENDIF
     C                     ENDIF                                                              216944
      *
      *****Write*Depot*Movement*record*********************************                       216944
      ** Write or Update Depot Movement record                                                216944
      *
     C           CSE018    IFEQ 'Y'                                                           216944
     C                     EXSR #UDPMV                                                        216944
     C                     ELSE                                                               216944
     C                     EXSR #WDPMV
     C                     ENDIF                                                              216944
      *
     C                     MOVE DPRN      MCRVRF           Reversal reference
      *
     C           MCCOTP    WHEQ 'B'                        Book
      *
      ***  Access Trades file and update it
      *
     C                     MOVE MCTRRF    WKTRRF           Reference
     C                     EXSR #UTRAD
     C                     ENDSL                           Check Customer/Book Ind
      *
     C                     ENDIF                           MCTRRF<>0
      *
      ***  If "Transaction Reference MCTRR2" is not equal to zeros
      *
     C           MCTRR2    IFNE *BLANKS
     C           MCTRR2    ANDNE'000000'
     C           MCRVR2    ANDEQ*BLANKS
      *
      ***  Check "Customer/Book indicator"
      *
     C                     SELEC
     C           MCCOTP    WHEQ 'C'                        Customer
      *
      ***  Access Depot Movements with Transaction Reference
      *
     C                     MOVELMCSESN    WKSESN    P      Security
     C                     MOVE MCTRR2    WKTRRF           Reference
      *
     C                     EXSR #ADPMV
      *
     C           CSE018    IFEQ 'N'                                                           216944
      ***  Retrieve a new Depot Reference
      *
     C                     MOVE WWNTR2    WKTRRF  6        Reference
      *
     C                     EXSR #DPTNB
      *
     C                     MOVE 'R'       WALLOC           Reversal
     C                     MOVE WWNTR2    DPRN             Reference
     C                     ADD  1         WWNTR2
      *
     C           WDPMV     IFEQ 'WI'
     C                     MOVE 'WO'      DPMV
     C**********           Z-ADDWDPID     DPOD                                                CSD027
     C                     MOVE WDPID     DPOD                                                CSD027
     C                     Z-ADDWDPMD     DPDO
     C**********           Z-ADD*ZERO     DPID                                                CSD027
     C                     MOVE *BLANKS   DPID                                                CSD027
     C                     Z-ADD*ZERO     DPMD
     C                     ELSE
     C                     MOVE 'WI'      DPMV
     C**********           Z-ADDWDPOD     DPID                                                CSD027
     C                     MOVE WDPOD     DPID                                                CSD027
     C                     Z-ADDWDPDO     DPMD
     C**********           Z-ADD*ZERO     DPOD                                                CSD027
     C                     MOVE *BLANKS   DPOD                                                CSD027
     C                     Z-ADD*ZERO     DPDO
     C                     ENDIF
     C                     ENDIF                                                              216944
      *
      *****Write*Depot*Movement*record*********************************                       216944
      ** Write or Update Depot Movement record                                                216944
      *
     C           CSE018    IFEQ 'Y'                                                           216944
     C                     EXSR #UDPMV                                                        216944
     C                     ELSE                                                               216944
     C                     EXSR #WDPMV
     C                     ENDIF                                                              216944
      *
     C                     MOVE DPRN      MCRVR2           Reversal reference
      *
     C           MCCOTP    WHEQ 'B'                        Book
      *
      ***  Access Trades file and update it
      *
     C                     MOVE MCTRR2    WKTRRF           Transaction Reference
     C                     EXSR #UTRAD
     C                     ENDSL                           Check Customer/Book Ind
      *
     C                     ENDIF                           MCTRR2<>0
      *
      ***  If "Transaction Reference MCTRR3" is not equal to zeros
      *
     C           MCTRR3    IFNE *BLANKS
     C           MCTRR3    ANDNE'000000'
     C           MCRVR3    ANDEQ*BLANKS
      *
      ***  Check "Customer/Book indicator"
      *
     C                     SELEC
     C           MCCOTP    WHEQ 'C'                        Customer
      *
      ***  Access Depot Movements with Transaction Reference
      *
     C                     MOVELMCSESN    WKSESN    P      Security
     C                     MOVE MCTRR3    WKTRRF           Reference
      *
     C                     EXSR #ADPMV
      *                                                                                       216944
     C           CSE018    IFEQ 'N'                                                           216944
      *
      ***  Retrieve a new Depot Reference
      *
     C                     MOVE WWNTR2    WKTRRF  6        Reference
      *
     C                     EXSR #DPTNB
      *
     C                     MOVE 'R'       WALLOC           Reversal
     C                     MOVE WWNTR2    DPRN             Reference
     C                     ADD  1         WWNTR2
      *
     C           WDPMV     IFEQ 'WI'
     C                     MOVE 'WO'      DPMV
     C**********           Z-ADDWDPID     DPOD                                                CSD027
     C                     MOVE WDPID     DPOD                                                CSD027
     C                     Z-ADDWDPMD     DPDO
     C**********           Z-ADD*ZERO     DPID                                                CSD027
     C                     MOVE *BLANKS   DPID                                                CSD027
     C                     Z-ADD*ZERO     DPMD
     C                     ELSE
     C                     MOVE 'WI'      DPMV
     C**********           Z-ADDWDPOD     DPID                                                CSD027
     C                     MOVE WDPOD     DPID                                                CSD027
     C                     Z-ADDWDPDO     DPMD
     C**********           Z-ADD*ZERO     DPOD                                                CSD027
     C                     MOVE *BLANKS   DPOD                                                CSD027
     C                     Z-ADD*ZERO     DPDO
     C                     ENDIF
     C                     ENDIF                                                              216944
      *
      *****Write*Depot*Movement*record*********************************                       216944
      ** Write or Update Depot Movement record                                                216944
      *
     C           CSE018    IFEQ 'Y'                                                           216944
     C                     EXSR #UDPMV                                                        216944
     C                     ELSE                                                               216944
     C                     EXSR #WDPMV
     C                     ENDIF                                                              216944
      *
     C                     MOVE DPRN      MCRVR3           Reversal reference
      *
     C           MCCOTP    WHEQ 'B'                        Book
      *
      ***  Access Trades file and update it
      *
     C                     MOVE MCTRR3    WKTRRF           Transaction Reference
     C                     EXSR #UTRAD
     C                     ENDSL                           Check Customer/Book Ind
      *
     C                     ENDIF                           MCTRR3<>0
      *
      ***  Update stock allocation
      ***  Access next Stock Allocation
      *
     C                     UPDATSECOALR0
     C                     ENDIF
      *
     C           WKCORF    READESECOALL0                 46
     C                     ENDDO                           *IN46=*OFF
      *
      ***  Setup Corporat Action Status to 'R'
      *
     C                     ENDIF                           MSEVNI='Y'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #POSRV -  Position Settlement Reversal                       *
      *  ------                                                       *
      *  Called by : Main processing                                  *
      *  Calls     : #POSET                                           *
      *****************************************************************
      *
     C           #POSRV    BEGSR
      *
      ***  If "Position Settlement indicator" is 'Y'
      *
     C           MSPOSI    IFEQ 'Y'
      *
      ********************************
      ***  Process Depot Reversal  ***
      ********************************
      *
      ***  Access to Depot Retrieve idx with same Coporate Action Reference,
      ***  same branch and same depot
      *
     C                     MOVE MSCORF    WSCORF    P      CA Reference
     C                     MOVE MSBRCD    WSBRCD    P      Branch
     C**********           Z-ADDMSDDPT    WSDDPT           Depot                              CSD027
     C                     MOVE MSDDPT    WSDDPT           Depot                              CSD027
      *
     C           WSCORF    SETLLSECODPL0
     C           WSCORF    READESECODPL0                 46
      *
     C           *IN46     DOWEQ*OFF
      *
     C           MBBRCD    IFEQ WSBRCD
     C           MBDDPT    ANDEQWSDDPT
      *
      ***  If "Position Settlement TNL1" is not equal to zeros
      *
     C           MBTNL1    IFNE *ZEROS
      *
      ***  Access to Position Settlement file to retrieve current Position Settlement
      ***  and update it to deleted or matured depending on record id
      *
     C                     MOVELMBBRCD    WKBRCD    P      Branch
     C                     MOVELMASESN    WKSESN    P      Security
     C**********           Z-ADDMBDDPT    WKDDPT           Depot/Customer                     CSD027
     C                     MOVE MBDDPT    WKDDPT           Depot/Customer                     CSD027
     C                     Z-ADDMAALEF    WKALEF           Allocation Effective Date
     C                     MOVE MACOAT    WKEVTY           Event Type
     C                     MOVE *BLANKS   WKPTFR           Portfolio
     C                     Z-ADDMBTNL1    WKTNLU           Position Settlement
     C                     EXSR #POSET
     C                     ENDIF                           MBTNL1<>0
     C                     ENDIF
      *
      ***  Access next Stock Allocation
      *
     C           WSCORF    READESECODPL0                 46
     C                     ENDDO                           *IN46=*OFF
      *
      ***********************************
      ***  Process Customer Reversal  ***
      ***********************************
      *
      ***  Access to Allocation Retrieve idx with same Coporate Action Reference
      *
     C                     MOVE MSCORF    WKCORF    P      CA Reference
     C                     MOVE MSBRCD    WWBRCD    P      Branch
     C**********           Z-ADDMSDDPT    WWDDPT           Depot                              CSD027
     C                     MOVE MSDDPT    WWDDPT           Depot                              CSD027
      *
     C           WKCORF    SETLLSECOALL0
     C           WKCORF    READESECOALL0                 46
      *
     C           *IN46     DOWEQ*OFF
      *
     C           MCBRCD    IFEQ WWBRCD
     C           MCDDPT    ANDEQWWDDPT
      *
      ***  If "Position Settlement TNL1" is not equal to zeros
      *
     C           MCTNL1    IFNE *ZEROS
      *
      ***  Access to Position Settlement file to retrieve current Position Settlement
      ***  and update it to deleted or matured depending on record id
      *
     C                     MOVELMCBRCD    WKBRCD    P      Branch
     C                     MOVELMASESN    WKSESN    P      Security
     C**********           Z-ADDMCCNUM    WKDDPT           Depot/Customer                     CSD027
     C                     MOVE MCCNUM    WKDDPT           Depot/Customer                     CSD027
     C                     Z-ADDMAALEF    WKALEF           Allocation Effective Date
     C                     MOVE MACOAT    WKEVTY           Event Type
     C                     MOVE MCPTFR    WKPTFR           Portfolio
     C                     Z-ADDMCTNL1    WKTNLU           Position Settlement
     C                     EXSR #POSET
     C                     ENDIF                           MCTNL1<>0
     C                     ENDIF
      *
      ***  Read Next record
      *
     C           WKCORF    READESECOALL0                 46
     C                     ENDDO                           *IN46=*OFF
     C                     ENDIF                           MSPOSI='Y'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SELLF -  Select Logical file from the processing type       *
      *  ------                                                       *
      *  Called by : #PDPTY                                           *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #SELLF    BEGSR
      *
     C                     MOVE MCCORF    WKCOR2
     C                     MOVE MCOPTN    WKOPT2
      *
     C                     SELEC
      *
      ***  Processing type 'DV'
      ***  Access to CO Dividends Events file
      *
     C           MAPTYP    WHEQ 'DV'
     C           KWCOOP    CHAINSECODVL0             47
     C                     MOVE MDRECI    WWRECI  1
     C                     MOVEL'SECODVL0'WWFILE 10
      *
      ***  Processing type 'FR'
      ***  Access to CO Free Allocations
      *
     C           MAPTYP    WHEQ 'FR'
     C           KWCOOP    CHAINSECOFRL0             47
     C                     MOVE MERECI    WWRECI  1
     C                     MOVEL'SECOFRL0'WWFILE 10
      *
      ***  Processing type 'RG'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'RG'
     C           KWCOOP    CHAINSECORGL0             47
     C                     MOVE MFRECI    WWRECI  1
     C                     MOVEL'SECORGL0'WWFILE 10
      *
      ***  Processing type 'CR'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'CR'
     C           KWCOOP    CHAINSECOCRL0             47
     C                     MOVE MHRECI    WWRECI  1
     C                     MOVEL'SECOCRL0'WWFILE 10
      *
      ***  Processing type 'OF'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'OF'
     C           KWCOOP    CHAINSECOOFL0             47
     C                     MOVE MIRECI    WWRECI  1
     C                     MOVEL'SECOOFL0'WWFILE 10
      *
      ***  Processing type 'EX'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'EX'
     C           KWCOOP    CHAINSECOEXL0             47
     C                     MOVE MJRECI    WWRECI  1
     C                     MOVEL'SECOEXL0'WWFILE 10
      *
      ***  Processing type 'NC'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'NC'
     C           WKCOR2    CHAINSECONCL0             47
     C                     MOVE MLRECI    WWRECI  1
     C                     MOVEL'SECONCL0'WWFILE 10
      *                                                                   CEU017
      ***  Processing type 'CC'                                           CEU017
      ***  Access to CO Currency Change file                              CEU017
      *                                                                   CEU017
     C           MAPTYP    WHEQ 'CC'                                      CEU017
     C           WKCOR2    CHAINSECOCCL0             47                   CEU017
     C                     MOVE NARECI    WWRECI  1                       CEU017
     C                     MOVEL'SECOCCL0'WWFILE 10                       CEU017
     C                     ENDSL
      *
     C           *IN47     IFEQ *ON
     C           WWRECI    OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD1         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 01 *
     C                     MOVELWWFILE    DBFILE           ***************
     C           MAPTYP    IFNE 'NC'
     C           MAPTYP    ANDNE'CC'                                      CEU017
     C                     MOVELWWCOOP    DBKEY     P
     C                     ELSE
     C                     MOVELWKCOR2    DBKEY     P
     C                     ENDIF
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CUAVP -  Retrieve Current Average Price                     *
      *  ------                                                       *
      *  Called by : #PDPTY                                           *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #CUAVP    BEGSR
      *
     C                     MOVE 'N'       WNOPOS  1
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'C' for customer
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  Retrieve the customer position record on LF/CPOSC
      *
     C                     MOVE MCBRCD    WCBRCD
     C                     MOVE MCCNUM    WCCNUM
     C                     MOVE MASESN    WCSESN
      *
     C           KWCOSC    CHAINCPOSC                48
      *
     C*****      *IN48     IFEQ *ON                                       136931
     C*****      MCCNUM    ANDNEWWERCU                                    136931
     C*****      RECI      OREQ '*'                                       136931
     C*****      MCCNUM    ANDNEWWERCU                                    136931
     C*****      *LOCK     IN   LDA                                       136931
     C*****                Z-ADD2         DBASE            ***************136931
     C*****                MOVEL*BLANKS   DBFILE           * DB ERROR 02 *136931
     C*****                MOVEL'CPOSC'   DBFILE           ***************136931
     C*****                MOVELWWCOSC    DBKEY     P                     136931
     C*****                MOVEL'SE7560'  DBPGM     P                     136931
     C*****                OUT  LDA                                       136931
     C*****                EXSR *PSSR                                     136931
     C*****                ENDIF                                          136931
      *
     C                     Z-ADD*ZERO     WWPRIC 158
      *
     C           *IN48     IFEQ *OFF
     C           RECI      ANDEQ'D'
      *
      ***  Check the "Trade/Value Date" indicator
      *
     C                     SELEC
      *
     C           MATDVD    WHEQ 'T'                        Trade Date
      *
      ***  Calculate average price using SR/ZAVPR2
      ***  SR/ZAVPR2 based on standard subroutine SR/ZAVPR
      *
     C           CSNT      IFNE *ZERO
     C                     Z-ADDCSNT      ZNOML            Nominal
     C                     Z-ADDCSPT      ZAPNC            Ap numerator
     C                     Z-ADDWONBDP    ZCDP             Nom. Ccy dec. places
     C                     Z-ADDWONMDP    NMDP             Nominal decimal places
     C                     EXSR ZAVPR2
     C                     Z-ADDZPRC      WWPRIC
     C                     ENDIF
      *
     C           MATDVD    WHEQ 'V'                        Value Date
      *
      ***  Calculate average price using SR/ZAVPR2
      ***  SR/ZAVPR2 based on standard subroutine SR/ZAVPR
      *
     C           CSNV      IFNE *ZERO
     C                     Z-ADDCSNV      ZNOML            Nominal
     C                     Z-ADDCSPV      ZAPNC            Ap numerator
     C                     Z-ADDWONBDP    ZCDP             Nom. Ccy dec. places
     C                     Z-ADDWONMDP    NMDP             Nominal decimal places
     C                     EXSR ZAVPR2
     C                     Z-ADDZPRC      WWPRIC
     C                     ENDIF
     C                     ENDSL
      *
      *****If*the*average*price*is*<*0,*set*average*price*to*zero******** 150004
      *
     C           WWPRIC    IFLT *ZERO
     C**********           Z-ADD*ZERO     WWPRIC                          150004
     C                     Z-SUBWWPRIC    WWPRIC                          150004
     C                     ENDIF
      *
     C                     ELSE
      *                                                                   136931
     C           MCCNUM    IFEQ WWERCU                                    136931
      *
     C                     MOVE 'Y'       WNOPOS
      *
      ***  Special Processing for the DUMMY customer without position
      *
     C                     SELEC
     C           MAPTYP    WHEQ 'DV'
     C                     Z-ADDMDCOMP    WWPRIC
     C           MAPTYP    WHEQ 'EX'
     C                     Z-ADDMJCOMP    WWPRIC
     C           MAPTYP    WHEQ 'FR'
     C                     Z-ADDMECOMP    WWPRIC
     C           MAPTYP    WHEQ 'OF'
     C                     Z-ADDMICOMP    WWPRIC
     C           MAPTYP    WHEQ 'RG'
     C                     Z-ADDMFCOMP    WWPRIC
     C           MAPTYP    WHEQ 'CC'                                      CEU017
     C           NAMRKI    IFEQ 'Y'                                       136931
     C                     Z-ADDMKPR      WWPRIC                          136931
     C                     ELSE                                           136931
     C                     Z-ADDNACOMP    WWPRIC                          CEU017
     C                     ENDIF                                          136931
     C                     ENDSL
      *                                                                   136931
     C                     ELSE                                           136931
     C                     Z-ADDMKPR      WWPRIC                          136931
     C                     ENDIF                                          136931
     C                     ENDIF
      *
      ***  If Cust/Book indicator is 'B' for book
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Access to Book position Header to retrieve the Last Average Price
      *
     C                     MOVE MASESN    WKSESN
     C                     MOVE MCBRCD    WKBRCA
     C                     MOVE MCBOOK    WKBOOK
     C                     MOVE WOMKTI    WKMKTI
     C                     MOVE MATDVD    WKTDVD                          152589
      *
     C           KWBKPH    SETGTBKPHD
     C           KWBKPH    REDPEBKPHD                    89
      *
     C           *IN89     IFEQ *OFF
     C                     Z-ADDLAVP      WWPRIC
     C                     ENDIF
      *
      *****If*the*average*price*is*<*0,*set*average*price*to*zero******** 150004
      *
     C           WWPRIC    IFLT *ZERO
     C**********           Z-ADD*ZERO     WWPRIC                          150004
     C                     Z-SUBWWPRIC    WWPRIC                          150004
     C                     ENDIF
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CAAVP -  Retrieve Calculated average price (1) & (2)        *
      *  ------                                                       *
      *  Called by : #PDPTY                                           *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #CAAVP    BEGSR
      *
     C                     MOVE 'Y'       WRKA    1        Working field
     C                     Z-ADD22        X       20       Working field
     C                     MOVEA*BLANKS   NSEC             Event Security (22 * 10A)
     C                     MOVEA*ZERO     NOMI             Ex-Date position (22 * 15,ON)
     C                     MOVEA*ZERO     MARK             Market value (22 * 15,ON)
     C                     CLEARSVRCD
     C                     MOVELNWRCD     SVRCD            Saved LF/SECOALL5 field
      *
      ***  Access to Stock Allocation with same Coporate Action Reference,
      ***  same branch, same depot, same customer/book indicator, same book
      ***  same customer and portfolio
      ***  (||| If cust/book is 'B', book must be filled and customer portfolio must be blanks
      ***  else if cust/book is 'C', book must be blanks and customer/portfolio filled !!!)
      *
     C                     MOVE MCCORF    WKCORF
     C                     MOVE MCOPTN    WKOPTN
     C                     MOVE MCBRCD    WKBRCD
     C                     MOVE MCDDPT    WKDDPT
     C                     MOVE MCCOTP    WKCOTP
     C                     MOVE MCBOOK    WKBOOK
     C                     MOVE MCCNUM    WKCNUM
     C                     MOVE MCPTFR    WKPTFR
      *
     C           KWCOA3    SETLLSECOALL3
     C           KWCOA3    READESECOALL3                 48
      *
     C           *IN48     DOWEQ*OFF
      *
      ***  If working field is 'Y'
      *
     C           WRKA      IFEQ 'Y'
      *
      ***  Calculate consideration of event security = Ex-Date position * Average price
      *
     C                     MOVE *ZERO     WWTOTM 248       Total Market
     C                     Z-ADD*ZERO     WWCONE 238
     C           MCEXPO    MULT WWPRIC    WWCONE           Consideration of event sec.
      *
     C           MAPTYP    IFEQ 'CR'
     C           MHADRE    ANDEQ'A'                                       137881
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C*****      MAPTYP    OREQ 'NC'                                      137881
      *
      ***  Calculate Market value of event security
      ***  = Ex-Date position (held on first record readm in fact it is same on all records)
      ***    multiplied by market ex-price
      *
     C                     Z-ADD*ZERO     WWMRKV 238
     C           MCEXPO    MULT MAEXPC    WWMRKV           Market Value
      *
      ***  Fill the 3 arrays at index X=22
      *
     C                     MOVE MASESN    NSEC,X           Event Security
     C                     Z-ADDMCEXPO    NOMI,X           Ex-Date position
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Setup to 'N' working field and setup X by 1
      *
     C                     Z-ADDWWMRKV    WWTOTM
     C                     ENDIF
     C                     Z-ADD1         X
     C                     MOVE 'N'       WRKA
     C                     ENDIF                           WRKA='Y'
      *
      ***  If new security is not '**CASH**'
      *
     C           MCSESN    IFNE '**CASH**'
      *
      ***  Calculate Market Value = actual stock allocation multiplied by market price
      *
     C                     Z-ADDMCASTA    WWMRKV
      *                                                                   137881
     C                     MOVE MCSESN    WKSESN    P                     137881
     C                     EXSR #SECTN                                    137881
      *                                                                   137881
     C           WNNMDP    IFEQ 1                                         137881
     C           WWMRKV    DIV  10        WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 2                                         137881
     C           WWMRKV    DIV  100       WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 3                                         137881
     C           WWMRKV    DIV  1000      WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 4                                         137881
     C           WWMRKV    DIV  10000     WWMRKV                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
      *
     C                     SELEC
      *
      ***  Retrieve the market price depends on processing type
      *
     C           MAPTYP    WHEQ 'CR'
     C                     Z-ADD1         Y       20
     C           MCSESN    LOKUPSECUR,Y                  89
     C           *IN89     IFEQ *ON
     C                     MULT NPR,Y     WWMRKV
     C                     ENDIF
      *
     C           MAPTYP    WHEQ 'CE'
     C                     MULT MAEXPC    WWMRKV
      *
     C           MAPTYP    WHEQ 'OF'
     C                     MULT MIMKTP    WWMRKV
      *
     C           MAPTYP    WHEQ 'RG'
     C                     MULT MFRIMP    WWMRKV
     C                     ENDSL
      *
      ***  Fill the 3 arrays at index X=22
      *
     C                     MOVE MCSESN    NSEC,X           Event Security
     C                     Z-ADDMCASTA    NOMI,X           Ex-Date position
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Increment X by 1
      *
     C                     ADD  WWMRKV    WWTOTM
     C                     ADD  1         X
     C                     ENDIF
      *
      ***  If new security is '**CASH**'
      *
     C           MCSESN    IFEQ '**CASH**'
      *
      ***  Calculate Market Value = actual cash allocation + actual cash rounding
      *
     C                     Z-ADDMCACAA    WWMRKV
     C                     ADD  MCACAR    WWMRKV
      *                                                                   137881
     C           WONBDP    IFEQ 1                                         137881
     C           WWMRKV    DIV  10        WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 2                                         137881
     C           WWMRKV    DIV  100       WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 3                                         137881
     C           WWMRKV    DIV  1000      WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 4                                         137881
     C           WWMRKV    DIV  10000     WWMRKV                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
      *
      ***  Fill the 3 arrays at index X
      *
     C                     MOVE MCSESN    NSEC,X           Event Security
     C                     Z-ADDWWMRKV    NOMI,X           Market value converted
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Increment X by 1
      *
     C                     ADD  WWMRKV    WWTOTM
     C                     ADD  1         X
     C                     ENDIF
      *
      ***  Read next record with same CO Reference, same option, same branch,
      ***  same depot, customer/book ind 'C' or 'B', same book or cust./port.
      *
     C           KWCOA3    READESECOALL3                 48
     C                     ENDDO
      *
      ***  Setup X by 1
      ***  Do while X is lower than 23 and array containing the security
      ***  at index X is not blank
      *
     C                     Z-ADD1         X
     C           X         DOWLT23
     C***********NSEC,X    ANDNE*BLANKS                                   162290
     C           NSEC,X    IFNE *BLANKS                                   162290
      *
      ***  Calculate % of Total Market Value (WWPTOM)
      ***           MARK,X
      ***  = -------------------  X  100
      ***     Total Market Value
      *
     C*****                Z-ADD*ZERO     WWPTOM 118                      137881
     C                     Z-ADD*ZERO     WWPTOM 238                      137881
     C           WWTOTM    IFNE *ZERO
     C*****                Z-ADDMARK,X    WWK170 170                      137881
     C                     Z-ADDMARK,X    WWK238 238                      137881
     C*****                MULT 100       WWK170                          137881
     C*****      WWK170    DIV  WWTOTM    WWPTOM                          137881
     C           WWK238    DIV  WWTOTM    WWPTOM                          137881
     C           WWPTOM    MULT 100       WWPTOM                          137881
     C                     ENDIF
      *
      ***  Calculate Consideration (WWCONS)
      ***     % of Total Market Value  *  Consideration of event security
      *****=*------------------------------------------------------------ 137881
      *******                         NOMI,X                              137881
      *
     C*****                Z-ADD*ZERO     WWCONS 158                      137881
     C                     Z-ADD*ZERO     WWCONS 238                      137881
     C*****      NOMI,X    IFNE *ZERO                                     137881
     C                     Z-ADDWWPTOM    WWK238 238
     C                     MULT WWCONE    WWK238
     C*****      WWK238    DIV  NOMI,X    WWCONS                          137881
     C*****                ENDIF                                          137881
      *
      ***  If security is not '**CASH**'
      *
     C*****      MCSESN    IFNE '**CASH**'                                137881
     C           NSEC,X    IFNE '**CASH**'                                137881
      *
      ***  Calculate Average Price (2) (WWAVR2) and store result in the array average price
      ***     Consideration
      ***  = ---------------
      ***        NOMI,X
      *
     C                     Z-ADD*ZERO     WWAVR2 158
     C           NOMI,X    IFNE *ZERO
     C*****      WWCONS    DIV  NOMI,X    WWAVR2                          137881
     C           WWK238    DIV  NOMI,X    WWAVR2                          137881
     C                     ENDIF
     C           WWAVR2    DIV  100       WWAVR2                          137881
     C                     Z-ADDWWAVR2    AVPR,X
     C                     ENDIF                           Sec.<>'**CASH**'
      *
      ***  If security is '**CASH**'
      *
     C*****      MCSESN    IFEQ '**CASH**'                                137881
     C           NSEC,X    IFEQ '**CASH**'                                137881
      *
      ***  Calculate Realised Profit (WWREPT)
      ***  = NOMI,X  -  Consideration
      *
     C                     Z-ADD*ZERO     WWREPT 238
     C           WWK238    DIV  100       WWCONS                          137881
     C           NOMI,X    SUB  WWCONS    WWREPT
     C                     ENDIF                           Sec.='**CASH**'
      *
      ***  Increment X by 1
      *
     C                     ENDIF                           NSEC,X <> ' '  162290
     C                     ADD  1         X
     C                     ENDDO
      *
      ***  Calculate Average Price (1) (WWAVR1)
      ***     Consideration of event security  +  realised profit
      ***  = -----------------------------------------------------
      ***                       Ex-Date Position
      *
     C                     Z-ADD*ZERO     WWAVR1 158
     C           MCEXPO    IFNE *ZERO
     C                     Z-ADDWWCONE    WWK238 238
     C                     ADD  WWREPT    WWK238
     C           WWK238    DIV  MCEXPO    WWAVR1
     C                     ENDIF
      *
     C                     CLEARNWRCD
     C                     MOVELSVRCD     NWRCD            Saved LF/SECOALL5 field
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CAPR - Processing for calculated price                      *
      *  -----                                                        *
      *  Called by : #PRFRO #PRFRR #PREX                              *
      *  Calls     : ZCCYCN                                           *
      *****************************************************************
      *
     C           #CAPR     BEGSR
      *
      ***                     ^(Nominal old position X average price) +/- cash element!
      ***                     CONVERTED IN nominal ccy of new Security
      ***  Calculated price = ---------------------------------------------------------
      ***                                          New position
      *
     C                     Z-ADD*ZERO     WWCAPR 158       Calculated price
     C********             Z-ADD*ZERO     WWCASH 238       Price converted in new security    150272
     C                     Z-ADD*ZERO     WWCASH 308       Price converted in new security    150272
     C                     Z-ADDMCEXPO    WWNMOP 150       Nominal old position
     C                     Z-ADDWWPRIC    WWAPOP 158       Average price old position
     C                     Z-ADDMCACAA    WWACAA 150       Actual cash allocation
     C                     Z-ADDMCACAR    WWACAR 150       Actual cash rounding
     C                     Z-ADDMCASTA    WWNWPO 150       New Position
      *
     C           WWNWPO    IFNE *ZERO
     C                     Z-ADD0         ZAMTF
      *
      ***  Multiply Nominal old position and Average price old position
      *
     C           WWNMOP    MULT WWAPOP    ZAMTF
      *
      ***  If Sign is '+' add the cash element else substract the cash element
      ***  Cash element = total cash
      ***                 (Actual cash allocation + Actual cash rounding)
      *
      *
     C           WWSIGN    IFEQ '+'
     C                     ADD  WWACAA    ZAMTF
     C                     ADD  WWACAR    ZAMTF
     C                     ELSE
     C           ZAMTF     SUB  WWACAA    ZAMTF
     C           ZAMTF     SUB  WWACAR    ZAMTF
     C                     ENDIF
      *
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     Z-ADDZAMTT     WWCASH
     C                     ENDIF                           ZAMFT<>*ZERO
      *
      ***  Divide the result by the new position
      *
     C           WWCASH    DIV  WWNWPO    WWCAPR
     C                     ENDIF
      *
     C                     ENDSR
      *                                                                   CEU017
      *****************************************************************   CEU017
      /EJECT                                                              CEU017
      *****************************************************************   CEU017
      *  #CAPRC - Processing for calculated price                     *   CEU017
      *  ------   for processing type 'CC'                            *   CEU017
      *  Called by : #PRCC                                            *   CEU017
      *  Calls     : ZCCYCN                                           *   CEU017
      *****************************************************************   CEU017
      *                                                                   CEU017
     C           #CAPRC    BEGSR                                          CEU017
      *                                                                   CEU017
      ***                     (Nom. old pos. X Avr Pr.) +/- cash rounding CEU017
      ***  Calculated price = ------------------------------------------- CEU017
      ***                                          New position           CEU017
      *                                                                   CEU017
     C***********          Z-ADD*ZERO     WWCASH 238       Pr. convCEU017 150272
     C                     Z-ADD*ZERO     WWCASH 308       Pr. converted  150272
     C                     Z-ADD*ZERO     WWCAPR 158       Calc. price    CEU017
     C                     Z-ADDMCEXPO    WWNMOP 150       Nom. old pos   CEU017
     C                     Z-ADDWWPRIC    WWAPOP 158       Avr. pr old posCEU017
     C                     Z-ADDMCACAA    WWACAA 150       Cash alloc.    CEU017
     C                     Z-ADDMCACAR    WWACAR 150       Cash rounding  CEU017
     C                     Z-ADDMCASTA    WWNWPO 150       New Position   CEU017
      *                                                                   CEU017
     C                     Z-ADD*ZEROS    DEC     10                      CEU017
     C********** WNNMDP    ADD  5         DEC                      CEU017 147102
     C           WNNMDP    SUB  WONMDP    DEC                             147102
     C           DEC       ADD  5         DEC                             147102
     C********** WWNMOP    MULT POWER8,DECZAMTF                    CEU017 136931
     C           WWNMOP    MULT POWER9,DECZAMTF                           136931
      *                                                                   CEU017
     C                     Z-ADDZAMTF     WWCASH                          CEU017
      *                                                                   CEU017
      ***  Multiply Nominal old position and Average price old position   CEU017
      *                                                                   CEU017
     C           WWCASH    MULT WWAPOP    WWCASH                          CEU017
      *                                                                   CEU017
      ***  If Sign is '+' add the cash element else substract the cash eleCEU017
      *                                                                   CEU017
     C           WWSIGN    IFEQ '+'                                       CEU017
     C                     ADD  MCACAR    WWCASH                          CEU017
     C                     ELSE                                           CEU017
     C                     SUB  MCACAR    WWCASH                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C           CEU002    IFEQ 'Y'                                       CEU017
     C           WOINCY    ANDEQ'Y'                                       CEU017
      *                                                                   CEU017
     C           WOEUMD    IFEQ 'M'                                       CEU017
     C           WWCASH    MULT WOEUER    WWCASH                          CEU017
     C                     ELSE                                           CEU017
     C           WWCASH    DIV  WOEUER    WWCASH                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C                     ELSE                                           CEU017
     C                     Z-ADDWWCASH    ZAMTF                           151931
     C                     MOVE WONMCY    ZCCYF                           CEU017
     C                     MOVE WOSPRT    ZRATEF                          CEU017
     C                     MOVE WOMDIN    ZMDINF                          CEU017
     C                     MOVE WONBDP    ZCDPF                           CEU017
     C                     MOVE WNNMCY    ZCCYT                           CEU017
     C                     MOVE WNSPRT    ZRATET                          CEU017
     C                     MOVE WNMDIN    ZMDINT                          CEU017
     C                     MOVE WNNBDP    ZCDPT                           CEU017
     C                     EXSR ZCCYCN                                    CEU017
     C                     Z-ADDZAMTT     WWCASH                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
      ***  Divide the result by the new position                          CEU017
      *                                                                   CEU017
     C           WWCASH    DIV  WWNWPO    WWCAPR                          CEU017
      *                                                                   CEU017
     C                     ENDSR                                          CEU017
      *                                                                   CEU017
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRDV -  Generate Trades/Depot Movements                     *
      *  -----    for processing type 'DV'                            *
      *  Called by : #PDPTY                                           *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRDV     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      ***  Generate a Trade Purchase for the book
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVE MCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual stock All.
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  If Market Price indicator is 'Y' use market price from PF/SECTYD
      ***  else use subscription price from PF/SECODVPD
      *
     C           MDMRKI    IFEQ 'Y'
     C                     Z-ADDWNMKPR    WWTPDY           Market Price
     C                     ELSE
     C           MDSBPR    IFNE *ZEROS                                    137881
     C                     Z-ADDMDSBPR    WWTPDY           Subscription Price
     C                     ELSE                                           137881
     C           MAEXPC    IFNE *ZEROS                                    137881
     C                     Z-ADDMAEXPC    WWTPDY           Mrkt Ex Price  137881
     C                     ELSE                                           137881
     C                     Z-ADDWNMKPR    WWTPDY           Market Price   137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      ***  Generate a Depot Movement for the customer (WI)
      *
      ***  Setup specific field for this processing type
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'WI'      WWDPMV           movement type
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  If Market Price indicator is 'Y' use market price from PF/SECTYD
      ***  else use subscription price from PF/SECODVPD
      *
     C           MDMRKI    IFEQ 'Y'
     C*********************Z-ADDWNMKPR    WWMKTP           Market Price   161910
     C                     Z-ADDWWPRIC    WWTPDY           COMP.PRICE     161910
     C                     ELSE
     C           MDSBPR    IFNE *ZEROS                                    137881
     C                     Z-ADDMDSBPR    WWMKTP           Subscription Price
     C                     ELSE                                           137881
     C           MAEXPC    IFNE *ZEROS                                    137881
     C                     Z-ADDMAEXPC    WWMKTP           Mrkt Ex Price  137881
     C                     ELSE                                           137881
     C*********************Z-ADDWNMKPR    WWMKTP           Market P137881 161910
     C                     Z-ADDWWPRIC    WWTPDY           COMP.PRICE     161910
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF
     C                     Z-ADDMCASTA    WWDPNA           Actual stock allocation
     C                     MOVE MSCHTP    WALLOC
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFR -  Check processing for type 'FR'                      *
      *  -----                                                        *
      *  Called by : #PDPTY                                           *
      *  Calls     : #PRFRR #PRFRO #PRFRA                             *
      *****************************************************************
      *
     C           #PRFR     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'FR' and New Security entered and Replace
      *
     C           MENSEC    WHNE MASESN
     C           MEADRE    ANDEQ'R'
     C                     EXSR #PRFRR
      *
      ***  Processing type 'FR' and Old Security entered and Replace
      *
     C           MENSEC    WHEQ MASESN
     C           MEADRE    ANDEQ'R'
     C                     EXSR #PRFRO
      *
      ***  Processing type 'FR' and Add
      *
     C           MEADRE    WHEQ 'A'
     C                     EXSR #PRFRA
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRR -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'FR' and New Security entered  *
      *            and Replace                                        *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #CAPR #SDPMV                *
      *****************************************************************
      *
     C           #PRFRR    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWTPDY           Average Price
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWMKTP           Average Price
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
     C                     MOVE MSCHTP    WALLOC
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
     C                     MOVE MSCHTP    WALLOC
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRO -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'FR' and Old Security entered  *
      *            and Replace                                        *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #CAPR #SDPMV                *
      *****************************************************************
      *
     C           #PRFRO    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWTPDY           Average Price
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWMKTP           Average Price
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
     C                     MOVE MSCHTP    WALLOC
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'WI'      WWDPMV           movement type
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
     C                     MOVE MSCHTP    WALLOC
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRA -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'FR' and Add                   *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRFRA    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C                     Z-ADD*ZERO     WWTPDY           Price=0
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADD*ZERO     WWMKTP           Price=0
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCR -  Check processing for type 'CR'                      *
      *  -----                                                        *
      *  Called by : #PDPTY                                           *
      *  Calls     : #PRCRR #PRCRA                                    *
      *****************************************************************
      *
     C           #PRCR     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'CR' and Replace
      *
     C*****      MEADRE    WHEQ 'R'                                       137881
     C           MHADRE    WHEQ 'R'                                       137881
     C                     EXSR #PRCRR
      *
      ***  Processing type 'CR' and Add
      *
     C*****      MEADRE    WHEQ 'A'                                       137881
     C           MHADRE    WHEQ 'A'                                       137881
     C                     EXSR #PRCRA
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCRR -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'CR' and Replace               *
      *  Called by : #PRCR                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRCRR    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
     C                     SETOF                     52                   165216
     C********** MACOAT    IFEQ 'SO'                               165216 186486
     C********** MCBOOK    IFEQ WXBOOK                                                 186486 215278
     C           MAPTYP    IFEQ 'CR'                                                          215278
     C           MCBOOK    ANDEQWXBOOK                                                        215278
     C           MCBSEC    ANDEQ*BLANKS                                   165216
     C                     SETON                     52                   165216
     C                     END                                            165216
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C           *IN52     IFEQ '0'                                       165216
     C                     MOVELMCBOOK    WXBOOK                          186486
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
     C                     END                                            165216
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
     C                     SETOF                     51                   165216
     C********** MACOAT    IFEQ 'SO'                               165216 186486
     C********** MCBSEC    ANDEQ*BLANKS                            165216 186486
     C********** MCBSEC    IFEQ *BLANKS                                                186486 215278
     C           MAPTYP    IFEQ 'CR'                                                          215278
     C           MCBSEC    ANDEQ*BLANKS                                                       215278
     C                     SETON                     51                   165216
     C                     END                                            165216
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C           *IN51     IFEQ '0'                                       165216
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
     C                     END                                            165216
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCRA -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'CR' and Add                   *
      *  Called by : #PRCR                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRCRA    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
     C                     SETOF                     52                                       215278
     C           MAPTYP    IFEQ 'CR'                                                          215278
     C           MCBOOK    ANDEQWXBOOK                                                        215278
     C           MCBSEC    ANDEQ*BLANKS                                                       215278
     C                     SETON                     52                                       215278
     C                     END                                                                215278
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C           *IN52     IFEQ '0'                                                           215278
     C                     MOVELMCBOOK    WXBOOK                                              215278
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average price (1)
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
     C                     END                                                                215278
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
     C                     MOVE WNNMCY    WWNMCY
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR3
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
     C                     SETOF                     51                                       215278
     C           MAPTYP    IFEQ 'CR'                                                          215278
     C           MCBSEC    ANDEQ*BLANKS                                                       215278
     C                     SETON                     51                                       215278
     C                     END                                                                215278
      *                                                                                       215278
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C           *IN51     IFEQ '0'                                                           215278
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
      *
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     END                                                                215278
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
      *
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR3
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCE -  Generate Trades/Depot Movements                     *
      *  -----    for processing type 'CE'                            *
      *           (Same as processing type 'CR' and Add               *
      *  Called by : #PDPTY                                           *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRCE     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWAVR1    WWMKTP           Average Price (1)
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROF -  Check processing for type 'OF'                      *
      *  -----                                                        *
      *  Called by : #PDPTY                                           *
      *  Calls     : #PROFE #PROFP                                    *
      *****************************************************************
      *
     C           #PROF     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'OF' and Offer type 'E'
      *
     C           MIOFTY    WHEQ 'E'
     C                     EXSR #PROFE
      *
      ***  Processing type 'OF' and Purchase Offers
      ***  or Processing type 'OF' and Subscriptions
      *
     C           MIOFTY    WHEQ 'P'
     C           MIOFTY    OREQ 'S'
     C                     EXSR #PROFP
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROFE -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'OF' and Exchange Offers       *
      *  Called by : #PROF                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PROFE    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C*******              Z-ADDMCHOST    WWNOML           Holding Taken as stock             145872
     C*******              Z-ADDMCASTA    WWNOML           Actual Stock                145872 158451
     C***  Actual Stock Allocation divided by Number of New Shares                            158451
     C***  multiplied by Number of Old Shares                                                 158451
     C                     Z-ADD*ZEROS    WWNOML                                              158451
     C           MCASTA    DIV  MINSHA    WWNOML                                              158451
     C           WWNOML    MULT MIOSHA    WWNOML                                              158451
     C********             Z-ADDWWAVR1    WWTPDY         Average Price(1) 166599
     C                     Z-ADDWWPRIC    WWTPDY           Av Price(1)    166599
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C*****                Z-ADD1         Y       20                                          145872
     C*****      WWSESN    LOKUPNSEC,Y                   89                                   145872
     C*****      *IN89     IFEQ *ON                                                           145872
     C*****                Z-ADDAVPR,Y    WWTPDY           Average price (2)                  145872
     C*****                ELSE                                                               145872
     C*****                Z-ADD*ZERO     WWTPDY                                              145872
     C*****                ENDIF                                                              145872
     C                     Z-ADDWWAVR1    WWTPDY           Average Price                      145872
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C********             Z-ADDWWAVR1    WWMKTP           Average Price1 166599
     C                     Z-ADDWWPRIC    WWTPDY           Average Price1 166599
     C*******              Z-ADDMCEXPO    WWDPNA           ex-date position                  145872
     C*******              Z-ADDMCASTA    WWDPNA           actual stock position      145872 158451
     C***  Actual Stock Allocation divided by Number of New Shares                           158451
     C***  multiplied by Number of Old Shares                                                158451
     C                     Z-ADD*ZEROS    WWDPNA                                             158451
     C           MCASTA    DIV  MINSHA    WWDPNA                                             158451
     C           WWDPNA    MULT MIOSHA    WWDPNA                                             158451
      *                                                                                      148404
     C           WWDPNA    IFLT *ZEROS                                                       148404
     C                     Z-SUBWWDPNA    WWDPNA                                             148404
     C                     MOVE 'WI'      WWDPMV                                             148404
     C                     ENDIF                                                             148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
     C*****                Z-ADD1         Y       20                                          145872
     C*****      WWSESN    LOKUPNSEC,Y                   89                                   145872
     C*****      *IN89     IFEQ *ON                                                           145872
     C*****                Z-ADDAVPR,Y    WWMKTP           Average price (2)                  145872
     C*****                ELSE                                                               145872
     C*****                Z-ADD*ZERO     WWMKTP                                              145872
     C*****                ENDIF                                                              145872
     C                     Z-ADDWWAVR1    WWMKTP           Average Price                      145872
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WO'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROFP -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'OF' and Purchase Offers       *
      *         or for processing type 'OF' and Subscriptions         *
      *  Called by : #PROF                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PROFP    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C**********           Z-ADDMCEXPO    WWNOML           ex-date position                   193662
     C                     Z-ADDMCASTA    WWNOML                                              193662
      *
     C           MIOFTY    IFEQ 'P'
     C           MCEXPO    IFGT *ZERO
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     ELSE
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     ENDIF
     C                     ELSE
     C           MCEXPO    IFGT *ZERO
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     ELSE
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     ENDIF
     C                     ENDIF
      *
     C           MIOFTY    IFEQ 'P'
     C                     Z-ADDMIREPR    WWTPDY           Receive price
     C                     ELSE
     C                     Z-ADDMISUPR    WWTPDY           Subscription price
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWTDTP    IFEQ 'TS'                       Sale
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ELSE                            Purchase
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     ENDIF
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C**********           Z-ADDMCEXPO    WWDPNA           ex-date position                   193662
     C                     Z-ADDMCASTA    WWDPNA                                              193662
      *
     C           MIOFTY    IFEQ 'P'
     C           MCEXPO    IFLT *ZERO
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     ELSE
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     ENDIF
     C                     ELSE
     C           MCEXPO    IFLT *ZERO
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     ELSE
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     ENDIF
     C                     ENDIF
      *
     C           MIOFTY    IFEQ 'P'
     C                     Z-ADDMIREPR    WWMKTP           Receive price
     C                     ELSE
     C                     Z-ADDMISUPR    WWMKTP           Subscription price
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PREX -   Generate Trades/Depot Movements                    *
      *  -----     for processing type 'EX'                           *
      *            (Same as processing type 'CR' and Replace)         *
      *  Called by : #PDPTY                                           *
      *  Calls     : #SECTN #ACOAT #WTRAD #CAPR #SDPMV                *
      *****************************************************************
      *
     C           #PREX     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
      *****************************************************************                161732 258814
      *****When*generate*transaction*for*the*old*position,*the*********                161732 258814
      *****nomnial*should*be*equal*to*the*holding*taken*as*stock*******                161732 258814
      *****+*holding*taken*as*cash.*This*will*allow*for*the*option*of**                161732 258814
      *****take*part*stock*and*keep*rest.******************************                161732 258814
      *****************************************************************                161732 258814
      *                                                                   161732
    C***********          Z-ADDMCEXPO    WWNOML           Ex-Date positio161732
     C********** MCHOST    ADD  MCHOCA    WWNOML                                       161732 258814
      *****************************************************************                161732 258814
     C                     Z-ADDMCEXPO    WWNOML                                              258814
      *                                                                   161732
     C                     Z-ADDWWPRIC    WWTPDY           Average price for the book
      *                                                                                      148404
     C           WWNOML    IFLT *ZEROS                                                       148404
     C                     MOVE 'Y'       WWINVR  1                                          148404
     C                     Z-SUBWWNOML    WWNOML                                             148404
     C                     MOVE 'TP'      WWTDTP                                             148404
     C                     ELSE                                                              148404
     C                     MOVE 'N'       WWINVR                                             148404
     C                     ENDIF                                                             148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '+'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                                          148404
     C                     MOVELWWPAAC    WWPAYT           Pay to                            148404
     C                     MOVE *BLANKS   WWPYFM           Pay from                          148404
     C                     ELSE                                                              148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                                             148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWPRIC    WWMKTP           Average Price for customer
     C***********          Z-ADDMCEXPO    WWDPNA           ex-date positio161732
      *****************************************************************                161732 258814
      *****When*generate*transaction*for*the*old*position,*the*********                161732 258814
      *****nomnial*should*be*equal*to*the*holding*taken*as*stock*******                161732 258814
      *****+*holding*taken*as*cash.*This*will*allow*for*the*option*of**                161732 258814
      *****take*part*stock*and*keep*rest.******************************                161732 258814
      *****************************************************************                161732 258814
     C********** MCHOST    ADD  MCHOCA    WWDPNA                                       161732 258814
     C                     Z-ADDMCEXPO    WWDPNA                                              258814
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WI'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     MOVE '+'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WO'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRG -  Check processing for type 'RG'                      *
      *  -----                                                        *
      *  Called by : #PDPTY                                           *
      *  Calls     : #PRRGZ #PRRGM #PRRGC                             *
      *****************************************************************
      *
     C           #PRRG     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'RG' and "Average Price Option" is 'Z' (zero average price)
      *
     C           MFAVOP    WHEQ 'Z'
     C                     EXSR #PRRGZ
      *
      ***  Processing type 'RG' and "Average Price Option" is 'M' (market price)
      *
     C           MFAVOP    WHEQ 'M'
     C                     EXSR #PRRGM
      *
      ***  Processing type 'RG' and "Average Price Option" is 'C' (calculated)
      *                                                    OR 'I' (calculated)     161746
      *
     C           MFAVOP    WHEQ 'C'
     C           MFAVOP    OREQ 'I'                                                161746
     C                     EXSR #PRRGC
      *
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGZ -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'RG' and zero average price    *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRRGZ    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C                     Z-ADD*ZERO     WWTPDY           Price=0
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADD*ZERO     WWMKTP           Price=0
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WO'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGM -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'RG' and market price          *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD ZCCYCN #SDPMV               *
      *****************************************************************
      *
     C           #PRRGM    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWPRIC    WWTPDY           Average price for the book
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TP'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD*ZERO     WWTPDY
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***           (Consider. event sec.  -  consider. new sec.  -  actual cash rounding)
      ***  Price =  ----------------------------------------------------------------------
      ***                                   Old Position
      *
      ***  Consideration event security = Ex-Date Position  *  Current Average Price
      ***  Consideration new security = Ex-Date Position  *  Right Market Price
      ***  Actual Cash Rounding = Converted from nominal ccy of event sec. to nominal ccy of new sec
      ***  Old Position = Ex-Date Position
      *
     C           MCEXPO    IFNE *ZERO
      *
     C                     Z-ADDMCEXPO    WWKCOE 150
     C                     MULT WWPRIC    WWKCOE           Cons. event Sec.
      *
     C                     Z-ADDMCEXPO    WWKCON 150
     C                     MULT MFRIMP    WWKCON           Cons. new Sec.
      *
     C                     Z-ADDWWKCOE    WWK150 150
     C                     SUB  WWKCON    WWK150
      *
     C                     Z-ADDMCACAA    ZAMTF
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     SUB  ZAMTT     WWK150           Actual cash rounding
     C                     ENDIF
      *
     C           WWK150    DIV  MCEXPO    WWTPDY           Calculated Price
     C                     ENDIF
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock allocation
     C                     Z-ADDMFRIMP    WWTPDY           Rights Market Price
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR3
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWPRIC    WWMKTP           Average price for the customer
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WI'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
     C                     Z-ADD*ZERO     WWMKTP
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***           (Consider. event sec.  -  consider. new sec.  -  actual cash rounding)
      ***  Price =  ----------------------------------------------------------------------
      ***                                   Old Position
      *
      ***  Consideration event security = Ex-Date Position  *  Current Average Price
      ***  Consideration new security = Ex-Date Position  *  Right Market Price
      ***  Actual Cash Rounding = Converted from nominal ccy of event sec. to nominal ccy of new sec
      ***  Old Position = Ex-Date Position
      *
     C           MCEXPO    IFNE *ZERO
      *
     C                     Z-ADDMCEXPO    WWKCOE 150
     C                     MULT WWPRIC    WWKCOE           Cons. event Sec.
      *
     C                     Z-ADDMCEXPO    WWKCON 150
     C                     MULT MFRIMP    WWKCON           Cons. new Sec.
      *
     C                     Z-ADDWWKCOE    WWK150 150
     C                     SUB  WWKCON    WWK150
      *
     C                     Z-ADDMCACAA    ZAMTF
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     SUB  ZAMTT     WWK150           Actual cash rounding
     C                     ENDIF
      *
     C           WWK150    DIV  MCEXPO    WWMKTP
     C                     ENDIF
      *
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
     C                     Z-ADDMFRIMP    WWMKTP           Rights Market Price
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WO'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR3
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGC -  Generate Trades/Depot Movements                    *
      *  ------    for processing type 'RG' and calculated price      *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRRGC    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C***********          MULT AVPR,Y    WWTPDY           AveragePrice(2)163065
     C                     Z-ADDAVPR,Y    WWTPDY           AveragePrice(2)163065
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual sotck allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C***********          MULT AVPR,Y    WWTPDY           AveragePrice(2)163065
     C                     Z-ADDAVPR,Y    WWTPDY           AveragePrice(2)163065
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TS'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR3
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *                                                                   148404
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C***********          MULT AVPR,Y    WWMKTP           AveragePrice(2)163065
     C                     Z-ADDAVPR,Y    WWMKTP           AveragePrice(2)163065
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
     C                     MOVE 'WI'      WWDPMV           movement type
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WO'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *                                                                   148404
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C***********          MULT AVPR,Y    WWMKTP           AveragePrice(2)163065
     C                     Z-ADDAVPR,Y    WWMKTP           AveragePrice(2)163065
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR3
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRNC  -  Generate Trades/Depot Movements                    *
      *  -----     for processing type 'NC'                           *
      *  Called by : #PDPTY                                           *
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *
      *****************************************************************
      *
     C           #PRNC     BEGSR
      *
      ***  If the Security Shortname has been changed
      *
     C           MLSESN    IFNE *BLANKS
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C*****                Z-ADDWWAVR1    WWTPDY           Average Price (137881
     C                     Z-ADDWWPRIC    WWTPDY                          137881
      *                                                                   148404
     C           WWNOML    IFLT *ZEROS                                    148404
     C                     MOVE 'Y'       WWINVR  1                       148404
     C                     Z-SUBWWNOML    WWNOML                          148404
     C                     MOVE 'TP'      WWTDTP                          148404
     C                     ELSE                                           148404
     C                     MOVE 'N'       WWINVR                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVE *BLANKS   WWPAYT           Pay to         148404
     C                     MOVELWWPAAC    WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVELWWPAAC    WWPAYT           Pay to
     C                     MOVE *BLANKS   WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C*****                Z-ADDWWAVR1    WWTPDY           Average Price (                    137881
     C                     Z-ADDWWPRIC    WWTPDY                                              137881
      *                                                                                       148404
     C           WWNOML    IFLT *ZEROS                                                        148404
     C                     MOVE 'Y'       WWINVR  1                                           148404
     C                     Z-SUBWWNOML    WWNOML                                              148404
     C                     MOVE 'TS'      WWTDTP                                              148404
     C                     ELSE                                                               148404
     C                     MOVE 'N'       WWINVR                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MCCOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C           WWINVR    IFEQ 'Y'                                       148404
     C                     MOVELWWPAAC    WWPAYT           Pay to         148404
     C                     MOVE *BLANKS   WWPYFM           Pay from       148404
     C                     ELSE                                           148404
     C                     MOVE *BLANKS   WWPAYT           Pay to
     C                     MOVELWWPAAC    WWPYFM           Pay from
     C                     ENDIF                                          148404
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #WTRAD
     C                     MOVE WKTRRF    WWTRR2
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WO) (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'WO'      WWDPMV           movement type
     C*****                Z-ADDWWAVR1    WWMKTP           Average Price (137881
     C                     Z-ADDWWPRIC    WWMKTP                          137881
     C                     Z-ADDMCEXPO    WWDPNA           ex-date position
      *                                                                   148404
     C           WWDPNA    IFLT *ZEROS                                    148404
     C                     Z-SUBWWDPNA    WWDPNA                          148404
     C                     MOVE 'WI'      WWDPMV                          148404
     C                     ENDIF                                          148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR1
      *
      ***  Setup specific field for this processing type
      ***  Generate a Depot Movement for the customer (WI) (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'WI'      WWDPMV           movement type
     C*****                Z-ADDWWAVR1    WWMKTP           Average Price (137881
     C                     Z-ADDWWPRIC    WWMKTP                          137881
     C                     Z-ADDMCASTA    WWDPNA           actual stock allocation
      *                                                                                       148404
     C           WWDPNA    IFLT *ZEROS                                                        148404
     C                     Z-SUBWWDPNA    WWDPNA                                              148404
     C                     MOVE 'WO'      WWDPMV                                              148404
     C                     ENDIF                                                              148404
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
     C                     MOVE MSCHTP    WALLOC
      *
      ***  Setup Default fields
      ***  And generate a new depot movement
      *
     C                     EXSR #SDPMV
     C                     MOVE WKTRRF    WWTRR2
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************   CEU017
      /EJECT                                                              CEU017
      *****************************************************************   CEU017
      *  #PRCC  -  Generate Trades/Depot Movements                    *   CEU017
      *  ------    for processing type 'CC'                           *   CEU017
      *  Called by : #PRCR                                            *   CEU017
      *  Calls     : #SECTN #ACOAT #WTRAD #SDPMV                      *   CEU017
      *****************************************************************   CEU017
      *                                                                   CEU017
     C           #PRCC     BEGSR                                          CEU017
      *                                                                   150272
     C                     MOVE 'N'       WW2TRD  1                       150272
     C                     MOVE 'N'       WW4TRD  1                       150272
     C                     MOVE 'N'       WW8TRD  1                       150272
      *                                                                   150272
     C                     MOVE 'N'       WW2DPT  1                       150272
     C                     MOVE 'N'       WW4DPT  1                       150272
     C                     MOVE 'N'       WW8DPT  1                       150272
      *                                                                   150272
     C                     Z-ADD*HIVAL    ZZNOML 110                      150272
      *                                                                   150272
     C                     Z-ADD200000000 ZRANG1 150                      150272
     C           ZRANG1    MULT 1000      ZRANG1                          150272
     C                     Z-ADD400000000 ZRANG2 150                      150272
     C           ZRANG2    MULT 1000      ZRANG2                          150272
      *                                                                   CEU017
      ***  Check Cust/Book indicator                                      CEU017
      *                                                                   CEU017
     C                     SELEC                                          CEU017
      *                                                                   CEU017
      ***  If Cust/Book indicator is 'B'                                  CEU017
      *                                                                   CEU017
     C           MCCOTP    WHEQ 'B'                                       CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Sale for the book (old position)              CEU017
      *                                                                   CEU017
     C                     MOVELMASESN    WWSESN    P      old security   CEU017
     C                     MOVELMASESN    WKSESN    P                     CEU017
     C                     MOVE 'TS'      WWTDTP           Sale           CEU017
      *                                                                   150272
     C           MCEXPO    IFGT ZZNOML                                    150272
      *                                                                   150272
     C           MCEXPO    IFLT ZRANG1                                    150272
     C                     MOVE 'Y'       WW2TRD                          150272
     C           MCEXPO    DIV  2         WWNOML           Ex-Date Positio150272
     C                     ELSE                                           150272
     C           MCEXPO    IFGE ZRANG1                                    150272
     C           MCEXPO    ANDLTZRANG2                                    150272
     C                     MOVE 'Y'       WW4TRD                          150272
     C           MCEXPO    DIV  4         WWNOML           Ex-Date Positio150272
     C                     ELSE                                           150272
     C           MCEXPO    IFGE ZRANG2                                    150272
     C                     MOVE 'Y'       WW8TRD                          150272
     C           MCEXPO    DIV  8         WWNOML           Ex-Date Positio150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
      *                                                                   150272
     C                     ELSE                                           150272
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date positioCEU017
     C                     ENDIF                                          150272
      *                                                                   150272
     C                     Z-ADDWWPRIC    WWTPDY           Current AverageCEU017
      *                                                                   148246
     C           WWNOML    IFLT *ZEROS                                    148246
     C                     MOVE 'Y'       WWINVR  1                       148246
     C                     Z-SUBWWNOML    WWNOML                          148246
     C                     MOVE 'TP'      WWTDTP                          148246
     C                     ELSE                                           148246
     C                     MOVE 'N'       WWINVR                          148246
     C                     ENDIF                                          148246
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WONMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Access to Corporate Action Type Details to retrieve            CEU017
      ***  Settlement Account Code                                        CEU017
      *                                                                   CEU017
     C                     MOVE MACOAT    WKCOAT                          CEU017
     C                     EXSR #ACOAT                                    CEU017
      *                                                                   CEU017
     C                     MOVE BVCOTC    WWCUST                          CEU017
     C                     MOVE MMACOD    WWSTAC           Settl. Account CEU017
     C                     MOVE '01'      WWSTSQ           Settl. Account CEU017
     C           WWINVR    IFEQ 'Y'                                       148246
     C                     MOVE *BLANKS   WWPAYT           Pay to         148246
     C                     MOVELWWPAAC    WWPYFM           Pay from       148246
     C                     ELSE                                           148246
     C                     MOVELWWPAAC    WWPAYT           Pay to         CEU017
     C                     MOVE *BLANKS   WWPYFM           Pay from       CEU017
     C                     ENDIF                                          148246
     C                     MOVE MSCHTP    WALLOC                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields for a new Trade                           CEU017
      *                                                                   CEU017
     C                     EXSR #WTRAD                                    CEU017
     C                     MOVE WKTRRF    WWTRR1                          CEU017
      *                                                                   150272
     C           WW2TRD    IFEQ 'Y'                                       150272
     C                     EXSR #WTRAD                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     ELSE                                           150272
     C           WW4TRD    IFEQ 'Y'                                       150272
     C                     EXSR #WTRAD                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     ELSE                                           150272
     C           WW8TRD    IFEQ 'Y'                                       150272
     C                     EXSR #WTRAD                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     EXSR #WTRAD                                    150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Purchase for the book (old position)          CEU017
      *                                                                   CEU017
     C                     MOVELMCSESN    WWSESN    P      new security   CEU017
     C                     MOVELMCSESN    WKSESN    P                     CEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE 'TP'      WWTDTP           Purchase       CEU017
     C                     Z-ADDMCASTA    WWNOML           actual stock   CEU017
      *                                                                   148246
     C           WWNOML    IFLT *ZEROS                                    148246
     C                     MOVE 'Y'       WWINVR                          148246
     C                     Z-SUBWWNOML    WWNOML                          148246
     C                     MOVE 'TS'      WWTDTP                          148246
     C                     ELSE                                           148246
     C                     MOVE 'N'       WWINVR                          148246
     C                     ENDIF                                          148246
      *                                                                   148246
     C                     MOVE '-'       WWSIGN  1        Sign           CEU017
     C                     EXSR #CAPRC                                    CEU017
     C                     Z-ADDWWCAPR    WWTPDY           calculated pricCEU017
      *                                                                   CEU017
     C                     MOVE WNNMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Access to Corporate Action Type Details to retrieve            CEU017
      ***  Settlement Account Code                                        CEU017
      *                                                                   CEU017
     C                     MOVE MCCOAT    WKCOAT                          CEU017
     C                     EXSR #ACOAT                                    CEU017
      *                                                                   CEU017
     C                     MOVE BVCOTC    WWCUST                          CEU017
     C                     MOVE MMACOD    WWSTAC           Settl. Account CEU017
     C                     MOVE '01'      WWSTSQ           Settl. Account CEU017
     C           WWINVR    IFEQ 'Y'                                       148246
     C                     MOVELWWPAAC    WWPAYT           Pay to         148246
     C                     MOVE *BLANKS   WWPYFM           Pay from       148246
     C                     ELSE                                           148246
     C                     MOVE *BLANKS   WWPAYT           Pay to         CEU017
     C                     MOVELWWPAAC    WWPYFM           Pay from       CEU017
     C                     ENDIF                                          148246
     C                     MOVE MSCHTP    WALLOC                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields for a new Trade                           CEU017
      *                                                                   CEU017
     C                     EXSR #WTRAD                                    CEU017
      *                                                                   150272
     C           WW2TRD    IFEQ 'Y'                                       150272
     C           WW4TRD    OREQ 'Y'                                       150272
     C           WW8TRD    OREQ 'Y'                                       150272
     C                     MOVE WKTRRF    WWTRR3                          150272
     C                     ELSE                                           150272
     C                     MOVE WKTRRF    WWTRR2                          CEU017
     C                     ENDIF                                          150272
      *                                                                   CEU017
     C           MCCOTP    WHEQ 'C'                                       CEU017
      *                                                                   CEU017
      ***  If Cust/Book indicator is 'C'                                  CEU017
      *                                                                   CEU017
     C           WNOPOS    IFEQ 'N'                                       CEU017
      *                                                                   CEU017
      ***  No 'WO' for the dummy customer without a position (CPOSC)      CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Depot Movement for the customer (WO) (old position) CEU017
      *                                                                   CEU017
     C                     MOVELMASESN    WWSESN    P      old security   CEU017
     C                     MOVELMASESN    WKSESN    P                     CEU017
     C                     MOVE 'WO'      WWDPMV           movement type  CEU017
     C                     Z-ADDWWPRIC    WWMKTP           Current AverageCEU017
      *                                                                   150272
     C           MCEXPO    IFGT ZZNOML                                    150272
      *                                                                   150272
     C           MCEXPO    IFLT ZRANG1                                    150272
     C                     MOVE 'Y'       WW2DPT                          150272
     C           MCEXPO    DIV  2         WWDPNA           Ex-Date Positio150272
     C                     ELSE                                           150272
     C           MCEXPO    IFGE ZRANG1                                    150272
     C           MCEXPO    ANDLTZRANG2                                    150272
     C                     MOVE 'Y'       WW4DPT                          150272
     C           MCEXPO    DIV  4         WWDPNA           Ex-Date Positio150272
     C                     ELSE                                           150272
     C           MCEXPO    IFGE ZRANG2                                    150272
     C                     MOVE 'Y'       WW8DPT                          150272
     C           MCEXPO    DIV  8         WWDPNA           Ex-Date Positio150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
      *                                                                   150272
     C                     ELSE                                           150272
     C                     Z-ADDMCEXPO    WWDPNA           ex-date positioCEU017
     C                     ENDIF                                          150272
      *                                                                   148246
     C           WWDPNA    IFLT *ZEROS                                    148246
     C                     Z-SUBWWDPNA    WWDPNA                          148246
     C                     MOVE 'WI'      WWDPMV                          148246
     C                     ENDIF                                          148246
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WONMCY    WWNMCY                          CEU017
     C                     MOVE MSCHTP    WALLOC                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields                                           CEU017
      ***  And generate a new depot movement                              CEU017
      *                                                                   CEU017
     C                     EXSR #SDPMV                                    CEU017
     C                     MOVE WKTRRF    WWTRR1                          CEU017
      *                                                                   150272
     C           WW2DPT    IFEQ 'Y'                                       150272
     C                     EXSR #SDPMV                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     ELSE                                           150272
     C           WW4DPT    IFEQ 'Y'                                       150272
     C                     EXSR #SDPMV                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     ELSE                                           150272
     C           WW8DPT    IFEQ 'Y'                                       150272
     C                     EXSR #SDPMV                                    150272
     C                     MOVE WKTRRF    WWTRR2                          150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     EXSR #SDPMV                                    150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          150272
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Depot Movement for the customer (WI) (old position) CEU017
      *                                                                   CEU017
     C                     MOVELMCSESN    WWSESN    P      new security   CEU017
     C                     MOVELMCSESN    WKSESN    P                     CEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE 'WI'      WWDPMV           movement type  CEU017
      *                                                                   CEU017
     C           WNOPOS    IFEQ 'N'                                       CEU017
     C                     MOVE '-'       WWSIGN  1        Sign           CEU017
     C                     EXSR #CAPRC                                    CEU017
     C                     Z-ADDWWCAPR    WWMKTP           calculated pricCEU017
     C                     ELSE                                           CEU017
     C                     Z-ADDWWPRIC    WWMKTP           calculated pricCEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C                     Z-ADDMCASTA    WWDPNA           actual stock alCEU017
      *                                                                   148246
     C           WWDPNA    IFLT *ZEROS                                    148246
     C                     Z-SUBWWDPNA    WWDPNA                          148246
     C                     MOVE 'WO'      WWDPMV                          148246
     C                     ENDIF                                          148246
      *                                                                   CEU017
     C                     MOVE WNNMCY    WWNMCY                          CEU017
     C                     MOVE MSCHTP    WALLOC                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields                                           CEU017
      ***  And generate a new depot movement                              CEU017
      *                                                                   CEU017
     C                     EXSR #SDPMV                                    CEU017
     C           WNOPOS    IFEQ 'N'                                       CEU017
      *                                                                   150272
     C           WW2DPT    IFEQ 'Y'                                       150272
     C           WW4DPT    OREQ 'Y'                                       150272
     C           WW8DPT    OREQ 'Y'                                       150272
     C                     MOVE WKTRRF    WWTRR3                          150272
     C                     ELSE                                           150272
     C                     MOVE WKTRRF    WWTRR2                          CEU017
     C                     ENDIF                                          150272
      *                                                                   150272
     C                     ELSE                                           CEU017
     C                     MOVE WKTRRF    WWTRR1                          CEU017
     C                     ENDIF                                          CEU017
     C                     ENDSL                           Check cust/bookCEU017
      *                                                                   CEU017
     C                     ENDSR                                          CEU017
      *                                                                   CEU017
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #POSET -  Retrieve current Position Settlement and update it *
      *  ------    to deleted or matured depending on record id       *
      *  Called by : #POSRV                                           *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #POSET    BEGSR
      *
      ***  Access Posistion Settlement file to retrieve current Position Settlement
      *
     C           KWPOSE    CHAINPOSET1               88
      *
     C           *IN88     IFEQ *OFF
      *
      ***  Check Record Identifier for Position Settlement file
      *
     C                     SELEC
      *
      ***  If record identifier is 'D'
      *
     C           RECI      WHEQ 'D'
     C                     MOVE '*'       RECI             deleted
     C                     MOVE 'D'       CHTP
     C                     Z-ADDBJRDNB    LCD
     C                     UPDATPOSETDF                89
      *
      ***  Record not found
      *
     C           *IN89     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD3         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 03 *
     C                     MOVE 'POSETDF 'DBFILE           ***************
     C                     MOVELWWPOSE    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           *IN89=*ON
      *
     C                     ADD  1         W03CNT
     C                     MOVE 'Y'       WWDATA           one Read
      *
      ***  If record identifier is 'M'
      *
     C           RECI      WHEQ 'M'
     C                     MOVE 'R'       RECI             Matured
     C                     MOVE 'R'       CHTP
     C                     Z-ADDBJRDNB    LCD
     C                     UPDATPOSETDF                89
      *
      ***  Record not found
      *
     C           *IN89     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD4         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 04 *
     C                     MOVE 'POSETDF 'DBFILE           ***************
     C                     MOVELWWPOSE    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     ADD  1         W06CNT
     C                     MOVE 'Y'       WWDATA           one Read
     C                     ENDSL                           Check RECI
     C                     ENDIF                           *IN88=*OFF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #WTRAD -  Setup default fields for a new Trade               *
      *  ------                                                       *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCE   *
      *              #PROFE #PROFP #PREX #PRTGZ #PRRGM #PRRGC #PRNC   *
      *  Calls     : #ACOAT #AOSEC ZNCD ZASIGN SPRCI ZBKDP ZAPNUM     *
      *              #AOPRF ZCCYCN ZTNLU1                             *
      *****************************************************************
      *
     C           #WTRAD    BEGSR
      *
      ** .. Trade reference
     C                     MOVE WWNTR1    WKTRRF  6
     C           WKTRRF    CHAINTRADHS               89
      *
     C           *IN89     DOWEQ*OFF
     C                     ADD  1         WWNTR1
     C                     MOVE WWNTR1    WKTRRF
     C           WKTRRF    CHAINTRADHS               89
     C                     ENDDO
     C                     ADD  1         WWNTR1
      *
     C                     CLEARTRADSDF
      *
      ** .. Branch
     C                     MOVE MCBRCD    TDBA
      ** .. Originat. Branch
     C                     MOVE MCBRCD    ORBR
      ** .. Book
     C                     MOVE MCBOOK    TDBK
      *
     C                     MOVE WKTRRF    TDRF
      *
      ***  Setup Specific fields
      *
      ** .. New Security
     C                     MOVE WWSESN    TDSS
      ** .. Trade Type
     C                     MOVE WWTDTP    TDTP
      ** .. Nominal
     C                     MOVE WWNOML    NOML
      ** .. Price/Discount/Yield
     C                     Z-ADDWWTPDY    TPDY
      ** .. Pay From
     C                     MOVE WWPYFM    PYFM
      ** .. Pay to
     C                     MOVE WWPAYT    PAYT
      *
     C                     MOVE WWNMCY    WKNMCY
     C           WONMCY    IFEQ WWNMCY
     C                     MOVE WOSITP    WKSITP
     C                     ELSE
     C                     MOVE WNSITP    WKSITP
     C                     ENDIF
      ***  Retrieve the processing type
     C           KWINV     CHAININVTP                89
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD5         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 05 *
     C                     MOVE 'INVTP   'DBFILE           ***************
     C                     MOVELWWINV     DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      ** .. Incomplete indicator
     C                     MOVE 'C'       TINC
      ** .. Counterparty Customer number
     C                     MOVE BVCOTC    TCNR
      ** .. Nominal currency
     C                     MOVE WWNMCY    TNMC
      ** .. Nominal decimal places
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWONMDP    TNMD
     C                     ELSE
     C                     Z-ADDWNNMDP    TNMD
     C                     ENDIF
      ** .. Value Date
     C                     Z-ADDMAALEF    TDVD
      *                                                                   151356
      ** Calculate Yield                                                  151356
     C           WWNMCY    IFEQ WONMCY                                    151356
     C                     MOVE WOSTBS    STBS                            151356
     C                     ELSE                                           151356
     C                     MOVE WNSTBS    STBS                            151356
     C                     ENDIF                                          151356
      *                                                                   151356
     C           STBS      IFEQ 'Y'                                       151356
     C                     Z-ADDTPDY      ZPRICE                          151356
     C                     Z-ADDTDVD      ZFDATE                          151356
     C           WWNMCY    IFEQ WONMCY                                    151356
     C                     Z-ADDWOMATY    MATY                            151356
     C                     MOVELWOSYBS    SYBS                            151356
     C                     ELSE                                           151356
     C                     Z-ADDWNMATY    MATY                            151356
     C                     MOVELWNSYBS    SYBS                            151356
     C                     ENDIF                                          151356
     C                     EXSR ZPRCO                                     151356
     C                     Z-ADDZPRCOT    TPDY                            151356
     C                     ENDIF                                          151356
      ** .. Trade Date
     C                     Z-ADDMATDDT    TDDT
      ** .. Trade Subtype
      *
      ***  Access to Corporate Action Type Details to retrieve
      ***  Settlement Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C           MMTSUB    IFNE *BLANKS
     C                     MOVE MMTSUB    TSUB
     C                     ELSE
      *
      ***  Retrieve the classification from PF/SDSECDPD
      *
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOSEC
      *
     C           BFCLAS    IFEQ 'M'
      *
      ***  Retrieve the Default Maket Subtype
      *
     C                     MOVE BVDMKS    TSUB
     C                     ELSE
      *
      ***  Retrieve the Default Portfolio Subtype
      *
     C                     MOVE BVDPFS    TSUB
     C                     ENDIF
     C                     ENDIF
      ** .. Link Reference
     C                     MOVE *BLANKS   LKRF
      ** .. Market Indicator
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOMKTI    TDMI
     C                     ELSE
     C                     MOVE WNMKTI    TDMI
     C                     ENDIF
      ** .. Narrative
     C                     MOVELDNARR     WWTEXT
     C                     MOVE MACORF    WWCROF
     C                     MOVE MACOAT    WWCOAT
     C                     MOVE WWDNAR    TDNR
      ** .. Trader ID
     C                     MOVEL*BLANKS   TDID
      ** .. AIBD/IPMA
     C                     MOVE 'Y'       AIIP
      ** .. Market Centre
     C           WWNMCY    IFEQ WONMCY
     C                     MOVELWOSMCC    TMKC
     C                     MOVE WOEDFT    EDFT
     C                     ELSE
     C                     MOVELWNSMCC    TMKC
     C                     MOVE WNEDFT    EDFT
     C                     ENDIF
      ** .. Capacity
     C                     Z-ADD*ZEROS    TCAP
      ** .. Accrued Indicator
     C                     EXSR ZNCD
     C                     MOVE 'C'       ACIN             Default
     C           TDVD      IFEQ NCD
     C                     MOVE 'F'       ACIN
     C***********          ELSE                                           151173
     C***********          MOVELEDFT      ZNRDYS  20                      151173
     C***********ZNRDYS    IFNE *ZEROS                                    151173
     C***********TDVD      IFLT NCD                                       151173
     C***********TDVD      ANDGEZDYNBR                                    151173
     C***********          MOVE 'X'       ACIN                            151173
     C***********          ENDIF                                          151173
     C***********          ENDIF                                          151173
     C                     ENDIF
      ** .. Days Adjustment
     C                     MOVE *ZEROS    DADJ
      ** .. Actual/Difference Indicator
     C                     MOVE *BLANKS   ADIN
      ** .. Coupon Rate                                                   148661
     C           WWNMCY    IFEQ WONMCY                                    148661
     C                     Z-ADDWOCPNR    TDCR                            148661
     C                     ELSE                                           148661
     C                     Z-ADDWNCPNR    TDCR                            148661
     C                     ENDIF                                          148661
      ** .. Interest Amount
     C           DYBS      IFNE ' '
     C           DVBS      ANDNE' '
     C                     MOVE ACIN      ZACIN
     C                     Z-ADD0         ZDADJ
     C                     MOVE *BLANKS   ZADIN
     C                     MOVE 'N'       ZCPOVR
     C***********          Z-ADDTNMD      ZCDP                            151173
     C           WWNMCY    IFEQ WONMCY                                    151173
     C                     Z-ADDWONBDP    ZCDP                            151173
     C                     ELSE                                           151173
     C                     Z-ADDWNNBDP    ZCDP                            151173
     C                     ENDIF                                          151173
     C                     Z-ADDMAALEF    ECD                             151173
     C                     EXSR ZPCINT
     C                     Z-ADDZITRA     ITRA
     C                     ELSE
     C                     Z-ADD*ZEROS    ITRA
     C                     ENDIF
      ** .. Interest Adjustment
     C                     MOVE *ZEROS    TINA
      *                                                                                       CAS006
      ** Set the Interest Amount and Interest Adjustment Using Net-                           CAS006
      ** Treasury-Rate fields if CAS006 is enabled.                                           CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
      *                                                                                       CAS006
     C           DYBS      IFNE *BLANK                                                        CAS006
     C           DVBS      ANDNE*BLANK                                                        CAS006
      *                                                                                       CAS006
      ** Reuse the parameters of the previous Purchased Interest on a                         CAS006
      ** Trade calculation except the Coupon Rate.                                            CAS006
      *                                                                                       CAS006
     C                     Z-ADDTDCR      WTDCR  117                                          CAS006
     C                     Z-ADDCPNN      TDCR                                                CAS006
     C                     EXSR ZPCINT                                                        CAS006
     C                     Z-ADDZITRA     ITRN                                                CAS006
     C                     Z-ADDWTDCR     TDCR                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADD*ZERO     ITRN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADD*ZERO     ITRN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     TINN                                                CAS006
      *                                                                                       CAS006
      ***..*Coupon Rate************************************************** 148661
     C********** WWNMCY    IFEQ WONMCY                                    148661
     C**********           Z-ADDWOCPNR    TDCR                            148661
     C**********           ELSE                                           148661
     C**********           Z-ADDWNCPNR    TDCR                            148661
     C**********           ENDIF                                          148661
      ** .. Price
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOSTBS    STBS
     C                     ELSE
     C                     MOVE WNSTBS    STBS
     C                     ENDIF
      *
     C                     Z-ADD*ZERO     PRIC
     C           STBS      IFEQ 'D'
     C           STBS      OREQ 'Y'
     C                     MOVELTPDY      ZPRCIN
     C                     Z-ADDTDVD      ZFDATE
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWOMATY    MATY
     C                     MOVELWOSYBS    SYBS
     C                     ELSE
     C                     Z-ADDWNMATY    MATY
     C                     MOVELWNSYBS    SYBS
     C                     ENDIF
     C                     EXSR ZPRCI
     C                     Z-ADDZPRCOT    PRIC
     C                     ELSE
     C                     Z-ADDTPDY      PRIC
     C                     ENDIF
      ** .. Ex-Dividend
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWONDVD    NDVD
     C                     ELSE
     C                     Z-ADDWNNDVD    NDVD
     C                     ENDIF
      *
     C           NDVD      IFEQ *ZEROS
     C                     MOVE 'C'       EXDV
     C                     ELSE
     C                     MOVELEDFT      ZNRDYS
      *
     C           ZNRDYS    IFNE *ZEROS
     C                     MOVE EDFT      WEDFT   1
      *
     C           WEDFT     IFEQ 'W'
      ***  If working days
     C                     Z-ADDNDVD      ZDAYNO
     C                     MOVE WWNMCY    ZCCY
     C                     MOVE *BLANKS   ZLOC
     C                     EXSR ZBKDT
     C                     ELSE
      ***  If actual days
     C           NDVD      SUB  ZNRDYS    ZDYNBR
     C                     ENDIF
      *
     C           TDDT      IFLT NDVD
     C           TDDT      ANDGEZDYNBR
     C                     MOVE 'X'       EXDV
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      ** .. Reallowance
     C                     MOVE *ZEROS    RALL
      ** .. Settlement Currency
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WONMCY    SETC
     C                     ELSE
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOSEC
     C*                                                                   148959
     C*** Settlement Currency for SE Redenomination should always         148959
     C*** equal to the nominal currency of the old Security.              148959
     C*                                                                   148959
     C           MAPTYP    IFEQ 'CC'                                      148959
     C                     MOVE WONMCY    SETC                            148959
     C                     ELSE                                           148959
     C*                                                                   148959
     C           WNMLTI    IFNE 'Y'
     C           BFCLAS    ANDNE'S'
     C           BFCLAS    ANDNE'D'
     C                     MOVE WNNMCY    SETC
     C                     ELSE
     C                     MOVE WONMCY    SETC
     C                     ENDIF
     C                     ENDIF
     C*                                                                   148959
     C                     ENDIF                                          148959
      ** .. Exchange Rate
      *
      ***  .. Settlement currency is not = Nominal currency
      ***                         - Calculate cross rate
      *
     C           SETC      IFEQ TNMC
     C                     Z-ADD1         TDER
     C                     MOVE 'M'       TMDI                            151062
     C                     ELSE
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM TNMC      @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C                     Z-ADDA6SPRT    ZRATE1 138
     C                     MOVE A6MDIN    ZMDI1   1
     C                     MOVE A6INCY    WWINCY  1                       153345
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM SETC      @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C                     Z-ADDA6SPRT    ZRATE2 138
     C                     MOVE A6MDIN    ZMDI2   1
     C                     EXSR ZXRATE
      *                                                                   153345
     C           TNMC      IFEQ BKEURO                                    153345
     C           A6INCY    ANDEQ'Y'                                       153345
     C           TDVD      ANDGEA6TPSD                                    153345
     C           SETC      OREQ BKEURO                                    153345
     C           WWINCY    ANDEQ'Y'                                       153345
     C           TDVD      ANDGEA6TPSD                                    153345
     C                     Z-ADDA6EUER    TDER                            153345
     C                     ELSE                                           153345
     C                     Z-ADDZRATEX    TDER
     C                     ENDIF                                          153345
      ** .. Multiply/Divide Ind.                                          151062
     C                     MOVE ZMDIX     TMDI                            151062
     C                     ENDIF
      ***..*Multiply/Divide*Ind.***************************************** 151062
     C*****                MOVE 'M'       TMDI                            151062
      ** .. Base Currency Rate
     C           SETC      IFEQ TNMC                                      151954
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWOSPRT    TBCR
     C                     ELSE
     C                     Z-ADDWNSPRT    TBCR
     C                     ENDIF
     C                     ELSE                                           151954
     C                     Z-ADDA6SPRT    TBCR                            151954
     C                     ENDIF                                          151954
      ** .. Settlement method
     C                     Z-ADD5         SMTH
      ** .. Pay from branch
     C           TDTP      IFEQ 'TP'
     C                     MOVE TDBA      PYFA
     C                     ENDIF
      ** .. Pay to branch
     C           TDTP      IFEQ 'TS'
     C                     MOVE TDBA      PYTA
     C                     ENDIF
      ** .. For Account of (Deliver to)
     C                     MOVE *BLANKS   TDFA
      ** .. Account Sequence Number
     C                     MOVE *BLANKS   ASNM
      ** .. Deliver to
     C********** TDTP      IFEQ 'TP'                                      148741
     C**********           Z-ADDMSDDPT    DELT                                                CSD027
     C                     MOVE MSDDPT    DELT                                                CSD027
     C**********           ENDIF                                          148741
      ** .. For Account of
     C                     MOVE *BLANKS   DTFA
      ** .. Deliver from
     C********** TDTP      IFEQ 'TS'                                      148741
     C**********           Z-ADDMSDDPT    DELF                                                CSD027
     C                     MOVE MSDDPT    DELF                                                CSD027
     C**********           ENDIF                                          148741
      ** .. Clearance type depends on Deliver To/Deliver From fields
     C                     MOVE '5'       CLTY
      *
     C           TDTP      IFEQ 'TP'
      *
     C                     MOVELDELT      WCUST            Deliver to
     C                     EXSR #AOSEC
     C                     SELEC
     C           BFCLAS    WHEQ 'E'                        Deliver to Euroclear
     C**********           MOVE '2'       CLTY                            148741
     C                     MOVE '1'       CLTY                            148741
     C           BFCLAS    WHEQ 'C'                        Deliver to Cedel
     C**********           MOVE '2'       CLTY                            147104
     C**********           MOVE '4'       CLTY                     147104 148741
     C                     MOVE '3'       CLTY                            148741
     C                     ENDSL
     C                     ELSE
      *
     C                     MOVELDELF      WCUST            Deliver from
     C                     EXSR #AOSEC
     C                     SELEC
     C           BFCLAS    WHEQ 'E'                        Deliver from Euroclear
     C**********           MOVE '2'       CLTY                            148741
     C                     MOVE '1'       CLTY                            148741
     C           BFCLAS    WHEQ 'C'                        Deliver from Cedel
     C**********           MOVE '2'       CLTY                            147104
     C**********           MOVE '4'       CLTY                     147104 148741
     C                     MOVE '3'       CLTY                            148741
     C                     ENDSL
     C                     ENDIF
      ** .. For Account of
     C                     MOVE *BLANKS   DFFA
      ** .. Special Instruction
     C                     MOVE *BLANKS   TDSI
      ** .. Priority Code
     C                     MOVE 'R'       PRYC
      ** .. Pay Code
     C                     MOVE '3'       PCOD
      ** .. Broker Commission Code
     C                     MOVE *BLANKS   TBCC
      ** .. Broker Commission Amount
     C                     Z-ADD*ZEROS    TBCA
      ** .. Broker Commission Code
     C                     MOVE *BLANKS   TCCC
      ** .. Customer Commission Amount
     C                     Z-ADD*ZEROS    TCCA
      ** .. Charges Code 1 - 7
     C                     MOVE *BLANKS   TCC1
     C                     MOVE *BLANKS   TCC2
     C                     MOVE *BLANKS   TCC3
     C                     MOVE *BLANKS   TCC4
     C                     MOVE *BLANKS   TCC5
     C                     MOVE *BLANKS   TCC6
     C                     MOVE *BLANKS   TCC7
      ** .. Charges Amount 1 - 7
     C                     Z-ADD*ZEROS    TCA1
     C                     Z-ADD*ZEROS    TCA2
     C                     Z-ADD*ZEROS    TCA3
     C                     Z-ADD*ZEROS    TCA4
     C                     Z-ADD*ZEROS    TCA5
     C                     Z-ADD*ZEROS    TCA6
     C                     Z-ADD*ZEROS    TCA7
      ** .. Tax Amount
     C                     Z-ADD*ZEROS    TAXA
      ** .. Broker Commission Rebate
     C                     Z-ADD0         BCMR
      ** .. Customer Commission Rebate
     C                     Z-ADD0         CCMR
      ** .. Tax Rebate
     C                     Z-ADD0         TXRB
      ** .. Bulk Reference
     C                     MOVE *BLANKS   BLKR
      ** .. Related Trade Reference
     C                     MOVE *BLANKS   RTRF
      ** .. Agency Trade Identifier
     C                     MOVE *BLANKS   ATRD
      ** .. Bulk confirmation required
     C                     MOVE *BLANKS   BCON
      ** .. Time of Input
     C                     TIME           WWTIME  60
     C                     Z-ADDWWTIME    TIME
      ** .. Autosettle Indicator
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOMKTI    WWMKTI  1
     C                     ELSE
     C                     MOVE WNMKTI    WWMKTI
     C                     ENDIF
      *
     C           WWMKTI    IFEQ 'G'
     C                     MOVE 'N'       AUTS
     C                     ELSE
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOSEC
     C                     MOVE BFASIN    AUTS             Count. aut. settl. ind
     C                     ENDIF
      ** .. Accounting Indicator
     C                     BITOF'01234567'TACI
      ** .. Message Indicator
     C                     BITOF'01234567'TMSI
      ** .. Confirmation Required
     C                     MOVE 'N'       TCFR
      ** .. Outstanding Nominal
     C                     Z-ADDNOML      TOSN
      ** .. Nominal Settled - not posted
     C                     Z-ADD*ZEROS    TNSN
      ** .. Nominal Settled - posted
     C                     Z-ADD*ZEROS    TNSP
      ** .. Value Settled - not posted
     C                     Z-ADD*ZEROS    TVSN
      ** .. Value Settled - posted
     C                     Z-ADD*ZEROS    TVSP
      ** .. Discrepancy - not posted
     C                     Z-ADD*ZEROS    TDSN
      ** .. Discrepancy - posted
     C                     Z-ADD*ZEROS    TDSP
      ** .. Date Fully Settled
     C                     Z-ADD*ZEROS    TDFS
      ** .. Settlement Sequence
     C                     Z-ADD*ZEROS    TSSQ
      ** .. Consideration
      *
      ***  If Security equal to event Security use nominal dec. places of event Security
      ***  else of new security
      *
     C           WOSESN    IFEQ TDSS
     C                     Z-ADDWONMDP    ZNMDP
     C                     Z-ADDWONBDP    ZNMCD
     C                     MOVE WOSPBS    ZPRCB
     C                     ELSE
     C                     Z-ADDWNNMDP    ZNMDP
     C                     Z-ADDWNNBDP    ZNMCD
     C                     MOVE WNSPBS    ZPRCB
     C                     ENDIF
      *
     C                     Z-ADDNOML      ZNOML
     C                     Z-ADDPRIC      ZAVPR
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     TCSR
      ** .. Countervalue
      *
      ***  consideration +/- purchase interest +/- reallowance +/- charges +/- commissions
      *
     C                     Z-ADD0         ZWRALL
     C                     Z-ADDTCSR      ZCONS  150
     C                     MOVE WWNMCY    NMCY
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOSPBS    SPBS
     C                     Z-ADDWONMDP    NMDP
     C                     Z-ADDWOCFCT    CFCT
     C                     Z-ADDWONBDP    ZCDP
     C                     ELSE
     C                     MOVE WNSPBS    SPBS
     C                     Z-ADDWNNMDP    NMDP
     C                     Z-ADDWNCFCT    CFCT
     C                     Z-ADDWNNBDP    ZCDP
     C                     ENDIF
     C                     EXSR ZCOTR
     C                     Z-ADDZCTRVL    TCTR
      ** .. Outstanding Value (contervalue converted in SETTLEMENT CURRENCY)
     C                     Z-ADD*ZEROS    TOSV
     C                     Z-ADDTCTR      ZAMTF
      *
      ***  If Settlement Currency is not equal to nominal currency
      *
     C           SETC      IFNE TNMC
     C           ZAMTF     ANDNE*ZEROS
     C                     MOVE WNNMCY    ZCCYF
     C                     MOVE WNSPRT    ZRATEF
     C                     MOVE WNMDIN    ZMDINF
     C                     MOVE WNNBDP    ZCDPF
     C                     MOVE WONMCY    ZCCYT
     C                     MOVE WOSPRT    ZRATET
     C                     MOVE WOMDIN    ZMDINT
     C                     MOVE WONBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     Z-ADDZAMTT     TOSV
     C                     ELSE
     C                     Z-ADDTCTR      TOSV
     C                     ENDIF
      ** .. Date Made Complete
     C                     Z-ADDBJRDNB    TDMC
      ** .. Original Entry Date
     C                     Z-ADDBJRDNB    TOED
      ** .. Profit Center
     C                     MOVE *BLANKS   PRFC
      *
      ***   If Profit Centre used
      ***   and Analytical Accounting Module is off
      *
     C           BKPRCU    IFEQ 'Y'
     C           BGN0ST    ANDNE'Y'
      *
      ***  If Book position/profit centres are to be reconciled
      *
     C           BVTBRC    IFEQ 'Y'
      *
      ***  Default from current book position profit centre record
      ***  if found & protect on screen
      *
     C                     MOVELTDBK      WKTDBK
     C                     MOVELTDBA      WKBRCA
     C                     MOVELTDSS      WKSESN    P
     C                     MOVELTDMI      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
     C                     MOVE WWSESN    WKSESN    P
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
      *
      ***  Else default from matrix and allow amendment
      *
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TDBK      @BOOK
     C                     MOVELTDTP      @TRTP     P
     C                     MOVE TSUB      @SUTP
     C                     MOVE TDBA      @BRAN
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
      ***  Customer Position Profit Centre defaulting
      *
      *
      ***  Default from current customer position profit centre
      ***  if found but do not protect on screen
      *
     C********** TCNR      IFNE *ZEROS                                                        CSD027
     C           TCNR      IFNE *BLANKS                                                       CSD027
     C                     MOVELTCNR      WKDPBN           Customer
     C                     MOVELTDBA      WKBRCA           Branch
     C                     MOVELTDSS      WKDPSS           Security
      *
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C                     MOVELWWSESN    WKDPSS           Event Security
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TDBK      @BOOK
     C                     MOVELTDTP      @TRTP     P
     C                     MOVE TSUB      @SUTP
     C                     MOVE TDBA      @BRAN
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      ** .. Pay/Rec Compl.
     C                     MOVE 'N'       PRPC
      ** .. Last SWIFT Sequence
     C                     Z-ADD0         LSWS
      ** .. Current Factor
     C                     Z-ADD0         TCFC
      ** .. Exchange Rate (Settle - Port)
     C                     Z-ADD0         SPXR
      ** .. Spot Rate Mult/Div Indicator
     C                     MOVE *BLANKS   SPMD
      *
      ***  New fields added for DBA 2 (amendment CAC002)
      ***  The following fileds are filled if the Analytical Accounting
      ***  module is ON else blank
      *
     C                     MOVE *BLANKS   BPRC
     C                     MOVE *BLANKS   TPRC
     C                     Z-ADD*ZERO     FXMP
     C                     Z-ADD*ZERO     FXMR
     C                     Z-ADD*ZERO     MAMT
      *
     C           BGN0ST    IFEQ 'Y'
      *                                                                   CAC005
      ** Defaulting of Book profit Centre will be done if CAC005 is       CAC005
      ** not installed                                                    CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'N'                                       CAC005
      *
      ***  Booking Profit Centre
      *
      ***  Default from current book position profit centre record
      ***  if found & protect on screen
      *
     C                     MOVELTDBK      WKTDBK
     C                     MOVELTDBA      WKBRCA
     C                     MOVELTDSS      WKSESN    P
     C                     MOVELTDMI      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C           RECI      ANDEQ'D'
     C                     MOVE PCBK      BPRC
      *
      ***  Else default from matrix and allow amendment
      *
     C                     ELSE
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TDBK      @BOOK
     C                     MOVELTDTP      @TRTP     P
     C                     MOVE TSUB      @SUTP
     C                     MOVE TDBA      @BRAN
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    BPRC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      ** If CAC005 is installed, retrieve the profit centre represented   CAC005
      ** by MCBOOK.  MCBOOK in the Corporate Actions-Allocation file is   CAC005
      ** being held as a pseudo book.                                     CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD                           CAC005
     C                     PARM '*USER  ' POPTN                           CAC005
     C                     PARM           PBKCD   2                       CAC005
     C                     PARM           PPRFC   4                       CAC005
     C                     PARM MCBOOK    PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPPRFC     BPRC                            CAC005
     C                     ELSE                                           CAC005
     C                     MOVE *BLANKS   BPRC                            CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      ***  Transaction Profit Centre
      *
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOSEC
      *
      ***  Default from current customer position profit centre record
      ***  if found
      *
     C           BFCLAS    IFEQ 'S'
     C           BFCLAS    OREQ 'D'
      *
     C                     MOVELTDBK      WKTDBK
     C                     MOVELTDBA      WKBRCA
     C                     MOVELTDSS      WKSESN    P
     C                     MOVELTDMI      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCCU      TPRC
      *
      ***  Else default from matrix and allow amendment
      *
     C                     ELSE
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TDBK      @BOOK
     C                     MOVELTDTP      @TRTP     P
     C                     MOVE TSUB      @SUTP
     C                     MOVE TDBA      @BRAN
     C                     MOVELTCNR      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    TPRC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If no record on customer positions profit centre file
      ***  need to add one and amend the audit file
      *
     C           BKPCDU    IFEQ 'Y'
     C           CAC005    ANDEQ'N'                                       CAC005
      *
      ***  Access to Position Profit Center to retrieve the profit centre
      *
     C                     MOVELTDBK      WKTDBK
     C                     MOVELTDBA      WKBRCA
     C                     MOVELTDSS      WKSESN    P
     C                     MOVELTDMI      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
      *
     C           *IN89     IFEQ *ON
     C                     MOVEL'D'       RECI
     C                     MOVELTDBK      BOKC
     C                     MOVELTDBA      BRCA
     C                     MOVELTDSS      SESN
     C                     MOVE TDMI      MKTI
     C                     MOVE TPRC      PCBK
     C                     Z-ADDBJRDNB    LCD
     C                     MOVEL'I'       CHTP
     C                     EXSR ZTNLU1
     C                     MOVELNATN      TNLU
     C                     WRITESEPCBDF
      *
     C           1         CHAINSEPCA                89
     C           *IN89     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD32        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 32 *
     C                     MOVEL'SEPCA   'DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     ADD  1         NORE
     C                     ADD  1         SINS
     C                     UPDATSEPCAF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** .. Corporate Action Flag
     C                     MOVE 'Y'       COAF
      ** .. Last Change Date
     C                     Z-ADDBJRDNB    LCD
      ** .. Type of last change
     C                     MOVE 'I'       CHTP
      ** .. Transaction number of last Update
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      TNLU
      ** .. RECI
     C                     MOVE 'D'       RECI
      ** .. Portfolio Reference
     C                     MOVE MCPTFR    PTFR
      *                                                                                       CAS006
      ** Initialise the Credit Risk Spread, Liquidity Premium,                                CAS006
      ** and New Net-Treasury Price fields.                                                   CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     CRSK                                                CAS006
     C                     Z-ADD*ZERO     LQPR                                                CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPRIC      PRICN                                               CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADD*ZERO     PRICN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       217310
      ** Default Timestamp.                                                                   217310
      *                                                                                       217310
     C                     MOVEASTAMP,1   TMST                                                217310
      *
      ***  Update Trade Details
      *
     C                     WRITETRADSDF
     C                     ADD  1         W01CNT
     C                     MOVE 'Y'       WWDATA           one Read
     C/COPY WNCPYSRC,SE7560C002
      *                                                                                       CER001
      ** When Lux Return feature is present, update extension file                            CER001
      *                                                                                       CER001
     C           BGLRIN    IFEQ 'Y'                        - B1                               CER001
      *                                                                                       CER001
     C                     MOVE *IN99     WWIN99  1                                           CER001
      *                                                                                       CER001
     C           TDRF      CHAINSETRX1PD             99                                       CER001
      *                                                                                       CER001
     C           *IN99     IFEQ *ON                        - B2                               CER001
      *                                                                                       CER001
     C                     CLEARTRADSDD6                                                      CER001
      *                                                                                       CER001
     C                     MOVELTDRF      CCTDRF                                              CER001
      *                                                                                       CER001
      ** Date is defaulted with Trade Value Date.                                             CER001
      *                                                                                       CER001
     C                     Z-ADDTDVD      CCAGSD                                              CER001
      *                                                                                       CER001
      ** If feature ULX008 is installed setup transaction time                                CER001
      ** and extract flag                                                                     CER001
      *                                                                                       CER001
     C           ULX008    IFEQ 'Y'                                                           CER001
     C                     TIME           CCTIME                                              CER001
     C                     MOVE *BLANK    CCEXFL                                              CER001
     C                     MOVE 'N'       CCCABR                                              CER001
     C                     MOVE 'N'       CCMTRD                                              CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C                     WRITETRADSDD6                                                      CER001
      *                                                                                       CER001
     C                     ENDIF                           - E2                               CER001
      *                                                                                       CER001
     C                     MOVE WWIN99    *IN99                                               CER001
      *                                                                                       CER001
     C                     ENDIF                           - E1                               CER001
      *
      *** If S01401 feature is switched 'On'
      *
     C           S01401    IFEQ 'Y'
      *
      ***  Update extension file
      *
     C                     CLEARTRADSDD1
      *
     C                     MOVELTDRF      T1TDRF
     C                     MOVE 'N'       T1CONG
     C                     MOVE 'N'       T1RCDG
     C                     MOVE 'N'       T1GMES
     C                     MOVE 'N'       T1GMEC
     C                     MOVE 'C'       T1CCID
     C                     TIME           WWTIME  60
     C                     MOVELWWTIME    T1TRTT
     C                     MOVE 'Y'       T1SCMG
     C                     MOVE 'A'       T1WHEN
     C                     MOVEASTAMP,1   T1TMST                                              217310
      *
     C                     WRITETRADSDD1
      *
     C                     MOVE 'B'       T1WHEN
     C                     WRITETRADSDD1
     C                     ENDIF
      *                                                                   CSE039
      * write to Movement Status file                                     CSE039
      *                                                                   CSE039
     C           CSE039    IFEQ 'Y'                                       CSE039
     C                     MOVELTDRF      TMTRRF                          CSE039
     C                     MOVEL'T'       TMTRTY                          CSE039
     C                     Z-ADDBJRDNB    TMNTDT                          CSE039
     C                     Z-ADD1         TMSQNR                          CSE039
     C                     MOVEL'INS'     TMSWSC                          CSE039
     C                     MOVEL*BLANKS   TMSWRC                          CSE039
     C                     MOVEL*BLANKS   TMNTMT                          CSE039
     C                     MOVEL*BLANKS   TMLCUS                          CSE039
     C                     MOVEL'MIDAS'   TMINOR                          CSE039
     C                     MOVEL*BLANKS   TMMSGK                          CSE039
     C                     MOVEL*BLANKS   TMSTMG                          CSE039
     C                     MOVELWWDNAR    TMNARR                          CSE039
     C                     MOVEL'I'       TMLCTP                          CSE039
     C                     Z-ADDBJRDNB    TMLCDT                          CSE039
     C                     MOVELTMMP,1    TMTMST                          CSE039
     C                     MOVELTDBA      TMTRBB                          CSE039
     C                     MOVE USER      TMLCUS                          CSE039
      *                                                                   CSE039
     C                     WRITESEMVTSD0                                  CSE039
     C                     ENDIF                                          CSE039
     C/COPY WNCPYSRC,SE7560C001
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #ADPMV -  Access Depots Movement                             *
      *  ------                                                       *
      *  Called by : #TDRVR                                           *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #ADPMV    BEGSR
      *
      ***  Access to Depot Movement previously generated using "Transaction Reference"
      *
     C           KWDPMV    CHAINDPTMV                88
      *
     C           *IN88     IFEQ *ON
     C                     MOVE MASESN    WKSESN
     C           KWDPMV    CHAINDPTMV                88
     C                     ENDIF                           *IN88=*ON
      *
     C           *IN88     IFEQ *ON
     C                     MOVELWKSESN    WKSES1    P
     C           *LOCK     IN   LDA
     C                     Z-ADD6         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 06 *
     C                     MOVE 'DPTMV   'DBFILE           ***************
     C                     MOVELW2DPMV    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           *IN88=*ON
      *
     C                     MOVE DPSS      WDPSS  10
     C                     MOVE DPMV      WDPMV   2
     C**********           Z-ADDDPID      WDPID   60                                          CSD027
     C                     MOVE DPID      WDPID   6                                           CSD027
     C                     Z-ADDDPMD      WDPMD   50
     C**********           Z-ADDDPOD      WDPOD   60                                          CSD027
     C                     MOVE DPOD      WDPOD   6                                           CSD027
     C                     Z-ADDDPDO      WDPDO   50
     C                     MOVE DPBA      WDPBA   3
     C                     MOVE ORBR      WORBR   3
     C                     MOVE DPBK      WDPBK   2
     C                     MOVE DPMK      WDPMK   1
     C**********           Z-ADDDPBN      WDPBN   60                                          CSD027
     C                     MOVE DPBN      WDPBN   6                                           CSD027
     C                     Z-ADDDPNA      WDPNA  110
     C                     MOVE DPNR      WDPNR  35
     C                     Z-ADDMKTP      WMKTP  158
     C                     Z-ADDDPAD      WDPAD   60
     C                     MOVE SWRF      WSWRF   3
     C                     MOVE SIOI      WSIOI   1
     C                     MOVE DPMS      WDPMS   1
     C                     MOVE DCFR      WDCFR   1
     C                     MOVE TACI      WTACI   1
     C                     MOVE DPR1      WDPR1   1
     C                     MOVE DPR2      WDPR2   1
     C                     Z-ADDORED      WORED   50
     C                     MOVE RPIN      WRPIN   1
     C                     MOVE DPPC      WDPPC   4
     C                     MOVE DCHC      WDCHC   2
     C                     MOVE DCCE      WDCCE   3
     C                     Z-ADDDCHA      WDCHA  130
     C                     Z-ADDDCSE      WDCSE   20
     C                     MOVE DCAB      WDCAB   3
     C**********           MOVE DCAT      WDCAT  12                                           CGL029
     C                     MOVE DCAT      WDCAT  18                                           CGL029
     C                     Z-ADDDPVD      WDPVD   50
     C                     MOVE SPXR      WSPXR  138
     C                     MOVE SPMD      WSPMD   1
     C                     MOVE PTFR      WPTFR   4
     C                     Z-ADDCYLD      WCYLD  117
     C                     MOVE CWDI      WCWDI   1
      *                                                                                       207006
     C           CSE029    IFEQ 'Y'                                                           207006
     C**********           Z-ADDCPTY      WCPTY   60                                   207006 CSD027
     C                     MOVE CPTY      WCPTY   6                                           CSD027
     C                     MOVE MRKT      WMRKT   2                                           207006
     C                     ENDIF                                                              207006
     C*
      ***  Access DPTMVDY1 if S01401 is installed.
      *
     C           S01401    IFEQ 'Y'
     C           KWDPMV    CHAINDPTMVDY1             88
      *
      ***  Record not found, database error.
      *
     C           *IN88     IFEQ *ON
     C                     MOVELWKSESN    WKSES1    P
     C           *LOCK     IN   LDA
     C                     Z-ADD7         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 07 *
     C                     MOVE 'DPTMVDY1'DBFILE           ***************
     C                     MOVELW2DPMV    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           *IN88=*ON
     C                     ENDIF                           S01401='Y'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #DPTNB -  Retrieve next Depot reference number               *
      *  ------                                                       *
      *  Called by : #TDRVR                                           *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #DPTNB    BEGSR
     C/COPY WNCPYSRC,SE7560C009
      *
     C******     S01401    IFEQ 'Y'                                       152873
      *
     C           WKTRRF    CHAINDPTMVDF1             89
     C           *IN89     DOWEQ*OFF
     C                     ADD  1         WWNTR2
     C                     MOVE WWNTR2    WKTRRF
     C           WKTRRF    CHAINDPTMVDF1             89
     C                     ENDDO                           *IN89=*OFF
      *
     C******               ELSE                                           152873
     C******                                                              152873
     C******     KWDPMV    CHAINDPTMV                89                   152873
     C******     *IN89     DOWEQ*OFF                                      152873
     C******               ADD  1         WWNTR2                          152873
     C******               MOVE WWNTR2    WKTRRF                          152873
     C******     KWDPMV    CHAINDPTMV                89                   152873
     C******               ENDDO                           *IN89=*OFF     152873
     C******               ENDIF                                          152873
     C/COPY WNCPYSRC,SE7560C010
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #WDPMV -  Write Depot Movement                               *
      *  ------                                                       *
      *  Called by : #TDRVR #SDPMV                                    *
      *  Calls     : #TOFP                                            *
      *****************************************************************
      *
     C           #WDPMV    BEGSR
      *
     C           WWDPNA    IFNE 0                                                             221751
      *                                                                                       221751
      ** .. Corporate Action Flag
     C                     MOVE 'Y'       COAF
     C                     Z-ADDBJRDNB    LCD              Last Change Date
     C                     MOVE 'I'       CHTP             Type of Last Change
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      TNLU             Trans. no. of last update
     C                     MOVE 'D'       RECI
      *
     C           WALLOC    IFEQ 'R'
     C                     MOVE WDPSS     DPSS
     C                     MOVE WDPBA     DPBA
     C                     MOVE WORBR     ORBR
     C                     MOVE WDPBK     DPBK
     C                     MOVE WDPMK     DPMK
     C**********           Z-ADDWDPBN     DPBN                                                CSD027
     C                     MOVE WDPBN     DPBN                                                CSD027
     C                     Z-ADDWDPNA     DPNA
     C                     MOVE WDPNR     DPNR
     C                     Z-ADDWMKTP     MKTP
     C                     Z-ADDWDPAD     DPAD
     C                     MOVE WSWRF     SWRF
     C                     MOVE WSIOI     SIOI
     C                     MOVE WDPMS     DPMS
     C                     MOVE WDCFR     DCFR
     C                     MOVE WTACI     TACI
     C                     MOVE WDPR1     DPR1
     C                     MOVE WDPR2     DPR2
     C                     Z-ADDWORED     ORED
     C                     MOVE WRPIN     RPIN
     C                     MOVE WDPPC     DPPC
     C                     MOVE WDCHC     DCHC
     C                     MOVE WDCCE     DCCE
     C                     Z-ADDWDCHA     DCHA
     C                     Z-ADDWDCSE     DCSE
     C                     MOVE WDCAB     DCAB
     C                     MOVE WDCAT     DCAT
     C                     Z-ADDWDPVD     DPVD
     C                     MOVE WSPXR     SPXR
     C                     MOVE WSPMD     SPMD
     C                     MOVE WPTFR     PTFR
     C                     Z-ADDWCYLD     CYLD
     C                     MOVE WCWDI     CWDI
      *                                                                                       207006
     C           CSE029    IFEQ 'Y'                                                           207006
     C**********           Z-ADDWCPTY     CPTY                                         207006 CSD027
     C                     MOVE WCPTY     CPTY                                                CSD027
     C                     MOVE WMRKT     MRKT                                                207006
     C                     ENDIF                                                              207006
      *                                                                                       207006
     C                     ENDIF
      *                                                                   CSE017
      ** If CSE017 is installed, Cum/Ex and Print Advice Indicator        CSE017
      ** should be initialised                                            CSE017
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE 'C'       DPIN                            CSE017
     C                     MOVE 'Y'       DPAP                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                                       193752
      ** Access to Corporate Action Type Details to retrieve                                  193752
      ** Trade Subtype.                                                                       193752
      *                                                                                       193752
     C                     MOVE MACOAT    WKCOAT                                              193752
     C                     EXSR #ACOAT                                                        193752
      *                                                                                       193752
     C           MMTSUB    IFNE *BLANKS                                                       193752
     C                     MOVE MMTSUB    TSUB                                                193752
     C                     ELSE                                                               193752
      *                                                                                       193752
      ** Retrieve the Default Portfolio Subtype.                                              193752
      *                                                                                       193752
     C                     MOVE BVDPFS    TSUB                                                193752
     C                     ENDIF                                                              193752
     C*
      ** Initialise Movement Subtype                                      183579
      *                                                                   183579
     C                     MOVEL*BLANKS   MSTP                            183579
     C                     MOVELTSUB      MSTP                            183579
      *                                                                   183579
      ** If Private Banking (TOF) installed, subtype must not be blank    183579
      *                                                                   183579
     C           BGN4ST    IFEQ 'Y'                                       183579
     C           MSTP      ANDEQ*BLANKS                                   183579
     C           *LOCK     IN   LDA                                       183579
     C                     Z-ADD40        DBASE            ***************183579
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 40 *183579
     C                     MOVE 'MVMT S/T'DBFILE           ***************183579
     C                     MOVELMSTP      DBKEY                           183579
     C                     MOVEL'SE7560'  DBPGM     P                     183579
     C                     OUT  LDA                                       183579
     C                     EXSR *PSSR                                     183579
     C                     ENDIF                                          183579
      *                                                                   CPB001
      **  If Replication Processing required.                             CPB001
     C           WUREPL    IFEQ 'Y'                        Begin WUREPL   CPB001
     C                     EXSR REPLIC                                    CPB001
      *                                                                   CPB001
     C                     ENDIF                           End WUREPL     CPB001
      *                                                                                       234829
      ** Get Original Purchase Date                                                           234829
      *                                                                                       234829
     C           CGL031    IFEQ 'Y'                                                           234829
     C                     EXSR GOPD                                                          234829
      *                                                                                       234829
      ** Get Original Purchased Interest                                                      234829
      *                                                                                       234829
     C                     EXSR GOPI                                                          234829
      *                                                                                       234829
      ** Get Fiscal Price via SEVSEFSPR3                                                      234829
      *                                                                                       234829
     C                     EXSR GFSPR                                                         234829
      *                                                                                       234829
      ** Get latest ETCPOSND record for a name change on the WO, so data can                  234829
      ** be used to write new record for new shortname on the WI.                             234829
      *                                                                                       234829
     C           MAPTYP    IFEQ 'NC'                                                          234829
     C           DPMV      ANDEQ'WO'                                                          234829
     C                     CALL SEETRT                                                        234829
     C                     PARM *BLANKS   PRETC                                               234829
     C                     PARM           DPBA                                                234829
     C                     PARM           DPSS                                                234829
     C                     PARM           PTFR                                                234829
     C                     PARM 'S'       @MRKT   1                                           234829
     C                     PARM           DPDO                                                234829
     C                     PARM           ETCPOS                                              234829
     C                     ENDIF                                                              234829
      *                                                                                       234829
      ** Write Position details to ETCPOSND via SEETCPUPD                                     234829
      *                                                                                       234829
     C           MAPTYP    IFNE 'NC'                                                          234829
     C           DPMV      OREQ 'WO'                                                          234829
     C                     MOVE RECI      RECIV                                               234829
     C                     MOVE ORBR      ORBRV                                               234829
     C                     MOVE TACI      TACIV                                               234829
     C                     Z-ADDORED      OREDV                                               234829
     C                     Z-ADDLCD       LCDV                                                234829
     C                     MOVE CHTP      CHTPV                                               234829
     C                     Z-ADDTNLU      TNLUV                                               234829
     C                     Z-ADDSPXR      SPXRV                                               234829
     C                     MOVE SPMD      SPMDV                                               234829
     C                     MOVE PTFR      PTFRV                                               234829
     C                     MOVE COAF      COAFV                                               234829
     C                     MOVE ACIN      ACINV                                               234829
     C                     MOVE REPI      REPIV                                               234829
     C                     MOVE DPAP      DPAPV                                               234829
     C                     Z-ADDFSPR      FSPRV                                               234829
     C                     MOVE FSPP      FSPPV                                               234829
     C**********           Z-ADDDPBN      DPBNV                                       234829 CSD027A
     C                     MOVE DPBN      DPBNV                                              CSD027A
     C                     CALL SEETCP                                                        234829
     C                     PARM *BLANKS   PRETC                                               234829
     C                     PARM 'I'       @BCHTP  1                                           234829
     C                     PARM 'D'       WTYPE   1                                           234829
     C                     PARM           @TRDDS                                              234829
     C                     PARM           @SEVDP                                              234829
     C                     PARM           @SECTY                                              234829
     C                     ELSE                                                               234829
      *                                                                                       234829
      ***  For Name changes and WI, write to ETCPOSND with same details                       234829
      ***  as existed on ETCPOSND for old shortname before this action                        234829
      ***                                                                                     234829
      *                                                                                       234829
     C                     MOVE DPSS      CSSC                                                234829
     C                     MOVE DPRN      TREF                                                234829
     C                     MOVE 'D'       TTYPE                                               234829
     C**********           Z-ADDDPID      CSDA                                        234829 CSD027A
     C**********           MOVE DPID      CSDA                                        CSD027A 240016
     C                     MOVE DPMD      CSDA                                                240016
     C                     MOVEASTAMP,1   ETMST                                               234829
      *                                                                                       234829
     C                     WRITEETCPOSF                                                       234829
     C                     ENDIF                                                              234829
     C                     ENDIF                                                              234829
      *
      ***  Write depot movements details
      *
     C                     MOVEASTAMP,1   DMTMST           Default Timestamp                  CPK015
     C                     Z-ADDBJRDNB    LCD              Last Change Date                   235041
     C                     Z-ADDBJRDNB    ORED             Last Change Date                   235041
     C                     MOVE 'I'       CHTP             Type of Last Change                235041
     C                     WRITEDPTMVDF
      *
     C           WALLOC    IFNE 'R'
     C                     ADD  1         W02CNT
     C                     ELSE
     C                     ADD  1         W05CNT
     C                     ENDIF
     C                     MOVE 'Y'       WWDATA           one Read
     C/COPY WNCPYSRC,SE7560C003
      *                                                                                       CER001
      ** When Lux Return feature is present, update extension file                            CER001
      *                                                                                       CER001
     C           BGLRIN    IFEQ 'Y'                        - B1                               CER001
      *                                                                                       CER001
     C                     MOVE *IN99     WWIN99  1                                           CER001
      *                                                                                       CER001
     C           WWNKEY    KLIST                                                              CER001
     C                     KFLD           WWDPSS 10                                           CER001
     C                     KFLD           WWDPRN  6                                           CER001
      *                                                                                       CER001
     C                     MOVELDPSS      WWDPSS                                              CER001
     C                     MOVELDPRN      WWDPRN                                              CER001
      *                                                                                       CER001
     C           WWNKEY    CHAINSEDPX1PD             99                                       CER001
      *                                                                                       CER001
     C           *IN99     IFEQ *ON                        - B2                               CER001
      *                                                                                       CER001
     C                     CLEARDPTMVDF6                                                      CER001
      *                                                                                       CER001
     C                     MOVELDPSS      WNDPSS                                              CER001
     C                     MOVELDPRN      WNDPRN                                              CER001
     C                     Z-ADD*ZEROS    WNOPTP                                              CER001
     C                     Z-ADD*ZEROS    WNEXCF                                              CER001
      *                                                                                       CER001
      ** If feature ULX008 is installed setup transaction time                                CER001
      ** and extract flag                                                                     CER001
      *                                                                                       CER001
     C           ULX008    IFEQ 'Y'                                                           CER001
     C                     MOVE *BLANK    WNEXFL                                              CER001
      *                                                                                       CER001
     C           DPMV      IFEQ 'WI'                                                          CER001
     C           DPMV      OREQ 'WO'                                                          CER001
     C                     TIME           WNTIME                                              CER001
      *                                                                                       CER001
      ** Access ER ICD to retrieve "Include in CAB Reporting" Flag                            CER001
      *                                                                                       CER001
     C           *LOVAL    SETLLERLUICL1                                                      CER001
     C                     READ ERLUICL1                 99                                   CER001
     C           *IN99     IFEQ *ON                                                           CER001
     C           *LOCK     IN   LDA                                                           CER001
     C                     Z-ADD80        DBASE            ***************                    CER001
     C                     MOVEL'ERLUICL1'DBFILE           * DB ERROR 80 *                    CER001
     C                     MOVEL'*NONE'   DBKEY            ***************                    CER001
     C                     OUT  LDA                                                           CER001
     C                     EXSR *PSSR                                                         CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C           VPDMOV    IFEQ 'N'                                                           CER001
     C                     MOVE 'Y'       WNCABR                                              CER001
     C                     ELSE                                                               CER001
     C                     MOVE 'N'       WNCABR                                              CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C                     MOVEL*BLANKS   WNCNBR                                              CER001
     C                     ELSE                                                               CER001
     C                     Z-ADD0         WNTIME                                              CER001
     C                     MOVE *BLANK    WNCABR                                              CER001
     C                     MOVEL*BLANKS   WNCNBR                                              CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C                     WRITEDPTMVDF6                                                      CER001
      *                                                                                       CER001
     C                     ENDIF                           - E2                               CER001
      *                                                                                       CER001
     C                     MOVE WWIN99    *IN99                                               CER001
      *                                                                                       CER001
     C                     ENDIF                           - E1                               CER001
      *
      ***  Update Extension files
      *
     C           S01401    IFEQ 'Y'
     C                     MOVE DPSS      DPDPSS
     C                     MOVE DPRN      DPDPRN
     C                     MOVE 'N'       DPCONG
     C                     MOVE 'N'       DPRCDG
     C                     Z-ADD0         DPLSWS
     C                     Z-ADD0         DPLSSC
     C                     Z-ADD0         DPTIME
     C                     Z-ADD0         DPLCD
     C                     MOVE 'N'       DPGMES
     C                     MOVE *BLANKS   DPINST
     C                     MOVE *BLANKS   DPINSS
     C                     MOVE *BLANKS   DPEUCL
     C                     MOVE *BLANKS   DPSAFA
     C                     MOVE *BLANKS   DPRPTY
     C                     MOVE *BLANKS   DPFIND
     C                     MOVE 'N'       DPGMEC
     C                     MOVE *BLANKS   DPTRTT
     C                     MOVE *BLANKS   DPGDEL
     C                     MOVE *BLANKS   DPFCOD
     C                     MOVE *BLANKS   DPSROL
     C                     MOVE *BLANKS   DPSCMG
     C                     MOVE 'S'       DPWHEN
     C                     Z-ADD0         DPPRIC
     C                     Z-ADD0         DPACND
     C                     Z-ADD0         DPITRA
     C                     Z-ADD0         DPTDER
      *
     C                     WRITEDPTMVDD1
     C                     ENDIF
      * write to Movement Status file                                     CSE039
      *                                                                   CSE039
     C           CSE039    IFEQ 'Y'                                       CSE039
     C                     MOVELDPRN      TMTRRF                          CSE039
     C                     MOVEL'W'       TMTRTY                          CSE039
     C                     Z-ADDBJRDNB    TMNTDT                          CSE039
     C                     Z-ADD1         TMSQNR                          CSE039
     C                     MOVEL'INS'     TMSWSC                          CSE039
     C                     MOVEL*BLANKS   TMSWRC                          CSE039
     C                     MOVEL*BLANKS   TMNTMT                          CSE039
     C                     MOVEL*BLANKS   TMLCUS                          CSE039
     C                     MOVEL'MIDAS'   TMINOR                          CSE039
     C                     MOVEL*BLANKS   TMMSGK                          CSE039
     C                     MOVEL*BLANKS   TMSTMG                          CSE039
     C                     MOVELWWDNAR    TMNARR                          CSE039
     C                     MOVEL'I'       TMLCTP                          CSE039
     C                     Z-ADDBJRDNB    TMLCDT                          CSE039
     C                     MOVELTMMP,1    TMTMST                          CSE039
     C                     MOVELDPBA      TMTRBB                          CSE039
     C                     MOVE USER      TMLCUS                          CSE039
      *                                                                   CSE039
     C                     WRITESEMVTSD0                                  CSE039
     C                     ENDIF                                          CSE039
      *                                                                   CSE039
     C/COPY WNCPYSRC,SE7560C004
      *
     C                     END                                                                221751
      *                                                                                       221751
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                                                  216944
      *****************************************************************                       216944
      *  #UDPMV -  Write Depot Movement                               *                       216944
      *  ------                                                       *                       216944
      *  Called by : #TDRVR                                           *                       216944
      *  Calls     : None                                             *                       216944
      *****************************************************************                       216944
      *                                                                                       216944
     C           #UDPMV    BEGSR                                                              216944
      *                                                                                       216944
     C           WDPNA     IFNE 0                                         221751
      *                                                                   221751
     C           RECI      IFNE '*'                                                           216944
     C                     MOVE 'R'       RECI                                                216944
     C                     MOVEL'D'       CHTP                                                216944
     C                     Z-ADDBJRDNB    LCD                                                 216944
      *                                                                                       216944
     C           WDPMV     IFEQ 'WI'                                                          216944
     C                     Z-ADDWDPMD     DPVD                                                216944
     C                     ELSE                                                               216944
     C                     Z-ADDWDPDO     DPVD                                                216944
     C                     ENDIF                                                              216944
      *                                                                                       216944
     C                     ADD  1         WXXDEL                          219634
      *                                                                                       221680
     C           ORED      IFEQ LCD                                                           221680
     C                     MOVE '*'       RECI                                                221680
     C                     END                                                                221680
      *                                                                                       221680
     C                     UPDATDPTMVDF2                                                      216944
      *                                                                                       216944
     C                     END                                                                216944
      *                                                                                       216944
     C                     END                                            221751
      *                                                                   221751
     C                     ENDSR                                                              216944
      *                                                                                       216944
      *****************************************************************                       216944
      /EJECT
      *****************************************************************
      *  #SDPMV -  Setup Default fields for Depot Movement            *
      *  ------                                                       *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCE   *
      *              #PROFE #PROFP #PREX #PRTGZ #PRRGM #PRRGC #PRNC   *
      *  Calls     : #WDPMV #AOPRF AOCURR0                            *
      *****************************************************************
      *
     C           #SDPMV    BEGSR
      *
      ***  Retrieve a new Depot Reference
      *
     C                     MOVE WWNTR2    WKTRRF  6        Reference
     C******     KWDPMV    CHAINDPTMV                89                   152873
     C           WKTRRF    CHAINDPTMVDF1             89                   152873
     C           *IN89     DOWEQ*OFF
     C                     ADD  1         WWNTR2
     C                     MOVE WWNTR2    WKTRRF
     C******     KWDPMV    CHAINDPTMV                89                   152873
     C           WKTRRF    CHAINDPTMVDF1             89                   152873
     C                     ENDDO                           *IN89=*OFF
     C                     ADD  1         WWNTR2
      *
     C                     CLEARDPTMVDF
      *
      ***  .. Branch Code
     C                     MOVE MCBRCD    DPBA
      ***  .. Origin. Branch
     C                     MOVE MCBRCD    ORBR
      ***  .. Beneficial Customer
     C                     MOVE MCCNUM    DPBN
      *
      ***  .. Security Shortname
     C                     MOVELWWSESN    DPSS      P
      ***  .. Depot Reference
     C                     MOVE WKTRRF    DPRN
      ***  .. Movement Type
     C                     MOVE WWDPMV    DPMV
      ***  .. In Depot, Out Depot, Movement Date In, Movement Date Out
     C**********           Z-ADD0         DPID                                                CSD027
     C                     MOVE *BLANKS   DPID                                                CSD027
     C                     Z-ADD0         DPMD
     C**********           Z-ADD0         DPOD                                                CSD027
     C                     MOVE *BLANKS   DPOD                                                CSD027
     C                     Z-ADD0         DPDO
      *
     C           DPMV      IFEQ 'WI'
     C**********           Z-ADDMSDDPT    DPID                                                CSD027
     C                     MOVE MSDDPT    DPID                                                CSD027
     C                     Z-ADDMAALEF    DPMD
     C                     ELSE
     C**********           Z-ADDMSDDPT    DPOD                                                CSD027
     C                     MOVE MSDDPT    DPOD                                                CSD027
     C                     Z-ADDMAALEF    DPDO
     C                     ENDIF
      ***  .. Book Code
     C                     MOVELBVDPBC    DPBK
      ***  .. Market Indicator
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOMKTI    DPMK      P
     C                     ELSE
     C                     MOVE WNMKTI    DPMK      P
     C                     ENDIF
      ***  .. Nominal Amount
     C                     Z-ADDWWDPNA    DPNA
      ***  .. Narrative
     C                     MOVELDNARR     WWTEXT
     C                     MOVE MACORF    WWCROF
     C                     MOVE MACOAT    WWCOAT
     C                     MOVE WWDNAR    DPNR
      ***  .. Market Price
     C                     Z-ADDWWMKTP    MKTP
      ***  .. Assoc. deal
     C                     Z-ADD*ZERO     DPAD
      ***  .. Switch ref.
     C                     MOVE *BLANKS   SWRF
      ***  .. Switch in/on
     C                     MOVE *BLANKS   SIOI
      ***  .. Message ind.
     C                     BITOF'0'       DPMS
      ***  .. Confirmation required
     C*************        MOVE 'N'       DCFR                            150140
     C                     MOVE 'Y'       DCFR                            150140
      ***  .. Accounting ind.
     C                     BITOF'01'      TACI
      ***  .. Depot Required 1
     C                     MOVE 'N'       DPR1
      ***  .. Depot Required 2
     C                     MOVE 'N'       DPR2
      ***  .. Original Entry Date
     C                     Z-ADDBJRDNB    ORED
      ***  .. Repo/Pledge ind.
     C                     MOVE *BLANKS   RPIN
      ***  .. Profit Centre
     C                     MOVE *BLANKS   DPPC
      *
      ***  Profit Center Used is 'Y', reset profit Center
      *
     C           BKPCDU    IFEQ 'Y'
      *
      ***  Access to Position Profit Center to retrieve the profit centre
      *
     C                     MOVELDPBN      WKDPBN           Customer
     C                     MOVELDPBA      WKBRCA           Branch
     C                     MOVELMCSESN    WKDPSS           New Security
      *
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      DPPC
     C                     ENDIF                           *IN89=OFF
      *
     C           DPPC      IFEQ *BLANKS
     C                     MOVELMASESN    WKDPSS           Event Security
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      DPPC
     C                     ENDIF                           *IN89=OFF
     C                     ENDIF                           DPPC=' '
      *
     C           DPPC      IFEQ *BLANKS
      *
      ***  Look up default using default matrix if profit centres
      ***  default used is yes on sdgelrpd
      *
     C                     MOVE DPBK      @BOOK
     C                     MOVE *BLANKS   @TRTP
     C                     MOVE *BLANKS   @SUTP
     C                     MOVE DPBA      @BRAN
     C                     MOVELDPBN      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    DPPC
     C                     ENDIF                           DPPC=' '
     C                     ENDIF                           BKPCDU='Y'
      *
      ***  If Analytical Accounting is installed, profit centre is
      ***  mandatory for Walk-In/Walk-out.
      *
     C           BGN0ST    IFEQ 'Y'
     C           DPPC      ANDEQ*BLANKS
     C                     MOVELBVSEPC    DPPC
     C                     ENDIF
      *                                                                   CAC005
      ** If CAC005 is installed, convert DPBK/DPPC into pseudo book       CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM DPBK      PBKCD   2                       CAC005
     C                     PARM DPPC      PPRFC   4                       CAC005
     C                     PARM           PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPPSBK     DPBK                            CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      ***  If no record on customer positions profit centre file
      ***  need to add one and amend the audit file
      *
     C           BKPCDU    IFEQ 'Y'
      *
      ***  Access to Position Profit Center to retrieve the profit centre
      *
     C                     MOVELDPBN      WKDPBN           Customer
     C                     MOVELDPBA      WKBRCA           Branch
     C                     MOVELDPSS      WKDPSS           New Security
      *
     C           KWSEPC    CHAINSEPCCDF              89
      *
     C           *IN89     IFEQ *ON
     C                     MOVEL'D'       RECI
     C                     MOVELDPBN      CNUM
     C                     MOVELDPBA      BRCA
     C                     MOVELDPSS      SESN
     C                     MOVELDPPC      PCCU
     C                     MOVE MCPTFR    PTFRXX                          CAC003
     C                     Z-ADDBJRDNB    LCD
     C                     MOVEL'I'       CHTP
     C                     EXSR ZTNLU1
     C                     MOVELNATN      TNLU
     C                     WRITESEPCCDF
      *
     C           1         CHAINSEPCA                89
     C           *IN89     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD8         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 08 *
     C                     MOVEL'SEPCA   'DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     ADD  1         NORE
     C                     ADD  1         SINS
     C                     UPDATSEPCAF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      ***  .. Charge Code
     C                     MOVE *BLANKS   DCHC
      ***  .. Charge Currency
     C                     MOVE *BLANKS   DCCE
      ***  .. Charge Amount
     C                     Z-ADD*ZERO     DCHA
      ***  .. Charge Settlement
     C                     Z-ADD*ZERO     DCSE
      ***  .. Charge acc. branch
     C                     MOVE *BLANKS   DCAB
      ***  .. Charge account
     C                     MOVE *BLANKS   DCAT
      ***  .. Value Date
     C                     Z-ADDMAALEF    DPVD
      ***  .. Echange Rate (Settle - Port)
      ***  .. Spot Rate Mult/Div Indicator
     C                     Z-ADD0         SPXR
     C                     MOVE *BLANKS   SPMD
      ***  .. Portfolio Reference
     C                     MOVE MCPTFR    PTFR
      *                                                                   CSE015
      ** Trade Date                                                       CSE015
      *                                                                   CSE015
     C           CSE015    IFEQ 'Y'                                       CSE015
     C           MACOEX    IFLT MAALEF                                    CSE015
     C                     Z-ADDMACOEX    DMTD                            CSE015
     C                     ELSE                                           CSE015
     C                     Z-ADDMAALEF    DMTD                            CSE015
     C                     ENDIF                                          CSE015
     C                     ENDIF                                          CSE015
      *
      ***  Setup Echange Rate and Spot Rate if Porfolio Management is ON
      ***  and TOF Interface is OFF
      *
     C           BGPFMG    IFEQ 'Y'
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C/COPY WNCPYSRC,SE7560C005
      *
     C           PTFR      IFNE *BLANKS
     C                     Z-ADD0         ZAMTF
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     ELSE
     C                     MOVE WNNMCY    ZCCYF
     C                     MOVE WNSPRT    ZRATEF
     C                     MOVE WNMDIN    ZMDINF
     C                     MOVE WNNBDP    ZCDPF
     C                     ENDIF
      *
     C                     MOVELDPBN      WWCNUM 10 P
     C                     MOVELDPBN      WNCNUM
     C                     MOVE PTFR      WKPTFR
      *
     C           PTFR      IFEQ '9997'
      *
     C                     CALL 'AOPLCSR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WWCNUM    @CUST  10
     C           SDPLCS    PARM SDPLCS    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD9         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 09 *
     C                     MOVE 'SDPLCSPD'DBFILE           ***************
     C                     MOVELWWCNUM    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE QBCSBY    ZCCYT
     C                     ELSE
      *
     C           KWPTFR    CHAINPMPORTLL             89
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD10        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 10 *
     C                     MOVE 'PMPORTLL'DBFILE           ***************
     C                     MOVELWNCNUM    DBKEY     P
     C                     MOVE WKPTFR    DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE PNPTCY    ZCCYT
     C                     ENDIF
      *
     C           ZCCYF     IFEQ ZCCYT
      ***  .. Spot Rate Mult/Div Indicator
     C                     Z-ADD1         SPXR
     C                     MOVE 'M'       SPMD
     C                     ELSE
      *
      ***  Retrieve base currency spot, M/D INDICATOR, DEC.PLACES
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM ZCCYT     @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD11        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 11 *
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELZCCYT     DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVE A6SPRT    ZRATET
     C                     MOVE A6MDIN    ZMDINT
     C                     MOVE A6NBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     Z-ADDZCRSRT    SPXR
     C                     MOVE ZCRSMD    SPMD
     C                     ENDIF
     C                     ENDIF                           PTFR<>*BLANKS
     C                     ENDIF                           PM=ON and TOF=OFF
      *
      ***  .. Customer Yield Rate
     C                     Z-ADD*ZEROS    CYLD
      ***  .. Customer with/deliv
     C                     MOVE 'N'       CWDI
      *                                                                                       207006
     C           CSE029    IFEQ 'Y'                                                           207006
     C                     MOVE BVCOTC    CPTY                                                207006
     C                     MOVE SMCC      MRKT                                                207006
     C                     ENDIF                                                              207006
      *
      ***  Write a new depot movement
      *
     C                     EXSR #WDPMV
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOPRF -  Subroutine to Call Access Object:                  *
      *  ------    Default Profit Center                              *
      *  Called by : #WTRAD #SDPMV                                    *
      *  Calls     : AOPRFMR0                                         *
      *****************************************************************
      *
     C           #AOPRF    BEGSR
      *                                                                                    179732
      **  Access Customer Details by using Access Object to retrieve                       179732
      **  Account Officer                                                                  179732
     C                     MOVE *BLANKS   @CUST                                            179732
     C                     MOVELWCUST     @CUST                                            179732
     C                     CALL 'AOCUSTR1'                                                 179732
     C                     PARM *BLANKS   @RTCD   7                                        179732
     C                     PARM '*KEY   ' @OPTN   7                                        179732
     C                     PARM           @CUST  10                                        179732
     C                     PARM           @KYST   7                                        179732
     C           SDCUST    PARM SDCUST    DSLDY                                            179732
      *                                                                                    179732
     C                     MOVELBBACOC    @ACOF                                            179732
      *
      ***  Setup Book code, Branch and User to retrieve Profit Centre
      *
     C                     CALL 'AOPRFMR0'
     C                     PARM *BLANKS   @RTC1   1
     C                     PARM           @BOOK   2
     C                     PARM           @TRTP   5
     C                     PARM           @SUTP   2
     C                     PARM           @BRAN   3
     C                     PARM *BLANKS   @DEPT   3
     C                     PARM USER      @USER  10
     C*******************  PARM *BLANKS   @ACOF   2                                        179732
     C*******************  PARM           WCNUM   6                                        179732
     C                     PARM           @ACOF   2                                        179732
     C                     PARM           WCUST   6                                        179732
     C                     PARM *BLANKS   @PRFC   4
      *
     C           @RTC1     IFEQ '0'
     C                     MOVEL@PRFC     WWPRFC  4
     C                     ELSE
     C                     MOVE *BLANKS   WWPRFC
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOSEC -  Subroutine to Call Access Object:                  *
      *  ------    Security Customer                                  *
      *  Called by : #WTRAD                                           *
      *  Calls     : AOSECSR0 *PSSR                                   *
      *****************************************************************
      *
     C           #AOSEC    BEGSR
      *
     C                     CALL 'AOSECSR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WCUST     @SCKY   6
     C           SDSECS    PARM SDSECS    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD12        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 12 *
     C                     MOVE 'SDSECSPD'DBFILE           ***************
     C                     MOVELWCUST     DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #UTRAD -  Update the trade to cancel it                      *
      *  ------                                                       *
      *  Called by : #TDRVR                                           *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #UTRAD    BEGSR
      *
      ***  Access to Trade previously generated using "Transaction Reference"
      *
     C           WKTRRF    CHAINTRADS                88
      *
     C           *IN88     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD13        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 13 *
     C                     MOVE 'TRADS   'DBFILE           ***************
     C                     MOVELWKTRRF    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  If feature S01401 (MT5xxx) is ON
      ***  Access to Trade details extended file
      *
     C           S01401    IFEQ 'Y'
     C           WKTRRF    CHAINTRADSDD1             88
      *
     C           *IN88     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD14        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 14 *
     C                     MOVE 'TRADSDY1'DBFILE           ***************
     C                     MOVELWKTRRF    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
     C                     MOVE 'C'       RECI
     C                     MOVE 'D'       CHTP
     C                     Z-ADDBJRDNB    LCD
     C                     UPDATTRADSDF
      *
      ***  Add 1 into counter of reversed trades
      *
     C                     ADD  1         W04CNT
     C                     MOVE 'Y'       WWDATA           one Read
      *
      * write to Movement Status file                                     CSE039
      *                                                                   CSE039
     C           CSE039    IFEQ 'Y'                                       CSE039
      *                                                                   CSE039
      ** Check if record exists (Reference, Type, Notification)           CSE039
     C                     MOVELTDRF      KTDRF                           CSE039
     C                     MOVEL'T'       KTRTY                           CSE039
     C                     Z-ADDBJRDNB    KNTDT                           CSE039
     C                     Z-ADD0         USQNR   30                      CSE039
      *                                                                   CSE039
      ** Get Sequence Number                                              CSE039
     C           KSEMV     SETLLSEMVTSL1                                  CSE039
     C                     READ SEMVTSL1                 65               CSE039
     C           *IN65     IFEQ *OFF                                      CSE039
     C           KTDRF     ANDEQTMTRRF                                    CSE039
     C           KTRTY     ANDEQTMTRTY                                    CSE039
     C           KNTDT     ANDEQTMNTDT                                    CSE039
     C                     Z-ADDTMSQNR    USQNR                           CSE039
     C                     ENDIF                                          CSE039
     C                     MOVELTDRF      TMTRRF                          CSE039
     C                     MOVEL'T'       TMTRTY                          CSE039
     C                     Z-ADDBJRDNB    TMNTDT                          CSE039
     C           USQNR     ADD  1         TMSQNR                          CSE039
     C                     MOVEL'DEL'     TMSWSC                          CSE039
     C                     MOVEL*BLANKS   TMSWRC                          CSE039
     C                     MOVEL*BLANKS   TMNTMT                          CSE039
     C                     MOVEL*BLANKS   TMLCUS                          CSE039
     C                     MOVEL'MIDAS'   TMINOR                          CSE039
     C                     MOVEL*BLANKS   TMMSGK                          CSE039
     C                     MOVEL*BLANKS   TMSTMG                          CSE039
     C                     MOVELWWDNAR    TMNARR                          CSE039
     C                     MOVEL'I'       TMLCTP                          CSE039
     C                     Z-ADDBJRDNB    TMLCDT                          CSE039
     C                     MOVELTMMP,1    TMTMST                          CSE039
     C                     MOVELTDBA      TMTRBB                          CSE039
     C                     MOVE USER      TMLCUS                          CSE039
      *                                                                   CSE039
     C                     WRITESEMVTSD0                                  CSE039
     C                     ENDIF                                          CSE039
      *                                                                   CSE039
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PDNCH -  Process Depot records for processing type 'NC'     *
      *  ------    (Name Change produced)                             *
      *  Called by : Main processing                                  *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #PDNCH    BEGSR
      *
      ***  Access to Corporate Action Name Changes to retrieve details
      *
     C**********           MOVE MSCORF    WKCORF                                              185017
     C                     MOVE MACORF    WKCORF                                              185017
     C           WKCORF    CHAINSECONCL0             46
      *
     C           *IN46     IFEQ *ON
     C           MLRECI    OREQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD15        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 15 *
     C                     MOVE 'SECONCL0'DBFILE           ***************
     C                     MOVELWKCORF    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           *IN46=*ON
      *
      ***  Update already done
      *
     C           MLUPDD    IFNE 'Y'
      *
      ***  Retrieve the details from the current security
      *
     C                     MOVELMASESN    WKSESN    P
      *
     C           WKSESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD16        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 16 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVELWKSESN    DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  For each non blank field retrieved on LF/SECONCL0
      ***    - Move current value retrieved on LF/SECTY into
      ***      the old fields held on PF/SECONCPD (MLOxxxx)
      ***    - Update PF/SECONCPD with the old fields
      ***    - Move all non blank fields in fields on PF/SECTYD and
      ***      update the master file PF/SECTYD with the new values of
      ***      fields entered.
      *
     C           MLSRPN    IFNE *BLANKS
     C                     MOVE SRPN      MLOSRN    P      Old Report Name
     C                     MOVE MLSRPN    SRPN      P      Report Name
     C                     ENDIF
      *
     C           MLSFN1    IFNE *BLANKS
     C                     MOVE SFN1      MLOSF1    P      Old Full Name 1
     C                     MOVE MLSFN1    SFN1      P      Full Name 1
     C                     ENDIF
      *
     C           MLSFN2    IFNE *BLANKS
     C                     MOVE SFN2      MLOSF2    P      Old Full Name 2
     C                     MOVE MLSFN2    SFN2      P      Full Name 2
     C                     ENDIF
      *
     C           MLT2RF    IFNE *BLANKS
     C                     MOVE T2RF      MLOT2R    P      Old Telekurs
     C                     MOVE MLT2RF    T2RF      P      Telekurs
     C                     ENDIF
      *
     C           MLISNO    IFNE *BLANKS
     C                     MOVE ISNO      MLOISN    P      Old ISIN Mumber
     C                     MOVE MLISNO    ISNO      P      ISIN Number
     C                     ENDIF
      *
     C           MLCSPN    IFNE *BLANKS
     C                     MOVE CSPN      MLOCSP    P      Old Cusip Mumber
     C                     MOVE MLCSPN    CSPN      P      Cusip Number
     C                     ENDIF
      *
     C           MLSREF    IFNE *BLANKS
     C                     MOVE SREF      MLOSRE    P      Old Extel
     C                     MOVE MLSREF    SREF      P      Extel
     C                     ENDIF
      *
     C           MLSRE1    IFNE *BLANKS
     C                     MOVE DASR      MLOSR1    P      Old Security ref. 1
     C                     MOVE MLSRE1    DASR      P      Security ref. 1
     C                     ENDIF
      *
     C           MLSRE2    IFNE *BLANKS
     C                     MOVE DCSR      MLOSR2    P      Old Security ref. 2
     C                     MOVE MLSRE2    DCSR      P      Security ref. 2
     C                     ENDIF
      *
     C           MLSRE3    IFNE *BLANKS
     C                     MOVE DDSR      MLOSR3    P      Old Security ref. 3
     C                     MOVE MLSRE3    DDSR      P      Security ref. 3
     C                     ENDIF
      *
     C                     UPDATSECTYDF
      *
      ***  Update done
      *
     C                     MOVE 'Y'       MLUPDD
     C                     UPDATSECONCD0
     C                     ENDIF                           MLUDPP<>'Y'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #ACOAT -  Subroutine to Retrieve Details from PF/SECOATPD    *
      *  ------    Corporate Action Type details                      *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCE   *
      *              #PROFE #PROFP #PREX #PRTGZ #PRRGM #PRRGC #PRNC   *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #ACOAT    BEGSR
      *
     C           WKCOAT    CHAINSECOATL0             89
      *
     C           *IN89     IFEQ *ON
     C           MMRECI    OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD17        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 17 *
     C                     MOVE 'SECOATPD'DBFILE           ***************
     C                     MOVELWKCOAT    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SECTO - Access to LF/SETY to Retrieve fields details        *
      *  ------   for the old security                                *
      *  Called by : Main processing                                  *
      *  Calls     : AOCURRR0 *PSSR                                   *
      *****************************************************************
      *
     C           #SECTO    BEGSR
      *
      ***  Chain for security record
      *
     C           WKSESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD18        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 18 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVELWKSESN    DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Security nominal decimal places and price basis
      *
     C                     MOVELNMCY      WONMCY
     C                     MOVE MKTI      WOMKTI
     C                     Z-ADDNMDP      WONMDP
     C                     MOVE SPBS      WOSPBS
     C                     Z-ADDCFCT      WOCFCT
     C                     MOVE SMCC      WOSMCC
     C                     Z-ADDCPNR      WOCPNR
     C                     MOVE EDFT      WOEDFT
     C                     Z-ADDNDVD      WONDVD
     C                     Z-ADDMATY      WOMATY
     C                     MOVE STBS      WOSTBS
     C                     MOVE SYBS      WOSYBS
     C                     MOVE SITP      WOSITP
     C                     MOVE MLTI      WOMLTI
      *
      ***  Retrieve nomimal currency spot, m/d ind. and dec. places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WONMCY    @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD19        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 19 *
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELWONMCY    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save base currency spot, m/d indicator, dec. places for later
      *
     C                     MOVE A6SPRT    WOSPRT
     C                     MOVE A6MDIN    WOMDIN
     C                     MOVE A6NBDP    WONBDP
     C                     MOVE A6NBDP    WOERLC
      *
     C           CEU002    IFEQ 'Y'
     C                     MOVE A6INCY    WOINCY  1
     C                     Z-ADDA6EUER    WOEUER
     C                     MOVE A6EUMD    WOEUMD
     C                     ELSE
     C                     MOVE *BLANKS   WOINCY  1
     C                     Z-ADD*ZEROS    WOEUER
     C                     MOVE *BLANKS   WOEUMD
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SECTN - Access to LF/SECTY to Retrieve fields details       *
      *  ------   for the new security                                *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCE   *
      *              #PROFE #PROFP #PREX #PRTGZ #PRRGM #PRRGC #PRNC   *
      *  Calls     : AOCURRR0 *PSSR                                   *
      *****************************************************************
      *
     C           #SECTN    BEGSR
      *
      ***  Chain for security record
      *
     C           WKSESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD20        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 20 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVELWKSESN    DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Security details for new security
      *
     C                     MOVELNMCY      WNNMCY
     C                     Z-ADDMKPR      WNMKPR
     C                     Z-ADDNMDP      WNNMDP
     C                     MOVE MKTI      WNMKTI
     C                     MOVE SMCC      WNSMCC
     C                     MOVE EDFT      WNEDFT
     C                     Z-ADDCPNR      WNCPNR
     C                     MOVE STBS      WNSTBS
     C                     Z-ADDMATY      WNMATY
     C                     MOVE SYBS      WNSYBS
     C                     Z-ADDNDVD      WNNDVD
     C                     Z-ADDNMDP      WNNMDP
     C                     MOVE SPBS      WNSPBS
     C                     Z-ADDCFCT      WNCFCT
     C                     MOVE SITP      WNSITP
     C                     MOVE MLTI      WNMLTI
      *
      ***  Retrieve nomimal currency spot, m/d ind. and dec. places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WNNMCY    @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD21        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 21 *
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELWNNMCY    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save base currency spot, m/d indicator, dec. places for later
      *
     C                     Z-ADDA6SPRT    WNSPRT
     C                     MOVE A6MDIN    WNMDIN
     C                     Z-ADDA6NBDP    WNNBDP
      *
     C           CEU002    IFEQ 'Y'
     C                     MOVE A6INCY    WNINCY  1
     C                     Z-ADDA6EUER    WNEUER
     C                     MOVE A6EUMD    WNEUMD
     C                     ELSE
     C                     MOVE *BLANKS   WNINCY  1
     C                     Z-ADD*ZEROS    WNEUER
     C                     MOVE *BLANKS   WNEUMD
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #TERPR -  Termination processing                             *
      *  ------                                                       *
      *  Called by : Main processing                                  *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #TERPR    BEGSR
      *
      ***  Close file if S01401 is installed.
      *
     C           S01401    IFEQ 'Y'
     C                     CLOSEDPTMVDY1
     C                     CLOSETRADSDY1
     C                     ENDIF
      *
      ***  Update Trade reference range if trade generated
      *
     C/COPY WNCPYSRC,SE7560C015
     C           NTRN      IFNE WWNTR1
     C                     Z-ADDWWNTR1    NTRN
     C                     UPDATTNRANABF               89
     C                     ENDIF
     C/COPY WNCPYSRC,SE7560C006
      *                                                                                       CER001
      ** When Lux Return feature ss present, close opened files                               CER001
      *                                                                                       CER001
     C           BGLRIN    IFEQ 'Y'                                                           CER001
     C                     CLOSESETRX1PD                                                      CER001
     C                     CLOSESEDPX1PD                                                      CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
     C           ULX008    IFEQ 'Y'                                                           CER001
     C                     CLOSEERLUICL1                                                      CER001
     C                     ENDIF                                                              CER001
      *
      ** UPDATE TRADE AUDIT DETAILS
      *
     C           W01CNT    IFNE *ZEROS
     C           W04CNT    ORNE *ZEROS
     C           1         CHAINTRADSAF              89
      *
     C           *IN89     IFEQ *OFF
     C                     ADD  W01CNT    SINS
     C                     ADD  W01CNT    NORE
     C                     ADD  W04CNT    SDEL
     C                     UPDATTRADSAF
     C                     ELSE
     C           *LOCK     IN   LDA
     C                     Z-ADD22        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 22 *
     C                     MOVE 'TRADSA  'DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  Update depot movements audit details
      *
     C           W02CNT    IFNE *ZEROS
     C           W05CNT    ORNE *ZEROS
     C           WXXDEL    ORNE *ZEROS                                                        219634
     C           1         CHAINDPTMVAF              89
      *
     C           *IN89     IFEQ *OFF
     C                     ADD  W02CNT    SINS
     C                     ADD  W05CNT    SINS
     C                     ADD  W02CNT    NORE
     C                     ADD  W05CNT    NORE
     C                     ADD  WXXDEL    SDEL                                                219634
     C                     SUB  WXXDEL    NORE                                                219634
     C                     UPDATDPTMVAF
     C                     ELSE
     C           *LOCK     IN   LDA
     C                     Z-ADD23        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 23 *
     C                     MOVE 'DPTMVA  'DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  Update position settlement audit details
      *
     C           W03CNT    IFNE *ZEROS
     C           1         CHAINPOSETAF              89
      *
     C           *IN89     IFEQ '0'
     C                     ADD  W03CNT    NODE             *NO.DLTD TDY
     C                     SUB  W03CNT    NORE             *NO.LIVE RCS
     C                     UPDATPOSETAF                89
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD24        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 24 *
     C                     MOVE 'POSETAF 'DBFILE           ***************
     C                     MOVEL'UPDAT'   DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ELSE
     C           *LOCK     IN   LDA
     C                     Z-ADD25        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 25 *
     C                     MOVE 'POSETA  'DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  Update  print Audit
      *
     C           WWDATA    IFNE 'N'
     C                     WRITEHEADAU
     C                     WRITECONTROL
     C                     ELSE
     C                     WRITEHEADAU
     C                     WRITENODTLS                     No detail to report
     C                     ENDIF
      *
      ***  Return out of the program
      *
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
     ******************************************************************
      /EJECT
      *****************************************************************
      *   *INZSR : Program initialisation Subroutine                  *
      *  -------                                                      *
      *  Called by : Automatically at pgm start                       *
      *  Calls     : AOBANKR0 *PSSR                                   *
      *****************************************************************
      *
     C           *INZSR    BEGSR
      *
      ***  Move the copyright statement
      *
     C                     MOVEACPY@      BIS@   80
      *
      ***  Initialise key and working fields
      *
     C           *LIKE     DEFN MASESN    WOSESN           Event Security
     C           *LIKE     DEFN MASESN    WWSESN           Working Security
     C           *LIKE     DEFN MATDVD    WKTDVD           Trade/Value Pos152589
     C           *LIKE     DEFN MCSESN    WNSESN           Current Security
     C           *LIKE     DEFN MSBRCD    WSBRCD           Saved Branch
     C           *LIKE     DEFN MSDDPT    WSDDPT           Saved Depot movement
     C           *LIKE     DEFN MCCNUM    WNCNUM           Customer
     C           *LIKE     DEFN MCCNUM    WKCNUM           Customer
     C           *LIKE     DEFN MCCOTP    WKCOTP           Cust/Book ind.
      ***  From LF/SECTY
     C           *LIKE     DEFN NMDP      WNNMDP           Decimal places
     C           *LIKE     DEFN NMDP      WONMDP           Decimal places
     C           *LIKE     DEFN SPBS      WOSPBS           Price Basis
     C           *LIKE     DEFN SPBS      WNSPBS           Price Basis
     C           *LIKE     DEFN CFCT      WNCFCT           Current Factor
     C           *LIKE     DEFN CFCT      WOCFCT           Current Factor
     C           *LIKE     DEFN NMCY      WONMCY           Nominal Ccy
     C           *LIKE     DEFN NMCY      WWNMCY           Nominal Ccy
     C           *LIKE     DEFN MKTI      WNMKTI           Market ind.
     C           *LIKE     DEFN MKTI      WOMKTI           Market ind.
     C           *LIKE     DEFN NMCY      WNNMCY           Nominal Ccy
     C           *LIKE     DEFN MKPR      WNMKPR           Market Price
     C           *LIKE     DEFN SMCC      WNSMCC           Market Center
     C           *LIKE     DEFN SMCC      WOSMCC           Market Center
     C           *LIKE     DEFN EDFT      WNEDFT           Ex Date Default
     C           *LIKE     DEFN EDFT      WOEDFT           Ex Date Default
     C           *LIKE     DEFN CPNR      WNCPNR           Coupon Rate
     C           *LIKE     DEFN CPNR      WOCPNR           Coupon Rate
     C           *LIKE     DEFN STBS      WNSTBS           Trade Basis
     C           *LIKE     DEFN STBS      WOSTBS           Trade Basis
     C           *LIKE     DEFN MATY      WNMATY           Maturity Date
     C           *LIKE     DEFN MATY      WOMATY           Maturity Date
     C           *LIKE     DEFN SYBS      WNSYBS           Yield Basis
     C           *LIKE     DEFN SYBS      WOSYBS           Yield Basis
     C           *LIKE     DEFN NDVD      WNNDVD           Next Dividend Date
     C           *LIKE     DEFN NDVD      WONDVD           Next Dividend Date
     C           *LIKE     DEFN SITP      WNSITP           Invest type
     C           *LIKE     DEFN SITP      WOSITP           Invest type
     C           *LIKE     DEFN MLTI      WNMLTI           Multi Currency
     C           *LIKE     DEFN MLTI      WOMLTI           Multi Currency
      ***  From LF/SECOALL5
     C           *LIKE     DEFN MCCORF    KWCORF           CA Reference
     C           *LIKE     DEFN MCCORF    WKCORF           CA Reference
     C           *LIKE     DEFN MCCORF    WSCORF           CA Reference
     C           *LIKE     DEFN MCOPTN    WKOPTN           Option Number
     C           *LIKE     DEFN MCBRCD    WWBRCD           Branch Code
     C           *LIKE     DEFN MCDDPT    WWDDPT           Depot
      ***  From LF/DPTMV
     C           *LIKE     DEFN DPMV      WWDPMV           Movement Type
     C           *LIKE     DEFN DPNA      WWDPNA           Nominal Amount
     C           *LIKE     DEFN MKTP      WWMKTP           Market Price
      ***  From LF/TRADS
     C           *LIKE     DEFN TDBK      WKTDBK           Book
     C           *LIKE     DEFN TDBK      WKBOOK           Book
     C           *LIKE     DEFN NOML      WWNOML           Nominal
     C           *LIKE     DEFN PAYT      WWPAYT           Pay to
     C           *LIKE     DEFN PYFM      WWPYFM           Pay from branch
     C           *LIKE     DEFN TDTP      WWTDTP           Trade type
     C           *LIKE     DEFN TPDY      WWTPDY           Price/Disc/Yield
      ***  From LF/SEPCBD
     C           *LIKE     DEFN MKTI      WKMKTI           Market Ind.
      ***  From LF/SEPCCD
     C           *LIKE     DEFN CNUM      WKDPBN           Customer Number
     C           *LIKE     DEFN BRCA      WKBRCA           Branch
     C           *LIKE     DEFN SESN      WKDPSS           Security
      ***  From LF/SECOATL0
     C           *LIKE     DEFN MMTYPE    WKCOAT           CA Type
      ***  From LF/TNRAN
     C           *LIKE     DEFN RECT      WKREC            Record type
     C           *LIKE     DEFN ZZ008     WKFILL           Filler
     C           *LIKE     DEFN RANG      WKRANG           Range Number
      *
      ***  Fields for security nominal currency
      *
     C           *LIKE     DEFN A6SPRT    WNSPRT
     C           *LIKE     DEFN A6SPRT    WOSPRT
     C           *LIKE     DEFN A6SPRT    WOEUER
     C           *LIKE     DEFN A6SPRT    WNEUER
     C           *LIKE     DEFN A6MDIN    WNMDIN
     C           *LIKE     DEFN A6MDIN    WOMDIN
     C           *LIKE     DEFN A6MDIN    WOEUMD
     C           *LIKE     DEFN A6MDIN    WNEUMD
     C           *LIKE     DEFN A6NBDP    WNNBDP
     C           *LIKE     DEFN A6NBDP    WONBDP
     C           *LIKE     DEFN A6ERLC    WOERLC
      *
     C           *LIKE     DEFN ECD       WWECD
     C/COPY WNCPYSRC,SE7560C013
      *
     C                     MOVE *BLANKS   WNSESN
     C                     MOVE *BLANKS   WNMKTI
     C                     MOVE *BLANKS   WNNMCY
     C                     MOVE *BLANKS   WNNMDP
     C                     MOVE *BLANKS   WNSMCC
     C                     MOVE *BLANKS   WNEDFT
     C                     MOVE *BLANKS   WOEDFT
     C                     MOVE *BLANKS   WNCPNR
     C                     MOVE *BLANKS   WOCPNR
     C                     MOVE *BLANKS   WNSTBS
     C                     MOVE *BLANKS   WNMATY
     C                     MOVE *BLANKS   WNSYBS
     C                     MOVE *BLANKS   WNNDVD
      *
     C                     MOVE *BLANKS   WSCORF
      *
     C                     MOVE *BLANKS   WALLOC  1
     C                     MOVE *BLANKS   WCUST   6
     C********** *NAMVAR   DEFN           MPHAS                                        220219 CCB020
     C********** *LOCK     IN   MPHAS                                                  220219 CCB020
     C**********           OUT  MPHAS                                                  220219 CCB020
      *                                                                                       CCB020
      ** CBFLAGQT Phase Check                                                                 CCB020
      *                                                                                       CCB020
     C                     MOVEL'CBC00100'@CBPRM  9                                           CCB020
     C                     MOVE '1'       @CBPRM                                              CCB020
     C                     CALL @CBPRM                                                        CCB020
     C                     PARM *BLANKS   COBST   4                                           CCB020
      *
      ***   LDA initialization
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVE 'SE7560'  DBPGM     P
     C                     OUT  LDA
      *
      ***  Call ZSFILE for Audit printer file SE7560AU
      *
     C                     Z-ADDSFNUMU    ZSNUM   60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   @PARM   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
      *
      ***  Program Ended abnormally
      *
     C           ZSERR     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     Z-ADD26        DBASE            ***************
     C                     MOVE 'SE7560AU'DBFILE           * DB ERROR 26 *
     C           'ZSFILE R'CAT  'OUTINE'  DBKEY     P      ***************
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Counts for Audit
      *
     C                     Z-ADD0         W01CNT  50
     C                     Z-ADD0         W02CNT  50
     C                     Z-ADD0         W03CNT  50
     C                     Z-ADD0         W04CNT  50
     C                     Z-ADD0         W05CNT  50
     C                     Z-ADD0         W06CNT  50
     C                     Z-ADD0         WXXDEL  50                                          219634
      *
      ***  Access bank details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD27        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 27 *
     C                     MOVE 'SDBANKPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Access Midas Module Details
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD28        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 28 *
     C                     MOVE 'SDMMODPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   CPB001
      ** If Private Banking Module is installed.                          CPB001
     C           BGN4ST    IFEQ 'Y'                         Begin BGN4ST  CPB001
      *                                                                   CPB001
      ** Set up Replication Processing Indicator.                         CPB001
     C                     MOVE 'Y'       WUREPL  1                       CPB001
      *                                                                   CPB001
     C                     ENDIF                            End BGN4ST    CPB001
      *
      ***  Retrieve Trade Number Range (BVCTNR)
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD29        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 29 *
     C                     MOVE 'SDSTRDPD'DBFILE           ***************
     C                     MOVEL'*FIRST'  DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C**********           MOVE BVERCU    WWERCU  60                                          CSD027
     C                     MOVE BVERCU    WWERCU  6                                           CSD027
     C/COPY WNCPYSRC,SE7560C016
      *
      ***  Using Trade Mumber Range, chain LF/TNRAN to retrieve
      ***  next available reference (NTRN)
      *
     C                     Z-ADD0         WKREC
     C                     MOVEL*BLANKS   WKFILL
     C                     Z-ADDBVCTNR    WKRANG
      *
     C           KWTNRA    CHAINTNRANABF             89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD30        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 30 *
     C                     MOVE 'TNRAN   'DBFILE           ***************
     C                     MOVELBVCTNR    DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDNTRN      WWNTR1  60       Next Trade Number
     C                     Z-ADDNTRN      WWNTR2  60       Next Depot Number
     C/COPY WNCPYSRC,SE7560C017
      *
      ** Retrieve Accruals/Profit Date form General Leg
      *
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD31        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 31 *
     C                     MOVE 'SDGELRPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     MOVEL'SE7560'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Check if S01445 is installed (Depot movement charges).
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'S01445'  @SARC   6
      *
      ***  Set indicator if installed.
      *
     C           @RTCD     IFEQ *BLANK
     C                     MOVE 'Y'       S01445  1
     C                     ELSE
     C                     MOVE 'N'       S01445
     C                     END
      *
      ***  Check if S01401 is installed.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'S01401'  @SARC   6
      *
      ***  Open file LF/DPTMVDY1, LF/TRADSDY1 and set indicator if installed.
      *
     C           @RTCD     IFEQ *BLANK
     C                     OPEN DPTMVDY1
     C                     OPEN TRADSDY1
     C                     MOVE 'Y'       S01401  1
     C                     ELSE
     C                     MOVE 'N'       S01401
     C                     ENDIF
      *
      ***  Check if CEU002 is installed (EMU EURO Rates).
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'CEU002'  @SARC
      *
      ***  Set indicator if installed.
      *
     C           @RTCD     IFEQ *BLANK
     C                     MOVE 'Y'       CEU002  1
     C                     ELSE
     C                     MOVE 'N'       CEU002
     C                     END
     C/COPY WNCPYSRC,SE7560C007
      *                                                                                       CER001
      ** When Lux Return feature is present, open files                                       CER001
      *                                                                                       CER001
     C           BGLRIN    IFEQ 'Y'                                                           CER001
     C                     OPEN SETRX1PD                                                      CER001
     C                     OPEN SEDPX1PD                                                      CER001
     C                     ENDIF                                                              CER001
      *                                                                                       CER001
      ** Check if ULX008 is installed                                                         CER001
      *                                                                                       CER001
     C                     MOVE 'N'       ULX008  1                                           CER001
     C                     CALL 'AOSARDR0'                                                    CER001
     C                     PARM *BLANKS   @RTCD                                               CER001
     C                     PARM '*VERIFY' @OPTN                                               CER001
     C                     PARM 'ULX008'  @SARC                                               CER001
      *                                                                                       CER001
      ** Set indicator if installed.                                                          CER001
      *                                                                                       CER001
     C           @RTCD     IFEQ *BLANK                                                        CER001
     C                     MOVE 'Y'       ULX008                                              CER001
     C                     OPEN ERLUICL1                                                      CER001
     C                     ENDIF                                                              CER001
      *                                                                   CAC005
      ***  Check if CAC005 is installed                                   CAC005
      *                                                                   CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   PRTCD   7                       CAC005
     C                     PARM '*VERIFY' POPTN   7                       CAC005
     C                     PARM 'CAC005'  PSARD   6                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005  1                       CAC005
     C                     ELSE                                           CAC005
     C                     MOVE 'N'       CAC005                          CAC005
     C                     END                                            CAC005
      *                                                                   CSE017
      ** Check if CSE017 is installed                                     CSE017
      *                                                                   CSE017
     C                     CALL 'AOSARDR0'                                CSE017
     C                     PARM *BLANKS   PRTCD                           CSE017
     C                     PARM '*VERIFY' POPTN                           CSE017
     C                     PARM 'CSE017'  PSARD                           CSE017
      *                                                                   CSE017
     C           PRTCD     IFEQ *BLANK                                    CSE017
     C                     MOVE 'Y'       CSE017  1                       CSE017
     C                     ELSE                                           CSE017
     C                     MOVE 'N'       CSE017                          CSE017
     C                     END                                            CSE017
      *                                                                   CSE015
      ** Check if CSE015 is installed                                     CSE015
      *                                                                   CSE015
     C                     CALL 'AOSARDR0'                                CSE015
     C                     PARM *BLANKS   PRTCD                           CSE015
     C                     PARM '*VERIFY' POPTN                           CSE015
     C                     PARM 'CSE015'  PSARD                           CSE015
      *                                                                   CSE015
     C           PRTCD     IFEQ *BLANK                                    CSE015
     C                     MOVE 'Y'       CSE015  1                       CSE015
     C                     ELSE                                           CSE015
     C                     MOVE 'N'       CSE015                          CSE015
      *                                                                   CSE015
      ** Database Error (return code other than *NRF)                     CSE015
      *                                                                   CSE015
     C           PRTCD     IFNE '*NRF   '                                 CSE015
     C                     MOVEL'SCSARDPD'DBFILE                          CSE015
     C                     MOVEL'CSE015'  DBKEY                           CSE015
     C                     Z-ADD33        DBASE                           CSE015
     C                     OUT  LDA                                       CSE015
     C                     EXSR *PSSR                                     CSE015
     C                     ENDIF                                          CSE015
     C                     END                                            CSE015
      *                                                                                       207006
      ** Check if CSE029 is installed                                                         207006
      *                                                                                       207006
     C                     CALL 'AOSARDR0'                                                    207006
     C                     PARM *BLANKS   PRTCD                                               207006
     C                     PARM '*VERIFY' POPTN                                               207006
     C                     PARM 'CSE029'  PSARD                                               207006
      *                                                                                       207006
      ** Database Error (return code other than *NRF)                                         207006
      *                                                                                       207006
     C           PRTCD     IFNE '*NRF   '                                                     207006
     C           PRTCD     ANDNE*BLANKS                                                       207006
     C                     MOVEL'SCSARDPD'DBFILE                                              207006
     C                     MOVEL'CSE029'  DBKEY                                               207006
     C                     Z-ADD41        DBASE                                               207006
     C                     OUT  LDA                                                           207006
     C                     EXSR *PSSR                                                         207006
     C                     ENDIF                                                              207006
      *                                                                                       207006
     C           PRTCD     IFEQ *BLANKS                                                       207006
     C                     MOVE 'Y'       CSE029  1                                           207006
     C                     ELSE                                                               207006
     C                     MOVE 'N'       CSE029                                              207006
     C                     ENDIF                                                              207006
      *                                                                   CSE039
      ***  Check if CSE039 is installed                                   CSE039
      *                                                                   CSE039
     C                     CALL 'AOSARDR0'                                CSE039
     C                     PARM *BLANKS   PRTCD   7                       CSE039
     C                     PARM '*VERIFY' POPTN   7                       CSE039
     C                     PARM 'CSE039'  PSARD   6                       CSE039
      *                                                                   CSE039
     C           PRTCD     IFEQ *BLANK                                    CSE039
     C                     MOVE 'Y'       CSE039  1                       CSE039
     C                     ELSE                                           CSE039
     C                     MOVE 'N'       CSE039                          CSE039
     C                     END                                            CSE039
      *                                                                                       216944
      ** Check if CSE018 is installed                                                         216944
      *                                                                                       216944
     C                     CALL 'AOSARDR0'                                                    216944
     C                     PARM *BLANKS   PRTCD                                               216944
     C                     PARM '*VERIFY' POPTN                                               216944
     C                     PARM 'CSE018'  PSARD                                               216944
      *                                                                                       216944
     C           PRTCD     IFEQ *BLANK                                                        216944
     C                     MOVE 'Y'       CSE018  1                                           216944
     C                     ELSE                                                               216944
     C                     MOVE 'N'       CSE018                                              216944
     C                     ENDIF                                                              216944
      *                                                                                       CAS006
      ** Check if CAS006 is enabled.                                                          CAS006
      *                                                                                       CAS006
     C                     CALL 'AOSARDR0'                                                    CAS006
     C                     PARM *BLANKS   PRTCD                                               CAS006
     C                     PARM '*VERIFY' POPTN                                               CAS006
     C                     PARM 'CAS006'  PSARD                                               CAS006
     C           SCSARD    PARM SCSARD    DSFDY                                               CAS006
      *                                                                                       CAS006
     C                     MOVE 'N'       CAS006  1                                           CAS006
     C           PRTCD     IFEQ *BLANKS                                                       CAS006
     C                     MOVE 'Y'       CAS006                                              CAS006
     C                     ELSE                                                               CAS006
      *                                                                                       CAS006
     C           PRTCD     IFNE '*NRF'                                                        CAS006
     C                     MOVEL'SCSARDPD'DBFILE                                              CAS006
     C                     MOVEL'CAS006'  DBKEY                                               CAS006
     C                     Z-ADD42        DBASE                                               CAS006
     C                     OUT  LDA                                                           CAS006
     C                     EXSR *PSSR                                                         CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       234829
      ** Check if CGL031 is installed                                                         234829
      *                                                                                       234829
     C                     CALL 'AOSARDR0'                                                    234829
     C                     PARM *BLANKS   PRTCD   7                                           234829
     C                     PARM '*VERIFY' POPTN   7                                           234829
     C                     PARM 'CGL031'  PSARD   6                                           234829
      *                                                                                       234829
     C           PRTCD     IFEQ *BLANKS                                                       234829
     C                     MOVE 'Y'       CGL031  1                                           234829
     C                     ENDIF                                                              234829
     C/COPY WNCPYSRC,SEH00027
      *
      ***  Define necessary KLIST'S
      *
      ***  Access to LF/SECOALL5
      *
     C           KWCOAL    KLIST
     C                     KFLD           WKCORF
     C                     KFLD           WKBRCD
     C                     KFLD           WKDDPT
      *
      ***  Access to LF/SECOALL3
      *
     C           KWCOA3    KLIST
     C                     KFLD           WKCORF
     C                     KFLD           WKOPTN
     C                     KFLD           WKBRCD
     C                     KFLD           WKDDPT
     C                     KFLD           WKCOTP
     C                     KFLD           WKBOOK
     C                     KFLD           WKCNUM
     C                     KFLD           WKPTFR
      *
      ***  Access to LF/TNRAN
      *
     C           KWTNRA    KLIST
     C                     KFLD           WKREC
     C                     KFLD           WKFILL
     C                     KFLD           WKRANG
      *
      ***  Access to LF/POSET1
      *
     C           KWPOSE    KLIST
     C                     KFLD           WKBRCD
     C                     KFLD           WKSESN
     C                     KFLD           WKDDPT
     C                     KFLD           WKALEF
     C                     KFLD           WKEVTY
     C                     KFLD           WKPTFR
     C                     KFLD           WKTNLU
      *
      ***  Access to LF/DPTMVDY1
      *
     C           KWDPMV    KLIST
     C                     KFLD           WKSESN
     C                     KFLD           WKTRRF
      *
      ***  Access to LF/SEPCCP
      *
     C           KWSEPC    KLIST
     C                     KFLD           WKDPBN
     C                     KFLD           WKBRCA
     C                     KFLD           WKDPSS
      *
      ***  Access to LF/SEPCBD
      *
     C           KWPCBD    KLIST
     C                     KFLD           WKTDBK
     C                     KFLD           WKBRCA
     C                     KFLD           WKSESN
     C                     KFLD           WKMKTI
      *
      ***  Access to LF/PMPORTPD
      *
     C           KWPTFR    KLIST
     C                     KFLD           WNCNUM
     C                     KFLD           WKPTFR
      *
      ***  Access to LF/INVTP
      *
     C           KWINV     KLIST
     C                     KFLD           WKNMCY
     C                     KFLD           WKSITP
      *
      ***  Access to all logical file CO
      *
     C           KWCOOP    KLIST
     C                     KFLD           WKCOR2
     C                     KFLD           WKOPT2
      *
      ***  Access to LF/CPOSC
      *
     C           KWCOSC    KLIST
     C                     KFLD           WCBRCD
     C                     KFLD           WCCNUM
     C                     KFLD           WCSESN
      *
      ***  Access to LF/CPOSC
      *
     C           KWBKPH    KLIST
     C                     KFLD           WKSESN
     C                     KFLD           WKBRCA
     C                     KFLD           WKBOOK
     C                     KFLD           WKMKTI
     C                     KFLD           WKTDVD                          152589
     C*                                                                   CSE039
     C*  - MOVEMENTS STATUS FILE                                          CSE039
     C*                                                                   CSE039
     C           KSEMV     KLIST                                          CSE039
     C                     KFLD           KTDRF   6                       CSE039
     C                     KFLD           KTRTY   1                       CSE039
     C                     KFLD           KNTDT   50                      CSE039
     C/COPY WNCPYSRC,SE7560C014
      *
     C                     MOVE 'N'       WWDATA  1        Data Read Indicator
      *
      ***  Calculate ECD as per Standard Midas Processing
      *
     C                     Z-ADDBKAPDT    ZZAPDT
     C                     Z-ADDBJDNWD    ZZDNWD
     C                     EXSR ZEVCD
     C                     MOVE ECD       WWECD
      *
     C                     ENDSR
     ******************************************************************
      /EJECT
      *****************************************************************
      *  *PSSR  - Dump routine in case of error                       *
      *  ------                                                       *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           WWRUN     IFNE 'Y'
     C                     DUMP
     C                     MOVE 'Y'       WWRUN   1
     C                     ENDIF
      *
     C           DBASE     IFGT 1
     C                     WRITEHEADAU
     C                     WRITEDBERROR
     C                     ENDIF
      *
     C                     MOVE *ON       *INU7
     C                     MOVE *ON       *INU8
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
     C                     ENDSR
      **********************************************************************
      *
     C********************************************************************
     C*                                                                  *
     C*  ZAVPR2 based on SR/ZAVPR standard subroutine                    *
     C*  ZAVPR- SUBROUTINE TO CALCULATE AVERAGE PRICE                    *
     C*                                                                  *
     C*  INPUT  -                   ZNOML (15,0) NOMINAL                 *
     C*                             ZAPNC (15,0) AP NUMERATOR            *
     C*           FROM CURRENCIES   ZCDP  (1,0) NOM.CCY DEC.PLS.         *
     C*           FROM SECTYD     - NMDP  (1,0) NOMINAL DEC. PLS.        *
     C*                             POWER8 ARRAY MUST BE INCLUDED IN     *
     C*                             CALLING PROGRAM                      *
     C*                                                                  *
     C*  OUTPUT - ZPRC   (16,9) AVERAGE PRICE                            *
     C*                                                                  *
     C*  CALLS - NONE                                                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           ZAVPR2    BEGSR                           **ZAVPR BEGSR
     C*
     C*** Define fields
     C*
     C                     Z-ADDZPRC      ZPRC   169
     C                     Z-ADDZAPNC     ZAPNC  150
     C                     Z-ADDZWK150    ZWK150 150
     C                     Z-ADDZDF154    ZDF154 154
     C                     Z-ADDZNOML     ZNOML  150
     C                     Z-ADDDC        DC      10
     C                     Z-ADDZCDP      ZCDP    10
     C*
     C*** Put AP Numerator into Nominal ccy dec pls
     C*
     C           5         ADD  ZCDP      DC      10
     C                     SUB  NMDP      DC
     C           DC        IFLT 5
     C           ZAPNC     DIV  POWER8,DC ZAPNC
     C                     END
     C*
     C*** Price basis 'P'
     C*
     C           SPBS      IFEQ 'P'
     C                     MULT 100       ZAPNC
     C                     END
     C*
     C           ZAPNC     DIV  ZNOML     ZPRC      H
     C*
     C*** Prevent High Order Truncation
     C*
     C           ZPRC      MULT ZNOML     ZWK150    H
     C           ZAPNC     SUB  ZWK150    ZWK150
     C           ZWK150    DIV  ZNOML     ZDF154    H
     C*
      *** Calculate price and adjust figures (if needed).
      *
     C           DC        IFGE 5
     C           ZPRC      DIV  POWER8,DC ZPRC      H
     C           ZDF154    DIV  POWER8,DC ZDF154    H
     C                     END
     C*
     C                     ADD  ZDF154    ZPRC
     C*
     C                     ENDSR                           *** ENDSR    ***
     C*
     C*****************************************************************
      /EJECT                                                              CPB001
      *****************************************************************   CPB001
      *                                                               *   CPB001
      *  REPLIC - Subroutine to set up Replication Indicator.         *   CPB001
      *                                                               *   CPB001
      *  Called by : #WDPMV                                           *   CPB001
      *                                                               *   CPB001
      *  Calls     : None                                             *   CPB001
      *                                                               *   CPB001
      *****************************************************************   CPB001
     C           REPLIC    BEGSR                           ** REPLIC SR **CPB001
      *                                                                   CPB001
      **  Initialize Replication Indicator.                               CPB001
     C                     MOVE *BLANK    REPI                            CPB001
      *                                                                   CPB001
      **  Access Customer Details by using Access Object,                 CPB001
      **  to retrieve Private Banking Customer Indicator.                 CPB001
     C                     MOVE *BLANKS   @CUST                           CPB001
     C                     MOVELDPBN      @CUST                           CPB001
     C                     CALL 'AOCUSTR1'                                CPB001
     C                     PARM '*MSG   ' @RTCD   7                       CPB001
     C                     PARM '*KEY   ' @OPTN   7                       CPB001
     C                     PARM           @CUST  10                       CPB001
     C                     PARM           @KYST   7                       CPB001
     C           SDCUST    PARM SDCUST    DSLDY                           CPB001
      *                                                                   CPB001
      **  If Customer Details do not exist, handle Database Error.        CPB001
     C           @RTCD     IFNE *BLANK                     BEGIN @RTCD    CPB001
     C                     MOVEL'SDCUSTPD'DBFILE           ***************CPB001
     C                     MOVEL@CUST     DBKEY            * DB ERROR 91 *CPB001
     C                     Z-ADD21        DBASE            ***************CPB001
     C                     EXSR *PSSR                                     CPB001
      *                                                                   CPB001
     C                     ENDIF                           End @RTCD      CPB001
      *                                                                   CPB001
      **  If Customer is a Private Banking Customer, set up               CPB001
      **  Replication Indicator.                                          CPB001
     C           BBPRBA    IFEQ 'Y'                        Begin BBPRBA   CPB001
     C********** PHASE     ANDNE'A'                                                    220219 CCB020
     C           COBST     ANDEQ'*YES'                                                        CCB020
     C                     MOVE 'Y'       REPI                            CPB001
      *                                                                   CPB001
     C                     ENDIF                           End BBPRBA     CPB001
      *                                                                   CPB001
     C                     ENDSR                                          CPB001
      *****************************************************************   CPB001
     C/EJECT                                                                                  234829
      *****************************************************************                       234829
      *                                                               *                       234829
      * GOPD - Get Original Purchase Date.                            *                       234829
      *                                                               *                       234829
      *****************************************************************                       234829
      *                                                                                       234829
     C           GOPD      BEGSR                                                              234829
      *                                                                                       234829
     C           DPMV      IFEQ 'WI'                                                          234829
     C                     Z-ADDDPMD      WDPMD                                               234829
     C                     ELSE                                                               234829
     C                     Z-ADDDPDO      WDPMD                                               234829
     C                     ENDIF                                                              234829
      *                                                                                       234829
     C                     CALL 'SEVOPDT'                                                     234829
     C                     PARM *BLANKS   PRETC  10                                           234829
     C                     PARM *BLANKS   DDOPDT  7                                           234829
     C                     PARM           DPMV                                                234829
     C                     PARM           DPSS                                                234829
     C                     PARM           DPBN                                                234829
     C                     PARM           DPBA                                                234829
     C                     PARM           BJRDNB                                              234829
     C                     PARM           BJDFIN                                              234829
     C                     PARM           DPVD                                                234829
     C                     PARM           WDPMD   50                                          234829
     C                     PARM           DPNA                                                234829
     C                     PARM           PTFR                                                234829
     C                     PARM           @FNXA                                               234829
     C                     PARM           @MIXA                                               234829
     C                     PARM           @MDXA                                               234829
     C                     PARM           WOPDOK  1                                           234829
     C                     PARM           OPDT                                                234829
      *                                                                                       234829
     C                     ENDSR                                                              234829
      *****************************************************************                       234829
     C/EJECT                                                                                  234829
      *****************************************************************                       234829
      *                                                               *                       234829
      * GFSPR - Get Fiscal Price                                      *                       234829
      *                                                               *                       234829
      *****************************************************************                       234829
      *                                                                                       234829
     C           GFSPR     BEGSR                                                              234829
      *                                                                                       234829
     C                     Z-ADD0         WFSPI                                               234829
     C                     MOVE NMCY      NMCYA                                               235041
     C                     Z-ADDDPNA      WNOML                                               235041
     C                     MOVE @DPBN     XDPBN   6                                           235041
      *                                                                                       234829
     C                     CALL SEVFSP                                                        234829
     C                     PARM *BLANKS   PRETC  10                                           234829
     C                     PARM           PFSPR  16                                           234829
     C                     PARM           @SECTY                                              234829
     C                     PARM           OPDT                                                234829
     C                     PARM           BJDFIN                                              234829
     C                     PARM           WFSPI   10                                          234829
     C                     PARM 'C'       SCUMEX  1                                           234829
     C***********          PARM           DPNA                                                235041
     C                     PARM           WNOML  150                                          235041
     C                     PARM           WNNBDP                                              234829
     C                     PARM           DPMV                                                234829
     C********             PARM           @DPBN                                               235041
     C                     PARM           XDPBN                                               235041
     C                     PARM           DPBA                                                234829
     C                     PARM *BLANKS   WDOPDT  6                                           234829
     C                     PARM           PTFR                                                234829
     C                     PARM           @FNXA                                               234829
     C                     PARM           @MIXA                                               234829
     C                     PARM           @MDXA                                               234829
     C                     PARM           WFSPOK  1                                           234829
     C                     PARM           FSPR                                                234829
     C                     PARM           FSPP                                                234829
      *                                                                                       234829
     C                     ENDSR                                                              234829
      *****************************************************************                       234829
     C/EJECT                                                                                  234829
      *****************************************************************                       234829
      *                                                               *                       234829
      * GOPI - Get Original Purchase Interest                         *                       234829
      *                                                               *                       234829
      *****************************************************************                       234829
      *                                                                                       234829
     C           GOPI      BEGSR                                                              234829
      *                                                                                       234829
     C                     MOVE NMCY      NMCYA                                               235041
     C                     MOVE @DPBN     XDPBN   6                                           235041
     C                     CALL SEVOPI                                                        234829
     C                     PARM *BLANKS   PRETC  10                                           234829
     C                     PARM *BLANKS   EOPIN  14                                           234829
     C                     PARM           DPMV                                                234829
     C********             PARM           @DPBN                                               235041
     C                     PARM           XDPBN                                               235041
     C                     PARM 'C'       SCUMEX  1                                           234829
     C                     PARM *BLANKS   WDOPDT                                              234829
     C                     PARM           DPSS                                                234829
     C                     PARM           DPNA                                                234829
     C                     PARM           OPDT                                                234829
     C                     PARM           DPBA                                                234829
     C                     PARM           BJDFIN                                              234829
     C                     PARM           @SECTY                                              234829
     C                     PARM           WNNBDP                                              234829
     C                     PARM 'Y'       WDFLT   1                                           234829
     C                     PARM *BLANKS   WVALD   1                                           235041
     C                     PARM           PTFR                                                234829
     C                     PARM           @FNXA                                               234829
     C                     PARM           @MIXA                                               234829
     C                     PARM           @MDXA                                               234829
     C                     PARM           WOPIOK  1                                           234829
     C                     PARM           OPIN                                                234829
     C                     PARM           ACIN                                                234829
      *                                                                                       234829
     C                     ENDSR                                                              234829
      *****************************************************************                       234829
      *
      ***  Compile with 2 Levels /COPY
     C/COPY WNCPYSRC,SE7560C008
      *
     C/COPY ZSRSRC,ZALIGNZ2
     C/COPY ZSRSRC,ZDAYSZ2
     C/COPY ZSRSRC,ZDATE1Z2
     C/COPY ZSRSRC,ZDATE2Z2
     C/COPY ZSRSRC,ZASIGNZ2
     C/COPY ZSRSRC,ZEVCDZ1
     C/COPY ZSRSRC,ZPCINTZ1
     C/COPY ZSRSRC,ZAPNUM
     C/COPY ZSRSRC,ZPRCIZ1
     C/COPY ZSRSRC,ZPRCOZ1                                                151356
     C/COPY ZSRSRC,ZYLDZ2
     C/COPY ZSRSRC,ZNCDZ3
     C/COPY ZSRSRC,ZLCDZ1
     C/COPY ZSRSRC,ZDYYRZ3
     C/COPY ZSRSRC,ZRATEZ1
     C/COPY ZSRSRC,ZXRATEZ1
     C/COPY ZSRSRC,ZCOTRZ1
     C/COPY ZSRSRC,ZYLDIZ1
     C/COPY ZSRSRC,ZYLDOZ1                                                151356
     C/COPY ZSRSRC,ZACCRZ1
     C/COPY ZSRSRC,ZACCZZ1
     C/COPY ZSRSRC,ZCNSDZ1
     C/COPY ZSRSRC,ZCALCD
     C/COPY ZSRSRC,ZBKDT
     C/COPY ZSRSRC,ZACCH
     C/COPY ZSRSRC,ZCCYCN
     C/COPY ZSRSRC,ZTNLU1Z2
      /EJECT
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** STAMP - Dummy timestamp                                                                    CPK015
0001-01-01-00.00.00.000000                                                                    CPK015
**  CPY@
(c) Finastra International Limited 2001
**  POWER9 - ARRAY OF POWERS FOR CURRENCY CONVERSION                      136931
000000001
000000010
000000100
000001000
000010000
000100000
001000000
010000000
100000000
**  TMMP  - Array of TIMESTAMP
0001-01-01-00.00.00.000000
