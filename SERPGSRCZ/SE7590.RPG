     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE CO Generate forward events cust/book')        *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  RPG/SE7590 - SE CO Generate Forward Events Cust/Book         *
      *                                                               *
      *  Function:  This Program Generate the forward events          *
      *  (COB)      Customer/Book                                     *
      *                                                               *
      *  Called by: SEC7590 - Generate Forward Events Cust/Book       *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. 226449             Date 24Jun15               *
      *  Prev Amend No. CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241795             Date 27Sep06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 190204             Date 31May01               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 179732             Date 16Jun00               *
      *                 CSE020             Date 21Mar00               *
      *                 161732             Date 21Mar00               *
      *                 088864             Date 20Apr00               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 161746             Date 12Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 05Jan99               *
      *                 151945             Date 06Jan99               *
      *                 137881             Date 13Jul98               *
      *                 141303             Date 26Aug98               *
      *                 CEU017             Date 18Mar98               *
      *                 CSE007   *CREATE   Date 18Mar98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  241795 - Populate ECSS whether CEU011 is switched on or off. *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  190204 - Recompiled due to changes in PF/SECODVPD.           *
      *  179732 - Upgrade Profit centre default matrix to use the     *
      *           correct customer number and a value for the account *
      *           officer.                                            *
      *  CSE020 - Corporate Actions Domino Effect Processing          *
      *           (Recompiled due to changes in PF/SECORFPD)          *
      *  161732 - Corporate Actions Exercise and Conversion -         *
      *           Part Stock/Keep Rest Calculation                    *
      *           (Recompiled due to changes in PF/SECOEXPD)          *
      *  088864 - Recompile over amended /COPY ZPCINTZ1               *
      *  161746 - Average Price Option 'I' has been added in SE7505.  *
      *           (SECORGPD/MFAVOP)                                   *
      *           Manage it as option 'C' in this program and in      *
      *           SE7560 SE7561 SE7590 SE7591                         *
      *           ( SEINS-BBN20520 & GBSEUSRMSG/CO00175 changed too ) *
      *  CAC005 - PCA-SE Enhancement.                                 *
      *  151945 - Recompiled Over changed ZDYYRZ3 .                   *
      *  137881 - Corporate Actions: Generation of Trades/Depot Mvts  *
      *           - Processing for 'NC' was never executed            *
      *           - No Trades/Depot Movements for 'NF' events         *
      *           - Review calculation of Average Prices for 'CR'     *
      *  141303 - EMU: Adaptation for CEU011 'Position/Risk Reporting'*
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007 - Corporate Actions                                   *
      *                                                               *
      *****************************************************************
      /EJECT
     FSECORFL2IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO References                                  Prefix - 'MA'
      *
     FSECODRL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Depot Upd Idx                               Prefix - 'MS'
      *
     FSECOALL5IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Stock Allocations                           Prefix - 'MC'
      *
     FSDCURRL1IF  E           K        DISK         KINFSR *PSSR          141303
      ***  SD Currency Details                                            141303
      *                                                                   141303
     FTREVED  O   E                    DISK         KINFSR *PSSR
      ***  SE Trade Events
      *
     FTREVEA  UF  E                    DISK         KINFSR *PSSR A
      ***  SE Trade Events - Audit
      *
     FPCTEVD  O   E                    DISK         KINFSR *PSSR
      ***  SE Portfolio Customer Trades Events
      *
     FPCTEVA  UF  E                    DISK         KINFSR *PSSR A
      ***  SE Portfolio Customer Trades Events - Audit
      *
     FSECTY   IF  E           K        DISK         KINFSR *PSSR
      ***  Securities Details
      *
     FSECODVL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Dividends Events File details               Prefix - 'MD'
      *
     FSECOFRL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Free Allocations                            Prefix - 'ME'
      *
     FSECORGL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Rights                                      Prefix - 'MF'
      *
     FSECOOFL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Exchange Offers                             Prefix - 'MI'
      *
     FSECOEXL0IF  E           K        DISK         KINFSR *PSSR          137881
      ***  SE CO Exercises and Conversions          Prefix - MJ           137881
      *                                                                   137881
     FSECOCRL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Corp. Reorganisation                        Prefix - 'MH'
      *
     FSECOATL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Type file details                           Prefix - 'MM'
      *
     FSECONCL0IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Name Changes                                Prefix - 'ML'
      *                                                                   137881
     FSECOCCL0IF  E           K        DISK         KINFSR *PSSR          137881
      ***  SE CO Currency Change                    Prefix - NA           137881
      *
     FSEPCBD  IF  E           K        DISK         KINFSR *PSSR
      ***  SE Book Position Profit Center
      *
     FSEPCCD  IF  E           K        DISK         KINFSR *PSSR
      ***  SE Customer Position Profit Center
      *
     FCPOSC   IF  E           K        DISK         KINFSR *PSSR
      ***  SE Cust Posn by Branch, Sec & Cus.
      *
     FBKPHD   IF  E           K        DISK         KINFSR *PSSR
      ***  SE Book Postion Headers
      *
     FSEDEV   IF  E           K        DISK         KINFSR *PSSR
      ***
      *
     FSECEO   IF  E           K        DISK         KINFSR *PSSR
      ***
     F            SEDEVDF                           KRENAMESEDEVDO
     F            SNDEVDF                           KRENAMESNDEVDO
      *
     FINVTP   IF  E           K        DISK         KINFSR *PSSR
      ***  Investment type details
      *
     FSECOALL3IF  E           K        DISK         KINFSR *PSSR
      ***  SE CO Stock Allocations                           Prefix - 'MC'
     F            SECOALD0                          KRENAMESECOALR3
      *
     FSE7590AUO   E                    PRINTER      KINFSR *PSSR
      ***  SE CO Generate Forward Events Cust/Book - Audit
     F                                              KINFDS SPOOLU
      *
      **************************************************************************
      /EJECT
      **************************************************************************
      *
     E                    SECUR      20 10
      ***  Retrieve the Security from PF/SECOCRPD
      *
     E                    MPRICE     20 16
      ***  Retrieve Market Price from PF/SECOCRPD
      *
     E                    NPR        20 15 8
      ***  Market Price from PF/SECOCRPD converted on numeric field
      *
     E                    NSEC       22 10
      ***  Array Security for the Calculated Average Price (1) & (2)
      *
     E*****               NOMI       22 15 0                              137881
     E                    NOMI       22 23 8                              137881
      ***  Array Nominal for the Calculated Average Price (1) & (2)
      *
     E*****               MARK       22 15 0                              137881
     E                    MARK       22 23 8                              137881
      ***  Array Market Price for the Calculated Average Price (1) & (2)
      *
     E*****               AVPR       22 15 0                              137881
     E                    AVPR       22 23 8                              137881
      ***  Average price for each new Security on processing type 'CR'
      *
     E/COPY ZSRSRC,ZALIGNZ1
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZHOLE
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E                    POWER8  1   8  8 4             POWER8 ARRAY
     E                    POWER   1   7  7 3             POWER ARRAY
      *
     E                    CPY@    1   1 80
      ***  Copyrigth Array
      *
     E                    POWER9  1   9  9 4             POWER9 ARRAY     137881
      *
     E                    CUR       200  3                                141303
      ** Currency array                                                   141303
      *                                                                   141303
     E                    SRT       200  2 0                              141303
      ** Currency Sort Sequence array                                     141303
      *                                                                   141303
      **************************************************************************
      /EJECT
      **************************************************************************
     I/COPY ZSRSRC,ZNCDZ2
     I/COPY ZSRSRC,ZHOLI
      *
     ILDA       E DSLDA
      ***  Data structure for database error
      *
     IPSDS       SDS
      ***  Program Status Data Structure
     I                                      254 263 USER
      *
     ISPOOLU      DS
      ***  File information data structure
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
     IWWINV       DS
      ***  Working DS for Database Error on LF/INVTP
     I                                        1   3 WKNMCY
     I                                        4   6 WKSITP
     IWWCOSC      DS
      ***  Working DS for Database Error on LF/CPOSC
     I                                        1   3 WCBRCD
     I                                        4  13 WCSESN
     I**********                             14  190WCCNUM                                    CSD027
     I                                       14  19 WCCNUM                                    CSD027
     I            DS
      ***  Working DS for Settlement Account
     I                                        1   6 WWCUST
     I**********                              7  10 WWSTAC                                    CGL029
     I**********                             11  12 WWSTSQ                                    CGL029
     I**********                              1  12 WWPAAC                                    CGL029
     I                                        7  16 WWSTAC                                    CGL029
     I                                       17  18 WWSTSQ                                    CGL029
     I                                        1  18 WWPAAC                                    CGL029
      *
     IWWCOOP      DS
      ***  Working DS for Database Error on LF/SECODVL0
     I                                        1   6 WKCOR2
     I                                        7   80WKOPT2
      *
     I            DS
      ***  DATA STRUCTURE FOR NUMERIC FIELDS TO NUMERIC ARRAY MOVES
      ***                                     1 300 APR
      ***                                     1 300 NPR
      *
     INWRCD     E DSSECOALL5
      ***  Current master file fields
      *
     ISVRCD       DS                            230
      ***  Stored master file fields
      *
     ISDBANK    E DSSDBANKPD
      ***  Data structure for bank details
      *
     ISDBRCH    E DSSDBRCHPD
      ***  Data structure for branch details
      *
     ISDSTRD    E DSSDSTRDPD
      ***  Data structure for securities trading details
      *
     ISDCURR    E DSSDCURRPD
      ***  Data structure for currency details
      *
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          #DFAC1                                    CGL029
      ***  Data structure for customer details
      *
     ISDSECS    E DSSDSECSPD
      ***  Dummy record format for access to Securities Clients
      *
     ISDMMOD    E DSSDMMODPD
      ***  Dummy record format for access to Midas Module
      *
     ISDGELR    E DSSDGELRPD
     I              QQACCD                          QQACD1                                    CGL029
      ***  Dummy record format for access to General Ledger Details
      *
     IDSSDY     E DSDSSDY
      ***  Long data structure for access objects
      *
     IDSFDY     E DSDSFDY
      ***  First DS for access programs, short data structure
      *
     ICPYR@#      DS
      ***  Data structure for compilation  - COPYRIGHT INSERTION
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                M A I N     P R O C E S S I N G                *
      *****************************************************************
      *
      ***  Access first record in CO Reference file (Status not equal to C)
      *
     C           *LOVAL    SETLLSECORFL2
     C                     READ SECORFL2                 88
      *
      ***  Do while end of file is not reached
      *
     C           *IN88     DOWEQ*OFF
      *
      ***  BYPASS REVERSED RECORDS
      *
     C           MACHTP    IFNE 'R'
      *
      ***  If security shortname is not equal to saved security
      ***  execute subroutine #SECTO to retrieve Security Record
      *
     C           MASESN    IFNE WOSESN
     C                     MOVELMASESN    WOSESN    P
     C                     MOVELMASESN    WKSESN    P
     C                     EXSR #SECTO
     C                     ENDIF
      *
      ***  Process all customer/Book allocation records
      *
     C                     EXSR #PRCB
     C                     ENDIF
      *
      ***  Access next record in CO Reference file
      *
     C                     READ SECORFL2                 88
     C                     ENDDO
      *
      ***  Termination processing
      *
     C                     EXSR #TERPR
      *
     ******************************************************************
      /EJECT
      *****************************************************************
      *  #PRCB  -  Process all cust/book allocation                   *
      *  -----                                                        *
      *  Called by : Main processing                                  *
      *  Calls     : #SELLF #CUAVP ZALIGN #CAAVP #PRDV #PRFR #PRCR    *
      *              #PRCC #PRCE #PROF #PREX #PRRG #PRNC              *
      *****************************************************************
      *
     C           #PRCB     BEGSR
      *
     C                     MOVELMACORF    KWCORF  6 P      CO Reference Number
      *
      ***  Access LF/SECODRL0 with reference in order to obtain
      ***  the depots linked to the Corporate Action
      *
     C           KWCORF    SETLLSECODRL0
     C           KWCORF    READESECODRL0                 87
      *
     C           *IN87     DOWEQ*OFF
      *
      ***  If Status is 'S' or 'X'
      *
     C           MSCOST    IFEQ 'S'
     C           MSCOST    OREQ 'X'
      *
     C                     MOVELMSCORF    WKCORF    P      CO Reference Number
     C                     MOVE MSBRCD    WKBRCD           CO Branch Code
     C                     MOVE MSDDPT    WKDDPT           CO Depot
      *
      ***  Reset array SECUR (20 * 10A) to blanks
      ***  Reset array MPRICE (20 * 16A) to blanks
      *
     C                     MOVEA*BLANKS   SECUR
     C                     MOVEA*BLANKS   MPRICE
     C                     MOVE 'Y'       WFIRST  1
      *
      ***  Access Allocation Record with same Corporate Action Reference, same branch
      ***  and same depot
      *
     C           KWCOAL    SETLLSECOALL5
     C           KWCOAL    READESECOALL5                 86
      *
     C           *IN86     DOWEQ*OFF
      *
      ***  Access to logical file depends on processing type
      *
     C                     EXSR #SELLF
      *
      ***  Retrieve the current average price
      *
     C           MAPTYP    IFEQ 'FR'
     C           MEADRE    ANDEQ'R'
     C           MAPTYP    OREQ 'CR'
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'EX'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C           MAPTYP    OREQ 'NC'
      *
     C                     EXSR #CUAVP
      *
      ***  Retrieve the current average price
      *
     C           MAPTYP    IFEQ 'CR'
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C           MAPTYP    OREQ 'NC'
      *
      ***  If processing type is 'CR' Move Security file into workfield
      ***  and Market price file into workfield
      *
     C           MAPTYP    IFEQ 'CR'
     C           WFIRST    ANDEQ'Y'
     C                     MOVE 'N'       WFIRST
     C                     MOVEAMHSECA    SECUR
     C                     MOVEAMHMKTP    MPRICE
      *
      ***  Convert the market price from file to numeric array
      *
     C                     MOVEA*ZERO     NPR
     C                     Z-ADD1         X       20
      *
     C           X         DOWLT21
     C           MPRICE,X  IFNE *BLANKS
     C                     MOVE MPRICE,X  NPR,X                           137881
     C*****                MOVE MPRICE,X  ZFIELD                          137881
     C*****                Z-ADD8         ZADEC                           137881
     C*****      15        SUB  8         ZADIG                           137881
     C*****                MOVE *OFF      *IN99                           137881
     C*****                EXSR ZALIGN                                    137881
      *****                                                               137881
     C*****      *IN99     IFEQ *ON                                       137881
     C*****                Z-ADD*ZEROS    NPR,X                           137881
     C*****                ELSE                                           137881
     C*****                MOVE ZFIELD    NPR,X                           137881
     C*****                ENDIF                                          137881
     C*****                ADD  1         X                               137881
     C                     ENDIF
     C                     ADD  1         X                               137881
     C                     ENDDO
     C                     ENDIF
      *
     C                     EXSR #CAAVP
     C                     ENDIF
     C                     ENDIF
      *
      ***  Generate Trades/Depot Movements depending on Processing Type
      *
     C                     SELEC
      *
      ***  Processing type 'DV'
      *
     C           MAPTYP    WHEQ 'DV'
     C                     EXSR #PRDV
      *
      ***  Processing type 'FR'
      *
     C           MAPTYP    WHEQ 'FR'
     C                     EXSR #PRFR
      *
      ***  Processing type 'CR'
      *
     C           MAPTYP    WHEQ 'CR'
     C                     EXSR #PRCR
      *                                                                   CEU017
      ***  Processing type 'CC'                                           CEU017
      *                                                                   CEU017
     C           MAPTYP    WHEQ 'CC'                                      CEU017
     C                     EXSR #PRCC                                     CEU017
      *
      ***  Processing type 'CE'
      *
     C           MAPTYP    WHEQ 'CE'
     C                     EXSR #PRCE
      *
      ***  Processing type 'OF'
      *
     C           MAPTYP    WHEQ 'OF'
     C                     EXSR #PROF
      *
      ***  Processing type 'EX'
      *
     C           MAPTYP    WHEQ 'EX'
     C                     EXSR #PREX
      *
      ***  Processing type 'RG'
      *
     C           MAPTYP    WHEQ 'RG'
     C                     EXSR #PRRG
      *
      ***  Processing type 'NC'
      *
     C           MAPTYP    WHEQ 'NC'
     C                     EXSR #PRNC
     C                     ENDSL                           Check proc. type
      *
      ***  Access next allocation record for the same CO Reference, same branch and same depot
      *
     C           KWCOAL    READESECOALL5                 86
     C                     ENDDO
     C                     ENDIF                           Status 'S' or 'X'
      *
      ***  Access next depot linked to the Corporate Action
      *
     C           KWCORF    READESECODRL0                 87
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SELLF -  Select Logical file from the processing type       *
      *  ------                                                       *
      *  Called by : #PRCB                                            *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #SELLF    BEGSR
      *
     C                     MOVE MCCORF    WKCOR2
     C                     MOVE MCOPTN    WKOPT2
      *
     C                     SELEC
      *
      ***  Processing type 'DV'
      ***  Access to CO Dividends Events file
      *
     C           MAPTYP    WHEQ 'DV'
     C           KWCOOP    CHAINSECODVL0             47
     C                     MOVE MDRECI    WWRECI  1
     C                     MOVEL'SECODVL0'WWFILE 10
      *
      ***  Processing type 'FR'
      ***  Access to CO Free Allocations
      *
     C           MAPTYP    WHEQ 'FR'
     C           KWCOOP    CHAINSECOFRL0             47
     C                     MOVE MERECI    WWRECI  1
     C                     MOVEL'SECOFRL0'WWFILE 10
      *
      ***  Processing type 'RG'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'RG'
     C           KWCOOP    CHAINSECORGL0             47
     C                     MOVE MFRECI    WWRECI  1
     C                     MOVEL'SECORGL0'WWFILE 10
      *
      ***  Processing type 'CR'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'CR'
     C           KWCOOP    CHAINSECOCRL0             47
     C                     MOVE MHRECI    WWRECI  1
     C                     MOVEL'SECOCRL0'WWFILE 10
      *
      ***  Processing type 'OF'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'OF'
     C           KWCOOP    CHAINSECOOFL0             47
     C                     MOVE MIRECI    WWRECI  1
     C                     MOVEL'SECOOFL0'WWFILE 10
      *                                                                   137881
      ***  Processing type 'EX'                                           137881
      ***  Access to CO                                                   137881
      *                                                                   137881
     C           MAPTYP    WHEQ 'EX'                                      137881
     C           KWCOOP    CHAINSECOEXL0             47                   137881
     C                     MOVE MJRECI    WWRECI  1                       137881
     C                     MOVEL'SECOEXL0'WWFILE 10                       137881
      *
      ***  Processing type 'NC'
      ***  Access to CO
      *
     C           MAPTYP    WHEQ 'NC'
     C           WKCOR2    CHAINSECONCL0             47
     C                     MOVE MLRECI    WWRECI  1
     C                     MOVEL'SECONCL0'WWFILE 10
      *                                                                   137881
      ***  Processing type 'CC'                                           137881
      ***  Access to CO Currency Change file                              137881
      *                                                                   137881
     C           MAPTYP    WHEQ 'CC'                                      137881
     C           WKCOR2    CHAINSECOCCL0             47                   137881
     C                     MOVE NARECI    WWRECI  1                       137881
     C                     MOVEL'SECOCCL0'WWFILE 10                       137881
     C                     ENDSL
      *
     C           *IN47     IFEQ *ON
     C           WWRECI    OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD2         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 02 *
     C                     MOVELWWFILE    DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C           MAPTYP    IFNE 'NC'                                      137881
     C           MAPTYP    ANDNE'CC'                                      137881
     C                     MOVELWWCOOP    DBKEY     P
     C                     ELSE                                           137881
     C                     MOVELWKCOR2    DBKEY     P                     137881
     C                     ENDIF                                          137881
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CUAVP -  Retrieve Current Average Price                     *
      *  ------                                                       *
      *  Called by : ##PRCB                                           *
      *  Calls     : *PSSR ZAVPR2                                     *
      *****************************************************************
      *
     C           #CUAVP    BEGSR
      *                                                                   137881
     C                     MOVE 'N'       WNOPOS  1                       137881
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'C' for customer
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  Retrieve the customer position record on LF/CPOSC
      *
     C                     MOVE MCBRCD    WCBRCD
     C                     MOVE MCCNUM    WCCNUM
     C                     MOVE MASESN    WCSESN
      *
     C           KWCOSC    CHAINCPOSC                48
      *
     C*****      *IN48     IFEQ *ON                                       137881
     C*****      RECI      OREQ '*'                                       137881
     C*****      *LOCK     IN   LDA                                       137881
     C*****                Z-ADD3         DBASE            ***************137881
     C*****                MOVEL*BLANKS   DBFILE           * DB ERROR 03 *137881
     C*****                MOVELWWFILE    DBFILE           ***************137881
     C*****                MOVELWWCOSC    DBKEY     P                     137881
     C*****                MOVEL'SE7590'  DBPGM     P                     137881
     C*****                OUT  LDA                                       137881
     C*****                EXSR *PSSR                                     137881
     C*****                ENDIF                                          137881
      *
     C                     Z-ADD*ZERO     WWPRIC 158
      *                                                                   137881
     C           *IN48     IFEQ *OFF                                      137881
     C           RECI      ANDEQ'D'                                       137881
      *
      ***  Check the "Trade/Value Date" indicator
      *
     C                     SELEC
      *
     C           MATDVD    WHEQ 'T'                        Trade Date
      *
      ***  Calculate average price using SR/ZAVPR2
      ***  SR/ZAVPR2 based on standard subroutine SR/ZAVPR
      *
     C           CSNT      IFNE *ZERO
     C                     Z-ADDCSNT      ZNOML            Nominal
     C                     Z-ADDCSPT      ZAPNC            Ap numerator
     C                     Z-ADDWONBDP    ZCDP             Nom. Ccy dec. places
     C                     Z-ADDWONMDP    NMDP             Nominal decimal places
     C                     EXSR ZAVPR2
     C                     Z-ADDZPRC      WWPRIC
     C                     ENDIF
      *
     C           MATDVD    WHEQ 'V'                        Value Date
      *
      ***  Calculate average price using SR/ZAVPR2
      ***  SR/ZAVPR2 based on standard subroutine SR/ZAVPR
      *
     C           CSNV      IFNE *ZERO
     C                     Z-ADDCSNV      ZNOML            Nominal
     C                     Z-ADDCSPV      ZAPNC            Ap numerator
     C                     Z-ADDWONBDP    ZCDP             Nom. Ccy dec. places
     C                     Z-ADDWONMDP    NMDP             Nominal decimal places
     C                     EXSR ZAVPR2
     C                     Z-ADDZPRC      WWPRIC
     C                     ENDIF
     C                     ENDSL
      *
      ***  If the average price is < 0, set average price to zero
      *
     C           WWPRIC    IFLT *ZERO
     C                     Z-ADD*ZERO     WWPRIC
     C                     ENDIF
      *                                                                   137881
     C                     ELSE                                           137881
      *                                                                   137881
     C           MCCNUM    IFEQ WWERCU                                    137881
      *                                                                   137881
     C                     MOVE 'Y'       WNOPOS                          137881
      *                                                                   137881
      ***  Special Processing for the DUMMY customer without position     137881
      *                                                                   137881
     C                     SELEC                                          137881
     C           MAPTYP    WHEQ 'DV'                                      137881
     C                     Z-ADDMDCOMP    WWPRIC                          137881
     C           MAPTYP    WHEQ 'EX'                                      137881
     C                     Z-ADDMJCOMP    WWPRIC                          137881
     C           MAPTYP    WHEQ 'FR'                                      137881
     C                     Z-ADDMECOMP    WWPRIC                          137881
     C           MAPTYP    WHEQ 'OF'                                      137881
     C                     Z-ADDMICOMP    WWPRIC                          137881
     C           MAPTYP    WHEQ 'RG'                                      137881
     C                     Z-ADDMFCOMP    WWPRIC                          137881
     C           MAPTYP    WHEQ 'CC'                                      137881
     C           NAMRKI    IFEQ 'Y'                                       137881
     C                     Z-ADDMKPR      WWPRIC                          137881
     C                     ELSE                                           137881
     C                     Z-ADDNACOMP    WWPRIC                          137881
     C                     ENDIF                                          137881
     C                     ENDSL                                          137881
      *                                                                   137881
     C                     ELSE                                           137881
     C                     Z-ADDMKPR      WWPRIC                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
      *
      ***  If Cust/Book indicator is 'B' for book
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Access to Book position Header to retrieve the Last Average Price
      *
     C                     MOVE MASESN    WKSESN
     C                     MOVE MCBRCD    WKBRCA
     C                     MOVE MCBOOK    WKBOOK
     C                     MOVE WOMKTI    WKMKTI
      *
     C           KWBKPH    SETGTBKPHD
     C           KWBKPH    REDPEBKPHD                    89
      *
     C           *IN89     IFEQ *OFF
     C                     Z-ADDLAVP      WWPRIC
     C                     ENDIF
      *
      ***  If the average price is < 0, set average price to zero
      *
     C           WWPRIC    IFLT *ZERO
     C                     Z-ADD*ZERO     WWPRIC
     C                     ENDIF
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CAAVP -  Retrieve Calculated average price (1) & (2)        *
      *  ------                                                       *
      *  Called by : #PRCB                                            *
      *  Calls     : Nothing                                          *
      *****************************************************************
      *
     C           #CAAVP    BEGSR
      *
     C                     MOVE 'Y'       WRKA    1        Working field
     C                     Z-ADD22        X       20       Working field
     C                     MOVEA*BLANKS   NSEC             Event Security (22 * 10A)
     C                     MOVEA*ZERO     NOMI             Ex-Date position (22 * 15,0N)
     C                     MOVEA*ZERO     MARK             Market value (22 * 15,0N)
     C                     CLEARSVRCD
     C                     MOVELNWRCD     SVRCD            Saved LF/SECOALL5 field
      *
      ***  Access to Stock Allocation with same Coporate Action Reference,
      ***  same branch, same depot, same customer/book indicator, same book
      ***  same customer and portfolio
      ***  (||| If cust/book is 'B', book must be filled and customer portfolio must be blanks
      ***  else if cust/book is 'C', book must be blanks and customer/portfolio filled |||)
      *
     C                     MOVE MCCORF    WKCORF
     C                     MOVE MCOPTN    WKOPTN
     C                     MOVE MCBRCD    WKBRCD
     C                     MOVE MCDDPT    WKDDPT
     C                     MOVE MCCOTP    WKCOTP
     C                     MOVE MCBOOK    WKBOOK
     C                     MOVE MCCNUM    WKCNUM
     C                     MOVE MCPTFR    WKPTFR
      *
     C           KWCOA3    SETLLSECOALL3
     C           KWCOA3    READESECOALL3                 48
      *
     C           *IN48     DOWEQ*OFF
      *
      ***  If working field is 'Y'
      *
     C           WRKA      IFEQ 'Y'
      *
      ***  Calculate consideration of event security = Ex-Date position * Average price
      *
     C                     MOVE *ZERO     WWTOTM 248       Total Market
     C                     Z-ADD*ZERO     WWCONE 238
     C           MCEXPO    MULT WWPRIC    WWCONE           Consideration of event sec.
      *
     C           MAPTYP    IFEQ 'CR'
     C           MHADRE    ANDEQ'A'                                       137881
     C           MAPTYP    OREQ 'CE'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'M'
     C           MAPTYP    OREQ 'RG'
     C           MFAVOP    ANDEQ'C'
     C           MAPTYP    OREQ 'RG'                                      161746
     C           MFAVOP    ANDEQ'I'                                       161746
     C           MAPTYP    OREQ 'NC'
      *
      ***  Calculate Market value of event security
      ***  = Ex-Date position (held on first record readm in fact it is same on all records)
      ***    multiplied by market ex-price
      *
     C                     Z-ADD*ZERO     WWMRKV 238
     C           MCEXPO    MULT MAEXPC    WWMRKV           Market Value
      *
      ***  Fill the 3 arrays at index X=22
      *
     C                     MOVE MASESN    NSEC,X           Event Security
     C                     Z-ADDMCEXPO    NOMI,X           Ex-Date position
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Setup to 'N' working field and setup X by 1
      *
     C                     Z-ADDWWMRKV    WWTOTM
     C                     ENDIF
     C                     Z-ADD1         X
     C                     MOVE 'N'       WRKA
     C                     ENDIF                           WRKA='Y'
      *
      ***  If new security is not '**CASH**'
      *
     C           MCSESN    IFNE '**CASH**'
      *
      ***  Calculate Market Value = actual stock allocation multiplied by market price
      *
     C                     Z-ADDMCASTA    WWMRKV
      *                                                                   137881
     C                     MOVE MCSESN    WKSESN    P                     137881
     C                     EXSR #SECTN                                    137881
      *                                                                   137881
     C           WNNMDP    IFEQ 1                                         137881
     C           WWMRKV    DIV  10        WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 2                                         137881
     C           WWMRKV    DIV  100       WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 3                                         137881
     C           WWMRKV    DIV  1000      WWMRKV                          137881
     C                     ELSE                                           137881
     C           WNNMDP    IFEQ 4                                         137881
     C           WWMRKV    DIV  10000     WWMRKV                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
      *
     C                     SELEC
      *
      ***  Retrieve the market price depends on processing type
      *
     C           MAPTYP    WHEQ 'CR'
     C                     Z-ADD1         Y       20
     C           MCSESN    LOKUPSECUR,Y                  89
     C           *IN89     IFEQ *ON
     C                     MULT NPR,Y     WWMRKV
     C                     ENDIF
      *
     C           MAPTYP    WHEQ 'CE'
     C                     MULT MAEXPC    WWMRKV
      *
     C           MAPTYP    WHEQ 'OF'
     C                     MULT MIMKTP    WWMRKV
      *
     C           MAPTYP    WHEQ 'RG'
     C                     MULT MFRIMP    WWMRKV
     C                     ENDSL
      *
      ***  Fill the 3 arrays at index X=22
      *
     C                     MOVE MCSESN    NSEC,X           Event Security
     C                     Z-ADDMCASTA    NOMI,X           Ex-Date position
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Increment X by 1
      *
     C                     ADD  WWMRKV    WWTOTM
     C                     ADD  1         X
     C                     ENDIF
      *
      ***  If new security is '**CASH**'
      *
     C           MCSESN    IFEQ '**CASH**'
      *
      ***  Calculate Market Value = actual cash allocation + actual cash rounding
      *
     C                     Z-ADDMCACAA    WWMRKV
     C                     ADD  MCACAR    WWMRKV
      *                                                                   137881
     C           WONBDP    IFEQ 1                                         137881
     C           WWMRKV    DIV  10        WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 2                                         137881
     C           WWMRKV    DIV  100       WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 3                                         137881
     C           WWMRKV    DIV  1000      WWMRKV                          137881
     C                     ELSE                                           137881
     C           WONBDP    IFEQ 4                                         137881
     C           WWMRKV    DIV  10000     WWMRKV                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
      *
      ***  Fill the 3 arrays at index X
      *
     C                     MOVE MCSESN    NSEC,X           Event Security
     C                     Z-ADDWWMRKV    NOMI,X           Market value converted
     C                     Z-ADDWWMRKV    MARK,X           Market Value
      *
      ***  Accumulate calculated market value into Total Market Value
      ***  Increment X by 1
      *
     C                     ADD  WWMRKV    WWTOTM
     C                     ADD  1         X
     C                     ENDIF
      *
      ***  Read next record with same CO Reference, same option, same branch,
      ***  same depot, customer/book ind 'C' or 'B', same book or cust./port.
      *
     C           KWCOA3    READESECOALL3                 48
     C                     ENDDO
      *
      ***  Setup X by 1
      ***  Do while X is lower than 23 and array containing the security
      ***  at index X is not blank
      *
     C                     Z-ADD1         X
     C           X         DOWLT23
     C           NSEC,X    ANDNE*BLANKS
      *
      ***  Calculate % of Total Market Value (WWPTOM)
      ***           MARK,X
      ***  = -------------------  X  100
      ***     Total Market Value
      *
     C*****                Z-ADD*ZERO     WWPTOM 118                      137881
     C                     Z-ADD*ZERO     WWPTOM 238                      137881
     C           WWTOTM    IFNE *ZERO
     C*****                Z-ADDMARK,X    WWK170 170                      137881
     C                     Z-ADDMARK,X    WWK238 238                      137881
     C*****                MULT 100       WWK170                          137881
     C*****      WWK170    DIV  WWTOTM    WWPTOM                          137881
     C           WWK238    DIV  WWTOTM    WWPTOM                          137881
     C           WWPTOM    MULT 100       WWPTOM                          137881
     C                     ENDIF
      *
      ***  Calculate Consideration (WWCONS)
      ***     % of Total Market Value  *  Consideration of event security
      *****=*------------------------------------------------------------ 137881
      *******                         NOMI,X                              137881
      *
     C*****                Z-ADD*ZERO     WWCONS 158                      137881
     C                     Z-ADD*ZERO     WWCONS 238                      137881
     C*****      NOMI,X    IFNE *ZERO                                     137881
     C                     Z-ADDWWPTOM    WWK238 238
     C                     MULT WWCONE    WWK238
     C*****      WWK238    DIV  NOMI,X    WWCONS                          137881
     C*****                ENDIF                                          137881
      *
      ***  If security is not '**CASH**'
      *
     C*****      MCSESN    IFNE '**CASH**'                                137881
     C           NSEC,X    IFNE '**CASH**'                                137881
      *
      ***  Calculate Average Price (2) (WWAVR2) and store result in the array average price
      ***     Consideration
      ***  = ---------------
      ***        NOMI,X
      *
     C                     Z-ADD*ZERO     WWAVR2 158
     C           NOMI,X    IFNE *ZERO
     C*****      WWCONS    DIV  NOMI,X    WWAVR2                          137881
     C           WWK238    DIV  NOMI,X    WWAVR2                          137881
     C                     ENDIF
     C           WWAVR2    DIV  100       WWAVR2                          137881
     C                     Z-ADDWWAVR2    AVPR,X
     C                     ENDIF                           Sec.<>'**CASH**'
      *
      ***  If security is '**CASH**'
      *
     C*****      MCSESN    IFEQ '**CASH**'                                137881
     C           NSEC,X    IFEQ '**CASH**'                                137881
      *
      ***  Calculate Realised Profit (WWREPT)
      ***  = NOMI,X  -  Consideration
      *
     C                     Z-ADD*ZERO     WWREPT 238
     C           WWK238    DIV  100       WWCONS                          137881
     C           NOMI,X    SUB  WWCONS    WWREPT
     C                     ENDIF                           Sec.='**CASH**'
      *
      ***  Increment X by 1
      *
     C                     ADD  1         X
     C                     ENDDO
      *
      ***  Calculate Average Price (1) (WWAVR1)
      ***     Consideration of event security  +  realised profit
      ***  = -----------------------------------------------------
      ***                       Ex-Date Position
      *
     C                     Z-ADD*ZERO     WWAVR1 158
     C           MCEXPO    IFNE *ZERO
     C                     Z-ADDWWCONE    WWK238 238
     C                     ADD  WWREPT    WWK238
     C           WWK238    DIV  MCEXPO    WWAVR1
     C                     ENDIF
      *
     C                     CLEARNWRCD
     C                     MOVELSVRCD     NWRCD            Saved LF/SECOALL5 field
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #CAPR - Processing for calculated price                      *
      *  -----                                                        *
      *  Called by : #PRFRO #PRFRR #PRCC                              *
      *  Calls     : ZCCYCN                                           *
      *****************************************************************
      *
     C           #CAPR     BEGSR
      *
      ***                     (Nominal old position X average price) +/- cash element
      ***  Calculated price = -------------------------------------------------------
      ***                                          New position
      *
     C                     Z-ADDMCEXPO    WWNMOP 150       Nominal old position
     C                     Z-ADDWWPRIC    WWAPOP 158       Average price old position
      *
      ***  Cash element is total cash (Actual cash allocation + Actual cash rounding)
      ***  CONVERTED FROM nominal currency of event security IN nominal ccy of new security
      *
     C*****                Z-ADD*ZERO     WWCASH 158                      137881
     C                     Z-ADD*ZERO     WWCASH 238                      137881
     C                     Z-ADD*ZERO     WWCAPR 158
     C                     Z-ADDMCACAA    WWACAA 150       Actual cash allocation
     C                     Z-ADDMCACAR    WWACAR 150       Actual cash rounding
     C                     Z-ADDMCASTA    WWNWPO 150       New Position
      *
     C           WWNWPO    IFNE *ZERO
     C           WWACAA    ADD  WWACAR    ZAMTF
      *
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     Z-ADDZAMTT     WWCASH
     C                     ENDIF                           ZAMFT<>*ZERO
      *
      ***  Multiply Nominal old position and Average price old position
      *
     C                     Z-ADD*ZERO     WWK238 238
     C           WWNMOP    MULT WWAPOP    WWK238
      *
      ***  If Sign is '+' add the cash element else substract the cash element
      *
     C           WWSIGN    IFEQ '+'
     C                     ADD  WWCASH    WWK238
     C                     ELSE
     C           WWK238    SUB  WWCASH    WWK238
     C                     ENDIF
      *
      ***  Divide the result by the new position
      *
     C           WWK238    DIV  WWNWPO    WWCAPR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************   137881
      /EJECT                                                              137881
      *****************************************************************   137881
      *  #CAPRC - Processing for calculated price                     *   137881
      *  ------   for processing type 'CC'                            *   137881
      *  Called by : #PRCC                                            *   137881
      *  Calls     : ZCCYCN                                           *   137881
      *****************************************************************   137881
      *                                                                   137881
     C           #CAPRC    BEGSR                                          137881
      *                                                                   137881
      ***                     (Nom. old pos. X Avr Pr.) +/- cash rounding 137881
      ***  Calculated price = ------------------------------------------- 137881
      ***                                          New position           137881
      *                                                                   137881
     C                     Z-ADD*ZERO     WWCASH 238       Pr. converted  137881
     C                     Z-ADD*ZERO     WWCAPR 158       Calc. price    137881
     C                     Z-ADDMCEXPO    WWNMOP 150       Nom. old pos   137881
     C                     Z-ADDWWPRIC    WWAPOP 158       Avr. pr old pos137881
     C                     Z-ADDMCACAA    WWACAA 150       Cash alloc.    137881
     C                     Z-ADDMCACAR    WWACAR 150       Cash rounding  137881
     C                     Z-ADDMCASTA    WWNWPO 150       New Position   137881
      *                                                                   137881
     C                     Z-ADD*ZEROS    DEC     10                      137881
     C           WNNMDP    ADD  5         DEC                             137881
     C           WWNMOP    MULT POWER9,DECZAMTF                           137881
      *                                                                   137881
     C                     Z-ADDZAMTF     WWCASH                          137881
      *                                                                   137881
      ***  Multiply Nominal old position and Average price old position   137881
      *                                                                   137881
     C           WWCASH    MULT WWAPOP    WWCASH                          137881
      *                                                                   137881
      ***  If Sign is '+' add the cash element else substract the cash ele137881
      *                                                                   137881
     C           WWSIGN    IFEQ '+'                                       137881
     C                     ADD  MCACAR    WWCASH                          137881
     C                     ELSE                                           137881
     C                     SUB  MCACAR    WWCASH                          137881
     C                     ENDIF                                          137881
      *                                                                   137881
     C           CEU002    IFEQ 'Y'                                       137881
     C           WOINCY    ANDEQ'Y'                                       137881
      *                                                                   137881
     C           WOEUMD    IFEQ 'M'                                       137881
     C           WWCASH    MULT WOEUER    WWCASH                          137881
     C                     ELSE                                           137881
     C           WWCASH    DIV  WOEUER    WWCASH                          137881
     C                     ENDIF                                          137881
      *                                                                   137881
     C                     ELSE                                           137881
     C                     MOVE WONMCY    ZCCYF                           137881
     C                     MOVE WOSPRT    ZRATEF                          137881
     C                     MOVE WOMDIN    ZMDINF                          137881
     C                     MOVE WONBDP    ZCDPF                           137881
     C                     MOVE WNNMCY    ZCCYT                           137881
     C                     MOVE WNSPRT    ZRATET                          137881
     C                     MOVE WNMDIN    ZMDINT                          137881
     C                     MOVE WNNBDP    ZCDPT                           137881
     C                     EXSR ZCCYCN                                    137881
     C                     Z-ADDZAMTT     WWCASH                          137881
     C                     ENDIF                                          137881
      *                                                                   137881
      ***  Divide the result by the new position                          137881
      *                                                                   137881
     C           WWCASH    DIV  WWNWPO    WWCAPR                          137881
      *                                                                   137881
     C                     ENDSR                                          137881
      *                                                                   137881
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRDV -  Generate Trades Event record                        *
      *  -----    for processing type 'DV'                            *
      *  Called by : #PRCB                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRDV     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      ***  Generate a Trade Purchase for the book
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual stock All.
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY           Nominal currency (New Sec.)
      *
      ***  If Market Price indicator is 'Y' use market price from PF/SECTYD
      ***  else use subscription price from PF/SECODVPD
      *
     C           MDMRKI    IFEQ 'Y'
     C                     Z-ADDWNMKPR    WWTPDY           Market Price
     C                     ELSE
     C           MDSBPR    IFNE *ZEROS                                    137881
     C                     Z-ADDMDSBPR    WWTPDY           Subscription Price
     C                     ELSE                                           137881
     C           MAEXPC    IFNE *ZEROS                                    137881
     C                     Z-ADDMAEXPC    WWTPDY           Mrkt Ex Price  137881
     C                     ELSE                                           137881
     C                     Z-ADDWNMKPR    WWTPDY           Market Price   137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF
      *
      ***  Setup Default fields for a new Trade Event
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      ***  Generate a Trade Purchase for the customer
      *
      ***  Setup specific field for this processing type
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual stock All.
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY           Nominal currency (New Sec.)
      *
      ***  If Market Price indicator is 'Y' use market price from PF/SECTYD
      ***  else use subscription price from PF/SECODVPD
      *
     C           MDMRKI    IFEQ 'Y'
     C                     Z-ADDWNMKPR    WWMKTP           Market Price
     C                     ELSE
     C           MDSBPR    IFNE *ZEROS                                    137881
     C                     Z-ADDMDSBPR    WWMKTP           Subscription Price
     C                     ELSE                                           137881
     C           MAEXPC    IFNE *ZEROS                                    137881
     C                     Z-ADDMAEXPC    WWMKTP           Mrkt Ex Price  137881
     C                     ELSE                                           137881
     C                     Z-ADDWNMKPR    WWMKTP           Market Price   137881
     C                     ENDIF                                          137881
     C                     ENDIF                                          137881
     C                     ENDIF
      *
      ***  Setup Default fields for a new Trade Event and a portfolio customer Trade Event
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFR -  Check processing for type 'FR'                      *
      *  -----                                                        *
      *  Called by : #PRCB                                            *
      *  Calls     : #PRFRR #PRFRO #PRFRA                             *
      *****************************************************************
      *
     C           #PRFR     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'FR' and New Security entered and Replace
      *
     C           MENSEC    WHNE MASESN
     C           MEADRE    ANDEQ'R'
     C                     EXSR #PRFRR
      *
      ***  Processing type 'FR' and Old Security entered and Replace
      *
     C           MENSEC    WHEQ MASESN
     C           MEADRE    ANDEQ'R'
     C                     EXSR #PRFRO
      *
      ***  Processing type 'FR' and Add
      *
     C           MEADRE    WHEQ 'A'
     C                     EXSR #PRFRA
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRR -  Generate Trade Event record                        *
      *  ------    for processing type 'FR' and New Security entered  *
      *            and Replace                                        *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #GNTRB #CAPR #GNTRC                       *
      *****************************************************************
      *
     C           #PRFRR    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWTPDY           Average Price
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the Customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWMKTP           Average Price
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the Customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRO -  Generate Trade Event record                        *
      *  ------    for processing type 'FR' and Old Security entered  *
      *            and Replace                                        *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #GNTRB #CAPR #GNTRC                       *
      *****************************************************************
      *
     C           #PRFRO    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWMKTP           Average Price
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
     C                     Z-ADDWWPRIC    WWMKTP           Average Price
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '-'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRFRA -  Generate Trades Event record                       *
      *  ------    for processing type 'FR' and Add                   *
      *  Called by : #PRFR                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRFRA    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C                     Z-ADD*ZERO     WWTPDY           Price=0
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD*ZERO     WWMKTP           Price=0
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCR -  Check processing for type 'CR'                      *
      *  -----                                                        *
      *  Called by : #PRCB                                            *
      *  Calls     : #PRCRR #PRCRA                                    *
      *****************************************************************
      *
     C           #PRCR     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'CR' and Replace
      *
     C*****      MEADRE    WHEQ 'R'                                       137881
     C           MHADRE    WHEQ 'R'                                       137881
     C                     EXSR #PRCRR
      *
      ***  Processing type 'CR' and Add
      *
     C*****      MEADRE    WHEQ 'A'                                       137881
     C           MHADRE    WHEQ 'A'                                       137881
     C                     EXSR #PRCRA
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCRR -  Generate Trades Event record                       *
      *  ------    for processing type 'CR' and Replace               *
      *  Called by : #PRCR                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRCRR    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCRA -  Generate Trades Event Record                       *
      *  ------    for processing type 'CR' and Add                   *
      *  Called by : #PRCR                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRCRA    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual sotck allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
      *
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
      *
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************   CEU017
      /EJECT                                                              CEU017
      *****************************************************************   CEU017
      *  #PRCC  -  Generate Trades Event record                       *   CEU017
      *  ------    for processing type 'CC'                           *   CEU017
      *  Called by : #PRCB                                            *   CEU017
      *  Calls     : #SECTN #GNTRB #CAPR #GNTRC                       *   CEU017
      *****************************************************************   CEU017
      *                                                                   CEU017
     C           #PRCC     BEGSR                                          CEU017
      *                                                                   CEU017
      ***  Check Cust/Book indicator                                      CEU017
      *                                                                   CEU017
     C                     SELEC                                          CEU017
      *                                                                   CEU017
      ***  If Cust/Book indicator is 'B'                                  CEU017
      *                                                                   CEU017
     C           MCCOTP    WHEQ 'B'                                       CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Sale for the book (old position)              CEU017
      *                                                                   CEU017
     C                     MOVELMASESN    WWSESN    P      old security   CEU017
     C                     MOVELMASESN    WKSESN    P                     CEU017
     C                     MOVE 'TS'      WWTDTP           Sale           CEU017
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date positioCEU017
     C                     Z-ADDWWPRIC    WWTPDY           Current AverageCEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WONMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields for a new Trade                           CEU017
      *                                                                   CEU017
     C                     EXSR #GNTRB                                    CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Purchase for the book (old position)          CEU017
      *                                                                   CEU017
     C                     MOVELMCSESN    WWSESN    P      new security   CEU017
     C                     MOVELMCSESN    WKSESN    P                     CEU017
     C                     MOVE 'TP'      WWTDTP           Purchase       CEU017
     C                     Z-ADDMCASTA    WWNOML           actual stock   CEU017
     C                     MOVE '-'       WWSIGN  1        Sign           CEU017
     C*****                EXSR #CAPR                              CEU017 137881
     C                     EXSR #CAPRC                                    137881
     C                     Z-ADDWWCAPR    WWTPDY           calculated pricCEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WNNMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields for a new Trade                           CEU017
      *                                                                   CEU017
     C                     EXSR #GNTRB                                    CEU017
      *                                                                   CEU017
     C           MCCOTP    WHEQ 'C'                                       CEU017
      *                                                                   CEU017
      ***  If Cust/Book indicator is 'C'                                  CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Sale for the customer (old position)          CEU017
      *                                                                   CEU017
     C                     MOVELMASESN    WWSESN    P      old security   CEU017
     C                     MOVELMASESN    WKSESN    P                     CEU017
     C                     MOVE 'TS'      WWTDTP           movement type  CEU017
     C                     Z-ADDMCEXPO    WWNOML           ex-date positioCEU017
     C                     Z-ADDWWPRIC    WWMKTP           Current AverageCEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WONMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields                                           CEU017
      ***  And generate a new Trade                                       CEU017
      *                                                                   CEU017
     C                     EXSR #GNTRC                                    CEU017
      *                                                                   CEU017
      ***  Setup specific field for this processing type                  CEU017
      ***  Generate a Trade Purchase for the customer (old position)      CEU017
      *                                                                   CEU017
     C                     MOVELMCSESN    WWSESN    P      new security   CEU017
     C                     MOVELMCSESN    WKSESN    P                     CEU017
     C                     MOVE 'TP'      WWTDTP           movement type  CEU017
     C                     Z-ADDMCASTA    WWNOML           actual stock alCEU017
     C                     MOVE '-'       WWSIGN  1        Sign           CEU017
     C*****                EXSR #CAPR                              CEU017 137881
     C                     EXSR #CAPRC                                    137881
     C                     Z-ADDWWCAPR    WWMKTP           calculated pricCEU017
      *                                                                   CEU017
      ***  Access to Security Details                                     CEU017
      *                                                                   CEU017
     C                     EXSR #SECTN                                    CEU017
      *                                                                   CEU017
     C                     MOVE WNNMCY    WWNMCY                          CEU017
      *                                                                   CEU017
      ***  Setup Default fields                                           CEU017
      ***  And generate a new Trade                                       CEU017
      *                                                                   CEU017
     C                     EXSR #GNTRC                                    CEU017
     C                     ENDSL                           Check cust/bookCEU017
      *                                                                   CEU017
     C                     ENDSR                                          CEU017
      *                                                                   CEU017
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRCE -  Generate Trades Event record                        *
      *  -----    for processing type 'CE'                            *
      *           (Same as processing type 'CR' and Add               *
      *  Called by : #PRCB                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRCE     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROF -  Check processing for type 'OF'                      *
      *  -----                                                        *
      *  Called by : #PRCB                                            *
      *  Calls     : #PROFE #PROFP                                    *
      *****************************************************************
      *
     C           #PROF     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'OF' and Offer type 'E'
      *
     C           MIOFTY    WHEQ 'E'
     C                     EXSR #PROFE
      *
      ***  Processing type 'OF' and Purchase Offers
      ***  or Processing type 'OF' and Subscriptions
      *
     C           MIOFTY    WHEQ 'P'
     C           MIOFTY    OREQ 'S'
     C                     EXSR #PROFP
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROFE -  Generate Trades Event Record                       *
      *  ------    for processing type 'OF' and Exchange Offers       *
      *  Called by : #PROF                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PROFE    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCHOST    WWNOML           Holding Taken as stock
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     Z-ADDAVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PROFP -  Generate Trades Event record                       *
      *  ------    for processing type 'OF' and Purchase Offers       *
      *         or for processing type 'OF' and Subscriptions         *
      *  Called by : #PROF                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PROFP    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
      *
     C           MIOFTY    IFEQ 'P'
     C           MCEXPO    IFGT *ZERO
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     ELSE
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     ENDIF
     C                     ELSE
     C           MCEXPO    IFGT *ZERO
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     ELSE
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     ENDIF
     C                     ENDIF
      *
     C           MIOFTY    IFEQ 'P'
     C                     Z-ADDMIREPR    WWTPDY           Receive price
     C                     ELSE
     C                     Z-ADDMISUPR    WWTPDY           Subscription price
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
      *
     C           MIOFTY    IFEQ 'P'
     C           MCEXPO    IFLT *ZERO
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     ELSE
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     ENDIF
     C                     ELSE
     C           MCEXPO    IFLT *ZERO
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     ELSE
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     ENDIF
     C                     ENDIF
      *
     C           MIOFTY    IFEQ 'P'
     C                     Z-ADDMIREPR    WWMKTP           Receive price
     C                     ELSE
     C                     Z-ADDMISUPR    WWMKTP           Subscription price
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PREX -   Generate Trades Event Record                       *
      *  -----     for processing type 'EX'                           *
      *            (Same as processing type 'CR' and Replace)         *
      *  Called by : #PRCB                                            *
      *  Calls     : #SECTN #GNTRB #CAPR #GNTRC                       *
      *****************************************************************
      *
     C           #PREX     BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWPRIC    WWTPDY           Average price for the book
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
     C                     MOVE '+'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWTPDY           calculated price
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P      old security
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWPRIC    WWMKTP           Average Price for customer
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     MOVE '+'       WWSIGN  1        Sign
     C                     EXSR #CAPR
     C                     Z-ADDWWCAPR    WWMKTP           calculated price
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRG -  Check processing for type 'RG'                      *
      *  -----                                                        *
      *  Called by : #PRCB                                            *
      *  Calls     : #PRRGZ #PRRGM #PRRGC                             *
      *****************************************************************
      *
     C           #PRRG     BEGSR
      *
     C                     SELEC
      *
      ***  Processing type 'RG' and "Average Price Option" is 'Z' (zero average price)
      *
     C           MFAVOP    WHEQ 'Z'
     C                     EXSR #PRRGZ
      *
      ***  Processing type 'RG' and "Average Price Option" is 'M' (market price)
      *
     C           MFAVOP    WHEQ 'M'
     C                     EXSR #PRRGM
      *
      ***  Processing type 'RG' and "Average Price Option" is 'C' (calculated)
      *                                                    OR 'I' (calculated)     161746
      *
     C           MFAVOP    WHEQ 'C'
     C           MFAVOP    OREQ 'I'                                                161746
     C                     EXSR #PRRGC
      *
     C                     ENDSL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGZ -  Generate Trades Event Record                       *
      *  ------    for processing type 'RG' and zero average price    *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRRGZ    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock Allocation
     C                     Z-ADD*ZERO     WWTPDY           Price=0
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD*ZERO     WWMKTP           Price=0
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGM -  Generate Trades Event Record                       *
      *  ------    for processing type 'RG' and market price          *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #GNTRB ZCCYN #GNTRC                       *
      *****************************************************************
      *
     C           #PRRGM    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWPRIC    WWTPDY           Average price for the book
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD*ZERO     WWTPDY
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***           (Consider. event sec.  -  consider. new sec.  -  actual cash rounding)
      ***  Price =  ----------------------------------------------------------------------
      ***                                   Old Position
      ***
      ***  Consideration event security = Ex-Date Position  *  Current Average Price
      ***  Consideration new security = Ex-Date Position  *  Right Market Price
      ***  Actual Cash Rounding = Converted from nominal ccy of event sec. to nominal ccy of new sec
      ***  Old Position = Ex-Date Position
      ***
     C           MCEXPO    IFNE *ZERO
      *
     C                     Z-ADDMCEXPO    WWKCOE 150
     C                     MULT WWPRIC    WWKCOE           Cons. event Sec.
      *
     C                     Z-ADDMCEXPO    WWKCON 150
     C                     MULT MFRIMP    WWKCON           Cons. new Sec.
      *
     C                     Z-ADDWWKCOE    WWK150 150
     C                     SUB  WWKCON    WWK150
      *
     C                     Z-ADDMCACAA    ZAMTF
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     SUB  ZAMTT     WWK150           Actual cash rounding
     C                     ENDIF
      *
     C           WWK150    DIV  MCEXPO    WWTPDY           Calculated Price
     C                     ENDIF
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual Stock allocation
     C                     Z-ADDMFRIMP    WWTPDY           Rights Market Price
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWPRIC    WWMKTP           Average price for the customer
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADD*ZERO     WWMKTP
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***           (Consider. event sec.  -  consider. new sec.  -  actual cash rounding)
      ***  Price =  ----------------------------------------------------------------------
      ***                                   Old Position
      *
      ***  Consideration event security = Ex-Date Position  *  Current Average Price
      ***  Consideration new security = Ex-Date Position  *  Right Market Price
      ***  Actual Cash Rounding = Converted from nominal ccy of event sec. to nominal ccy of new sec
      ***  Old Position = Ex-Date Position
      *
     C           MCEXPO    IFNE *ZERO
      *
     C                     Z-ADDMCEXPO    WWKCOE 150
     C                     MULT WWPRIC    WWKCOE           Cons. event Sec.
      *
     C                     Z-ADDMCEXPO    WWKCON 150
     C                     MULT MFRIMP    WWKCON           Cons. new Sec.
      *
     C                     Z-ADDWWKCOE    WWK150 150
     C                     SUB  WWKCON    WWK150
      *
     C                     Z-ADDMCACAA    ZAMTF
     C           ZAMTF     IFNE *ZERO
     C                     MOVE WONMCY    ZCCYF
     C                     MOVE WOSPRT    ZRATEF
     C                     MOVE WOMDIN    ZMDINF
     C                     MOVE WONBDP    ZCDPF
     C                     MOVE WNNMCY    ZCCYT
     C                     MOVE WNSPRT    ZRATET
     C                     MOVE WNMDIN    ZMDINT
     C                     MOVE WNNBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     SUB  ZAMTT     WWK150           Actual cash rounding
     C                     ENDIF
      *
     C           WWK150    DIV  MCEXPO    WWMKTP
     C                     ENDIF
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADDMFRIMP    WWMKTP           Rights Market Price
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRRGC -  Generate Trades Event Record                       *
      *  ------    for processing type 'RG' and calculated price      *
      *  Called by : #PRRG                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRRGC    BEGSR
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     MULT AVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           Actual sotck allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     MULT AVPR,Y    WWTPDY           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWTPDY
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      Event security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     MULT AVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (new position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADD1         Y       20
     C           WWSESN    LOKUPNSEC,Y                   89
     C           *IN89     IFEQ *ON
     C                     MULT AVPR,Y    WWMKTP           Average price (2)
     C                     ELSE
     C                     Z-ADD*ZERO     WWMKTP
     C                     ENDIF
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #PRNC  -  Generate Trades Event Record                       *
      *  -----     for processing type 'NC'                           *
      *  Called by : #PRCB                                            *
      *  Calls     : #SECTN #GNTRB #GNTRC                             *
      *****************************************************************
      *
     C           #PRNC     BEGSR
      *
      ***  If the Security Shortname has been changed
      *
     C           MLSESN    IFNE *BLANKS
      *
      ***  Check Cust/Book indicator
      *
     C                     SELEC
      *
      ***  If Cust/Book indicator is 'B'
      *
     C           MCCOTP    WHEQ 'B'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the book (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           Sale
     C                     Z-ADDMCEXPO    WWNOML           Ex-Date position
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the book (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P      new security
     C                     MOVE 'TP'      WWTDTP           Purchase
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADDWWAVR1    WWTPDY           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields for a new Trade
      *
     C                     EXSR #GNTRB
      *
     C           MCCOTP    WHEQ 'C'
      *
      ***  If Cust/Book indicator is 'C'
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Sale for the customer (old position)
      *
     C                     MOVELMASESN    WWSESN    P      old security
     C                     MOVELMASESN    WKSESN    P
     C                     MOVE 'TS'      WWTDTP           movement type
     C                     Z-ADDMCEXPO    WWNOML           ex-date position
     C                     Z-ADDWWAVR1    WWMKTP           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WONMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
      *
      ***  Setup specific field for this processing type
      ***  Generate a Trade Purchase for the customer (old position)
      *
     C                     MOVELMCSESN    WWSESN    P      new security
     C                     MOVELMCSESN    WKSESN    P
     C                     MOVE 'TP'      WWTDTP           movement type
     C                     Z-ADDMCASTA    WWNOML           actual stock allocation
     C                     Z-ADDWWAVR1    WWMKTP           Average Price (1)
      *
      ***  Access to Security Details
      *
     C                     EXSR #SECTN
      *
     C                     MOVE WNNMCY    WWNMCY
      *
      ***  Setup Default fields
      ***  And generate a new Trade
      *
     C                     EXSR #GNTRC
     C                     ENDSL                           Check cust/book ind.
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #GNTRB - Write a Trade Event Record for book Record          *
      *  ------                                                       *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCC   *
      *              #PRCE #PROFE #PROFP #PREX #PRRGZ #PRRGM #PRRGC   *
      *              #PRNC                                            *
      *  Calls     : ZAPNUM ZNCD ZPCINT *PSSR ZCOTR ZCCYCN #ACOAT     *
      *              #AOSEC #AOPRF #AOCUS #AOBRC                      *
      *****************************************************************
      *
     C           #GNTRB    BEGSR
      *
     C                     CLEARTREVEDF
      *
      ** .. Trade Reference
     C                     MOVE MACORF    TRTR
      ** .. Security Shortname
     C                     MOVELWWSESN    TRSS      P
      ** .. Trade Type
     C                     MOVE WWTDTP    TRTT
      *
     C           TRTT      IFEQ 'TP'
      ** .. I/O Indicator
     C                     MOVE 'O'       TRIO             I/O INDICATOR
      ** .. Event Code
     C                     MOVE '31P1'    TREC             EVENT CODE
     C                     ELSE
      ** .. I/O Indicator
     C                     MOVE 'I'       TRIO             I/O INDICATOR
      ** .. Event Code
     C                     MOVE '31S1'    TREC             EVENT CODE
     C                     ENDIF
      *
      ** .. Value Date
     C                     Z-ADDMAALEF    TRVD
      ** .. Our Deport
     C**********           Z-ADDMCDDPT    TROD                                                CSD027
     C                     MOVE MCDDPT    TROD                                                CSD027
      ** .. Nominal Currency
     C                     MOVE WWNMCY    TRNC
      ** .. Nominal/Outst nominal
     C                     Z-ADDWWNOML    TRON
      ** .. C/Value - Nominal Currency
     C                     Z-ADD*ZEROS    TRVN
      *
      ***  C/value - nom ccy = consideration +/- purchase interest +/- reallowance
      ***                      +/- charges +/- commissions
      *
      ***  Consideration = Nominal Ccy * price (see generation by processing type)
      ***                                      (use SR/ZAPNUM)
      *
     C           WONMCY    IFEQ WWNMCY
     C                     Z-ADDWONMDP    ZNMDP
     C                     Z-ADDWONBDP    ZNMCD
     C                     MOVE WOSPBS    ZPRCB
     C                     ELSE
     C                     Z-ADDWNNMDP    ZNMDP
     C                     Z-ADDWNNBDP    ZNMCD
     C                     MOVE WNSPBS    ZPRCB
     C                     ENDIF
      *
     C                     Z-ADDWWNOML    ZNOML
     C                     Z-ADDWWTPDY    ZAVPR
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     ZCONS  150       Consideration
      *
      ***  Interest Amount
      *
     C                     EXSR ZNCD
     C                     MOVE 'C'       WWACIN           Default
     C           TRVD      IFEQ NCD
     C                     MOVE 'F'       WWACIN
     C                     ELSE
     C           WWNMCY    IFEQ WONMCY
     C                     MOVELWOEDFT    ZNRDYS  20
     C                     ELSE
     C                     MOVELWNEDFT    ZNRDYS
     C                     ENDIF
     C           ZNRDYS    IFNE *ZEROS
     C           TRVD      IFLT NCD
     C           TRVD      ANDGEZDYNBR
     C                     MOVE 'X'       WWACIN
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Setup default field for SR/ZPCINT
      *
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWONMDP    WWTNMD
     C                     Z-ADDWOCPNR    TDCR
     C                     Z-ADDWOIADJ    IADJ
     C                     MOVE WOPPDI    PPDI
     C                     Z-ADDWOSFPP    SFPP
     C                     Z-ADDWOITLD    ITLD
     C                     Z-ADDWOCPNR    CPNR
     C                     Z-ADDWOCFCT    CFCT
     C                     Z-ADDWOCPDP    CPDP
     C                     ELSE
     C                     Z-ADDWNNMDP    WWTNMD
     C                     Z-ADDWNCPNR    TDCR   117
     C                     Z-ADDWNIADJ    IADJ
     C                     MOVE WNPPDI    PPDI
     C                     Z-ADDWNSFPP    SFPP
     C                     Z-ADDWNITLD    ITLD
     C                     Z-ADDWNCPNR    CPNR
     C                     Z-ADDWNCFCT    CFCT
     C                     Z-ADDWNCPDP    CPDP
     C                     ENDIF
      *
     C           DYBS      IFNE ' '
     C           DVBS      ANDNE' '
     C                     MOVE WWSESN    SESN
     C                     MOVE WWNOML    NOML   110
     C                     MOVE WWACIN    ZACIN
     C                     Z-ADD0         ZDADJ
     C                     MOVE *BLANKS   ZADIN
     C                     MOVE 'N'       ZCPOVR
     C                     Z-ADDWWTNMD    ZCDP
     C                     EXSR ZPCINT
     C                     Z-ADDZITRA     ITRA   130       Purchase Interest
     C                     ELSE
     C                     Z-ADD*ZEROS    ITRA
     C                     ENDIF
      *
      ***  Setup default field for SR/ZCOTR
      *
     C                     Z-ADD0         ZWRALL           Reallowance
      *
      ***  Charges and commisions are equal to zero
      *
     C                     Z-ADD0         TCA1   130
     C                     Z-ADD0         TCA2   130
     C                     Z-ADD0         TCA3   130
     C                     Z-ADD0         TCA4   130
     C                     Z-ADD0         TCA5   130
     C                     Z-ADD0         TCA6   130
     C                     Z-ADD0         TCA7   130
     C                     Z-ADD0         TAXA   130
     C                     Z-ADD0         TBCA   130
     C                     Z-ADD0         TCCA   130
      *
     C                     MOVE WWNMCY    NMCY
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOSPBS    SPBS
     C                     Z-ADDWONMDP    NMDP
     C                     Z-ADDWOCFCT    CFCT
     C                     Z-ADDWONMDP    ZCDP
     C                     MOVE WOSITP    WKSITP
     C                     ELSE
     C                     MOVE WNSPBS    SPBS
     C                     Z-ADDWNNMDP    NMDP
     C                     Z-ADDWNCFCT    CFCT
     C                     Z-ADDWNNMDP    ZCDP
     C                     MOVE WNSITP    WKSITP
     C                     ENDIF
      *
     C                     MOVE WWNMCY    WKNMCY
      *
      ***  Retrieve the processing type
      *
     C           KWINV     CHAININVTP                89
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD4         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 04 *
     C                     MOVE 'INVTP   'DBFILE           ***************
     C                     MOVELWWINV     DBKEY     P
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADD0         ZWRALL
     C                     Z-ADDWWNOML    NOML
     C                     Z-ADDWWTPDY    PRIC   158
     C                     EXSR ZCOTR
     C                     Z-ADDZCTRVL    TRVN
      *
      ** .. Settlement Currency
     C                     MOVE WONMCY    TRSC
      ** .. C/Value - Settlement Currency
     C                     Z-ADD*ZEROS    TRVS
     C                     Z-ADDTRVN      ZAMTF
     C           WONMCY    IFNE WWNMCY
     C           ZAMTF     ANDNE*ZEROS
     C                     MOVE WNNMCY    ZCCYF
     C                     MOVE WNSPRT    ZRATEF
     C                     MOVE WNMDIN    ZMDINF
     C                     MOVE WNNBDP    ZCDPF
     C                     MOVE WONMCY    ZCCYT
     C                     MOVE WOSPRT    ZRATET
     C                     MOVE WOMDIN    ZMDINT
     C                     MOVE WONBDP    ZCDPT
     C                     EXSR ZCCYCN
     C                     Z-ADDZAMTT     TRVS
     C                     ELSE
     C                     Z-ADDTRVN      TRVS
     C                     ENDIF
      ** .. Overdue indicator
      *
      ***  If Value date is lower or equal to Event Control Date than Setup 'Y' to Overdue
      *
     C           TRVD      IFLE WWECD
     C                     MOVE 'Y'       TROI
     C                     ELSE
     C                     MOVE *BLANKS   TROI
     C                     ENDIF
      ** .. Portfolio Indicator
     C                     MOVE 'N'       TRPI
      ** .. Counterparty
     C                     MOVELBVCOTC    TRPT
      ** .. Ex coupon/dividend
     C                     EXSR ZNCD
     C                     MOVE 'C'       TRED             Default
      *
     C           TRVD      IFEQ NCD
     C                     MOVE 'F'       TRED
     C                     ELSE
     C           WWNMCY    IFEQ WONMCY
     C                     MOVELWOEDFT    ZNRDYS  20
     C                     ELSE
     C                     MOVELWNEDFT    ZNRDYS
     C                     ENDIF
      *
     C           ZNRDYS    IFNE *ZEROS
     C           TRVD      IFLT NCD
     C           TRVD      ANDGEZDYNBR
     C                     MOVE 'X'       TRED
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** .. Branch
     C                     MOVE MCBRCD    TRBA
      ** .. Book
     C                     MOVE MCBOOK    TRBK
      ** .. Market Indicator
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOMKTI    TRMK
     C                     ELSE
     C                     MOVE WNMKTI    TRMK
     C                     ENDIF
      ** .. Trade Sub-Type
      *
      ***  Access to Corporate Action Type Details to retrieve CO Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      *
     C           MMTSUB    IFNE *BLANKS
     C                     MOVE MMTSUB    TRTS
     C                     ELSE
      *
      ***  Retrieve the classification from PF/SDSECDPD
      *
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOSEC
      *
     C           BFCLAS    IFEQ 'M'
      *
      ***  Retrieve the Default Maket Subtype
      *
     C                     MOVE BVDMKS    TRTS
     C                     ELSE
      *
      ***  Retrieve the Default Portfolio Subtype
      *
     C                     MOVE BVDPFS    TRTS
     C                     ENDIF
     C                     ENDIF
      ** .. Profit Center
      *
     C                     MOVE *BLANKS   PRFC
      *
      ***   If Profit Centre used
      ***   and Analytical Accounting Module is off
      *
     C           BKPRCU    IFEQ 'Y'
     C           BGN0ST    ANDNE'Y'
      *
      ***  If Book position/profit centres are to be reconciled
      *
     C           BVTBRC    IFEQ 'Y'
      *
      ***  Default from current book position profit centre record
      *
     C                     MOVELTRBK      WKTDBK
     C                     MOVELTRBA      WKBRCA
     C                     MOVELTRSS      WKSESN    P
     C                     MOVELTRMK      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
     C                     MOVE WOSESN    WKSESN    P
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
      *
      ***  Else default from matrix and allow amendment
      *
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TRBK      @BOOK
     C                     MOVELTRTT      @TRTP     P
     C                     MOVE TRTS      @SUTP
     C                     MOVE TRBA      @BRAN
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Book position/profit centres are NOT to be reconciled
      *
     C           BVTBRC    IFEQ 'N'
      *
      ***  Customer Position Profit Centre defaulting
      *
      *
      ***  Default from current customer position profit centre
      *
     C********** TRPT      IFNE *ZEROS                                                        CSD027
     C           TRPT      IFNE *BLANKS                                                       CSD027
     C                     MOVELTRPT      WKDPBN           Customer
     C                     MOVELTRBA      WKBRCA           Branch
     C                     MOVELTRSS      WKDPSS    P      Security
      *
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C                     MOVELWOSESN    WKDPSS           Event Security
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TRBK      @BOOK
     C                     MOVELTRTT      @TRTP     P
     C                     MOVE TRTS      @SUTP
     C                     MOVE TRBA      @BRAN
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *                                                                   CAC005
      ** If CAC005 is on, retrieve profit centre from AOBKPCR0            CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM MCBOOK    PMPSBK  2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVE PMPRFC    PRFC                            CAC005
     C                     ELSE                                           CAC005
     C                     MOVEL*BLANKS   PRFC                            CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      ***  Access to Customer details to retrieve the report name and Town
      *
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOCUS
      ** .. C/Party report name
     C                     MOVE BBCRNM    TRCN
      ** .. C/Party report town
     C                     MOVE BBCRTN    TRTN
      ** .. Settlement method
     C                     Z-ADD5         TRSM
      ** .. Settlement account
     C                     MOVE BVCOTC    WWCUST
     C                     MOVE MMACOD    WWSTAC           Settl. Account Code
     C                     MOVE '01'      WWSTSQ           Settl. Account Seq.
     C                     MOVE WWPAAC    TRSA
      ** .. Settlement Branch
     C                     MOVE MCBRCD    TRTA
      ** .. Clearance Type
     C                     MOVE '5'       TRCR
      *
     C           TRTT      IFEQ 'TP'
     C                     MOVELMSDDPT    WCUST            Deliver to
     C                     EXSR #AOSEC
      *
     C                     SELEC
     C           BFCLAS    WHEQ 'E'                        Deliver to Euroclear
     C                     MOVE '2'       TRCR
     C           BFCLAS    WHEQ 'C'                        Deliver to Cedel
     C                     MOVE '2'       TRCR
     C                     ENDSL
     C                     ELSE
      *
     C                     MOVELMSDDPT    WCUST            Deliver from
     C                     EXSR #AOSEC
      *
     C                     SELEC
     C           BFCLAS    WHEQ 'E'                        Deliver from Euroclear
     C                     MOVE '2'       TRCR
     C           BFCLAS    WHEQ 'C'                        Deliver from Cedel
     C                     MOVE '2'       TRCR
     C                     ENDSL
     C                     ENDIF
      ** ..  Portfolio Reference
     C                     MOVE MCPTFR    PTFR
      ** ..  due to Early Redemption
     C                     MOVE 'N'       EARL
      ** ..  Originating branch
     C                     MOVE MCBRCD    ORBR
      *
      ***  Access to Branch detail to retrieve the book, orig. branch
      ***  and event branch
      *
     C                     EXSR #AOBRC
      ** .. Company of Booking Branch
     C                     MOVE A8CMCD    COBB
      ** .. Company of Originating Branch
     C                     MOVE A8CMCD    COOB
      ** .. Company of event branch
     C                     MOVE A8CMCD    ECPY
      ** ..Entity code
     C                     MOVE *BLANKS   EXEI
      ** .. Branch entity level
     C                     MOVE 'B'       ELVB
      ** .. Company entity level
     C                     MOVE 'C'       ELVC
      ** .. System entity level
     C                     MOVE 'S'       ELVS
      ** .. Event branch code
     C                     MOVE TRTA      EBRC
      ** .. Multibranching event
     C                     MOVE 'N'       IBRE
      ** .. Intercompany event flag
     C                     MOVE 'Y'       ICYE
      ** .. Our Settlement Branch
     C                     MOVE *BLANKS   OSBR
      ** .. Corporate Action Flag
     C                     MOVE 'Y'       COAF
      ** .. Record ID
     C                     MOVE 'D'       TRRI
      *                                                                   141303
     C********** CEU011    IFEQ 'Y'                                                    141303 241795
     C                     Z-ADD1         A                               141303
     C           TRNC      LOKUPCUR,A                    89               141303
      *                                                                   141303
     C           *IN89     IFEQ *ON                                       141303
     C                     Z-ADDSRT,A     ECSS                            141303
     C                     ELSE                                           141303
      *                                                                   141303
     C           *LOCK     IN   LDA                                       141303
     C                     Z-ADD17        DBASE            ***************141303
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 17 *141303
     C                     MOVE 'SDCURRPD'DBFILE           ***************141303
     C                     MOVELTRNC      DBKEY                           141303
     C                     MOVEL'SE7590'  DBPGM     P                     141303
     C                     OUT  LDA                                       141303
     C                     EXSR *PSSR                                     141303
     C                     ENDIF                                          141303
     C**********           ENDIF                                                       141303 241795
      *
      ***  Write a trade event record for book record
      *
     C                     WRITETREVEDF
     C                     ADD  1         OUTRTR
     C                     ADD  TRON      WTOTTR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #GNTRC - Write a Trade Event Record for customer record      *
      *  ------   and write portfolio customer trade event record     *
      *           for customer record                                 *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCC   *
      *              #PRCE #PROFE #PROFP #PREX #PRRGZ #PRRGM #PRRGC   *
      *              #PRNC                                            *
      *  Calls     : ZAPNUM #ACOAT #AOSEC #AOPRF #AOCUS #AOBRC        *
      *****************************************************************
      *
     C           #GNTRC    BEGSR
      *
     C                     CLEARTREVEDF
     C                     CLEARPCTEVDF
      *
      ** .. Trade Reference
     C                     MOVE MACORF    TRTR
      ** .. Security Shortname
     C                     MOVELWWSESN    TRSS      P
      ** .. Trade Type
     C                     MOVE WWTDTP    TRTT
      *
     C           TRTT      IFEQ 'TP'
      ** .. I/O Indicator
     C                     MOVE 'O'       TRIO
     C                     ELSE
      ** .. I/O Indicator
     C                     MOVE 'I'       TRIO
     C                     ENDIF
      *
      ** .. Event Code
     C                     MOVE *BLANKS   TREC
      ** .. Value Date
     C                     Z-ADDMAALEF    TRVD
      ** .. Our Deport
     C**********           Z-ADDMCDDPT    TROD                                                CSD027
     C                     MOVE MCDDPT    TROD                                                CSD027
      ** .. Nominal Currency
     C                     MOVE WWNMCY    TRNC
      ** .. Nominal/Outst nominal
     C                     Z-ADDWWNOML    TRON
      ** .. C/Value - Nominal Currency
     C                     Z-ADD*ZEROS    TRVN
      *
     C           WWNMCY    IFEQ WONMCY
     C                     Z-ADDWONMDP    ZNMDP
     C                     Z-ADDWONBDP    ZNMCD
     C                     MOVE WOSPBS    ZPRCB
     C                     ELSE
     C                     Z-ADDWNNMDP    ZNMDP
     C                     Z-ADDWNNBDP    ZNMCD
     C                     MOVE WNSPBS    ZPRCB
     C                     ENDIF
      *
     C                     Z-ADDTRON      ZNOML
     C                     Z-ADDWWMKTP    ZAVPR
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     TRVN
      ** .. C/Value - Settlement Currency
     C                     Z-ADDTRVN      TRVS
      ** .. Settlement Currency
     C                     MOVE TRNC      TRSC
      ** .. Overdue indicator
     C                     MOVE *BLANKS   TROI
      ** .. Portfolio Indicator
     C                     MOVE 'Y'       TRPI
      ** .. Counterparty
     C                     MOVELMCCNUM    TRPT
      ** .. Ex coupon/dividend
     C                     MOVE 'F'       TRED
      ** .. Branch
     C                     MOVE MCBRCD    TRBA
      ** .. Book
     C                     MOVE *BLANKS   TRBK
      ** .. Market Indicator
     C           WWNMCY    IFEQ WONMCY
     C                     MOVE WOMKTI    TRMK
     C                     ELSE
     C                     MOVE WNMKTI    TRMK
     C                     ENDIF
      *
      ***  Access to Corporate Action Type Details to retrieve CO Account Code
      *
     C                     MOVE MACOAT    WKCOAT
     C                     EXSR #ACOAT
      ** .. Trade Sub-Type
      *
      ***  Retrieve the classification from PF/SDSECDPD
      *
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOSEC
      *
      ***  Retrieve the Default Portfolio Subtype
      *
     C                     MOVE BVDPFS    TRTS
      ** .. Profit Center
      *
     C                     MOVE *BLANKS   PRFC
      *
      ***   If Profit Centre used
      ***   and Analytical Accounting Module is off
      *
     C           BKPRCU    IFEQ 'Y'
     C           BGN0ST    ANDNE'Y'
      *
      ***  If Book position/profit centres are to be reconciled
      *
     C           BVTBRC    IFEQ 'Y'
      *
      ***  Default from current book position profit centre record
      *
     C                     MOVELTRBK      WKTDBK
     C                     MOVELTRBA      WKBRCA
     C                     MOVELTRSS      WKSESN    P
     C                     MOVELTRMK      WKMKTI
      *
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
     C                     MOVE WOSESN    WKSESN    P
     C           KWPCBD    CHAINSEPCBD               89
     C           *IN89     IFEQ *OFF
     C                     MOVE PCBK      PRFC
     C                     ELSE
      *
      ***  Else default from matrix and allow amendment
      *
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TRBK      @BOOK
     C                     MOVELTRTT      @TRTP     P
     C                     MOVE TRTS      @SUTP
     C                     MOVE TRBA      @BRAN
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Book position/profit centres are NOT to be reconciled
      *
     C           BVTBRC    IFEQ 'N'
      *
      ***  Customer Position Profit Centre defaulting
      *
      *
      ***  Default from current customer position profit centre
      *
     C********** TRPT      IFNE *ZEROS                                                        CSD027
     C           TRPT      IFNE *BLANKS                                                       CSD027
     C                     MOVELTRPT      WKDPBN           Customer
     C                     MOVELTRBA      WKBRCA           Branch
     C                     MOVELTRSS      WKDPSS    P      Security
      *
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C                     MOVELWOSESN    WKDPSS           Event Security
     C           KWSEPC    CHAINSEPCCDF              89
     C           *IN89     IFEQ *OFF
     C                     MOVELPCCU      PRFC
     C                     ELSE
     C           BKPCDU    IFEQ 'Y'
     C                     MOVE TRBK      @BOOK
     C                     MOVELTRTT      @TRTP     P
     C                     MOVE TRTS      @SUTP
     C                     MOVE TRBA      @BRAN
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOPRF
     C                     MOVE WWPRFC    PRFC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Access to Customer details to retrieve the report name and Town
      *
     C                     MOVELTRPT      WCUST
     C                     EXSR #AOCUS
      ** .. C/Party report name
     C                     MOVE BBCRNM    TRCN
      ** .. C/Party report town
     C                     MOVE BBCRTN    TRTN
      ** .. Settlement method
     C                     Z-ADD*ZEROS    TRSM
      ** .. Settlement account
     C                     MOVE *BLANKS   TRSA
      ** .. Settlement Branch
     C                     MOVE *BLANKS   TRTA
      ** .. Clearance Type
     C                     MOVE *BLANKS   TRCR
      ** ..  Portfolio Reference
     C                     MOVE MCPTFR    PTFR
      ** ..  due to Early Redemption
     C                     MOVE 'N'       EARL
      ** ..  Originating branch
     C                     MOVE MCBRCD    ORBR
      *
      ***  Access to Branch detail to retrieve the book, orig. branch
      ***  and event branch
      *
     C                     EXSR #AOBRC
      ** .. Company of Booking Branch
     C                     MOVE A8CMCD    COBB
      ** .. Company of Originating Branch
     C                     MOVE A8CMCD    COOB
      ** .. Company of event branch
     C                     MOVE A8CMCD    ECPY
      ** ..Entity code
     C                     MOVE *BLANKS   EXEI
      ** .. Branch entity level
     C                     MOVE 'B'       ELVB
      ** .. Company entity level
     C                     MOVE 'C'       ELVC
      ** .. System entity level
     C                     MOVE 'S'       ELVS
      ** .. Event branch code
     C                     MOVE MCBRCD    EBRC
      ** .. Multibranching event
     C                     MOVE 'N'       IBRE
      ** .. Intercompany event flag
     C                     MOVE 'Y'       ICYE
      ** .. Our Settlement Branch
     C                     MOVE *BLANKS   OSBR
      ** .. Corporate Action Flag
     C                     MOVE 'Y'       COAF
      ** .. Record ID
     C                     MOVE 'D'       TRRI
      *                                                                   141303
     C********** CEU011    IFEQ 'Y'                                                    141303 241795
     C                     Z-ADD1         A                               141303
     C           TRNC      LOKUPCUR,A                    89               141303
      *                                                                   141303
     C           *IN89     IFEQ *ON                                       141303
     C                     Z-ADDSRT,A     ECSS                            141303
     C                     ELSE                                           141303
      *                                                                   141303
     C           *LOCK     IN   LDA                                       141303
     C                     Z-ADD18        DBASE            ***************141303
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 18 *141303
     C                     MOVE 'SDCURRPD'DBFILE           ***************141303
     C                     MOVELTRNC      DBKEY                           141303
     C                     MOVEL'SE7590'  DBPGM     P                     141303
     C                     OUT  LDA                                       141303
     C                     EXSR *PSSR                                     141303
     C                     ENDIF                                          141303
     C**********           ENDIF                                                       141303 241795
      *
      ***  Write a trade event record for book record
      *
     C                     WRITETREVEDF
     C                     ADD  1         OUTRTR
     C                     ADD  TRON      WTOTTR
      *
      ** .. Book code
     C                     MOVE BVDPBC    TRBK
      *
      ***  Write a portfolio cutomer trade event record for customer record
      *
     C                     WRITEPCTEVDF
     C                     ADD  1         OUTRPC
     C                     ADD  TRON      WTOTPC
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SECTO - Access to LF/SETY to Retrive fields details         *
      *  ------   for the old security                                *
      *  Called by : Main processing                                  *
      *  Calls     : AOCURRR0 *PSSR                                   *
      *****************************************************************
      *
     C           #SECTO    BEGSR
      *
      ***  Chain for security record
      *
     C           WKSESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD5         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 05 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVELWKSESN    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Security nominal decimal places and price basis
      *
     C                     MOVELNMCY      WONMCY
     C                     Z-ADDNMDP      WONMDP
     C                     MOVE SPBS      WOSPBS
     C                     MOVE SITP      WOSITP
     C                     Z-ADDCFCT      WOCFCT
     C                     Z-ADDCPDP      WOCPDP
     C                     Z-ADDCPNR      WOCPNR
     C                     Z-ADDIADJ      WOIADJ
     C                     Z-ADDITLD      WOITLD
     C                     MOVE PPDI      WOPPDI
     C                     Z-ADDSFPP      WOSFPP
     C                     MOVE MKTI      WOMKTI
      *
      ***  Retrieve nomimal currency spot, m/d ind. and dec. places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WONMCY    @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD6         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 06 *
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELWONMCY    DBKEY     P
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save base currency spot, m/d indicator, dec. places for later
      *
     C                     MOVE A6SPRT    WOSPRT
     C                     MOVE A6MDIN    WOMDIN
     C                     MOVE A6NBDP    WONBDP
      *                                                                   137881
     C           CEU002    IFEQ 'Y'                                       137881
     C                     MOVE A6INCY    WOINCY  1                       137881
     C                     Z-ADDA6EUER    WOEUER                          137881
     C                     MOVE A6EUMD    WOEUMD                          137881
     C                     ELSE                                           137881
     C                     MOVE *BLANKS   WOINCY  1                       137881
     C                     Z-ADD*ZEROS    WOEUER                          137881
     C                     MOVE *BLANKS   WOEUMD                          137881
     C                     ENDIF                                          137881
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #SECTN - Access to LF/SETY to Retrive fields details         *
      *  ------   for the new security                                *
      *  Called by : #PRDV #PRFRR #PRFRO #PRFRA #PRCRR #PRCRA #PRCC   *
      *              #PRCE #PROFE #PROFP #PREX #PRRGZ #PRRGM #PRRGC   *
      *              #PRNC                                            *
      *  Calls     : AOCURRR0 *PSSR                                   *
      *****************************************************************
      *
     C           #SECTN    BEGSR
      *
      ***  Chain for security record
      *
     C           WKSESN    CHAINSECTY                89
      *
     C           *IN89     IFEQ *ON
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD7         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 07 *
     C                     MOVE 'SECTY   'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVELWKSESN    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Security details for new security
      *
     C                     MOVE EDFT      WNEDFT
     C                     MOVELNMCY      WNNMCY
     C                     MOVE SPBS      WNSPBS
     C                     Z-ADDNMDP      WNNMDP
     C                     Z-ADDMKPR      WNMKPR
     C                     MOVE SITP      WNSITP
     C                     Z-ADDCFCT      WNCFCT
     C                     Z-ADDCPDP      WNCPDP
     C                     Z-ADDCPNR      WNCPNR
     C                     Z-ADDIADJ      WNIADJ
     C                     Z-ADDITLD      WNITLD
     C                     MOVE PPDI      WNPPDI
     C                     Z-ADDSFPP      WNSFPP
     C                     MOVE MKTI      WNMKTI
      *
      ***  Retrieve nomimal currency spot, m/d ind. and dec. places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WNNMCY    @CYCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD8         DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 08 *
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELWNNMCY    DBKEY     P
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save base currency spot, m/d indicator, dec. places for later
      *
     C                     Z-ADDA6SPRT    WNSPRT
     C                     MOVE A6MDIN    WNMDIN
     C                     Z-ADDA6NBDP    WNNBDP
      *                                                                   137881
     C           CEU002    IFEQ 'Y'                                       137881
     C                     MOVE A6INCY    WNINCY  1                       137881
     C                     Z-ADDA6EUER    WNEUER                          137881
     C                     MOVE A6EUMD    WNEUMD                          137881
     C                     ELSE                                           137881
     C                     MOVE *BLANKS   WNINCY  1                       137881
     C                     Z-ADD*ZEROS    WNEUER                          137881
     C                     MOVE *BLANKS   WNEUMD                          137881
     C                     ENDIF                                          137881
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOBRC - Access to Branch Code Details with AO               *
      *  ------                                                       *
      *  Called by : #GNTRB #GNTRC                                    *
      *  Calls     : AOBRCHR0 *PSSR                                   *
      *****************************************************************
      *
     C           #AOBRC    BEGSR
      *
     C                     MOVE TRBA      WKBRCD
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   WLRTCD
     C                     PARM '*KEY  '  WLOPTN
     C                     PARM WKBRCD    WLBRCH  3
     C           SDBRCH    PARM SDBRCH    DSSDY
      *
      ***  If record not found
      *
     C           WLRTCD    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD9         DBASE            ***************
     C                     MOVE 'SDBRCHPD'DBFILE           * DB ERROR 09 *
     C                     MOVELWKBRCD    DBKEY            ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOCUS - Access to Customer details with AO                  *
      *  ------                                                       *
      *  Called by : #GNTRB #GNTRC                                    *
      *  Calls     : AOCUSTR0 *PSSR                                   *
      *****************************************************************
      *
     C           #AOCUS    BEGSR
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   WLRTCD
     C                     PARM '*KEY  '  WLOPTN
     C                     PARM WCUST     WLCUST 10
     C                     PARM *BLANKS   WLKYST  7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      ***  If record not found
      *
     C           WLRTCD    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD10        DBASE            ***************
     C                     MOVE 'SDCUSTPD'DBFILE           * DB ERROR 10 *
     C                     MOVELWCUST     DBKEY     P      ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOSEC -  Subroutine to Call Access Object:                  *
      *  ------    Security Customer                                  *
      *  Called by : #GNTRB #GNTRC                                    *
      *  Calls     : AOSECSR0 *PSSR                                   *
      *****************************************************************
      *
     C           #AOSEC    BEGSR
      *
     C                     CALL 'AOSECSR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WCUST     @SCKY   6
     C           SDSECS    PARM SDSECS    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD11        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 11 *
     C                     MOVE 'SDSECSPD'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVELWCUST     DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #AOPRF -  Subroutine to Call Access Object:                  *
      *  ------    Default Profit Center                              *
      *  Called by : #GNTRB #GNTRC                                    *
      *  Calls     : AOPRFMR0 *PSSR                                   *
      *****************************************************************
      *
     C           #AOPRF    BEGSR
      *                                                                                    179732
      **  Access Customer Details by using Access Object to retrieve                       179732
      **  Account Officer                                                                  179732
     C                     EXSR #AOCUS                                                     179732
      *                                                                                    179732
     C                     MOVELBBACOC    @ACOF                                            179732
      *
      ***  Setup Book code, Branch and User to retrieve Profit Centre
      *
     C                     CALL 'AOPRFMR0'
     C                     PARM *BLANKS   @RTC1   1
     C                     PARM           @BOOK   2
     C                     PARM           @TRTP   5
     C                     PARM           @SUTP   2
     C                     PARM           @BRAN   3
     C                     PARM *BLANKS   @DEPT   3
     C                     PARM USER      @USER  10
     C******************** PARM *BLANKS   @ACOF   2                                        179732
     C******************** PARM           WCNUM   6                                        179732
     C                     PARM           @ACOF   2                                        179732
     C                     PARM           WCUST   6                                        179732
     C                     PARM *BLANKS   @PRFC   4
      *
     C           @RTC1     IFEQ '0'
     C                     MOVEL@PRFC     WWPRFC  4
     C                     ELSE
     C                     MOVE *BLANKS   WWPRFC
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #ACOAT -  Subroutine to Retrieve Details from PF/SECOATPD    *
      *  ------    Corporate Action Type details                      *
      *  Called by : #GNTRB #GNTRC                                    *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #ACOAT    BEGSR
      *
     C           WKCOAT    CHAINSECOATL0             89
      *
     C           *IN89     IFEQ *ON
     C           MMRECI    OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD12        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 12 *
     C                     MOVE 'SECOATPD'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVELWKCOAT    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  *PSSR  - Dump routine in case of error                       *
      *  ------                                                       *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           WWRUN     IFNE 'Y'
     C                     DUMP
     C                     MOVE 'Y'       WWRUN   1
     C                     ENDIF
      *
     C           DBASE     IFGT 1
     C                     WRITEHEADAU
     C                     WRITEDBERROR
     C                     ENDIF
      *
     C                     MOVE *ON       *INU7
     C                     MOVE *ON       *INU8
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *  #TERPR -  Termination processing                             *
      *  ------                                                       *
      *  Called by : Main processing                                  *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #TERPR    BEGSR
      *
     C                     WRITEHEADAU
      *
      ***  Process audit processing
      ***  If no record output
      *
     C           OUTRPC    IFEQ *ZEROS
     C           OUTRTR    ANDEQ*ZEROS
     C                     WRITENODTLS
     C                     ELSE
      *
      ***  Write trade events audit record
      *
     C           1         SETLLTREVEA
     C                     READ TREVEA                   89
      *
     C           WTOTTR    DIV  1000      TRHRWN
     C                     MVR            TRHRDC
      *
      ***  If record found
      *
     C           *IN89     IFEQ '0'
      *
      ***  Trailer before running of the program
      *
     C                     Z-ADDNORE      TRBEFO
     C                     Z-ADDHRWN      TRBEF1
     C                     Z-ADDHRDC      TRBEF2
      *
      ***  Trailer added
      *
     C                     Z-ADDOUTRTR    TRCALC
     C                     Z-ADDTRHRWN    TRCAL1
     C                     Z-ADDTRHRDC    TRCAL2
      *
     C                     ADD  OUTRTR    NORE
     C                     ADD  TRHRWN    HRWN
     C           HRDC      ADD  TRHRDC    TRHRDC
      *
     C           TRHRDC    IFGE 1000
     C           TRHRDC    SUB  1000      HRDC
     C                     ADD  1         HRWN
     C                     ELSE
     C                     Z-ADDTRHRDC    HRDC
     C                     ENDIF
      *
      ***  Old Trailer + Calculated trailer = New trailer for TREVED
      *
     C                     Z-ADDNORE      TRAFTR
     C                     Z-ADDHRWN      TRAFT1
     C                     Z-ADDHRDC      TRAFT2
      *
     C                     UPDATTREVEAF
      *
      ***  If trailer does not exist |||
      *
     C                     ELSE
      *
      ***  Trailer before running of the program
      *
     C                     Z-ADD*ZEROS    TRBEFO
     C                     Z-ADD*ZEROS    TRBEF1
     C                     Z-ADD*ZEROS    TRBEF2
      *
      ***  Trailer added
      *
     C                     Z-ADDOUTRTR    TRCALC
     C                     Z-ADDTRHRWN    TRCAL1
     C                     Z-ADDTRHRDC    TRCAL2
      *
      ***  New Trailer for TREVED (Same as trailer added)
      *
     C                     Z-ADDOUTRTR    TRAFTR
     C                     Z-ADDTRHRWN    TRAFT1
     C                     Z-ADDTRHRDC    TRAFT2
      *
     C                     Z-ADDOUTRTR    NORE
     C                     Z-ADDTRHRWN    HRWN
     C                     Z-ADDTRHRDC    HRDC
     C                     WRITETREVEAF
     C                     ENDIF
      *
      ***  Write portfolio customer Trade Events audit record
      *
     C           1         SETLLPCTEVA
     C                     READ PCTEVA                   89
      *
     C           WTOTPC    DIV  1000      PCHRWN
     C                     MVR            PCHRDC
      *
     C           *IN89     IFEQ *OFF
      *
      ***   Trailer before running of the program
      *
     C                     Z-ADDNORE      PCBEFO
     C                     Z-ADDHRWN      PCBEF1
     C                     Z-ADDHRDC      PCBEF2
      *
      ***  Trailer added
      *
     C                     Z-ADDOUTRPC    PCCALC
     C                     Z-ADDPCHRWN    PCCAL1
     C                     Z-ADDPCHRDC    PCCAL2
      *
     C                     ADD  OUTRPC    NORE
     C                     ADD  PCHRWN    HRWN
     C           HRDC      ADD  PCHRDC    PCHRDC
      *
     C           PCHRDC    IFGE 1000
     C           PCHRDC    SUB  1000      HRDC
     C                     ADD  1         HRWN
     C                     ELSE
     C                     Z-ADDPCHRDC    HRDC
     C                     ENDIF
      *
      ***  Old Trailer + Calculated Trailer = New Trailer of PCTEVD
      *
     C                     Z-ADDNORE      PCAFTR
     C                     Z-ADDHRWN      PCAFT1
     C                     Z-ADDHRDC      PCAFT2
      *
     C                     UPDATPCTEVAF
      *
      ***  If Trailer does not exist |||
      *
     C                     ELSE
      *
      ***  Trialer before running of the program
      *
     C                     Z-ADD*ZEROS    PCBEFO
     C                     Z-ADD*ZEROS    PCBEF1
     C                     Z-ADD*ZEROS    PCBEF2
      *
      ***  Trailer added
      *
     C                     Z-ADDOUTRPC    PCCALC
     C                     Z-ADDPCHRWN    PCCAL1
     C                     Z-ADDPCHRDC    PCCAL2
      *
      ***  New Trailer of PCTEVD (Same as added)
      *
     C                     Z-ADDOUTRPC    PCAFTR
     C                     Z-ADDPCHRWN    PCAFT1
     C                     Z-ADDPCHRDC    PCAFT2
      *
     C                     Z-ADDOUTRPC    NORE
     C                     Z-ADDPCHRWN    HRWN
     C                     Z-ADDPCHRDC    HRDC
     C                     WRITEPCTEVAF
     C                     ENDIF
      *
     C                     WRITECONTROL
     C                     ENDIF
      *
      ***  End of Program
      *
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *   *INZSR : Program initialisation Subroutine                  *
      *  -------                                                      *
      *  Called by : Automatically at pgm start                       *
      *  Calls     :                                                  *
      *****************************************************************
      *
     C           *INZSR    BEGSR
      *
      ***  Copyright statement
      *
     C                     MOVEACPY@      BIS@   80
      *
      ***  Initialise key and working fields
      *
     C           *LIKE     DEFN MCBRCD    WKBRCA           Branch Code
     C           *LIKE     DEFN MCBRCD    WKBRCD           Branch Code
     C           *LIKE     DEFN CFCT      WNCFCT           Current Factor
     C           *LIKE     DEFN CFCT      WOCFCT           Current Factor
     C           *LIKE     DEFN CPDP      WNCPDP           Current Paid price
     C           *LIKE     DEFN CPDP      WOCPDP           Current Paid price
     C           *LIKE     DEFN CPNR      WNCPNR           Coupon rate
     C           *LIKE     DEFN CPNR      WOCPNR           Coupon rate
     C           *LIKE     DEFN SITP      WNSITP           Invest. type
     C           *LIKE     DEFN SITP      WOSITP           Invest. type
     C           *LIKE     DEFN SPBS      WNSPBS           Price Basis
     C           *LIKE     DEFN SPBS      WOSPBS           Price Basis
     C           *LIKE     DEFN PPDI      WNPPDI           Partly Payd ind.
     C           *LIKE     DEFN PPDI      WOPPDI           Partly Payd ind.
     C           *LIKE     DEFN SFPP      WNSFPP           Fully Payd Price
     C           *LIKE     DEFN SFPP      WOSFPP           Fully Payd Price
     C           *LIKE     DEFN IADJ      WNIADJ           Interest adjustment
     C           *LIKE     DEFN IADJ      WOIADJ           Interest adjustment
     C           *LIKE     DEFN ITLD      WNITLD           Initial Date
     C           *LIKE     DEFN ITLD      WOITLD           Initial Date
     C           *LIKE     DEFN NMDP      WNNMDP           Decimal places
     C           *LIKE     DEFN NMDP      WONMDP           Decimal places
     C           *LIKE     DEFN NMCY      WNNMCY           Nominal Ccy
     C           *LIKE     DEFN NMCY      WONMCY           Nominal Ccy
     C           *LIKE     DEFN NMCY      WWNMCY           Nominal Ccy
     C           *LIKE     DEFN MKPR      WNMKPR           Market Price
     C           *LIKE     DEFN MKTI      WNMKTI           Market ind.
     C           *LIKE     DEFN MKTI      WOMKTI           Market ind.
     C           *LIKE     DEFN MMTYPE    WKCOAT           CO Type
     C           *LIKE     DEFN MACORF    WKCORF           CO Reference
     C           *LIKE     DEFN MCDDPT    WKDDPT           CO Depot
     C           *LIKE     DEFN CNUM      WKDPBN           Customer Number
     C           *LIKE     DEFN SESN      WKDPSS           Security
     C           *LIKE     DEFN SESN      WKSESN           Security
     C           *LIKE     DEFN SESN      WOSESN           Security
     C           *LIKE     DEFN SESN      WNSESN           Security
     C           *LIKE     DEFN SESN      WWSESN           Security
     C           *LIKE     DEFN MKTI      WKMKTI           Market Ind.
     C           *LIKE     DEFN TRBK      WKTDBK           Book
     C           *LIKE     DEFN TRBK      WKBOOK           Book
     C           *LIKE     DEFN MCOPTN    WKOPTN           Option Number
     C           *LIKE     DEFN MCCNUM    WKCNUM           Customer
     C           *LIKE     DEFN MCCOTP    WKCOTP           Cust/Book ind.
     C           *LIKE     DEFN EDFT      WNEDFT           Ex Date Default
     C           *LIKE     DEFN EDFT      WOEDFT           Ex Date Default
     C           *LIKE     DEFN ECD       WWECD            Event controle Date
     C           *LIKE     DEFN MCASTA    WWNOML           Nominal
     C           *LIKE     DEFN MCPTFR    WKPTFR           Port. ref.
     C           *LIKE     DEFN TRTT      WWTDTP           Trade type
     C           *LIKE     DEFN A6NBDP    WNNBDP
     C           *LIKE     DEFN A6NBDP    WONBDP
     C           *LIKE     DEFN A6MDIN    WNMDIN
     C           *LIKE     DEFN A6MDIN    WOMDIN
     C           *LIKE     DEFN A6MDIN    WOEUMD                          137881
     C           *LIKE     DEFN A6MDIN    WNEUMD                          137881
     C           *LIKE     DEFN A6SPRT    WNSPRT
     C           *LIKE     DEFN A6SPRT    WOSPRT
     C           *LIKE     DEFN A6SPRT    WOEUER                          137881
     C           *LIKE     DEFN A6SPRT    WNEUER                          137881
      *
     C                     MOVE *BLANKS   WCUST   6
     C                     Z-ADD*ZEROS    WWMKTP 158
     C                     Z-ADD*ZEROS    WWTPDY 158
     C                     Z-ADD*ZEROS    WWTNMD  10
     C                     MOVE *BLANKS   WWACIN  1
      *
     C                     Z-ADD*ZEROS    OUTRTR  50
     C                     Z-ADD*ZEROS    OUTRPC  50
      *
     C                     Z-ADD0         WTOTTR 150
     C                     Z-ADD0         WTOTPC 150
      *
     C                     Z-ADD0         TRHRWN 150       Hash Total (Integer)
     C                     Z-ADD0         TRHRDC  50       Hash Total (Decimal)
     C                     Z-ADD0         PCHRWN 150       Hash Total (Integer)
     C                     Z-ADD0         PCHRDC  50       Hash Total (Decimal)
      *
      ***  Define necessary KLIST'S
      *
     C           KWCOAL    KLIST
     C                     KFLD           WKCORF
     C                     KFLD           WKBRCD
     C                     KFLD           WKDDPT
      *
     C           KWCOA3    KLIST
     C                     KFLD           WKCORF
     C                     KFLD           WKOPTN
     C                     KFLD           WKBRCD
     C                     KFLD           WKDDPT
     C                     KFLD           WKCOTP
     C                     KFLD           WKBOOK
     C                     KFLD           WKCNUM
     C                     KFLD           WKPTFR
      *
     C           KWCOOP    KLIST
     C                     KFLD           WKCOR2
     C                     KFLD           WKOPT2
      *
     C           KWPCBD    KLIST
     C                     KFLD           WKTDBK
     C                     KFLD           WKBRCA
     C                     KFLD           WKSESN
     C                     KFLD           WKMKTI
      *
     C           KWCOSC    KLIST
     C                     KFLD           WCBRCD
     C                     KFLD           WCCNUM
     C                     KFLD           WCSESN
      *
     C           KWSEPC    KLIST
     C                     KFLD           WKDPBN
     C                     KFLD           WKBRCA
     C                     KFLD           WKDPSS
      *
     C           KWBKPH    KLIST
     C                     KFLD           WKSESN
     C                     KFLD           WKBRCA
     C                     KFLD           WKBOOK
     C                     KFLD           WKMKTI
      *
     C           KWINV     KLIST
     C                     KFLD           WKNMCY
     C                     KFLD           WKSITP
      *
      ***   LDA initialization
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVE 'SE7590'  DBPGM     P
     C                     OUT  LDA
      *
      ***  Call ZSFILE for Audit printer file SE7590AU
      *
     C                     Z-ADDSFNUMU    ZSNUM   60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   @PARM   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
      *
      ***  Program Ended abnormally
      *
     C           ZSERR     IFEQ 'Y'
     C                     Z-ADD1         DBASE            ***************
     C                     MOVELSFILEU    DBFILE    P      * DB ERROR 01 *
     C           'ZSFILE R'CAT  'OUTINE'  DBKEY     P      ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Access to bank details to retrieve the midas run date
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   WLRTCD  7
     C                     PARM '*FIRST'  WLOPTN  7
     C           SDBANK    PARM SDBANK    DSSDY
      *
     C           WLRTCD    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD13        DBASE            ***************
     C                     MOVE 'SDBANKPD'DBFILE           * DB ERROR 13 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Set indicator 98 for date format used in ZDATE2
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE *ON       *IN98
     C                     ENDIF
      *
      ***  Access Midas Module Details
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD14        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 14 *
     C                     MOVE 'SDMMODPD'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Retrieve Accruals/Profit Date form General Leg
      *
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD15        DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 15 *
     C                     MOVE 'SDGELRPD'DBFILE           ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Access securities trading details using access object
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM *BLANKS   WLRTCD
     C                     PARM '*FIRST'  WLOPTN
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
     C           WLRTCD    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD16        DBASE            ***************
     C                     MOVE 'SDSTRDPD'DBFILE           * DB ERROR 16 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     MOVEL'SE7590'  DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   137881
     C**********           MOVE BVERCU    WWERCU  60                                   137881 CSD027
     C                     MOVE BVERCU    WWERCU  6                                           CSD027
      *                                                                   137881
      ***  Check if CEU002 is installed (EMU EURO Rates).                 137881
      *                                                                   137881
     C                     CALL 'AOSARDR0'                                137881
     C                     PARM *BLANKS   @RTCD   7                       137881
     C                     PARM '*VERIFY' @OPTN   7                       137881
     C                     PARM 'CEU002'  @SARC   6                       137881
      *                                                                   137881
      ***  Set indicator if installed.                                    137881
      *                                                                   137881
     C           @RTCD     IFEQ *BLANK                                    137881
     C                     MOVE 'Y'       CEU002  1                       137881
     C                     ELSE                                           137881
     C                     MOVE 'N'       CEU002                          137881
     C                     END                                            137881
      *                                                                   141303
      ***  Check if CEU011 is installed (EMU Position/Risk Reporting)     141303
      *                                                                   141303
     C                     CALL 'AOSARDR0'                                141303
     C                     PARM *BLANKS   @RTCD                           141303
     C                     PARM '*VERIFY' @OPTN                           141303
     C                     PARM 'CEU011'  @SARC   6                       141303
      *                                                                   141303
      ***  Set indicator if installed.                                    141303
      *                                                                   141303
     C           @RTCD     IFEQ *BLANK                                    141303
     C                     MOVE 'Y'       CEU011  1                       141303
     C                     ELSE                                           141303
     C                     MOVE 'N'       CEU011                          141303
     C                     END                                            141303
      *                                                                   141303
     C********** CEU011    IFEQ 'Y'                                                    141303 241795
     C                     Z-ADD1         A       30                      141303
     C           *LOVAL    SETLLSDCURRL1                                  141303
     C                     READ SDCURRL1                 89               141303
      *                                                                   141303
     C           A         DOWLE200                                       141303
     C           *IN89     ANDEQ*OFF                                      141303
      *                                                                   141303
     C                     MOVE A6CYCD    CUR,A                           141303
     C                     Z-ADDA6SSNB    SRT,A                           141303
      *                                                                   141303
     C                     READ SDCURRL1                 89               141303
     C                     ADD  1         A                               141303
     C                     ENDDO                                          141303
     C**********           ENDIF                                                       141303 241795
      *
      ***  Calculate ECD as per Standard Midas Processing
      *
     C                     Z-ADDBKAPDT    ZZAPDT
     C                     Z-ADDBJDNWD    ZZDNWD
     C                     EXSR ZEVCD
     C                     MOVE ECD       WWECD
      *                                                                   CAC005
      ** Check if CAC005 - PCA-SE Enhancement is on.                      CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD   7                       CAC005
     C                     PARM '*VERIFY' @OPTN   7                       CAC005
     C                     PARM 'CAC005'  @SARD   6                       CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     ENDIF                                          CAC005
      *
     C                     ENDSR
      *
      **************************************************************************
      /EJECT
      **************************************************************************
     C*                                                                  *
     C*  ZAVPR2 based on SR/ZAVPR standard subroutine                    *
     C*  ZAVPR- SUBROUTINE TO CALCULATE AVERAGE PRICE                    *
     C*                                                                  *
     C*  INPUT  -                   ZNOML (15,0) NOMINAL                 *
     C*                             ZAPNC (15,0) AP NUMERATOR            *
     C*           FROM CURRENCIES   ZCDP  (1,0) NOM.CCY DEC.PLS.         *
     C*           FROM SECTYD     - NMDP  (1,0) NOMINAL DEC. PLS.        *
     C*                             POWER8 ARRAY MUST BE INCLUDED IN     *
     C*                             CALLING PROGRAM                      *
     C*                                                                  *
     C*  OUTPUT - ZPRC   (16,9) AVERAGE PRICE                            *
     C*                                                                  *
     C*  CALLS - NONE                                                    *
     C**                                                                 *
      ********************************************************************
     C*
     C           ZAVPR2    BEGSR                           **ZAVPR BEGSR
     C*
     C*** Define fields
     C*
     C                     Z-ADDZPRC      ZPRC   169
     C                     Z-ADDZAPNC     ZAPNC  150
     C                     Z-ADDZWK150    ZWK150 150
     C                     Z-ADDZDF154    ZDF154 154
     C                     Z-ADDZNOML     ZNOML  150
     C                     Z-ADDDC        DC      10
     C                     Z-ADDZCDP      ZCDP    10
     C*
     C*** Put AP Numerator into Nominal ccy dec pls
     C*
     C           5         ADD  ZCDP      DC      10
     C                     SUB  NMDP      DC
     C           DC        IFLT 5
     C           ZAPNC     DIV  POWER8,DC ZAPNC
     C                     END
     C*
     C*** Price basis 'P'
     C*
     C           SPBS      IFEQ 'P'
     C                     MULT 100       ZAPNC
     C                     END
     C*
     C           ZAPNC     DIV  ZNOML     ZPRC      H
     C*
     C*** Prevent High Order Truncation
     C*
     C           ZPRC      MULT ZNOML     ZWK150    H
     C           ZAPNC     SUB  ZWK150    ZWK150
     C           ZWK150    DIV  ZNOML     ZDF154    H
     C*
      *** Calculate price and adjust figures (if needed).
      *
     C           DC        IFGE 5
     C           ZPRC      DIV  POWER8,DC ZPRC      H
     C           ZDF154    DIV  POWER8,DC ZDF154    H
     C                     END
     C*
     C                     ADD  ZDF154    ZPRC
     C*
     C                     ENDSR                           *** ENDSR    ***
     C*
      **************************************************************************
      /EJECT
      **************************************************************************
     C/COPY ZSRSRC,ZALIGNZ2
     C/COPY ZSRSRC,ZAPNUM
     C/COPY ZSRSRC,ZEVCDZ1
     C/COPY ZSRSRC,ZNCDZ3
     C/COPY ZSRSRC,ZDATE1Z2
     C/COPY ZSRSRC,ZDATE2Z2
     C/COPY ZSRSRC,ZCCYCN
     C/COPY ZSRSRC,ZCOTRZ1
     C/COPY ZSRSRC,ZCNSDZ1
     C/COPY ZSRSRC,ZPCINTZ1
     C/COPY ZSRSRC,ZLCDZ1
     C/COPY ZSRSRC,ZRATEZ1
     C/COPY ZSRSRC,ZACCRZ1
     C/COPY ZSRSRC,ZDYYRZ3
     C/COPY ZSRSRC,ZDAYSZ2
      *
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**  POWER9 - ARRAY OF POWERS FOR CURRENCY CONVERSION                      137881
000000001
000000010
000000100
000001000
000010000
000100000
001000000
010000000
100000000
