000100200529     H        1
000200200529      *****************************************************************
000300200529/*OVRF*: OVRDBF FILE(SECTYZ1) TOFILE(SECTY) SHARE(*NO)              : *
000400200529/*STD *  RPGBASE                                                      *
000500200529/*EXI *  TEXT('Midas SE Corporate actions - depot maintenance')       *
000600200529      *****************************************************************
000700200529      *                                                               *
000800200529      *  Midas - Securities Trading Module                            *
000900200529      *                                                               *
001000200529      *  SE7593  - SE Corporate Actions - Depot Maintenance           *
001100200529      *                                                               *
001200200529      *  Function:  Used to maintain details of allocations per       *
001300200529      *  (I/C)      depot.                                            *
001400200529      *                                                               *
001500200529      *  BE CARREFUL: All amendments of calculations made in this     *
001600200529      *               program must obligatorily be done in RPG/       *
001700200529      *               SE7550: Midas SE Corporate Actions Automatic    *
001800200529      *               Allocation Processing |                         *
001900200529      *               Some of those amendments must perhaps be done   *
002000200529      *               in RPG/SE7513: Midas SE Corporate Actions       *
002100200529      *               Customer/Book by Depot Maintenance, depending   *
002200200529      *               on calculations used in this program |          *
002300200529      *                                                               *
002400200529      *  Called By: SE7593  - Midas SE Corporate Actions - Depot      *
002500200529      *                       Selection.                              *
002600200529      *             SE7592  - Midas SE Corporate Actions - Depot      *
002700200529      *                       Select Option.                          *
002800200529      *                                                               *
002900200529      *  Calls: SE0040   - Midas SE Security detail maintenance.      *
003000200529      *         SE7513   - Midas SE CO Customer/Book by Depot         *
003100200529      *                    Maintenance.                               *
003200200529      *         Y2CLMSC  - Midas ABS Clear specific program message   *
003300200529      *                    queue.                                     *
003400200529      *         Y2SNMGC  - Midas ABS Send a message SNDxxxMSG.        *
003500200529      *         AOBANKR0 - Midas AO Bank ICD access object.           *
003600200529      *         AOCUSTR0 - Midas AO Client details access object.     *
003700200529      *         AOCURRR0 - Midas AO Currency codes access object.     *
003800200529      *         AOSTRDR0 - Access Program for Securities Trading      *   136935
003900200529      *                    Details.                                   *   136935
004000200529      *                                                               *
004100200529      *  (c) Finastra International Limited 2001                      *
004200200529      *                                                               *
004500200619      *  Last Amend No. MD046248           Date 27Oct17               *
004600200529      * Bank Fusion Midas 1.4 Base -----------------------------------*
004700200529      * Midas Plus 1.4 Base 04 ---------------------------------------*
004800200529      * Midas Plus 1.4 Base ------------------------------------------*
004900200529      * Midas Plus 1.3 ----------- Base ------------------------------*
005000200619      *  PREV Amend No. CSD031             Date 10Apr06               *
005100200529      *                 CSD027             Date 09Dec05               *
005200200529      *                 CSE071             Date 19Jul05               *
005300200529      *                 CSW037A            Date 02May05               *
005400200529      *                 CSD025             Date 11Jan05               *
005500200529      *                 CSW037             Date 15Dec04               *
005600200529      *                 CSW036             Date 15Dec04               *
005700200529      *                 CLE025             Date 20Oct03               *
005800200529      * Midas Release 4 --------------- Base -------------------------*
005900200529      *                 190204             Date 31May01               *
006000200529      * Midas DBA 3.03 -----------------------------------------------*
006100200529      *                 CAP137             Date 07Feb00               *
006200200529      *                 CSE020             Date 21Mar00               *
006300200529      *                 161732             Date 21Mar00               *
006400200529      * Midas DBA 3.00 ---------------- Base -------------------------*
006500200529      *                 155856             Date 23Feb99               *
006600200529      *                 153731             Date 21Jan99               *
006700200529      *                 138957             Date 16Jul98               *
006800200529      *                 137884             Date 14Jul98               *
006900200529      *                 136935             Date 29Jun98               *
007000200529      *                 136930             Date 17Jun98               *
007100200529      *                 135690             Date 08Jun98               *
007200200529      *                 135686             Date 05Jun98               *
007300200529      *                 135685             Date 28May98               *
007400200529      *                 CEU017             Date 05Mar98               *
007500200529      *                 CSE007  *CREATE    Date 01Dec97               *
007600200529      *                                                               *
007700200529      *---------------------------------------------------------------*
007800200529      *                                                               *
008700200529      *  MD046248 - Finastra Rebranding                               *
008800200529      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
008900200529      *  CSD027 - Conversion Of Customer Number to Alpha              *
009000200529      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
009100200529      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
009200200529      *  CSD025 - Customer De-Activation                              *
009300200529      *  CSW037 - Additional Field Data on MT300/MT320                *
009400200529      *  CSW036 - Dual SWIFT BIC held on Client Details               *
009500200529      *  CLE025 - Credit Lines (Recompile)                            *
009600200529      *  190204 - Changed Dividend per Unit format from 9N0 to 13N8.  *
009700200529      *  CAP137 - Conversion of SE Security inputs into modular       *
009800200529      *           structure to use as APIs.                           *
009900200529      *  CSE020 - Corporate Actions Domino Effect Processing          *
010000200529      *  161732 - Corporate Actions Exercise and Conversion -         *
010100200529      *           Part Stock/Keep Rest Calculation                    *
010200200529      *  155856 - Dbase Error 025 File SECOALL7 when cash amount is   *
010300200529      *           amended.                                            *
010400200529      *  153731 - Corporate Actions: Incorrect Record Number in       *
010500200529      *           Subfile SFLRCDNBR field                             *
010600200529      *  138957 - Corporate Actions: Review information passed to     *
010700200529      *           RPG/SE0040 (Security Details Maintenance) for a     *
010800200529      *           Name Change event where the Security Shortname is   *
010900200529      *           being changed (when F15 is pressed).                *
011000200529      *  137884 - Corporate Actions: Array Index Error when F5 pressed*
011100200529      *  136935 - Corporate Actions: Allocation processing amendments:*
011200200529      *           1. Amend calculations for Offers.                   *
011300200529      *           2. Input Balancing Difference on Dummy Customer if  *
011400200529      *              Currency Change or depending if field 'Allocate  *
011500200529      *              Difference to Dummy' = 'Y' on Securities Trading *
011600200529      *              ICD.                                             *
011700200529      *           3. For Reinvestment of Dividend, if Compensation    *
011800200529      *              Price entered, use Compensation Price instead of *
011900200529      *              Subscription Price, otherwise, calculate Sub-    *
012000200529      *              scription Price = Subscription Price minus Dis-  *
012100200529      *              count Rate.                                      *
012200200529      *  136930 - EMU and Corporate Actions: various errors:          *
012300200529      *           - Blink on screen Ex-Date Position if different     *
012400200529      *             from Allocation detail file and Depot Position    *
012500200529      *             file.                                             *
012600200529      *  135690 - Various errors for Corporate Actions:               *
012700200529      *           1. If Processing Type = Name Changes, New Security  *
012800200529      *              always equal Event Security, therefore, if       *
012900200529      *              Security Shortname entered on CO detail input,   *
013000200529      *              no Detail was retrieved from Depot allocation    *
013100200529      *              file and New Security displayed and transmitted  *
013200200529      *              to RPG/SE7513 was Event Security and no detail   *
013300200529      *              was retrieve on Allocation detail file on SE7513.*
013400200529      *              Security from CO detail file entered, process    *
013500200529      *              with this Security.                              *
013600200529      *           2. Due to Fix 135689: Error in validation of        *
013700200529      *              Dividend per Unit, amend number of decimal       *
013800200529      *              places of Dividend per Unit for Dividend Events, *
013900200529      *              from New Currency instead of New Security.       *
014000200529      *  135686 - Corporate Actions and EMU                           *
014100200529      *           1. Due database error, don't check if Actual Stock  *
014200200529      *              Allocation entered is on Denomination Multiplier *
014300200529      *              precision if processing type = CE, NC or NF      *
014400200529      *           2. Amend wrong calculation on Actual Stock          *
014500200529      *              Allocation: if with Denomination Multiplier      *
014600200529      *              precision, no Decimal Places used, so retrieve   *
014700200529      *              New Security Decimal Places.                     *
014800200529      *  135685 - It's not feasible to enter the Compensation Price   *
014900200529      *           at the Bulk level as the Bulk will have many        *
015000200529      *           Securities all giving a cash compensation at a      *
015100200529      *           different level. Therefore, allow the entry of      *
015200200529      *           'MARKET' which will use the Market Price of the     *
015300200529      *           Security at allocation effective date.              *
015400200529      *  CEU017 - Securities Redenomination Euro Changes              *
015500200529      *  CSE007 - Corporate Actions                                   *
015600200529      *                                                               *
015700200529      *****************************************************************
015800200529      *
015900200529      ***  Midas SE Securities                                           - Prefixe
016000200529      *
016100200529     FSECTYZ1 IF  E           K        DISK         KINFSR *PSSR
016200200529      *
016300200529      ***  Midas SE Corporate Actions - Depots live records              - Prefixe MB
016400200529      *
016500200529     FSECODPL3UF  E           K        DISK         KINFSR *PSSR A
016600200529     F                                              KCOMIT
017000200529      *
017100200529      ***  Midas SE Corporate Actions - Depots Upd idx                   - Prefixe MS
017200200529      *
017300200529     FSECODRL0UF  E           K        DISK         KINFSR *PSSR A
017400200529     F                                              KCOMIT
017500200529      *
017600200529      ***  Midas SE Corporate Actions - Dividends Events                 - Prefixe MD
017700200529      *
017800200529     FSECODVL1IF  E           K        DISK         KINFSR *PSSR
017900200529      *
018000200529      ***  Midas SE Corporate Actions - Free Allocations                 - Prefixe ME
018100200529      *
018200200529     FSECOFRL1IF  E           K        DISK         KINFSR *PSSR
018300200529      *
018400200529      ***  Midas SE Corporate Actions - Rights                           - Prefixe MF
018500200529      *
018600200529     FSECORGL1IF  E           K        DISK         KINFSR *PSSR
018700200529      *
018800200529      ***  Midas SE Corporate Actions - Capital Events                   - Prefixe MG
018900200529      *
019000200529     FSECOCEL1IF  E           K        DISK         KINFSR *PSSR
019100200529      *
019200200529      ***  Midas SE Corporate Actions - Corp. Reorganisation             - Prefixe MH
019300200529      *
019400200529     FSECOCRL1IF  E           K        DISK         KINFSR *PSSR
019500200529      *
019600200529      ***  Midas SE Corporate Actions - Exchange Offers                  - Prefixe MI
019700200529      *
019800200529     FSECOOFL1IF  E           K        DISK         KINFSR *PSSR
019900200529      *
020000200529      ***  Midas SE Corporate Actions - Exercice & Conversion            - Prefixe MJ
020100200529      *
020200200529     FSECOEXL1IF  E           K        DISK         KINFSR *PSSR
020300200529      *                                                                   135690
020400200529      ***  Midas SE Corporate Actions - Exercice & Conversion             135690
020500200529      ***                                                    - Prefixe ML 135690
020600200529      *                                                                   135690
020700200529     FSECONCL1IF  E           K        DISK         KINFSR *PSSR          135690
020800200529      *                                                                   CEU017
020900200529      ***  Midas SE Corporate Actions - Currency Changes                  CEU017
021000200529      ***                                                    - Prefixe NA CEU017
021100200529      *                                                                   CEU017
021200200529     FSECOCCL2IF  E           K        DISK         KINFSR *PSSR          CEU017
021300200529      *
021400200529      ***  Midas SE Market Prices file.                                  - Prefixe
021500200529      *
021600200529     FPRICM   IF  E           K        DISK         KINFSR *PSSR
021700200529      *                                                                   135685
021800200529      ***  MA - SE CORPORATE ACTIONS References - Rtv Idx                 135685
021900200529      *                                                                   135685
022000200529     FSECORFL1IF  E           K        DISK                               135685
022100200529     F                                              KINFSR *PSSR          135685
022200200529      *                                                                   CSE020
022300200529      ** Midas SE Corporate Actions - References Upd Idx                  CSE020
022400200529      *                                                                   CSE020
022500200529     FSECORFL9IF  E           K        DISK                               CSE020
022600200529     F            SECORFD0                          KRENAMESECORFX0       CSE020
022700200529     F                                              KINFSR *PSSR          CSE020
022800200529      *                                                                   136930
022900200529      ***  Midas SE Depot Positions - Current and Historic                136930
023000200529      *                                                                   136930
023100200529     FSEDPOHL0IF  E           K        DISK                               136930
023200200529     F                                              KINFSR *PSSR          136930
023300200529      *                                                                   136935
023400200529      ***  SE Corpotrate Actions - Allocat. Live Records     - Prefixe MC 136935
023500200529      *                                                                   136935
023600200529     FSECOALL7UF  E           K        DISK         KINFSR *PSSR          136935
023700200529     F                                              KCOMIT                136935
023800200529      *                                                                   CSE020
023900200529      ** SE Corporate Actions - Stock Allocations                         CSE020
024000200529      *                                                                   CSE020
024100200529     FSECOALL5IF  E           K        DISK                               CSE020
024200200529     F            SECOALD0                          KRENAMESECOALD5       CSE020
024300200529     F                                              KINFSR *PSSR          CSE020
024700200529      *
024800200529      ***  Display file.
024900200529      *
025000200529     FSE7593DFCF  E                    WORKSTN      KINFSR *PSSR
025100200529     F                                              KINFDS SCRDS
025200200529     F                                        #1RRN KSFILE SE7593S1
025300200529      *
025400200529      *****************************************************************
025500200529      *                                                               *
025600200529      *  F U N C T I O N   O F   I N D I C A T O R S                  *
025700200529      *                                                               *
025800200529      *  KC    F3: Exit pressed.                               (*ON)  *
025900200529      *  KE    F5: Refresh pressed.                            (*ON)  *
026000200529      *  KL    F12: Previous screen pressed.                   (*ON)  *
026100200529      *                                                               *
026200200529      *  20    F20: 'Exit without saving' pressed.             (*ON)  *
026300200529      *  25    - Rollup pressed on subfile,                    (*ON)  *
026400200529      *        - used in program message subfile.                     *
026500200529      *  30    Chain failed on LF/SECTY.                       (*ON)  *
026600200529      *  31    - Chain failed on LF/SECODPL3,                  (*ON)  *
026700200529      *          subfile end (SE7593C1),                              *
026800200529      *        - Allow Rollup.                                 (*OFF) *
026900200529      *  33    Chain failed on LF/SECODPL3.                    (*ON)  *
027000200529      *  34    Record changed on subfile SE7593S1.             (*ON)  *
027100200529      *  35    Chain failed on LF/SECODRL0.                    (*ON)  *
027200200529      *  36    Chain failed on LF/SECODPL3.                    (*ON)  *
027300200529      *        or on SECOALL7.                                 (*ON)  *   136935
027400200529      *  40    - Enquiry mode (protect all screen fields,      (*ON)  *
027500200529      *        - Amend mode.                                   (*OFF) *
027600200529      *  44    Record not found on LF/PRICM.                   (*ON)  *
027700200529      *  45    - 'CASH' line on sufile SE7593S1:               (*ON)  *
027800200529      *          display fields Actual 1 and Bal.Dif.1,               *
027900200529      *          non protect field Actual 3,                          *
028000200529      *          non display fields Actual 4, Bal.Dif.2-3-4.          *
028100200529      *        - New Security line on sufile SE7593S1:         (*OFF) *
028200200529      *          non display fields Actual 1 and Bal.Dif.1,           *
028300200529      *          protect field Actual 3,                              *
028400200529      *          display fields Actual 4, Bal.Dif.2-3-4.              *
028500200529      *  58    Field DDACN3: Action Code in error on subfile   (*ON)  *
028600200529      *        SE7593S1.                                              *
028700200529      *  59    Field DDACT2: Actual 2 in error on subfile      (*ON)  *
028800200529      *        SE7593S1, field DDEXIT: 'Confirm exit without          *
028900200529      *        saving' in error on record format SE7593F2.            *
029000200529      *  60    Field DDACT3: Actual 3 in error on subfile      (*ON)  *
029100200529      *        SE7593S1.                                              *
029200200529      *  61    Field DDACT4: Actual 4 in error on subfile      (*ON)  *
029300200529      *        SE7593S1.                                              *
029400200529      *  62    Blink Ex-Date Position on screen if different   (*ON)  *   136930
029500200529      *        from Depot Position and Allocation.                    *   136930
029600200529      *  82    - Clear subfile SE7593S1                        (*ON)  *
029700200529      *        - Display subfile control SE7593C1.             (*OFF) *
029800200529      *  83    Display subfile SE7593S1 = record number > 0.   (*ON)  *
029900200529      *  85    SFLNXTCHG on subfile.                           (*ON)  *
030000200529      *  89    Record not found on file SECOxxL1 (where xx =   (*ON)  *
030100200529      *        'DV', 'FR', 'RG', 'CE', 'CR', 'OF' or 'EX'),           *
030200200529      *        SECOCCL2 or on subfile SE7593S1.                       *
030300200529      *                                                               *
030400200529      *  90    Used in standart subroutine ZDATE2 and ZASIGN.         *
030500200529      *  91    Used in standart subroutine ZDATE2 and ZASIGN.         *
030600200529      *  92    Used in standart subroutine ZDATE2 and ZASIGN.         *
030700200529      *  93    Used in standart subroutine ZDATE2 and ZASIGN.         *
030800200529      *  94    Used in standart subroutine ZDATE2.                    *
030900200529      *  95    Used in standart subroutine ZDATE2.                    *
031000200529      *  96    Used in standart subroutine ZASIGN.                    *
031100200529      *  97    Used in standart subroutine ZASIGN.                    *
031200200529      *  98    Date in format DDMMYY,                          (*OFF) *
031300200529      *        Date in formt MMDDYY,                           (*ON)  *
031400200529      *        (used in standart subroutines ZDATE1 and ZDATE2).      *
031500200529      *  99    - Used in standart subroutine ZASIGN = field           *
031600200529      *          not numeric,                                  (*ON)  *
031700200529      *        - Used in standart subroutines ZDATE1 and ZDATE2.       *
031800200529      *                                                               *
031900200529      *  LR    End Program indicator.                          (*ON)  *
032000200529      *  U7-U8 Database error indicator.                       (*ON)  *
032100200529      *                                                               *
032200200529      *****************************************************************
032300200529      /SPACE 3
032400200529      *****************************************************************
032500200529      *                                                               *
032600200529      *  S U B R O U T I N E   I N D E X                              *
032700200529      *                                                               *
032800200529      *  P001   - Initial processing.                                 *
032900200529      *  P002   - Detail processing.                                  *
033000200529      *  P003   - Termination processing.                             *
033100200529      *  P004   - Build the subfile (Amend Mode).                     *
033200200529      *  P005   - Validation of the subfile (Amend Mode).             *
033300200529      *  P006   - Validate and perform Action taken (Amend Mode).     *
033400200529      *  P007   - Process Action.                                     *
033500200529      *  P008   - Update/write LF/SECODRL0 (Amend Mode).              *
033600200529      *  P009   - Move file fields to screen fields for New Security. *
033700200529      *  P010   - Move file fields to screen fields for Security      *
033800200529      *           '**CASH**'.                                         *
033900200529      *  V001   - Validate details input (Amend Mode).                *
034000200529      *  REASTR - Recalculate Actual Stock Rounding for New Security  *
034100200529      *           on Security line.                                   *
034200200529      *  REACAR - Recalculate Actual Cash Rounding for New Security   *
034300200529      *           on Security line.                                   *
034400200529      *  REACAA - Recalculate Actual Cash Allocation for Security     *
034500200529      *           '**CASH**' on Security line.                        *
034600200529      *  U001   - Load field for file SECODRL0.                       *
034700200529      *  U002   - Load fields for file SECODPL3 with all amounts = 0. *
034800200529      *  ACCSEC - Access Security details file.                       *
034900200529      *  *PSSR  - Error processing.                                   *
035000200529      *  ZASNMS - Send message to program message queue.              *
035100200529      *  SETNDP - Set amount from num field 30.9 to num field 15.0    *
035200200529      *           with Number of Decimal Places from a Currency.      *
035300200529      *  RTVNDP - Set amount from num field 15.0 to num field 30.9    *
035400200529      *           with Retrieve Number of Decimal Places from a Ccy.  *
035500200529      *  ROUNDD - Perform rounding to the Number of Decimal Places.   *
035600200529      *  CSBPR  - Calculate Subscription Price if Subscription Price  *
035700200529      *           entered as Market for Dividend Events.              *
035800200529      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
035900200529      *           date formats.                                       *
036000200529      *  ZSEDIT - Standart subroutine to insert a decimal point into  *
036100200529      *           a numeric field and to blank out leading zeroes.    *
036200200529      *  ZASIGN - Standart subroutine to validate and right-align     *
036300200529      *           signed numeric fields.                              *
036400200529      *  ZDATE1 - Standart subroutine to validate dates submitted and *
036500200529      *           convert to a number of days.                        *
036600200529      *                                                               *
036700200529      *****************************************************************
036800200529      /EJECT
036900200529      *
037000200529      ***  Array containing text messages for command keys.
037100200529      *
037200200529     E                    TXT     1   5 78
037300200529      *
037400200529      ***  Array containing titles for subfile lines.
037500200529      *
037600200529     E                    CNSARR  1   6 17
037700200529      *
037800200529      ***  Array for Security Shortnames.
037900200529      *
038000200529     E                    SSARR      20 10
038100200529      *
038200200529      ***  Array to retrieve New Securities (20 potential) from SECOCRL1.
038300200529      *
038400200529     E                    TSEC       20 10
038500200529      *
038600200529      ***  Array to retrieve Number of New Shares (20 potential) from SECOCRL1.
038700200529      *
038800200529     E                    TNSH       20 16
038900200529      *
039000200529      ***  Array to retrieve Rounding (20 potential) from SECOCRL1.
039100200529      *
039200200529     E                    TNDN       20  1
039300200529      *
039400200529      ***  Array to retrieve Rounding Settlement in Cash (20 potential) from SECOCRL1.
039500200529      *
039600200529     E                    TNDS       20  1
039700200529      *
039800200529      ***  Array to retrieve Compensation Price (20 potential) from SECOCRL1.
039900200529      *
040000200529     E                    TOPA       20 16
040100200529      *
040200200529      ***  Arrays to retrieve Denomination Multiplier (20 potential) from SECOCRL1.
040300200529      *
040400200529     E                    TDML       20 16
040500200529      *
040600200529      ***  Array containing error narrative when calling PGM.
040700200529      *
040800200529     E***********         NARR    1   2 29                                CAP137
040900200529     E                    NARR    1   3 29                                CAP137
041000200529      *
041100200529      ***  Arrays ZS1 and ZS2 used by standart subroutine ZSEDIT.
041200200529      *
041300200529     E/COPY ZSRSRC,ZSEDITZ1
041400200529      *
041500200529      ***  Arrays used by standart subroutine ZDATE2:
041600200529      ***    ZYDY containing Years in days cumulative, four year span,
041700200529      ***    ZMDY containing Months in days cumulative through year,
041800200529      ***    ZMNM containing Months short name.
041900200529      *
042000200529     E/COPY ZSRSRC,ZDATE2Z1
042100200529      *
042200200529      ***  Arrays ZS3, ZS4 and ZS5 used by standart subroutine ZASIGN.
042300200529      *
042400200529     E/COPY ZSRSRC,ZASIGNZ1
042500200529      *
042600200529      ***  Array containing Copyright statement.
042700200529      *
042800200529     E                    CPY@    1   1 80
042900200529      /SPACE 3
043000200529      *                                                                   CSE020
043100200529     ISECOALD5                                                            CSE020
043200200529      ** Rename fields of SECOALL5: Midas SE CA - Stock Allocations       CSE020
043300200529      *                                                                   CSE020
043400200529     I              MCRECI                          M5RECI                CSE020
043500200529     I              MCLCD                           M5LCD                 CSE020
043600200529     I              MCCHTP                          M5CHTP                CSE020
043700200529     I              MCLUID                          M5LUID                CSE020
043800200529     I              MCCORF                          M5CORF                CSE020
043900200529     I              MCOPTN                          M5OPTN                CSE020
044000200529     I              MCBRCD                          M5BRCD                CSE020
044100200529     I              MCDDPT                          M5DDPT                CSE020
044200200529     I              MCCOTP                          M5COTP                CSE020
044300200529     I              MCBOOK                          M5BOOK                CSE020
044400200529     I              MCCNUM                          M5CNUM                CSE020
044500200529     I              MCPTFR                          M5PTFR                CSE020
044600200529     I              MCEXPO                          M5EXPO                CSE020
044700200529     I              MCSESN                          M5SESN                CSE020
044800200529     I              MCOALR                          M5OALR                CSE020
044900200529     I              MCOTSA                          M5OTSA                CSE020
045000200529     I              MCOSTR                          M5OSTR                CSE020
045100200529     I              MCOCAR                          M5OCAR                CSE020
045200200529     I              MCCAOP                          M5CAOP                CSE020
045300200529     I              MCASTA                          M5ASTA                CSE020
045400200529     I              MCHOST                          M5HOST                CSE020
045500200529     I              MCHOCA                          M5HOCA                CSE020
045600200529     I              MCACAA                          M5ACAA                CSE020
045700200529     I              MCASTR                          M5ASTR                CSE020
045800200529     I              MCACAR                          M5ACAR                CSE020
045900200529     I              MCOPT1                          M5OPT1                CSE020
046000200529     I              MCOPT2                          M5OPT2                CSE020
046100200529     I              MCREST                          M5REST                CSE020
046200200529     I              MCBSEC                          M5BSEC                CSE020
046300200529     I              MCBEDT                          M5BEDT                CSE020
046400200529     I              MCBSTT                          M5BSTT                CSE020
046500200529     I              MCBLTY                          M5BLTY                CSE020
046600200529     I              MCBEWI                          M5BEWI                CSE020
046700200529     I              MCCOAT                          M5COAT                CSE020
046800200529     I              MCTRRF                          M5TRRF                CSE020
046900200529     I              MCTRR2                          M5TRR2                CSE020
047000200529     I              MCTRR3                          M5TRR3                CSE020
047100200529     I              MCRVRF                          M5RVRF                CSE020
047200200529     I              MCRVR2                          M5RVR2                CSE020
047300200529     I              MCRVR3                          M5RVR3                CSE020
047400200529     I              MCTNL1                          M5TNL1                CSE020
047500200529     I              MCLTRQ                          M5LTRQ                CSE020
047600200529     I              MCTOTF                          M5TOTF                CSE020
047700200529     I              MCTOTT                          M5TOTT                CSE020
050900200529      *
051000200529      *
051100200529      ***  Rename fields of SECOOFL1: Midas SE Corporate Actions - Offers.
051200200529      *
051300200529     ISECOOFD0
051400200529     I              MIRECI                          MDRECI
051500200529     I              MINSHA                          MDNSHA
051600200529     I              MIOSHA                          MDOSHA
051700200529     I              MIRNDN                          MDRNDN
051800200529     I              MIRNDS                          MDRNDS
051900200529     I              MICOMP                          MDCOMP
052000200529     I              MIDMLT                          MDDMLT
052100200529      *
052200200529      ***  Rename fields of SECORGL1: Midas SE Corporate Actions - Rights Issues.
052300200529      *
052400200529     ISECORGD0
052500200529     I              MFRECI                          MDRECI
052600200529     I              MFNSHA                          MDNSHA
052700200529     I              MFOSHA                          MDOSHA
052800200529     I              MFRNDN                          MDRNDN
052900200529     I              MFRNDS                          MDRNDS
053000200529     I              MFCOMP                          MDCOMP
053100200529     I              MFDMLT                          MDDMLT
053200200529      *
053300200529      ***  Rename fields of SECOEXL1: Midas SE Corporate Actions - Exercices and Conversions.
053400200529      *
053500200529     ISECOEXD0
053600200529     I              MJRECI                          MDRECI
053700200529     I              MJNSHA                          MDNSHA
053800200529     I              MJOSHA                          MDOSHA
053900200529     I              MJRNDN                          MDRNDN
054000200529     I              MJRNDS                          MDRNDS
054100200529     I              MJCOMP                          MDCOMP
054200200529     I              MJSUPR                          MDSBPR
054300200529     I              MJDMLT                          MDDMLT
054400200529     I              MJRCPR                          MDRCPR                161732
054500200529      *
054600200529      ***  Rename fields of SECOCRL1: Midas SE Corporate Actions - Corporate Reorganisation.
054700200529      *
054800200529     ISECOCRD0
054900200529     I              MHRECI                          MDRECI
055000200529     I              MHOSHA                          MDOSHA
055100200529      *
055200200529      ***  Rename fields of SECOFRL1: Midas SE Corporate Actions - Free Allocation.
055300200529      *
055400200529     ISECOFRD0
055500200529     I              MERECI                          MDRECI
055600200529     I              MENSHA                          MDNSHA
055700200529     I              MEOSHA                          MDOSHA
055800200529     I              MERNDN                          MDRNDN
055900200529     I              MERNDS                          MDRNDS
056000200529     I              MECOMP                          MDCOMP
056100200529     I              MEDMLT                          MDDMLT
056200200529      *
056300200529      ***  Rename fields of SECOCEL1: Midas SE Corporate Actions - Capital Changes.
056400200529      *
056500200529     ISECOCED0
056600200529     I              MGRECI                          MDRECI
056700200529      *                                                                   CEU017
056800200529      ***  Rename fields of SECOCCL2: Midas SE Corporate Actions -        CEU017
056900200529      ***                             Currency Changes.                   CEU017
057000200529      *                                                                   CEU017
057100200529     ISECOCCD0                                                            CEU017
057200200529     I              NARECI                          MDRECI                CEU017
057300200529     I              NANNSZ                          MDNSHA                CEU017
057400200529     I              NAONSZ                          MDOSHA                CEU017
057500200529     I              NARNDN                          MDRNDN                CEU017
057600200529     I              NARNDS                          MDRNDS                CEU017
057700200529     I              NACOMP                          MDCOMP                CEU017
057800200529     I              NADMLT                          MDDMLT                CEU017
057900200529      *                                                                   CSE020
058000200529      ** Rename fields of SECORFL9: Corporate Actions Reference File      CSE020
058100200529      *                                                                   CSE020
058200200529     ISECORFX0                                                            CSE020
058300200529     I              MARECI                          MNRECI                CSE020
058400200529     I              MALCD                           MNLCD                 CSE020
058500200529     I              MACHTP                          MNCHTP                CSE020
058600200529     I              MALUID                          MNLUID                CSE020
058700200529     I              MACORF                          MNCORF                CSE020
058800200529     I              MAJOBN                          MNJOBN                CSE020
058900200529     I              MAUSER                          MNUSER                CSE020
059000200529     I              MAJNBR                          MNJNBR                CSE020
059100200529     I              MASESN                          MNSESN                CSE020
059200200529     I              MACOAT                          MNCOAT                CSE020
059300200529     I              MAPTYP                          MNPTYP                CSE020
059400200529     I              MACOAN                          MNCOAN                CSE020
059500200529     I              MACOEX                          MNCOEX                CSE020
059600200529     I              MAALEF                          MNALEF                CSE020
059700200529     I              MANBOP                          MNNBOP                CSE020
059800200529     I              MATDVD                          MNTDVD                CSE020
059900200529     I              MACOPD                          MNCOPD                CSE020
060000200529     I              MATDDT                          MNTDDT                CSE020
060100200529     I              MAEVDT                          MNEVDT                CSE020
060200200529     I              MACPNB                          MNCPNB                CSE020
060300200529     I              MASHMD                          MNSHMD                CSE020
060400200529     I              MALTBS                          MNLTBS                CSE020
060500200529     I              MAOCPV                          MNOCPV                CSE020
060600200529     I              MANCPV                          MNNCPV                CSE020
060700200529     I              MAONML                          MNONML                CSE020
060800200529     I              MANNML                          MNNNML                CSE020
060900200529     I              MACUPC                          MNCUPC                CSE020
061000200529     I              MAEXPC                          MNEXPC                CSE020
061100200529     I              MACLRD                          MNCLRD                CSE020
061200200529     I              MACLRT                          MNCLRT                CSE020
061300200529     I              MADLRD                          MNDLRD                CSE020
061400200529     I              MADLRT                          MNDLRT                CSE020
061500200529     I              MABLOS                          MNBLOS                CSE020
061600200529     I              MABLOP                          MNBLOP                CSE020
061700200529     I              MABFRD                          MNBFRD                CSE020
061800200529     I              MABEND                          MNBEND                CSE020
061900200529     I              MAREFO                          MNREFO                CSE020
062000200529     I              MACONR                          MNCONR                CSE020
062100200529     I              MADFNR                          MNDFNR                CSE020
062200200529     I              MADFCP                          MNDFCP                CSE020
062300200529     I              MADFSP                          MNDFSP                CSE020
062400200529     I              MALREQ                          MNLREQ                CSE020
062500200529     I              MALPRO                          MNLPRO                CSE020
062600200529     I              MALTSI                          MNLTSI                CSE020
062700200529     I              MASTAT                          MNSTAT                CSE020
062800200529     I              MAPREF                          MNPREF                CSE020
062900200529      *
063000200529      ***  Display File Status Data Structure.
063100200529      *
063200200529     ISCRDS       DS
063300200529     I                                    B 378 3790CPFPOS
063400200529      *
063500200529      ***  Data structure for compilation - Copyright insertion.
063600200529      *
063700200529     ICPYR@$      DS
063800200529     I                                        1  80 CPY@
063900200529     I                                        1  20 CPY@$$
064000200529      *
064100200529      ***  Program status data structure.
064200200529      *
064300200529     IPSDS       SDS
064400200529     I                                     *PROGRAM ##PGM
064500200529     I                                      244 253 JOB
064600200529     I                                      254 263 USER
064700200529      *
064800200529      ***  Local data area.
064900200529      ***  Local data area for database error details
065000200529      ***  *LOCK IN LDA immediately before and OUT LDA immediately
065100200529      ***  after each database error handling.
065200200529      *
065300200529     ILDA         DS                            256
065400200529     I                                      134 141 WWFILE
065500200529     I                                      142 170 WWKEY
065600200529     I                                      171 180 WWPGM
065700200529     I                                      181 1830WWASE
065800200529      *
065900200529      ***  External data structures for Bank Details                     - Prefixe BJ.
066000200529      *
066100200529     ISDBANK    E DSSDBANKPD
066200200529      *
066300200529      ***  External data structures for Customer Details                 - Prefixe BB.
066400200529      *
066500200529     ISDCUST    E DSSDCUSTPD
066600200529      *
066700200529      ***  External data structure for Currency details                  - Prefixe A6.
066800200529      *
066900200529     ISDCURR    E DSSDCURRPD
067000200529      *                                                                   CAP137
067100200529      ** Externally described DS for SAR details                          CAP137
067200200529     ISCSARD    E DSSCSARDPD                                              CAP137
067300200529      *
067400200529      ***  First Data Strusture for Access Programs, Long Data Structure.
067500200529      *
067600200529     IDSSDY     E DSDSSDY
067700200529      *
067800200529      ***  Second Data Strusture for Access Programs, Short Data Structure.
067900200529      *
068000200529     IDSFDY     E DSDSFDY
068500200529      *                                                                   136935
068600200529      ***  Data structure for Securities Trading Details.    - Prefixe BV 136935
068700200529      *                                                                   136935
068800200529     ISDSTRD    E DSSDSTRDPD                                              136935
068900200529      *
070200200529      ***  Data structure for fields WORK15 used by standart subroutine ZSEDIT.
070300200529      *
070400200529     I/COPY ZSRSRC,ZSEDITZ2
070500200529      /EJECT
070600200529      *================================================================
070700200529      *  P R O G R A M   S T A R T                                    *
070800200529      *================================================================
070900200529      *
071000200529      ***  Initial processing.
071100200529      *
071200200529     C                     EXSR P001
071300200529      *
071400200529      ***  Detail processing.
071500200529      *
071600200529     C                     EXSR P002
071700200529      *
071800200529      ***  Termination processing.
071900200529      *
072000200529     C                     EXSR P003
072100200529      *
072200200529      *================================================================
072300200529      *  P R O G R A M   E N D                                        *
072400200529      *================================================================
072500200529      /EJECT
072600200529      *****************************************************************
072700200529      *                                                               *
072800200529      *  P001   - Initial processing.                                 *
072900200529      *                                                               *
073000200529      *  Called by: Main processing.                                  *
073100200529      *                                                               *
073200200529      *  Calls: ACCSEC   - Access Security details file.              *
073300200529      *         *PSSR    - Error processing.                          *
073400200529      *         ZDATE2   - Standart subroutine to convert a Day       *
073500200529      *                    Number to date formats.                    *
073600200529      *         AOBANKR0 - Midas AO Bank ICD access object.           *
073700200529      *         AOCUSTR0 - Midas AO Client details access object.     *
073800200529      *         AOCURRR0 - Midas AO Currency codes access object.     *
073900200529      *                                                               *
074000200529      *****************************************************************
074100200529      *
074200200529     C           P001      BEGSR                           ** P001 SR **
074300200529      *
074400200529      ***  Setup Copyright statement.
074500200529      *
074600200529     C                     MOVEACPY@      CPY2@  80
074700200529      *
074800200529      ***  Entry parameters.
074900200529      *
075000200529     C           *ENTRY    PLIST
075100200529     C                     PARM           WWREFN  6        CO Reference
075200200529     C                     PARM           WWSECN 10        Security Shortname
075300200529     C                     PARM           WWCOAT  2        Corporate Action Type
075400200529     C                     PARM           WWPTYP  2        Processing Type
075500200529     C                     PARM           WWEXDT  5        Ex-Date
075600200529     C                     PARM           WWOPTN  2        Option Number
075700200529     C                     PARM           WWACTN  1        Action 'A' or 'E'
075800200529     C                     PARM           WWBRCD  3        Branch
075900200529     C                     PARM           WWDEPT  6        Depot
076000200529     C                     PARM           WWEXPO 17        Ex-date position
076100200529     C                     PARM           WWCOAD  6        Last Allocation Date
076200200529     C                     PARM           WWSTAT  1        Corporate Action Stat
076300200529     C                     PARM           WWFINA  1        Final Allocation Indi
076400200529     C                     PARM           WWNCCY  3        Nominal Currency
076500200529     C                     PARM           WWUPDT  1        Update done ?
076600200529     C                     PARM           WWRTCD  1        Return Code
076700200529      *
076800200529      ***  Setup key list to LF/SECODRL0.
076900200529      *
077000200529     C           KEY1      KLIST
077100200529     C                     KFLD           WWREFN           CO Reference (Parameter)
077200200529     C                     KFLD           WWDSBA  3        Branch
077300200529     C**********           KFLD           WWDDPT  60       Depot (parameter, num field)       CSD027
077400200529     C                     KFLD           WWDDPT  6        Depot (parameter, num field)       CSD027
077500200529      *
077600200529      ***  Setup key list to LF/SECODPL3.
077700200529      *
077800200529     C           KEY2      KLIST
077900200529     C                     KFLD           WWREFN           CO Reference (parameter)
078000200529     C                     KFLD           WWOPNB           Option Number (parameter, num field)
078100200529     C                     KFLD           WWBRCA  3        Branch
078200200529     C**********           KFLD           WWDPOT  60       Depot                              CSD027
078300200529     C                     KFLD           WWDPOT  6        Depot                              CSD027
078400200529     C                     KFLD           WWSECS 10        Security
078500200529      *
078600200529      ***  Setup key list to LF/SECOxxL1.
078700200529      *
078800200529     C           KEY3      KLIST
078900200529     C                     KFLD           WWREFN           CO Reference (parameter)
079000200529     C                     KFLD           WWOPNB           Option Number (parameter, num field)
079100200529      *
079200200529      ***  Setup key list to LF/PRICM.
079300200529      *
079400200529     C           KEY4      KLIST
079500200529     C                     KFLD           MDNSEC           New Security from SECODVL1
079600200529     C                     KFLD           KPVDT   50       Value Date
079700200529      *                                                                   136930
079800200529      ***  Setup key list to LF/SEDPOHL0.                                 136930
079900200529      *                                                                   136930
080000200529     C           KEY6      KLIST                                          136930
080100200529     C                     KFLD           WWBRCD                          136930
080200200529     C                     KFLD           WWDDPT                          136930
080300200529     C                     KFLD           WWSECN                          136930
080400200529     C                     KFLD           KEXDT   50                      136930
080500200529      *                                                                   136935
080600200529      ***  Setup key list to LF/SECOALL7.                                 136935
080700200529      *                                                                   136935
080800200529     C           KEY7      KLIST                                          136935
080900200529     C                     KFLD           WWREFN           CO Reference   136935
081000200529     C                     KFLD           WWOPNB           Option Number  136935
081100200529     C                     KFLD           WWBRCD           Branch         136935
081200200529     C                     KFLD           WWDDPT           Depot          136935
081300200529     C                     KFLD           WWSECS           Security       136935
081400200529     C                     KFLD           WWCOTP  1        Cust./Book Ind.136935
081500200529     C                     KFLD           WWBOOK  2        Book           136935
081600200529     C**********           KFLD           WWERCU  60       Dummy Cust.                 136935 CSD027
081700200529     C                     KFLD           WWERCU  6        Dummy Cust.                        CSD027
081800200529     C                     KFLD           WWPTFR  4        Portfolio      136935
081900200529      *                                                                   CSE020
082000200529      ** Setup key list to LF/SECOALL5.                                   CSE020
082100200529      *                                                                   CSE020
082200200529     C           KEY8      KLIST                                          CSE020
082300200529     C                     KFLD           MAPREF                          CSE020
082400200529     C                     KFLD           DSBA                            CSE020
082500200529     C                     KFLD           DDPT                            CSE020
083400200529      *
083500200529      ***  Setup work and key fields.
083600200529      *
083700200529     C                     MOVEL'SE7593  'DBPGM  10        PGM name for database error proc.
083800200529     C                     MOVE 'L'       ZECODE           Edit code used in SR ZSEDIT
083900200529     C                     MOVE 'N'       WWUPDT           Update done ?
084000200529     C**********           MOVE WWDEPT    WWDDPT  60       Depot (parameter, num field)       CSD027
084100200529     C                     MOVE WWDEPT    WWDDPT  6        Depot (parameter, num field)       CSD027
084200200529     C                     MOVE WWEXDT    KEXDT            Ex-Date        136930
084300200529     C                     MOVE 'C'       WWCOTP           Cust./Book Ind.136935
084400200529     C                     MOVE *BLANKS   WWBOOK           Book           136935
084500200529     C                     MOVE *BLANKS   WWPTFR           Portfolio      136935
084600200529      *
084700200529      ***  If Action Mode = 'E': Enquiry, setup indicator *IN40 to *ON to protect all screen fields.
084800200529      *
084900200529     C           WWACTN    IFEQ 'E'                        Enquiry Mode
085000200529     C                     MOVE '1'       *IN40
085100200529     C                     ELSE                            Amend Mode
085200200529     C                     MOVE '0'       *IN40
085300200529     C                     ENDIF
085400200529      *
085500200529      ***  If Option Number = '??', retrieve it depending on Processing Type. not for Processing
085600200529      ***  Type Name Changes, Non Financial Events where Option Number always = 01.
085700200529      ***  And not for Currency Changes.                                  CEU017
085800200529      *
085900200529     C           WWOPTN    IFEQ '??'
086000200529      *
086100200529     C                     SELEC
086200200529     C           WWPTYP    WHEQ 'DV'                       Dividend Events
086300200529     C           WWREFN    SETLLSECODVL1
086400200529     C           WWREFN    READESECODVL1                 89
086500200529     C                     MOVE MDOPTN    WWOPTN
086600200529     C                     MOVEL'SECODVL1'DBFILS
086700200529      *
086800200529     C           WWPTYP    WHEQ 'FR'                       Free Allocation
086900200529     C           WWREFN    SETLLSECOFRL1
087000200529     C           WWREFN    READESECOFRL1                 89
087100200529     C                     MOVE MEOPTN    WWOPTN
087200200529     C                     MOVEL'SECOFRL1'DBFILS
087300200529      *
087400200529     C           WWPTYP    WHEQ 'CE'                       Capital Changes
087500200529     C           WWREFN    SETLLSECOCEL1
087600200529     C           WWREFN    READESECOCEL1                 89
087700200529     C                     MOVE MGOPTN    WWOPTN
087800200529     C                     MOVEL'SECOCEL1'DBFILS
087900200529      *
088000200529     C           WWPTYP    WHEQ 'CR'                       Corporate Reorganisation
088100200529     C           WWREFN    SETLLSECOCRL1
088200200529     C           WWREFN    READESECOCRL1                 89
088300200529     C                     MOVE MHOPTN    WWOPTN
088400200529     C                     MOVEL'SECOCRL1'DBFILS
088500200529      *
088600200529     C           WWPTYP    WHEQ 'RG'                       Rights Issues
088700200529     C           WWREFN    SETLLSECORGL1
088800200529     C           WWREFN    READESECORGL1                 89
088900200529     C                     MOVE MFOPTN    WWOPTN
089000200529     C                     MOVEL'SECORGL1'DBFILS
089100200529      *
089200200529     C           WWPTYP    WHEQ 'OF'                       Offers
089300200529     C           WWREFN    SETLLSECOOFL1
089400200529     C           WWREFN    READESECOOFL1                 89
089500200529     C                     MOVE MIOPTN    WWOPTN
089600200529     C                     MOVEL'SECOOFL1'DBFILS
089700200529      *
089800200529     C           WWPTYP    WHEQ 'EX'                       Exercices and Conversions
089900200529     C           WWREFN    SETLLSECOEXL1
090000200529     C           WWREFN    READESECOEXL1                 89
090100200529     C                     MOVE MJOPTN    WWOPTN
090200200529     C                     MOVEL'SECOEXL1'DBFILS
090300200529      *
090400200529      ***  If record not found, handle Database Error.
090500200529      *
090600200529     C           *IN89     IFEQ '1'
090700200529     C                     Z-ADD001       DBASE   30       ***************
090800200529     C                     MOVELDBFILS    DBFILE 10        * DB ERROR 01 *
090900200529     C                     MOVELWWREFN    DBKEY  29        ***************
091000200529     C                     EXSR *PSSR
091100200529     C                     ENDIF
091200200529      *
091300200529      ***  If Processing Type = Non Financial Events or Name Chamges, set Option Number to 01.
091400200529      ***  For Currency Changes, set it to 01.                            CEU017
091500200529      *
091600200529     C           WWPTYP    WHEQ 'NC'                       Name Changes
091700200529     C                     MOVE '01'      WWOPTN
091800200529      *
091900200529     C           WWPTYP    WHEQ 'NF'
092000200529     C                     MOVE '01'      WWOPTN           Non Financial Events
092100200529      *                                                                   CEU017
092200200529     C           WWPTYP    WHEQ 'CC'                                      CEU017
092300200529     C                     MOVE '01'      WWOPTN           Ccy Changes    CEU017
092400200529     C                     ENDSL
092500200529      *
092600200529     C                     ENDIF
092700200529      *
092800200529      ***  Setup Option Number retrieve or received as parameter for key field.
092900200529      *
093000200529     C                     MOVE WWOPTN    WWOPNB  20
093100200529      *
093200200529      ***  Setup common screen fields.
093300200529      *
093400200529     C                     MOVE WWREFN    DDREF3           CO Reference
093500200529     C                     MOVE WWSECN    DDSEC3           Security Shortname
093600200529     C                     MOVE WWCOAT    DDATP3           Corporate Action Type
093700200529     C                     MOVE WWOPNB    DDOPT3           Option Number
093800200529     C                     MOVELWWDDPT    DDDEP3           Depot
093900200529     C                     MOVE WWEXPO    DDEDP3           Ex-date position
094000200529     C                     MOVE WWCOAD    DDLTA3           Last Allocation Date
094100200529     C                     MOVE WWSTAT    DDSTS3           Corporate Action Status
094200200529     C                     MOVE WWFINA    DDFLA3           Final Allocation Indicator
094300200529     C                     MOVE WWNCCY    DDNCC3           Nominal Currency
094400200529     C                     MOVE WWBRCD    DDBRC3           Branch
094500200529     C                     TIME           ##TME   60       Screen time.
094600200529      *
094700200529     C           WWEXDT    IFEQ *BLANKS
094800200529     C           WWEXDT    OREQ *ZEROS
094900200529     C                     MOVE *BLANKS   DDEXD3           Ex-Date
095000200529     C                     ELSE
095100200529     C                     MOVE WWEXDT    ZDAYNO
095200200529     C                     EXSR ZDATE2
095300200529     C                     MOVE ZDATE     DDEXD3           Ex-Date
095400200529     C                     ENDIF
095500200529      *
095600200529      ***  Access Customer details file to retrieve Depot Name.
095700200529      *
095800200529     C                     MOVE *BLANKS   WLKEYC
095900200529     C                     MOVELWWDDPT    WLKEYC
096000200529     C                     CALL 'AOCUSTR0'
096100200529     C                     PARM '*DBERR'  WLRTCD
096200200529     C                     PARM '*KEY   ' WLOPTN
096300200529     C                     PARM           WLKEYC 10
096400200529     C                     PARM *BLANKS   WLKYST  7
096500200529     C           SDCUST    PARM SDCUST    DSSDY
096600200529      *
096700200529      ***  If record not found, handle Database Error.
096800200529      *
096900200529     C           WLRTCD    IFNE *BLANKS
097000200529     C                     Z-ADD002       DBASE            ***************
097100200529     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 02 *
097200200529     C                     MOVELWWDDPT    DBKEY            ***************
097300200529     C                     EXSR *PSSR
097400200529     C                     ENDIF
097500200529     C                     MOVELBBCSSN    DDDEPS           Depot Name
097600200529      *
097700200529     C                     MOVE TXT,3     ##CTX1           Command keys
097800200529      *
097900200529      ***  Setup Action Code to blank and reset error indicators of subfile record.
098000200529      *
098100200529     C                     MOVE *BLANKS   DDACN3
098200200529     C                     MOVEA'0000'    *IN,58
098300200529      *
098400200529      ***  Access Bank Details file.
098500200529      *
098600200529     C                     CALL 'AOBANKR0'
098700200529     C                     PARM *BLANKS   WLRTCD  7
098800200529     C                     PARM '*FIRST'  WLOPTN  7
098900200529     C           SDBANK    PARM SDBANK    DSSDY
099000200529      *
099100200529      ***  If record not found, handle Database Error.
099200200529      *
099300200529     C           WLRTCD    IFNE *BLANKS
099400200529     C                     Z-ADD003       DBASE            ***************
099500200529     C                     MOVEL'SDBANKPD'DBFILE           * DB ERROR 03 *
099600200529     C                     MOVEL*BLANKS   DBKEY            ***************
099700200529     C                     EXSR *PSSR
099800200529     C                     ENDIF
099900200529      *
100000200529     C                     MOVELUSER      USIDXX           User Id.
100100200529     C                     MOVELJOB       WSID             Work Station Name
100200200529     C                     MOVE BJMRDT    ##MRDT           Midas run Date
100300200529      *
100400200529      ***  Check System Date Format, DDMMYY (*IN98 off)
100500200529      ***                            MMDDYY (*IN98 on).
100600200529      *
100700200529     C                     MOVE '0'       *IN98
100800200529     C           BJDFIN    IFEQ 'M'
100900200529     C                     MOVE '1'       *IN98
101000200529     C                     ENDIF
106300200529      *                                                                   136935
106400200529      ***  Call Access Program for Securities Trading Details to retrieve 136935
106500200529      ***  field 'Allocate Difference to Dummy' and Dummy Customer.       136935
106600200529      *                                                                   136935
106700200529     C                     CALL 'AOSTRDR0'                                136935
106800200529     C                     PARM *BLANKS   WLRTCD                          136935
106900200529     C                     PARM '*FIRST'  WLOPTN                          136935
107000200529     C           SDSTRD    PARM SDSTRD    DSSDY                           136935
107100200529      *                                                                   136935
107200200529      ***  Handle Database Error.                                         136935
107300200529      *                                                                   136935
107400200529     C           WLRTCD    IFNE *BLANKS                                   136935
107500200529     C                     Z-ADD023       DBASE            ***************136935
107600200529     C                     MOVEL'SDSTRDPD'DBFILE           * DB ERROR 23 *136935
107700200529     C                     MOVEL*BLANKS   DBKEY            ***************136935
107800200529     C                     EXSR *PSSR                                     136935
107900200529     C                     ENDIF                                          136935
108000200529     C********** BVALDC    IFEQ 'Y'                                136935 155856
108100200529     C           WWPTYP    IFEQ 'CC'                                      155856
108200200529     C           WWPTYP    ORNE 'CC'                                      155856
108300200529     C           BVALDC    ANDEQ'Y'                                       155856
108400200529     C                     MOVE BVERCU    WWERCU                          136935
113900200529     C                     ENDIF                                          136935
114000200529      *
114100200529      ***  Retrieve Event Currency, Event Security Decimal Places and Event Price Basis.
114200200529      *
114300200529     C                     MOVE WWSECN    KSECN  10
114400200529     C                     EXSR ACCSEC
114500200529     C                     MOVE NMCY      WNMCYO  3        Event Currency
114600200529     C                     MOVE NMCY      DDNCC3           Event Currency for screen
114700200529     C                     Z-ADDNMDP      WNMDPO  10       Event Security Decimal Places
114800200529     C                     MOVE SPBS      WSPBSO  1        Event Price Basis
114900200529      *
115000200529      ***  Retrieve Event Currency Decimal Places by calling access objet.
115100200529      *
115200200529     C                     CALL 'AOCURRR0'
115300200529     C                     PARM '*MSG   ' WLRTCD
115400200529     C                     PARM '*KEY   ' WLOPTN
115500200529     C                     PARM NMCY      WLAJCD  3
115600200529     C           SDCURR    PARM SDCURR    DSSDY
115700200529      *
115800200529      ***  If record not found, handle Database Error.
115900200529      *
116000200529     C           WLRTCD    IFNE *BLANKS
116100200529     C                     Z-ADD004       DBASE            ***************
116200200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 04 *
116300200529     C                     MOVELWLAJCD    DBKEY            ***************
116400200529     C                     EXSR *PSSR
116500200529     C                     ENDIF
116600200529     C                     Z-ADDA6NBDP    NMDPCO  10       Event Currency Decimal Places
116700200529      *                                                                   136930
116800200529     C           WWREFN    CHAINSECORFL1             89                   136930
116900200529      *                                                                   136930
117000200529     C           *IN89     IFEQ '1'                                       136930
117100200529     C                     Z-ADD022       DBASE            ***************136930
117200200529     C                     MOVEL'SECORFL1'DBFILE           * DB ERROR 22 *136930
117300200529     C                     MOVELWWREFN    DBKEY            ***************136930
117400200529     C                     EXSR *PSSR                                     136930
117500200529     C                     ENDIF                                          136930
117600200529      *                                                                   CSE020
117700200529      ** If CA is a child, obtain the Security from the Originating CA    CSE020
117800200529      *                                                                   CSE020
117900200529     C           MAPREF    IFNE *BLANKS                                   CSE020
118000200529     C           MAPREF    CHAINSECORFL9             70                   CSE020
118100200529      *                                                                   CSE020
118200200529     C           *IN70     IFEQ *ON                                       CSE020
118300200529     C           *LOCK     IN   LDA                                       CSE020
118400200529     C                     Z-ADD027       DBASE            ***************CSE020
118500200529     C                     MOVEL'SECORFL9'DBFILE           * DB ERROR 027*CSE020
118600200529     C                     MOVELMAPREF    DBKEY            ***************CSE020
118700200529     C                     OUT  LDA                                       CSE020
118800200529     C                     EXSR *PSSR                                     CSE020
118900200529     C                     ENDIF                                          CSE020
119000200529      *                                                                   CSE020
119100200529     C           MNPREF    DOWNE*BLANKS                                   CSE020
119200200529     C           MNPREF    CHAINSECORFL9             70                   CSE020
119300200529     C           *IN70     IFEQ *ON                                       CSE020
119400200529     C           *LOCK     IN   LDA                                       CSE020
119500200529     C                     Z-ADD028       DBASE            ***************CSE020
119600200529     C                     MOVEL'SECORFL9'DBFILE           * DB ERROR 028*CSE020
119700200529     C                     MOVELMNPREF    DBKEY            ***************CSE020
119800200529     C                     OUT  LDA                                       CSE020
119900200529     C                     EXSR *PSSR                                     CSE020
120000200529     C                     ENDIF                                          CSE020
120100200529     C                     ENDDO                                          CSE020
120200200529     C                     MOVE MNSESN    WOSESN 10                       CSE020
120300200529      *                                                                   CSE020
120400200529      ** Save Security of the Child CA. Use Security obtained from the    CSE020
120500200529      ** originating CA instead.                                          CSE020
120600200529      *                                                                   CSE020
120700200529     C                     MOVE WWSECN    WKSESN 10                       CSE020
120800200529     C                     MOVE WOSESN    WWSECN                          CSE020
120900200529     C                     ENDIF                                          CSE020
121000200529      *                                                                   136930
121100200529      ***  SETGT on LF/SEDPOHL0 with Branch, Depot, Security and Ex-Date. 136930
121200200529      *                                                                   136930
121300200529     C           KEY6      SETGTSEDPOHL0                                  136930
121400200529      *                                                                   136930
121500200529      ***  Read previous record on LF/SEDPOHL0                            136930
121600200529      *                                                                   136930
121700200529     C                     READPSEDPOHL0                 89               136930
121800200529      *                                                                   136360
121900200529      ***  If record read...                                              136930
122000200529      *                                                                   136930
122100200529     C           *IN89     IFEQ '0'                                       136930
122200200529      *                                                                   136930
122300200529      ***  For the same Security, Branch and Depot                        136930
122400200529      *                                                                   136930
122500200529     C           DSSC      IFEQ WWSECN                                    136930
122600200529     C           DSBA      ANDEQWWBRCD                                    136930
122700200529     C           DDPT      ANDEQWWDDPT                                    136930
122800200529     C                     MOVE *BLANKS   ZFLD15                          136930
122900200529      *                                                                   CSE020
123000200529      ** If CA is a child, override Ex-date position with the sum of      CSE020
123100200529      ** the Actual Stock Allocation of the Parent CA.                    CSE020
123200200529      *                                                                   CSE020
123300200529     C           MAPREF    IFNE *BLANKS                                   CSE020
123400200529     C                     MOVE WKSESN    WWSECN                          CSE020
123500200529     C                     Z-ADD*ZERO     WKASTA 150                      CSE020
123600200529     C           KEY8      SETLLSECOALL5                                  CSE020
123700200529     C           KEY8      READESECOALL5                 70               CSE020
123800200529     C           *IN70     DOWEQ*OFF                                      CSE020
123900200529     C           M5SESN    IFEQ WWSECN                                    CSE020
124000200529     C                     ADD  M5ASTA    WKASTA                          CSE020
124100200529     C                     ENDIF                                          CSE020
124200200529     C           KEY8      READESECOALL5                 70               CSE020
124300200529     C                     ENDDO                                          CSE020
124400200529     C                     Z-ADDWKASTA    ZFLD15                          CSE020
124500200529      *                                                                   CSE020
124600200529     C                     ELSE                                           CSE020
124700200529      *                                                                   CSE020
124800200529     C           MATDVD    IFEQ 'V'                                       136930
124900200529     C                     MOVE DSNV      ZFLD15                          136930
125000200529     C                     ELSE                                           136930
125100200529     C***********MATDVD    IFEQ 'T'                                136930 CSE020
125200200529     C                     MOVE DSNT      ZFLD15                          136960
125300200529     C                     ENDIF                                          136930
125400200529     C                     ENDIF                                          CSE020
125500200529      *                                                                   CSE020
125600200529     C                     Z-ADDWNMDPO    ZDECS                           136930
125700200529     C                     MOVE 'L'       ZECODE                          136930
125800200529     C                     EXSR ZSEDIT                                    136930
125900200529     C                     MOVE ZOUT21    WUEXPO 17                       136930
126000200529     C***********          ENDIF                                   136930 CSE020
126100200529     C                     ENDIF                                          136930
126200200529     C                     ENDIF                                          136930
126300200529      *                                                                   136930
126400200529      ***  If Ex-Date Position different from Depot Position file and     136930
126500200529      ***  Allocation file, blink on screen.                              136930
126600200529      *                                                                   136930
126700200529     C                     MOVE *OFF      *IN62                           CSE020
126800200529     C           WWEXPO    IFNE WUEXPO                                    136930
126900200529     C                     MOVE '1'       *IN62                           136930
127000200529     C                     ENDIF                                          136930
127100200529      *
127200200529     C                     MOVE *BLANKS   WUNSEC 10
127300200529      *
127400200529      ***  If Processing Type not Corporate Reorganisation.
127500200529      *
127600200529     C           WWPTYP    IFNE 'CR'
127700200529      *
127800200529      ***  Retrieve New Security Shortname on Corporate Actions Detail file, not for Processing
127900200529      ***  Type Capital Changes, where New Security = Event Security.
128000200529      *
128100200529     C                     SELEC
128200200529     C           WWPTYP    WHEQ 'DV'                       Divedend Events
128300200529     C           KEY3      SETGTSECODVL1
128400200529     C           KEY3      REDPESECODVL1                 89
128500200529     C                     MOVE MDNSEC    WUNSEC
128600200529     C                     MOVEL'SECODVL1'DBFILS
128700200529      *
128800200529     C           WWPTYP    WHEQ 'FR'                       Free Allocation
128900200529     C           KEY3      SETGTSECOFRL1
129000200529     C           KEY3      REDPESECOFRL1                 89
129100200529     C                     MOVE MENSEC    WUNSEC
129200200529     C                     MOVEL'SECOFRL1'DBFILS
129300200529      *
129400200529     C           WWPTYP    WHEQ 'RG'                       Rights Issues
129500200529     C           KEY3      SETGTSECORGL1
129600200529     C           KEY3      REDPESECORGL1                 89
129700200529     C                     MOVE MFNSEC    WUNSEC
129800200529     C                     MOVEL'SECORGL1'DBFILS
129900200529      *
130000200529     C           WWPTYP    WHEQ 'OF'                       Offers
130100200529     C           KEY3      SETGTSECOOFL1
130200200529     C           KEY3      REDPESECOOFL1                 89
130300200529     C                     MOVE MINSEC    WUNSEC
130400200529     C                     MOVEL'SECOOFL1'DBFILS
130500200529      *
130600200529     C           WWPTYP    WHEQ 'EX'                       Exercices and Conversions
130700200529     C           KEY3      SETGTSECOEXL1
130800200529     C           KEY3      REDPESECOEXL1                 89
130900200529     C                     MOVE MJNSEC    WUNSEC
131000200529     C                     MOVEL'SECOEXL1'DBFILS
131100200529      *
131200200529     C           WWPTYP    WHEQ 'NC'                       Name Changes   135690
131300200529     C           WWREFN    SETGTSECONCL1                                  135690
131400200529     C           WWREFN    REDPESECONCL1                 89               135690
131500200529     C                     MOVE MLSESN    WUNSEC                          135690
131600200529     C                     MOVEL'SECONCL1'DBFILS                          135690
131700200529      *                                                                   135690
131800200529     C           WWPTYP    WHEQ 'CC'                       Currency       CEU017
131900200529     C           WWREFN    SETGTSECOCCL2                   Changes        CEU017
132000200529     C           WWREFN    REDPESECOCCL2                 89               CEU017
132100200529     C                     MOVE NANSEC    WUNSEC                          CEU017
132200200529     C                     MOVEL'SECOCCL2'DBFILS                          CEU017
132300200529      *                                                                   CEU017
132400200529      ***  If record not found, handle Database Error.
132500200529      *
132600200529     C           *IN89     IFEQ '1'
132700200529     C                     Z-ADD005       DBASE            ***************
132800200529     C                     MOVELDBFILS    DBFILE           * DB ERROR 05 *
132900200529     C           WWPTYP    IFEQ 'CC'                       ***************
133000200529     C                     MOVELWWREFN    DBKEY
133100200529     C                     ELSE
133200200529     C                     MOVELWWREFN    DBKEY1
133300200529     C                     MOVE WWOPNB    DBKEY1
133400200529     C                     MOVELDBKEY1    DBKEY
133500200529     C                     ENDIF
133600200529     C                     EXSR *PSSR
133700200529     C                     ENDIF
133800200529     C                     ENDSL
133900200529      *
134000200529     C           WUNSEC    IFNE *BLANKS
134100200529      *
134200200529      ***  If Processing Type with New Security entered (else, New Security = Event Security),
134300200529      ***  retrieve New Currency.
134400200529      *
134500200529     C                     MOVE WUNSEC    KSECN  10
134600200529     C                     EXSR ACCSEC
134700200529      *
134800200529      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
134900200529      *
135000200529     C                     CALL 'AOCURRR0'
135100200529     C                     PARM '*MSG   ' WLRTCD
135200200529     C                     PARM '*KEY   ' WLOPTN
135300200529     C                     PARM NMCY      WLAJCD  3
135400200529     C           SDCURR    PARM SDCURR    DSSDY
135500200529      *
135600200529      ***  If record not found, handle Database Error.
135700200529      *
135800200529     C           WLRTCD    IFNE *BLANKS
135900200529     C                     Z-ADD006       DBASE            ***************
136000200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 06 *
136100200529     C                     MOVELWLAJCD    DBKEY            ***************
136200200529     C                     EXSR *PSSR
136300200529     C                     ENDIF
136400200529     C                     Z-ADDA6NBDP    NMDPCN  10       New Currency Decimal Places
136500200529     C                     ELSE
136600200529      *
136700200529      ***  If Processing Type with no New Security entered (New Security = Event Security),
136800200529      ***  set New Currency Decimal Places to Event Currency Decimal Places.
136900200529      *
137000200529     C                     Z-ADDNMDPCO    NMDPCN  10       New Currency Decimal Places
137100200529     C                     ENDIF
137200200529     C                     ENDIF
137300200529      *
137400200529      ***  Select the program MSGQ for error messages.
137500200529      *
137600200529     C                     MOVEL'*'       TOPQ   10
137700200529     C                     MOVEL'*PRV'    TOPRQ   5
137800200529     C                     MOVEL'SEUSRMSG'PMSGF  10
137900200529      *
138000200529      ***  Setup fields for subroutine ZASNMS.
138100200529      *
138200200529     C                     MOVEL'SE7593 ' ZAPGM  10        Message queue
138300200529     C                     MOVEL'SEUSRMSG'ZAMSGF 10        Message file
138400200529     C                     MOVEL*BLANK    ZAPGRL  5        Rel queue
138500200529     C                     MOVEL*BLANK    ZAMSID  7        Message Id.
138600200529     C                     MOVEL*BLANK    ZAMSDA132        Message data.
138700200529     C                     MOVEL*BLANK    ZAMSTP  7        Message type.
138800200529      *                                                                   CAP137
138900200529      ** Check if API Securities New Screen Input is installed.           CAP137
139000200529      *                                                                   CAP137
139100200529     C                     CALL 'AOSARDR0'                                CAP137
139200200529     C                     PARM *BLANKS   WLRTCD                          CAP137
139300200529     C                     PARM '*VERIFY' WLOPTN                          CAP137
139400200529     C                     PARM 'CAP137'  PSARD   6                       CAP137
139500200529     C           SCSARD    PARM SCSARD    DSFDY                           CAP137
139600200529      *                                                                   CAP137
139700200529      ** An NRF (No Record Found) return code is valid.                   CAP137
139800200529      ** Issue database error only for error return codes.                CAP137
139900200529      *                                                                   CAP137
140000200529     C           WLRTCD    IFNE *BLANKS                                   CAP137
140100200529     C           WLRTCD    ANDNE'*NRF   '                                 CAP137
140200200529     C           *LOCK     IN   LDA                                       CAP137
140300200529     C                     Z-ADD27        DBASE                           CAP137
140400200529     C                     MOVEL'SCSARDPD'DBFILE                          CAP137
140500200529     C                     MOVEL'CAP137'  DBKEY                           CAP137
140600200529     C                     OUT  LDA                                       CAP137
140700200529     C                     EXSR *PSSR                                     CAP137
140800200529     C                     ENDIF                                          CAP137
140900200529      *                                                                   CAP137
141000200529     C           WLRTCD    IFEQ *BLANK                                    CAP137
141100200529     C                     MOVEL'Y'       CAP137  1                       CAP137
141200200529     C                     MOVEL'SESECS'  PPGM    9                       CAP137
141300200529     C                     MOVE 'SIN'     PPGM                            CAP137
141400200529     C                     ELSE                                           CAP137
141500200529     C                     MOVEL'N'       CAP137                          CAP137
141600200529     C                     MOVE *BLANKS   PPGM                            CAP137
141700200529     C                     ENDIF                                          CAP137
141800200529     C/COPY WNCPYSRC,SEH00033
141900200529      *
142000200529     C                     ENDSR
142100200529      *
142200200529      *****************************************************************
142300200529      /EJECT
142400200529      *****************************************************************
142500200529      *                                                               *
142600200529      *  P002   - Detail processing.                                  *
142700200529      *                                                               *
142800200529      *  Called by: Main processing.                                  *
142900200529      *                                                               *
143000200529      *  Calls: P004     - Build the subfile (Amend Mode).            *
143100200529      *         P005     - Validation of the subfile (Amend Mode).    *
143200200529      *         ZASNMS   - Send message to program message queue.     *
143300200529      *         Y2CLMSC  - Midas ABS Clear specific program message   *
143400200529      *                    queue.                                     *
143500200529      *                                                               *
143600200529      *****************************************************************
143700200529      *
143800200529     C           P002      BEGSR                           ** P002 SR **
143900200529      *
144000200529      ***  Set 'First Time' flag to 'Y'.
144100200529      *
144200200529     C                     MOVE 'Y'       FIRSTA  1
144300200529      *
144400200529      ***  Do until F3: Exit or F12: Previous screen is pressed.
144500200529      *
144600200529     C           *INKC     DOUEQ'1'
144700200529     C           *INKL     OREQ '1'
144800200529      *
144900200529      ***  Check if First Time or F5: Refresh is pressed.
145000200529      *
145100200529     C           FIRSTA    IFEQ 'Y'
145200200529     C           *INKE     OREQ '1'
145300200529      *
145400200529      ***  Initialise subfile.
145500200529      *
145600200529     C                     MOVE '1'       *IN82
145700200529     C                     WRITESE7593C1
145800200529     C                     MOVEA'00'      *IN,82
145900200529     C                     Z-ADD0         #1RRN
146000200529     C                     Z-ADD0         #1RRNS  40
146100200529      *
146200200529      ***  Build the first subfile page.
146300200529      *
146400200529     C                     MOVE '0'       *IN85
146500200529     C                     EXSR P004
146600200529     C                     Z-ADD#1RRN     #1RRNS
146700200529      *
146800200529     C           FIRSTA    IFEQ 'Y'
146900200529     C                     MOVE '1'       *INKE
147000200529     C                     ENDIF
147100200529      *
147200200529     C                     MOVE 'N'       FIRSTA
147300200529     C                     Z-ADD3         CTR2
147400200529     C                     Z-ADD1         #1RRN
147500200529      *
147600200529     C                     ENDIF
147700200529      *
147800200529      ***  If Roll Up is pressed and no error.
147900200529      *
148000200529     C           *IN25     IFEQ '1'
148100200529     C                     Z-ADD#1RRNS    #1RRN
148200200529     C                     Z-ADD#1RRNS    WWRRN   40
148300200529      *
148400200529      ***  Build the next subfile page.
148500200529      *
148600200529     C                     MOVE '0'       *IN85
148700200529     C                     EXSR P004
148800200529     C                     Z-ADD#1RRN     #1RRNS
148900200529      *                                                                   153731
149000200529     C           WWPTYP    IFEQ 'CR'                                      153731
149100200529     C           WNEWPG    ANDEQ'Y'                                       153731
149200200529     C           WWPTYP    ORNE 'CR'                                      153731
149300200529     C           WWRRN     ADD  1         #1RRN
149400200529     C                     ELSE                                           153731
149500200529     C                     Z-ADDW1RRN     #1RRN                           153731
149600200529     C                     ENDIF                                          153731
149700200529      *                                                                   153731
149800200529     C                     ENDIF
149900200529      *
150000200529      ***  Display subfile on screen.
150100200529      *
150200200529     C                     WRITE#MSGCTL                    Program messages
150300200529     C                     WRITESE7593F0                   Command keys
150400200529     C                     EXFMTSE7593C1                   Subfile
150500200529      *
150600200529     C                     Z-ADD#1RRN     W1RRN   40
150700200529      *
150800200529      ***  Clear messages from program message quque.
150900200529      *
151000200529     C                     CALL 'Y2CLMSC'
151100200529     C                     PARM ##PGM     ZAPGM  10
151200200529     C                     PARM '*SAME'   ZAPGRL  5
151300200529      *
151400200529      ***  If F20: Exit without saving taken.
151500200529      *
151600200529     C           *IN20     IFEQ '1'
151700200529      *
151800200529     C                     MOVE TXT,5     ##CTX1           Setup command keys
151900200529     C                     MOVE *BLANKS   DDEXIT           Confirmation fields
152000200529     C                     MOVE '0'       *IN59            Error indicator
152100200529      *
152200200529      ***  Do while no error.
152300200529      *
152400200529     C           DDEXIT    DOWNE'Y'
152500200529     C           DDEXIT    ANDNE'N'
152600200529      *
152700200529      ***  Setup screen time.
152800200529      *
152900200529     C                     TIME           ##TME            Screen time.
153000200529      *
153100200529      ***  Execute screen confirmation format.
153200200529      *
153300200529     C                     WRITE#MSGCTL                    Program messages
153400200529     C                     WRITESE7593F0                   Command keys
153500200529     C                     EXFMTSE7593F2                   Confirmation screen
153600200529      *
153700200529      ***  Clear messages from program message queue.
153800200529      *
153900200529     C                     CALL 'Y2CLMSC'
154000200529     C                     PARM ##PGM     ZAPGM  10
154100200529     C                     PARM '*SAME'   ZAPGRL  5
154200200529      *
154300200529      ***  Confirmation field must equal 'Y' or 'N'.
154400200529      *
154500200529     C           DDEXIT    IFNE 'N'
154600200529     C           DDEXIT    ANDNE'Y'
154700200529     C                     MOVE '1'       *IN59            Reverse image
154800200529     C                     MOVEL'CO00032' ZAMSID           Message id.
154900200529     C                     EXSR ZASNMS                     Send message
155000200529     C                     ELSE
155100200529     C                     MOVE '0'       *IN59            Reverse image
155200200529     C                     ENDIF
155300200529     C                     ENDDO
155400200529      *
155500200529      ***  Setup INKC = F3: Exit.
155600200529      *
155700200529     C                     MOVE '1'       *INKC
155800200529      *
155900200529      ***  If Exit without saving confirmed, rollback changed records.
156000200529      *
156100200529     C           DDEXIT    IFEQ 'Y'
156200200529     C                     MOVE 'N'       WWUPDT
156300200529     C                     ROLBK
156400200529      *
156500200529      ***  If Exit without saving not confirmed, comit changed records.
156600200529      *
156700200529     C                     ELSE
156800200529     C                     COMIT
156900200529     C                     ENDIF
157000200529     C                     ENDIF
157100200529      *
157200200529      ***  If ENTER taken.
157300200529      *
157400200529     C           *INKC     IFEQ '0'                        Not F3: Exit
157500200529     C           *INKL     ANDEQ'0'                        Not F12: Previous screen
157600200529     C           *INKE     ANDEQ'0'                        Not F5: Refresh
157700200529     C           *IN20     ANDEQ'0'                        Not F20: Exit without saving
157800200529     C           *IN25     ANDEQ'0'                        Not Rollup
157900200529      *
158000200529      ***  Validate subfile records.
158100200529      *
158200200529     C                     EXSR P005
158300200529     C                     ENDIF
158400200529      *
160700200529     C                     ENDDO
160800200529      *
160900200529     C                     ENDSR
161000200529      *
161100200529      *****************************************************************
161200200529      /EJECT
161300200529      *****************************************************************
161400200529      *                                                               *
161500200529      *  P003   - Termination processing.                             *
161600200529      *                                                               *
161700200529      *  Called by: Main processing.                                  *
161800200529      *                                                               *
161900200529      *  Calls: None.                                                 *
162000200529      *                                                               *
162100200529      *****************************************************************
162200200529      *
162300200529     C           P003      BEGSR                           ** P003 SR **
162400200529      *
162500200529      ***  If F3: Exit taken.
162600200529      *
162700200529     C           *INKC     IFEQ '1'
162800200529     C                     MOVE '3'       WWRTCD
162900200529      *
163000200529      ***  Comit changed records.
163100200529      *
163200200529     C                     COMIT
163300200529     C                     ENDIF
163400200529      *
163500200529      ***  If F12: Previous screen taken.
163600200529      *
163700200529     C           *INKL     IFEQ '1'
163800200529     C                     MOVE '2'       WWRTCD
163900200529      *
164000200529      ***  Comit changed records.
164100200529      *
164200200529     C                     COMIT
164300200529     C                     ENDIF
164400200529      *
164500200529      ***  Return to previous program.
164600200529      *
164700200529     C                     RETRN
164800200529     C                     MOVE '1'       *INLR
164900200529      *
165000200529     C                     ENDSR
165100200529      *
165200200529      *****************************************************************
165300200529      /EJECT
165400200529      *****************************************************************
165500200529      *                                                               *
165600200529      *  P004   - Build the subfile (Amend Mode).                     *
165700200529      *                                                               *
165800200529      *  Called by: P002   - Detail processing.                       *
165900200529      *                                                               *
166000200529      *  Calls: P009     - Move file fields to screen fields for      *
166100200529      *                    New Security.                              *
166200200529      *         P010     - Move file fields to screen fields for      *
166300200529      *                    Security '**CASH**'.                       *
166400200529      *         U002     - Load fields for file SECODPL3 with all     *
166500200529      *                    amounts = 0.                               *
166600200529      *         ACCSEC   - Access Security details file.              *
166700200529      *         CSBPR    - Calculate Subscription Price if            *
166800200529      *                    Subscription Price entered as Market for   *
166900200529      *                    Dividend Events.                           *
167000200529      *         *PSSR    - Error processing.                          *
167100200529      *         AOCURRR0 - Midas AO Currency codes access object.     *
167200200529      *                                                               *
167300200529      *****************************************************************
167400200529      *
167500200529     C           P004      BEGSR                           ** P004 SR **
167600200529      *
167700200529      ***  If Rollup taken.
167800200529      *
167900200529     C           *IN25     IFEQ '1'
168000200529     C                     ADD  3         CTR2    20
168100200529     C                     ENDIF
168200200529      *
168300200529      ***  Setup key fields.
168400200529      *
168500200529     C                     MOVELDDBRC3    WWBRCA           Branch
168600200529     C                     MOVELDDDEP3    WWDPOT           Depot
168700200529      *
168800200529      ***  If first time or F5: Refresh taken, first subfile record must be for Cash Line.
168900200529      *
169000200529     C           FIRSTA    IFEQ 'Y'
169100200529     C           *INKE     OREQ '1'
169200200529     C                     MOVEL'**CASH**'WWSECS    P      Security
169300200529      *
169400200529      ***  Process Cash Line.
169500200529      *
169600200529     C           KEY2      CHAINSECODPL3             31
169700200529      *
169800200529     C           *IN31     IFEQ '1'
169900200529     C                     EXSR U002
170000200529     C                     WRITESECODPD0
170100200529     C                     ENDIF
170200200529      *
170300200529     C                     MOVELCNSARR,1  DDTXT1           title 1st line = 'Cash'
170400200529     C                     MOVELCNSARR,2  DDTXT2           title 2nd line = 'Cash Opt/Allocat'
170500200529     C                     MOVELCNSARR,3  DDTXT3           title 3rd line = 'Cash Rounding'
170600200529     C                     MOVE *BLANKS   DDTXT4           title 4th line = blank
170700200529     C                     MOVE *BLANKS   DDORG4           original 4th line =  blank
170800200529     C                     MOVE *BLANKS   DDACT4           actual 4th line = blank
170900200529     C                     MOVE *BLANKS   DDAC4H           actual 4th line hidden field = blank
171000200529     C                     MOVE *BLANKS   DDBLD4           Balancing Diff. 4th line = blank
171100200529     C                     MOVE *BLANKS   DDNSEC           New Security = blank
171200200529      *
171300200529      ***  Move values for Cash Line record.
171400200529      *
171500200529     C                     Z-ADD1         CTR1    20       Set meter to 1
171600200529      *
171700200529      ***  If Processing Type not Corporate Reorganisation.
171800200529      *
171900200529     C           WWPTYP    IFNE 'CR'
172000200529      *
172100200529      ***  Retrieve New Security Shortname on Corporate Actions Detail file, not for Processing
172200200529      ***  Type Capital Changes, where New Security = Event Security.
172300200529      *
172400200529     C                     MOVE *BLANKS   WUNSEC
172500200529     C                     SELEC
172600200529     C           WWPTYP    WHEQ 'DV'                       Divedend Events
172700200529     C           KEY3      SETGTSECODVL1
172800200529     C           KEY3      REDPESECODVL1                 89
172900200529     C                     MOVE MDNSEC    WUNSEC
173000200529     C                     MOVEL'SECODVL1'DBFILS
173100200529      *
173200200529     C           WWPTYP    WHEQ 'FR'                       Free Allocation
173300200529     C           KEY3      SETGTSECOFRL1
173400200529     C           KEY3      REDPESECOFRL1                 89
173500200529     C                     MOVE MENSEC    WUNSEC
173600200529     C                     MOVEL'SECOFRL1'DBFILS
173700200529      *
173800200529     C           WWPTYP    WHEQ 'RG'                       Rights Issues
173900200529     C           KEY3      SETGTSECORGL1
174000200529     C           KEY3      REDPESECORGL1                 89
174100200529     C                     MOVE MFNSEC    WUNSEC
174200200529     C                     MOVEL'SECORGL1'DBFILS
174300200529      *
174400200529     C           WWPTYP    WHEQ 'OF'                       Offers
174500200529     C           KEY3      SETGTSECOOFL1
174600200529     C           KEY3      REDPESECOOFL1                 89
174700200529     C                     MOVE MINSEC    WUNSEC
174800200529     C                     MOVEL'SECOOFL1'DBFILS
174900200529      *
175000200529     C           WWPTYP    WHEQ 'EX'                       Exercices and Conversions
175100200529     C           KEY3      SETGTSECOEXL1
175200200529     C           KEY3      REDPESECOEXL1                 89
175300200529     C                     MOVE MJNSEC    WUNSEC
175400200529     C                     MOVEL'SECOEXL1'DBFILS
175500200529      *
175600200529     C           WWPTYP    WHEQ 'NC'                       Name Changes   135690
175700200529     C           WWREFN    SETGTSECONCL1                                  135690
175800200529     C           WWREFN    REDPESECONCL1                 89               135690
175900200529     C                     MOVE MLSESN    WUNSEC                          135690
176000200529     C                     MOVEL'SECONCL1'DBFILS                          135690
176100200529      *                                                                   135690
176200200529     C           WWPTYP    WHEQ 'CC'                       Currency       CEU017
176300200529     C           WWREFN    SETGTSECOCCL2                   Changes        CEU017
176400200529     C           WWREFN    REDPESECOCCL2                 89               CEU017
176500200529     C                     MOVE NANSEC    WUNSEC                          CEU017
176600200529     C                     MOVEL'SECOCCL2'DBFILS                          CEU017
176700200529      *                                                                   CEU017
176800200529      ***  If record not found, handle Database Error.
176900200529      *
177000200529     C           *IN89     IFEQ '1'
177100200529     C                     Z-ADD020       DBASE            ***************
177200200529     C                     MOVELDBFILS    DBFILE           * DB ERROR 20 *
177300200529     C           WWPTYP    IFEQ 'CC'                       ***************
177400200529     C           WWPTYP    OREQ 'NC'                                      135690
177500200529     C                     MOVELWWREFN    DBKEY
177600200529     C                     ELSE
177700200529     C                     MOVELWWREFN    DBKEY1
177800200529     C                     MOVE WWOPNB    DBKEY1
177900200529     C                     MOVELDBKEY1    DBKEY
178000200529     C                     ENDIF
178100200529     C                     EXSR *PSSR
178200200529     C                     ENDIF
178300200529     C                     ENDSL
178400200529      *
178500200529      ***  If New Security retrieve not blank.
178600200529      *
178700200529     C           WUNSEC    IFNE *BLANKS
178800200529      *
178900200529      ***  Retrieve New Currency, New Security Decimal Places and New Price Basis.
179000200529      *
179100200529     C                     MOVE WUNSEC    KSECN
179200200529     C                     EXSR ACCSEC
179300200529      *
179400200529     C                     MOVE NMCY      WNMCYN           New Currency
179500200529     C                     Z-ADDNMDP      WNMDPN           New Security Decimal Places
179600200529     C                     MOVE SPBS      WSPBSN  1        Price Basis
179700200529      *
179800200529      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
179900200529      *
180000200529     C                     CALL 'AOCURRR0'
180100200529     C                     PARM '*MSG   ' WLRTCD
180200200529     C                     PARM '*KEY   ' WLOPTN
180300200529     C                     PARM NMCY      WLAJCD
180400200529     C           SDCURR    PARM SDCURR    DSSDY
180500200529      *
180600200529      ***  If record not found, handle Database Error.
180700200529      *
180800200529     C           WLRTCD    IFNE *BLANKS
180900200529     C                     Z-ADD019       DBASE            ***************
181000200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 19 *
181100200529     C                     MOVELWLAJCD    DBKEY            ***************
181200200529     C                     EXSR *PSSR
181300200529     C                     ENDIF
181400200529     C                     Z-ADDA6NBDP    NMDPCN  10       New Currency Decimal Places
181500200529      *
181600200529      ***  Else, if New Security retrieve is blank or No access done (= New Security = Event
181700200529      ***  Security).
181800200529      *
181900200529     C                     ELSE
182000200529      *
182100200529      ***  Set New Currency, New Security and Currency Decimal Places and New Price Basis to Event
182200200529      ***  Values.
182300200529      *
182400200529     C                     MOVE WNMCYO    WNMCYN
182500200529     C                     Z-ADDWNMDPO    WNMDPN
182600200529     C                     MOVE WSPBSO    WSPBSN
182700200529     C                     Z-ADDNMDPCO    NMDPCN
182800200529     C                     ENDIF
182900200529     C                     ENDIF
183000200529      *
183100200529      ***  Move file fields to subfile fields (**CASH**).
183200200529      *
183300200529     C                     EXSR P010
183400200529      *
183500200529      ***  Write a record to the subfile.
183600200529      *
183700200529     C/COPY WNCPYSRC,SEH00034
183800200529     C                     MOVE '1'       *IN45            Display 'CASH' fields
183900200529     C                     ADD  1         #1RRN      83
184000200529     C                     WRITESE7593S1
184100200529     C/COPY WNCPYSRC,SEH00035
184200200529      *
184300200529     C                     ENDIF
184400200529      *
184500200529      ***  Process New Security lines.
184600200529      *
184700200529      ***  If Processing Type = Corporate Reorganisation.
184800200529      *
184900200529     C           WWPTYP    IFEQ 'CR'
185000200529      *
185100200529     C                     MOVE 'N'       WNEWPG  1
185200200529     C                     MOVE '0'       *IN31
185300200529      *
185400200529      ***  Retrieve the 20 potential New Security.
185500200529      *
185600200529     C           KEY3      CHAINSECOCRL1             89
185700200529      *
185800200529      ***  If record not found, handle Database Error.
185900200529      *
186000200529     C           *IN89     IFEQ '1'
186100200529     C                     Z-ADD007       DBASE            ***************
186200200529     C                     MOVEL'SECOCRL1'DBFILE           * DB ERROR 07 *
186300200529     C                     MOVELWWREFN    DBKEY1  8        ***************
186400200529     C                     MOVE WWOPNB    DBKEY1
186500200529     C                     MOVELDBKEY1    DBKEY
186600200529     C                     EXSR *PSSR
186700200529      *
186800200529      ***  If record found.
186900200529      *
187000200529     C                     ELSE
187100200529     C                     MOVEAMHSECA    SSARR
187200200529      *
187300200529     C                     MOVELCNSARR,4  DDTXT1           title 1st line = New Security
187400200529     C                     MOVELCNSARR,5  DDTXT2           title 2nd line = Stock Allocation
187500200529     C                     MOVELCNSARR,6  DDTXT3           title 3rd line = Stock Rounding
187600200529     C                     MOVELCNSARR,3  DDTXT4           title 4th line = Cash Rounding
187700200529      *
187800200529      ***  If first time, initialise array index to 1 to retrieve first New Security and line
187900200529      ***  counter to 3.
188000200529      *
188100200529     C           FIRSTA    IFEQ 'Y'
188200200529     C           *INKE     OREQ '1'                                       137884
188300200529     C                     Z-ADD1         A       20
188400200529     C                     Z-ADD0         B       20
188500200529     C                     Z-ADD3         CTR2
188600200529      *
188700200529      ***  If not, add 1 to array index to retrieve next New Security.
188800200529      *
188900200529     C                     ELSE
189000200529     C                     Z-ADDB         A
189100200529     C                     ADD  1         A
189200200529     C                     ENDIF
189300200529      *
189400200529      ***  Do until subfile page is full or the 20 potential New Security processed.
189500200529      *
189600200529     C           CTR1      DOUEQCTR2                       Subfile page full
189700200529     C           A         ORGT 20                         20 Potential New Security processed
189800200529      *
189900200529     C           SSARR,A   IFNE *BLANKS
190000200529     C                     MOVELSSARR,A   WWSECS           New Security
190100200529      *
190200200529      ***  Retrieve New Currency, New Security decimal Places and New Price Basis.
190300200529      *
190400200529     C                     MOVE WWSECS    KSECN
190500200529     C                     EXSR ACCSEC
190600200529      *
190700200529     C                     MOVE NMCY      WNMCYN           New Currency
190800200529     C                     Z-ADDNMDP      WNMDPN           New Security Decimal Places
190900200529     C                     MOVE SPBS      WSPBSN  1        New Price Basis
191000200529      *
191100200529      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
191200200529      *
191300200529     C                     CALL 'AOCURRR0'
191400200529     C                     PARM '*MSG   ' WLRTCD
191500200529     C                     PARM '*KEY   ' WLOPTN
191600200529     C                     PARM NMCY      WLAJCD
191700200529     C           SDCURR    PARM SDCURR    DSSDY
191800200529      *
191900200529      ***  If record not found, handle Database Error.
192000200529      *
192100200529     C           WLRTCD    IFNE *BLANKS
192200200529     C                     Z-ADD008       DBASE            ***************
192300200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 08 *
192400200529     C                     MOVELWLAJCD    DBKEY            ***************
192500200529     C                     EXSR *PSSR
192600200529     C                     ENDIF
192700200529     C                     Z-ADDA6NBDP    NMDPCN  10       New Currency Decimal Places
192800200529      *
192900200529      ***  Retrive CO Depot details for the New Security.
193000200529      *
193100200529     C           KEY2      CHAINSECODPL3             31
193200200529      *
193300200529      ***  If record not found, load fields for CO Details file with all amounts = 0 and write a
193400200529      ***  record on SECODPL3.
193500200529      *
193600200529     C           *IN31     IFEQ '1'
193700200529     C                     EXSR U002
193800200529     C                     WRITESECODPD0
193900200529     C                     ENDIF
194000200529      *
194100200529     C                     MOVE *BLANKS   DDACT1           set actual 1st line to blank
194200200529     C                     MOVE *BLANKS   DDBLD1           set Balancing Diff. 1st line to blank
194300200529      *
194400200529     C                     MOVELSSARR,A   DDNSEC           New Security
194500200529      *
194600200529      ***  Move file fields to subfile fields.
194700200529      *
194800200529     C                     EXSR P009
194900200529      *
195000200529      ***  Write a record to the subfile and increment counter.
195100200529      *
195200200529     C                     MOVE '0'       *IN45            Display New Security fields
195300200529     C                     ADD  1         #1RRN      83
195400200529     C                     MOVE 'Y'       WNEWPG
195500200529     C                     WRITESE7593S1
195600200529     C                     ADD  1         CTR1
195700200529     C                     ENDIF
195800200529      *
195900200529      ***  Increment and save array index.
196000200529      *
196100200529     C                     Z-ADDA         B       20
196200200529     C                     ADD  1         A
196300200529      *
196400200529     C           A         IFEQ 20
196500200529     C                     MOVE '1'       *IN31
196600200529     C                     ENDIF
196700200529      *
196800200529     C                     ENDDO
196900200529     C                     ENDIF
197000200529      *
197100200529      ***  Else, if Processing Type = Dividend Events, Free Allocation, Capital Change, Rights
197200200529      ***  Issues, Offers or Exercices and Conversions (= not 'CR').
197300200529      ***  And Currency Changes.                                          CEU017
197400200529      *
197500200529     C                     ELSE
197600200529      *
197700200529     C                     MOVE '1'       *IN31
197800200529      *
197900200529      ***  Chain to LFs according to Processing Type.
198000200529      *
198100200529     C                     SELEC
198200200529     C           WWPTYP    WHEQ 'DV'                       Dividend Events
198300200529     C           KEY3      CHAINSECODVL1             89
198400200529     C                     MOVE 'SECODVL1'DBFILS  8
198500200529      *
198600200529     C           WWPTYP    WHEQ 'FR'                       Free Allocation
198700200529     C           KEY3      CHAINSECOFRL1             89
198800200529     C                     MOVE 'SECOFRL0'DBFILS
198900200529      *
199000200529     C           WWPTYP    WHEQ 'CE'                       Capital Changes
199100200529     C           KEY3      CHAINSECOCEL1             89
199200200529     C                     MOVE 'SECOCEL1'DBFILS
199300200529      *
199400200529     C           WWPTYP    WHEQ 'RG'                       Rights Issues
199500200529     C           KEY3      CHAINSECORGL1             89
199600200529     C                     MOVE 'SECORGL1'DBFILS
199700200529      *
199800200529     C           WWPTYP    WHEQ 'OF'                       Offers
199900200529     C           KEY3      CHAINSECOOFL1             89
200000200529     C                     MOVE 'SECOOFL1'DBFILS
200100200529      *
200200200529     C           WWPTYP    WHEQ 'EX'                       Exercices and Conversions
200300200529     C           KEY3      CHAINSECOEXL1             89
200400200529     C                     MOVE 'SECOEXL1'DBFILS
200500200529      *                                                                   135690
200600200529     C           WWPTYP    WHEQ 'NC'                       Name Changes   135690
200700200529     C           WWREFN    CHAINSECONCL1             89                   135690
200800200529     C                     MOVE 'SECONCL1'DBFILS                          135690
200900200529      *                                                                   CEU017
201000200529     C           WWPTYP    WHEQ 'CC'                       Currency       CEU017
201100200529     C           WWREFN    CHAINSECOCCL2             89    Changes.       CEU017
201200200529     C                     MOVE 'SECOCCL2'DBFILS                          CEU017
201300200529     C                     ENDSL
201400200529      *
201500200529      ***  If record not found, handle Database Error.
201600200529      *
201700200529     C           *IN89     IFEQ '1'
201800200529     C                     Z-ADD009       DBASE            ***************
201900200529     C                     MOVELDBFILS    DBFILE           * DB ERROR 09 *
202000200529     C                     MOVELWWREFN    DBKEY1  8        ***************
202100200529     C                     MOVE WWOPNB    DBKEY1
202200200529     C                     MOVELDBKEY1    DBKEY
202300200529     C                     EXSR *PSSR
202400200529      *
202500200529      ***  Else, if record is found, load screen fields.
202600200529      *
202700200529     C                     ELSE
202800200529      *
202900200529     C                     MOVELCNSARR,4  DDTXT1           title 1st line = New Security
203000200529     C                     MOVELCNSARR,5  DDTXT2           title 2nd line = Stock Allocation
203100200529     C                     MOVELCNSARR,6  DDTXT3           title 3rd line = Stock Rounding
203200200529     C                     MOVELCNSARR,3  DDTXT4           title 4th line = Cash Rounding
203300200529      *
203400200529      ***  Load New Security Shortname.
203500200529      *
203600200529     C                     SELEC
203700200529     C           WWPTYP    WHEQ 'DV'                       If Dividend Events
203800200529     C                     MOVELMDNSEC    WWSECS           = from file
203900200529      *
204000200529     C           WWPTYP    WHEQ 'FR'                       If Free Allocation
204100200529     C                     MOVELMENSEC    WWSECS           = from file
204200200529      *
204300200529     C           WWPTYP    WHEQ 'CE'                       If Capital Changes
204400200529     C                     MOVELWWSECN    WWSECS           = Security received as parameter
204500200529      *
204600200529     C           WWPTYP    WHEQ 'RG'                       If Rights Issues
204700200529     C                     MOVELMFNSEC    WWSECS           = from file
204800200529      *
204900200529     C           WWPTYP    WHEQ 'OF'                       If Offers
205000200529     C                     MOVELMINSEC    WWSECS           = from file
205100200529      *
205200200529     C           WWPTYP    WHEQ 'EX'                       If Exercices and Conversions
205300200529     C                     MOVELMJNSEC    WWSECS           = from file
205400200529      *
205500200529     C           WWPTYP    WHEQ 'NC'                       If Name Changes
205600200529     C           MLSESN    IFEQ *BLANKS                    If Sec.blank   135690
205700200529     C                     MOVELWWSECN    WWSECS           = Security received as parameter
205800200529     C                     ELSE                            Else           135690
205900200529     C                     MOVELMLSESN    WWSECS           = from file    135690
206000200529     C                     ENDIF                                          135690
206100200529      *
206200200529     C           WWPTYP    WHEQ 'NF'                       If Non Financial Events
206300200529     C                     MOVELWWSECN    WWSECS           = Security received as parameter
206400200529      *                                                                   CEU017
206500200529     C           WWPTYP    WHEQ 'CC'                       If Ccy Changes CEU017
206600200529     C                     MOVELNANSEC    WWSECS           = from file    CEU017
206700200529     C                     ENDSL
206800200529      *
206900200529      ***  Process New Security.
207000200529      *
207100200529     C                     MOVELWWSECS    DDNSEC
207200200529     C           DDNSEC    IFNE *BLANKS
207300200529      *
207400200529      ***  Retrieve New Currency, New Security Decimal Places and New Price Basis.
207500200529      *
207600200529     C                     MOVE WWSECS    KSECN
207700200529     C                     EXSR ACCSEC
207800200529      *
207900200529     C                     MOVE NMCY      WNMCYN           New Currency
208000200529     C                     Z-ADDNMDP      WNMDPN           New Security Decimal Places
208100200529     C                     MOVE SPBS      WSPBSN  1        New Price Basis
208200200529      *
208300200529      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
208400200529      *
208500200529     C                     CALL 'AOCURRR0'
208600200529     C                     PARM '*MSG   ' WLRTCD
208700200529     C                     PARM '*KEY   ' WLOPTN
208800200529     C                     PARM NMCY      WLAJCD
208900200529     C           SDCURR    PARM SDCURR    DSSDY
209000200529      *
209100200529      ***  If record not found, handle Database Error.
209200200529      *
209300200529     C           WLRTCD    IFNE *BLANKS
209400200529     C                     Z-ADD010       DBASE            ***************
209500200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 10 *
209600200529     C                     MOVELWLAJCD    DBKEY            ***************
209700200529     C                     EXSR *PSSR
209800200529     C                     ENDIF
209900200529     C                     Z-ADDA6NBDP    NMDPCN  10       New Currency Decimal Places
210000200529      *
210100200529      ***  If Processing Type = Dividend Events and Subscription Price is entered as Market,
210200200529      ***  the Subscription Price must first be calculated from Current Market Price minus Discount.
210300200529      *
210400200529     C           WWPTYP    IFEQ 'DV'
210500200529     C           MDMRKI    ANDEQ'Y'
210600200529     C                     EXSR CSBPR
210700200529     C                     ENDIF
210800200529      *                                                                   136935
210900200529      ***  If Processing Type = Dividend Events with Stock Dividend Type  136935
211000200529      ***  = 'R', if Compensation Price entered, use Compensation Price   136935
211100200529      ***  instead of Subscription Price, otherwise, calculate Subscrip-  136935
211200200529      ***  tion Price = Subscription Price minus Discount Rate.           136935
211300200529      *                                                                   136935
211400200529     C           WWPTYP    IFEQ 'DV'                                      136935
211500200529     C           MDSDIT    ANDEQ'R'                                       136935
211600200529     C           MDCOMP    IFNE 0                                         136935
211700200529     C                     Z-ADDMDCOMP    MDSBPR                          136935
211800200529     C                     ELSE                                           136935
211900200529     C           MDMRKI    IFNE 'Y'                                       136935
212000200529     C           MDSBPR    MULT MDDSRT    WWSBPR                          136935
212100200529     C           WWSBPR    DIV  100       WWSBPR                          136935
212200200529     C                     SUB  WWSBPR    MDSBPR                          136935
212300200529     C                     ENDIF                                          136935
212400200529     C                     ENDIF                                          136935
212500200529     C                     ENDIF                                          136935
212600200529      *
212700200529      ***  Chain to LF/SECODPL3 to retrieve record details.
212800200529      *
212900200529     C           KEY2      CHAINSECODPL3             33
213000200529      *
213100200529      ***  If record not found, load fields for CO Details file with all amounts = 0 and write a
213200200529      ***  record on SECODPL3.
213300200529      *
213400200529     C           *IN33     IFEQ '1'
213500200529     C                     EXSR U002
213600200529     C                     WRITESECODPD0
213700200529     C                     ENDIF
213800200529      *
213900200529      ***  Move file fields to subfile fields for New Security lines.
214000200529      *
214100200529     C                     EXSR P009
214200200529      *
214300200529      ***  Write a record to the subfile.
214400200529      *
214500200529     C                     MOVE '0'       *IN45            Display New Security fields
214600200529     C                     ADD  1         #1RRN
214700200529     C                     WRITESE7593S1
214800200529     C                     ENDIF
214900200529      *
215000200529     C                     ENDIF
215100200529      *
215200200529     C                     ENDIF
215300200529      *
215400200529     C                     ENDSR
215500200529      *
215600200529      *****************************************************************
215700200529      /EJECT
215800200529      *****************************************************************
215900200529      *                                                               *
216000200529      *  P005   - Validation of the subfile (Amend Mode).             *
216100200529      *                                                               *
216200200529      *  Called by: P002   - Detail processing.                       *
216300200529      *                                                               *
216400200529      *  Calls: P006     - Validate and perform Action taken (Amend   *
216500200529      *                    Mode).                                     *
216600200529      *         P007     - Process Action.                            *
216700200529      *         P008     - Update/write LF/SECODRL0 (Amend Mode).     *
216800200529      *         V001     - Validate details input (Amend Mode).       *
216900200529      *         Y2CLMSC  - Midas ABS Clear specific program message   *
217000200529      *                    queue.                                     *
217100200529      *                                                               *
217200200529      *****************************************************************
217300200529      *
217400200529     C           P005      BEGSR                           ** P005 SR **
217500200529      *
217600200529      ***  Clear messages from program message queue.
217700200529      *
217800200529     C                     CALL 'Y2CLMSC'
217900200529     C                     PARM ##PGM     ZAPGM  10
218000200529     C                     PARM '*SAME'   ZAPGRL  5
218100200529      *
218200200529      ***  Read first record amended on subfile.
218300200529      *
218400200529     C                     READCSE7593S1                 34
218500200529      *
218600200529     C                     MOVE 'Y'       UPDCAS  1
218700200529      *
218800200529      ***  Setup subfile record number with the current CPF'S Position within the subfile.
218900200529      *
219000200529     C           *IN34     IFEQ '1'
219100200529     C                     Z-ADDCPFPOS    #1RRN
219200200529     C                     ENDIF
219300200529      *
219400200529      ***  Do while record amended on subfile and not F3: Exit and not F12: Previous Screen pressed.
219500200529      *
219600200529     C           *IN34     DOWEQ'0'                        Record amended
219700200529     C           *INKC     ANDEQ'0'                        Not F3
219800200529     C           *INKL     ANDEQ'0'                        Not F12
219900200529      *
220000200529      ***  Reset error indicators.
220100200529      *
220200200529     C                     MOVEA'0000'    *IN,58
220300200529      *
220400200529     C                     MOVE '1'       *IN85            SFLNXTCHG
220500200529      *
220600200529      ***  Set 'Record valid' flag to 'Y'.
220700200529      *
220800200529     C                     MOVE 'Y'       VALREC  1
220900200529      *
221000200529      ***  Validate details input.
221100200529      *
221200200529     C                     EXSR V001
221300200529      *
221400200529      *
221500200529      ***  If details input not valide, read next subfile record changed.
221600200529      *
221700200529     C           VALREC    IFEQ 'N'
221800200529     C                     GOTO TAG2
221900200529     C                     ENDIF
222000200529      *
222100200529      ***  If action indicator is changed, validate and perform Action taken.
222200200529      *
222300200529     C           DDACN3    IFNE ' '
222400200529     C                     EXSR P006
222500200529      *
222600200529      ***  If Action Code not valide, read next subfile record changed.
222700200529      *
222800200529     C           VALREC    IFEQ 'N'
222900200529     C                     GOTO TAG2
223000200529     C                     ENDIF
223100200529      *
223200200529     C                     ENDIF
223300200529      *
223400200529      ***  If record is valid.
223500200529      *
223600200529     C           VALREC    IFEQ 'Y'
223700200529      *
223800200529      ***  Update SECODRL0.
223900200529      *
224000200529     C                     EXSR P008
224100200529     C                     ENDIF
224200200529      *
224300200529      ***  Process action.
224400200529      *
224500200529     C           DDACN3    IFNE ' '
224600200529     C                     EXSR P007
224700200529      *
224800200529     C                     MOVE '0'       *IN85
224900200529     C                     MOVE *BLANKS   DDACN3           Reset Action Code
225000200529     C                     UPDATSE7593S1                   Update subfile record
225100200529     C                     ENDIF
225200200529      *
225300200529     C           TAG2      TAG
225400200529      *
225500200529     C                     WRITE#MSGCTL                    write program message
225600200529      *
225700200529      ***  Read next subfile record canged.
225800200529      *
225900200529     C                     READCSE7593S1                 34
226000200529     C                     ENDDO
226100200529      *
226200200529     C                     Z-ADD1         #1RRN
226300200529      *
226400200529      ***  Redisplay current screen.
226500200529      *
226600200529     C                     WRITE#MSGCTL                    Program messages
226700200529     C                     WRITESE7593C1                   Subfile
226800200529     C                     WRITESE7593F0                   Command Keys
226900200529      *
227000200529     C                     ENDSR
227100200529      *
227200200529      *****************************************************************
227300200529      /EJECT
227400200529      *****************************************************************
227500200529      *                                                               *
227600200529      *  P006   - Validate and perform Action taken (Amend Mode).     *
227700200529      *                                                               *
227800200529      *  Called by: P005   - Validation of the subfile (Amend Mode).  *
227900200529      *                                                               *
228000200529      *  Calls: ZASNMS - Send message to program message queue.       *
228100200529      *                                                               *
228200200529      *****************************************************************
228300200529      *
228400200529     C           P006      BEGSR                           ** P006 SR **
228500200529      *
228600200529      ***  Action must either be 'A', 'E' or 'F'.
228700200529      *
228800200529     C           DDACN3    IFNE 'A'
228900200529     C           DDACN3    ANDNE'E'
229000200529     C           DDACN3    ANDNE'F'
229100200529     C           DDACN3    ANDNE' '
229200200529     C                     MOVE 'N'       VALREC           'Record not valid' flag
229300200529     C                     MOVE '1'       *IN58            Reverse Action Code
229400200529     C                     MOVEL'CO00204' ZAMSID
229500200529     C                     EXSR ZASNMS
229600200529     C                     ENDIF
229700200529      *
229800200529      ***  Action 'A' is not allowed in the enquiry mode.
229900200529      *
230000200529     C           DDACN3    IFEQ 'A'
230100200529     C           WWACTN    ANDEQ'E'
230200200529     C                     MOVE 'N'       VALREC           'Record not valid' flag
230300200529     C                     MOVE '1'       *IN58            Reverse Action Code
230400200529     C                     MOVEL'CO00237' ZAMSID
230500200529     C                     EXSR ZASNMS
230600200529     C                     ENDIF
230700200529      *
230800200529      ***  Action 'F' is not allowed for Cash Line.
230900200529      *
231000200529     C           DDACN3    IFEQ 'F'
231100200529     C           DDTXT1    ANDEQCNSARR,1
231200200529     C                     MOVE *BLANKS   DDACN3
231300200529     C                     MOVE 'N'       VALREC           'Record not valid' flag
231400200529     C                     MOVE '1'       *IN58            Reverse Action Code
231500200529     C                     MOVEL'CO00205' ZAMSID
231600200529     C                     EXSR ZASNMS
231700200529     C                     ENDIF
231800200529     C/COPY WNCPYSRC,SEH00036
231900200529      *
232000200529     C                     ENDSR
232100200529      *
232200200529      *****************************************************************
232300200529      /EJECT
232400200529      *****************************************************************
232500200529      *                                                               *
232600200529      *  P007   - Process Action.                                     *
232700200529      *                                                               *
232800200529      *  Called by: P005   - Validation of the subfile (Amend Mode).  *
232900200529      *                                                               *
233000200529      *  Calls: *PSSR  - Error processing.                            *
233100200529      *         SE0040   - Midas SE Security detail maintenance.      *
233200200529      *         SE7513   - Midas SE CO Customer/Book by Depot         *
233300200529      *                    Maintenance.                               *
233400200529      *                                                               *
233500200529      *****************************************************************
233600200529      *
233700200529     C           P007      BEGSR                           ** P007 SR **
233800200529      *
233900200529      ***  If Action 'F' is entered in front of New Security line,
234000200529      ***  call RPG/SE0040 to enquire the Security details of the New Security.
234100200529      *
234200200529     C           DDACN3    IFEQ 'F'
234300200529     C           DDTXT1    ANDEQCNSARR,4
234400200529      *
234500200529     C           CAP137    IFNE 'Y'                                       CAP137
234600200529     C                     CALL 'SE0040'               87
234700200529     C                     PARM *BLANKS   #RTCD   7
234800200529     C                     PARM 'E'       #ACCD   1
234900200529     C                     PARM DDNSEC    #NSEC  10
235000200529     C                     PARM *BLANKS   #OSEC  10
235100200529     C                     PARM *BLANKS   #OTHER156                       138957
235200200529     C                     ELSE                                           CAP137
235300200529     C                     CALL 'SEC023'               87                 CAP137
235400200529     C                     PARM           PPGM                            CAP137
235500200529     C                     PARM *BLANKS   #RTCD                           CAP137
235600200529     C                     PARM 'E'       #ACCD                           CAP137
235700200529     C                     PARM DDNSEC    #NSEC                           CAP137
235800200529     C                     PARM *BLANKS   #OSEC                           CAP137
235900200529     C                     PARM *BLANKS   #OTHER                          CAP137
236000200529     C                     PARM 'Y'       PLINK   1                       CAP137
236100200529     C                     ENDIF                                          CAP137
236200200529      *
236300200529      ***  If there is an error in calling the pgm or return code is not blank and not F3 pressed,
236400200529      ***  handle database error.
236500200529      *
236600200529     C           *IN87     IFEQ '1'
236700200529     C           *INU7     OREQ '1'
236800200529     C           *INU8     OREQ '1'
236900200529     C           #RTCD     ORNE *BLANKS
237000200529     C           #RTCD     ANDNE'Y2U9999'
237100200529     C                     Z-ADD011       DBASE            ***************
237200200529     C                     MOVEL'SE7593 ' DBFILE           * DB ERROR 11 *
237300200529     C           CAP137    IFNE 'Y'                                       CAP137
237400200529     C                     MOVELNARR,1    DBKEY            ***************
237500200529     C                     ELSE                                           CAP137
237600200529     C                     MOVELNARR,3    DBKEY                           CAP137
237700200529     C                     ENDIF                                          CAP137
237800200529     C                     EXSR *PSSR
237900200529     C                     ENDIF
238000200529      *
238100200529     C                     ENDIF
238200200529      *
238300200529      ***  If Action 'A' or 'E' is entered.
238400200529      *
238500200529     C           DDACN3    IFEQ 'A'
238600200529     C           DDACN3    OREQ 'E'
238700200529     C                     COMIT
238800200529      *
238900200529      ***  If Action 'A' is entered, New Security is equal to '**CASH**'.
239000200529      *
239100200529     C           DDTXT1    IFEQ CNSARR,1
239200200529     C                     MOVEL'**CASH**'WNSEC  10 P
239300200529     C                     ENDIF
239400200529      *
239500200529      ***  If Action 'E' is entered, New Security is the same as displayed on the screen.
239600200529      *
239700200529     C           DDTXT1    IFEQ CNSARR,4
239800200529     C                     MOVE DDNSEC    WNSEC
239900200529     C                     ENDIF
240000200529      *
240100200529      ***  Call RPG/SE7513 to display the Customer/Books Maintenance Enquiry screen.
240200200529      *
240300200529     C                     CALL 'SE7513'               87
240400200529     C                     PARM           WWREFN  6        ER Reference
240500200529     C                     PARM           WWSECN 10        Security Shortname
240600200529     C                     PARM           WWCOAT  2        Corporate Action Type
240700200529     C                     PARM           WWPTYP  2        Processing Type
240800200529     C                     PARM           WWEXDT  5        Ex-Date
240900200529     C                     PARM           DDSTS3           Status
241000200529     C                     PARM           DDFLA3           Final Allocation Indicator
241100200529     C                     PARM           DDBRC3           Branch Code
241200200529     C                     PARM           DDDEP3           Depot
241300200529     C                     PARM           DDNCC3           Nominal Currency
241400200529     C                     PARM           WNSEC            New Security
241500200529     C                     PARM           DDOPT3           Option Number
241600200529     C                     PARM DDACN3    WWMODE  1        Amend or Enquiry ?
241700200529     C                     PARM           WWRTCD  1        Return Code
241800200529      *
241900200529      ***  If there is an error in calling the pgm or return code is 'E', handle Database Error.
242000200529      *
242100200529     C           *IN87     IFEQ '1'
242200200529     C           *INU7     OREQ '1'
242300200529     C           *INU8     OREQ '1'
242400200529     C           WWRTCD    OREQ 'E'
242500200529     C                     Z-ADD012       DBASE            ***************
242600200529     C                     MOVEL'SE7593 ' DBFILE           * DB ERROR 12 *
242700200529     C                     MOVELNARR,2    DBKEY            ***************
242800200529     C                     EXSR *PSSR
242900200529     C                     ENDIF
243000200529      *
243100200529      ***  If 'Return Code' equal to '3', seton F3: Exit indicator.
243200200529      *
243300200529     C           WWRTCD    IFEQ '3'
243400200529     C                     MOVE '1'       *INKC
243500200529     C                     ELSE
243600200529     C                     MOVE 'Y'       FIRSTA
243700200529     C                     ENDIF
243800200529      *
243900200529     C                     ENDIF
244000200529      *
244100200529     C                     ENDSR
244200200529      *
244300200529      *****************************************************************
244400200529      /EJECT
244500200529      *****************************************************************
244600200529      *                                                               *
244700200529      *  P008   - Update/Write LF/SECODRL0 (Amend Mode).              *
244800200529      *                                                               *
244900200529      *  Called by: P005   - Validation of the subfile (Amend Mode).  *
245000200529      *                                                               *
245100200529      *  Calls: U001   - Load field for file SECODRL0.                *
245200200529      *                                                               *
245300200529      *****************************************************************
245400200529      *
245500200529     C           P008      BEGSR                           ** P008 SR **
245600200529      *
245700200529      ***  Setup key list to LF/SECODRL0.
245800200529      *
245900200529     C                     MOVE DDBRC3    WWDSBA           Branch from screen
246000200529     C                     MOVELDDDEP3    WWDDPT           Depot from screen
246100200529      *
246200200529      ***  Retrieve CO Depot Reference details for CO Reference, Branch and Depot processed.
246300200529      *
246400200529     C           KEY1      CHAINSECODRL0             35
246500200529      *
246600200529      ***  If details not found, load fields and write a record to PF/SECODRL0.
246700200529      *
246800200529     C           *IN35     IFEQ '1'
246900200529     C                     EXSR U001
247000200529     C                     WRITESECODRD0
247100200529      *
247200200529      ***  Else, if found, load fields and update the record in PF/SECODRL0.
247300200529      *
247400200529     C                     ELSE
247500200529     C                     EXSR U001
247600200529     C                     UPDATSECODRD0
247700200529     C                     ENDIF
247800200529      *
247900200529     C                     ENDSR
248000200529      *
248100200529      *****************************************************************
248200200529      /EJECT
248300200529      *****************************************************************
248400200529      *                                                               *
248500200529      *  P009   - Move file fields to screen fields for New Security. *
248600200529      *                                                               *
248700200529      *  Called by: P004   - Build the subfile (Amend Mode).          *
248800200529      *             V001   - Validate details input (Amend Mode).     *
248900200529      *                                                               *
249000200529      *  Calls: ZSEDIT - Standart subroutine to insert a decimal      *
249100200529      *                  point into a numeric field and to blank out  *
249200200529      *                  leading zeroes.                              *
249300200529      *                                                               *
249400200529      *****************************************************************
249500200529      *
249600200529     C           P009      BEGSR                           ** P009 SR **
249700200529      *
249800200529      ***  Currencies.
249900200529      *
250000200529     C                     MOVE WNMCYN    DDCCY2           Currency 1
250100200529     C                     MOVE WNMCYN    DDCCY3           Currency 2
250200200529     C                     MOVE WNMCYN    DDCCY4           Currency 3
250300200529      *
250400200529      ***  Holding taken as stock.
250500200529      *
250600200529     C                     MOVE *BLANKS   DDHTS3
250700200529     C           MBHOST    IFNE *ZEROS
250800200529     C                     MOVE *BLANKS   ZFLD15
250900200529     C                     MOVELMBHOST    ZFLD15
251000200529     C                     Z-ADDWNMDPO    ZDECS            Event Security Decimal Places
251100200529     C                     EXSR ZSEDIT
251200200529     C                     MOVE ZOUT21    DDHTS3
251300200529     C                     ENDIF
251400200529      *
251500200529      ***  Original Stock Alocation = Original 2.
251600200529      *
251700200529     C                     MOVE *BLANKS   DDORG2
251800200529     C           MBOALR    IFNE *ZEROS
251900200529     C                     MOVE *BLANKS   ZFLD15
252000200529     C                     MOVELMBOALR    ZFLD15
252100200529     C                     Z-ADDWNMDPN    ZDECS            New Security Decimal Places
252200200529     C                     EXSR ZSEDIT
252300200529     C                     MOVE ZOUT21    DDORG2
252400200529     C                     ENDIF
252500200529      *
252600200529      ***  Original Stock Rounding = Original 3.
252700200529      *
252800200529     C                     MOVE *BLANKS   DDORG3
252900200529     C           MBOSTR    IFNE *ZEROS
253000200529     C                     MOVE *BLANKS   ZFLD15
253100200529     C                     MOVELMBOSTR    ZFLD15
253200200529     C                     Z-ADD8         ZDECS            8 Decimal Places
253300200529     C                     EXSR ZSEDIT
253400200529     C                     MOVE ZOUT21    DDORG3
253500200529     C                     ENDIF
253600200529      *
253700200529      ***  Original Cash Rounding = Original 4.
253800200529      *
253900200529     C                     MOVE *BLANKS   DDORG4
254000200529     C           MBOCAR    IFNE *ZEROS
254100200529     C                     MOVE *BLANKS   ZFLD15
254200200529     C                     MOVELMBOCAR    ZFLD15
254300200529     C                     Z-ADDNMDPCN    ZDECS            New Currency Decimal Places
254400200529     C                     EXSR ZSEDIT
254500200529     C                     MOVE ZOUT21    DDORG4
254600200529     C                     ENDIF
254700200529      *
254800200529      ***  Actual Stock Allocation = Actual 2.
254900200529      *
255000200529     C                     MOVE *BLANKS   DDACT2
255100200529     C                     MOVE *BLANKS   DDAC2H
255200200529     C           MBASTA    IFNE *ZEROS
255300200529     C                     MOVE *BLANKS   ZFLD15
255400200529     C                     MOVELMBASTA    ZFLD15
255500200529     C                     Z-ADDWNMDPN    ZDECS            New Security Decimal Places
255600200529     C                     EXSR ZSEDIT
255700200529     C                     MOVE ZOUT21    DDACT2
255800200529     C                     MOVE ZOUT21    DDAC2H
255900200529     C                     ENDIF
256000200529      *
256100200529      ***  Actual Stock Rounding = Actul 3.
256200200529      *
256300200529     C                     MOVE *BLANKS   DDACT3
256400200529     C                     MOVE *BLANKS   DDAC3H
256500200529     C           MBASTR    IFNE *ZEROS
256600200529     C                     MOVE *BLANKS   ZFLD15
256700200529     C                     MOVELMBASTR    ZFLD15
256800200529     C                     Z-ADD8         ZDECS            8 Decimal Places
256900200529     C                     EXSR ZSEDIT
257000200529     C                     MOVE ZOUT21    DDACT3
257100200529     C                     MOVE ZOUT21    DDAC3H
257200200529     C                     ENDIF
257300200529      *
257400200529      ***  Actual Cash Rounding = Actual 4.
257500200529      *
257600200529     C                     MOVE *BLANKS   DDACT4
257700200529     C                     MOVE *BLANKS   DDAC4H
257800200529     C           MBACAR    IFNE *ZEROS
257900200529     C                     MOVE *BLANKS   ZFLD15
258000200529     C                     MOVELMBACAR    ZFLD15
258100200529     C                     Z-ADDNMDPCN    ZDECS            New Currency Decimal Places
258200200529     C                     EXSR ZSEDIT
258300200529     C                     MOVE ZOUT21    DDACT4
258400200529     C                     MOVE ZOUT21    DDAC4H
258500200529     C                     ENDIF
258600200529      *
258700200529      ***  Balancing Stok Allocation = Balancing Difference 2.
258800200529      *
258900200529     C                     MOVE *BLANKS   DDBLD2
259000200529     C           MBBSTA    IFNE *ZEROS
259100200529     C                     MOVE *BLANKS   ZFLD15
259200200529     C                     MOVELMBBSTA    ZFLD15
259300200529     C                     Z-ADDWNMDPN    ZDECS            New Security Decimal Places
259400200529     C                     EXSR ZSEDIT
259500200529     C                     MOVE ZOUT21    DDBLD2
259600200529     C                     ENDIF
259700200529      *
259800200529      ***  Balancing Stock Rounding = Balancing Difference 3.
259900200529      *
260000200529     C                     MOVE *BLANKS   DDBLD3
260100200529     C           MBBSTR    IFNE *ZEROS
260200200529     C                     MOVE *BLANKS   ZFLD15
260300200529     C                     MOVELMBBSTR    ZFLD15
260400200529     C                     Z-ADD8         ZDECS            8 Decimal Places
260500200529     C                     EXSR ZSEDIT
260600200529     C                     MOVE ZOUT21    DDBLD3
260700200529     C                     ENDIF
260800200529      *
260900200529      ***  Balancing Cash Rounding = Balancing Difference 4.
261000200529      *
261100200529     C                     MOVE *BLANKS   DDBLD4
261200200529     C           MBBCAR    IFNE *ZEROS
261300200529     C                     MOVE *BLANKS   ZFLD15
261400200529     C                     MOVELMBBCAR    ZFLD15
261500200529     C                     Z-ADDNMDPCN    ZDECS            New Currency Decimal Places
261600200529     C                     EXSR ZSEDIT
261700200529     C                     MOVE ZOUT21    DDBLD4
261800200529     C                     ENDIF
261900200529      *
262000200529      ***  Reset screen fields used only for Security '**CASH**' line.
262100200529      *
262200200529     C                     MOVE *BLANKS   DDACT1           Actual 1
262300200529     C                     MOVE *BLANKS   DDBLD1           Balancing Difference 1
262400200529      *
262500200529     C                     ENDSR
262600200529      *
262700200529      *****************************************************************
262800200529      /EJECT
262900200529      *****************************************************************
263000200529      *                                                               *
263100200529      *  P010   - Move file fields to screen fields for Security      *
263200200529      *           '**CASH**'.                                         *
263300200529      *                                                               *
263400200529      *  Called by: P004   - Build the subfile (Amend Mode).          *
263500200529      *             V001   - Validate details input (Amend Mode).     *
263600200529      *                                                               *
263700200529      *  Calls: ZSEDIT - Standart subroutine to insert a decimal      *
263800200529      *                  point into a numeric field and to blank out  *
263900200529      *                  leading zeroes.                              *
264000200529      *                                                               *
264100200529      *****************************************************************
264200200529      *
264300200529     C           P010      BEGSR                           ** P010 SR **
264400200529      *
264500200529      ***  If Processing Type = Corporate Reorganisation, set Number of Decimal Places used in
264600200529      ***  standart subroutine ZSEDIT to Event Currency Decimal Places and screen Currencies to
264700200529      ***  Event Currency, else set Number of Decimal Places to New Currency Decimal Places and
264800200529      ***  Currencies to New Currency.
264900200529      *
265000200529     C           WWPTYP    IFEQ 'CR'
265100200529     C                     Z-ADDNMDPCO    ZDECS            Event Currency Decimal Places
265200200529     C                     MOVE WNMCYO    DDCCY2
265300200529     C                     MOVE WNMCYO    DDCCY3
265400200529     C                     ELSE
265500200529     C                     Z-ADDNMDPCN    ZDECS            New Currency Deciam Places
265600200529     C                     MOVE WNMCYN    DDCCY2
265700200529     C                     MOVE WNMCYN    DDCCY3
265800200529     C                     ENDIF
265900200529      *
266000200529      ***  Original Cash Option = Original 2.
266100200529      *
266200200529     C                     MOVE *BLANKS   DDORG2
266300200529     C           MBCAOP    IFNE *ZEROS
266400200529     C                     MOVE *BLANKS   ZFLD15
266500200529     C                     MOVELMBCAOP    ZFLD15
266600200529     C                     EXSR ZSEDIT
266700200529     C                     MOVE ZOUT21    DDORG2
266800200529     C                     ENDIF
266900200529      *
267000200529      ***  Original Cash Rounding = Original 3.
267100200529      *
267200200529     C                     MOVE *BLANKS   DDORG3
267300200529     C           MBOCAR    IFNE *ZEROS
267400200529     C                     MOVE *BLANKS   ZFLD15
267500200529     C                     MOVELMBOCAR    ZFLD15
267600200529     C                     EXSR ZSEDIT
267700200529     C                     MOVE ZOUT21    DDORG3
267800200529     C                     ENDIF
267900200529      *
268000200529      ***  Actual 1 = Actual Cash Allocation + Actual Cash Rounding.
268100200529      *
268200200529     C                     Z-ADD*ZEROS    WWACTC 150
268300200529     C           MBACAA    ADD  MBACAR    WWACTC
268400200529     C                     MOVE *BLANKS   DDACT1
268500200529     C           WWACTC    IFNE *ZEROS
268600200529     C                     MOVE *BLANKS   ZFLD15
268700200529     C                     MOVELWWACTC    ZFLD15
268800200529     C                     EXSR ZSEDIT
268900200529     C                     MOVE ZOUT21    DDACT1
269000200529     C                     ENDIF
269100200529      *
269200200529      ***  Actual Cash Allocation = Actual 2.
269300200529      *
269400200529     C                     MOVE *BLANKS   DDACT2
269500200529     C                     MOVE *BLANKS   DDAC2H
269600200529     C           MBACAA    IFNE *ZEROS
269700200529     C                     MOVE *BLANKS   ZFLD15
269800200529     C                     MOVELMBACAA    ZFLD15
269900200529     C                     EXSR ZSEDIT
270000200529     C                     MOVE ZOUT21    DDACT2
270100200529     C                     MOVE ZOUT21    DDAC2H
270200200529     C                     ENDIF
270300200529      *
270400200529      ***  Actual Cash Rounding = Actual 3.
270500200529      *
270600200529     C                     MOVE *BLANKS   DDACT3
270700200529     C                     MOVE *BLANKS   DDAC3H
270800200529     C           MBACAR    IFNE *ZEROS
270900200529     C                     MOVE *BLANKS   ZFLD15
271000200529     C                     MOVELMBACAR    ZFLD15
271100200529     C                     EXSR ZSEDIT
271200200529     C                     MOVE ZOUT21    DDACT3
271300200529     C                     MOVE ZOUT21    DDAC3H
271400200529     C                     ENDIF
271500200529      *
271600200529      ***  Balancing Cash Allocation = Balancing Difference 1.
271700200529      *
271800200529     C                     MOVE *BLANKS   DDBLD1
271900200529     C           MBBCAA    IFNE *ZEROS
272000200529     C                     MOVE *BLANKS   ZFLD15
272100200529     C                     MOVELMBBCAA    ZFLD15
272200200529     C                     EXSR ZSEDIT
272300200529     C                     MOVE ZOUT21    DDBLD1
272400200529     C                     ENDIF
272500200529      *
272600200529      ***  Reset screen fields used only for New Security line.
272700200529      *
272800200529     C                     MOVE *BLANKS   DDCCY4           Currency 4
272900200529     C                     MOVE *BLANKS   DDORG4           Original 4
273000200529     C                     MOVE *BLANKS   DDACT4           Actual 4
273100200529     C                     MOVE *BLANKS   DDAC4H           Actual 4 hidden
273200200529     C                     MOVE *BLANKS   DDBLD2           Balancing Difference 2
273300200529     C                     MOVE *BLANKS   DDBLD3           Balancing Difference 3
273400200529     C                     MOVE *BLANKS   DDBLD4           Balancing Difference 4
273500200529      *
273600200529     C                     ENDSR
273700200529      *
273800200529      *****************************************************************
273900200529      /EJECT
274000200529      *****************************************************************
274100200529      *                                                               *
274200200529      *  V001   - Validate details input (Amend Mode).                *
274300200529      *                                                               *
274400200529      *  Called by: P005   - Validation of the subfile (Amend Mode).  *
274500200529      *                                                               *
274600200529      *  Calls: REASTR   - Recalculate Actual Stock Rounding for New  *
274700200529      *                    Security on Security line.                 *
274800200529      *         REACAR   - Recalculate Actual Cash Rounding for New   *
274900200529      *                    Security on Security line.                 *
275000200529      *         REACAA   - Recalculate Actual Cash Allocation for     *
275100200529      *                    Security '**CASH**' on Security line.      *
275200200529      *         P009     - Move file fields to screen fields for New  *
275300200529      *                    Security.                                  *
275400200529      *         P010     - Move file fields to screen fields for      *
275500200529      *                    Security '**CASH**'.                       *
275600200529      *         ACCSEC   - Access Security details file.              *
275700200529      *         *PSSR    - Error processing.                          *
275800200529      *         ZASNMS   - Send message to program message queue.     *
275900200529      *         SETNDP   - Set amount from num field 30.9 to num      *
276000200529      *                    field 15.0 with Number of Decimal Places   *
276100200529      *                    from a Currency.                           *
276200200529      *         RTVNDP   - Set amount from num field 15.0 to num      *
276300200529      *                    field 30.9 with Retrieve Number of Decimal *
276400200529      *                    Places from a Ccy.                         *
276500200529      *         ROUNDD   - Perform rounding to the Number of Decimal  *
276600200529      *                    Places.                                    *
276700200529      *         ZASIGN   - Standart subroutine to validate and        *
276800200529      *                    right-align signed numeric fields.         *
276900200529      *         AOCURRR0 - Midas AO Currency codes access object.     *
277000200529      *                                                               *
277100200529      *****************************************************************
277200200529      *
277300200529     C           V001      BEGSR                           ** V001 SR **
277400200529      *
277500200529      ***  Cash Line (title 1st line = 'Cash').
277600200529      *
277700200529     C           DDTXT1    IFEQ CNSARR,1
277800200529      *
277900200529      ***  Retrieve CO Depot details for Security 'CASH'.
278000200529      *
278100200529     C                     MOVEL'**CASH**'WWSECS    P
278200200529     C           KEY2      CHAINSECODPL3             36
278300200529      *
278400200529      ***  If record no longer on file, handle Database Error.
278500200529      *
278600200529     C           *IN36     IFEQ '1'
278700200529     C                     Z-ADD013       DBASE            ***************
278800200529     C                     MOVE 'SECODPL3'DBFILE           * DB ERROR 13 *
278900200529     C                     MOVELWWREFN    DBKEY1           ***************
279000200529     C                     MOVE WWOPNB    DBKEY1
279100200529     C                     MOVELWWBRCA    DBKEY2  9
279200200529     C                     MOVE WWDPOT    DBKEY2
279300200529     C                     MOVELDBKEY1    DBKEY3 17
279400200529     C                     MOVE DBKEY2    DBKEY3
279500200529     C                     MOVELDBKEY3    DBKEY4 27
279600200529     C                     MOVE WWSECS    DBKEY4
279700200529     C                     MOVELDBKEY4    DBKEY
279800200529     C                     EXSR *PSSR
279900200529     C                     ENDIF
280000200529      *                                                                   136935
280100200529     C                     Z-ADD0         DUACAA 150                      136935
280200200529     C                     Z-ADD0         DUACAR 150                      136935
280300200529      *
280400200529      ***  If Actual Cash Opt/Allocat. is changed.
280500200529      *
280600200529     C           DDACT2    IFNE DDAC2H
280700200529      *
280800200529      ***  Save some fields.
280900200529      *
281000200529     C                     Z-ADDMBACAA    WWACAA           Old Actual Cash Allocation
281100200529      *
281200200529      ***  Validate the input.
281300200529      *
281400200529     C                     MOVE *BLANKS   ZFLD17
281500200529     C                     MOVELDDACT2    ZFLD17
281600200529     C           WWPTYP    IFEQ 'CR'
281700200529     C                     Z-ADDNMDPCO    ZSDEC            Event Currency Decimal Places
281800200529     C                     ELSE
281900200529     C                     Z-ADDNMDPCN    ZSDEC            New Currency Decimal Places
282000200529     C                     ENDIF
282100200529     C           15        SUB  ZSDEC     ZSDIG
282200200529     C                     EXSR ZASIGN
282300200529      *
282400200529      ***  Field must be numeric.
282500200529      *
282600200529     C           *IN99     IFEQ '1'
282700200529     C                     MOVE 'N'       VALREC
282800200529     C                     MOVE 'N'       UPDCAS
282900200529     C                     MOVE '1'       *IN59
283000200529     C                     MOVEL'CO00230' ZAMSID
283100200529     C                     EXSR ZASNMS
283200200529     C                     ELSE
283300200529      *
283400200529      ***  Move Actual Cash Allocation entered into file field.
283500200529      *
283600200529     C                     MOVE ZOUT15    MBACAA
283700200529     C           ZFSIGN    IFEQ '-'
283800200529     C                     MULT -1        MBACAA
283900200529     C                     ENDIF
284000200529      *
284100200529      ***  Recalculate Balancing Cash Allocation on file by adding
284200200529      ***  the old value and subtracting the new value of Actual Cash
284300200529      ***  Allocation.
284400200529      *
284500200529     C                     ADD  WWACAA    MBBCAA
284600200529     C                     SUB  MBACAA    MBBCAA
284700200529      *                                                                   136935
284800200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
284900200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
285000200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
285100200529      ***  reset it.                                                      136935
285200200529      *                                                                   136935
285300200529     C           MBBCAA    IFNE 0                                         136935
285400200529     C           WWPTYP    ANDEQ'CC'                                      136935
285500200529     C           MBBCAA    ORNE 0                                         136935
285600200529     C           WWPTYP    ANDNE'CC'                                      136935
285700200529     C           BVALDC    ANDEQ'Y'                                       136935
285800200529     C                     Z-SUBMBBCAA    DUACAA                          136935
285900200529     C                     Z-ADD0         MBBCAA                          136935
286000200529     C                     ENDIF                                          136935
286100200529      *
286200200529     C                     ENDIF
286300200529     C                     ENDIF
286400200529      *
286500200529      ***  If Actual Cash rounding is changed.
286600200529      *
286700200529     C           DDACT3    IFNE DDAC3H
286800200529      *
286900200529      ***  Save some fields.
287000200529      *
287100200529     C                     Z-ADDMBACAR    WWACAR           Old Actual Cash Rounding
287200200529      *
287300200529      ***  Validate the input.
287400200529      *
287500200529     C                     MOVE *BLANKS   ZFLD17
287600200529     C                     MOVELDDACT3    ZFLD17
287700200529     C           WWPTYP    IFEQ 'CR'
287800200529     C                     Z-ADDNMDPCO    ZSDEC            Event Currency Decimal Places
287900200529     C                     ELSE
288000200529     C                     Z-ADDNMDPCN    ZSDEC            New Currency Decimal Places
288100200529     C                     ENDIF
288200200529     C           15        SUB  ZSDEC     ZSDIG
288300200529     C                     EXSR ZASIGN
288400200529      *
288500200529      ***  Field must be numeric.
288600200529      *
288700200529     C           *IN99     IFEQ '1'
288800200529     C                     MOVE 'N'       VALREC
288900200529     C                     MOVE 'N'       UPDCAS
289000200529     C                     MOVE '1'       *IN60
289100200529     C                     MOVEL'CO00231' ZAMSID
289200200529     C                     EXSR ZASNMS
289300200529     C                     ELSE
289400200529      *
289500200529      ***  Move Actual Cash Rounding entered into file field.
289600200529      *
289700200529     C                     MOVE ZOUT15    MBACAR
289800200529     C           ZFSIGN    IFEQ '-'
289900200529     C                     MULT -1        MBACAR
290000200529     C                     ENDIF
290100200529      *
290200200529      ***  Recalculate Balancing Cash Rounding on file by adding
290300200529      ***  Old value and subtracting New value of Actual Cash Rounding.
290400200529      *
290500200529     C           MBBCAA    ADD  WWACAR    MBBCAA
290600200529     C           MBBCAA    SUB  MBACAR    MBBCAA
290700200529      *                                                                   136935
290800200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
290900200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
291000200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
291100200529      ***  reset it.                                                      136935
291200200529      *                                                                   136935
291300200529     C           MBBCAA    IFNE 0                                         136935
291400200529     C           WWPTYP    ANDEQ'CC'                                      136935
291500200529     C           MBBCAA    ORNE 0                                         136935
291600200529     C           WWPTYP    ANDNE'CC'                                      136935
291700200529     C           BVALDC    ANDEQ'Y'                                       136935
291800200529     C                     Z-ADDMBBCAA    DUACAR                          136935
291900200529     C                     Z-ADD0         MBBCAA                          136935
292000200529     C                     ENDIF                                          136935
292100200529      *
292200200529     C                     ENDIF
292300200529     C                     ENDIF
292400200529      *
292500200529      ***  If Actual Cash Allocation or Actual Cash Rounding changed.
292600200529      *
292700200529     C           DDACT2    IFNE DDAC2H
292800200529     C           DDACT3    ORNE DDAC3H
292900200529      *
293000200529      ***  If no error, update current record in LF/SECODPL3.
293100200529      *
293200200529     C           *IN59     IFEQ '0'
293300200529     C           *IN60     ANDEQ'0'
293400200529     C                     MOVE 'A'       MBCHTP
293500200529     C                     Z-ADDBJRDNB    MBLCD
293600200529     C                     MOVE USER      MBLUID
293700200529     C                     UPDATSECODPD0
293900200529     C                     MOVE 'Y'       WWUPDT  1
294000200529      *
294100200529      ***  Move file fields to subfile fields (**CASH**).
294200200529      *
294300200529     C                     EXSR P010
294400200529     C                     MOVE '0'       *IN85            SFLNXTCHG
294500200529     C                     MOVE '1'       *IN45
294600200529     C                     UPDATSE7593S1
294700200529      *                                                                   136935
294800200529      ***  If Balancing Difference has been allocated to Dummy Customer,  136935
294900200529      ***  update record from SECOALL7 for Security '**CASH**' and Dummy  136935
295000200529      ***  Customer                                                       136935
295100200529      *                                                                   136935
295200200529     C           DUACAA    IFNE 0                                         136935
295300200529     C           DUACAR    ORNE 0                                         136935
295400200529     C           KEY7      CHAINSECOALL7             36                   136935
295500200529      *                                                                   136935
295600200529      ***  If record no longer on file, handle Database Error.            136935
295700200529      *                                                                   136935
295800200529     C           *IN36     IFEQ '1'                                       136935
295900200529     C                     Z-ADD024       DBASE            ***************136935
296000200529     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 24 *136935
296100200529     C                     MOVELWWREFN    DBKEY1           ***************136935
296200200529     C                     MOVE WWOPNB    DBKEY1                          136935
296300200529     C                     MOVELWWBRCD    DBKEY2  9                       136935
296400200529     C                     MOVE WWDDPT    DBKEY2                          136935
296500200529     C                     MOVELDBKEY1    DBKEY3 17                       136935
296600200529     C                     MOVE DBKEY2    DBKEY3                          136935
296700200529     C                     MOVELDBKEY3    DBKEY4 27                       136935
296800200529     C                     MOVE WWSECS    DBKEY4                          136935
296900200529     C                     MOVELWWCOTP    DBKEY5  3                       136935
297000200529     C                     MOVE WWBOOK    DBKEY5                          136935
297100200529     C                     MOVELWWERCU    DBKEY6 10                       136935
297200200529     C                     MOVE WWPTFR    DBKEY6                          136935
297300200529     C                     MOVELDBKEY5    DBKEY7 13                       136935
297400200529     C                     MOVE DBKEY6    DBKEY7                          136935
297500200529     C                     MOVELDBKEY4    DBKEY8 40                       136935
297600200529     C                     MOVE DBKEY7    DBKEY8                          136935
297700200529     C                     MOVELDBKEY8    DBKEY                           136935
297800200529     C                     EXSR *PSSR                                     136935
297900200529     C                     ENDIF                                          136935
298000200529     C                     ADD  DUACAA    MCACAA                          136935
298100200529     C                     ADD  DUACAR    MCACAR                          136935
298200200529     C                     MOVE 'A'       MCCHTP                          136935
298300200529     C                     Z-ADDBJRDNB    MCLCD                           136935
298400200529     C                     MOVE USER      MCLUID                          136935
298500200529     C                     MOVE 'M'       MCREST                          136935
298600200529     C                     UPDATSECOALD0                                  136935
298700200529     C                     ENDIF                                          136935
298800200529      *
298900200529      ***  If error, update subfile.
299000200529      *
299100200529     C                     ELSE
299200200529     C                     MOVE '1'       *IN85            SFLNXTCHG
299300200529     C                     MOVE '1'       *IN45
299400200529     C                     UPDATSE7593S1
299500200529     C                     ENDIF
299600200529      *
299700200529     C                     ELSE
299800200529     C           DDACN3    IFEQ ' '
299900200529     C/COPY WNCPYSRC,SEH00037
300000200529     C                     MOVE '0'       *IN85            SFLNXTCHG
300100200529     C                     MOVE '1'       *IN45
300200200529     C                     UPDATSE7593S1
300300200529     C                     ENDIF
300400200529     C                     ENDIF
300500200529      *
300600200529      ***  Security Line.
300700200529      *
300800200529     C                     ELSE
300900200529      *
301000200529      ***  Reset indicators fields amended.
301100200529      *
301200200529     C                     MOVE 'N'       AMACAR  1        Actual Cash Rounding recalculated ind.
301300200529     C                     MOVE 'N'       AMACAA  1        Actual Cash Allocation recalculated ind.
301400200529     C                     MOVE 'N'       AMASTR  1        Actual Stock Rounding recalculated ind.
301500200529      *                                                                   136935
301600200529     C                     Z-ADD0         DUACAA                          136935
301700200529     C                     Z-ADD0         DUACAR                          136935
301800200529     C                     Z-ADD0         DUASTA 150                      136935
301900200529     C                     Z-ADD0         DUASTR 150                      136935
302000200529      *
302100200529      ***  Actual Stock Allocation and Actual Cash Rounding can not
302200200529      ***  be changed in same time.
302300200529      *
302400200529     C           DDACT2    IFNE DDAC2H
302500200529     C           DDACT4    ANDNEDDAC4H
302600200529     C                     MOVEL'CO00302' ZAMSID
302700200529     C                     MOVE 'N'       VALREC
302800200529     C                     MOVE '1'       *IN59
302900200529     C                     MOVE '1'       *IN61
303000200529     C                     EXSR ZASNMS
303100200529     C                     ELSE
303200200529      *
303300200529      ***  Retrieve CO Depot details for the New Security.
303400200529      *
303500200529     C                     MOVELDDNSEC    WWSECS
303600200529     C           KEY2      CHAINSECODPL3             36
303700200529      *
303800200529      ***  If record no longer on file, handle Database Error.
303900200529      *
304000200529     C           *IN36     IFEQ '1'
304100200529     C                     Z-ADD014       DBASE            ***************
304200200529     C                     MOVEL'SECODPL3'DBFILE           * DB ERROR 14 *
304300200529     C                     MOVELWWREFN    DBKEY1           ***************
304400200529     C                     MOVE WWOPNB    DBKEY1
304500200529     C                     MOVELWWBRCA    DBKEY2  9
304600200529     C                     MOVE WWDPOT    DBKEY2
304700200529     C                     MOVELDBKEY1    DBKEY3 17
304800200529     C                     MOVE DBKEY2    DBKEY3
304900200529     C                     MOVELDBKEY3    DBKEY4 27
305000200529     C                     MOVE WWSECS    DBKEY4
305100200529     C                     MOVELDBKEY4    DBKEY
305200200529     C                     EXSR *PSSR
305300200529     C                     ENDIF
305400200529      *
305500200529      ***  Retrieve New Currency, New Security decimal places and New Price Basis for the new
305600200529      ***  Security.
305700200529      *
305800200529     C                     MOVE WWSECS    KSECN
305900200529     C                     EXSR ACCSEC
306000200529      *
306100200529     C                     MOVE NMCY      WNMCYN  3        New currency
306200200529     C                     Z-ADDNMDP      WNMDPN  10       New Security Decimal Places
306300200529     C                     MOVE SPBS      WSPBSN  1        New Price basis
306400200529      *
306500200529      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
306600200529      *
306700200529     C                     CALL 'AOCURRR0'
306800200529     C                     PARM '*MSG   ' WLRTCD
306900200529     C                     PARM '*KEY   ' WLOPTN
307000200529     C                     PARM NMCY      WLAJCD
307100200529     C           SDCURR    PARM SDCURR    DSSDY
307200200529      *
307300200529      ***  If record not found, handle Database Error.
307400200529      *
307500200529     C           WLRTCD    IFNE *BLANKS
307600200529     C                     Z-ADD015       DBASE            ***************
307700200529     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 15 *
307800200529     C                     MOVELWLAJCD    DBKEY            ***************
307900200529     C                     EXSR *PSSR
308000200529     C                     ENDIF
308100200529     C                     Z-ADDA6NBDP    NMDPCN  10       New Currency Decimal Places
308200200529      *
308300200529      ***  If Actual Stock Allocation is changed.
308400200529      *
308500200529     C           DDACT2    IFNE DDAC2H
308600200529      *
308700200529      ***  Save some fields in work fields.
308800200529      *
308900200529     C                     Z-ADDMBASTA    WWASTA 150       Old Actual Stock Allocation
309000200529     C                     Z-ADDMBASTR    WWASTR 158       Old Actual Stock Rounding
309100200529     C                     Z-ADDMBACAR    WOACAR           Old Actual Cash  Rounding
309200200529     C                     Z-ADDMBHOCA    WWHOCA 150       Holding Taken as Cash
309300200529      *
309400200529      ***  Validate the input.
309500200529      *
309600200529     C                     MOVE *BLANKS   ZFLD17
309700200529     C                     MOVELDDACT2    ZFLD17
309800200529     C                     Z-ADDWNMDPN    ZSDEC            New Security Decimal Places
309900200529     C           15        SUB  ZSDEC     ZSDIG
310000200529     C                     EXSR ZASIGN
310100200529      *
310200200529      ***  Field must be numeric.
310300200529      *
310400200529     C           *IN99     IFEQ '1'
310500200529     C                     MOVE 'N'       VALREC
310600200529     C                     MOVE '1'       *IN59
310700200529     C                     MOVEL'CO00232' ZAMSID
310800200529     C                     EXSR ZASNMS
310900200529     C                     ELSE
311000200529      *
311100200529      ***  Move Actual Stock Allocation entered into work field.
311200200529      *
311300200529     C                     MOVE ZOUT15    WUASTA 150
311400200529     C           ZFSIGN    IFEQ '-'
311500200529     C                     MULT -1        WUASTA
311600200529     C                     ENDIF
311700200529      *
311800200529      ***  Access File depending on CO Type.
311900200529      *
312000200529     C                     SELEC
312100200529     C           WWPTYP    WHEQ 'DV'                       Dividend Events
312200200529     C           KEY3      CHAINSECODVL1             89
312300200529     C                     MOVE 'SECODVL1'DBFILS  8
312400200529      *
312500200529     C           WWPTYP    WHEQ 'CE'                       Capital Change
312600200529     C           KEY3      CHAINSECOCEL1             89
312700200529     C                     MOVE 'SECOCEL1'DBFILS
312800200529      *
312900200529     C           WWPTYP    WHEQ 'RG'                       Rights Issues
313000200529     C           KEY3      CHAINSECORGL1             89
313100200529     C                     MOVE 'SECORGL1'DBFILS
313200200529      *
313300200529     C           WWPTYP    WHEQ 'FR'                       Free Allocation
313400200529     C           KEY3      CHAINSECOFRL1             89
313500200529     C                     MOVE 'SECOFRL1'DBFILS
313600200529      *
313700200529     C           WWPTYP    WHEQ 'OF'                       Offers
313800200529     C           KEY3      CHAINSECOOFL1             89
313900200529     C                     MOVE 'SECOOFL1'DBFILS
314000200529      *
314100200529     C           WWPTYP    WHEQ 'CR'                       Corporate Reorganisation
314200200529     C           KEY3      CHAINSECOCRL1             89
314300200529     C                     MOVE 'SECOCRL1'DBFILS
314400200529      *
314500200529     C           WWPTYP    WHEQ 'EX'                       Exercices and Conversions
314600200529     C           KEY3      CHAINSECOEXL1             89
314700200529     C                     MOVE 'SECOEXL1'DBFILS
314800200529      *                                                                   CEU017
314900200529     C           WWPTYP    WHEQ 'CC'                       Currency       CEU017
315000200529     C           WWREFN    CHAINSECOCCL2             89    Changes.       CEU017
315100200529     C                     MOVE 'SECOCCL2'DBFILS                          CEU017
315200200529     C                     ENDSL
315300200529      *
315400200529      ***  If record not found in its corresponding LF, handle Database Error.
315500200529      *
315600200529     C           *IN89     IFEQ '1'
315700200529     C                     Z-ADD016       DBASE            ***************
315800200529     C                     MOVELDBFILS    DBFILE           * DB ERROR 16 *
315900200529     C                     MOVELWWREFN    DBKEY1  8        ***************
316000200529     C                     MOVE WWOPNB    DBKEY1
316100200529     C                     MOVELDBKEY1    DBKEY
316200200529     C                     EXSR *PSSR
316300200529     C                     ENDIF
316400200529      *
316500200529      ***  If Processing Type not Capital Changes, not Non Financial Events and not Name Changes.
316600200529      *
316700200529     C                     MOVE 'Y'       ASAVAL  1        Actual Stock Allocation valid
316800200529     C           WWPTYP    IFNE 'CE'                       Not Capital Changes
316900200529     C           WWPTYP    ANDNE'NF'                       Not Non Financial Events
317000200529     C           WWPTYP    ANDNE'NC'                       Not Name Changes
317100200529      *
317200200529      ***  Retrieve Number of New Shares, Rounding, Rounding Settlement in Cash, Denomination
317300200529      ***  Multiplier and Compensation Price depending on CO Type.
317400200529      *
317500200529     C                     Z-ADD0         WWDMLT                          135686
317600200529     C           WWPTYP    IFEQ 'CR'
317700200529     C                     MOVEAMHSECA    TSEC,1
317800200529     C                     Z-ADD1         I       20
317900200529     C           WWSECS    LOKUPTSEC,I                   17Search New Security (20 Potential)
318000200529     C           *IN17     IFEQ '0'
318100200529     C                     Z-ADD0         WWNSHA 157       Number of New Shares
318200200529     C                     MOVE ' '       WWRNDN  1        Rounding
318300200529     C                     MOVE ' '       WWRNDS  1        Rounding Settlement in Cash
318400200529     C                     Z-ADD0         WWCOMP 158       Compensation Price
318500200529     C******               Z-ADD0         WWDMLT 158       Denom. Multip. 135686
318600200529     C                     Z-ADD1         WWDMLT 309       Denom. Multip. 135686
318700200529     C                     ELSE
318800200529     C                     MOVEAMHNSHA    TNSH,1
318900200529     C                     MOVE TNSH,I    WWNSHA           Number of New Shares
319000200529     C                     MOVEAMHRNDN    TNDN,1
319100200529     C                     MOVE TNDN,I    WWRNDN           Rounding
319200200529     C                     MOVEAMHRNDS    TNDS,1
319300200529     C                     MOVE TNDS,I    WWRNDS           Rounding Settlement in Cash
319400200529     C                     MOVEAMHCOPA    TOPA,1
319500200529     C                     MOVE TOPA,I    WWCOMP           Compensation Price
319600200529     C                     MOVEAMHDMLA    TDML,1
319700200529     C******               MOVE TDML,I    WWDMLT           Denom. Multip. 135686
319800200529     C                     MOVE TDML,I    WUNUM            Denom. Multip. 135686
319900200529     C                     ENDIF
320000200529     C                     ELSE
320100200529     C                     Z-ADDMDNSHA    WWNSHA           Number of New Shares
320200200529      *                                                                   135685
320300200529      ***  If Processing Type = Currency Change                           135685
320400200529      ***  and Compensation Price is entered as Market,                   135685
320500200529      ***  the Compensation Price must first be calculated                135685
320600200529      ***  from Current Market Price.                                     135685
320700200529      *                                                                   135685
320800200529     C           WWPTYP    IFEQ 'CC'                                      135685
320900200529     C           NAMRKI    ANDEQ'Y'                                       135685
321000200529     C                     EXSR CCOMP                                     135685
321100200529     C                     ENDIF                                          135685
321200200529      *                                                                   135685
321300200529     C                     Z-ADDMDCOMP    WWCOMP           Compensation Price
321400200529     C******               Z-ADDMDDMLT    WWDMLT           Denom. Multip. 135686
321500200529     C                     Z-ADDMDDMLT    WUNUM            Denom. Multip. 135686
321600200529     C                     MOVE MDRNDN    WWRNDN           Rounding
321700200529     C                     MOVE MDRNDS    WWRNDS           Rounding Settlement in Cash
321800200529     C                     ENDIF
321900200529     C******               ENDIF                                          135686
322000200529      *
322100200529      ***  Prepare Denomination Multiplier.
322200200529      *
322300200529     C                     Z-ADDWNMDPN    WWNBDP           New Security Decimal Places
322400200529     C           WWDMLT    IFNE 1                                         135686
322500200529     C                     EXSR RTVNDP                                    135686
322600200529     C                     Z-ADDWWNUM     WWDMLT                          135686
322700200529     C                     ENDIF                                          135686
322800200529      *                                                                   135686
322900200529     C                     Z-ADDWUASTA    WUNUM
323000200529     C                     EXSR RTVNDP
323100200529     C******     WWRNDN    IFEQ 'D'                                       135686
323200200529     C           WWNUM     DIV  WWDMLT    W1ASTA 300
323300200529     C                     MVR            RESTE   90                      135686
323400200529     C******               ELSE                                           135686
323500200529     C******     WWNUM     DIV  WWDMLT    W1ASTA    H                     135686
323600200529     C******               ENDIF                                          135686
323700200529     C******     W1ASTA    MULT WWDMLT    W2ASTA 309                      135686
323800200529      *
323900200529      ***  Actual Stock Allocation entered must be in Denomination Multiplier and Rounding
324000200529      ***  precision.
324100200529      *
324200200529     C******     WWNUM     IFNE W2ASTA                                    135686
324300200529     C           RESTE     IFNE 0                                         135686
324400200529     C                     MOVE 'N'       ASAVAL           Actual Stock Allocation not valid
324500200529     C                     MOVE 'N'       VALREC           Record not valid
324600200529     C                     MOVE '1'       *IN59
324700200529     C                     MOVEL'CO00362' ZAMSID
324800200529     C                     EXSR ZASNMS
324900200529     C                     ENDIF                                          135686
325000200529     C                     ENDIF
325100200529      *
325200200529      ***  If Actual Stock Allocation entered valid.
325300200529      *
325400200529     C           ASAVAL    IFEQ 'Y'
325500200529      *
325600200529      ***  Move Actual Stock Allocation saved into file field.
325700200529      *
325800200529     C                     Z-ADDWUASTA    MBASTA
325900200529      *
326000200529      ***  If Processing Type not Non Financial Events and not Name Changes.
326100200529      *
326200200529     C           WWPTYP    IFNE 'NF'                       If not Non Financial Events
326300200529     C           WWPTYP    ANDNE'NC'                       and not Name Changes
326400200529      *
326500200529      ***  Recalculate Actual Stock Rounding (MBASTR).
326600200529      *
326700200529     C                     EXSR REASTR
326800200529      *
326900200529      ***  Recalculate Actual Cash Rounding (MBACAR).
327000200529      *
327100200529     C                     EXSR REACAR
327200200529      *
327300200529      ***  If Actual Cash Rounding recalculated, recalculate Balancing Cash Rounding (MBBCAR) on
327400200529      ***  file by subtracting old vaue and adding new value of Actual Cash Rounding.
327500200529      *
327600200529     C           AMACAR    IFEQ 'Y'
327700200529     C                     SUB  WOACAR    MBBCAR
327800200529     C                     ADD  MBACAR    MBBCAR
327900200529     C                     Z-ADDMBACAR    WNACAR
328000200529      *                                                                   136935
328100200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
328200200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
328300200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
328400200529      ***  reset it.                                                      136935
328500200529      *                                                                   136935
328600200529     C           MBBCAR    IFNE 0                                         136935
328700200529     C           WWPTYP    ANDEQ'CC'                                      136935
328800200529     C           MBBCAR    ORNE 0                                         136935
328900200529     C           WWPTYP    ANDNE'CC'                                      136935
329000200529     C           BVALDC    ANDEQ'Y'                                       136935
329100200529     C                     Z-ADDMBBCAR    DUACAR                          136935
329200200529     C                     Z-ADD0         MBBCAR                          136935
329300200529     C                     ENDIF                                          136935
329400200529     C                     ENDIF
329500200529      *
329600200529      ***  If Actual Stock Rounding recalculated, recalculate Balancing Stock Rounding (MBBSTR) on
329700200529      ***  file by subtracting old value and adding new value of Actual Stock Rounding.
329800200529      *
329900200529     C           AMASTR    IFEQ 'Y'
330000200529     C                     SUB  WWASTR    MBBSTR
330100200529     C                     ADD  MBASTR    MBBSTR
330200200529      *                                                                   136935
330300200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
330400200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
330500200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
330600200529      ***  reset it.                                                      136935
330700200529      *                                                                   136935
330800200529     C           MBBSTR    IFNE 0                                         136935
330900200529     C           WWPTYP    ANDEQ'CC'                                      136935
331000200529     C           MBBSTR    ORNE 0                                         136935
331100200529     C           WWPTYP    ANDNE'CC'                                      136935
331200200529     C           BVALDC    ANDEQ'Y'                                       136935
331300200529     C                     Z-ADDMBBSTR    DUASTR                          136935
331400200529     C                     Z-ADD0         MBBSTR                          136935
331500200529     C                     ENDIF                                          136935
331600200529     C                     ENDIF
331700200529      *
331800200529     C                     ENDIF
331900200529      *
332000200529      ***  Recalculate Balancing Stock Allocation on file by subtracting
332100200529      ***  Old value and adding New value of Actual Stock Allocation.
332200200529      *
332300200529     C                     SUB  WWASTA    MBBSTA
332400200529     C                     ADD  MBASTA    MBBSTA
332500200529      *                                                                   136935
332600200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
332700200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
332800200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
332900200529      ***  reset it.                                                      136935
333000200529      *                                                                   136935
333100200529     C           MBBSTA    IFNE 0                                         136935
333200200529     C           WWPTYP    ANDEQ'CC'                                      136935
333300200529     C           MBBSTA    ORNE 0                                         136935
333400200529     C           WWPTYP    ANDNE'CC'                                      136935
333500200529     C           BVALDC    ANDEQ'Y'                                       136935
333600200529     C                     Z-ADDMBBSTA    DUASTA                          136935
333700200529     C                     Z-ADD0         MBBSTA                          136935
333800200529     C                     ENDIF                                          136935
333900200529      *
334000200529     C                     ENDIF
334100200529     C                     ENDIF
334200200529     C                     ENDIF
334300200529      *
334400200529      ***  If Actual Cash Rounding is changed.
334500200529      *
334600200529     C           DDACT4    IFNE DDAC4H
334700200529      *
334800200529      ***  Save some fields in work fields.
334900200529      *
335000200529     C                     Z-ADDMBACAR    WOACAR 150       Old Actual Cash Rounding
335100200529      *
335200200529      ***  Validate the input.
335300200529      *
335400200529     C                     MOVE *BLANKS   ZFLD17
335500200529     C                     MOVELDDACT4    ZFLD17
335600200529     C                     Z-ADDNMDPCN    ZSDEC            New Currency Decimal Places
335700200529     C           15        SUB  ZSDEC     ZSDIG
335800200529     C                     EXSR ZASIGN
335900200529      *
336000200529      ***  Field must be numeric.
336100200529      *
336200200529     C           *IN99     IFEQ '1'
336300200529     C                     MOVE 'N'       VALREC
336400200529     C                     MOVE '1'       *IN61
336500200529     C                     MOVEL'CO00231' ZAMSID
336600200529     C                     EXSR ZASNMS
336700200529     C                     ELSE
336800200529      *
336900200529      ***  Move Actual Cash Rounding entered into file field and save it.
337000200529      *
337100200529     C                     MOVE ZOUT15    MBACAR
337200200529     C                     MOVE ZOUT15    WNACAR 150
337300200529     C           ZFSIGN    IFEQ '-'
337400200529     C                     MULT -1        MBACAR
337500200529     C                     MULT -1        WNACAR
337600200529     C                     ENDIF
337700200529      *
337800200529      ***  Recalculate Balancing Cash Rounding on file by subtracting
337900200529      ***  Old value and adding new value of Actual Cash Rounding.
338000200529      *
338100200529     C                     SUB  WOACAR    MBBCAR
338200200529     C                     ADD  MBACAR    MBBCAR
338300200529     C                     MOVE 'Y'       AMACAR           Actual Cash rounding amended ind.
338400200529      *                                                                   136935
338500200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
338600200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
338700200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
338800200529      ***  reset it.                                                      136935
338900200529      *                                                                   136935
339000200529     C           MBBCAR    IFNE 0                                         136935
339100200529     C           WWPTYP    ANDEQ'CC'                                      136935
339200200529     C           MBBCAR    ORNE 0                                         136935
339300200529     C           WWPTYP    ANDNE'CC'                                      136935
339400200529     C           BVALDC    ANDEQ'Y'                                       136935
339500200529     C                     Z-ADDMBBCAR    DUACAR                          136935
339600200529     C                     Z-ADD0         MBBCAR                          136935
339700200529     C                     ENDIF                                          136935
339800200529     C                     ENDIF
339900200529     C                     ENDIF
340000200529     C                     ENDIF
340100200529      *
340200200529      ***  If Actual Stock Allocation or Actual Cash Rounding changed.
340300200529      *
340400200529     C           DDACT2    IFNE DDAC2H
340500200529     C           DDACT4    ORNE DDAC4H
340600200529      *
340700200529      ***  If no error, update current record in LF/SECODPL3.
340800200529      *
340900200529     C           *IN59     IFEQ '0'
341000200529     C           *IN61     ANDEQ'0'
341100200529     C                     MOVE 'A'       MBCHTP
341200200529     C                     MOVE USER      MBLUID
341300200529     C                     Z-ADDBJRDNB    MBLCD
341400200529     C                     UPDATSECODPD0
341600200529     C                     MOVE 'Y'       WWUPDT
341700200529      *                                                                   136935
341800200529      ***  If at least one Balancing Difference has been allocated to     136935
341900200529      ***  Dummy Customer, update record from SECOALL7 for New Security   136935
342000200529      ***  and Dummy Customer.                                            136935
342100200529      *                                                                   136935
342200200529     C           DUASTA    IFNE 0                                         136935
342300200529     C           DUASTR    ORNE 0                                         136935
342400200529     C           DUACAR    ORNE 0                                         136935
342500200529     C           KEY7      CHAINSECOALL7             36                   136935
342600200529      *                                                                   136935
342700200529      ***  If record no longer on file, handle Database Error.            136935
342800200529      *                                                                   136935
342900200529     C           *IN36     IFEQ '1'                                       136935
343000200529     C                     Z-ADD025       DBASE            ***************136935
343100200529     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 25 *136935
343200200529     C                     MOVELWWREFN    DBKEY1           ***************136935
343300200529     C                     MOVE WWOPNB    DBKEY1                          136935
343400200529     C                     MOVELWWBRCD    DBKEY2  9                       136935
343500200529     C                     MOVE WWDDPT    DBKEY2                          136935
343600200529     C                     MOVELDBKEY1    DBKEY3 17                       136935
343700200529     C                     MOVE DBKEY2    DBKEY3                          136935
343800200529     C                     MOVELDBKEY3    DBKEY4 27                       136935
343900200529     C                     MOVE WWSECS    DBKEY4                          136935
344000200529     C                     MOVELWWCOTP    DBKEY5  3                       136935
344100200529     C                     MOVE WWBOOK    DBKEY5                          136935
344200200529     C                     MOVELWWERCU    DBKEY6 10                       136935
344300200529     C                     MOVE WWPTFR    DBKEY6                          136935
344400200529     C                     MOVELDBKEY5    DBKEY7 13                       136935
344500200529     C                     MOVE DBKEY6    DBKEY7                          136935
344600200529     C                     MOVELDBKEY4    DBKEY8 40                       136935
344700200529     C                     MOVE DBKEY7    DBKEY8                          136935
344800200529     C                     MOVELDBKEY8    DBKEY                           136935
344900200529     C                     EXSR *PSSR                                     136935
345000200529     C                     ENDIF                                          136935
345100200529     C                     ADD  DUASTA    MCASTA                          136935
345200200529     C                     ADD  DUASTR    MCASTR                          136935
345300200529     C                     ADD  DUACAR    MCACAR                          136935
345400200529     C                     MOVE 'A'       MCCHTP                          136935
345500200529     C                     Z-ADDBJRDNB    MCLCD                           136935
345600200529     C                     MOVE USER      MCLUID                          136935
345700200529     C                     MOVE 'M'       MCREST                          136935
345800200529     C                     UPDATSECOALD0                                  136935
345900200529     C                     ENDIF                                          136935
346000200529      *
346100200529      ***  Move file fields to subfile fields (Security line).
346200200529      *
346300200529     C                     EXSR P009
346400200529     C                     MOVE '0'       *IN85            SFLNXTCHG
346500200529     C                     MOVE '0'       *IN45
346600200529     C                     UPDATSE7593S1
346700200529      *
346800200529      ***  Access SECODPL3 with Reference, Option Number, Branch, Depot and Security '**CASH**'.
346900200529      *
347000200529     C                     MOVEL'**CASH**'WWSECS    P
347100200529     C           KEY2      CHAINSECODPL3             36
347200200529      *
347300200529      ***  If record no longer on file, handle Database Error.
347400200529      *
347500200529     C           *IN36     IFEQ '1'
347600200529     C                     Z-ADD017       DBASE            ***************
347700200529     C                     MOVEL'SECODPL3'DBFILE           * DB ERROR 17 *
347800200529     C                     MOVELWWREFN    DBKEY1           ***************
347900200529     C                     MOVE WWOPNB    DBKEY1
348000200529     C                     MOVELWWBRCA    DBKEY2  9
348100200529     C                     MOVE WWDPOT    DBKEY2
348200200529     C                     MOVELDBKEY1    DBKEY3 17
348300200529     C                     MOVE DBKEY2    DBKEY3
348400200529     C                     MOVELDBKEY3    DBKEY4 27
348500200529     C                     MOVE WWSECS    DBKEY4
348600200529     C                     MOVELDBKEY4    DBKEY
348700200529     C                     EXSR *PSSR
348800200529     C                     ENDIF
348900200529      *
349000200529      ***  Save some fields in work fields.
349100200529      *
349200200529     C                     Z-ADDMBACAA    WWACAA 150       Old Actual Cash Allocation
349300200529     C                     Z-ADDMBACAR    WWACAR 150       Old Actual Cash Rounding
349400200529     C                     Z-ADDMBBCAA    SVBCAA 150       Balancing Cash Allocation
349500200529     C                     Z-ADDMBHOCA    WWHOCA 150       Holding Taken as Cash
349600200529      *
349700200529      ***  If Actual stock Allocation changed.
349800200529      *
349900200529     C           DDACT2    IFNE DDAC2H
350000200529      *
350100200529      ***  Recalculate Actual Cash Allocation (MBACAA).
350200200529      *
350300200529     C                     EXSR REACAA
350400200529      *
350500200529      ***  If Actual Cash Allocation recalculated, recalculate Balancing Cash (MBBCAA) on file
350600200529      ***  by subtracting old value and adding new value of Actual Cash Allocation.
350700200529      *
350800200529     C           AMACAA    IFEQ 'Y'
350900200529     C                     SUB  WWACAA    MBBCAA
351000200529     C                     ADD  MBACAA    MBBCAA
351100200529      *                                                                   136935
351200200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
351300200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
351400200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
351500200529      ***  reset it.                                                      136935
351600200529      *                                                                   136935
351700200529     C           MBBCAA    IFNE 0                                         136935
351800200529     C           WWPTYP    ANDEQ'CC'                                      136935
351900200529     C           MBBCAA    ORNE 0                                         136935
352000200529     C           WWPTYP    ANDNE'CC'                                      136935
352100200529     C           BVALDC    ANDEQ'Y'                                       136935
352200200529     C                     Z-SUBMBBCAA    DUACAA                          136935
352300200529     C                     Z-ADD0         MBBCAA                          136935
352400200529     C                     ENDIF                                          136935
352500200529     C                     ENDIF
352600200529      *
352700200529     C                     ENDIF
352800200529      *
352900200529      ***  If Actual Cash Rounding recalculated or changed, recalculate Actual Cash Rounding on file
353000200529      ***  by subtracting old value and adding new value of Actual Cash Rounding.
353100200529      *
353200200529     C           AMACAR    IFEQ 'Y'
353300200529     C           WWPTYP    IFEQ 'CR'
353400200529     C                     Z-ADDNMDPCO    WWNBDP           Event Currenbcy Decimal Places
353500200529     C                     ELSE
353600200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
353700200529     C                     ENDIF
353800200529     C                     Z-ADDMBACAR    WUNUM
353900200529     C                     EXSR RTVNDP
354000200529     C                     Z-ADDWWNUM     WUACAR
354100200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
354200200529     C                     Z-ADDWOACAR    WUNUM
354300200529     C                     EXSR RTVNDP
354400200529     C                     SUB  WWNUM     WUACAR
354500200529     C                     Z-ADDWNACAR    WUNUM
354600200529     C                     EXSR RTVNDP
354700200529     C                     ADD  WWNUM     WUACAR
354800200529     C           WWPTYP    IFEQ 'CR'
354900200529     C                     Z-ADDNMDPCO    WWNBDP           Event Currency Decimal Places
355000200529     C                     ELSE
355100200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
355200200529     C                     ENDIF
355300200529     C                     MOVE 'R'       WUROOP           Rounding = half adjust
355400200529     C                     Z-ADDWUACAR    WWNUM
355500200529     C                     EXSR ROUNDD
355600200529     C                     EXSR SETNDP
355700200529     C                     Z-ADDWUNUM     MBACAR           Actual Cash Rounding
355800200529      *
355900200529      ***  Recalculate Balancing Cash on file by adding old value and subtracting new value of
356000200529      ***  Actual Cash Rounding.
356100200529      *
356200200529     C                     ADD  WWACAR    MBBCAA
356300200529     C                     SUB  MBACAR    MBBCAA
356400200529      *                                                                   136935
356500200529      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
356600200529      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
356700200529      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
356800200529      ***  reset it.                                                      136935
356900200529      *                                                                   136935
357000200529     C           MBBCAA    IFNE 0                                         136935
357100200529     C           WWPTYP    ANDEQ'CC'                                      136935
357200200529     C           MBBCAA    ORNE 0                                         136935
357300200529     C           WWPTYP    ANDNE'CC'                                      136935
357400200529     C           BVALDC    ANDEQ'Y'                                       136935
357500200529     C                     Z-ADDMBBCAA    DUACAR                          136935
357600200529     C                     Z-ADD0         MBBCAA                          136935
357700200529     C                     ENDIF                                          136935
357800200529     C                     ENDIF
357900200529      *
358000200529      ***  If Actual Cash Allocation, Actual Cash Rounding or Balancing Cash Allocation changed,
358100200529      ***  update record on LF/SECODPL3.
358200200529      *
358300200529     C           WWACAA    IFNE MBACAA
358400200529     C           WWACAR    ORNE MBACAR
358500200529     C           SVBCAA    ORNE MBBCAA
358600200529     C                     MOVE 'A'       MBCHTP           Type of last change
358700200529     C                     MOVE USER      MBLUID           User Id.
358800200529     C                     Z-ADDBJRDNB    MBLCD            Last change date
358900200529     C                     ENDIF
359000200529     C                     UPDATSECODPD0
359200200529     C                     MOVE 'Y'       WWUPDT           Update done
359300200529      *                                                                   136935
359400200529      ***  If at least one Balancing Difference has been allocated to     136935
359500200529      ***  Dummy Customer, update record from SECOALL7 for New Security   136935
359600200529      ***  and Dummy Customer.                                            136935
359700200529      *                                                                   136935
359800200529     C           DUACAA    IFNE 0                                         136935
359900200529     C           DUACAR    ORNE 0                                         136935
360000200529     C           KEY7      CHAINSECOALL7             36                   136935
360100200529      *                                                                   136935
360200200529      ***  If record no longer on file, handle Database Error.            136935
360300200529      *                                                                   136935
360400200529     C           *IN36     IFEQ '1'                                       136935
360500200529     C                     Z-ADD026       DBASE            ***************136935
360600200529     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 26 *136935
360700200529     C                     MOVELWWREFN    DBKEY1           ***************136935
360800200529     C                     MOVE WWOPNB    DBKEY1                          136935
360900200529     C                     MOVELWWBRCD    DBKEY2  9                       136935
361000200529     C                     MOVE WWDDPT    DBKEY2                          136935
361100200529     C                     MOVELDBKEY1    DBKEY3 17                       136935
361200200529     C                     MOVE DBKEY2    DBKEY3                          136935
361300200529     C                     MOVELDBKEY3    DBKEY4 27                       136935
361400200529     C                     MOVE WWSECS    DBKEY4                          136935
361500200529     C                     MOVELWWCOTP    DBKEY5  3                       136935
361600200529     C                     MOVE WWBOOK    DBKEY5                          136935
361700200529     C                     MOVELWWERCU    DBKEY6 10                       136935
361800200529     C                     MOVE WWPTFR    DBKEY6                          136935
361900200529     C                     MOVELDBKEY5    DBKEY7 13                       136935
362000200529     C                     MOVE DBKEY6    DBKEY7                          136935
362100200529     C                     MOVELDBKEY4    DBKEY8 40                       136935
362200200529     C                     MOVE DBKEY7    DBKEY8                          136935
362300200529     C                     MOVELDBKEY8    DBKEY                           136935
362400200529     C                     EXSR *PSSR                                     136935
362500200529     C                     ENDIF                                          136935
362600200529     C                     ADD  DUACAA    MCACAA                          136935
362700200529     C                     ADD  DUACAR    MCACAR                          136935
362800200529     C                     MOVE 'A'       MCCHTP                          136935
362900200529     C                     Z-ADDBJRDNB    MCLCD                           136935
363000200529     C                     MOVE USER      MCLUID                          136935
363100200529     C                     MOVE 'M'       MCREST                          136935
363200200529     C                     UPDATSECOALD0                                  136935
363300200529     C                     ENDIF                                          136935
363400200529      *
363500200529      ***  If at least one 'CASH' field changed, update 'CASH' line on subfile.
363600200529      *
363700200529     C           UPDCAS    IFEQ 'Y'
363800200529     C/COPY WNCPYSRC,SEH00038
363900200529     C                     Z-ADD#1RRN     W3RRN   40
364000200529     C                     Z-ADD1         #1RRN
364100200529     C           #1RRN     CHAINSE7593S1             89
364200200529      *
364300200529      ***  Move file fields to subfile fields.
364400200529      *
364500200529     C                     EXSR P010
364600200529     C                     MOVE '0'       *IN85            SFLNXTCHG
364700200529     C                     MOVE '1'       *IN45
364800200529     C                     UPDATSE7593S1
364900200529     C                     Z-ADDW3RRN     #1RRN
365000200529     C                     ENDIF
365100200529      *
365200200529      ***  If error, update subfile.
365300200529      *
365400200529     C                     ELSE
365500200529     C                     MOVE '1'       *IN85            SFLNXTCHG
365600200529     C                     MOVE '0'       *IN45
365700200529     C                     UPDATSE7593S1
365800200529     C                     ENDIF
365900200529     C                     ELSE
366000200529     C           DDACN3    IFEQ ' '
366100200529     C                     MOVE '0'       *IN85            SFLNXTCHG
366200200529     C                     MOVE '0'       *IN45
366300200529     C                     UPDATSE7593S1
366400200529     C                     ENDIF
366500200529     C                     ENDIF
366600200529     C                     ENDIF
366700200529      *
366800200529     C                     ENDSR
366900200529      *
367000200529      *****************************************************************
367100200529      /EJECT
367200200529      *****************************************************************
367300200529      *                                                               *
367400200529      *  REASTR - Recalculate Actual Stock Rounding for New Security  *
367500200529      *           on Security line.                                   *
367600200529      *                                                               *
367700200529      *  Called by: V001   - Validate details input (Amend Mode).     *
367800200529      *                                                               *
367900200529      *  Calls: RTVNDP - Set amount from num field 15.0 to num field  *
368000200529      *                  30.9 with Retrieve Number of Decimal Places  *
368100200529      *                  from a Ccy.                                  *
368200200529      *         ROUNDD - Perform rounding to the Number of Decimal    *
368300200529      *                  Places.                                      *
368400200529      *                                                               *
368500200529      *****************************************************************
368600200529      *
368700200529     C           REASTR    BEGSR                           ** REASTR SR **
368800200529      *
368900200529      ***  Retrieve Holding Taken as Stock.
369000200529      *
369100200529     C                     Z-ADDWNMDPO    WWNBDP  10       Event Security Decimal Places
369200200529     C                     Z-ADDMBHOST    WUNUM
369300200529     C                     EXSR RTVNDP
369400200529     C                     Z-ADDWWNUM     WTHOST 309
369500200529      *
369600200529     C           WWPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
369700200529     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
369800200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
369900200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
370000200529      *
370100200529     C           WWPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
370200200529     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
370300200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
370400200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
370500200529      *
370600200529     C           WWPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
370700200529     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
370800200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
370900200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
371000200529      *
371100200529     C           WWPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
371200200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
371300200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
371400200529      *
371500200529     C           WWPTYP    OREQ 'OF'                       Or Processing Type = Offers
371600200529     C           MIOFTY    ANDEQ'E'                           Offer Type = Exchange Offers
371700200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
371800200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
371900200529      ******                                                              136935
372000200529     C******     MAPTYP    OREQ 'OF'                       Or Subscript.  136935
372100200529     C******     MIOFTY    ANDEQ'S'                           Offers      136935
372200200529     C******     MDOSHA    ANDNE0                             Old Sh.not 0136935
372300200529     C******     WWNSHA    ANDNE0                             New Sh.not 0136935
372400200529      *
372500200529     C           WWPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
372600200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
372700200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
372800200529     C           MDSBPR    ANDNE0                             Subscription Price not zero
372900200529      *
373000200529     C           WWPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
373100200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
373200200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
373300200529      *
373400200529     C           WWPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
373500200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
373600200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
373700200529      *                                                                   CEU017
373800200529      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
373900200529      ***  Size not zero.                                                 CEU017
374000200529      *                                                                   CEU017
374100200529     C           WWPTYP    OREQ 'CC'                                      CEU017
374200200529     C           MDOSHA    ANDNE0                                         CEU017
374300200529     C           WWNSHA    ANDNE0                                         CEU017
374400200529      *
374500200529      ***  Calculate work field A = Total of all Customers and Books Holdings Taken as Stock
374600200529      ***  divided by Number of Old Shares.
374700200529      *
374800200529     C           WTHOST    DIV  MDOSHA    FLDA   309
374900200529      *
375000200529      ***  Calculate True Stock Allocation (using Total of all Customers and Books Holdings Taken
375100200529      ***  as Stock as Holding) = work field A previously calculated multiplied by Number of New
375200200529      ***  Shares.
375300200529      *
375400200529     C           FLDA      MULT WWNSHA    WUOTSA 309
375500200529      *
375600200529      ***  Calculate Actual Stock Rounding = True Stock Allocation (using Total of all Customers and
375700200529      ***  Books Holdings Taken as Stock) - Actual Stock Allocation entered.
375800200529      *
375900200529     C                     Z-ADDWNMDPN    WWNBDP  10       New Security Decimal Places
376000200529     C                     Z-ADDMBASTA    WUNUM
376100200529     C                     EXSR RTVNDP                     retrieve Actual Stock Allocation
376200200529     C           WUOTSA    SUB  WWNUM     WUASTR 309
376300200529      *
376400200529      ***  Set Actual Stock Rounding calculated.
376500200529      *
376600200529     C                     Z-ADD8         WWNBDP           8 Decimal Places
376700200529     C                     MOVE WWRNDN    WUROOP  1        Rounding from CO Detail file
376800200529     C                     Z-ADDWUASTR    WWNUM
376900200529     C                     EXSR ROUNDD
377000200529     C                     Z-ADDWWNUM     WUASTR
377100200529     C                     Z-ADDWUASTR    MBASTR           Actual Stock Rounding
377200200529     C                     MOVE 'Y'       AMASTR           Actual Stock Rounding recalculated ind.
377300200529     C                     ENDIF
377400200529      *
377500200529     C           WWPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
377600200529     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
377700200529     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
377800200529     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
377900200529     C           MDSBPR    ANDNE0                             Subscription Price not zero
378000200529      *
378100200529      ***  Calculate Cash Pool = Total of all Customers and Books Holdings Taken as Stock multiplied
378200200529      ***  by Dividend Per Unit.
378300200529      *
378400200529     C******               Z-ADDWNMDPN    WWNBDP           New Sec.Dec.Pl.135690
378500200529     C**********           Z-ADDNMDPCN    WWNBDP           New Cur.135690 190204
378600200529     C**********           Z-ADDMDDIVU    WUNUM                           190204
378700200529     C**********           EXSR RTVNDP                     retrieve Divide190204
378800200529     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
378900200529     C           WTHOST    MULT WWNUM     CASPOO 309
379000200529      *
379100200529      ***  Calculate work field BB = Cash Pool divided by Subscription Price.
379200200529      *
379300200529     C           CASPOO    DIV  MDSBPR    FLDBB  309
379400200529      *
379500200529      ***  If Price Basis is 'P' for %, result should be divided by 100.
379600200529      *
379700200529     C           WSPBSN    IFEQ 'P'
379800200529     C           FLDBB     DIV  100       FLDBB
379900200529     C                     ENDIF
380000200529      *
380100200529      ***  Set True Stock Allocation (using Total of all Customers and Books Holdings Taken
380200200529      ***  as Stock as Holding) = work field BB previously calculated.
380300200529      *
380400200529     C                     Z-ADDFLDBB     WUOTSA
380500200529      *
380600200529      ***  Calculate Actual Stock Rounding = True Stock Allocation (using Total of all Customers and
380700200529      ***  Books Holdings Taken as Stock) - Actual Stock Allocation entered.
380800200529      *
380900200529     C                     Z-ADDWNMDPN    WWNBDP  10       New Security Decimal Places
381000200529     C                     Z-ADDMBASTA    WUNUM
381100200529     C                     EXSR RTVNDP                     Retrieve Actual Stock allocation
381200200529     C           WUOTSA    SUB  WWNUM     WUASTR 309
381300200529      *
381400200529      ***  Set Actual Stock Rounding calculated.
381500200529      *
381600200529     C                     Z-ADD8         WWNBDP           8 Decimal Places
381700200529     C                     MOVE WWRNDN    WUROOP  1        Rounding from CO Detail file
381800200529     C                     Z-ADDWUASTR    WWNUM
381900200529     C                     EXSR ROUNDD
382000200529     C                     Z-ADDWWNUM     WUASTR
382100200529     C                     Z-ADDWUASTR    MBASTR           Actual Stock Rounding
382200200529     C                     MOVE 'Y'       AMASTR           Actual Stock Rounding recalculated ind.
382300200529     C                     ENDIF
382400200529      *
382500200529     C                     ENDSR
382600200529      *
382700200529      *****************************************************************
382800200529      /EJECT
382900200529      *****************************************************************
383000200529      *                                                               *
383100200529      *  REACAR - Recalculate Actual Cash Rounding for New Security   *
383200200529      *           on Security line.                                   *
383300200529      *                                                               *
383400200529      *  Called by: V001   - Validate details input (Amend Mode).     *
383500200529      *                                                               *
383600200529      *  Calls: SETNDP - Set amount from num field 30.9 to num field  *
383700200529      *                  15.0 with Number of Decimal Places from a    *
383800200529      *                  Currency.                                    *
383900200529      *         RTVNDP - Set amount from num field 15.0 to num field  *
384000200529      *                  30.9 with Retrieve Number of Decimal Places  *
384100200529      *                  from a Ccy.                                  *
384200200529      *         ROUNDD - Perform rounding to the Number of Decimal    *
384300200529      *                  Places.                                      *
384400200529      *                                                               *
384500200529      *****************************************************************
384600200529      *
384700200529     C           REACAR    BEGSR                           ** REACAC SR **
384800200529      *
384900200529     C                     Z-ADD0         WUACAR           Reset Actual Cash Rounding work field
385000200529      *
385100200529     C           WWPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
385200200529     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
385300200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
385400200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
385500200529      *
385600200529     C           WWPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
385700200529     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
385800200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
385900200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
386000200529      *
386100200529     C           WWPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
386200200529     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
386300200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
386400200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
386500200529      *
386600200529     C           WWPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
386700200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
386800200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
386900200529      *
387000200529     C           WWPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
387100200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
387200200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
387300200529      *
387400200529     C           WWPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
387500200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
387600200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
387700200529      *
387800200529     C           WWPTYP    OREQ 'OF'                       Or Processing Type = Offers
387900200529     C           MIOFTY    ANDEQ'E'                           Exchange    136935
388000200529     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
388100200529     C           WWNSHA    ANDNE0                             Number of New Shares not zero
388200200529      *
388300200529     C           WWPTYP    OREQ 'EX'                       Or Proces.Type= Exervices and Conversions
388400200529     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
388500200529     C           WWNSHA    ANDNE0                             Number of New Shares not 0
388600200529     C           MDSBPR    ANDNE0                             Subscription Price not 0
388700200529      *                                                                   CEU017
388800200529      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
388900200529      ***  Size not zero.                                                 CEU017
389000200529      *                                                                   CEU017
389100200529     C           WWPTYP    OREQ 'CC'                                      CEU017
389200200529     C           MDOSHA    ANDNE0                                         CEU017
389300200529     C           WWNSHA    ANDNE0                                         CEU017
389400200529      *
389500200529      ***  If Rounding Settlement in Cash = 'Y', Actual Cash Rounding = Actual Stock
389600200529      ***  Rounding re-calculated previously multiplied by Compensation Price.
389700200529      *
389800200529     C           WWRNDS    IFEQ 'Y'
389900200529     C           WUASTR    MULT WWCOMP    WUACAR 309
390000200529      *
390100200529      ***  If Price Basis is 'P' for %, result should be divided by 100.
390200200529      *
390300200529     C           WSPBSN    IFEQ 'P'
390400200529     C           WUACAR    DIV  100       WUACAR
390500200529     C                     ENDIF
390600200529      *
390700200529      ***  Set Actual Cash Rounding calculated.
390800200529      *
390900200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
391000200529     C                     MOVE 'R'       WUROOP           Rounding = half adjust
391100200529     C                     Z-ADDWUACAR    WWNUM  309
391200200529     C                     EXSR ROUNDD
391300200529     C                     Z-ADDWWNUM     WUACAR
391400200529     C                     EXSR SETNDP
391500200529     C                     Z-ADDWUNUM     MBACAR           Actual Cash Rounding
391600200529     C                     MOVE 'Y'       AMACAR           Actual Cash Rounding recalculated ind.
391700200529      *
391800200529      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Actual Cash Rounding to zero.
391900200529      *
392000200529     C                     ELSE
392100200529     C                     Z-ADD0         MBACAR
392200200529     C                     MOVE 'Y'       AMACAR           Actual Cash Rounding recalculated ind.
392300200529     C                     ENDIF
392400200529      *
392500200529     C                     ENDIF
392600200529      *
392700200529     C           WWPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
392800200529     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
392900200529     C********** MDDIVU    ANDNE0                             Dividend Per Unit not zero      190204
393000200529     C           MDDIV1    ANDNE0                             Dividend Per Unit not zero      190204
393100200529     C           MDSBPR    ANDNE0                             Subscription Price not zero
393200200529      *
393300200529      ***  If Rounding Settlement in Cash = 'Y', Actual Cash Rounding = (Holding Taken as Stock
393400200529      ***  from New Security multiplied by Dividend Per Unit) - (Actual Stock Allocation entered
393500200529      ***  multiplied by Subscription Price).
393600200529      *
393700200529     C           WWRNDS    IFEQ 'Y'
393800200529     C                     Z-ADDWNMDPO    WWNBDP           Event Security Decimal Places
393900200529     C                     Z-ADDMBHOST    WUNUM
394000200529     C                     EXSR RTVNDP                     retrieve Holding Taken as Stock
394100200529     C                     Z-ADDWWNUM     WTHOST
394200200529     C******               Z-ADDWNMDPN    WWNBDP           New Sec.Dec.Pl.135690
394300200529     C**********           Z-ADDNMDPCN    WWNBDP           New Cur.135690 190204
394400200529     C**********           Z-ADDMDDIVU    WUNUM                           190204
394500200529     C**********           EXSR RTVNDP                     retrieve Divide190204
394600200529     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
394700200529     C           WTHOST    MULT WWNUM     W1ACAR 309
394800200529     C                     Z-ADDMBASTA    WUNUM
394900200529     C                     EXSR RTVNDP                     retrieve Actual Stock Allocation
395000200529     C           WWNUM     MULT MDSBPR    W2ACAR 309
395100200529      *
395200200529      ***  If Price Basis is 'P' for %, result should be divided by 100.
395300200529      *
395400200529     C           WSPBSN    IFEQ 'P'
395500200529     C           W2ACAR    DIV  100       W2ACAR
395600200529     C                     ENDIF
395700200529     C           W1ACAR    SUB  W2ACAR    WUACAR
395800200529      *
395900200529      ***  Set Actual Cash Rounding calculated.
396000200529      *
396100200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
396200200529     C                     MOVE 'R'       WUROOP           Rounding = half adjust
396300200529     C                     Z-ADDWUACAR    WWNUM  309
396400200529     C                     EXSR ROUNDD
396500200529     C                     Z-ADDWWNUM     WUACAR
396600200529     C                     EXSR SETNDP
396700200529     C                     Z-ADDWUNUM     MBACAR           Actual Cash Rounding
396800200529     C                     MOVE 'Y'       AMACAR           Actual Cash Rounding recalculated ind.
396900200529      *
397000200529      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Actual Cash Rounding to zero.
397100200529      *
397200200529     C                     ELSE
397300200529     C                     Z-ADD0         MBACAR
397400200529     C                     MOVE 'Y'       AMACAR           Actual Cash Rounding recalculated ind.
397500200529     C                     ENDIF
397600200529     C                     ENDIF
397700200529      *
397800200529     C                     ENDSR
397900200529      *
398000200529      *****************************************************************
398100200529      /EJECT
398200200529      *****************************************************************
398300200529      *                                                               *
398400200529      *  REACAA - Recalculate Actual Cash Allocation for Security     *
398500200529      *           '**CASH**' on Security line.                        *
398600200529      *                                                               *
398700200529      *  Called by: V001   - Validate details input (Amend Mode).     *
398800200529      *                                                               *
398900200529      *  Cals: SETNDP - Set amount from num field 30.9 to num field   *
399000200529      *                 15.0 with Number of Decimal Places from a     *
399100200529      *                 Currency.                                     *
399200200529      *        RTVNDP - Set amount from num field 15.0 to num field   *
399300200529      *                 30.9 with Retrieve Number of Decimal Places   *
399400200529      *                 from a Ccy.                                   *
399500200529      *        ROUNDD - Perform rounding to the Number of Decimal     *
399600200529      *                 Places.                                       *
399700200529      *                                                               *
399800200529      *****************************************************************
399900200529      *
400000200529     C           REACAA    BEGSR                           ** REACAA SR **
400100200529      *
400200200529      *****If*Processing*Type*=*Exercices*and*Conversions,*calculate*Actu 161732
400300200529      *****Holding*Taken*as*Cash*from*New*Security*multiplied*by*Subscrip 161732
400400200529      ** If Processing Type = Exercises and Conversions, calculate        161732
400500200529      ** Actual Cash Allocation = Holding Taken as Cash multiplied        161732
400600200529      ** with the Receive/Cash Price.                                     161732
400700200529      *
400800200529     C           WWPTYP    IFEQ 'EX'                       If Exercices and Conversions
400900200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
401000200529     C                     Z-ADDWWHOCA    WUNUM
401100200529     C                     EXSR RTVNDP                     retrieve Holding Taken as Cash
401200200529     C***********WWNUM     MULT MDSBPR    WWACAA                          161732
401300200529     C           WWNUM     MULT MDRCPR    WWACAA                          161732
401400200529      *
401500200529      ***  If Price Basis is 'P' for %, result should be divided by 100.
401600200529      *
401700200529     C           WSPBSN    IFEQ 'P'
401800200529     C           WWACAA    DIV  100       WWACAA
401900200529     C                     ENDIF
402000200529      *
402100200529      ***  Set Actual Cash Allocation calculated.
402200200529      *
402300200529     C                     MOVE 'R'       WUROOP           Rounding = half adjust
402400200529     C                     Z-ADDWWACAA    WWNUM
402500200529     C                     EXSR ROUNDD
402600200529     C                     Z-ADDWWNUM     WWACAA
402700200529     C                     EXSR SETNDP
402800200529     C                     Z-ADDWUNUM     MBACAA           Actual Cash Allocation
402900200529     C                     MOVE 'Y'       AMACAA           Actual Cash Allocation recalculated ind.
403000200529     C                     ELSE
403100200529      *
403200200529      ***  If Processing Type = Dividend Events and Stock Dividend type not Stock for Stock,
403300200529      ***  calculate Actual Cash Allocation = Holding Taken as Cash from New Security
403400200529      ***  multiplied by Dividend Per Unit, and half adjust.
403500200529      *
403600200529     C           WWPTYP    IFEQ 'DV'                       If Dividend Events
403700200529     C           MDSDIT    ANDNE'S'                           not Stock for Stock
403800200529     C******               Z-ADDWNMDPN    WWNBDP           New Sec.Dec.pl.135690
403900200529     C                     Z-ADDNMDPCN    WWNBDP           New Cur.Dec.Pl.135690
404000200529     C**********           Z-ADDMDDIVU    WUNUM                           190204
404100200529     C                     Z-ADDMDDIV1    WUNUM                           190204
404200200529     C                     EXSR RTVNDP                     retrieve Dividend Per Unit
404300200529     C                     Z-ADDWWNUM     WWDIVU 309
404400200529     C                     Z-ADDNMDPCN    WWNBDP           New Currency Decimal Places
404500200529     C                     Z-ADDWWHOCA    WUNUM
404600200529     C                     EXSR RTVNDP                     retrieve Holding Taken as Cash
404700200529     C           WWNUM     MULT WWDIVU    WWACAA
404800200529      *
404900200529      ***  Set Actual Cash Allocation calculated.
405000200529      *
405100200529     C                     MOVE 'R'       WUROOP           Rounding = half adjust
405200200529     C                     Z-ADDWWACAA    WWNUM
405300200529     C                     EXSR ROUNDD
405400200529     C                     Z-ADDWWNUM     WWACAA
405500200529     C                     EXSR SETNDP
405600200529     C                     Z-ADDWUNUM     MBACAA           Actual Cash Allocation
405700200529     C                     MOVE 'Y'       AMACAA           Actual Cash Allocation recalculated ind.
405800200529     C                     ENDIF
405900200529     C                     ENDIF
406000200529      *                                                                   136935
406100200529      ***  If Processing Type = Offers with Offer Type = Subscription,    136935
406200200529      ***  calculate Actual Cash Allocation = Actual Stock Allocation     136935
406300200529      ***  multiplied by Subscription Price.                              136935
406400200529      *                                                                   136935
406500200529     C           MAPTYP    IFEQ 'OF'                                      136935
406600200529     C           MIOFTY    ANDEQ'S'                                       136935
406700200529     C                     Z-ADDWNMDPN    ZSDEC                           136935
406800200529     C                     Z-ADDWUASTA    WUNUM                           136935
406900200529     C                     EXSR RTVNDP                                    136935
407000200529     C           WWNUM     MULT MISUPR    WWACAA                          136935
407100200529      *                                                                   136935
407200200529      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
407300200529      *                                                                   136935
407400200529     C           WSPBSN    IFEQ 'P'                                       136935
407500200529     C           WWACAA    DIV  100       WWACAA                          136935
407600200529     C                     ENDIF                                          136935
407700200529      *                                                                   136935
407800200529      ***  Set Actual Cash Allocation calculated.                         136935
407900200529      *                                                                   136935
408000200529     C                     Z-ADDNMDPCN    WWNBDP           New Cur.Dec.Pl.136935
408100200529     C                     MOVE 'R'       WUROOP           Half Adjust    136935
408200200529     C                     Z-ADDWWACAA    WWNUM                           136935
408300200529     C                     EXSR ROUNDD                                    136935
408400200529     C                     Z-ADDWWNUM     WWACAA                          136935
408500200529     C                     EXSR SETNDP                                    136935
408600200529     C                     Z-ADDWUNUM     MBACAA                          136935
408700200529     C                     MOVE 'Y'       AMACAA                          136935
408800200529     C                     ENDIF                                          136935
408900200529      *
409000200529     C                     ENDSR
409100200529      *
409200200529      *****************************************************************
409300200529      /EJECT
409400200529      *****************************************************************
409500200529      *                                                               *
409600200529      *  U001   - Load field for file SECODRL0.                       *
409700200529      *                                                               *
409800200529      *  Called by: P008   - Update/Write LF/SECODRL0 (Amend Mode).   *
409900200529      *                                                               *
410000200529      *  Calls: ZDATE1 - Standart subroutine to validate dates        *
410100200529      *                  submitted and convert to a number of days.   *
410200200529      *                                                               *
410300200529      *****************************************************************
410400200529      *
410500200529     C           U001      BEGSR                           ** U001 SR **
410600200529      *
410700200529      ***  If record not found in LF/SECODRL0, load "inserted" fields.
410800200529      *
410900200529     C           *IN35     IFEQ '1'
411000200529     C                     MOVE 'D'       MSRECI           Record Id.
411100200529     C                     MOVE 'I'       MSCHTP           Type of last Change = Insert
411200200529     C                     MOVE DDREF3    MSCORF           Reference Number
411300200529     C                     MOVE DDBRC3    MSBRCD           Branch
411400200529     C                     MOVELDDDEP3    MSDDPT           Depot
411500200529     C                     ELSE
411600200529      *
411700200529      ***  Else, if record found in LF/SECODRL0, load "changed" fields.
411800200529      *
411900200529     C                     MOVE 'A'       MSCHTP           Type of last Change = Amend
412000200529     C                     ENDIF
412100200529      *
412200200529      ***  Load file fields.
412300200529      *
412400200529     C                     Z-ADDBJRDNB    MSLCD            Last Change Date = Run Date
412500200529     C                     MOVELUSER      MSLUID           User Id.
412600200529     C                     MOVE DDFLA3    MSFAID           Final Allocation Indicator
412700200529     C                     MOVE DDSTS3    MSCOST           Corporate Actions Status
412800200529      *
412900200529     C                     MOVE DDLTA3    ZDATE
413000200529     C                     EXSR ZDATE1
413100200529     C                     Z-ADDZDAYNO    MSCOAD           Last Allocation Date
413200200529      *
413300200529     C                     ENDSR
413400200529      *
413500200529      *****************************************************************
413600200529      /EJECT
413700200529      *****************************************************************
413800200529      *                                                               *
413900200529      *  U002   - Load fields for file SECODPL3 with all amounts = 0. *
414000200529      *                                                               *
414100200529      *  Called by: P004   - Build the subfile (Amend Mode).          *
414200200529      *                                                               *
414300200529      *  Calls: ZASIGN - Standart subroutine to validate and          *
414400200529      *                  right-align signed numeric fields.           *
414500200529      *                                                               *
414600200529      *****************************************************************
414700200529      *
414800200529     C           U002      BEGSR                           ** U002 SR **
414900200529      *
415000200529      ***  Load file fields.
415100200529      *
415200200529     C                     MOVE 'D'       MBRECI           Record Id.
415300200529     C                     Z-ADDBJRDNB    MBLCD            Last Change Date = Run Date
415400200529     C                     MOVE 'I'       MBCHTP           Type of last Change = Insert
415500200529     C                     MOVELUSER      MBLUID           User Id.
415600200529      *
415700200529     C                     MOVE DDREF3    MBCORF           Reference Number
415800200529     C                     MOVE DDOPT3    MBOPTN           Option Number
415900200529     C                     MOVE DDBRC3    MBBRCD           Branch
416000200529     C                     MOVELDDDEP3    MBDDPT           Depot
416100200529      *
416200200529     C                     MOVE WWSECS    MBSESN           New Security Shortname
416300200529      *
416400200529     C                     MOVE *BLANKS   ZFLD17
416500200529     C                     MOVELWWEXPO    ZFLD17
416600200529     C                     Z-ADDWNMDPO    ZSDEC            Event Security Decimal Places
416700200529     C           15        SUB  ZSDEC     ZSDIG
416800200529     C                     EXSR ZASIGN
416900200529     C                     MOVE ZOUT15    MBEXPO           Ex-Date Position
417000200529      *
417100200529      ***  Set all amounts to 0.
417200200529      *
417300200529     C                     Z-ADD*ZEROS    MBOALR           Original Stock Allocation
417400200529     C                     Z-ADD*ZEROS    MBOTSA           True Stock Allocation
417500200529     C                     Z-ADD*ZEROS    MBOSTR           Original Stock Rounding
417600200529     C                     Z-ADD*ZEROS    MBOCAR           Original Cash Rounding
417700200529     C                     Z-ADD*ZEROS    MBCAOP           Original Cash Option
417800200529     C                     Z-ADD*ZEROS    MBASTA           Actual Stock Allocation
417900200529     C                     Z-ADD*ZEROS    MBHOST           Holding Taken as Stock
418000200529     C                     Z-ADD*ZEROS    MBHOCA           Holding Taken as Cash
418100200529     C                     Z-ADD*ZEROS    MBACAA           Actual Cash Allocation
418200200529     C                     Z-ADD*ZEROS    MBASTR           Actual Stock Rounding
418300200529     C                     Z-ADD*ZEROS    MBACAR           Actual Cash Rounding
418400200529     C                     Z-ADD*ZEROS    MBBSTA           Balancing Stock Allocation
418500200529     C                     Z-ADD*ZEROS    MBBCAA           Balancing Cash Allocation
418600200529     C                     Z-ADD*ZEROS    MBBSTR           Balancing Stock Rounding
418700200529     C                     Z-ADD*ZEROS    MBBCAR           Balancing Cash Rounding
418800200529      *
418900200529     C                     Z-ADD*ZEROS    MBTNL1           Position Settlement TNL1 = 0
419000200529     C                     MOVE *BLANKS   MBCOAT           Corporate Action Type = blank
419100200529      *
419200200529     C                     ENDSR
419300200529      *
419400200529      *****************************************************************
419500200529      /EJECT
419600200529      *****************************************************************
419700200529      *                                                               *
419800200529      *  ACCSEC - Access Security Details file.                       *
419900200529      *                                                               *
420000200529      *  Called by: P001   - Initial processing.                      *
420100200529      *             P004   - Build the subfile (Amend Mode).          *
420200200529      *             V001   - Validate details input (Amend Mode).     *
420300200529      *                                                               *
420400200529      *  Calls: *PSSR  - Error processing.                            *
420500200529      *                                                               *
420600200529      *****************************************************************
420700200529      *
420800200529     C           ACCSEC    BEGSR                           ** ACCSEC SR **
420900200529      *
421000200529      ***  Retrieve Nominal Currency, Nominal Currency decimal Places and Price Basis.
421100200529      *
421200200529     C           KSECN     CHAINSECTYZ1              30
421300200529      *
421400200529      ***  If no record found, handle Database Error.
421500200529      *
421600200529     C           *IN30     IFEQ '1'
421700200529     C                     Z-ADD018       DBASE            ***************
421800200529     C                     MOVEL'SECTY   'DBFILE           * DB ERROR 18 *
421900200529     C                     MOVELKSECN     DBKEY            ***************
422000200529     C                     EXSR *PSSR
422100200529     C                     ENDIF
422200200529      *
422300200529     C                     ENDSR
422400200529      *
422500200529      *****************************************************************
422600200529      /EJECT
422700200529      *****************************************************************
422800200529      *                                                               *
422900200529      *  *PSSR  - Error processing.                                   *
423000200529      *                                                               *
423100200529      *  Called by: P001   - Initial processing.                      *
423200200529      *             P004   - Build the subfile (Amend Mode).          *
423300200529      *             P007   - Process Action.                          *
423400200529      *             V001   - Validate details input (Amend Mode).     *
423500200529      *             ACCSEC - Access Security Details file.            *
423600200529      *                                                               *
423700200529      *  Calls: None.                                                 *
423800200529      *                                                               *
423900200529      *****************************************************************
424000200529      *
424100200529     C           *PSSR     BEGSR                           ** *PSSR SR **
424200200529      *
424300200529      ***  Update LDA with error information.
424400200529      *
424500200529     C           *NAMVAR   DEFN           LDA
424600200529     C           *LOCK     IN   LDA
424700200529     C                     MOVELDBFILE    WWFILE
424800200529     C                     MOVELDBKEY     WWKEY
424900200529     C                     MOVELDBPGM     WWPGM
425000200529     C                     MOVELDBASE     WWASE
425100200529     C                     OUT  LDA
425200200529      *
425300200529      ***  Rollback changes, print dump and cancel program.
425400200529      *
425500200529     C                     ROLBK
425600200529     C                     MOVE 'E'       WWRTCD
425700200529     C                     DUMP
425800200529      *
425900200529     C                     MOVE '1'       *INU7
426000200529     C                     MOVE '1'       *INU8
426100200529     C                     MOVE '1'       *INLR
426200200529     C                     RETRN
426300200529      *
426400200529     C                     ENDSR
426500200529      *
426600200529      *****************************************************************
426700200529      /EJECT
426800200529      *****************************************************************
426900200529      *                                                               *
427000200529      *  ZASNMS - Send message to program message queue.              *
427100200529      *                                                               *
427200200529      *  Called by: P002   - Detail processing.                       *
427300200529      *             P006   - Validate and perform Action taken (Amend *
427400200529      *                      Mode).                                   *
427500200529      *             V001   - Validate details input (Amend Mode).     *
427600200529      *                                                               *
427700200529      *  Calls: Y2SNMGC  - Midas ABS Send a message SNDxxxMSG.        *
427800200529      *                                                               *
427900200529      *****************************************************************
428000200529      *
428100200529     C           ZASNMS    BEGSR                           ** ZASNMS SR **
428200200529      *
428300200529      ***  Send message.
428400200529      *
428500200529     C                     CALL 'Y2SNMGC'
428600200529     C                     PARM           ZAPGM            Program queue
428700200529     C                     PARM           ZAPGRL           Rel queue
428800200529     C                     PARM           ZAMSID           Message Id.
428900200529     C                     PARM           ZAMSGF           Message file.
429000200529     C                     PARM           ZAMSDA           Message data.
429100200529     C                     PARM           ZAMSTP           Message type.
429200200529      *
429300200529      ***  Clear all fields for default mechanism next time.
429400200529      *
429500200529     C                     MOVEL*BLANKS   ZAPGM            Message queue
429600200529     C                     MOVEL*BLANKS   ZAPGRL           Rel queue
429700200529     C                     MOVEL*BLANKS   ZAMSDA           Message data.
429800200529     C                     MOVEL*BLANKS   ZAMSTP           Message type.
429900200529      *
430000200529     C                     ENDSR
430100200529      *
430200200529      *****************************************************************
430300200529      /EJECT
430400200529      *****************************************************************
430500200529      *                                                               *
430600200529      *  SETNDP - Set amount from num field 30.9 to num field 15.0    *
430700200529      *           with Number of Decimal Places from a Currency.      *
430800200529      *                                                               *
430900200529      *  Called by: V001   - Validate details input (Amend Mode).     *
431000200529      *             REACAR - Recalculate Actual Cash Rounding for New *
431100200529      *                      Security on Security line.               *
431200200529      *             REACAA - Recalculate Actual Cash Allocation for   *
431300200529      *                      Security '**CASH**' on Security line.    *
431400200529      *                                                               *
431500200529      *  Calls: None.                                                 *
431600200529      *                                                               *
431700200529      *****************************************************************
431800200529      *
431900200529     C           SETNDP    BEGSR                           ** SETNDP SR **
432000200529      *
432100200529     C           WWNBDP    IFEQ 0                          If no Decimal Place
432200200529     C                     Z-ADDWWNUM     WUNUM  150
432300200529     C                     ELSE
432400200529     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
432500200529     C           WWNUM     MULT 10        WUNUM
432600200529     C                     ELSE
432700200529     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
432800200529     C           WWNUM     MULT 100       WUNUM
432900200529     C                     ELSE
433000200529     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
433100200529     C           WWNUM     MULT 1000      WUNUM
433200200529     C                     ELSE
433300200529     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
433400200529     C           WWNUM     MULT 10000     WUNUM
433500200529     C                     ENDIF
433600200529     C                     ENDIF
433700200529     C                     ENDIF
433800200529     C                     ENDIF
433900200529     C                     ENDIF
434000200529      *
434100200529     C                     ENDSR
434200200529      *
434300200529      *****************************************************************
434400200529      /EJECT
434500200529      *****************************************************************
434600200529      *                                                               *
434700200529      *  RTVNDP - Set amount from num field 15.0 to num field 30.9    *
434800200529      *           with Retrieve Number of Decimal Places from a Ccy.  *
434900200529      *                                                               *
435000200529      *  Called by: V001   - Validate details input (Amend Mode).     *
435100200529      *             REASTR - Recalculate Actual Stock Rounding for    *
435200200529      *                      New Security on Security line.           *
435300200529      *             REACAR - Recalculate Actual Cash Rounding for New *
435400200529      *                      Security on Security line.               *
435500200529      *             REACAA - Recalculate Actual Cash Allocation for   *
435600200529      *                      Security '**CASH**' on Security line.    *
435700200529      *                                                               *
435800200529      *  Calls: None.                                                 *
435900200529      *                                                               *
436000200529      *****************************************************************
436100200529      *
436200200529     C           RTVNDP    BEGSR                           ** RTVNDP SR **
436300200529      *
436400200529     C           WWNBDP    IFEQ 0                          If no Decimal Place
436500200529     C                     Z-ADDWUNUM     WWNUM
436600200529     C                     ELSE
436700200529     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
436800200529     C           WUNUM     DIV  10        WWNUM
436900200529     C                     ELSE
437000200529     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
437100200529     C           WUNUM     DIV  100       WWNUM
437200200529     C                     ELSE
437300200529     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
437400200529     C           WUNUM     DIV  1000      WWNUM
437500200529     C                     ELSE
437600200529     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
437700200529     C           WUNUM     DIV  10000     WWNUM
437800200529     C                     ENDIF
437900200529     C                     ENDIF
438000200529     C                     ENDIF
438100200529     C                     ENDIF
438200200529     C                     ENDIF
438300200529      *
438400200529     C                     ENDSR
438500200529      *
438600200529      *****************************************************************
438700200529      /EJECT
438800200529      *****************************************************************
438900200529      *                                                               *
439000200529      *  ROUNDD - Perform rounding to the Number of Decimal Places.   *
439100200529      *                                                               *
439200200529      *  Called by: V001   - Validate details input (Amend Mode).     *
439300200529      *             REASTR - Recalculate Actual Stock Rounding for    *
439400200529      *                      New Security on Security line.           *
439500200529      *             REACAR - Recalculate Actual Cash Rounding for New *
439600200529      *                      Security on Security line.               *
439700200529      *             REACAA - Recalculate Actual Cash Allocation for   *
439800200529      *                      Security '**CASH**' on Security line.    *
439900200529      *                                                               *
440000200529      *  Calls: None.                                                 *
440100200529      *                                                               *
440200200529      *****************************************************************
440300200529      *
440400200529     C           ROUNDD    BEGSR                           ** ROUNDD SR **
440500200529      *
440600200529     C           WWNBDP    IFEQ 0                          If no Decimal Place
440700200529     C           WUROOP    IFEQ 'R'
440800200529     C                     Z-ADDWWNUM     WUFLD0 300H
440900200529     C                     ELSE
441000200529     C                     Z-ADDWWNUM     WUFLD0
441100200529     C           WUROOP    IFEQ 'U'
441200200529     C           WWNUM     ANDNEWUFLD0
441300200529     C                     ADD  1         WUFLD0
441400200529     C                     ENDIF
441500200529     C                     ENDIF
441600200529     C                     Z-ADDWUFLD0    WWNUM
441700200529     C                     ELSE
441800200529     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
441900200529     C           WUROOP    IFEQ 'R'
442000200529     C                     Z-ADDWWNUM     WUFLD1 301H
442100200529     C                     ELSE
442200200529     C                     Z-ADDWWNUM     WUFLD1
442300200529     C           WUROOP    IFEQ 'U'
442400200529     C           WWNUM     ANDNEWUFLD1
442500200529     C                     ADD  0.1       WUFLD1
442600200529     C                     ENDIF
442700200529     C                     ENDIF
442800200529     C                     Z-ADDWUFLD1    WWNUM
442900200529     C                     ELSE
443000200529     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
443100200529     C           WUROOP    IFEQ 'R'
443200200529     C                     Z-ADDWWNUM     WUFLD2 302H
443300200529     C                     ELSE
443400200529     C                     Z-ADDWWNUM     WUFLD2
443500200529     C           WUROOP    IFEQ 'U'
443600200529     C           WWNUM     ANDNEWUFLD2
443700200529     C                     ADD  0.01      WUFLD2
443800200529     C                     ENDIF
443900200529     C                     ENDIF
444000200529     C                     Z-ADDWUFLD2    WWNUM
444100200529     C                     ELSE
444200200529     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
444300200529     C           WUROOP    IFEQ 'R'
444400200529     C                     Z-ADDWWNUM     WUFLD3 303H
444500200529     C                     ELSE
444600200529     C                     Z-ADDWWNUM     WUFLD3
444700200529     C           WUROOP    IFEQ 'U'
444800200529     C           WWNUM     ANDNEWUFLD3
444900200529     C                     ADD  0.001     WUFLD3
445000200529     C                     ENDIF
445100200529     C                     ENDIF
445200200529     C                     Z-ADDWUFLD3    WWNUM
445300200529     C                     ELSE
445400200529     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
445500200529     C           WUROOP    IFEQ 'R'
445600200529     C                     Z-ADDWWNUM     WUFLD4 304H
445700200529     C                     ELSE
445800200529     C                     Z-ADDWWNUM     WUFLD4
445900200529     C           WUROOP    IFEQ 'U'
446000200529     C           WWNUM     ANDNEWUFLD4
446100200529     C                     ADD  0.0001    WUFLD4
446200200529     C                     ENDIF
446300200529     C                     ENDIF
446400200529     C                     Z-ADDWUFLD4    WWNUM
446500200529     C                     ELSE
446600200529     C           WWNBDP    IFEQ 8                          If 8 Decimal Places
446700200529     C           WUROOP    IFEQ 'R'
446800200529     C                     Z-ADDWWNUM     WUFLD8 308H
446900200529     C                     ELSE
447000200529     C                     Z-ADDWWNUM     WUFLD8
447100200529     C           WUROOP    IFEQ 'U'
447200200529     C           WWNUM     ANDNEWUFLD8
447300200529     C                     ADD  0.00000001WUFLD8
447400200529     C                     ENDIF
447500200529     C                     ENDIF
447600200529     C                     Z-ADDWUFLD8    WWNUM
447700200529     C                     ENDIF
447800200529     C                     ENDIF
447900200529     C                     ENDIF
448000200529     C                     ENDIF
448100200529     C                     ENDIF
448200200529     C                     ENDIF
448300200529      *
448400200529     C                     ENDSR
448500200529      *
448600200529      *****************************************************************
448700200529      /EJECT
448800200529      *****************************************************************
448900200529      *                                                               *
449000200529      *  CSBPR  - Calculate Subscription Price if Subscription Price  *
449100200529      *           entered as Market for Dividend Events.              *
449200200529      *                                                               *
449300200529      *  Called by: P004   - Build the subfile (Amend Mode).          *
449400200529      *                                                               *
449500200529      *  Calls: None.                                                 *
449600200529      *                                                               *
449700200529      *****************************************************************
449800200529      *
449900200529     C           CSBPR     BEGSR                           ** CSBPR SR **
450000200529      *
450100200529      ***  Find Market Price with correct Date.
450200200529      *
450300200529     C                     MOVE 'N'       WWCHCK  1
450400200529      *
450500200529     C                     MOVE WWEXDT    KPVDT
450600200529     C           KEY4      SETGTPRICM
450700200529     C                     READPPRICM                    44
450800200529      *
450900200529      ***  If record found use this Price.
451000200529      *
451100200529     C           *IN44     IFEQ '0'
451200200529     C           PSSN      ANDEQMDNSEC
451300200529     C                     MOVE 'Y'       WWCHCK
451400200529      *
451500200529      ***  Otherwise check for Current Price.
451600200529      *
451700200529     C                     ELSE
451800200529     C                     Z-ADD*HIVAL    KPVDT
451900200529      *
452000200529     C           KEY4      SETGTPRICM
452100200529     C                     READPPRICM                    44
452200200529      *
452300200529      ***  If record found use this price.
452400200529      *
452500200529     C           *IN44     IFEQ '0'
452600200529     C           PSSN      ANDEQMDNSEC
452700200529     C                     MOVE 'Y'       WWCHCK
452800200529     C                     ENDIF
452900200529     C                     ENDIF
453000200529      *
453100200529     C           WWCHCK    IFEQ 'N'
453200200529     C                     Z-ADDMKPR      MPRICE 158       Market Price from Security file.
453300200529     C                     ELSE
453400200529     C                     Z-ADDPPRC      MPRICE
453500200529     C                     ENDIF
453600200529      *
453700200529      ***  Calculate Subscription Price = Current Market Price minus Discount.
453800200529      *
453900200529     C           MPRICE    MULT MDDSRT    WWSBPR 158
454000200529     C           WWSBPR    DIV  100       WWSBPR
454100200529     C           MPRICE    SUB  WWSBPR    MDSBPR
454200200529      *
454300200529     C                     ENDSR
454400200529      *
454500200529      *****************************************************************
454600200529      /EJECT                                                              135685
454700200529      *****************************************************************   135685
454800200529      *                                                               *   135685
454900200529      *  CCOMP  - Calculate Compensation Price if Compensation Price  *   135685
455000200529      *           entered as Market for Currency Change Events        *   135685
455100200529      *                                                               *   135685
455200200529      *  Called by: P004   - Build the subfile (Amend Mode).          *   135685
455300200529      *                                                               *   135685
455400200529      *  Calls: None.                                                 *   135685
455500200529      *                                                               *   135685
455600200529      *****************************************************************   135685
455700200529      *                                                                   135685
455800200529     C           CCOMP     BEGSR                           ** CCOMP SR ** 135685
455900200529      *                                                                   135685
456000200529      ***  Find Market Price with correct Date.                           135685
456100200529      *                                                                   135685
456200200529     C                     MOVE 'N'       WWCHCK  1                       135685
456300200529      *                                                                   135685
456400200529     C           WWREFN    CHAINSECORFL1             89                   135685
456500200529      *                                                                   135685
456600200529     C           *IN89     IFEQ '1'                                       135685
456700200529     C                     Z-ADD021       DBASE            ***************135685
456800200529     C                     MOVEL'SECORFL1'DBFILE           * DB ERROR 21 *135685
456900200529     C                     MOVELWWREFN    DBKEY            ***************135685
457000200529     C                     EXSR *PSSR                                     135685
457100200529     C                     ENDIF                                          135685
457200200529      *                                                                   135685
457300200529     C           KEY5      KLIST                                          135685
457400200529     C                     KFLD           NANSEC           New Security   135685
457500200529     C                     KFLD           KALEF   50       Alloc. Effect. 135685
457600200529      *                                                                   135685
457700200529     C                     Z-ADDMAALEF    KALEF                           135685
457800200529      *                                                                   135685
457900200529     C           KEY5      SETGTPRICM                                     135685
458000200529     C                     READPPRICM                    44               135685
458100200529      *                                                                   135685
458200200529      ***  If record found use this Price.                                135685
458300200529      *                                                                   135685
458400200529     C           *IN44     IFEQ '0'                                       135685
458500200529     C           PSSN      ANDEQNANSEC                                    135685
458600200529     C                     MOVE 'Y'       WWCHCK                          135685
458700200529      *                                                                   135685
458800200529      ***  Otherwise check for Current Price.                             135685
458900200529      *                                                                   135685
459000200529     C                     ELSE                                           135685
459100200529     C                     Z-ADD*HIVAL    KALEF                           135685
459200200529      *                                                                   135685
459300200529     C           KEY5      SETGTPRICM                                     135685
459400200529     C                     READPPRICM                    44               135685
459500200529      *                                                                   135685
459600200529      ***  If record found use this price.                                135685
459700200529      *                                                                   135685
459800200529     C           *IN44     IFEQ '0'                                       135685
459900200529     C           PSSN      ANDEQNANSEC                                    135685
460000200529     C                     MOVE 'Y'       WWCHCK                          135685
460100200529     C                     ENDIF                                          135685
460200200529     C                     ENDIF                                          135685
460300200529      *                                                                   135685
460400200529     C           WWCHCK    IFEQ 'N'                                       135685
460500200529     C                     Z-ADDMKPR      MDCOMP 158       Market Price   135685
460600200529     C                     ELSE                                           135685
460700200529     C                     Z-ADDPPRC      MDCOMP                          135685
460800200529     C                     ENDIF                                          135685
460900200529      *                                                                   135685
461000200529     C                     ENDSR                                          135685
461100200529      *                                                                   135685
461200200529      *****************************************************************   135685
461300200529      /EJECT
461400200529      *****************************************************************
461500200529      *                                                               *
461600200529      *  ZSEDIT - Standart subroutine to insert a decimal point into  *
461700200529      *           a numeric field and to blank out leading zeroes.    *
461800200529      *                                                               *
461900200529      *  Called by: P009   - Move file fields to screen fields for    *
462000200529      *                      New Security.                            *
462100200529      *             P010   - Move file fields to screen fields for    *
462200200529      *                      Security '**CASH**'.                     *
462300200529      *                                                               *
462400200529      *  Calls: None.                                                 *
462500200529      *                                                               *
462600200529      *****************************************************************
462700200529      *
462800200529     C/COPY ZSRSRC,ZSEDITZ3
462900200529      *
463000200529      /EJECT
463100200529      *****************************************************************
463200200529      *                                                               *
463300200529      *  ZDATE1 - Standart subroutine to validate dates submitted and *
463400200529      *           convert to a number of days.                        *
463500200529      *                                                               *
463600200529      *  Called by: U001   - Load field for file SECODRL0.            *
463700200529      *                                                               *
463800200529      *  Calls: None.                                                 *
463900200529      *                                                               *
464000200529      *****************************************************************
464100200529      *
464200200529     C/COPY ZSRSRC,ZDATE1Z2
464300200529      *
464400200529      /EJECT
464500200529      *****************************************************************
464600200529      *                                                               *
464700200529      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
464800200529      *           date formats.                                       *
464900200529      *                                                               *
465000200529      *  Called by: P001   - Initial processing.                      *
465100200529      *                                                               *
465200200529      *  Calls: None.                                                 *
465300200529      *                                                               *
465400200529      *****************************************************************
465500200529      *
465600200529     C/COPY ZSRSRC,ZDATE2Z4
465700200529      *
465800200529      /EJECT
465900200529      *****************************************************************
466000200529      *                                                               *
466100200529      *  ZASIGN - Standart subroutine to validate and right-align     *
466200200529      *           signed numeric fields.                              *
466300200529      *                                                               *
466400200529      *  Called by: V001   - Validate details input (Amend Mode).     *
466500200529      *             U002   - Load fields for file SECODPL3 with all   *
466600200529      *                      amounts = 0.                             *
466700200529      *                                                               *
466800200529      *  Calls: None.                                                 *
466900200529      *                                                               *
467000200529      *****************************************************************
467100200529      *
467200200529     C/COPY ZSRSRC,ZASIGNZ2
467300200529      *
467400200529      /EJECT
467500200529**  TXT - Text message for command keys.
467600200529F3=Exit  F12=Previous Screen  Rollup/Down
467700200529F3=Exit  F12=Previous
467800200529F3=Exit F5=Refresh Screen F12=Previous F20=Exit Without Saving   Rollup/Down
467900200529F12=Previous
468000200529Enter 'N' to Save Changes or 'Y' to Remove Changes
468100200529**  CNSARR - Titles for subfile lines.
468200200529Cash
468300200529Cash Opt/Allocat
468400200529Cash Rounding
468500200529New Security
468600200529Stock Allocation
468700200529Stock Rounding
468800200529**  NARR - Error narrative when calling PGM.
468900200529ERROR CALLING PGM 'SE0040'
469000200529ERROR CALLING PGM 'SE7513'
469100200529ERROR CALLING PGM 'SEC023'
469200200529**  ZYDY - Years in days cumulative, four year span,
4693002005290366073110961461
469400200529**  ZMDY - Months in days cumulative through year,
469500200529000031059090120151181212243273304334365
469600200529**  ZMNM - Months short name.
469700200529JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
469800200529**  CPY@ - Copyright statement.
469900200529(c) Finastra International Limited 2001
