     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SF Validate booking branch/user')
      *****************************************************************
      *                                                               *
      *  Midas  SECURITY PROFILE FACILITY                             *
      *                                                               *
      *   ZBBBU  - TO VALIDATE THAT THE USER IS AUTHORISED TO A       *
      *            BOOKING BRANCH                                     *
      *                                                               *
      *  Function: This program checks that the user is authorised    *
      *            to a Booking Branch. It's called in batch mode.    *
      *            A parameter is passed back to the calling program  *
      *            to indicate validity :                             *
      *            0 - all valid                                      *
      *            1 - no authorised branches found for user          *
      *            2 - user is not authorised to this branch          *
      *                                                               *
      *  Where Used: Input Cycle, multibranch environment             *
      *                                                               *
      *  Called By: Any program requiring this validation             *
      *                                                               *
      *  Calls: None                                                  *
      *                                                               *
      *  Any changes made to this program may also need to be         *
      *  incorporated in ZVBBU.                                       *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      * Midas Release 4.01.02 ----------------------------------------*
      *  Last Amend No. 197434             Date 09Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *  Prev Amend No. CLE004 *CREATE     Date 27Aug97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  197434 - Array index error on SF0021. Increase maximum       *
      *           number of branches from 100 to 900.                 *
      *  CLE004 - Syndications & Authorisations                       *
      *                                                               *
      ********************************************************************
      *                                                               *
     FMBRBS   IF  E           K        DISK
      *
      *****************************************************************
      * ID F  C  H  L     FUNCTION OF INDICATORS
      *
      *       01       OPEN FILE
      *       99       NO VALID BRANCHES FOUND
      *
      *****************************************************************
      *       INPUTS TO THIS PROGRAMME
      *
      *       BRANCH CODE 3A  (FROM THE CALLING PROGRAMME)
      *       USER ID    10A  (FROM THE CALLING PROGRAM)
      *       DTAARA/ZBRU     VALID BOOKING BRANCHES FOR THIS USER
      *
      *****************************************************************
      *       OUTPUT FROM THIS PROGRAMME
      *
      *       ERROR CODE  : 0 = NO ERROR
      *                     1 = NO VALID BRANCHES FOUND FOR USER
      *                     2 = THIS BRANCH CODE NOT VALID FOR USER
      *
      *****************************************************************
     E**********          ZBR       100  3               STORAGE ARRAY                        197434
     E                    ZBR       900  3               STORAGE ARRAY                        197434
      **
     C           *ENTRY    PLIST
     C                     PARM           ZBRCDX  3        BRANCH CODE 3A
     C                     PARM           USRID  10        USER ID
     C                     PARM           ERR     10       ERROR CODE 1S
      *
     C                     SETOF                       99
     C                     Z-ADD0         ERR
      *
      *****************************************************************
      **  IF FIRST ROUND MOVE ZBRU DETAILS INTO ARRAY
      *
     C           *IN01     IFEQ '0'                        B01
      **
     C                     SETON                     01    SET 1ST RND IND
      *
     C                     EXSR ZSPFB
      *
     C                     END
      *
      *****************************************************************
      * IF NO RECORDS ARE ON ZBRU SET ERROR CONDITION TO 1
      *
     C           U         IFEQ 0
     C                     Z-ADD1         ERR
      *
      * IF AT LEAST ONE RECORD ON ZBRU
      *
     C                     ELSE
      *
     C           ZBRCDX    LOKUPZBR                      99
      *
      * IF INPUTED BRANCH NOT ON ZBRU SET ERROR CONDITION TO 2
      *
     C           *IN99     IFEQ '0'
     C                     Z-ADD2         ERR
     C                     END
      *
     C                     END
      *
     C                     RETRN
      *****************************************************************
      **  P/ZSPFB STD SR TO MAKE SPF USER/BRANCHES AVAILABLE TO PGM
      **    INPUT FROM MBRBS FILE- ZBR1 & 2,UP TO 100 BRANCHES,TOP DOWN
      **                           ZIN,INDEX OF LOWEST ENTRY FOR ARRAY
      **    OUTPUT - ZBR  ARRAY, TOP DOWN
      **             U, EQ ZINO
      *****************************************************************
     C           ZSPFB     BEGSR                           **  ZSPFB **
      **
      **   BOOKING BRANCHES
      **
     C           USRID     CHAINMBRBSDDF             20
     C  N20      RECI      COMP 'D'                  2020
     C**N20***** VBRA      COMP *BLANK                   20                                   197434
     C  N20      VBRX      COMP *BLANK                   20                                   197434
      **
     C           *IN20     IFEQ '1'
     C                     MOVE '000'     NOBR
     C**********           MOVE *BLANK    VBRA                                                197434
     C                     MOVE *BLANK    VBRX                                                197434
     C                     END
      *
     C**********           MOVEAVBRA      ZBR,1                                               197434
     C                     MOVEAVBRX      ZBR,1                                               197434
     C                     MOVE NOBR      U       30
     C                     ENDSR
      **
      *****************************************************************
