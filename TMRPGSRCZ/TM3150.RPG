     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas Bnks Open Pos Enq-All Ccy(Ex-DL3150)')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Treasury Management Module                           S01166
     F*                                                               *
     F*  TM3150    - BANKS OPEN POSITION ENQUIRY, ALL CURRENCIES      *   S01166
     F*              (FORMERLY DL3150)                                *
     F*                                                               *
     F*  Function: This enquiry shows how exposed the open            *
     F*  (I/C)     positions are to movements in todays spot rates    *
     F*                                                               *
     F*  Called by: TMC0311 - TM Enquiry control                      *
     F*        via: DL3100  - Treasury management controller          *
     F*                                                               *
     F*  Calls    : ZA0250  - Clear program message queue.            *
     F*           : ZA0240  - Display program message queue.          *
     F*           : ZA0440  - Send message with data.                 *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. CRE026             Date 09Jun06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSE071             Date 19Jul05               *
      *                 TDA035             Date 02Apr04               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 082279             Date 14Jan98               *
      *                 078522             Date 16Nov94               *
     F*                 050683             DATE 27OCT93               *
     F*                 S01319             DATE 13AUG91               *
     F*                 S01277             DATE 11FEB91               *
     F*                 S01117             DATE 19OCT90               *
     F*                 S01195             DATE 15OCT90               *
     F*                 S01194             DATE 15OCT90               *
     F*                 S01277             DATE 18JUL90               *
     F*                 E20774             DATE 15MAR90               *
     F*                 S01199             DATE 28FEB90               *
     F*                 E20525             DATE 06DEC89               *
     F*                 E90054             DATE 30/01/89              *
     F*                 E90145             DATE 30/01/89              *
     F*                 S01166             DATE 13/05/88              *
     F*                 E12284             DATE 22/04/88              *
     F*                 S01136             DATE 05/11/87              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CRE026 - Consumer Banking                                    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  082279 - Prevent Divide by Zero If HIGH/LOW Spots = 0        *
     F*  078522 - Rounding error in SR ZA0750. SR should only perform *
     F*           half-adjust once regardless of no. currency decimal *
     F*           places.                                             *
     F*  050683 - Currencies which are not valid dealing currencies   *
     F*           are being included in the enquiry.  Fix applied is  *
     F*           to ensure that only valid dealing currencies will   *
     F*           be included in the enquiry.                         *
     F*  S01319 - Remove redundant processing                         *
     F*  S01277 - GENERAL TREASURY MGT ERROR FIXES AND                *
     F*           CROSS-CURRENCY POSITIONS ENQUIRY PROCESSING         *
     F*         - IF NO X-CCY DEFINED GET A ROGUE '+' IN SFL          *
     F*         - GETS RATES WRONG IF SECONDARY CCY = BASE CCY        *
     F*           FOR DEALING IN X-CCY PROCESSING. Also always        *
     F*           display a market rate, even if no x-ccy positn      *
     F*           ALSO FORMAT BLANK X-CCY RECORD CORRECTLY. ALSO      *
     F*           REPLACE PUTOVR                                      *
     F*         - IF NO RCD FOUND ON FXEPOSLL, DUMPS WITH ARRAY       *
     F*           INDEX ERROR IN SR/#DB B'COS @Q NOT SET UP.          *
     F*         - IF NEW CURRENCY ENTERED IN PROMPT FIELD AND ROLL    *
     F*           UP/DOWN TAKEN PROCESS AS FOR 'ENTER' TAKEN          *
     F*  S01117 - NEW COPYRIGHT STATEMENT                             *
     F*           DEALING PROGRAMS USED ONLY IN TREASURY MGMT.        *
     F*           MODULE NOW PREFIXED WITH 'TM'                       *
     F*  S01195 - NEW HOLIDAY PROCESSING                              *
     F*  S01194 - NEW STANDING DATA PROCESSING                        *
     F*  E20774 - REPLACE QCAEXEC WITH QCMDEXC                        *
     F*  S01199 -  HELP SYSTEM.                                    *
     F*  E20525 - PROGRAM LOOPED IF THERE WERE NO RECORDS IN          *
     F*           FXEPOSLL.                                           *
     F*  E90054 - ENQUIRY DISPLAYS A '+' IN BOTTOM RIGHT HAND         *
     F*           CORNER EVEN WHEN THERE ARE NO MORE RECORDS TO       *
     F*           ROLLUP.                                             *
     F*  E90145 - PROGRAM SHOULD CALL SUBROUTINE ZA0240 INSTEAD       *
     F*           OF @PLV15 AS THIS IS A FIELD NAME.                  *
     F*  S01166 - DISPLAY OUTPUT ON AS400 SCREEN INSTEAD OF PC        *
     F*           VIA DATA AREA                                       *
     F*  E12284 - CORRECTION TO P/L FIGURE IF BASE CURRENCY HAS       *
     F*           ZERO DECIMAL PLACES:TO PREVENT OVERFLOW             *
     F*  S01136 - DRS INCORPORATION 2. : remove banknotes & bullion   *
     F*           file                                                *
     F*           RELEASE CA38CPLL FILE                               *
     F*                                                               *
     F*****************************************************************
     F**  Indicator Function Summary
     F*
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     F********20         CROSS-CURRENCIES INDICATOR                 S01277S01277
     F*       21         ERROR IN CURRENCY FIELD                          S01277
     F*       60         CHAIN FAIL FOR FILE FX38CPLL
     F*       61         READ EOF FOR FILE FXEPOSLL
     F*       62         READ ERROR FOR FILE FXEPOSLL
     F********63*********READ ERROR FOR FILE FDCCYTLL                     S01194
     F*       64         READ EOF FOR FILE FXCRSCLL                       S01277
     F*       65         READ ERROR FOR FILE FXCRSCLL                     S01277
     F*       66         READ ERROR FOR FILE FXEPOCLL                     S01277
     F********80*********READ*ERROR*FOR*FILE*FDINSTLL*(ZA0870)************S01319
     F*       82         LOOK UP *IN FOR ZA0880
     F********89         EOF ON READ DSPF/DL3150DD (NOT USED)      S01166 S01117
     F*       89         EOF ON READ DSPF/TM3150DD (NOT USED)             S01117
     F*     U7+U8        DATA BASE ERROR
     F*
     F*
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     FFXEPOSLLIF  E           K        DISK         KINFSR INFSR      UC
     F***CA38CPLLUF  E                 DISK         KINFSR INFSR      UC  S01166
     F**FDCCYTLLIF**E*          K        DISK         KINFSR INFSR    UC  S01194
     F*FDINSTLLIF**E*******************DISK*********KINFSR*INFSR******UC**S01319
     F*******BBCPOSLLIF  E           K        DISK         KINFSR INFSR   S01136
     F**************                                KCOMIT                S01136
     F*                                                                   S01166
     F**                                                                  S01166
     F*FDUSSILLIF**E**********K********DISK*********KINFSR*INFSRUC**S01166S01319
     F**                                                                  S01166
     FMUSER   IF  E           K        DISK         KINFSR INFSR      UC  S01319
     F***DL3150DDCF**E*                   WORKSTN              UC  S01166 S01117
     F**********                              RRN   KSFILE DL3150S1S01166 S01117
     F**********                                    KNUM        1  S01166 S01117
     FTM3150DDCF  E                    WORKSTN                        UC  S01117
     F                                        RRN   KSFILE TM3150S1       S01117
     F                                              KNUM        1         S01117
     FFXCRSCLLIF  E           K        DISK         KINFSR INFSR          S01277
     FFXEPOCLLIF  E           K        DISK         KINFSR INFSR          S01277
     F            FXEPOSP0                          KRENAMEFXEPOCL1       S01277
     FFDCCYPLLIF  E           K        DISK         KINFSR INFSR          S01277
     FFXCCYPLLIF  E           K        DISK         KINFSR INFSR          S01277
     F            FDCCYPP0                          KRENAMEFXCCYPP0       S01277
     F**FDTABJLLIF**E*          K        DISK         KINFSR INFSR S01277 S01195
     F*
      /EJECT
     E**  ARRAY TO HOLD INPUT RATE
     E                    @A         13  1  A
     E*
     E**  ARRAY TO HOLD OUTPUT RATE
     E                    @B          8  1
     E*
     E**  DECIMAL PLACES CORRECTION ARRAY
     E** (ie.  1000 100 10 1 .1 .01 .001)
     E                    @DP     7   7  7 3
     E*
     E**  HEADINGS ARRAYS FOR OUTPUT TO DATA AREA AMENQ1AA
     E***                 @HEAD5  1   1 51                                S01166
     E***                 @HEAD6  1   1 51                                S01166
     E*                                                                   S01166
     E** ARRAY FOR RATE INPUT                                             S01166
     E                    @D         15  1                                S01166
     E*                                                                   S01166
     E** ARRAY FOR DISPLAY RATE                                           S01166
     E                    @E         21  1                                S01166
     E*                                                                   S01166
     E** WORK ARRAY                                                       S01166
     E                    @C         21  1                                S01166
     E*                                                                   S01166
     E                    @OVR    1   1 36                                S01166
     E****Array*to*set*up*parameter*for*call*to*QCAEXEC             S01166E20774
     E**  Array to set up parameter for call to QCMDEXC                   E20774
     E*                                                                   S01166
     E                    @SF     1  10 10 0                              S01277
     E**  Array of scaling factors.                                       S01277
     E*                                                                   S01277
     E**  ARRAY FOR SR. ZA0710 - CUMULATIVE DAYS IN YEAR FOR 4 YEAR PERIODS01277
     E                    @YD     4   4  5 0A                             S01277
     E*                                                                   S01277
     E**  ARRAY FOR SR. ZA0710 - CUMULATIVE DAYS IN YEAR PER MONTH        S01277
     E                    @MD    13  13  5 0A                             S01277
     E*                                                                   S01277
     E**  ARRAY FOR SR. ZA0630 - POWERS OF TEN.                           S01277
     E                    @@AY    1  10 10 0                              S01277
     E*                                                                   S01277
     E****USED*BY*SR**ZA0830*-*CURRENCY*RECORDS**                  S01277 S01195
     E**********          @CY        50  3                         S01277 S01195
     E*                                                                   S01277
     E**  USED TO INITIALISE SCALE RATE TO 99999.99999999                 S01277
     E                    @IN     1   1 13 8                              S01277
     E*                                                                   S01277
     E                    @TXT    1   1 29                                S01277
     E**  Array FOR ERROR DESCRIPTION                                     S01277
     E                    CPY@    1   1 80                                S01117
     E* Copyright array                                                   S01117
     E*                                                                   S01277
     E                    @TL     1   8 30                                S01277
     E**  Array titles (cross/base ccys)                                  S01277
     E*                                                                   S01277
     E* Copy standard holiday array                                       S01195
      /COPY ZSRSRC,ZHOLE                                                  S01195
     E*****************************************************************   S01166
      /EJECT
     I*
     I** DATA STRUCTURE TO CONVERT DECIMAL RATE IN TO CHARACTER
     I            DS
     I                                        1  138@@RIN
     I                                        1  13 @A
     I*
     I** DATASTUCTURE TO CONVERT @@IAMT DECIMAL FIELD TO ALPHA FIELD      S01166
     I@@AMDS      DS                             15                       S01166
     I                                        1  150@@IAMT                S01166
     I*                                                                   S01166
     I**  MULTIPLE OCCURENCE DATA STRUCTURE TO HANDLE VARIOUS VALUES
     I*VALUE******DS**********               10
     I@VALUE      DS                         16                           S01166
     I                                        1   3 FOCCY
     I                                        5  190@CPV
     I                                       20  20 @CPS
     I                                       21  350@CBV
     I                                       36  36 @CBS
     I                                       38  44 @RRV
     I                                       46  600@PLV                  S01166
     I                                       61  61 @PLS                  S01166
     I                                       62  69 @COR                  S01166
     I*
     I** DATA STRUCTURE TO GET CCY FROM ROLL/REFRESH KEY FIELD (*ENTRY)
     I***@RRKF       DS                             24                    S01166
     I***                                     1   3 @CCC                  S01166
     I*
     I** DATA STRUCTURE TO GET CCY FROM FX38CPLL IF @RRK IS BLANK     )
     I*ARKT1***** DS
     I***@WFAP       DS                                                   S01166
     I***                                     1   3 @ICY                  S01166
     I*
     I****DATA*STRUCTURE*FOR*CHAIN*TO*S/FDCCYTLL***                       S01194
     I**@KDCY***    DS                                                    S01194
     I**********                              1   2 @K20                  S01194
     I**********                              9  11 @CYY                  S01194
     I**********                             12  12 @K1                   S01194
     IPSDS       SDS
     I*
     I**  Program status data structure.
     I**  Field containing file in use.
     I                                      201 208 @FILE
     I**  Field containing workstaion  ID.
     I                                      244 253 @JOB
     I**  Field containing user ID.
     I                                      254 263 @USER
     I*
     I           UDS
     I**  Local data area for data base errors.
     I**  Field containing name of database file in error.
     I                                      134 141 DBFILE
     I**  Field containing key value causing database error.
     I                                      142 170 DBKEY
     I**  Field containing name of program causing database error.
     I                                      171 180 DBPGM
     I**  Field containing number of database error.
     I                                      181 183 DBASE
     I*
     I**  AMENQ1AA DATA AREA FOR OUTPUT TO PC
     I***AMENQ       DS                                                   S01166
     I***                                     1  51 @HEAD1                S01166
     I***                                   100 104 @STEN                 S01166
     I***                                   105 155 @HEAD2                S01166
     I***                                                                 S01166
     I***                                   157 208 @VAL1                 S01166
     I***                                   209 260 @VAL2                 S01166
     I***                                   261 312 @VAL3                 S01166
     I***                                   313 364 @VAL4                 S01166
     I***                                   365 416 @VAL5                 S01166
     I***                                   417 468 @VAL6                 S01166
     I***                                   469 520 @VAL7                 S01166
     I***                                   521 572 @VAL8                 S01166
     I***                                   573 624 @VAL9                 S01166
     I***                                   625 676 @VAL10                S01166
     I***                                                                 S01166
     I***                                   694 700 @HEAD3                S01166
     I***                                   702 7110@BDVT                 S01166
     I***                                   712 712 @BDVS                 S01166
     I***                                   717 719 @HEAD4                S01166
     I***                                   721 7270@PLVT                 S01166
     I***                                   728 728 @PLTS                 S01166
     I*                                                                   S01166
     I*   Data structure for command in array @OVR                        S01166
     I@OVRID      DS                             36                       S01166
     I                                       32  350@WAIT                 S01166
     I*                                                                   S01166
     I@DATA       DS                             45                       S01277
     I*                                                                   S01277
     I** Data structure to hold the data for screen messages.             S01277
     I                                        1  25 @DATA1                S01277
     I                                       26  45 @DATA2                S01277
     I                                       26  28 @DTC1                 S01277
     I                                       29  29 @BLK1                 S01277
     I                                       30  32 @DTC2                 S01277
     I                                        1  45 @DATA3                S01277
     I*                                                                   S01277
     I@MKCCY      DS                                                      S01277
     I*                                                                   S01277
     I** Data structure to to hold marker key for top/bottom ccys.        S01277
     I                                        1   3 DDPCCY                S01277
     I                                        4   6 CPSCCY                S01277
     I*                                                                   S01277
     I**  DATA STRUCTURE FOR ZA0680/ZA0710 - DATE INPUT TO SUBROUTINES*   S01277
     I            DS                              8                       S01277
     I                                        1   80@@DTIN                S01277
     I                                        1   40@@YYYY                S01277
     I                                        3   40@@YY                  S01277
     I                                        1   20@@CC                  S01277
     I                                        5   60@@MTH                 S01277
     I                                        7   80@@DAY                 S01277
     I*                                                                   S01277
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@Z71Y                 S01277
     I            DS                              4                       S01277
     I                                        1   40@@Z71Y                S01277
     I                                        1   10@@SSY1                S01277
     I                                        2   20@@SSY2                S01277
     I                                        3   30@@SSY3                S01277
     I                                        4   40@@SSY4                S01277
     I*                                                                   S01277
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@VDT                  S01277
     I            DS                              8                       S01277
     I                                        1   80@@VDT                 S01277
     I                                        1   40@@YR                  S01277
     I                                        5   60@@Z71M                S01277
     I                                        7   80@@Z71D                S01277
     I*                                                                   S01277
     I****Data*Structure*for*key*of*holidays*file**                S01277 S01195
     I**********                                                   S01277 S01195
     I**********  DS                             12                S01277 S01195
     I**********                              1  12 SS0830         S01277 S01195
     I**********                              7  110@@MNO          S01277 S01195
     I**********                                                   S01277 S01195
     I**********  DS                                               S01277 S01195
     I****USED*BY*SR**ZA0830*-*ARRAY*DATA*STRUCTURE**              S01277 S01195
     I**********                              1 150 @CY            S01277 S01195
     I**********                              1  75 @@CY1          S01277 S01195
     I**********                             76 150 @@CY2          S01277 S01195
     I*                                                                   S01277
     I**   Controlling parameters   (Current Prompt 1)                    S01277
     I**                                                                  S01277
     I            DS                             80                       S01277
     I                                        1  80 FAEPT1                S01277
     I                                        2   4 @@CCY1                S01277
     I                                       32  34 @@CCY2                S01277
     I*                                                                   S01277
     IRUNDAT      DS                             13                       S01277
     I** DATA STRUCTURE FOR RUNDATE.                                      S01277
     I                                        1   7 @RDATE                S01277
     I                                    P   8  100@RDNUM                S01277
     I*                                                                   S01194
     ISDCURR    E DSSDCURRPD                                              S01194
     I* External DS for Currency Details                                  S01194
     ISDBANK    E DSSDBANKPD                                              S01194
     I* External DS for Bank Details                                      S01194
     ISDDEAL    E DSSDDEALPD                                              S01319
     I** EXTERNAL DS FOR DEALING DETAILS                                  S01319
     IDSSDY     E DSDSSDY                                                 S01194
     I* DS used by Access Objects (long records)                          S01194
     IDSFDY     E DSDSFDY                                                 S01194
     I* DS used by Access Objects (short records)                         S01194
      /COPY ZSRSRC,ZHOLI                                                  S01195
     I* Copy standard holiday data structure                              S01195
     C****************************************************************
     //EJECT
     C                     MOVEACPY@      BIS@   80                       S01117
     C********** *LIKE     DEFN FOBDSE    BDSE
     C********** *LIKE     DEFN FOTNTP    TNTP
     C****************************************************************
     C*                 MAIN PROGRAM
     C*                 ~~~~~~~~~~~~
     C**  INPUT PARAMETERS
     C***        *ENTRY    PLIST                                          S01166
     C***                  PARM           @TERM   1                       S01166
     C***                  PARM           @ENQU   1                       S01166
     C***                  PARM           @RRKF  24                       S01166
     C*
     C**  IF TERMINATION FLAG SET MUST TERMINATE PROGRAM IMMEDIATELY
     C***        @TERM     IFEQ 'T'                        B1             S01166
     C***                  MOVE '1'       *INLR            *1             S01166
     C***                  GOTO #9                         *1             S01166
     C***                  END                             E1             S01166
     C*
     C**  CHECK IF THIS IS THE INITIAL CALL OF THE PGM
     C***        @INITL    IFEQ *BLANK                     B1             S01166
     C                     EXSR #A                         *1
     C***                  END                             E1             S01166
     C*
     C           *INU7     IFEQ '0'                        B1
     C*                                                                   S01166
     C* do while cmd/3 not pressed                                        S01166
     C*                                                                   S01166
     C           *IN01     DOWEQ'0'                        B2             S01166
     C                     EXSR #B                         *2             S01166
     C                     END                             E2             S01166
     C                     END                             E1
     C*
     C           *INU7     IFEQ '0'                        B1
     C                     EXSR #C                         *1
     C                     END                             E1
     C*
     C           #9        TAG                             *** TAG #9 ***
     C                     RETRN
     C*
     C****************************************************************
     C*
     C*            INDEX TO SUBROUTINES
     C*            ~~~~~~~~~~~~~~~~~~~~
     C*   1.   #B        MAIN PROCESSING
     C*        #D        CROSS CURRENCY POSITIONS                         S01277
     C*   2.   #BB       CALCULATIONS
     C*   3.   #BC       SETS UP FIELDS FOR OUTPUT TO AMENQ1AA
     C*        #DB       CALCULATIONS (CROSS CURRENCIES)                  S01277
     C*        #DBA      CALCULATION CROSS EXCHANGE RATE                  S01277
     C*        #DBAA     CALCULATE TWO CROSS RATES FOR A DATE             S01277
     C*        #DD       OUTPUT CROSS  CURRENCY TOTALS                    S01277
     C*   4.   ZA0880    EDITS REV. RATE AND COR                          S01166
     C*        ZA0820    DETERMINE SPOT DATE                              S01277
     C*        ZA0630    CALCULATE FORWARD OUTRIGHT RATE                  S01277
     C*        ZA0900    CALCULATE CROSS EXCHANGE RATE                    S01277
     C*        ZA0700    CALCULATE FORWARD POINTS                         S01277
     C*        ZA1150    CONVERT RATE TO SCALED RATE                      S01277
     C*        ZA1160    CONVERT SCALED RATE TO UNSCALED RATE             S01277
     C*        ZA0680    CONVERT YYYYMMDD TO MIDAS DAY NUMBER FORMAT      S01277
     C*********ZA0830****HOLIDAYS PROCESSING                       S01277 S01195
     C*        ZCHKH     DETERMINE IF DATE IS A HOLIDAY IN GIVEN CCY      S01195
     C*        ZA0710    CONVERT MIDAS DAY NUMBER TO YYYYMMDD FORMAT      S01277
     C*   5.   #C        TERMINATION
     C*   6.   #A        INITIALISATION
     C*   7.   ZA0870    RETRIEVES BASE CCY AND NO. DECIMAL PLACES
     C*   8.   #BA       READ ERROR PROCESSING
     C*   9.   INFSR     FILE ERROR SUBROUTINE
     C*  10.   *PSSR     PROGRAM ERROR SUBROUTINE
     C*
     C****************************************************************
     //EJECT
     C****************************************************************
     C*
     C*  SUBROUTINE: #B   - THIS ROUTINE DECIDES IF FORWARD OR
     C*                     BACKWARD READ OF S/FXEPOSLL IS REQUIRED AND
     C*                     SETS UP THE MARKER CCY ETC.
     C*
     C*  CALLED FROM : MAIN PROGRAM
     C*
     C*  FIELDS INPUT :
     C*
     C*  FIELDS USED : @BDVT    BANK DEALT SPOT BCE TOT. FOR S/FXEPOSLL
     C*                @CCC     CURRENCY  (PASSED AS PARAMETER)
     C*                RRN      RECORD COUNTER FOR S/FXEPOSLL             S01166
     C*                @FIRST   'Y' IF PROCESSING FIRST READ RECORD
     C*                @FWBK    FORWARD OR BACKWARD READ OF S/FXEPOSLL
     C*                @EFIL    'Y' IF FXEPOSLL IS EMPTY
     C*                @ENQU    TYPE OF ENQUIRY (PASSED AS PARAMETER)
     C*                @HEAD1   HEADINGS FOR DISPLAY WINDOW
     C*                @HEAD2   HEADINGS FOR DISPLAY WINDOW
     C*                @HEAD3   HEADINGS FOR DISPLAY WINDOW
     C*                @HEAD4   HEADINGS FOR DISPLAY WINDOW
     C*                @HEAD5   HEADINGS FOR DISPLAY WINDOW (ARRAY)
     C*                @HEAD6   HEADINGS FOR DISPLAY WINDOW (ARRAY)
     C*                @MCCY    FIRST/LAST CCY ON DISPLAY WINDOW
     C*                @OCC     OCCURENCE OF DATA STRUCTURE
     C*                @PLV     PROFIT/LOSS
     C*                @PLVT    PROFIT/LOSS TOTAL FOR FILE S/FXEPOSLL
     C*                DDSTEN   START/END OF FILE ON DISPLAY WINDOW       S01166
     C*                AMENQ    DATA AREA AMENQ1AA
     C*                DBFILE   FILE READ ERROR, NAME OF FILE
     C*                DBASE    FILE READ ERROR, ERROR NUMBER
     C*                FOBDSE   BANK DEALT SPOT BCE         S/FXEPOSLL
     C*                FOCCY    CURRENCY CODE               S/FXEPOSLL
     C*
     C*    CALLS  :    #BA   DATA BASE ERROR
     C*                #BB   CALCULATIONS
     C*                #BC   SETS UP FIELDS FOR OUTPUT TO AMENQ1AA
     C*
     C****************************************************************
     C*
     C           #B        BEGSR
     C*                                                                   S01166
     C* only read display file after something has been written to it     S01166
     C           @INITL    IFEQ '1'                                       S01166
     C*
     C* write heading text                                                S01166
     C                     TIME           DDTIME  60                      S01277
     C**********           WRITEDL3150F0                           S01166 S01117
     C                     WRITETM3150F0                                  S01117
     C**********           WRITEDL3150F1                           S01166 S01117
     C                     WRITETM3150F1                                  S01117
     C*                                                                   S01166
     C                     SETOF                     36                   S01166
     C           @NOREC    IFEQ 'N'                                       E20525
     C                     SETON                     35                   S01166
     C                     ELSE                                           E20525
     C                     SETOF                     35             S01166E20525
     C                     END                                            E20525
     C* write msg subfile                                                 S01166
     C**********           WRITEDL3150C0                           S01166 S01117
     C                     WRITETM3150C0                                  S01117
     C* write enq subfile                                                 S01166
     C**********           WRITEDL3150C1                           S01166 S01117
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01166
     C                     SETON                     36                   S01166
     C* write totals                                                      S01166
     C**********           WRITEDL3150F2                           S01166 S01117
     C                     WRITETM3150F2                                  S01117
     C*                                                                   S01166
     C                     SETOF                     052526               S01166
     C*                                                                   S01166
     C**********           READ DL3150DD        0589read screen    S01166 S01117
     C                     READ TM3150DD               0589read screen    S01117
     C*                                                                   S01166
     C**         *IN10     DOWEQ'1'                        help    S01166 S01199
     C**                   SETOF                     10            S01166 S01199
     C**                   CALL 'SDMENU'                           S01166 S01199
     C**                   READ DL3150DD               0589        S01166 S01199
     C**                   END                                     S01166 S01199
     C*                                                                   S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C* clear msg subfile                                                 S01166
     C                     CALL 'ZA0250'                                  S01166
     C*                                                                   S01166
     C**  RESET ALL THE VARIABLE FIELDS
     C                     MOVE *BLANKS   FORCID
     C                     Z-ADD15        @LOC    30                      S01166
     C                     Z-ADD01        @HIC    30
     C                     MOVE *BLANKS   @EFIL   1
     C*****                MOVE '0'       *IN20                     S01277S01277
     C                     MOVE '0'       *IN21                           S01277
     C*
     C**  SET RECORD COUNTER TO 16                                        S01166
     C                     Z-ADD16        RRN     20                      S01166
     C*
     C*** MUST INPUT DATA AREA SO NO PROBLEMS WITH LOCKS                  S01166
     C***        *LOCK     IN   AMENQ                                     S01166
     C***                                                                 S01166
     C*** BLANK OUT FIELDS IN DATA AREA AMENQ1AA                          S01166
     C***                  MOVE *BLANKS   AMENQ                           S01166
     C***                                                                 S01166
     C*** SET UP HEADINGS FOR DATA AREA AMENQ1AA                          S01166
     C***                  MOVE 'Net BCE' @HEAD3                          S01166
     C***                  MOVE 'P/L'     @HEAD4                          S01166
     C***                  MOVEA@HEAD5    @HEAD1                          S01166
     C***                  MOVEA@HEAD6    @HEAD2                          S01166
     C*
     C**  CLEAR FORWARD/BACKWARD FIELD AND VARIOUS VALUE FIELDS
     C**  @FWBK = ' '   READ BACKWARDS        @FWBK = F   READ FORWARDS
     C                     MOVE *BLANK    @FWBK   1
     C                     MOVE '0'       *IN61
     C*
     C**  If a currency requested which is not the                        S01277
     C**  Base currency for dealing process cross-currencys.              S01277
     C*                                                                   S01277
     C           DDPCCY    IFNE *BLANKS                    B1             S01277
     C***********DDPCCY****ANDNEIDCYDL*********************B1*******S01277S01319
     C           DDPCCY    ANDNEBNCYDL                     B1             S01319
     C*                                                                   S01277
     C****Validate*entered*currency***                             S01277 S01194
     C**********                                                   S01277 S01194
     C**********           MOVE DDPCCY    @CYY                     S01277 S01194
     C**********                                                   S01277 S01194
     C********** @KDCY     CHAINFDCCYTLL             21            S01277 S01194
     C********** *IN21     IFEQ '1'                        B2      S01277 S01194
      *                                                                   S01194
     C**  Validate entered currency via call to Access Object             S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7        *1             S01194
     C                     PARM '*KEY   ' @OPTN   7        *1             S01194
     C                     PARM DDPCCY    @PCCY   3        *1             S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
      *                                                                   S01194
     C           A6DLCI    IFEQ 'N'                                       050683
     C           @RTCD     ANDEQ*BLANKS                                   050683
     C                     MOVEL'MMM0202' @MSGID                          050683
     C                     MOVE *BLANKS   @DATA3                          050683
     C                     MOVELDDPCCY    @DATA3                          050683
     C                     CALL 'ZA0440'                                  050683
     C                     PARM           @MSGID                          050683
     C                     PARM           @DATA                           050683
     C                     MOVE '1'       *IN21                           050683
     C                     GOTO #B9                                       050683
     C                     END                                            050683
     C           @RTCD     IFNE *BLANKS                    B2             S01194
     C                     MOVEL'FXM0011' @MSGID           *2             S01277
     C                     MOVE *BLANKS   @DATA3           *2             S01277
     C                     MOVELDDPCCY    @DATA3           *2             S01277
     C                     CALL 'ZA0440'                   *2             S01277
     C                     PARM           @MSGID           *2             S01277
     C                     PARM           @DATA            *2             S01277
     C                     MOVE '1'       *IN21            *2             S01277
     C*                                                                   S01277
     C**  Currency invalid - skip further processing                      S01277
     C**  and redisplay screen with error.                                S01277
     C*                                                                   S01277
     C****Clear subfile before refilling by writing control record        S01277
     C****with SFLCLR active.                                             S01277
     C*****                                                               S01277
     C*****                MOVE '0'       *IN35                           S01277
     C*****                MOVE '0'       *IN36                           S01277
     C*****                MOVE '1'       *IN20                           S01277
     C**********           WRITEDL3150C1                           S01277 S01117
     C*****                WRITETM3150C1                                  S01117
     C*****                                                               S01277
     C*****                MOVE *BLANKS   DDBDVT                          S01277
     C*****                MOVE *BLANKS   DDPLVT                          S01277
     C*                                                                   S01277
     C                     GOTO #B9                                       S01277
     C*                                                                   S01277
     C                     ELSE                                           S01194
     C                     MOVEL@PCCY     DDPCCY                          S01194
     C                     END                             E2             S01277
     C*                                                                   S01277
     C**  Process Cross-Currency enquiry.                                 S01277
     C*                                                                   S01277
     C** Set up titles for cross ccy for dealing details                  S01277
     C                     MOVE *BLANKS   DDTTL1                          S01277
     C                     MOVEA@TL,2     DDTTL1                          S01277
     C                     MOVELDDPCCY    @WRK4   4                       S01277
     C                     MOVE @WRK4     DDTTL1                          S01277
     C                     MOVEA@TL,4     DDTTL2                          S01277
     C                     MOVEA@TL,6     DDTTL3                          S01277
     C                     MOVEA@TL,8     DDTTL4                          S01277
     C                     MOVE '1'       *IN20                     S01277S01277
     C*                                                                   S01277
     C                     EXSR #D                                        S01277
     C*                                                                   S01277
     C                     GOTO #B9                                       S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  Else process for Base currency.                                 S01277
     C*                                                                   S01277
     C** Set up titles for base ccy for dealing details                   S01277
     C                     MOVE *BLANKS   DDTTL1                          S01277
     C                     MOVEA@TL,1     DDTTL1                          S01277
     C                     MOVEA@TL,3     DDTTL2                          S01277
     C                     MOVEA@TL,5     DDTTL3                          S01277
     C                     MOVEA@TL,7     DDTTL4                          S01277
     C**                                                                  S01277
     C**  DON'T SET @PLV ETC TO x'404040' BELOW !!!  SO LOOP ROUND
     C**  ALL MULTIPLE OCCURENCES OF THE FIELDS,STOPS DECIMAL DATA ERRORS
     C******************   DO   10        @OCC    20       B1
     C                     DO   16        @OCC    20       B1             S01166
     C           @OCC      OCUR @VALUE                     *1
     C                     MOVE *BLANKS   @VALUE           *1
     C                     Z-ADD0         @PLV             *1
     C                     Z-ADD0         @CPV             *1
     C                     Z-ADD0         @CBV             *1
     C                     END                             E1
     C*
     C**  If primary currency has changed since last time                 S01277
     C**  through treat as new enquiry.                                   S01277
     C*                                                                   S01277
     C           DDPCCY    IFNE @SAVCY                     B1             S01277
     C                     MOVE '0'       @INITL                          S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C                     MOVE DDPCCY    @SAVCY  3                       S01277
     C*                                                                   S01277
     C*
     C**  SET FIRST RECORD READ FLAG TO 'Y'
     C                     MOVE 'Y'       @FIRST  1
     C*
     C**  ZEROIZE RUNNING TOTAL FIELDS
     C                     Z-ADD0         @PLVT  150                      S01166
     C                     Z-ADD0         @PLT15
     C*
     C                     Z-ADD0         @BDVT  150                      S01166
     C*
     C**  DEFINE MARKER CCY FIELD
     C***        *LIKE     DEFN FOCCY     @MCCY                           S01166
     C*
     C**  MUST USE @CCC BECAUSE OF DATA STRUCTURE LIMITATIONS
     C***        *LIKE     DEFN FOCCY     @CCY                            S01166
     C           *LIKE     DEFN FOCCY     @TOPCY                          S01166
     C           *LIKE     DEFN FOCCY     @BOTCY                          S01166
     C**  IF *ENTRY PARM IS BLANK (EG REFRESH) CHAIN TO FX38CPLL
     C**  FOR THE BOTTOM CCY OR TOP CCY
     C***        @CCC      IFEQ *BLANKS                    B1             S01166
     C*          1         CHAINFX38CPLL             60
     C***        1         CHAINCA38CPLL             60                   S01166
     C*
     C** ERROR IF RECORD NOT FOUND, SET UP LDA AND EXIT PGM
     C***        *IN60     IFEQ '1'                        B*2            S01166
     C***                  MOVEL'1'       DBKEY            **2************S01166
     C***                  MOVEL'FX38CPLL'DBFILE           **2* DB        S01166
     C***                  MOVEL'CA38CPLL'DBFILE           **2* DB        S01166
     C***                  MOVEL'007'     DBASE            **2* ERROR 007 S01166
     C***                  EXSR #BA                        **2*           S01166
     C***                  GOTO #B9                        **2************S01166
     C***                  END                             E*2            S01166
     C*
     C**  GET CCY FROM FARKB1 OR FARKT1
     C***        @ENQU     IFEQ 'D'                        B2             S01166
     C***        @ENQU     OREQ 'R'                        B2             S01166
     C***                  MOVELFARKT1    @WFAP            *2             S01166
     C***                  ELSE                            X2             S01166
     C***                  MOVELFARKB1    @WFAP            *2             S01166
     C***                  END                             E2             S01166
     C*
     C***                  MOVE @ICY      @CCC             *1             S01166
     C***                  END                             E1             S01166
     C*
     C***                  MOVE @CCC      @CCY                            S01166
     C*
     C**** ******  ******  ******  ******  ******  ******  ******
     C*
     C**  CHECK THE TYPE OF ENQUIRY UPDATE (PASSED AS A PARAMETER)
     C**  AND SET THE FILE POINTER TO THE TOP OR BOTTOM OF THE FILE
     C*
      **  Force later section of code to respond to PC with headings
      **  only if no records on file for a new enquiry.
     C***        @ENQU     IFEQ *BLANKS                    B1             S01166
     C***                  MOVE *HIVAL    FORCID           *1             S01166
     C***                  END                             E1             S01166
      *
     C**  NEW ENQUIRY OR FIRST PAGE ENQUIRY
     C***        @ENQU     IFEQ *BLANK                     B1             S01166
     C***        @ENQU     OREQ 'F'                        B1             S01166
     C* 1st time round (i.e. not refresh or roll)                         S01166
     C*   read file forwards from beginning                               S01166
     C           @INITL    IFEQ *BLANK                     B1             S01166
     C                     MOVE 'F'       @FWBK            *1
     C           *LOVAL    SETLLFXEPOSLL                   *1
     C                     READ FXEPOSLL                 61*1
     C*
     C**  IF END OF FILE (NO RECORD READ EOF *IN 61 SET ON)
     C**  MUST BE EMPTY FILE - WRITE TO MSG SUBFILE                       S01166
     C           *IN61     IFEQ '1'                        B2
     C***********          MOVEL'RTM0001' @MSGID 10        *2       S01166E20525
     C                     MOVEL'RTM0011' @MSGID 10        *2             E20525
     C                     MOVE '1'       *IN30                           E90054
     C***********          CALL '@PLV15'                   *2       S01166E90145
     C                     CALL 'ZA0240'                   *2             S01166
     C                     PARM           @MSGID           *2             S01166
     C                     MOVE '1'       @INITL           *2             E20525
     C                     MOVE 'Y'       @EFIL            *2
     C                     MOVE 'Y'       @NOREC           *2             E20525
     C                     GOTO #B9                        *2
     C                     END                             E2
     C*
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW
     C                     MOVE FOCCY     @TOPCY           *1             S01166
     C           *LOVAL    SETLLFXEPOSLL                   *1
     C                     END                             E1             S01166
     C*
     C**  LAST PAGE ENQUIRY
     C***        @ENQU     IFEQ 'L'                        B1             S01166
     C***                                                                 S01166
     C*** MUST READ FILE BACKWARDS                                        S01166
     C***        *HIVAL    SETGTFXEPOSLL                   *1             S01166
     C***                  READPFXEPOSLL                 61*1             S01166
     C***                                                                 S01166
     C*** IF BEGINNING OF FILE (NO RECORD READ EOF *IN 61 SET ON)         S01166
     C*** MUST BE EMPTY FILE                                              S01166
     C***        *IN61     IFEQ '1'                        B2             S01166
     C***                  MOVE 'Y'       @EFIL            *2             S01166
     C***                  GOTO #B9                        *2             S01166
     C***                  END                             E2             S01166
     C***                                                                 S01166
     C*** SET UP MARKER CCY FOR END OF DISPLAY WINDOW                     S01166
     C***                  MOVE FOCCY     @MCCY            *1             S01166
     C***        *HIVAL    SETGTFXEPOSLL                   *1             S01166
     C***                  END                             E1             S01166
     C*
     C**  ROLL UP ENQUIRY
     C***        @ENQU     IFEQ 'U'                        B1             S01166
     C*
     C**  MUST READ FILE FORWARDS
     C           *IN25     IFEQ '1'                        B1             S01166
     C                     MOVE 'F'       @FWBK            *1
     C           @BOTCY    SETGTFXEPOSLL                   *1             S01166
     C                     READ FXEPOSLL                 61*1
     C*
     C**  IF END OF FILE (NO RECORD READ EOF *IN 61 SET ON)
     C**  MUST BE NO MORE RECS TO DISPLAY                                 S01166
     C           *IN61     IFEQ '1'                        B2
     C                     MOVEL'RTM0001' @MSGID           *2             S01166
     C                     MOVE '1'       *IN30                           E90054
     C                     CALL 'ZA0240'                   *2             S01166
     C                     PARM           @MSGID           *2             S01166
     C                     MOVE 'Y'       @EFIL            *2
     C                     GOTO #B9                        *2             S01166
     C                     END                             E2
     C*
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW
     C                     MOVE FOCCY     @TOPCY           *1             S01166
     C           *LOVAL    SETLLFXEPOSLL                   *1
     C                     END                             E1             S01166
     C*
     C**  ROLL DOWN ENQUIRY
     C***        @ENQU     IFEQ 'D'                        B1             S01166
     C*
     C**  MUST READ FILE BACKWARDS
     C           *IN26     IFEQ '1'                        B1             S01166
     C           @TOPCY    SETLLFXEPOSLL                   *1             S01166
     C                     READPFXEPOSLL                 61*1
     C*
     C**  IF BEGINNING OF FILE (NO RECORD READ EOF *IN 61 SET ON)
     C**  MUST BE EMPTY FILE
     C           *IN61     IFEQ '1'                        B2
     C                     MOVEL'RTM0001' @MSGID           *2             S01166
     C                     MOVE '1'       *IN30                           E90054
     C                     CALL 'ZA0240'                   *2             S01166
     C                     PARM           @MSGID           *2             S01166
     C                     MOVE 'Y'       @EFIL            *2             S01166
     C                     GOTO #B9                        *2             S01166
     C                     END                             E2             S01166
     C*
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW
     C**  AND ASSUME ROLLBACK TO BEGINNING
     C                     MOVE 'START'   DDSTEN           *1
     C                     MOVE FOCCY     @BOTCY           *1             S01166
     C           *HIVAL    SETLLFXEPOSLL                   *1
     C                     END                             E1             S01166
     C*
     C**  REFRESH ENQUIRY
     C***        @ENQU     IFEQ 'R'                        B1             S01166
     C*
     C**  MUST READ FILE FORWARDS
     C           *IN05     IFEQ '1'                        B1             S01166
     C                     MOVE 'F'       @FWBK            *1
     C**  IF NO CCY ON FX38CPPP IE REFRESH ON AN ENQUIRY ON A BLANK
     C**  FXEPOSPP, MUST REFRESH FROM START OF FILE
     C***        @CCC      IFEQ *BLANKS                    B*2            S01166
     C           @TOPCY    SETLLFXEPOSLL                   **1            S01166
     C                     READ FXEPOSLL                 61**1            S01166
     C*
     C**  IF END OF FILE (NO RECORD READ EOF *IN 61 SET ON)
     C**  MUST BE EMPTY FILE
     C           *IN61     IFEQ '1'                        B**2           S01166
     C***********          MOVEL'RTM0001' @MSGID           ***2     S01166E20525
     C                     MOVEL'RTM0011' @MSGID           ***2           E20525
     C                     MOVE '1'       *IN30                           E90054
     C                     CALL 'ZA0240'                   ***2           S01166
     C                     PARM           @MSGID           ***2           S01166
     C                     MOVE 'Y'       @EFIL            ***2           S01166
     C                     MOVE 'Y'       @NOREC           ***2           E20525
     C                     GOTO #B9                        ***2           S01166
     C                     END                             E**2           S01166
     C*
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW
     C                     MOVE FOCCY     @TOPCY           **1            S01166
     C***                  END                             E*2            S01166
     C           *LOVAL    SETLLFXEPOSLL                   **1            S01166
     C*
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW
     C***                  MOVE @CCY      @TOPCY           *1             S01166
     C                     END                             E1             S01166
     C*
     C**  THIS SETS MULT. OCC. DS. ON OCCURENCE 1
     C           @FWBK     IFEQ 'F'                        B1
     C           1         OCUR @VALUE                     *1
     C                     ELSE                            X1
     C           15        OCUR @VALUE                     *1             S01166
     C                     END                             E1
     C*                                                                   S01166
     C**** ******  ******  ******  ******  ******  ******  ******
     C*                                                                   S01166
     C* clear enq subfile                                                 S01166
     C                     SETOF                     3536                 S01166
     C**********           WRITEDL3150C1                           S01166 S01117
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01166
     C                     Z-ADD99        RRN                             S01166
     C                     MOVE *BLANKS   DDSTEN                          S01166
     C                     SETOF                     30
     C*
     C**  READ EACH RECORD AND IF IT IS WITHIN THE DISPLAY WINDOW
     C**  CALCULATE THE VARIOUS VALUES, ELSE JUST TOTAL P/L & DEALT BCE
     C*
     C**  REPEAT UNTIL BEGINNING OR END OF FILE
     C**  OR ERROR ON FILE READS/CHAINS
     C           *IN61     DOWEQ'0'                        B1
     C           *IN62     ANDEQ'0'                        B1
     C********** *IN63     ANDEQ'0'                        B1             S01194
     C*
     C**  IF READING FORWARDS USE  READ
     C           @FWBK     IFEQ 'F'                        B*2
     C*
     C                     READ FXEPOSLL               6261**2
     C*
     C**  IF AN ERROR ON THE READ (NOT EOF!!)
     C           *IN62     IFEQ '1'                        B**3 **********
     C                     MOVEL'FXEPOSLL'DBFILE           ***3 * DB
     C                     MOVEL'001'     DBASE            ***3 * ERROR 00
     C                     EXSR #BA                        ***3 **********
     C                     GOTO #B9                        ***3
     C                     END                             E**3
     C*
     C** CALCULATE P/L ETC., IF NOT END OF FILE
     C           *IN61     IFEQ '0'                        B**3
     C                     EXSR #BB                        ***3
     C                     END                             E**3
     C*
     C**  CHECK IF CCY GREATER THAN OR EQUAL TO MARKER CCY  IE. IS THIS
     C**  WITHIN DISPLAY WINDOW   AND NOT END OF FILE
     C           FOCCY     IFGE @TOPCY                     B**3           S01166
     C           *IN61     ANDNE'1'                        B**3
     C           A6DLCI    ANDNE'N'                                       050683
     C           RRN       IFEQ 99                         B***4          S01166
     C                     Z-ADD1         RRN              ****4          S01166
     C*
     C**  IF THE CCY EQUAL TO THE MARKER CCY IS THE FIRST RECORD READ
     C           @FIRST    IFEQ 'Y'                        B****5
     C                     MOVE 'START'   DDSTEN           *****5         S01166
     C                     END                             E****5
     C                     END                             E****4         S01166
     C*
     C**  MOVE CALCULATED VALUES TO SUBFILE FOR DISPLAY                   S01166
     C           RRN       IFLE 15                         B***4          S01166
     C***        RRN       ANDGE1                                         S01166
     C                     EXSR #BC                        ****4          S01166
     C                     MOVE FOCCY     @BOTCY           ****4          S01166
     C***                  END                                            S01166
     C*
     C**  ADD ONE TO COUNTER (UNLESS IT IS 16, THIS STOPS COUNTER         S01166
     C**  GOING BEYOND 99 AND BACK TO 0)
     C***        RRN       IFLE 15                                        S01166
     C                     ADD  1         RRN              ****4          S01166
     C***                  END                                            S01166
     C*
     C**  IF RRN    WITHIN 1-15 SET UP MULTIPLE OCC. DATA ST.             S01166
     C***        RRN       IFLE 15                                        S01166
     C***        RRN       ANDGE1                                         S01166
     C           RRN       OCUR @VALUE                     ****4          S01166
     C*
     C**  ELSE SET TO 16TH OCUR SO DOESNT CORRUPT DATA                    S01166
     C                     ELSE                            X***4
     C           16        OCUR @VALUE                     ****4          S01166
     C                     END                             E***4          S01166
     C*
     C**  END OF CCY READ EQUAL TO OR GREATER THAN MARKER CCY SECTION
     C                     END                             E**3
     C*
     C**  IF THE LAST RECORD ON FILE IS WITHIN DISPLAY WINDOW
     C**     SETON SFLEND INDICATOR                                       S01166
     C           *IN61     IFEQ '1'                        B**3
     C           RRN       ANDLE15                         B**3           S01166
     C                     MOVE ' END '   DDSTEN           ***3           S01166
     C                     SETON                     30                   S01166
     C                     END                             E**3
     C*
     C**  ELSE IF READING BACKWARDS USE  READP
     C                     ELSE                            X*2
     C                     READPFXEPOSLL               6261**2
     C*
     C**  IF AN ERROR ON THE READ (NOT BOF!!)
     C           *IN62     IFEQ '1'                        B**3
     C                     MOVEL'FXEPOSLL'DBFILE           ***3 **********
     C                     MOVEL'002'     DBASE            ***3 * DB
     C                     EXSR #BA                        ***3 * ERROR 00
     C                     GOTO #B9                        ***3 **********
     C                     END                             E**3
     C*
     C**  CALCULATE PROFIT AND LOSS ETC. IF NOT BOF
     C           *IN61     IFEQ '0'                        B**3
     C** not bof and subfile full - so not START
     C           RRN       IFEQ 16                         B***4
     C                     MOVE *BLANKS   DDSTEN           ****4
     C                     END                             E***4
     C*
     C                     EXSR #BB                        ***3
     C                     END                             E**3
     C*
     C**  IF CCY IS EQUAL TO MARKER CCY MUST SET COUNTER
     C           FOCCY     IFLE @BOTCY                     B**3           S01166
     C           *IN61     ANDNE'1'                        B**3           S01166
     C           A6DLCI    ANDNE'N'                                       050683
     C*                                                                   S01166
     C           RRN       IFEQ 99                         B***4          S01166
     C                     Z-ADD15        RRN              ****4          S01166
     C*
     C**  CHECK IF CCY LESS THAN OR EQUAL TO MARKER CCY  IE. THIS IS
     C**  WITHIN DISPLAY WINDOW   AND NOT BEGINNING OF FILE
     C***        FOCCY     IFLE @BOTCY                                    S01166
     C***        *IN61     ANDEQ'0'                                       S01166
     C*
     C**  IF RECORD IS THE FIRST ONE READ AND CCY LESS THAN OR EQUAL
     C**  TO MARKER CCY, CCY IS WITHIN THE DISPLAY WINDOW
     C           @FIRST    IFEQ 'Y'                        B***5          S01166
     C                     MOVE ' END '   DDSTEN           ****5          S01166
     C                     SETON                     30
     C                     END                             E***5          S01166
     C*
     C                     END                             E***4          S01166
     C*                                                                   S01166
     C**  MOVE CALCULATED VALUES TO DATA AREA AMENQ1AA FOR SCREEN
     C           RRN       IFLE 15                         B***4          S01166
     C***        RRN       ANDGE1                          B***4          S01166
     C                     EXSR #BC                        ****4
     C                     MOVE FOCCY     @TOPCY                          S01166
     C***                  END                                            S01166
     C*
     C**  SUBTRACT ONE FROM COUNTER (UNLESS IT IS 11, ALSO DON'T LET
     C**  COUNTER GO TO ZERO BECAUSE DISPLAY WINDOW GOES FROM 1 - 10)
     C***        RRN       IFLE 15                                        S01166
     C                     SUB  1         RRN              ****4          S01166
     C*
     C           RRN       IFEQ 0                          B****5         S01166
     C                     Z-ADD16        RRN              *****5         S01166
     C                     END                             E****5
     C***                  END                                            S01166
     C*
     C**  IF RRN    WITHIN 1-15 SET UP MULTIPLE OCC. DATA ST.             S01166
     C***        RRN       IFLE 15                                        S01166
     C***        RRN       ANDGE1                                         S01166
     C           RRN       OCUR @VALUE                     ****4          S01166
     C*
     C**  ELSE SET TO 16TH OCUR SO DOESNT CORRUPT DATA                    S01166
     C                     ELSE                            X***4
     C           16        OCUR @VALUE                     ****4          S01166
     C                     END                             E***4
     C*
     C**  END OF CCY LESS THAN OR EQUAL TO MARKER CCY SECTION
     C                     END                             E**3
     C*
     C**  IF THE LAST RECORD READ (IE. FIRST ON FILE) IS WITHIN           S01166
     C**  DISPLAY WINDOW                                                  S01166
     C           *IN61     IFEQ '1'                        B**3           S01166
     C*                                                                   S01166
     C* if bof before filling subfile                                     S01166
     C*     then treat as 1st screen                                      S01166
     C           RRN       IFNE 16                         B4             S01166
     C                     MOVE *BLANK    @INITL           *4             S01166
     C                     SETOF                     26    setof rollup   S01166
     C                     GOTO #B9                        *4             S01166
     C                     END                             E4             S01166
     C*                                                                   S01166
     C                     END                             E**3           S01166
     C*                                                                   S01166
     C**  IF FIRST READ IS SET TO YES, THEN SET IT TO NO
     C           @FIRST    IFEQ 'Y'                        B**3           S01166
     C                     MOVE 'N'       @FIRST           ***3           S01166
     C                     END                             E**3           S01166
     C*                                                                   S01166
     C**  END OF FORWARD OR BACKWARD READ SECTIONS
     C                     END                             E*2
     C*
     C**  END OF DO-LOOP
     C                     END                             E1
     C* format totals                                                     S01166
     C                     EXSR #BD                                       S01166
     C*                                                                   S01166
     C                     MOVE '1'       @INITL  1                       S01166
     C*                                                                   S01166
     C           #B9       ENDSR                           ** #B9 TAG **  S01166
     C****************************************************************
      /EJECT
     C****************************************************************    S01277
     C*                                                                   S01277
     C*  SUBROUTINE: #D   - PROCESS CROSS-CURRENCIES ENQUIRY              S01277
     C*                                                                   S01277
     C*  CALLED FROM : #B                                                 S01277
     C*                                                                   S01277
     C*  FIELDS INPUT :                                                   S01277
     C*                                                                   S01277
     C*  FIELDS USED : @BDVT    BANK DEALT SPOT BCE TOT. FOR S/FXEPOSLL   S01277
     C*                @CCC     CURRENCY  (PASSED AS PARAMETER)           S01277
     C*                RRN      RECORD COUNTER FOR S/FXEPOSLL             S01277
     C*                @FIRST   'Y' IF PROCESSING FIRST READ RECORD       S01277
     C*                @FWBK    FORWARD OR BACKWARD READ OF S/FXEPOSLL    S01277
     C*                @EFIL    'Y' IF FXEPOSLL IS EMPTY                  S01277
     C*                @ENQU    TYPE OF ENQUIRY (PASSED AS PARAMETER)     S01277
     C*                @HEAD1   HEADINGS FOR DISPLAY WINDOW               S01277
     C*                @HEAD2   HEADINGS FOR DISPLAY WINDOW               S01277
     C*                @HEAD3   HEADINGS FOR DISPLAY WINDOW               S01277
     C*                @HEAD4   HEADINGS FOR DISPLAY WINDOW               S01277
     C*                @HEAD5   HEADINGS FOR DISPLAY WINDOW (ARRAY)       S01277
     C*                @HEAD6   HEADINGS FOR DISPLAY WINDOW (ARRAY)       S01277
     C*                @MCCY    FIRST/LAST CCY ON DISPLAY WINDOW          S01277
     C*                @OCC     OCCURENCE OF DATA STRUCTURE               S01277
     C*                @PLV     PROFIT/LOSS                               S01277
     C*                @PLVT    PROFIT/LOSS TOTAL FOR FILE S/FXEPOSLL     S01277
     C*                DDSTEN   START/END OF FILE ON DISPLAY WINDOW       S01277
     C*                AMENQ    DATA AREA AMENQ1AA                        S01277
     C*                DBFILE   FILE READ ERROR, NAME OF FILE             S01277
     C*                DBASE    FILE READ ERROR, ERROR NUMBER             S01277
     C*                FOBDSE   BANK DEALT SPOT BCE         S/FXEPOSLL    S01277
     C*                FOCCY    CURRENCY CODE               S/FXEPOSLL    S01277
     C*                                                                   S01277
     C*    CALLS  :    #BA   DATA BASE ERROR                              S01277
     C*                #DB   CALCULATIONS (CROSS-CURRENCIES)              S01277
     C*                #BC   SETS UP FIELDS FOR OUTPUT TO AMENQ1AA        S01277
     C*                #DD   OUTPUT CROSS CURRENCY TOTALS                 S01277
     C*                                                                   S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C           #D        BEGSR                                          S01277
     C*                                                                   S01277
     C**  DON'T SET @PLV ETC TO x'404040' BELOW !!!  SO LOOP ROUND        S01277
     C**  ALL MULTIPLE OCCURENCES OF THE FIELDS,STOPS DECIMAL DATA ERRORS S01277
     C                     DO   16        @OCC    20       B1             S01277
     C           @OCC      OCUR @VALUE                     *1             S01277
     C                     MOVE *BLANKS   @VALUE           *1             S01277
     C                     Z-ADD0         @PLV             *1             S01277
     C                     Z-ADD0         @CPV             *1             S01277
     C                     Z-ADD0         @CBV             *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  If primary currency has changed since last time                 S01277
     C**  through treat as new enquiry.                                   S01277
     C*                                                                   S01277
     C           DDPCCY    IFNE @SAVCY                     B1             S01277
     C                     MOVE '0'       @INITL                          S01277
     C**  If roll up/down pressed treat as 'enter'.                       S01277
     C                     MOVE '0'       *IN25                           S01277
     C                     MOVE '0'       *IN26                           S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C                     MOVE DDPCCY    @SAVCY  3                       S01277
     C*                                                                   S01277
     C**  GET NUMBER OF DECIMAL PLACES FOR PRIMARY CURRENCY               S01277
     C*   VIA ACCESS OBJECT                                               S01194
     C*                                                                   S01277
     C                     MOVE DDPCCY    @CYY                            S01277
      *                                                                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7        *1             S01194
     C                     PARM '*KEY   ' @OPTN   7        *1             S01194
     C                     PARM           @CYY    3        *1             S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01194
     C                     MOVE A6NBDP    @PRCDP  10                      S01194
     C*                                                                   S01277
     C**  SET FIRST RECORD READ FLAG TO 'Y'                               S01277
     C                     MOVE 'Y'       @FIRST  1                       S01277
     C*                                                                   S01277
     C**  ZEROIZE RUNNING TOTAL FIELDS                                    S01277
     C                     Z-ADD0         @PLVT  150                      S01277
     C                     Z-ADD0         @PLT15                          S01277
     C*                                                                   S01277
     C                     Z-ADD0         @BDVT  150                      S01277
     C*                                                                   S01277
     C                     MOVE 'N'       @NOREC                          S01277
     C*                                                                   S01277
     C* 1st time round (i.e. not refresh or roll)                         S01277
     C*   read file forwards from beginning                               S01277
     C           *IN25     IFEQ '0'                        B1             S01277
     C           *IN26     ANDEQ'0'                        B1             S01277
     C           *IN05     ANDEQ'0'                        B1             S01277
     C                     MOVE 'F'       @FWBK            *1             S01277
     C           @CKEY1    SETLLFXCRSCLL                   *1             S01277
     C                     READ FXCRSCLL                 64*1             S01277
     C*                                                                   S01277
     C**  IF END OF FILE (NO RECORD READ EOF *IN 64 SET ON)               S01277
     C**  MUST BE EMPTY FILE - WRITE TO MSG SUBFILE                       S01277
     C           *IN64     IFEQ '1'                        B2             S01277
     C           DDPCCY    ORNE CPPCCY                     B2             S01277
     C                     MOVEL'RTM0011' @MSGID 10        *2             S01277
     C                     MOVE '1'       *IN30                           S01277
     C                     CALL 'ZA0240'                   *2             S01277
     C                     PARM           @MSGID           *2             S01277
     C                     MOVE '1'       @INITL           *2             S01277
     C                     MOVE 'Y'       @EFIL            *2             S01277
     C                     MOVE *BLANKS   DDBDVT           *2             S01277
     C                     MOVE *BLANKS   DDPLVT           *2             S01277
     C* clear enq subfile                                                 S01277
     C                     SETOF                     3536                 S01277
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01277
     C* rewrite blank subfile                                             S01277
     C                     SETON                     3536                 S01277
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01277
     C                     Z-ADD99        RRN                             S01277
     C                     MOVE *BLANKS   DDSTEN                          S01277
     C*********************SETOF                     30             S01277S01277
     C*                                                                   S01277
     C                     GOTO #D9                        *2             S01277
     C                     END                             E2             S01277
     C*                                                                   S01277
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW                   S01277
     C                     MOVE @MKCCY    @TPCCY  6        *1             S01277
     C           @CKEY1    SETLLFXCRSCLL                   *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  MUST READ FILE FORWARDS                                         S01277
     C           *IN25     IFEQ '1'                        B1             S01277
     C                     MOVE 'F'       @FWBK            *1             S01277
     C                     MOVE @BTCCY    @CSCCY
     C           @CKEY2    SETGTFXCRSCLL                   *1             S01277
     C                     READ FXCRSCLL                 64*1             S01277
     C*                                                                   S01277
     C**  IF END OF FILE (NO RECORD READ EOF *IN 64 SET ON)               S01277
     C**  OR PRIMARY CURRENCY HAS CHANGED                                 S01277
     C**  MUST BE NO MORE RECS TO DISPLAY                                 S01277
     C           *IN64     IFEQ '1'                        B2             S01277
     C           DDPCCY    ORNE CPPCCY                     B2             S01277
     C                     MOVEL'RTM0001' @MSGID           *2             S01277
     C                     MOVE '1'       *IN30                           S01277
     C                     CALL 'ZA0240'                   *2             S01277
     C                     PARM           @MSGID           *2             S01277
     C                     MOVE 'Y'       @EFIL            *2             S01277
     C                     GOTO #D9                        *2             S01277
     C                     END                             E2             S01277
     C*                                                                   S01277
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW                   S01277
     C                     MOVE @MKCCY    @TPCCY           *1             S01277
     C           @CKEY1    SETLLFXCRSCLL                   *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  MUST READ FILE BACKWARDS                                        S01277
     C           *IN26     IFEQ '1'                        B1             S01277
     C                     MOVE @TPCCY    @CSCCY
     C           @CKEY2    SETLLFXCRSCLL                   *1             S01277
     C                     READPFXCRSCLL                 64*1             S01277
     C*                                                                   S01277
     C**  IF BEGINNING OF FILE (NO RECORD READ EOF *IN 64 SET ON)         S01277
     C**  OR PRIMARY CURRENCY HAS CHANGED                                 S01277
     C**  MUST BE EMPTY FILE                                              S01277
     C           *IN64     IFEQ '1'                        B2             S01277
     C           DDPCCY    ORNE CPPCCY                     B2             S01277
     C                     MOVEL'RTM0001' @MSGID           *2             S01277
     C                     MOVE '1'       *IN30                           S01277
     C                     CALL 'ZA0240'                   *2             S01277
     C                     PARM           @MSGID           *2             S01277
     C                     MOVE 'Y'       @EFIL            *2             S01277
     C                     GOTO #D9                        *2             S01277
     C                     END                             E2             S01277
     C*                                                                   S01277
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW                   S01277
     C**  AND ASSUME ROLLBACK TO BEGINNING                                S01277
     C                     MOVE 'START'   DDSTEN           *1             S01277
     C                     MOVE @MKCCY    @BTCCY  6        *1             S01277
     C           @CKEY1    SETGTFXCRSCLL                   *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  MUST READ FILE FORWARDS                                         S01277
     C           *IN05     IFEQ '1'                        B1             S01277
     C                     MOVE 'F'       @FWBK            *1             S01277
     C*                                                                   S01277
     C**  MUST REFRESH FROM START OF FILE                                 S01277
     C                     MOVE @TPCCY    @CSCCY
     C           @CKEY2    SETLLFXCRSCLL                   *1             S01277
     C                     READ FXCRSCLL                 64*1             S01277
     C*                                                                   S01277
     C**  IF END OF FILE (NO RECORD READ EOF *IN 64 SET ON)               S01277
     C**  OR PRIMARY CURRENCY HAS CHANGED                                 S01277
     C**  MUST BE EMPTY FILE                                              S01277
     C           *IN64     IFEQ '1'                        B**2           S01277
     C           DDPCCY    ORNE CPPCCY                     B**2           S01277
     C                     MOVEL'RTM0011' @MSGID           ***2           S01277
     C                     MOVE '1'       *IN30                           S01277
     C                     CALL 'ZA0240'                   ***2           S01277
     C                     PARM           @MSGID           ***2           S01277
     C                     MOVE 'Y'       @EFIL            ***2           S01277
     C                     MOVE *BLANKS   DDBDVT           *2             S01277
     C                     MOVE *BLANKS   DDPLVT           *2             S01277
     C* clear enq subfile                                                 S01277
     C                     SETOF                     3536                 S01277
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01277
     C* rewrite blank subfile                                             S01277
     C                     SETON                     3536                 S01277
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01277
     C                     GOTO #D9                        ***2           S01277
     C                     END                             E**2           S01277
     C*                                                                   S01277
     C**  SET UP MARKER CCY FOR START OF DISPLAY WINDOW                   S01277
     C                     MOVE @MKCCY    @TPCCY           **1            S01277
     C           @CKEY1    SETLLFXCRSCLL                   *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  THIS SETS MULT. OCC. DS. ON OCCURENCE 1                         S01277
     C           @FWBK     IFEQ 'F'                        B1             S01277
     C           1         OCUR @VALUE                     *1             S01277
     C                     ELSE                            X1             S01277
     C           15        OCUR @VALUE                     *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**** ******  ******  ******  ******  ******  ******  ******         S01277
     C*                                                                   S01277
     C* clear enq subfile                                                 S01277
     C                     SETOF                     3536                 S01277
     C                     WRITETM3150C1                                  S01117
     C*                                                                   S01277
     C                     Z-ADD99        RRN                             S01277
     C                     MOVE *BLANKS   DDSTEN                          S01277
     C                     SETOF                     30                   S01277
     C*                                                                   S01277
     C**  READ EACH RECORD AND IF IT IS WITHIN THE DISPLAY WINDOW         S01277
     C**  CALCULATE THE VARIOUS VALUES, ELSE JUST TOTAL P/L & DEALT BCE   S01277
     C*                                                                   S01277
     C**  REPEAT UNTIL BEGINNING OR END OF FILE                           S01277
     C**  OR ERROR ON FILE READS/CHAINS OR PRIMARY                        S01277
     C**  CURRENCY CHANGES                                                S01277
     C           *IN64     DOWEQ'0'                        B1             S01277
     C           *IN65     ANDEQ'0'                        B1             S01277
     C           DDPCCY    ANDEQCPPCCY                     B1             S01277
     C*                                                                   S01277
     C**  IF READING FORWARDS USE  READ                                   S01277
     C           @FWBK     IFEQ 'F'                        B*2            S01277
     C*                                                                   S01277
     C                     READ FXCRSCLL               6564**2            S01277
     C*                                                                   S01277
     C**  IF AN ERROR ON THE READ (NOT EOF!!)                             S01277
     C           *IN65     IFEQ '1'                        B**3 **********S01277
     C                     MOVEL'FXCRSCLL'DBFILE           ***3 * DB      S01277
     C                     MOVEL'007'     DBASE            ***3 * ERROR 00701277
     C                     EXSR #BA                        ***3 **********S01277
     C                     GOTO #D9                        ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C** CALCULATE P/L ETC., IF NOT END OF FILE                           S01277
     C** AND PRIMARY CURRENCY NOT CHANGED                                 S01277
     C           *IN64     IFEQ '0'                        B**3           S01277
     C           DDPCCY    ANDEQCPPCCY                     B**3           S01277
     C*                                                                   S01277
     C**  Cross ccy positions are being kept for this ccy                 S01277
     C**  so access FXEPOCLL for details.                                 S01277
     C*                                                                   S01277
     C                     MOVE CPSCCY    @CSCCY                          S01277
     C*                                                                   S01277
     C           @EPKEY    CHAINFXEPOCLL             66                   S01277
     C*                                                                   S01277
     C**  If record not found no position exists for this                 S01277
     C**  currency combination so output zero position to                 S01277
     C**  screen.                                                         S01277
     C*                                                                   S01277
     C           *IN66     IFEQ '1'                        B***4          S01277
     C*                                                                   S01277
     C                     MOVE CPSCCY    FOCCY                           S01277
     C                     MOVE *BLANKS   @CPV11                          S01277
     C******               MOVE '0'       @CPV11                    S01277S01277
     C                     MOVE '0 '      @CPV11                          S01277
     C                     MOVE *BLANKS   @COR                            S01277
     C******               MOVE '0'       @COR                      S01277S01277
     C                     MOVEL'0.0'     @COR                            S01277
     C                     MOVE *BLANKS   @CBV11                          S01277
     C******               MOVE '0'       @CBV11                    S01277S01277
     C                     MOVE '0 '      @CBV11                          S01277
     C***********          MOVE *BLANKS   @RRV                      S01277S01277
     C***********          MOVE '0'       @RRV                      S01277S01277
     C*                                                                   S01277
     C** Calculate cross currency, always display low rate (no position   S01277
     C** So doesn't really matter which is displayed, std is low rate)    S01277
     C                     EXSR #DBA                                      S01277
     C*                                                                   S01277
     C** Format for display                                               S01277
     C                     Z-ADD@@LRAT    @@RIN                           S01277
     C                     EXSR ZA0880                                    S01277
     C                     MOVEA@B        @RRV                            S01277
      *                                                                   S01277
     C                     MOVE *BLANKS   @PLV13                          S01277
     C******               MOVE '0'       @PLV13                    S01277S01277
     C                     MOVE '0 '      @PLV13                          S01277
     C*                                                                   S01277
     C                     ELSE                            X***4          S01277
     C*                                                                   S01277
     C                     EXSR #DB                        ****4          S01277
     C*                                                                   S01277
     C                     END                             E***4          S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  CHECK IF CCY GREATER THAN OR EQUAL TO MARKER CCY  IE. IS THIS   S01277
     C**  WITHIN DISPLAY WINDOW   AND NOT END OF FILE                     S01277
     C**  AND PRIMARY CURRENCY NOT CHANGED                                S01277
     C           @MKCCY    IFGE @TPCCY                     B**3           S01277
     C           *IN64     ANDNE'1'                        B**3           S01277
     C           DDPCCY    ANDEQCPPCCY                     B**3           S01277
     C           RRN       IFEQ 99                         B***4          S01277
     C                     Z-ADD1         RRN              ****4          S01277
     C*                                                                   S01277
     C**  IF THE CCY EQUAL TO THE MARKER CCY IS THE FIRST RECORD READ     S01277
     C           @FIRST    IFEQ 'Y'                        B****5         S01277
     C                     MOVE 'START'   DDSTEN           *****5         S01277
     C                     END                             E****5         S01277
     C                     END                             E****4         S01277
     C*                                                                   S01277
     C**  MOVE CALCULATED VALUES TO SUBFILE FOR DISPLAY                   S01277
     C           RRN       IFLE 15                         B***4          S01277
     C                     EXSR #BC                        ****4          S01277
     C                     MOVE @MKCCY    @BTCCY           ****4          S01277
     C*                                                                   S01277
     C**  ADD ONE TO COUNTER (UNLESS IT IS 16, THIS STOPS COUNTER         S01277
     C**  GOING BEYOND 99 AND BACK TO 0)                                  S01277
     C                     ADD  1         RRN              ****4          S01277
     C*                                                                   S01277
     C**  IF RRN    WITHIN 1-15 SET UP MULTIPLE OCC. DATA ST.             S01277
     C           RRN       OCUR @VALUE                     ****4          S01277
     C*                                                                   S01277
     C**  ELSE SET TO 16TH OCUR SO DOESNT CORRUPT DATA                    S01277
     C                     ELSE                            X***4          S01277
     C           16        OCUR @VALUE                     ****4          S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C**  END OF CCY READ EQUAL TO OR GREATER THAN MARKER CCY SECTION     S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  IF THE LAST RECORD ON FILE IS WITHIN DISPLAY WINDOW             S01277
     C**     SETON SFLEND INDICATOR                                       S01277
     C           *IN64     IFEQ '1'                        B**3           S01277
     C           RRN       ANDLE15                         B**3           S01277
     C           DDPCCY    ORNE CPPCCY                     B**3           S01277
     C           RRN       ANDLE15                         B**3           S01277
     C                     MOVE ' END '   DDSTEN           ***3           S01277
     C                     SETON                     30                   S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  ELSE IF READING BACKWARDS USE  READP                            S01277
     C                     ELSE                            X*2            S01277
     C                     READPFXCRSCLL               6564**2            S01277
     C*                                                                   S01277
     C**  IF AN ERROR ON THE READ (NOT BOF!!)                             S01277
     C           *IN65     IFEQ '1'                        B**3           S01277
     C                     MOVEL'FXCRSCLL'DBFILE           ***3 **********S01277
     C                     MOVEL'008'     DBASE            ***3 * DB      S01277
     C                     EXSR #BA                        ***3 * ERROR 00801277
     C                     GOTO #D9                        ***3 **********S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  CALCULATE PROFIT AND LOSS ETC. IF NOT BOF                       S01277
     C** AND PRIMARY CURRENCY NOT CHANGED                                 S01277
     C           *IN64     IFEQ '0'                        B**3           S01277
     C           DDPCCY    ANDEQCPPCCY                     B**3           S01277
     C** not bof and subfile full - so not START                          S01277
     C           RRN       IFEQ 16                         B***4          S01277
     C                     MOVE *BLANKS   DDSTEN           ****4          S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C**  Cross ccy positions are being kept for this ccy                 S01277
     C**  so access FXEPOCLL for details.                                 S01277
     C*                                                                   S01277
     C                     MOVE CPSCCY    @CSCCY                          S01277
     C*                                                                   S01277
     C           @EPKEY    CHAINFXEPOCLL             66                   S01277
     C*                                                                   S01277
     C**  If record not found no position exists for this                 S01277
     C**  currency combination so output zero position to                 S01277
     C**  screen.                                                         S01277
     C*                                                                   S01277
     C           *IN66     IFEQ '1'                        B***4          S01277
     C*                                                                   S01277
     C                     MOVE CPSCCY    FOCCY                           S01277
     C                     MOVE *BLANKS   @CPV11                          S01277
     C                     MOVE '0'       @CPV11                          S01277
     C                     MOVE *BLANKS   @COR                            S01277
     C                     MOVE '0'       @COR                            S01277
     C                     MOVE *BLANKS   @CBV11                          S01277
     C                     MOVE '0'       @CBV11                          S01277
     C                     MOVE *BLANKS   @RRV                            S01277
     C                     MOVE '0'       @RRV                            S01277
     C                     MOVE *BLANKS   @PLV13                          S01277
     C                     MOVE '0'       @PLV13                          S01277
     C*                                                                   S01277
     C                     ELSE                            X***4          S01277
     C*                                                                   S01277
     C                     EXSR #DB                        ****4          S01277
     C*                                                                   S01277
     C                     END                             E***4          S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  IF CCY IS EQUAL TO MARKER CCY MUST SET COUNTER                  S01277
     C           @MKCCY    IFLE @BTCCY                     B**3           S01277
     C           *IN64     ANDNE'1'                        B**3           S01277
     C           DDPCCY    ANDEQCPPCCY                     B**3           S01277
     C*                                                                   S01277
     C           RRN       IFEQ 99                         B***4          S01277
     C                     Z-ADD15        RRN              ****4          S01277
     C*                                                                   S01277
     C**  IF RECORD IS THE FIRST ONE READ AND CCY LESS THAN OR EQUAL      S01277
     C**  TO MARKER CCY, CCY IS WITHIN THE DISPLAY WINDOW                 S01277
     C           @FIRST    IFEQ 'Y'                        B***5          S01277
     C                     MOVE ' END '   DDSTEN           ****5          S01277
     C                     SETON                     30                   S01277
     C                     END                             E***5          S01277
     C*                                                                   S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C**  MOVE CALCULATED VALUES TO DATA AREA AMENQ1AA FOR SCREEN         S01277
     C           RRN       IFLE 15                         B***4          S01277
     C                     EXSR #BC                        ****4          S01277
     C                     MOVE @MKCCY    @TPCCY           ****4          S01277
     C*                                                                   S01277
     C**  SUBTRACT ONE FROM COUNTER (UNLESS IT IS 11, ALSO DON'T LET      S01277
     C**  COUNTER GO TO ZERO BECAUSE DISPLAY WINDOW GOES FROM 1 - 10)     S01277
     C                     SUB  1         RRN              ****4          S01277
     C*                                                                   S01277
     C           RRN       IFEQ 0                          B****5         S01277
     C                     Z-ADD16        RRN              *****5         S01277
     C                     END                             E****5         S01277
     C*                                                                   S01277
     C**  IF RRN    WITHIN 1-15 SET UP MULTIPLE OCC. DATA ST.             S01277
     C           RRN       OCUR @VALUE                     ****4          S01277
     C*                                                                   S01277
     C**  ELSE SET TO 16TH OCUR SO DOESNT CORRUPT DATA                    S01277
     C                     ELSE                            X***4          S01277
     C           16        OCUR @VALUE                     ****4          S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C**  END OF CCY LESS THAN OR EQUAL TO MARKER CCY SECTION             S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  IF THE LAST RECORD READ (IE. FIRST ON FILE) IS WITHIN           S01277
     C**  DISPLAY WINDOW                                                  S01277
     C**  OR PRIMARY CURRENCY HAS CHANGED                                 S01277
     C           *IN64     IFEQ '1'                        B**3           S01277
     C           DDPCCY    ORNE CPPCCY                     B**3           S01277
     C*                                                                   S01277
     C* if bof before filling subfile                                     S01277
     C*     then treat as 1st screen                                      S01277
     C           RRN       IFNE 16                         B4             S01277
     C                     MOVE '0'       @INITL           *4             S01277
     C                     SETOF                     26    setof rollup   S01277
     C                     GOTO #D9                        *4             S01277
     C                     END                             E4             S01277
     C*                                                                   S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  IF FIRST READ IS SET TO YES, THEN SET IT TO NO                  S01277
     C           @FIRST    IFEQ 'Y'                        B**3           S01277
     C                     MOVE 'N'       @FIRST           ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C**  END OF FORWARD OR BACKWARD READ SECTIONS                        S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C**  END OF DO-LOOP                                                  S01277
     C                     END                             E1             S01277
     C* format totals                                                     S01277
     C                     EXSR #DD                                       S01277
     C*                                                                   S01277
     C                     MOVE '1'       @INITL  1                       S01277
     C*                                                                   S01277
     C           #D9       ENDSR                           ** #D9 TAG **  S01277
     C****************************************************************    S01277
     C/EJECT                                                              S01277
     C****************************************************************
     C*
     C*  SUBROUTINE: #BB  - THIS ROUTINE CALCULATES THE VARIOUS VALUES
     C*                     EG. P/L COR BCE
     C*
     C*  FIELDS USED : @B     OUTPUT VALUE FROM ZA0880
     C*                @CBS   COR BCE SIGN
     C*                @CBV   COR BCE VALUE
     C*                @CPS   OPEN POSITION SIGN
     C*                @CPV   OPEN POSITION VALUE
     C*                @DP    DECIMAL PLACES CORRECTION ARRAY
     C*                @F     INDEX FOR DECIMAL PLACES CORRECTION ARRAY   S01166
     C*                @P     BASE CCY DECIMAL PLACES - 1
     C*                @PLV   PROFIT/LOSS (6,0)
     C*                @PLV15 PROFIT/LOSS(9,0)  B'COS CAN HAVE UPTO 3 D.P.S01166
     C*                @PLT15 PROFIT/LOSS TOTAL (15,0)
     C*                @RRV   REVALUATION RATE
     C*                @RVBC  REVALUATION BCE NUMERIC
     C*                @RVRT  REVALUATION RATE NUMERIC
     C*                @WORK  WORK FIELD USED IN REV. RATE CALC.
     C*                @@NDPB DECIMAL PLACES FOR BASE CCY
     C*                @@RIN  INPUT VALUE FOR ZA0880
     C*****************CDP    CURRENCY DECIMAL PLACES      S/TABTG10      S01194
     C*                A6NBDP CURRENCY DECIMAL PLACES      PF/SDCURRPD    S01194
     C*                FOCCY  CURRENCY READ FROM FILE      S/FXEPOSLL
     C*                FOTNTP TOTAL NET POSITION           S/FXEPOSLL
     C*                FOBDSE BANK DEALT SPOT BCE          S/FXEPOSLL
     C*****************HISP   HIGH SPOT RATE               S/TABTG10      S01194
     C*                A6HSRT HIGH SPOT RATE               PF/SDCURRPD    S01194
     C*****************IDCYDL*BASE*CCY*FOR*DEALING************************S01319
     C*                BNCYDL BASE CCY FOR DEALING                        S01319
     C*****************LOSP   LOW SPOT RATE                S/TABTG10      S01194
     C*                A6LSPR LOW SPOT RATE                PF/SDCURRPD    S01194
     C*****************XRMD   EXCHANGE RATE MULT/DIV *IN   S/TABTG10      S01194
     C*                A6MDEX EXCHANGE RATE MULT/DIV *IN   PF/SDCURRPD    S01194
     C*                A6SCEX SCALING EXPONENT             PF/SDCURRPD    S01194
     C*
     C*
     C*  FIELDS INPUT :
     C*
     C*  CALLED BY : #B
     C*
     C*  CALLS     :     ZA0880    VALUE FORMATTING
     C*                  #BA       FILE DATA BASE ERROR
     C*
     C****************************************************************
     C           #BB       BEGSR
      **************                                                      S01136
      ************** Initialize fields before read.                       S01136
     C**************       Z-ADD0         BVUNMP                          S01136
     C**************       Z-ADD0         BVBDSE                          S01136
     C***********FOCCY     CHAINBBCPOSLL             99                   S01136
      *************                                                       S01136
      *************  Net value fields from FX and BB Currency positions   S01136
     C***********BVUNMP    ADD  FOTNTP    TNTP                            S01136
     C***********BVBDSE    ADD  FOBDSE    BDSE                            S01136
     C*                                                                   S01166
     C****ACCESS*S/TABTG10*THROUGH*S/FXFDCCYTLL***                 S01166 S01194
     C                     MOVE FOCCY     @CYY                            S01166
      *                                                                   S01194
      * Call Access Object for Currency details                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @CYY    3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C           A6DLCI    IFEQ 'N'                                       050683
     C                     GOTO #BB9                                      050683
     C                     END                                            050683
     C           A6LSPR    IFEQ 0                                         082279
     C                     Z-ADD1         A6LSPR                          082279
     C                     END                                            082279
     C           A6HSRT    IFEQ 0                                         082279
     C                     Z-ADD1         A6HSRT                          082279
     C                     END                                            082279
      *                                                                   S01194
     C********** @KDCY     CHAINFDCCYTLL             63            S01166 S01194
     C**********                                                   S01166 S01194
     C****ERROR*IF*NO*RECORD*FOUND,*SET*UP*LDA*AND*EXIT*PGM***     S01166 S01194
     C********** *IN63     IFEQ '1'                        B1      S01166 S01194
     C**********           MOVEL'FDCCYTLL'DBFILE           *1 *****S01166 S01194
     C**********           MOVEL'003'     DBASE            *1 *    S01166 S01194
     C**********           MOVEL@CYY      DBKEY            *1 * DB S01166 S01194
     C**********           EXSR #BA                        *1 *    S01166 S01194
     C**********           GOTO #BB9                       *1 *****S01166 S01194
     C**********           END                             E1      S01166 S01194
     C*
     C**  CURRENCY POSITION
     C*   ~~~~~~~~~~~~~~~~~
     C******************** Z-ADDTNTP      @CPV                            S01136
     C                     Z-ADDFOTNTP    @CPV                            S01136
     C*
     C**  ADD SIGN
     C***********TNTP      IFLT 0                          B1             S01136
     C***        FOTNTP    IFLT 0                          B1             S01136
     C***                  MOVE '-'       @CPS             *1             S01166
     C***                  Z-SUB@CPV      @CPV             *1             S01166
     C***                  ELSE                            X2             S01166
     C***                  MOVE '+'       @CPS             *1             S01166
     C***                  END                             E1             S01166
     C*                                                                   S01166
     C                     Z-ADD@CPV      @@IAMT           *1             S01166
     C                     DIV  1000      @@IAMT    H      *1             E12560
     C**********           Z-ADDCDP       @@CDP   10       *1      S01166 S01194
     C                     Z-ADDA6NBDP    @@CDP   10       *1             S01194
     C*                    MOVE JRDFCY    @@CCY            *1             S01166
     C                     Z-ADD21        @@CRET  20       *1             S01166
     C                     EXSR ZA0750                     *1             S01166
     C                     MOVE @@ADSP    @CPV11 11        *1             S01166
     C*
     C** IF CCY IS BASE CCY NO MORE PROCESSING IS REQUIRED
     C***********FOCCY*****IFEQ*IDCYDL*********************B1*************S01319
     C           FOCCY     IFEQ BNCYDL                     B1             S01319
     C                     MOVE *BLANKS   @COR             *1             S01166
     C                     MOVE *BLANKS   @CBV11           *1             S01166
     C                     MOVE *BLANKS   @RRV             *1             S01166
     C                     MOVE *BLANKS   @PLV13           *1             S01166
     C                     GOTO #BB9                       *1
     C                     END                             E1
     C*
     C**  CLOSE OUT RATE BASE CURRENCY EQUIVALENT
     C*   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     C*
     C**  USE BANK DEALT SPOT BCE (S/FXEPOSLL)
     C                     Z-ADDFOBDSE    @CBV                            S01136
     C*******************  Z-ADDBDSE      @CBV                            S01136
     C**  ADD SIGN (REVERSED)
     C***        FOBDSE    IFLT 0                                         S01136
     C***********BDSE      IFLT 0                                         S01136
     C***                  MOVE '+'       @CBS                            S01166
     C                     Z-SUB@CBV      @CBV                            S01166
     C***                  ELSE                                           S01166
     C***                  MOVE '-'       @CBS                            S01166
     C***                  END                                            S01166
     C*                                                                   S01166
     C                     Z-ADD@CBV      @@IAMT           *1             S01166
     C                     DIV  1000      @@IAMT    H      *1             E12560
     C                     Z-ADD@@NDPB    @@CDP            *1             S01166
     C*                    MOVE JRDFCY    @@CCY            *1             S01166
     C                     Z-ADD21        @@CRET  20       *1             S01166
     C                     EXSR ZA0750                     *1             S01166
     C                     MOVE @@ADSP    @CBV11 11        *1             S01166
     C*                                                                   S01166
     C*                                                                   S01166
     C**  FOR BOTH FORWARD AND BACKWARD READ MUST KEEP RUNNING TOTALS :
     C**  BANK DEALT SPOT BASE CCY EQUIVALENT RUNNING TOTAL
     C                     ADD  FOBDSE    @BDVT                           S01136
     C*********************ADD  BDSE      @BDVT                           S01136
     C*
     C**  REVALUATION RATE
     C*   ~~~~~~~~~~~~~~~~
     C*
     C**  IF CURRENCY POSITION IS ZERO, USE COR BCE
     C**  (  FOBDSE  = - COR BCE     BUT MUST NOT REVERSE SIGN!! )
     C**  (  FOTNTP  =  CCY POSITION )        ~~~
     C*
     C**  ELSE USE CCY POSITION
     C*
     C           FOTNTP    IFEQ 0                          B1             S01136
     C           *LIKE     DEFN FOBDSE    @WORK            *1             S01136
     C                     Z-ADDFOBDSE    @WORK            *1             S01136
     C***********TNTP      IFEQ 0                          B1             S01136
     C************LIKE     DEFN BDSE      @WORK            *1             S01136
     C***********          Z-ADDBDSE      @WORK            *1             S01136
     C*
     C**  ELSE USE CCY POSITION
     C                     ELSE                            X1
     C                     Z-ADDFOTNTP    @WORK            *1     BB9800  S01136
     C*******************  Z-ADDTNTP      @WORK            *1             S01136
     C                     END                             E1
     C*
     C********** *LIKE     DEFN HGSP      @RVRT                           S01194
     C           *LIKE     DEFN A6HSRT    @RVRT                           S01194
     C********** XRMD      IFEQ 'M'                        B1             S01194
     C           A6MDEX    IFEQ 'M'                        B1             S01194
     C           @WORK     ANDLT0                          B1
     C*
     C********** XRMD      OREQ 'D'                        B1             S01194
     C           A6MDEX    OREQ 'D'                        B1             S01194
     C           @WORK     ANDGT0                          B1
     C*
     C**********           Z-ADDHGSP      @RVRT            *1             S01194
     C                     Z-ADDA6HSRT    @RVRT            *1             S01194
     C                     ELSE                            X1
     C**********           Z-ADDLOSP      @RVRT            *1             S01194
     C                     Z-ADDA6LSPR    @RVRT            *1             S01194
     C                     END                             E1
     C*
     C**  FORMAT RATE FOR PC (VIA DATA AREA)
     C                     MOVE @RVRT     @@RIN
     C                     Z-ADD0         @PAD    10
     C********** @PAD      DOWNESEXP                       B1             S01194
     C           @PAD      DOWNEA6SCEX                     B1             S01194
     C                     MULT 10        @@RIN            *1
     C                     ADD  1         @PAD             *1
     C                     END                             E1
     C                     EXSR ZA0880
     C*
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST
     C                     MOVEA@B        @RRV
     C*
     C**  REVALUATION BASE CURRENCY EQUIVALENT (USED BY P/L CALC.)
     C*   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     C**  (  FOTNTP  =  CCY POSITION )
     C           *LIKE     DEFN FOTNTP    @RVBC                           S01136
     C************LIKE     DEFN TNTP      @RVBC                           S01136
     C*
     C**  IF CURRENCY POSITION IS ZERO, REV. BCE WILL BE ZERO
     C           FOTNTP    IFEQ 0                          B1             S01136
     C********** TNTP      IFEQ 0                          B1             S01136
     C                     MOVE *ZEROS    @RVBC            *1
     C*
     C**  ELSE CALCULATE VALUE
     C                     ELSE                            X1
     C********** CDP       SUB  @@NDPB    @F      10       *1      S01166 S01194
     C           A6NBDP    SUB  @@NDPB    @F      10       *1             S01194
     C                     ADD  4         @F               *1             S01166
     C           @F        IFLT 4                                         S01166
     C           FOTNTP    MULT @DP,@F    FOTNTP    H      *1             S01136
     C***********TNTP      MULT @DP,@F    TNTP      H      *1             S01136
     C                     END
     C*
     C**  CHECK MULT/DIVIDE INDICATOR
     C*
     C********** XRMD      IFEQ 'M'                        B*2            S01194
     C           A6MDEX    IFEQ 'M'                        B*2            S01194
     C********** TNTP      MULT @RVRT     @RVBC     H      **2            S01136
     C           FOTNTP    MULT @RVRT     @RVBC     H      **2            S01136
     C                     ELSE                            X*2
     C***********TNTP      DIV  @RVRT     @RVBC     H      **2            S01136
     C           FOTNTP    DIV  @RVRT     @RVBC     H      **2            S01136
     C                     END                             E*2
     C           @F        IFLT 4                          B*2            S01166
     C********** TNTP      MULT @DP,@F    TNTP      H                     S01136
     C           FOTNTP    MULT @DP,@F    FOTNTP    H      **2            S01136
     C                     END                             E*2
     C           @F        IFGT 4                          B*2            S01166
     C           @RVBC     MULT @DP,@F    @RVBC     H      **2            S01166
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C                     Z-ADD0         @PAD    10
     C********** @PAD      DOWNESEXP                                      S01194
     C           @PAD      DOWNEA6SCEX                                    S01194
     C                     MULT 10        @RVRT
     C                     ADD  1         @PAD
     C                     END
     C*
     C**  FORMAT RATE FOR PC (VIA DATA AREA)
     C                     MOVE @RVRT     @@RIN
     C                     EXSR ZA0880
     C*
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST
     C                     MOVEA@B        @RRV
     C*
     C**  PROFIT/LOSS
     C*   ~~~~~~~~~~~
     C*
     C**  (  FOBDSE  = - COR BCE )
     C**  THIS MAY SEEM BACK-TO-FRONT BUT BECAUSE THE SIGNS OF BOTH
     C**  THE FIELDS HAVE NOT BEEN REVERSED IT IS CORRECT      ~~~~
     C           @RVBC     SUB  FOBDSE    @PLV15 150                      S01136
     C********** @RVBC     SUB  BDSE      @PLV15  90                      S01136
     C*                                                                   E12284
     C**  IF BASE CCY OF DEALING HAS ZERO DECIMAL POINT, DIVIDE P/L FIGUREE12284
     C**  BY 1000 TO AVOID OVERFLOW OF SIGNIFICANT FIGURE IN P/L.         E12284
     C*                                                                   E12284
     C           @@NDPB    IFEQ 0                          B1             E12284
     C           @PLV15    DIV  1000      @PLV15    H      *1             E12284
     C                     END                             E1             E12284
     C*
     C**  MUST CONVERT THIS TO UNITS
     C           @PLV15    DIV  @DP,@P    @PLV      H                     S01166
     C*
     C**  FOR BOTH FORWARD AND BACKWARD READ MUST KEEP RUNNING TOTALS :
     C**  PROFIT AND LOSS
     C                     ADD  @PLV15    @PLT15 150                      S01166
     C*
     C**  ADD SIGN
     C***        @PLV      IFLT 0                          B1             S01166
     C***                  MOVE '-'       @PLS             *1             S01166
     C***                  Z-SUB@PLV      @PLV             *1             S01166
     C***                  ELSE                            X1             S01166
     C***                  MOVE '+'       @PLS             *1             S01166
     C***                  END                             E1             S01166
     C                     Z-ADD0         @@CDP            *1             S01166
     C                     Z-ADD@PLV      @@IAMT           *1             S01166
     C*                    MOVE JRDFCY    @@CCY            *1             S01166
     C                     Z-ADD21        @@CRET  20       *1             S01166
     C                     EXSR ZA0750                     *1             S01166
     C                     MOVE @@ADSP    @PLV13 13        *1             S01166
     C*                                                                   S01166
     C*   CALCULATE COR                                                   S01166
     C*     need to adjust according to ccy dec places @@CDP              S01166
     C*                        and base ccy dec places @@NDPB             S01166
     C*                                                                   S01166
     C                     Z-ADD0         @CORN  138                      S01166
     C*                                                                   S01166
     C           @CPV      IFNE 0                          B1             S01166
     C           @CBV      ANDNE0                          B1             S01166
     C**********           Z-ADDCDP       @@CDP            *1      S01166 S01194
     C                     Z-ADDA6NBDP    @@CDP            *1             S01194
     C                     Z-ADD@@NDPB    @NDPB            *1             S01166
     C*                                                                   S01166
     C********** XRMD      IFEQ 'M'                        B*2     S01166 S01194
     C           A6MDEX    IFEQ 'M'                        B*2            S01194
     C*                                                                   S01166
     C           @CBV      DIV  @CPV      @CORN     H      **2            S01166
     C           @NDPB     DOWGT0                          B**3           S01166
     C                     DIV  10        @CORN     H      ***3           S01166
     C                     SUB  1         @NDPB            ***3           S01166
     C                     END                             E**3           S01166
     C           @@CDP     DOWGT0                          B**3           S01166
     C                     MULT 10        @CORN            ***3           S01166
     C                     SUB  1         @@CDP            ***3           S01166
     C                     END                             E**3           S01166
     C*                                                                   S01166
     C                     ELSE                            X2             S01166
     C*                                                                   S01166
     C           @CPV      DIV  @CBV      @CORN     H      *2             S01166
     C           @@CDP     DOWGT0                          B**3           S01166
     C                     DIV  10        @CORN     H      ***3           S01166
     C                     SUB  1         @@CDP            ***3           S01166
     C                     END                             E**3           S01166
     C           @NDPB     DOWGT0                          B**3           S01166
     C                     MULT 10        @CORN            ***3           S01166
     C                     SUB  1         @NDPB            ***3           S01166
     C                     END                             E**3           S01166
     C*                                                                   S01166
     C                     END                             E2             S01166
     C* format for display                                                S01166
     C                     MOVE @CORN     @@RIN                           S01166
     C                     Z-ADD0         @PAD                            S01166
     C********** @PAD      DOWNESEXP                       B1      S01166 S01194
     C           @PAD      DOWNEA6SCEX                     B1             S01194
     C                     MULT 10        @@RIN            *1             S01166
     C                     ADD  1         @PAD             *1             S01166
     C                     END                             E1             S01166
     C                     EXSR ZA0880                                    S01166
     C*                                                                   S01166
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST   S01166
     C                     MOVEA@B        @COR                            S01166
     C*                                                                   S01166
     C                     ELSE                            X1             S01166
     C                     MOVEL'0.0'     @COR             *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C           #BB9      ENDSR                           *** TAG #BB9 **
     C*
     C****************************************************************
      /EJECT
     C****************************************************************
     C*
     C*  SUBROUTINE : #BC   - THIS ROUTINE MOVES THE CALCULATED
     C*                      VALUES TO THE DATA AREA DATA STRUCTURE
     C*
     C*  FIELDS INPUT : FOCCY  CURRENCY BEING PROCESSED
     C*                 @CPV   OPEN POSITION VALUE
     C*                 @CPS   OPEN POSITION SIGN
     C*                 @CBV   COR BCE VALUE
     C*                 @CBS   COR BCE SIGN
     C*                 @RRV   REVALUATION RATE
     C*                 @PLV   PROFIT/LOSS
     C*                 @PLS   PROFIT/LOSS SIGN
     C*
     C*  FIELDS USED : @VALUE  MULTIPLE OCCURENCE D.S. FOR VALUES
     C*                RRN     CCY NO. BEING PROCESSED                    S01166
     C*
     C*  FIELDS OUTPUT: @VAL1  VALUES FOR CCY 1 (IN AMENQ1AA)
     C*                   TO
     C*               : @VAL10 VALUES FOR CCY 10 (IN AMENQ1AA)
     C*
     C*  CALLED FROM : #B
     C*
     C****************************************************************
     C*
     C           #BC       BEGSR
     C*                                                                   S01166
     C**  CHECK COUNTER VALUE AND MOVE VALUES ACCORDINGLY
     C**  SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C*
     C           RRN       IFGE 1                                         S01166
     C           RRN       ANDLE15                                        S01166
     C*
     C           RRN       OCUR @VALUE                                    S01166
     C                     MOVE FOCCY     DDCCY                           S01166
     C                     MOVE @CPV11    DDCPV                           S01166
     C                     MOVE @COR      DDCOR                           S01166
     C                     MOVE @CBV11    DDCBV                           S01166
     C                     MOVE @RRV      DDRRV                           S01166
     C                     MOVE @PLV13    DDPLV                           S01166
     C*                                                                   S01166
     C**********           WRITEDL3150S1                           S01166 S01117
     C                     WRITETM3150S1                                  S01117
     C*                                                                   S01166
     C                     END                                            S01166
     C*
     C***        RRN       IFEQ 2                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        2         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL2            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 3                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        3         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL3            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 4                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        4         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL4            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 5                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        5         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL5            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 6                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        6         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL6            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 7                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        7         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL7            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 8                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        8         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL8            *1             S01166
     C***                  EXSR #BCA                                      S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 9                          B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        9         OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 10                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        10        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL10           *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 11                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        11        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 12                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        12        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 13                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        13        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 14                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        14        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C***        RRN       IFEQ 15                         B1             S01166
     C***                                                                 S01166
     C*** SET MULTIPLE OCCURENCE DATA STRUCTURE                           S01166
     C***        15        OCUR @VALUE                     *1             S01166
     C***                  MOVE @VALUE    @VAL9            *1             S01166
     C***                  END                             E1             S01166
     C***                                                                 S01166
     C*** Record 1st and last screen lines used.                          S01166
     C***        RRN       IFLT @LOC                                      S01166
     C***                  Z-ADDRRN       @LOC                            S01166
     C***                  END                                            S01166
     C***        RRN       IFGT @HIC                                      S01166
     C***                  Z-ADDRRN       @HIC                            S01166
     C***                  END                                            S01166
     C*                                                                   S01166
     C           #BC9      ENDSR                           ** #BC9 TAG **
     C****************************************************************
     C/EJECT                                                              S01166
     C****************************************************************    S01166
     C*                                                                   S01166
     C*  SUBROUTINE: #BD - OUTPUT TOTALS                                  S01166
     C*                                                                   S01166
     C*  CALLED BY : #B                                                   S01166
     C*                                                                   S01166
     C*  CALLS     :                                                      S01166
     C*                                                                   S01166
     C*  FIELDS USED :                                                    S01166
     C*  FIELDS OUTPUT :                                                  S01166
     C*                                                                   S01166
     C****************************************************************    S01166
     C           #BD       BEGSR                                          S01166
     C*                                                                   S01166
     C**  MUST DIVIDE TOTAL BY 1000                                       S01166
     C           @BDVT     DIV  1000      @BDVT     H                     S01166
     C                     Z-SUB@BDVT     @BDVT                           S01166
     C*                                                                   S01166
     C                     Z-ADD@@NDPB    @@CDP                           S01166
     C                     Z-ADD@BDVT     @@IAMT                          S01166
     C                     Z-ADD21        @@CRET  20                      S01166
     C                     EXSR ZA0750                                    S01166
     C                     MOVE @@ADSP    DDBDVT                          S01166
     C*                                                                   S01166
     C**  MUST CORRECT TOTAL P/L FOR OUTPUT                               S01166
     C           @PLT15    DIV  @DP,@P    @PLVT     H                     S01166
     C*                                                                   S01166
     C                     Z-ADD0         @@CDP                           S01166
     C                     Z-ADD@PLVT     @@IAMT                          S01166
     C                     Z-ADD21        @@CRET  20                      S01166
     C                     EXSR ZA0750                                    S01166
     C                     MOVE @@ADSP    DDPLVT                          S01166
     C*                                                                   S01166
     C           #BD9      ENDSR                                       ***S01166
     C/EJECT                                                              S01166
     C****************************************************************    S01277
     C*                                                                   S01277
     C*  SUBROUTINE: #DB  - THIS ROUTINE CALCULATES THE VARIOUS VALUES    S01277
     C*                     EG. P/L COR CCE FOR CROSS CURRENCY POSITIONS  S01277
     C*                                                                   S01277
     C*  FIELDS USED : @B     OUTPUT VALUE FROM ZA0880                    S01277
     C*                @CBS   COR BCE SIGN                                S01277
     C*                @CBV   COR BCE VALUE                               S01277
     C*                @CPS   OPEN POSITION SIGN                          S01277
     C*                @CPV   OPEN POSITION VALUE                         S01277
     C*                @DP    DECIMAL PLACES CORRECTION ARRAY             S01277
     C*                @F     INDEX FOR DECIMAL PLACES CORRECTION ARRAY   S01277
     C*                @P     BASE CCY DECIMAL PLACES - 1                 S01277
     C*                @PLV   PROFIT/LOSS (6,0)                           S01277
     C*                @PLV15 PROFIT/LOSS(9,0)  B'COS CAN HAVE UPTO 3 D.P.S01277
     C*                @PLT15 PROFIT/LOSS TOTAL (15,0)                    S01277
     C*                @RRV   REVALUATION RATE                            S01277
     C*                @RVBC  REVALUATION BCE NUMERIC                     S01277
     C*                @RVRT  REVALUATION RATE NUMERIC                    S01277
     C*                @WORK  WORK FIELD USED IN REV. RATE CALC.          S01277
     C*                @PRCDP DECIMAL PLACES FOR PRIMARY CCY              S01277
     C*                @@RIN  INPUT VALUE FOR ZA0880                      S01277
     C*                A6NBDP CURRENCY DECIMAL PLACES      PF/SDCURRPD    S01194
     C*                FOCCY  CURRENCY READ FROM FILE      S/FXEPOSLL     S01277
     C*                FOCTNP TOTAL NET POSITION           S/FXEPOSLL     S01277
     C*                FOCTEP BANK DEALT SPOT CCE          S/FXEPOSLL     S01277
     C*                A6HSRT HIGH SPOT RATE               PF/SDCURRPD    S01194
     C*                IDCYDL BASE CCY FOR DEALING                        S01277
     C*                A6LSPR LOW SPOT RATE                PF/SDCURRPD    S01194
     C*                A6MDEX EXCHANGE RATE MULT/DIV *IN   PF/SDCURRPD    S01194
     C*                A6SCEX SCALING EXPONENT             PF/SDCURRPD    S01194
     C*                                                                   S01277
     C*                                                                   S01277
     C*  FIELDS INPUT :                                                   S01277
     C*                                                                   S01277
     C*  CALLED BY : #D                                                   S01277
     C*                                                                   S01277
     C*  CALLS     :     ZA0880    VALUE FORMATTING                       S01277
     C*                  #BA       FILE DATA BASE ERROR                   S01277
     C*                                                                   S01277
     C****************************************************************    S01277
     C           #DB       BEGSR                                          S01277
     C*                                                                   S01277
     C                     MOVE FOCCY     @CYY                            S01277
      *                                                                   S01194
      * Call Access Object for Currency details                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @CYY    3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
      *                                                                   S01194
     C*                                                                   S01277
     C**  CROSS POSITION                                                  S01277
     C*   ~~~~~~~~~~~~~~                                                  S01277
     C                     Z-ADDFOCTNP    @CPV                            S01277
     C*                                                                   S01277
     C**  ADD SIGN                                                        S01277
     C                     Z-ADD@CPV      @@IAMT           *1             S01277
     C                     DIV  1000      @@IAMT    H      *1             S01277
     C                     Z-ADDA6NBDP    @@CDP   10       *1             S01194
     C                     Z-ADD21        @@CRET  20       *1             S01277
     C                     EXSR ZA0750                     *1             S01277
     C                     MOVE @@ADSP    @CPV11 11        *1             S01277
     C*                                                                   S01277
     C***IF CCY IS BASE CCY NO MORE PROCESSING IS REQUIRED                S01277
     C*****      FOCCY     IFEQ IDCYDL                     B1             S01277
     C*****                MOVE *BLANKS   @COR             *1             S01277
     C*****                MOVE *BLANKS   @CBV11           *1             S01277
     C*****                MOVE *BLANKS   @RRV             *1             S01277
     C*****                MOVE *BLANKS   @PLV13           *1             S01277
     C*****                GOTO #DB9                       *1             S01277
     C*****                END                             E1             S01277
     C*                                                                   S01277
     C**  CLOSE OUT RATE CROSS CURRENCY EQUIVALENT                        S01277
     C*   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                        S01277
     C*                                                                   S01277
     C**  USE BANK DEALT SPOT BCE (S/FXEPOSLL)                            S01277
     C                     Z-ADDFOCTEP    @CBV                            S01277
     C**  ADD SIGN (REVERSED)                                             S01277
     C                     Z-SUB@CBV      @CBV                            S01277
     C*                                                                   S01277
     C                     Z-ADD@CBV      @@IAMT           *1             S01277
     C                     DIV  1000      @@IAMT    H      *1             S01277
     C                     Z-ADD@PRCDP    @@CDP            *1             S01277
     C                     Z-ADD21        @@CRET  20       *1             S01277
     C                     EXSR ZA0750                     *1             S01277
     C                     MOVE @@ADSP    @CBV11 11        *1             S01277
     C*                                                                   S01277
     C**  FOR BOTH FORWARD AND BACKWARD READ MUST KEEP RUNNING TOTALS :   S01277
     C**  BANK DEALT SPOT CROSS CCY EQUIVALENT RUNNING TOTAL              S01277
     C                     ADD  FOCTEP    @BDVT                           S01277
     C*                                                                   S01277
     C**  REVALUATION RATE                                                S01277
     C*   ~~~~~~~~~~~~~~~~                                                S01277
     C*                                                                   S01277
     C**  IF CURRENCY POSITION IS ZERO, USE COR CCE                       S01277
     C**  (  FOCTEP  = - COR CCE     BUT MUST NOT REVERSE SIGN!! )        S01277
     C**  (  FOCTNP  =  CCY POSITION )        ~~~                         S01277
     C*                                                                   S01277
     C           FOCTNP    IFEQ 0                          B1             S01277
     C                     Z-ADDFOCTEP    @WORK            *1             S01277
     C*                                                                   S01277
     C**  ELSE USE CCY POSITION                                           S01277
     C                     ELSE                            X1             S01277
     C                     Z-ADDFOCTNP    @WORK            *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C****If secondary currency is base currency use rates          S01277S01277
     C****from file else calculate cross rates.                     S01277S01277
     C******                                                        S01277S01277
     C******     FOCCY     IFEQ IDCYDL                     B1       S01277S01277
     C******                                                        S01277S01277
     C******     XRMD      IFEQ 'M'                        B2       S01277S01277
     C******     @WORK     ANDLT0                          B2       S01277S01277
     C******                                                        S01277S01277
     C******     XRMD      OREQ 'D'                        B2       S01277S01277
     C******     @WORK     ANDGT0                          B2       S01277S01277
     C******                                                        S01277S01277
     C******               Z-ADDHGSP      @RVRT            *2       S01277S01277
     C******               ELSE                            X2       S01277S01277
     C******               Z-ADDLOSP      @RVRT            *2       S01277S01277
     C******               END                             E2       S01277S01277
     C******                                                        S01277S01277
     C******               ELSE                            X1       S01277S01277
     C*                                                                   S01277
     C                     EXSR #DBA                                      S01277
     C*                                                                   S01277
     C** #DBA always returns a divide rate from CCY1 to CCY2              S01277
     C** so further reference to Multiply/Divide indicator                S01277
     C** is not needed.                                                   S01277
     C*                                                                   S01277
     C           @WORK     IFGT 0                          B2             S01277
     C                     Z-ADD@@HRAT    @RVRT            *2             S01277
     C                     ELSE                            X2             S01277
     C                     Z-ADD@@LRAT    @RVRT            *2             S01277
     C                     END                             E2             S01277
     C*                                                                   S01277
     C******               END                             E1       S01277S01277
     C*                                                                   S01277
     C****FORMAT*RATE FOR PC (VIA DATA AREA)                        S01277S01277
     C**  FORMAT RATE (VIA DATA AREA @A/@@RIN)                      S01277S01277
     C                     MOVE @RVRT     @@RIN                           S01277
     C******               Z-ADD0         @PAD    10                S01277S01277
     C******     @PAD      DOWNESEXP                       B1       S01277S01277
     C******               MULT 10        @@RIN            *1       S01277S01277
     C******               ADD  1         @PAD             *1       S01277S01277
     C******               END                             E1       S01277S01277
     C                     EXSR ZA0880                                    S01277
     C*                                                                   S01277
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST   S01277
     C                     MOVEA@B        @RRV                            S01277
     C*                                                                   S01277
     C**  REVALUATION CROSS CURRENCY EQUIVALENT (USED BY P/L CALC.)       S01277
     C*   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                           S01277
     C**  (  FOCTNP  =  CCY POSITION )                                    S01277
     C*                                                                   S01277
     C**  IF CURRENCY POSITION IS ZERO, REV. CCE WILL BE ZERO             S01277
     C           FOCTNP    IFEQ 0                          B1             S01277
     C                     MOVE *ZEROS    @RVBC            *1             S01277
     C*                                                                   S01277
     C**  ELSE CALCULATE VALUE                                            S01277
     C                     ELSE                            X1             S01277
     C           A6NBDP    SUB  @PRCDP    @F      10       *1             S01194
     C                     ADD  4         @F               *1             S01277
     C           @F        IFLT 4                                         S01277
     C           FOCTNP    MULT @DP,@F    FOCTNP    H      *1             S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C** If secondary currency is base currency for dealing               S01277
     C** need to check Multiply/Divide indicator, but for                 S01277
     C** cross currency positions always divide because                   S01277
     C** #DBA always returns a divide rate from CCY1 to CCY2.             S01277
     C*                                                                   S01277
     C***********FOCCY*****IFEQ*IDCYDL*********************B*2******S01277S01319
     C           FOCCY     IFEQ BNCYDL                     B*2            S01319
     C*                                                                   S01277
     C           A6MDEX    IFEQ 'M'                        B**3           S01194
     C           FOCTNP    MULT @RVRT     @RVBC     H      ***3           S01277
     C                     ELSE                            X**3           S01277
     C           FOCTNP    DIV  @RVRT     @RVBC     H      ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     ELSE                            X*2            S01277
     C           FOCTNP    DIV  @RVRT     @RVBC     H      **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C           @F        IFLT 4                          B*2            S01277
     C           FOCTNP    MULT @DP,@F    FOCTNP    H      **2            S01277
     C                     END                             E*2            S01277
     C           @F        IFGT 4                          B*2            S01277
     C           @RVBC     MULT @DP,@F    @RVBC     H      **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C                     Z-ADD0         @PAD    10                      S01277
     C           @PAD      DOWNEA6SCEX                                    S01194
     C                     MULT 10        @RVRT                           S01277
     C                     ADD  1         @PAD                            S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C**  FORMAT RATE FOR PC (VIA DATA AREA)                              S01277
     C                     MOVE @RVRT     @@RIN                           S01277
     C                     EXSR ZA0880                                    S01277
     C*                                                                   S01277
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST   S01277
     C                     MOVEA@B        @RRV                            S01277
     C*                                                                   S01277
     C**  PROFIT/LOSS                                                     S01277
     C*   ~~~~~~~~~~~                                                     S01277
     C*                                                                   S01277
     C**  (  FOCTEP  = - COR CCE )                                        S01277
     C**  THIS MAY SEEM BACK-TO-FRONT BUT BECAUSE THE SIGNS OF BOTH       S01277
     C**  THE FIELDS HAVE NOT BEEN REVERSED IT IS CORRECT      ~~~~       S01277
     C           @RVBC     SUB  FOCTEP    @PLV15 150                      S01277
     C*                                                                   S01277
     C**  IF PRIMARY CURRENCY HAS ZERO DECIMAL POINT, DIVIDE P/L FIGURE   S01277
     C**  BY 1000 TO AVOID OVERFLOW OF SIGNIFICANT FIGURE IN P/L.         S01277
     C*                                                                   S01277
     C           @PRCDP    IFEQ 0                          B1             S01277
     C           @PLV15    DIV  1000      @PLV15    H      *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  Position table on number of decimal places for primary ccy.     S01277
     C*                                                                   S01277
     C           4         SUB  @PRCDP    @Q      10                      S01277
     C*                                                                   S01277
     C**  MUST CONVERT THIS TO UNITS                                      S01277
     C           @PLV15    DIV  @DP,@Q    @PLV      H                     S01277
     C*                                                                   S01277
     C**  FOR BOTH FORWARD AND BACKWARD READ MUST KEEP RUNNING TOTALS :   S01277
     C**  PROFIT AND LOSS                                                 S01277
     C                     ADD  @PLV15    @PLT15 150                      S01277
     C*                                                                   S01277
     C**  ADD SIGN                                                        S01277
     C                     Z-ADD0         @@CDP            *1             S01277
     C                     Z-ADD@PLV      @@IAMT           *1             S01277
     C                     Z-ADD21        @@CRET  20       *1             S01277
     C                     EXSR ZA0750                     *1             S01277
     C                     MOVE @@ADSP    @PLV13 13        *1             S01277
     C*                                                                   S01277
     C*   CALCULATE COR                                                   S01277
     C*   ~~~~~~~~~~~~~                                                   S01277
     C*     need to adjust according to ccy dec places @@CDP              S01277
     C*                     and Primary ccy dec places @PRCDP             S01277
     C*                                                                   S01277
     C                     Z-ADD0         @CORN  138                      S01277
     C*                                                                   S01277
     C           @CPV      IFNE 0                          B1             S01277
     C           @CBV      ANDNE0                          B1             S01277
     C                     Z-ADDA6NBDP    @@CDP            *1             S01194
     C                     Z-ADD@PRCDP    @NDPB            *1             S01277
     C*                                                                   S01277
     C** If secondary currency is base currency for dealing               S01277
     C** need to check Multiply/Divide indicator, but for                 S01277
     C** cross currency positions always divide because                   S01277
     C** #DBA always returns a divide rate from CCY1 to CCY2.             S01277
     C*                                                                   S01277
     C***********FOCCY*****IFEQ*IDCYDL*********************B*2******S01277S01319
     C           FOCCY     IFEQ BNCYDL                     B*2            S01319
     C*                                                                   S01277
     C           A6MDEX    IFEQ 'M'                        B**3           S01194
     C*                                                                   S01277
     C           @CBV      DIV  @CPV      @CORN     H      ***3           S01277
     C           @NDPB     DOWGT0                          B***4          S01277
     C                     DIV  10        @CORN     H      ****4          S01277
     C                     SUB  1         @NDPB            ****4          S01277
     C                     END                             E***4          S01277
     C           @@CDP     DOWGT0                          B***4          S01277
     C                     MULT 10        @CORN            ****4          S01277
     C                     SUB  1         @@CDP            ****4          S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C                     ELSE                            X**3           S01277
     C*                                                                   S01277
     C           @CPV      DIV  @CBV      @CORN     H      ***3           S01277
     C           @@CDP     DOWGT0                          B***4          S01277
     C                     DIV  10        @CORN     H      ****4          S01277
     C                     SUB  1         @@CDP            ****4          S01277
     C                     END                             E***4          S01277
     C           @NDPB     DOWGT0                          B***4          S01277
     C                     MULT 10        @CORN            ****4          S01277
     C                     SUB  1         @NDPB            ****4          S01277
     C                     END                             E***4          S01277
     C*                                                                   S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     ELSE                            X*2            S01277
     C*                                                                   S01277
     C           @CPV      DIV  @CBV      @CORN     H      **2            S01277
     C           @@CDP     DOWGT0                          B**3           S01277
     C                     DIV  10        @CORN     H      ***3           S01277
     C                     SUB  1         @@CDP            ***3           S01277
     C                     END                             E**3           S01277
     C           @NDPB     DOWGT0                          B**3           S01277
     C                     MULT 10        @CORN            ***3           S01277
     C                     SUB  1         @NDPB            ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C* format for display                                                S01277
     C                     MOVE @CORN     @@RIN                           S01277
     C                     Z-ADD0         @PAD                            S01277
     C           @PAD      DOWNEA6SCEX                     B*2            S01194
     C                     MULT 10        @@RIN            **2            S01277
     C                     ADD  1         @PAD             **2            S01277
     C                     END                             E*2            S01277
     C                     EXSR ZA0880                                    S01277
     C*                                                                   S01277
     C**  NOTE: MOVEA IS 'EQUIVALENT' TO MOVEL SO RIGHTMOST NO. IS LOST   S01277
     C                     MOVEA@B        @COR                            S01277
     C*                                                                   S01277
     C                     ELSE                            X1             S01277
     C                     MOVEL'0.0'     @COR             *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           #DB9      ENDSR                           *** TAG #DB9 **S01277
     C*                                                                   S01277
     C****************************************************************    S01277
     C/EJECT                                                              S01277
     C*****************************************************************   S01277
     C*                                                               *   S01277
     C*  SUBROUTINE: #DBA -  Cross exchange rate enquiry              *   S01277
     C*                                                               *   S01277
     C*                                                               *   S01277
     C*  FIELDS USED:  Input  -- CPPCCY    )    Input                 *   S01277
     C*                       -- CPSCCY    )      currencies          *   S01277
     C*                                                               *   S01277
     C*  CALLED BY : #DB                                              *   S01277
     C*  CALLS     : #DBAA                                            *   S01277
     C*                                                               *   S01277
     C*****************************************************************   S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C           #DBA      BEGSR                                          S01277
     C**                                                                  S01277
     C***  Access spot days and spot dates for the two currencies         S01277
     C**                                                                  S01277
     C                     MOVELCPPCCY    @CYY    3                       S01277
      *                                                                   S01194
      * Call Access Object for Currency details                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @CYY    3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C**                                                                  S01277
     C                     MOVELCPPCCY    @@CCY1                          S01277
     C                     Z-ADDA6FXSD    @@SPD1                          S01194
     C                     Z-ADDA6SPDY    @@WSP1                          S01194
     C                     Z-ADDA6HSRT    @HISP1                          S01194
     C                     Z-ADDA6LSPR    @LOSP1                          S01194
     C                     Z-ADDA6DPBF    @DPBF1                          S01194
     C                     Z-ADDA6NBDP    @CDP1                           S01194
     C                     Z-ADDA6NQDP    @NQDP1                          S01194
     C                     MOVELA6MDEX    @XRMD1                          S01194
     C*                                                                   S01277
     C**  move scale exponent to work field                               S01277
     C                     Z-ADDA6SCEX    @SCXP1  10                      S01194
     C***                                                                 S01277
     C                     MOVELCPSCCY    @CYY                            S01277
      *                                                                   S01194
      * Call Access Object for Currency details                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @CYY    3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C**                                                                  S01277
     C                     MOVELCPSCCY    @@CCY2                          S01277
     C                     Z-ADDA6FXSD    @@SPD2                          S01194
     C                     Z-ADDA6SPDY    @@WSP2                          S01194
     C                     Z-ADDA6HSRT    @HISP2                          S01194
     C                     Z-ADDA6LSPR    @LOSP2                          S01194
     C                     Z-ADDA6DPBF    @DPBF2                          S01194
     C                     Z-ADDA6NBDP    @CDP2                           S01194
     C                     Z-ADDA6NQDP    @NQDP2                          S01194
     C                     MOVELA6MDEX    @XRMD2                          S01194
     C*                                                                   S01277
     C**  move scale exponent to work field                               S01277
     C                     Z-ADDA6SCEX    @SCXP2  10                      S01194
     C*                                                                   S01277
     C** If secondary ccy is base ccy for dealing, rates are obtained     S01277
     C** directly from record for primary ccy                             S01277
     C***********CPSCCY****IFEQ*IDCYDL*********************B1*******S01277S01319
     C           CPSCCY    IFEQ BNCYDL                     B1             S01319
     C*                                                                   S01277
     C** Scale high rate                                                  S01277
     C                     Z-ADD@SCXP1    @@SXP2           *1             S01277
     C                     Z-ADD@SCXP2    @@SXP1           *1             S01277
     C                     MOVE @XRMD1    @@FCMD           *1             S01277
     C                     Z-ADD@HISP1    @@INRT           *1             S01277
     C                     EXSR ZA1150                     *1             S01277
     C*                                                                   S01277
     C** This routine always returns a divide rate so...                  S01277
     C** If primary ccy is a multiply rate                                S01277
     C           @XRMD1    IFEQ 'M'                        B*2            S01277
     C                     Z-ADD@@SCRT    @@HRAT           **2            S01277
     C                     ELSE                            X*2            S01277
     C** else make this the 'low' rate                                    S01277
     C                     Z-ADD@@SCRT    @@LRAT           **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** Scale low rate                                                   S01277
     C                     Z-ADD@LOSP1    @@INRT           *1             S01277
     C                     EXSR ZA1150                     *1             S01277
     C*                                                                   S01277
     C** This routine always returns a divide rate so...                  S01277
     C** If primary ccy is a multiply rate                                S01277
     C           @XRMD1    IFEQ 'M'                        B*2            S01277
     C                     Z-ADD@@SCRT    @@LRAT           **2            S01277
     C                     ELSE                            X*2            S01277
     C** else make this the 'high' rate                                   S01277
     C                     Z-ADD@@SCRT    @@HRAT           **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** Else continue with the processing                                S01277
     C                     ELSE                            X1             S01277
     C**                                                                  S01277
     C***  Calculate mutual spot day                                      S01277
     C**                                                                  S01277
     C                     EXSR ZA0820                                    S01277
     C                     Z-ADD@@VDT     @@SPDD                          S01277
     C**                                                                  S01277
     C***  Calculate two cross rates for spot date                        S01277
     C**                                                                  S01277
     C                     EXSR #DBAA                                     S01277
     C**                                                                  S01277
     C***  Decide if first rate is low (left column) or high (right)      S01277
     C**                                                                  S01277
     C           @XR1      IFLT @XR2                       B1             S01277
     C                     Z-ADD@XR1      @@LRAT 138       *1             S01277
     C                     Z-ADD@XR2      @@HRAT 138       *1             S01277
     C                     ELSE                            X1             S01277
     C                     Z-ADD@XR2      @@LRAT           *1             S01277
     C                     Z-ADD@XR1      @@HRAT           *1             S01277
     C                     END                             E1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           #DBA9     ENDSR                           **#DBA9*       S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C*****************************************************************   S01277
     C*                                                               *   S01277
     C*  SUBROUTINE: #DBAA  - Calculate two cross rates for a date    *   S01277
     C*                                                               *   S01277
     C*                                                               *   S01277
     C*  FIELDS USED:  CPPCCY  -- First Currency                      *   S01277
     C*                CPSCCY  -- Second Currency                     *   S01277
     C*                @@VDT   -- Value Date                          *   S01277
     C*                @HISP1/2  -- First/second High Spots           *   S01277
     C*                @LOSP1/2  -- First/second Low Spots            *   S01277
     C*                @XRMD1/2  -- First/second Multiply/divides     *   S01277
     C*                @NQDP1/2  -- First/second Normal Quote Dec.Pl. *   S01277
     C*                                                               *   S01277
     C*                                                               *   S01277
     C*     OUTPUT:    @XR1    -- First Cross Rate                    *   S01277
     C*                @XR2    -- Second Cross Rate                   *   S01277
     C*                @XM1    -- First Multiply/Divide Indicator     *   S01277
     C*                @XM2    -- Second Multiply/Divide Indicator    *   S01277
     C*                                                               *   S01277
     C*  CALLED BY : #DBA                                             *   S01277
     C*  CALLS     : ZA0630                                           *   S01277
     C*              ZA0900                                           *   S01277
     C*              ZA1150     - Convert rate to scaled rate         *   S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C*****************************************************************   S01277
     C*                                                                   S01277
     C           #DBAA     BEGSR                                          S01277
     C*                                                                   S01277
     C**                                                                  S01277
     C***   Calculate forward outright rates on each line                 S01277
     C**        Each line has a buy and sell for each currency            S01277
     C**           Currency 1, Buy rate, is @RBC1                         S01277
     C**           Currency 1, Sell rate, is @RSC1                        S01277
     C**           Currency 2, Buy rate, is @RBC2                         S01277
     C**           Currency 2, Sell rate, is @RSC2                        S01277
     C**                                                                  S01277
     C                     MOVELCPPCCY    @@CCY            *1             S01277
     C                     Z-ADD@HISP1    A6HSRT           *1             S01194
     C                     Z-ADD@LOSP1    A6LSPR           *1             S01194
     C                     MOVEL@XRMD1    A6MDEX           *1             S01194
     C                     MOVEL@NQDP1    A6NQDP           *1             S01194
     C                     Z-ADD@@SPD1    A6FXSD           *1             S01194
     C*                                                                   S01277
     C** MOVE FIRST CURRENCY SCALING TO WORK FIELD                        S01277
     C                     Z-ADD@SCXP1    @@SXP1           *1             S01277
     C**                                                                  S01277
     C                     MOVE 'B'       @@BYSL           *1             S01277
     C                     EXSR ZA0630                     *1             S01277
     C*                                                                   S01277
     C** If database error branch to end of subroutine                    S01277
     C           *INU7     CABEQ'1'       #DBAA9                          S01277
     C*                                                                   S01277
     C                     Z-ADD@@MOR     @RBC1  138       *1             S01277
     C**                                                                  S01277
     C                     MOVE 'S'       @@BYSL           *1             S01277
     C                     EXSR ZA0630                     *1             S01277
     C*                                                                   S01277
     C** If database error branch to end of subroutine                    S01277
     C           *INU7     CABEQ'1'       #DBAA9                          S01277
     C*                                                                   S01277
     C                     Z-ADD@@MOR     @RSC1  138       *1             S01277
     C**                                                                  S01277
     C                     MOVELCPSCCY    @@CCY   3        *1             S01194
     C                     Z-ADD@HISP2    A6HSRT           *1             S01194
     C                     Z-ADD@LOSP2    A6LSPR           *1             S01194
     C                     MOVEL@XRMD2    A6MDEX           *1             S01194
     C                     MOVEL@NQDP2    A6NQDP           *1             S01194
     C                     Z-ADD@@SPD2    A6FXSD           *1             S01194
     C*                                                                   S01277
     C** MOVE SECOND CURRENCY SCALING TO WORK FIELD                       S01277
     C                     Z-ADD@SCXP2    @@SXP1           *1             S01277
     C**                                                                  S01277
     C                     MOVE 'B'       @@BYSL           *1             S01277
     C                     EXSR ZA0630                     *1             S01277
     C*                                                                   S01277
     C** If database error branch to end of subroutine                    S01277
     C           *INU7     CABEQ'1'       #DBAA9                          S01277
     C*                                                                   S01277
     C                     Z-ADD@@MOR     @RBC2  138       *1             S01277
     C**                                                                  S01277
     C                     MOVE 'S'       @@BYSL           *1             S01277
     C                     EXSR ZA0630                     *1             S01277
     C*                                                                   S01277
     C** If database error branch to end of subroutine                    S01277
     C           *INU7     CABEQ'1'       #DBAA9                          S01277
     C*                                                                   S01277
     C                     Z-ADD@@MOR     @RSC2  138       *1             S01277
     C**                                                                  S01277
     C****   Calculate two cross rates                                    S01277
     C**                                                                  S01277
     C                     Z-ADD@RBC1     @@RAT1           *1             S01277
     C                     Z-ADD@RSC2     @@RAT2           *1             S01277
     C                     MOVEL@XRMD1    @@MDI1           *1             S01277
     C                     MOVEL@XRMD2    @@MDI2           *1             S01277
     C                     EXSR ZA0900                     *1             S01277
     C                     Z-ADD@@CSRT    @XR1             *1             S01277
     C                     MOVEL@@FCMD    @XM1    1        *1             S01277
     C**                                                                  S01277
     C                     Z-ADD@RSC1     @@RAT1 138       *1             S01277
     C                     Z-ADD@RBC2     @@RAT2 138       *1             S01277
     C                     MOVEL@XRMD1    @@MDI1           *1             S01277
     C                     MOVEL@XRMD2    @@MDI2           *1             S01277
     C                     EXSR ZA0900                     *1             S01277
     C                     Z-ADD@@CSRT    @XR2             *1             S01277
     C                     MOVEL@@FCMD    @XM2    1        *1             S01277
     C*                                                                   S01277
     C**                                                                  S01277
     C**    Convert CROSS rate to scale rate                              S01277
     C                     Z-ADD@SCXP1    @@SXP1  10                      S01277
     C                     Z-ADD@SCXP2    @@SXP2  10                      S01277
     C                     Z-ADD@XR1      @@INRT                          S01277
     C                     MOVE 'M'       @@FCMD                          S01277
     C                     EXSR ZA1150                                    S01277
     C*                                                                   S01277
     C**    MOVE SCALE RATED                                              S01277
     C                     Z-ADD@@SCRT    @XR1                            S01277
     C*                                                                   S01277
     C** STORE OUTPUT FIELDS FROM ZA1150 TO WORK FIELD FOR FIRST CCY      S01277
     C                     Z-ADD@@ISRT    @ISRT1                          S01277
     C                     Z-ADD@@ERCD    @ERCD1                          S01277
     C*                                                                   S01277
     C**  Convert CROSS rate to scale rate                                S01277
     C                     Z-ADD@XR2      @@INRT                          S01277
     C                     EXSR ZA1150                                    S01277
     C*                                                                   S01277
     C** STORE OUTPUT FIELDS FROM ZA1150 TO WORK FIELD FOR SECOND CCY     S01277
     C                     Z-ADD@@ISRT    @ISRT2                          S01277
     C                     Z-ADD@@ERCD    @ERCD2                          S01277
     C*                                                                   S01277
     C**    MOVE SCALE RATED                                              S01277
     C                     Z-ADD@@SCRT    @XR2                            S01277
     C*                                                                   S01277
     C**  CHECK  IF RETURN CODE1 ='1'  OR RETURN CODE2 = '1'              S01277
     C**         USE INVERSE OF SCALE RATE FOR BOTH CROSS RATES           S01277
     C           @ERCD1    IFEQ 1                          B1             S01277
     C           @ERCD2    OREQ 1                          B1             S01277
     C                     Z-ADD@ISRT1    @XR1             *1             S01277
     C                     Z-ADD@ISRT2    @XR2             *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  CHECK  IF RETURN CODE ='3' USE 99999.99999999                   S01277
     C           @ERCD1    IFEQ 3                          B1             S01277
     C           @ERCD2    OREQ 3                          B1             S01277
     C                     Z-ADD@IN,1     @XR1             *1             S01277
     C                     Z-ADD@IN,1     @XR2             *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C                     GOTO #DBAA9                                    S01277
     C*                                                                   S01277
     C** DEFINE WORK FIELDS                                               S01277
     C           *LIKE     DEFN @@ISRT    @ISRT1                          S01277
     C           *LIKE     DEFN @@ERCD    @ERCD1                          S01277
     C           *LIKE     DEFN @@ISRT    @ISRT2                          S01277
     C           *LIKE     DEFN @@ERCD    @ERCD2                          S01277
     C*                                                                   S01277
     C           #DBAA9    ENDSR                           **#DBAA9*      S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C*  SUBROUTINE: #DD - OUTPUT CROSS CURRENCY TOTALS                   S01277
     C*                                                                   S01277
     C*  CALLED BY : #D                                                   S01277
     C*                                                                   S01277
     C*  CALLS     :                                                      S01277
     C*                                                                   S01277
     C*  FIELDS USED :                                                    S01277
     C*  FIELDS OUTPUT :                                                  S01277
     C*                                                                   S01277
     C****************************************************************    S01277
     C           #DD       BEGSR                                          S01277
     C*                                                                   S01277
     C**  MUST DIVIDE TOTAL BY 1000                                       S01277
     C           @BDVT     DIV  1000      @BDVT     H                     S01277
     C                     Z-SUB@BDVT     @BDVT                           S01277
     C*                                                                   S01277
     C                     Z-ADD@PRCDP    @@CDP                           S01277
     C                     Z-ADD@BDVT     @@IAMT                          S01277
     C                     Z-ADD21        @@CRET  20                      S01277
     C                     EXSR ZA0750                                    S01277
     C                     MOVE @@ADSP    DDBDVT                          S01277
     C*                                                                   S01277
     C**  MUST CORRECT TOTAL P/L FOR OUTPUT                               S01277
     C           4         SUB  @PRCDP    @Q      10                      S01277
     C*                                                                   S01277
     C           @PLT15    DIV  @DP,@Q    @PLVT     H                     S01277
     C*                                                                   S01277
     C                     Z-ADD0         @@CDP                           S01277
     C                     Z-ADD@PLVT     @@IAMT                          S01277
     C                     Z-ADD21        @@CRET  20                      S01277
     C                     EXSR ZA0750                                    S01277
     C                     MOVE @@ADSP    DDPLVT                          S01277
     C*                                                                   S01277
     C           #DD9      ENDSR                                       ***S01277
      /EJECT                                                              S01166
     C****************************************************************    S01166
     C*                                                              *    S01166
     C*                                                              *    S01166
     C*     MIDAS/DRS - STANDING DATA MODULE                         *    S01166
     C*                                                              *    S01166
     C*     ZA0750 -  CONVERT AMOUNT TO DISPLAY -38                  *    S01166
     C*                                                              *    S01166
     C*                                                              *    S01166
     C*       CALLS:                                                 *    S01166
     C*                                                              *    S01166
     C*       INPUT: @@IAMT 15,0 (INPUT AMOUNT)                      *    S01166
     C*              @@CCY  3A   (INPUT CURRENCY)                    *    S01166
     C*              @@CRET 2,0  (NUMBER OF CHARACTERS TO RETURN)    *    S01166
     C*              @@CDP  1,0  (CURRENCY DECIMAL PLACES)           *    S01166
     C*                                                              *    S01166
     C*      OUTPUT: @@ADSP 21A    (AMOUNT TO DISPLAY)               *    S01166
     C*                                                              *    S01166
     C*        USES:                                                 *    S01166
     C*                                                              *    S01166
     C****************************************************************    S01166
     C*                                                                   S01166
     C           ZA0750    BEGSR                                          S01166
     C*                                                                   S01166
     C*******    @@CDP     DOWGT0                                  S01166 078522
     C*******              DIV  10        @@IAMT    H              S01166 078522
     C*******              SUB  1         @@CDP                    S01166 078522
     C*******              END                                     S01166 078522
     C*                                                                   078522
     C           @@CDP     IFEQ 1                                         078522
     C                     DIV  10        @@IAMT    H                     078522
     C                     ELSE                                           078522
     C           @@CDP     IFEQ 2                                         078522
     C                     DIV  100       @@IAMT    H                     078522
     C                     ELSE                                           078522
     C           @@CDP     IFEQ 3                                         078522
     C                     DIV  1000      @@IAMT    H                     078522
     C                     END                                            078522
     C                     END                                            078522
     C                     END                                            078522
     C                     Z-ADD0         @@CDP                           078522
     C*                                                                   S01166
     C*          INITIALISE ARRAYS                                        S01166
     C*                                                                   S01166
     C                     MOVEA*BLANKS   @E                              S01166
     C                     MOVEA*BLANKS   @C                              S01166
     C*                                                                   S01166
     C*          MOVE SIGN TO DISPLAY AMOUNT                              S01166
     C*                                                                   S01166
     C           @@IAMT    IFGT 0                          B1             S01166
     C                     MOVE '+'       @E,21            *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C*          AFTER '-' SIGN PLACED IN  @E CHANGE @@IAMT TO +VE        S01166
     C*                                                                   S01166
     C           @@IAMT    IFLT 0                          B1             S01166
     C                     MOVE '-'       @E,21            *1             S01166
     C                     Z-SUB@@IAMT    @@IAMT           *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C           @@IAMT    IFEQ 0                          B1             S01166
     C                     MOVE ' '       @E,21            *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C*          MOVE INPUT AMOUNT TO @D                                  S01166
     C*                                                                   S01166
     C                     MOVEA@@AMDS    @D                              S01166
     C*                                                                   S01166
     C*          MOVE DECIMAL PORTION OF AMOUNT TO @E                     S01166
     C*                                                                   S01166
     C                     Z-ADD15        @@C     20                      S01166
     C                     Z-ADD20        @@D     20                      S01166
     C*                                                                   S01166
     C           20        SUB  @@CDP     @@MAX   20                      S01166
     C           @@D       DOWGT@@MAX                      B1             S01166
     C                     MOVE @D,@@C    @E,@@D           *1             S01166
     C                     SUB  1         @@C              *1             S01166
     C                     SUB  1         @@D              *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C*          MOVE DECIMAL SEPARATOR TO @E                             S01166
     C*                                                                   S01166
     C           @@CDP     IFNE 0                          B1             S01166
     C*********************MOVE*IDDCSP****@E,@@D************1*******S01166S01319
     C                     MOVE BNDCSP    @E,@@D           *1             S01319
     C                     SUB  1         @@D              *1             S01166
     C                     END                             E1             S01166
      * IF AMOUNT IS ZERO THEN MOVE A ZERO AND EXIT                       FE0141
     C           @@IAMT    IFEQ 0                          B1             FE0141
     C                     MOVE '0'       @E,@@D           *1             FE0141
     C                     GOTO ZA0755                     *1             FE0141
     C                     END                             E1             FE0141
     C*                                                                   S01166
     C*          FIND POSITION OF LAST CHARACTER TO BE MOVED              S01166
     C*                                                                   S01166
     C                     Z-ADD1         @@E     20                      S01166
     C*                                                                   S01166
     C           @@E       DOWLT@@MAX                      B1             S01166
     C           @D,@@E    ANDEQ'0'                        *1             S01166
     C                     ADD  1         @@E              *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C*          MOVE INTEGER PORTION OF AMOUNT TO @E                     S01166
     C*                                                                   S01166
     C*                    Z-ADD0         @@CNT1  20                      S01166
     C*                    Z-ADD0         @@CNT2  20                      S01166
     C*                                                                   S01166
     C           @@C       DOWGT@@E                        B1             S01166
     C                     MOVE @D,@@C    @E,@@D           *1             S01166
     C*                    ADD  1         @@CNT1           *1             S01166
     C                     SUB  1         @@C              *1             S01166
     C                     SUB  1         @@D              *1             S01166
     C*                                                                   S01166
     C*          INSERT THOUSAND SEPARATORS                               S01166
     C*                                                                   S01166
     C*          @@CNT1    DIV  3         @@RES   20       *1             S01166
     C*                    MVR            @@REMD  10       *1             S01166
     C***        @@REMD    IFEQ 0                          B*2            S01166
     C***        @@CNT2    ANDLT5                          **2            S01166
     C***                  MOVE IDTHSP    @E,@@D           **2            S01166
     C***                  ADD  1         @@CNT2           **2            S01166
     C***                  Z-ADD@@D       @@F     20       **2            S01166
     C***                  SUB  1         @@D              **2            S01166
     C***                  END                             E*2            S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C*          MOVE LAST CHARACTER                                      S01166
     C*                                                                   S01166
     C                     MOVE @D,@@C    @E,@@D                          S01166
     C*                                                                   S01166
     C*          IF NUMBER OF CHARACTERS MOVED IS GREATER THAN NUMBER     S01166
     C*        TO BE RETURNED DROP THOUSAND SEPARATORS TILL SATISFIED     S01166
     C*                                                                   S01166
     C***        22        SUB  @@D       @@CMOV  20                      S01166
     C***        @@CMOV    SUB  @@CRET    @@DIFF  20                      S01166
     C***        @@DIFF    IFGT 0                          B1             S01166
     C***                  DO   @@DIFF                     B*2            S01166
     C***                  Z-ADD1         @@G     20       **2            S01166
     C***                  Z-ADD2         @@H     20       **2            S01166
     C***        @@G       DOWLE21                         B**3           S01166
     C***                  MOVE @E,@@G    @C,@@H           ***3           S01166
     C***                  ADD  1         @@G              ***3           S01166
     C***                  ADD  1         @@H              ***3           S01166
     C***        @@G       IFEQ @@F                        B***4          S01166
     C***                  ADD  1         @@G              ****4          S01166
     C***                  END                             E***4          S01166
     C***                  END                             E**3           S01166
     C***                  MOVEA@C        @E               **2            S01166
     C***                  ADD  4         @@F              **2            S01166
     C***                  END                             E*2            S01166
     C***                  END                             E1             S01166
     C           ZA0755    TAG                                            S01166
     C*                                                                   S01166
     C*          MOVE @E TO DISPLAY FIELD                                 S01166
     C*                                                                   S01166
     C                     MOVEA@E        @@ADSP 21                       S01166
     C           ZA0759    ENDSR                                          S01166
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE ZA0880 - CONVERT SHORT RATE TO DISPLAY            *
     C*                                                               *
     C*                      THIS SUBROUTINE RECEIVES A 13/8 INPUT    *
     C*                      RATE @@RIN & OUTPUTS A 8A RATE WITH      *
     C*                      DECIMAL SEPERATOR @B                     *
     C*                                                               *
     C*  CALLED BY   : #BB                                            *
     C*                                                               *
     C*  INPUT       : @A     - INPUT RATE ARRAY  (13A)               *
     C*  OUTPUT      : @B     - OUTPUT RATE ARRAY (8A)                *
     C*                                                               *
     C*  WORK FIELDS : @@1    - ARRAY INDEX FOR @@C1 (2,0)            *
     C*              : @@B    - ARRAY INDEX FOR @@C2 (1,0)            *
     C*                                                               *
     C*   INDICATOR  :  82    - LOOKUP ARRAY                          *
     C*                                                               *
     C*****************************************************************
     C*
     C           ZA0880    BEGSR
     C*
     C**  LOKUP FOR FIRST NON-ZERO ELEMENT.
     C                     Z-ADD1         @@1     20
     C           *ZERO     LOKUP@A,@@1               82
     C*
     C**  IF NON-ZERO ELEMENT FOUND AFTER POSITION 5 RESET INDEX TO 5
     C           @@1       IFGT 5                          B1
     C                     Z-ADD5         @@1              *1
     C                     END                             E1
     C*
     C**  RESET INDEX TO OUTPUT RATE ARRAY
     C                     Z-ADD*ZERO     @@B     10
     C*
     C**  LOAD 8 POSITION OUTPUT ARRAY
     C           @@B       DOUEQ8                          B1
     C*
     C**  INCREMENT INDEX AND MOVE INPUT ELEMENT TO OUTPUT RATE ARRAY
     C                     ADD  1         @@B              *1
     C                     MOVE @A,@@1    @B,@@B           *1
     C*
     C**  IF INDEX TO INPUT RATE ARRAY = 5 MOVE DEC. SEP. TO OUTPUT
     C**  ARRAY AND SETON INDICATOR TO STOP THIS BEING REPEATED.
     C           @@1       IFEQ 5                          B*2
     C*
     C                     ADD  1         @@B              **2
     C*********************MOVE*IDDCSP****@B,@@B*************2************S01319
     C                     MOVE BNDCSP    @B,@@B           **2            S01319
     C           @@B       ADD  1         @@CHK   10       **2
     C                     END                             E*2
     C*
     C                     ADD  1         @@1              *1
     C*
     C                     END                             E1
     C*
     C** Coding to remove trailing zeros from rates
     C           @B,@@B    DOWEQ'0'                        B1
     C           @@B       ANDNE@@CHK                      B1
     C                     MOVE *BLANK    @B,@@B           *1
     C                     SUB  1         @@B              *1
     C                     END                             E1
     C*
     C           ZA0889    ENDSR                           ***ZA0889***
     C****************************************************************
     C/EJECT                                                              S01277
     C*****************************************************************   S01277
     C*                                                               *   S01277
     C*       TITLE:DETERMINE SPOT DATE.      .                       *   S01277
     C*                                                               *   S01277
     C* INPUT  :@@CCY1 CURRENCY-1.                        -FORMAT(3A) *   S01277
     C*         @@CCY2 CURRENCY-2.                        -FORMAT(3A) *   S01277
     C*         @@WSP1 SPOT DAYS CURRENCY-1               -FORMAT(3N) *   S01277
     C*         @@WSP2 SPOT DAYS CURRENCY-2               -FORMAT(3N) *   S01277
     C*         @@SPD1 SPOT DATE FOR CURRENCY-1           -FORMAT(8N) *   S01277
     C*         @@SPD2 SPOT DATE FOR CURRENCY-2           -FORMAT(8N) *   S01277
     C**********IDCYDL*BASE*CURRENCY*FOR*DEALING**********-FORMAT(3AS01277S01319
     C*         BNCYDL BASE CURRENCY FOR DEALING          -FORMAT(3A) *   S01319
     C*                                                               *   S01277
     C* OUTPUT :@@VDT  DATE (YYYYMMDD)                    -FORMAT(8N) *   S01277
     C*                                                               *   S01277
     C* USES :   @@DAYN MIDAS DAY NO USED BY SR ZA0710                *   S01277
     C*          @@MNO  MIDAS DAY NO                                      S01195
     C*          @@CDYN CALCULATED SPOT DATE DAY NO.                  *   S01277
     C*          @@SPDY NO. OF SPOT DAYS REQUIRED.                    *   S01277
     C*          @@WDAD NO. OF WORKING DAYS ADDED TO CURRENT DAY NO.  *   S01277
     C*                                                              *    S01277
     C* CALLED BY:  #DBA                                             *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C* CALLS:      ZCHKH                                            *    S01195
     C*             ZA0710                                           *    S01277
     C*                                                               *   S01277
     C*     AMEND NO. 000001                  DATE   14/07/86        *    S01277
     C*       Amendment to calculate Spot Date on the basis of only  *    S01277
     C*       mutual working days.                                   *    S01277
     C*                                                              *    S01277
     C*****************************************************************   S01277
     C*                                                               *   S01277
     C           ZA0820    BEGSR                                          S01277
     C*                                                                   S01277
     C**  DEFINE AND INITIALISE FIELDS USED IN THIS ROUTINE.              S01277
     C                     Z-ADD0         @@CDYN  50                      S01277
     C                     Z-ADD0         @@VDT   80                      S01277
     C                     Z-ADD0         @@SPDY  30                      S01277
     C                     Z-ADD0         @@WDAD  30                      S01277
     C                     Z-ADD0         @@DAYN  50                      S01277
     C*                                                                   S01277
     C**  CHECK IF THE FIRST CURRENCY IS THE BASE CURRENCY FOR DEALING    S01277
     C**  - IF IT IS BLANK THIS ALSO MEANS IT IS THE BASE CURRENCY.       S01277
     C***********@@CCY1****IFEQ*IDCYDL*********************B1*******S01277S01319
     C           @@CCY1    IFEQ BNCYDL                     B1             S01319
     C           @@CCY1    OREQ *BLANK                     X1             S01277
     C*                                                                   S01277
     C**  IF IT IS THE BASE CURRENCY FOR DEALING, USE THE SPOT DATE FOR   S01277
     C**  THE OTHER CURRENCY - THEN BY-PASS FURTHER PROCESSING.           S01277
     C                     Z-ADD@@SPD2    @@VDT            *1             S01277
     C                     GOTO ZA0829                     *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  CHECK IF THE SECOND CURRENCY IS THE BASE CURRENCY FOR DEALING   S01277
     C**  - IF IT IS BLANK THIS ALSO MEANS IT IS THE BASE CURRENCY.       S01277
     C***********@@CCY2****IFEQ*IDCYDL*********************B1*******S01277S01319
     C           @@CCY2    IFEQ BNCYDL                     B1             S01319
     C           @@CCY2    OREQ *BLANK                     X1             S01277
     C*                                                                   S01277
     C**  IF IT IS THE BASE CURRENCY FOR DEALING, USE THE SPOT DATE FOR   S01277
     C**  THE OTHER CURRENCY - THEN BY-PASS FURTHER PROCESSING.           S01277
     C                     Z-ADD@@SPD1    @@VDT            *1             S01277
     C                     GOTO ZA0829                     *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  NEITHER CURRENCY IS THE BASE CURRENCY FOR DEALING - CALCULATE   S01277
     C**  THE SPOT DATE.                                                  S01277
     C*                                                                   S01277
     C**  SET THE SPOT DATE TO BE CALCULATED TO THE MIDAS RUNDATE.        S01277
     C                     Z-ADD@RDNUM    @@CDYN                          S01277
     C*                                                                   S01277
     C**  DETERMINE WHICH OF THE CURRENCIES HAS THE LARGER NUMBER OF      S01277
     C**  SPOT DAYS AND USE THAT FIGURE AS THE NUMBER OF SPOT DAYS        S01277
     C**  REQUIRED.                                                       S01277
     C           @@WSP1    IFGT @@WSP2                                    S01277
     C*                                                                   S01277
     C                     Z-ADD@@WSP1    @@SPDY                          S01277
     C*                                                                   S01277
     C                     ELSE                                           S01277
     C*                                                                   S01277
     C                     Z-ADD@@WSP2    @@SPDY                          S01277
     C*                                                                   S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C**  INITIALISE THE NUMBER OF WORKING DAYS ADDED TO THE CURRENT      S01277
     C**  DATE.                                                           S01277
     C                     Z-ADD0         @@WDAD                          S01277
     C*                                                                   S01277
     C**  CONTINUE PROCESSING WHILST THE NUMBER OF SPOT DAYS REQUIRED     S01277
     C**  IS GREATER THAN THE NUMBER OF WORKING DAYS ADDED TO THE         S01277
     C**  CURRENT DATE.                                                   S01277
     C           @@SPDY    DOWGT@@WDAD                     B1             S01277
     C*                                                                   S01277
     C**  CONTINUE PROCESSING WHILST THE CALC. SPOT DATE IS A HOLIDAY     S01277
     C**  FOR EITHER CURRENCY.                                            S01277
     C                     MOVE 'H'       ZIND             *1             S01195
     C           ZIND      DOWEQ'H'                        B*2            S01195
     C*                                                                   S01277
     C**  INCREMENT THE SPOT DATE BEING CALCULATED BY ONE DAY.            S01277
     C                     ADD  1         @@CDYN           **2            S01277
     C*                                                                   S01277
     C**  CHECK WHETHER THE CALC. SPOT DATE IS A HOLIDAY FOR THE FIRST    S01277
     C**  CURRENCY BY EXECUTING SR. ZCHKH                                 S01195
     C                     MOVE @@CCY1    ZCCY             **2            S01195
     C                     Z-ADD@@CDYN    ZDAYNO           **2            S01195
      *                                                                   S01195
      * Set ZLOC to system location from SDBANKPD                         S01195
     C                     MOVELBJSLCD    ZLOC             **2            S01195
     C                     EXSR ZCHKH                      **2            S01195
     C*                                                                   S01277
     C**  IF THE SPOT DATE IS NOT A HOLIDAY FOR THE FIRST CURRENCY,       S01277
     C**  CHECK WHETHER THE CALC. SPOT DATE IS A HOLIDAY FOR THE          S01277
     C**  SECOND CURRENCY BY EXECUTING SR. ZCHKH                          S01195
     C           ZIND      IFNE 'H'                        B**3           S01195
     C*                                                                   S01277
     C                     MOVE @@CCY2    ZCCY             ***3           S01195
     C                     Z-ADD@@CDYN    ZDAYNO           ***3           S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C*                                                                   S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C**  INCREMENT THE NO. OF WORKING DAYS ADDED TO THE CURRENT DATE     S01277
     C**  BY ONE DAY.                                                     S01277
     C                     ADD  1         @@WDAD           *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C**  CONVERT THE RESULTING SPOT DATE TO YYYYMMDD FORM.               S01277
     C*                                                                   S01277
     C                     Z-ADD@@CDYN    @@DAYN                          S01277
     C                     EXSR ZA0710                                    S01277
     C*                                                                   S01277
     C           ZA0829    ENDSR                           **ZA8029**     S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                              *    S01277
     C* ZA0630 - THIS SUBROUTINE CALCULATES THE FORWARD OUTRIGHT RATE*    S01277
     C*                                                              *    S01277
     C* CALLED BY:   #DBAA                                           *    S01277
     C*                                                              *    S01277
     C* CALLS :   ZA0700                                             *    S01277
     C*       :   ZA1150   - Convert rate to scaled rate             *    S01277
     C*       :   ZA1160   - Convert scale rate to unscaled rate      *   S01277
     C*                                                              *    S01277
     C* INPUT  :  @@BYSL BUY/SELL RATE                         (1A)  *    S01277
     C*        :  @@SXP1 FIRST CURRENCY  SCALING EXPONENT      (1N)  *    S01277
     C*        :  @@SXP2 SECOND CURRENCY SCALING EXPONENT      (1N)  *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C* OUTPUT :  @@MOR  FORWARD OUTRIGHT RATE                 (13N) *    S01277
     C*           @@MDI1 MULTIPLY/DIVIDE INDICATOR             (1A)  *    S01277
     C*                                                              *    S01277
     C* USES :    @@SPRT SPOT RATE                                   *    S01277
     C*           @@FPT  FORWARD POINTS                              *    S01277
     C*           @@C    ARRAY INDEX                                 *    S01277
     C*           @@AY   ARRAY OF POWERS OF 10                       *    S01277
     C*           @@WF1  WORKFIELD                                   *    S01277
     C*****************************************************************   S01277
     C*                                                                   S01277
     C           ZA0630    BEGSR                                          S01277
     C           @@BYSL    IFEQ 'B'                        B1             S01277
     C*                                                                   S01277
     C** If multiply/divide indicator is 'M' move high spot rate to       S01277
     C** spot rate work field otherwise fill with low spot rate.          S01277
     C           A6MDEX    IFEQ 'M'                        B*2            S01195
     C                     MOVE A6HSRT    @@SPRT 138       **2            S01195
     C*                                                                   S01277
     C** Otherwise multiply/divide is 'D'.                                S01277
     C                     ELSE                            X*2            S01277
     C                     MOVE A6LSPR    @@SPRT           **2            S01195
     C                     END                             E*2            S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           @@BYSL    IFEQ 'S'                        B1             S01277
     C*                                                                   S01277
     C** If multiply/divide indicator is 'M' move low spot rate to        S01277
     C** spot rate work field otherwise fill with high spot rate.         S01277
     C           A6MDEX    IFEQ 'M'                        B*2            S01195
     C                     MOVE A6LSPR    @@SPRT           **2            S01195
     C*                                                                   S01277
     C** Otherwise multiply/divide is 'D'.                                S01277
     C                     ELSE                            X*2            S01277
     C                     MOVE A6HSRT    @@SPRT           **2            S01195
     C                     END                             E*2            S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C** Store multiply/divide indicator for output from routine.         S01277
     C                     MOVE A6MDEX    @@MDI1  1                       S01195
     C                     Z-ADD@@SXP1    @@SXP1                          S01277
     C                     Z-ADD0         @@SXP2                          S01277
     C                     Z-ADD@@SPRT    @@INRT                          S01277
     C                     MOVE 'M'       @@FCMD                          S01277
     C                     EXSR ZA1150                                    S01277
     C*                                                                   S01277
     C** CHECK FOR RETURN ERROR CODE                                      S01277
     C           @@ERCD    IFEQ 1                                         S01277
     C           @@ERCD    OREQ 3                                         S01277
     C*                                                                   S01277
     C** SET UP DATABASE ERROR FIELDS                                     S01277
     C                     MOVEL'SDCURRPD'DBFILE           ***************S01194
     C                     MOVEL'905'     DBASE            * DBERROR 905 *S01277
     C                     MOVEL@TXT,1    DBKEY            ***************S01277
     C                     MOVE '1'       *INU7                           S01277
     C                     MOVE '1'       *INU8                           S01277
     C                     GOTO ZA0639                                    S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C** MOVE scale rate TO WORK FIELD                                    S01277
     C                     Z-ADD@@SCRT    @@SPRT                          S01277
     C*                                                                   S01277
     C** ZA0700  is an internal subroutine which is used                  S01277
     C** to obtain forward points(@@FPT).                                 S01277
     C                     EXSR ZA0700                                    S01277
     C*                                                                   S01277
     C** Calculate forward outright rate by adding high/low spot rate     S01277
     C** to forward points & then dividing the result by 10 to the        S01277
     C** power of NQDP (normally quoted decimal places).                  S01277
     C                     Z-ADDA6NQDP    @@C     20                      S01194
     C                     ADD  1         @@C                             S01277
     C           @@FPT     DIV  @@AY,@@C  @@WF1  158H                     S01277
     C           @@WF1     ADD  @@SPRT    @@MOR  138                      S01277
     C*                                                                   S01277
     C** Unscale forward outright rate                                    S01277
     C                     Z-ADD@@SXP1    @@SEXP                          S01277
     C                     Z-ADD@@MOR     @@INRT                          S01277
     C                     EXSR ZA1160                                    S01277
     C                     Z-ADD@@USRT    @@MOR                           S01277
     C                     GOTO ZA0639                                    S01277
     C*                                                                   S01277
     C** Unexecuted processing to define fields used in routine.          S01277
     C                     MOVE @@BYSL    @@BYSL  1                       S01277
     C                     MOVE @@FPT     @@FPT   72                      S01277
     C*                                                                   S01277
     C           ZA0639    ENDSR                                          S01277
     C*                                                                   S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                              *    S01277
     C* ZA0900 - THIS SUBROUTINE CALCULATES THE CROSS EXCHANGE RATE  *    S01277
     C*                                                              *    S01277
     C* CALLED BY :  #DBAA                                           *    S01277
     C*                                                              *    S01277
     C* CALLS :                                                      *    S01277
     C*                                                              *    S01277
     C* INPUT  : @@MDI1  FIRST MULTIPLY/DIVIDE INDICATOR             *    S01277
     C*          @@MDI2  SECOND MULTIPLY/DIVIDE INDICATOR            *    S01277
     C*          @@RAT1  FIRST RATE (SIZE : 13,8)                    *    S01277
     C*          @@RAT2  SECOND RATE (SIZE : 13,8)                   *    S01277
     C*                                                              *    S01277
     C* OUTPUT : @@CSRT  CROSS RATE  (SIZE : 13,8)                   *    S01277
     C*          @@FCMD  FIRST CCY MULTIPLY/DIVIDE INDICATOR         *    S01277
     C*                                                              *    S01277
     C* USES :                                                       *    S01277
     C*                                                              *    S01277
     C*     LAST AMEND NO. 000003             DATE   21/08/86        *    S01277
     C*      Amendment to prevent divide by zero.                    *    S01277
     C*                                                              *    S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C           ZA0900    BEGSR                                          S01277
     C*                                                                   S01277
     C           @@RAT1    IFEQ *ZERO                      B1             S01277
     C                     Z-ADD1         @@RAT1           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           @@RAT2    IFEQ *ZERO                      B1             S01277
     C                     Z-ADD1         @@RAT2           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  IF THE FIRST RATE M/D INDICATOR IS 'M' MULTIPLY,                S01277
     C**             ELSE DIVIDE                                          S01277
     C*                                                                   S01277
     C           @@MDI1    IFEQ 'M'                        B1             S01277
     C                     Z-ADD@@RAT1    @@CSRT 138       *1             S01277
     C                     ELSE                            X1             S01277
     C           1         DIV  @@RAT1    @@CSRT    H      *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  IF THE SECOND RATE M/D INDICATOR IS 'D' MULTIPLY,               S01277
     C**             ELSE DIVIDE                                          S01277
     C*                                                                   S01277
     C           @@MDI2    IFEQ 'D'                        B1             S01277
     C           @@CSRT    MULT @@RAT2    @@CSRT           *1             S01277
     C                     ELSE                            X1             S01277
     C           @@CSRT    DIV  @@RAT2    @@CSRT    H      *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C**  SET FIRST CCY MULTIPLY/DIVIDE *IN TO MULTIPLY                   S01277
     C                     MOVE 'M'       @@FCMD  1                       S01277
     C*                                                                   S01277
     C           ZA0909    ENDSR                           **ZA0909 TAG** S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                              *    S01277
     C* ZA0700 - THIS SUBROUTINE CALCULATES FORWARD POINTS           *    S01277
     C*                                                              *    S01277
     C* CALLED BY:ZA0630                                             *    S01277
     C*                                                              *    S01277
     C* CALLS :   ZA0680                                             *    S01277
     C*                                                              *    S01277
     C* INPUT  :  @@VDT  VALUE DATE                            (8N)  *    S01277
     C*           @@CCY  CURRENCY CODE                         (3A)  *    S01277
     C*           @@BYSL BUY/SELL RATE                         (1A)  *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C* OUTPUT :  @@FPT  FORWARD POINTS                        (7N)  *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C* ADDITIONAL WORK FIELDS USED WITHIN THIS ROUTINE :                 S01277
     C*                                                              *    S01277
     C*           @@SPDT SPOT DATE             (MIDAS DAY NO.)       *    S01277
     C*           @@VDAT VALUE DATE            (MIDAS DAY NO.)       *    S01277
     C*           @@TPRD TYPE OF PERIOD        ('W' IS WEEKS)        *    S01277
     C*           @@PRD  NUMBER OF PERIODS                           *    S01277
     C*           @@FP1  FORWARD POINTS FROM 1ST REC. USED IN CALC.  *    S01277
     C*           @@FP2  FORWARD POINTS FROM 2ND REC. USED IN CALC.  *    S01277
     C*           @@D1   MIDAS DAY NO. CORRESPONDING WITH @@FP1      *    S01277
     C*           @@D2   MIDAS DAY NO. CORRESPONDING WITH @@FP2      *    S01277
     C*           @@WF1  WORK FIELD HOLDING INTERMEDIATE RESULT FROM *    S01277
     C*                                                  CALCULATION.*    S01277
     C*           @@WF2  WORK FIELD HOLDING INTERMEDIATE RESULT FROM *    S01277
     C*                                                  CALCULATION.*    S01277
     C*           @@MDNO MIDAS DAY NUMBER RETURNED FROM SR @@MDNO    *    S01277
     C*           @@DTWF DATE WORKFIELD                              *    S01277
     C*                                                              *    S01277
     C*           @@CCY1 1st Currency                                *    S01277
     C*           @@CCY2 2nd Currency                                *    S01277
     C*           @@CC1D Read(red) 1st point for 1st Ccy             *    S01277
     C*           @@CC2D Read(red) 1st point for 2nd Ccy             *    S01277
     C*           @@PRD1 Stored period date for 1st point, 1st Ccy   *    S01277
     C*           @@PRD2 Stored period date for 1st point, 2nd Ccy   *    S01277
     C*           @@PRDD Stored period date for 1st point, this Ccy  *    S01277
     C*           @@CC1W 1W point record for 1st Ccy read(red)       *    S01277
     C*           @@CC2W 1W point record for 2nd Ccy read(red)       *    S01277
     C*           @@C1LP 1W 1st Ccy low points                       *    S01277
     C*           @@C2LP 1W 2nd Ccy low points                       *    S01277
     C*           @@C1HP 1W 1st Ccy high points                      *    S01277
     C*           @@C2HP 1W 2nd Ccy high points                      *    S01277
     C*           @@D2C1 1W 1st Ccy period date day no.              *    S01277
     C*           @@D2C2 1W 2nd Ccy period date day no.              *    S01277
     C*           @@SPC1 1W 1st Ccy spot date day no.                *    S01277
     C*           @@SPC2 1W 2nd Ccy spot date day no.                *    S01277
     C*           @@CCYL Currency used by previous Exsr of ZA0700    *    S01277
     C*           @@VDTL Value date used by previous Exsr of ZA0700  *    S01277
     C*           @@CNFD No record found for currency with > date    *    S01277
     C*           @@XCCY Stored Ccy from last Exsr                   *    S01277
     C*           @@XPRD Stored Period Date from last Exsr           *    S01277
     C*           @@XTPR Stored Period Type from last Exsr           *    S01277
     C*           @@XLOP Stored Low Points from last Exsr            *    S01277
     C*           @@XHIP Stored High Points from last Exsr           *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C*     AMEND NO. XXXXX                    DATE XX/XX/XX         *    S01277
     C*                                                              *    S01277
     C*****************************************************************   S01277
     C*                                                                   S01277
     C           ZA0700    BEGSR                                          S01277
     C*                                                                   S01277
     C**  Only access 1st points record once per currency.                S01277
     C           @@CCY     IFEQ @@CCY1                     B1             S01277
     C           @@CC1D    ANDNE'Y'                        A1             S01277
     C           @@CCY     OREQ @@CCY2                     B1             S01277
     C           @@CC2D    ANDNE'Y'                        A1             S01277
     C*                                                                   S01277
     C**  Find first record on file for currency.                         S01277
     C                     MOVE *LOVAL    @@DTWF  80       *1             S01277
     C*                                                                   S01277
     C**  Load key used to access LF/FXCCYPLL.                            S01277
     C           CCYLOW    KLIST                                          S01277
     C                     KFLD           @@CCY            *1             S01277
     C                     KFLD           @@DTWF           *1             S01277
     C           CCYLOW    SETLLFXCCYPLL                   *1             S01277
     C                     READ FXCCYPLL                 81*1             S01277
     C*                                                                   S01277
     C** If currency for record has not been found                        S01277
     C** then there is a database error.                                  S01277
     C           @@CCY     IFNE XPCCY                      B*2            S01277
     C                     MOVEL'FXCCYPLL'DBFILE           **2            S01277
     C                     MOVEL'924'     DBASE            ***************S01277
     C                     MOVEL@@CCY     DBKEY            *             *S01277
     C                     MOVE '1'       *INU7            * DBERROR 924 *S01277
     C                     MOVE '1'       *INU8            *             *S01277
     C                     GOTO ZA0709                     ***************S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C*   Store period date for 1st points record for ccy                 S01277
     C           @@CCY     IFEQ @@CCY1                     B*2            S01277
     C                     MOVE XPPRDD    @@PRD1  80       **2            S01277
     C                     MOVE 'Y'       @@CC1D           **2            S01277
     C                     ELSE                            X*2            S01277
     C                     MOVE XPPRDD    @@PRD2  80       **2            S01277
     C                     MOVE 'Y'       @@CC2D           **2            S01277
     C                     END                             E*2            S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C*   Store period date for 1st points record for ccy                 S01277
     C           @@CCY     IFEQ @@CCY1                     B1             S01277
     C                     MOVE @@PRD1    @@PRDD  80       *1             S01277
     C                     ELSE                            X1             S01277
     C                     MOVE @@PRD2    @@PRDD           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C** If the value date is spot date , or before the first record      S01277
     C** on file for the currency then the points are zero.               S01277
     C*                                                                   S01277
     C           @@VDT     IFEQ A6FXSD                     B1             S01194
     C           @@VDT     ORLT @@PRDD                     *1             S01277
     C                     Z-ADD0         @@FPT   72       *1             S01277
     C                     GOTO ZA0709                     *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  Prevent rereading of point record if Currency and Date same     S01277
     C           @@CCY     IFNE @@CCYL                     B1             S01277
     C           @@VDT     ORNE @@VDTL                     B1             S01277
     C                     MOVE @@CCY     @@CCYL           *1             S01277
     C                     MOVE @@VDT     @@VDTL           *1             S01277
     C                     MOVE *BLANK    @@CNFD  1        *1             S01277
     C*                                                                   S01277
     C**  Load key used to access LF/FXCCYPLL.             *1             S01277
     C           CCYVDT    KLIST                           *1             S01277
     C                     KFLD           @@CCY            *1             S01277
     C                     KFLD           @@VDT            *1             S01277
     C           CCYVDT    SETLLFXCCYPLL                   *1             S01277
     C                     READ FXCCYPLL                 81*1             S01277
     C*                                                                   S01277
     C** If currency has not been found check previous record.            S01277
     C           @@CCY     IFNE XPCCY                      B*2            S01277
     C           *IN81     OREQ '1'                        **2            S01277
     C                     MOVE 'Y'       @@CNFD           **2            S01277
     C**                                                                  S01277
     C** IF *IN81 IS ON, EOF IS ENCOUNTERED AND NEED REPOSITION FILE      S01277
     C** TO EOF MARK AND RESET THE EOF STATUS SAVE UP BY SYSTEM.          S01277
     C           *IN81     IFEQ '1'                         B**3          S01277
     C           CCYVDT    SETGTFXCCYPLL                    ***3          S01277
     C                     END                              E**3          S01277
     C                     END                              E*2           S01277
     C*  Store for possible use in next Exsr of ZA0700                    S01277
     C                     MOVE XPCCY     @@XCCY            *1            S01277
     C                     MOVE XPPRDD    @@XPRD            *1            S01277
     C                     MOVE XPTPRD    @@XTPR            *1            S01277
     C                     MOVE XPLOPT    @@XLOP            *1            S01277
     C                     MOVE XPHIPT    @@XHIP            *1            S01277
     C                     ELSE                             X1            S01277
     C*  If Ccy/Date same as last Exsr, restore essential values.         S01277
     C                     MOVE @@XCCY    XPCCY             *1            S01277
     C                     MOVE @@XPRD    XPPRDD            *1            S01277
     C                     MOVE @@XTPR    XPTPRD            *1            S01277
     C                     MOVE @@XLOP    XPLOPT            *1            S01277
     C                     MOVE @@XHIP    XPHIPT            *1            S01277
     C*                                                                   S01277
     C                     END                              E1            S01277
     C* No Currency with > date, take last for Ccy.                       S01277
     C           @@CNFD    IFEQ 'Y'                         B1            S01277
     C                     GOTO ZA0708                      *1            S01277
     C                     END                              E1            S01277
     C*                                                                   S01277
     C** Find midas day number of value date.                             S01277
     C                     Z-ADD@@VDT     @@DTIN                          S01277
     C                     EXSR ZA0680                                    S01277
     C                     Z-ADD@@MDNO    @@VDAT  50                      S01277
     C*                                                                   S01277
     C** IF    record with = date found                                   S01277
     C           @@VDT     IFEQ XPPRDD                     B1             S01277
     C*                                                                   S01277
     C** IF Type of period is not 'D'                                     S01277
     C           XPTPRD    IFNE 'D'                        B*2            S01277
     C*                                                                   S01277
     C** If the buy/sell rate indicator is 'B' & the currency multiply    S01277
     C** /divide exchange rate indicator is 'D' ,                         S01277
     C** or 'S' & 'M' respectively,use low points otherwise use high      S01277
     C** points.                                                          S01277
     C           @@BYSL    IFEQ 'B'                        B**3           S01277
     C           A6MDEX    ANDEQ'D'                        ***3           S01194
     C                     MOVE XPLOPT    @@FPT            ***3           S01277
     C                     GOTO ZA0709                     ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C           @@BYSL    IFEQ 'S'                        B**3           S01277
     C           A6MDEX    ANDEQ'M'                        ***3           S01194
     C                     MOVE XPLOPT    @@FPT            ***3           S01277
     C                     GOTO ZA0709                     ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     MOVE XPHIPT    @@FPT            **2            S01277
     C                     GOTO ZA0709                     **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** The type of period is 'D'.                                       S01277
     C** Date is spot + 1 , spot - 1 or spot - 2 days.                    S01277
     C** Linear interpolation or extrapolation used between one week      S01277
     C** rate & 0 on the spot date.                                       S01277
     C*                                                                   S01277
     C*   Only access 1W point once per currency.                         S01277
     C           @@CCY     IFEQ @@CCY1                     B*2            S01277
     C           @@CC1W    ANDNE'Y'                        A*2            S01277
     C           @@CCY     OREQ @@CCY2                     B*2            S01277
     C           @@CC2W    ANDNE'Y'                        A*2            S01277
     C*                                                                   S01277
     C** Find the one week rate.                                          S01277
     C** Define search argument for chain to LF/FDCCYPLL.                 S01277
     C                     MOVE 'W'       @@TPRD  1        **2            S01277
     C                     Z-ADD1         @@PRD   20       **2            S01277
     C           WEEKRT    KLIST                           **2            S01277
     C                     KFLD           @@CCY            **2            S01277
     C                     KFLD           @@TPRD           **2            S01277
     C                     KFLD           @@PRD            **2            S01277
     C*                                                                   S01277
     C** CHAIN TO FILE FDCCYPLL                                           S01277
     C           WEEKRT    CHAINFDCCYPLL             80    **2            S01277
     C           XPDLTF    IFEQ '*'                        B**3           S01277
     C                     MOVE '1'       *IN80            ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C** DEAL WITH DATA BASE ERROR                                        S01277
     C           *IN80     IFEQ '1'                        B**3           S01277
     C                     MOVEL'FDCCYPLL'DBFILE           ***3           S01277
     C                     MOVEL'923'     DBASE            ***************S01277
     C                     MOVEL@@CCY     DBKEY            *             *S01277
     C                     MOVE '1'       *INU7            * DBERROR 923 *S01277
     C                     MOVE '1'       *INU8            *             *S01277
     C                     GOTO ZA0709                     ***************S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C** Find 1 week date & spot date as a day number.                    S01277
     C                     Z-ADDXPPRDD    @@DTIN           **2            S01277
     C                     EXSR ZA0680                     **2            S01277
     C                     Z-ADD@@MDNO    @@D2    50       **2            S01277
     C*                                                                   S01277
     C                     Z-ADDA6FXSD    @@DTIN           **2            S01194
     C                     EXSR ZA0680                     **2            S01277
     C                     Z-ADD@@MDNO    @@SPDT  50       **2            S01277
     C*                                                                   S01277
     C           @@CCY     IFEQ @@CCY1                     B**3           S01277
     C                     MOVE 'Y'       @@CC1W           ***3           S01277
     C                     MOVE XPLOPT    @@C1LP  72       ***3           S01277
     C                     MOVE XPHIPT    @@C1HP  72       ***3           S01277
     C                     Z-ADD@@D2      @@D2C1  50       ***3           S01277
     C                     Z-ADD@@SPDT    @@SPC1  50       ***3           S01277
     C                     ELSE                            X**3           S01277
     C                     MOVE 'Y'       @@CC2W           ***3           S01277
     C                     MOVE XPLOPT    @@C2LP  72       ***3           S01277
     C                     MOVE XPHIPT    @@C2HP  72       ***3           S01277
     C                     Z-ADD@@D2      @@D2C2  50       ***3           S01277
     C                     Z-ADD@@SPDT    @@SPC2  50       ***3           S01277
     C                     END                             E**3           S01277
     C*                                                                   S01277
     C                     END                             E*2            S01277
     C*  Restore week 1 points etc. as previously stored.                 S01277
     C           @@CCY     IFEQ @@CCY1                     B*2            S01277
     C                     MOVE @@C1LP    XPLOPT           **2            S01277
     C                     MOVE @@C1HP    XPHIPT           **2            S01277
     C                     Z-ADD@@D2C1    @@D2             **2            S01277
     C                     Z-ADD@@SPC1    @@SPDT           **2            S01277
     C                     ELSE                            X*2            S01277
     C                     MOVE @@C2LP    XPLOPT           **2            S01277
     C                     MOVE @@C2HP    XPHIPT           **2            S01277
     C                     Z-ADD@@D2C2    @@D2             **2            S01277
     C                     Z-ADD@@SPC2    @@SPDT           **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C** If the buy/sell rate indicator is 'B' & the currency multiply    S01277
     C** /divide exchange rate indicator is 'D' ,                         S01277
     C** or 'S' & 'M' respectively,use low points otherwise use high      S01277
     C** points.                                                          S01277
     C           @@BYSL    IFEQ 'B'                        B*2            S01277
     C           A6MDEX    ANDEQ'D'                        **2            S01194
     C                     MOVE XPLOPT    @@FP2   72       **2            S01277
     C*                                                                   S01277
     C                     ELSE                            X*2            S01277
     C           @@BYSL    IFEQ 'S'                        B**3           S01277
     C           A6MDEX    ANDEQ'M'                        ***3           S01194
     C                     MOVE XPLOPT    @@FP2            ***3           S01277
     C*                                                                   S01277
     C                     ELSE                            X**3           S01277
     C                     MOVE XPHIPT    @@FP2            ***3           S01277
     C                     END                             E**3           S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** Forward points can now be calculated.                            S01277
     C           @@VDAT    SUB  @@SPDT    @@WF1  158       *1             S01277
     C           @@FP2     MULT @@WF1     @@WF1            *1             S01277
     C           @@D2      SUB  @@SPDT    @@WF2   80       *1             S01277
     C           @@WF1     DIV  @@WF2     @@FPT            *1             S01277
     C                     GOTO ZA0709                     *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C*                                                                   S01277
     C** IF    record with > date found                                   S01277
     C           XPPRDD    IFGT @@VDT                      B1             S01277
     C*                                                                   S01277
     C** If the buy/sell rate indicator is 'B' & the currency multiply    S01277
     C** /divide exchange rate indicator is 'D' ,                         S01277
     C** or 'S' & 'M' respectively,use low points otherwise use high      S01277
     C** points.                                                          S01277
     C           @@BYSL    IFEQ 'B'                        B*2            S01277
     C           A6MDEX    ANDEQ'D'                        **2            S01194
     C                     MOVE XPLOPT    @@FP2   72       **2            S01277
     C*                                                                   S01277
     C                     ELSE                            X*2            S01277
     C           @@BYSL    IFEQ 'S'                        B**3           S01277
     C           A6MDEX    ANDEQ'M'                        ***3           S01194
     C                     MOVE XPLOPT    @@FP2            ***3           S01277
     C*                                                                   S01277
     C                     ELSE                            X**3           S01277
     C                     MOVE XPHIPT    @@FP2            ***3           S01277
     C                     END                             E**3           S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** Find day number of date.                                         S01277
     C                     Z-ADDXPPRDD    @@DTIN           *1             S01277
     C                     EXSR ZA0680                     *1             S01277
     C                     Z-ADD@@MDNO    @@D2    50       *1             S01277
     C*                                                                   S01277
     C** Prevent rereading of point record if Ccy/Date same               S01277
     C           @@CCY     IFNE @@CCYP                     B*2            S01277
     C           @@VDT     ORNE @@VDTP                     B*2            S01277
     C                     MOVE @@CCY     @@CCYP           **2            S01277
     C                     MOVE @@VDT     @@VDTP           **2            S01277
     C*                                                                   S01277
     C** READ PREVIOUS record on LF/FXCCYPLL                              S01277
     C                     READPFXCCYPLL               8180**2            S01277
     C*                                                                   S01277
     C** IF read prior was unsuccessful then there is a database error.   S01277
     C           *IN80     IFEQ '1'                        B**3           S01277
     C           *IN81     OREQ '1'                        ***3           S01277
     C                     MOVEL'FXCCYPLL'DBFILE           ***3           S01277
     C                     MOVEL'927'     DBASE            ***************S01277
     C                     MOVE '1'       *INU7            *             *S01277
     C                     MOVE '1'       *INU8            * DBERROR 927 *S01277
     C                     GOTO ZA0709                     *             *S01277
     C                     END                             ***************S01277
     C*                                                                   S01277
     C* Store point record detail for later Exsrs of ZA0700               S01277
     C                     MOVE XPPRDD    @@XPCC           **2            S01277
     C                     MOVE XPLOPT    @@XPLP           **2            S01277
     C                     MOVE XPHIPT    @@XPHP           **2            S01277
     C                     ELSE                            X*2            S01277
     C                     MOVE @@XPCC    XPPRDD           **2            S01277
     C                     MOVE @@XPLP    XPLOPT           **2            S01277
     C                     MOVE @@XPHP    XPHIPT           **2            S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C           @@BYSL    IFEQ 'B'                        B*2            S01277
     C           A6MDEX    ANDEQ'D'                        **2            S01194
     C                     MOVE XPLOPT    @@FP1   72       **2            S01277
     C*                                                                   S01277
     C                     ELSE                            X*2            S01277
     C           @@BYSL    IFEQ 'S'                        B**3           S01277
     C           A6MDEX    ANDEQ'M'                        ***3           S01194
     C                     MOVE XPLOPT    @@FP1            ***3           S01277
     C*                                                                   S01277
     C                     ELSE                            X**3           S01277
     C                     MOVE XPHIPT    @@FP1            ***3           S01277
     C                     END                             E**3           S01277
     C                     END                             E*2            S01277
     C*                                                                   S01277
     C** Find day number of date.                                         S01277
     C                     Z-ADDXPPRDD    @@DTIN           *1             S01277
     C                     EXSR ZA0680                     *1             S01277
     C                     Z-ADD@@MDNO    @@D1    50       *1             S01277
     C*                                                                   S01277
     C** Forward points can now be calculated.                            S01277
     C           @@FP2     SUB  @@FP1     @@WF1            *1             S01277
     C           @@VDAT    SUB  @@D1      @@WF2            *1             S01277
     C           @@WF1     MULT @@WF2     @@WF1            *1             S01277
     C           @@D2      SUB  @@D1      @@WF2            *1             S01277
     C           @@WF1     DIV  @@WF2     @@WF1            *1             S01277
     C           @@WF1     ADD  @@FP1     @@FPT     H      *1             S01277
     C                     GOTO ZA0709                     *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C** No record with > or = date has been found at this stage          S01277
     C** of processing so the points on the furthest forward              S01277
     C** record are used.                                                 S01277
     C** Find the furthest forward record                                 S01277
     C*                                                                   S01277
     C** READ PREVIOUS record on LF/FXCCYPLL                              S01277
     C           ZA0708    TAG                                            S01277
     C                     MOVE *HIVAL    @@VDT                           S01277
     C           CCYVDT    SETGTFXCCYPLL                                  S01277
     C                     READPFXCCYPLL               8081               S01277
     C           @@CCY     IFNE XPCCY                      B1             S01277
     C                     MOVE '1'       *IN80            *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C** IF read prior was unsuccessful then there is a database error.   S01277
     C           *IN80     IFEQ '1'                        B1             S01277
     C           *IN81     OREQ '1'                        *1             S01277
     C                     MOVEL'FXCCYPLL'DBFILE           ***************S01277
     C                     MOVEL'928'     DBASE            *             *S01277
     C                     MOVE '1'       *INU7            * DBERROR 928 *S01277
     C                     MOVE '1'       *INU8            *             *S01277
     C                     GOTO ZA0709                     ***************S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C** If the buy/sell rate indicator is 'B' & the currency multiply    S01277
     C** /divide exchange rate indicator is 'D' ,                         S01277
     C** or 'S' & 'M' respectively,use low points otherwise use high      S01277
     C** points.                                                          S01277
     C           @@BYSL    IFEQ 'B'                        B1             S01277
     C           A6MDEX    ANDEQ'D'                        *1             S01194
     C                     MOVE XPLOPT    @@FPT            *1             S01277
     C                     GOTO ZA0709                     *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           @@BYSL    IFEQ 'S'                        B1             S01277
     C           A6MDEX    ANDEQ'M'                        *1             S01194
     C                     MOVE XPLOPT    @@FPT            *1             S01277
     C                     GOTO ZA0709                     *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C                     MOVE XPHIPT    @@FPT                           S01277
     C*                                                                   S01277
     C                     GOTO ZA0709                                    S01277
     C*                                                                   S01277
     C** Unexecuted processing to define fields used by this subroutine.  S01277
     C                     MOVE @@MDNO    @@MDNO  50                      S01277
     C*                                                                   S01277
     C           ZA0709    ENDSR                                          S01277
     C*****************************************************************   S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                              *    S01277
     C*     ZA1150 -  Convert rate to scaled rate.                   *    S01277
     C*                                                              *    S01277
     C*     CALLS:                                                   *    S01277
     C*                                                              *    S01277
     C*     INPUT:   @@SXP1 - First currency scaling exponent.       *    S01277
     C*              @@SXP2 - Second currency scaling exponent.      *    S01277
     C*              @@INRT - Rate to be scaled.                     *    S01277
     C*              @@FCMD - First Currency Multiply/Divide Ind.    *    S01277
     C*                                                              *    S01277
     C*     OUTPUT:  @@SCRT - Scaled rate.                           *    S01277
     C*              @@ISRT - Inverse of scaled rate.                *    S01277
     C*              @@ERCD - Error code.                            *    S01277
     C*                                                              *    S01277
     C*     USES:    @SF    - Array of scaling factors.              *    S01277
     C*              @@C    - Index for array @SF.                   *    S01277
     C*              @@SCF1 - Scaling factor for currency 1.         *    S01277
     C*              @@SCF2 - Scaling factor for currency 2.         *    S01277
     C*              @@WKA  - Work field, 15,0N.                     *    S01277
     C*              @@WKB  - Work field, 15,0N.                     *    S01277
     C*                                                              *    S01277
     C*     LAST AMEND NO. 000000             DATE   XX/XX/XX        *    S01277
     C*                                                              *    S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C           ZA1150    BEGSR                                          S01277
     C*                                                                   S01277
     C**  Define and initialise fields used and output fields.            S01277
     C                     Z-ADD@@SXP1    @@SXP1  10                      S01277
     C                     Z-ADD@@SXP2    @@SXP2  10                      S01277
     C                     Z-ADD@@INRT    @@INRT 128                      S01277
     C                     MOVE @@FCMD    @@FCMD  1                       S01277
     C*                                                                   S01277
     C                     Z-ADD*ZEROS    @@SCRT 128                      S01277
     C                     Z-ADD*ZEROS    @@ISRT 128                      S01277
     C                     Z-ADD*ZEROS    @@ERCD  10                      S01277
     C*                                                                   S01277
     C                     Z-ADD*ZEROS    @@C     20                      S01277
     C                     Z-ADD*ZEROS    @@SCF1 100                      S01277
     C                     Z-ADD*ZEROS    @@SCF2 100                      S01277
     C                     Z-ADD*ZEROS    @@WKA  150                      S01277
     C                     Z-ADD*ZEROS    @@WKB  150                      S01277
     C*                                                                   S01277
     C**  If the input rate is zero, the two output rates are zero,       S01277
     C**  by-pass further processing.                                     S01277
     C           @@INRT    CABEQ0         ZA1159                          S01277
     C*                                                                   S01277
     C**  Determine the scaling factor from the scaling exponent for      S01277
     C**  the first currency.                                             S01277
     C                     Z-ADD@@SXP1    @@C                             S01277
     C                     ADD  1         @@C                             S01277
     C                     Z-ADD@SF,@@C   @@SCF1                          S01277
     C*                                                                   S01277
     C**  Determine the scaling factor from the scaling exponent for      S01277
     C**  the second currency.                                            S01277
     C                     Z-ADD@@SXP2    @@C                             S01277
     C                     ADD  1         @@C                             S01277
     C                     Z-ADD@SF,@@C   @@SCF2                          S01277
     C*                                                                   S01277
     C**  If the M/D indicator is M, then the scaled rate is calculated   S01277
     C**  as follows....                                                  S01277
     C           @@FCMD    IFEQ 'M'                        B1             S01277
     C*                                                                   S01277
     C**  Calculate the scaled rate and its inverse.                      S01277
     C           @@INRT    MULT @@SCF1    @@SCRT           *1             S01277
     C           @@SCF2    DIV  @@INRT    @@ISRT    H      *1             S01277
     C*                                                                   S01277
     C**  Calculate the scaled rate and its inverse, placing the result   S01277
     C**  into 15,0 fields to check for overflow.                         S01277
     C           @@INRT    MULT @@SCF1    @@WKA            *1             S01277
     C           @@SCF2    DIV  @@INRT    @@WKB     H      *1             S01277
     C*                                                                   S01277
     C**  Otherwise, calculate the rate as follows....                    S01277
     C                     ELSE                            X1             S01277
     C*                                                                   S01277
     C**  Calculate the scaled rate and its inverse.                      S01277
     C           @@INRT    MULT @@SCF2    @@SCRT           *1             S01277
     C           @@SCF1    DIV  @@INRT    @@ISRT    H      *1             S01277
     C*                                                                   S01277
     C**  Calculate the scaled rate and its inverse, placing the result   S01277
     C**  into 15,0 fields to check for overflow.                         S01277
     C           @@INRT    MULT @@SCF2    @@WKA            *1             S01277
     C           @@SCF1    DIV  @@INRT    @@WKB     H      *1             S01277
     C*                                                                   S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  If the work fields are greater than 9999.99999999, set up the   S01277
     C**  error codes.                                                    S01277
     C           @@WKA     IFGE 10000                      B1             S01277
     C                     Z-ADD1         @@ERCD           *1             S01277
     C                     END                             E1             S01277
     C           @@WKB     IFGE 10000                      B1             S01277
     C                     Z-ADD2         @@ERCD           *1             S01277
     C                     END                             E1             S01277
     C           @@WKA     IFGE 10000                      B1             S01277
     C           @@WKB     ANDGE10000                      B1             S01277
     C                     Z-ADD3         @@ERCD           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           ZA1159    ENDSR                           **ZA1159**     S01277
     C/EJECT                                                              S01277
     C****************************************************************    S01277
     C*                                                              *    S01277
     C*     ZA1160 -  Convert scaled rate to unscaled rate.          *    S01277
     C*                                                              *    S01277
     C*     CALLS:                                                   *    S01277
     C*                                                              *    S01277
     C*     INPUT:   @@SEXP - Scaling exponent.                      *    S01277
     C*              @@INRT - Rate to be unscaled.                   *    S01277
     C*                                                              *    S01277
     C*     OUTPUT:  @@USRT - Unscaled rate.                         *    S01277
     C*                                                              *    S01277
     C*     USES:    @SF    - Array of scaling factors.              *    S01277
     C*              @@C    - Index for array @SF.                   *    S01277
     C*              @@SCAF - Scaling factor.                        *    S01277
     C*                                                              *    S01277
     C*     LAST AMEND NO. 000000             DATE   XX/XX/XX        *    S01277
     C*                                                              *    S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C           ZA1160    BEGSR                                          S01277
     C*                                                                   S01277
     C**  Define and initialise fields used and output fields.            S01277
     C                     Z-ADD@@SEXP    @@SEXP  10                      S01277
     C                     Z-ADD@@INRT    @@INRT 128                      S01277
     C*                                                                   S01277
     C                     Z-ADD*ZEROS    @@USRT 128                      S01277
     C*                                                                   S01277
     C                     Z-ADD*ZEROS    @@C     20                      S01277
     C                     Z-ADD*ZEROS    @@SCAF 100                      S01277
     C*                                                                   S01277
     C**  If the input rate is zero, the output rate is zero, by-pass     S01277
     C**  further processing.                                             S01277
     C           @@INRT    CABEQ0         ZA1169                          S01277
     C*                                                                   S01277
     C**  Determine the scaling factor from the scaling exponent.         S01277
     C                     Z-ADD@@SEXP    @@C                             S01277
     C                     ADD  1         @@C                             S01277
     C                     Z-ADD@SF,@@C   @@SCAF                          S01277
     C*                                                                   S01277
     C**  Calculate the unscaled rate.                                    S01277
     C           @@INRT    DIV  @@SCAF    @@USRT    H                     S01277
     C*                                                                   S01277
     C           ZA1169    ENDSR                           **ZA1169**     S01277
     C/EJECT                                                              S01277
     C******************************************************************* S01277
     C*                                                              *    S01277
     C* ZA0680 - THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO    *    S01277
     C*          MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)    *    S01277
     C*                                                              *    S01277
     C*                                                              *    S01277
     C* CALLED BY :   ZA0700    (5 times)                            *    S01277
     C*               ZA0730                                         *    S01277
     C*                                                              *    S01277
     C* CALLS :                                                      *    S01277
     C*                                                              *    S01277
     C* INPUT  : @@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)   S01277
     C*                                                              *    S01277
     C* OUTPUT : @@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                *    S01277
     C*                                                              *    S01277
     C* USES :   @@CC   NUMBER OF CENTURIES IN DATE                  *    S01277
     C*          @@DAY  DAY NUMBER                                   *    S01277
     C*          @@REM  REMAINDER FROM DIVIDE                        *    S01277
     C*          @@MTH  MONTH NUMBER                                 *    S01277
     C*          @MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN*    S01277
     C*                 MONTH                                        *    S01277
     C*          @@WK2  WORK FIELD (2,0)                             *    S01277
     C*          @@WK5  WORK FIELD (5,0)                             *    S01277
     C*          @@YYYY YEAR (4 CHARACTER)                           *    S01277
     C*          @@YY   YEAR (2 CHARACTER)                           *    S01277
     C*          @YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN*    S01277
     C*                 A FOUR YEAR PERIOD                           *    S01277
     C*                                                              *    S01277
     C****************************************************************    S01277
     C*                                                                   S01277
     C           ZA0680    BEGSR                                          S01277
     C*                                                                   S01277
     C**  CLEAR OUT ANY 'OLD' DATA IN FIELD                               S01277
     C                     Z-ADD0         @@MDNO  50                      S01277
     C*                                                                   S01277
     C**   IF DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING          S01277
     C           @@YYYY    IFGE 2072                       B1             S01277
     C*                                                                   S01277
     C**    MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)            S01277
     C           @@CC      SUB  19        @@WK2   20       *1             S01277
     C           @@WK2     MULT 36524     @@MDNO           *1             S01277
     C*                                                                   S01277
     C**  YEAR 2000 IS A LEAP YEAR MUST ALLOW EXTRA DAY                   S01277
     C                     ADD  1         @@MDNO           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C           @@YYYY    ADD  28        @@WK2                           S01277
     C*                                                                   S01277
     C           @@WK2     DIV  4         @@WK2                           S01277
     C                     MVR            @@REM   10                      S01277
     C*                                                                   S01277
     C**    MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD                S01277
     C           @@WK2     MULT 1461      @@WK5   50                      S01277
     C                     ADD  @@WK5     @@MDNO                          S01277
     C*                                                                   S01277
     C**  CHECK REMAINDER AND MONTH NUMBER                                S01277
     C           @@REM     IFEQ 0                          B1             S01277
     C           @@MTH     ANDGT2                          B1             S01277
     C                     ADD  1         @@MDNO           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  YEAR NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR               S01277
     C           @@REM     IFNE 0                          B1             S01277
     C                     ADD  @YD,@@REM @@MDNO           *1             S01277
     C                     END                             E1             S01277
     C*                                                                   S01277
     C**  ADD MONTHS THIS YEAR                                            S01277
     C                     ADD  @MD,@@MTH @@MDNO                          S01277
     C*                                                                   S01277
     C**  ADD DAYS THIS MONTH                                             S01277
     C                     ADD  @@DAY     @@MDNO                          S01277
     C*                                                                   S01277
     C           ZA0689    ENDSR                           **ZA0689 TAG** S01277
     C*****************************************************************   S01277
      ** Copy standard holiday subroutines                                S01195
      /COPY ZSRSRC,ZCHKH                                                  S01195
      /COPY ZSRSRC,ZACCH                                                  S01195
     C*****************************************************************   S01277
     C*                                                               *   S01277
     C*       TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   S01277
     C*                                                               *   S01277
     C*       SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   S01277
     C*       PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   S01277
     C*       THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   S01277
     C*       SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   S01277
     C*       IF '@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   S01277
     C*       '@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   S01277
     C*                                                               *   S01277
     C* NOTE: FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  S01277
     C*                                                               *   S01277
     C*       1) @@DAYN   LENGTH 5,0.                                 *   S01277
     C*                                                               *   S01277
     C*       FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   S01277
     C*                                                               *   S01277
     C*       1) @@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   S01277
     C*       2) @@RTN    LENGTH 1,0.                                 *   S01277
     C*       3) @@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   S01277
     C*       4) @@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   S01277
     C*       5) @@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   S01277
     C*       6) @@RDAY   LENGTH 5,0.                                 *   S01277
     C*       7) @@LEAP   LENGTH 1,0.                                     S01277
     C*                                                               *   S01277
     C*       INDICATORS USED ARE:                                    *   S01277
     C*                                                               *   S01277
     C*       1) 80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   S01277
     C*       2) 81       CHECK FOR LOW ON ARRAY @MD.                 *   S01277
     C*                                                               *   S01277
     C* INPUT FIELD:       @@DAYN                                     *   S01277
     C*                                                               *   S01277
     C* OUTPUT FIELD:      @@VDT                                      *   S01277
     C*                                                               *   S01277
     C* WORK FIELDS:       @@RTN                                      *   S01277
     C*                    @@Z71Y                                     *   S01277
     C*                    @@RDAY                                     *   S01277
     C*                    @@LEAP                                     *   S01277
     C*                    @@I                                        *   S01277
     C*                    @@J                                        *   S01277
     C*                                                               *   S01277
     C* ARRAYS USED:       @YD COMPILE TIME ARRAY.                        S01277
     C*                    @MD COMPILE TIME ARRAY.                        S01277
     C*                                                                   S01277
     C*     CALLED BY:   ZA0730                                           S01277
     C*                  ZA0820                                           S01277
     C*                                                                   S01277
     C*****************************************************************   S01277
     C*                                                                   S01277
     C           ZA0710    BEGSR                                          S01277
     C*                                                                   S01277
     C                     SETOF                     8081                 S01277
     C                     Z-ADD0         @@RTN   10                      S01277
     C                     Z-ADD0         @@VDT                           S01277
     C                     Z-ADD1         @@I     20                      S01277
     C                     Z-ADD1         @@J     20                      S01277
     C                     Z-ADD1         @@LEAP  10                      S01277
     C*                                                                   S01277
     C           @@DAYN    IFLT 1                                         S01277
     C                     Z-ADD1         @@RTN                           S01277
     C                     GOTO ZA0719                                    S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* DIVISION TO DETERMINE WETHER LEAP YEAR.                           S01277
     C*                                                                   S01277
     C           @@DAYN    DIV  1461      @@Z71Y                          S01277
     C                     MVR            @@RDAY  50                      S01277
     C*                                                                   S01277
     C* CALCULATING YEAR.                                                 S01277
     C*                                                                   S01277
     C           @@Z71Y    MULT 4         @@Z71Y                          S01277
     C                     ADD  1972      @@Z71Y                          S01277
     C*                                                                   S01277
     C* CHECKING IF YEAR IS GREATER THAN OR EQUAL TO 2100                 S01277
     C*                                                                   S01277
     C           @@Z71Y    IFGE 2100                                      S01277
     C                     ADD  @@SSY2    @@RDAY                          S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* LOKUP ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        S01277
     C* HAVE PASSED.                                                      S01277
     C*                                                                   S01277
     C           @@RDAY    LOKUP@YD,@@I                8080               S01277
     C*                                                                   S01277
     C* IF YEAR IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     S01277
     C*                                                                   S01277
     C           *IN80     IFEQ '0'                                       S01277
     C                     Z-ADD0         @@LEAP                          S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* ADD INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       S01277
     C*                                                                   S01277
     C           @@LEAP    IFEQ 1                                         S01277
     C           @@RDAY    SUB  @YD,@@I   @@RDAY                          S01277
     C                     ADD  @@I       @@Z71Y                          S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* PROCESSING FOR A LEAP YEAR.                                       S01277
     C*                                                                   S01277
     C           @@LEAP    IFEQ 0                                         S01277
     C*                                                                   S01277
     C* IF '@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   S01277
     C*                                                                   S01277
     C           @@RDAY    IFEQ 60                                        S01277
     C                     Z-ADD29        @@Z71D                          S01277
     C                     Z-ADD2         @@Z71M                          S01277
     C                     GOTO ZA0711                                    S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* IF '@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    S01277
     C* PROCEED AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     S01277
     C* YEAR. NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          S01277
     C*                                                                   S01277
     C           @@RDAY    IFGT 60                                        S01277
     C           @@RDAY    SUB  1         @@RDAY                          S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* IF DAY '@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      S01277
     C* IN 4 YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      S01277
     C* GROUP.                                                            S01277
     C*                                                                   S01277
     C           @@RDAY    IFEQ 0                                         S01277
     C                     Z-ADD31        @@Z71D                          S01277
     C                     Z-ADD12        @@Z71M                          S01277
     C                     SUB  1         @@Z71Y                          S01277
     C                     GOTO ZA0711                                    S01277
     C                     END                                            S01277
     C*                                                                   S01277
     C* LOOK UP ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         S01277
     C* OCCURS IN                                                         S01277
     C*                                                                   S01277
     C           @@RDAY    LOKUP@MD,@@J                81                 S01277
     C                     Z-ADD@@J       @@Z71M                          S01277
     C           @@RDAY    SUB  @MD,@@J   @@Z71D                          S01277
     C*                                                                   S01277
     C* DS @@VDT  IS RETURNED IN YYYYMMDD FORMAT                          S01277
     C*                                                                   S01277
     C           ZA0711    TAG                                            S01277
     C*                                                                   S01277
     C                     MOVE @@Z71Y    @@YR                            S01277
     C*                                                                   S01277
     C           ZA0719    ENDSR                                          S01277
     C*****************************************************************   S01277
      /EJECT
     C****************************************************************
     C*
     C*  SUBROUTINE: #C  - THIS ROUTINE IS THE FINAL ROUTINE WHICH
     C*                    OUTPUTS THE DATA AREA AND CALLS THE
     C*                    CONTROL MODULE PROGRAM
     C*
     C*  CALLED BY : MAIN PROGRAM
     C*
     C*  CALLS     : CM0020 CONTROL MODULE PROGRAM                        S01166
     C*
     C*  FIELDS USED : @BDVS  TOTAL BANK DEALT SPOT BCE SIGN
     C*                @BDVT  BANK DEALT SPOT BCE TOT. FOR S/FXEPOSLL
     C*                @BLNK  BLANK FIELD
     C*                @CCY1  CURRENCY 1 ON DISPLAY WINDOW
     C*                @CCY10 CURRENCY 10 ON DISPLAY WINDOW
     C*                @ENQU  ENQUIRY UPDATED (*ENTRY PLIST)
     C*                @ENQN  ENQUIRY NUMBER
     C*                @ESER  EMID TYPE OF SEND ENQUIRY RESPONSE
     C*                @PLCM  PARAMETER LIST FOR CALL TO CM0020           S01166
     C*                @PLTS  TOTAL PROFIT/LOSS SIGN
     C*                @PLVT  TOTAL PROFIT/LOSS VALUE
     C*                @PWNW  WINDOW NUMBER
     C*                DBASE  CHAIN FAIL ERROR NUMBER
     C*                DBFILE CHAIN FAIL FILE NAME
     C*                DBKEY  CHAIN FAIL KEY
     C*                FARKT1 ROLL KEY/FIELD TOP 1
     C*                FARKB1 ROLL KEY/FIELD BOTTOM 1
     C*
     C*  FIELDS OUTPUT : AMENQ2AA  DATA AREA CONTAINING OUTPUT FIELDS
     C*
     C****************************************************************
     C           #C        BEGSR
     C*
     C**  IF NO RECORDS ON FILE @EFIL WILL BE 'Y'
     C           @EFIL     IFNE 'Y'                        B1
     C*
     C**  MUST DIVIDE TOTAL BY 1000
     C***        @BDVT     DIV  1000      @BDVT     H      *1             S01166
     C*
     C**  MUST CORRECT TOTAL P/L FOR OUTPUT
     C***        @PLT15    DIV  @DP,@P    @PLVT     H      *1             S01166
     C*
     C** ADJUST TOTAL DEALT BASE CURRENCY EQUIVALENT FOR BASE CCY
     C** DECIMAL PLACES
     C***        @@NDPB    IFEQ 1                          B*2            S01166
     C***                  DIV  10        @BDVT     H      **2            S01166
     C***                  END                             E*2            S01166
     C***        @@NDPB    IFEQ 2                          B*2            S01166
     C***                  DIV  100       @BDVT     H      **2            S01166
     C***                  END                             E*2            S01166
     C***        @@NDPB    IFEQ 3                          B*2            S01166
     C***                  DIV  1000      @BDVT     H      **2            S01166
     C***                  END                             E*2            S01166
     C*
     C**  PUT IN THE SIGN FOR THE TOTALS
     C**  PROFIT/LOSS
     C***        @PLVT     IFGT 0                          B*2            S01166
     C***                  MOVE '+'       @PLTS            **2            S01166
     C***                  ELSE                            X*2            S01166
     C***                  MOVE '-'       @PLTS            **2            S01166
     C***                  Z-SUB@PLVT     @PLVT                           S01166
     C***                  END                             E*2            S01166
     C***                                                                 S01166
     C*** BANK DEALT SPOT BASE CURRENCY EQUIVALENT (REVERSED)             S01166
     C***        @BDVT     IFGT 0                          B*2            S01166
     C***                  MOVE '-'       @BDVS            **2            S01166
     C***                  ELSE                            X*2            S01166
     C***                  MOVE '+'       @BDVS            **2            S01166
     C***                  Z-SUB@BDVT     @BDVT                           S01166
     C***                  END                             E*2            S01166
     C                     END                             E1             S01166
     C*
     C**  OUTPUT THE DATA AREA AMENQ1AA, unconditional, release.
     C***                  OUT  AMENQ                                     S01166
     C*
     C****FOR*EMPTY FILE*FXEPOSLL SEND*BACK*DUMMY*ENQUIRY CODE
     C** FOR EMPTY FILE MUST SEND RESPONSE SO GET TITLES
     C           @EFIL     IFEQ 'Y'                        B1
     C******************   MOVE '999'     @ENQN   3        *1
     C***                  MOVE '043'     @ENQN   3        *1             S01166
     C*
     C** RELEASE CA38CPLL FILE IF ACCESSED BEFORE
     C***        @CCC      IFEQ *BLANKS                    B*2            S01136
     C***                  EXCPT@RLS01                     **2            S01136
     C***                  END                             X*2            S01136
     C                     ELSE                            X1             S01166
     C*
     C**  UPDATE S/FX38CPPP FIELDS
     C*          1         CHAINFX38CPLL             60
     C***        1         CHAINCA38CPLL             60                   S01166
     C*
     C** ERROR IF RECORD NOT FOUND, SET UP LDA AND EXIT PGM
     C***        *IN60     IFEQ '1'                        B1             S01166
     C***                  MOVEL'1'       DBKEY            *1 ************S01166
     C***                  MOVEL'FX38CPLL'DBFILE           *1 * DB        S01166
     C***                  MOVEL'CA38CPLL'DBFILE           *1 * DB        S01166
     C***                  MOVEL'004'     DBASE            *1 * ERROR 003 S01166
     C***                  EXSR #BA                        *1 *           S01166
     C***                  GOTO #C9                        *1 ************S01166
     C***                  END                             E1             S01166
     C*
     C**  PICK UP TOP & BOTTOM CCY'S IN DISPLAY WINDOW
     C           @LOC      OCUR @VALUE
     C                     MOVELFOCCY     @BOTCY                          S01166
     C           @HIC      OCUR @VALUE
     C                     MOVELFOCCY     @TOPCY                          S01166
     C*                    UPDATFX38CPP0
     C***                  UPDATCA38CPP0                                  S01166
      *
     C***                  MOVE '043'     @ENQN            *1             S01166
     C                     END                             E1
     C*
     C**  SEND THE DATA TO THE PC USING THE CONTROL MODULE PROGRAM
     C                     MOVE 'ER'      @ESER   2
     C                     MOVE '1'       @PWNW   1
     C*
     C                     MOVE *BLANK    @BLNK   1
     C***                  CALL 'CM0020'                                  S01166
     C***                  PARM *BLANK    @TERM                           S01166
     C***                  PARM           @ESER                           S01166
     C***                  PARM           @PWNW                           S01166
     C***                  PARM           @ENQU                           S01166
     C***                  PARM           @ENQN                           S01166
     C***                  PARM           @BLNK                           S01166
     C*
     C**  CHECK FOR ERROR ON CALLED PGM
     C***        @TERM     IFEQ 'E'                        B1             S01166
     C***                  RETRN                           *1             S01166
     C***                  END                             E1             S01166
     C*                                                                   S01166
     C                     SETON                     LR                   S01166
     C                     RETRN                                          S01166
     C*
     C           #C9       ENDSR                           *** TAG #C9 ***
     C****************************************************************
      /EJECT
     C****************************************************************
     C*
     C*  SUBROUTINE: #A   - THIS ROUTINE IS THE INITIAL ROUTINE WHICH
     C*                     OPENS FILES SETS UP FIELD VALUES ETC.
     C*
     C*  FIELDS USED : @INITL INITIAL RUN OF PROGRAM FLAG
     C*                @K1    PART OF DATA STRUCTURE KEY FOR S/FDCCYTLL
     C*                @K20   PART OF DATA STRUCTURE KEY FOR S/FDCCYTLL
     C*                @P     BASE CCY DECIMAL PLACES - 1
     C*                AMENQ  DATA AREA AMENQ2AA
     C*                DBPGM  PROGRAM NAME FOR DB ERROR OUTPUT OF LDA
     C*
     C*  FIELDS INPUT :
     C*
     C*  CALLED BY : MAIN PROGRAM
     C*
     C*  CALLS     : ZA0870  STANDARD SR. TO RETRIEVE BASE CCY AND D.P
     C*
     C****************************************************************
     C           #A        BEGSR
      *                                                                   S01194
      * Get Bank's details from SDBANKPD via Access Object                S01194
      * (Note that *DBERR is used as standard return code although        S01194
      * this will not normally produce a DB error due to access           S01194
      * object having already been called in SD1600)                      S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
      *                                                                   S01194
     C**  DATA AREA NAMES
     C***        *NAMVAR   DEFN AMENQ1AA  AMENQ                           S01166
     C*
     C** READ DATA AREA - RUNDAT                                          S01277
     C           *NAMVAR   DEFN           RUNDAT                          S01277
     C                     IN   RUNDAT                                    S01277
     C*                                                                   S01277
     C**  SET UP PROGRAM NAME FOR DB ERROR
     C**********           MOVEL'DL3150'  DBPGM                    S01166 S01117
     C                     MOVEL'TM3150'  DBPGM                           S01117
     C*                                                                   S01166
     C**  Key list for access of FXCRSCLL (partial key).                  S01277
     C*                                                                   S01277
     C           @CKEY1    KLIST                                          S01277
     C                     KFLD           DDPCCY                          S01277
     C*                                                                   S01277
     C**  Key list for access of FXCRSCLL (full key).                     S01277
     C*                                                                   S01277
     C           @CKEY2    KLIST                                          S01277
     C                     KFLD           DDPCCY                          S01277
     C                     KFLD           @CSCCY  3                       S01277
     C*                                                                   S01277
     C**  Key list for access of FXEPOCLL.                                S01277
     C*                                                                   S01277
     C           @EPKEY    KLIST                                          S01277
     C                     KFLD           @CSCCY  3                       S01277
     C                     KFLD           DDPCCY                          S01277
     C*                                                                   S01277
     C**  Set on Message Subfile end indicator.                           S01166
     C                     SETON                     40                   S01166
     C*                                                                   S01166
     C**  Initialise screen msg queue.                                    S01166
     C                     MOVEL'*'       DDPGMQ                          S01166
     C*                                                                   S01166
     C**  Move workstation ID to screen field.                            S01166
     C                     MOVEL@JOB      DDWSID                          S01166
     C*                                                                   S01166
     C*
     C*****SET*UP*KEY*FOR*ACCESS*TO*S/FDCCYTLL***                         S01194
     C**********           MOVE '1'       @K1                             S01194
     C**********           MOVE '20'      @K20                            S01194
     C*                                                                   S01166
     C*********************OPEN*FDUSSILL****************************S01166S01319
     C                     OPEN MUSER                                     S01319
     C**************************************************************S01166S01319
     C*********************MOVEL@USER*****@USER3**3*****************S01166S01319
     C**************************************************************S01166S01319
     C***********@USER3****CHAINFDUSSIP0*************71*************S01166S01319
     C**************************************************************S01166S01319
     C**db*err*if*user*not*found************************************S01166S01319
     C************IN71*****IFEQ*'1'************************B1*******S01166S01319
     C*********************MOVE*'929'*****DBASE*************1******S01166*S01319
     C*********************MOVE*'FDUSSILL'DBFILE************1*******S01166S01319
     C*********************MOVEL@USER3****DBKEY*************1**ERRO*S01166S01319
     C*********************MOVE*'1'********INU7*************1***929*S01166S01319
     C*********************MOVE*'1'********INU8*************1*******S01166S01319
     C*********************GOTO*#A9*************************1*******S01166S01319
     C*********************END*****************************E1*******S01166S01319
     C*                                                                   S01166
     C           @USER     CHAINMUSER                71                   S01319
     C*                                                                   S01319
     C           *IN71     IFEQ '1'                        B1             S01319
     C*                                                                   S01319
     C                     MOVEL'MUSER'   DBFILE           ***************S01319
     C                     MOVE '929'     DBASE            *             *S01319
     C                     MOVEL@USER     DBKEY            * DBERROR 929 *S01319
     C                     MOVE '1'       *INU7                           S01319
     C                     MOVE '1'       *INU8            ************** S01319
     C                     GOTO #A9                                       S01319
     C*                                                                   S01319
     C                     END                             E1             S01319
     C* do file overide before open                                       S01166
     C***********USREF*****IFEQ*'Y'                        B2       S01166S01319
     C           AURF      IFEQ 'Y'                        B2             S01319
     C                     MOVEL@OVR,1    @OVRID           *2             S01166
     C*********************Z-ADDUSRFPD****@WAIT*************2*******S01166S01319
     C                     Z-ADDREFP      @WAIT            *2             S01319
     C                     Z-ADD36        QCALEN 155       *2             S01166
     C*********************CALL 'QCAEXEC'                  *2       S01166E20774
     C                     CALL 'QCMDEXC'                  *2             E20774
     C                     PARM           @OVRID           *2             S01166
     C                     PARM           QCALEN           *2             S01166
     C                     END                             E2             S01166
     C*                                                                   S01166
     C**********           OPEN DL3150DD                           S01166 S01117
     C                     OPEN TM3150DD                                  S01117
     C*                                                                   S01166
     C*
     C**  OPEN S/FXEPOSLL
     C                     OPEN FXEPOSLL
     C*
     C**  OPEN S/FX38CPLL
     C*                    OPEN FX38CPLL
     C***                  OPEN CA38CPLL                                  S01166
     C*
     C****OPEN*OF*S/FDCCYTLL*IS*DONE*BY*ZA0870**STANDARD*SR***            S01194
     C*
     C**  RETRIEVE BASE CCY
     C                     EXSR ZA0870
     C*
     C**  SET UP P/L CONVERSION TO UNITS FIELD
     C           4         SUB  @@NDPB    @P      10
     C*
     C           *LIKE     DEFN @@NDPB    @NDPB                           S01166
     C*                                                                   S01166
     C**  CHECK FOR U7,U8 SETON IN STANDARD SR.
     C           *INU7     IFEQ '1'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C*                                                                   S01166
     C                     SETOF                     30                   S01166
     C*                                                                   S01166
     C**  SET ON FIRST CALL OF PROGRAM FLAG
     C***                  MOVE '1'       @INITL  1                       S01166
     C*                                                                   S01166
     C** INITIALISE THE NO RECORDS ON FILE FIELD.                         E18284
     C                     MOVE 'N'       @NOREC  1                       E18284
     C*                                                                   S01166
     C***  Initialise fields used in ZA subroutines                       S01277
     C**                                                                  S01277
     C                     MOVE *BLANK    @@CC1D  1                       S01277
     C                     MOVE *BLANK    @@CC2D  1                       S01277
     C                     MOVE *BLANK    @@CC1W  1                       S01277
     C                     MOVE *BLANK    @@CC2W  1                       S01277
     C                     MOVE *ZEROS    @@MNOL  50                      S01277
     C                     MOVE *BLANKS   @@CCYL  3                       S01277
     C                     MOVE *ZEROS    @@VDTL  80                      S01277
     C                     MOVE *BLANKS   @@CCYP  3                       S01277
     C                     MOVE *ZEROS    @@VDTP  80                      S01277
     C*                                                                   S01277
     C**  Define program work fields with reference to file fields.       S01277
     C**                                                                  S01277
     C           *LIKE     DEFN A6SPDY    @@WSP1                          S01194
     C           *LIKE     DEFN A6SPDY    @@WSP2                          S01194
     C           *LIKE     DEFN A6FXSD    @@SPD1                          S01194
     C           *LIKE     DEFN A6FXSD    @@SPD2                          S01194
     C           *LIKE     DEFN A6HSRT    @HISP1                          S01194
     C           *LIKE     DEFN A6HSRT    @HISP2                          S01194
     C           *LIKE     DEFN A6LSPR    @LOSP1                          S01194
     C           *LIKE     DEFN A6LSPR    @LOSP2                          S01194
     C           *LIKE     DEFN A6NBDP    @CDP1                           S01194
     C           *LIKE     DEFN A6NBDP    @CDP2                           S01194
     C           *LIKE     DEFN A6DPBF    @DPBF1                          S01194
     C           *LIKE     DEFN A6DPBF    @DPBF2                          S01194
     C           *LIKE     DEFN A6NQDP    @NQDP1                          S01194
     C           *LIKE     DEFN A6NQDP    @NQDP2                          S01194
     C           *LIKE     DEFN A6MDEX    @XRMD1                          S01194
     C           *LIKE     DEFN A6MDEX    @XRMD2                          S01194
     C           *LIKE     DEFN XPPRDD    @@SPDD                          S01277
     C           *LIKE     DEFN @@MDI1    @@MDI2                          S01277
     C           *LIKE     DEFN A6HSRT    @XR1                            S01194
     C           *LIKE     DEFN A6LSPR    @XR2                            S01194
     C           *LIKE     DEFN XPCCY     @@XCCY                          S01277
     C           *LIKE     DEFN XPPRDD    @@XPRD                          S01277
     C           *LIKE     DEFN XPTPRD    @@XTPR                          S01277
     C           *LIKE     DEFN XPLOPT    @@XLOP                          S01277
     C           *LIKE     DEFN XPHIPT    @@XHIP                          S01277
     C           *LIKE     DEFN XPPRDD    @@XPCC                          S01277
     C           *LIKE     DEFN XPLOPT    @@XPLP                          S01277
     C           *LIKE     DEFN XPHIPT    @@XPHP                          S01277
     C**
     C           #A9       ENDSR                           *** TAG #A9 ***
     C****************************************************************
     C/EJECT                                                              S01166
      *****************************************************************
      *                                                               *
      *       TITLE:RETRIEVE NO.OF DECIMAL POSITIONS FOR BASE         *
      *             CURRENCY DEALING.                                 *
      *                                                               *
     C********SUBROUTINE*ZA0870*WILL*ACCESS*'FDINSTLL'.*THE*BASE**********S01319
      *       SUBROUTINE ZA0870 WILL ACCESS 'SDDEALPP'. THE BASE      *   S01319
      ********CURRENCY*CODE*IS*THEN*USED**TO*ACCESS*FILE*"FDCCYTLL"****   S01194
      *       CURRENCY CODE IS THEN USED  TO ACCESS FILE SDCURRPD     *   S01194
      *       (VIA ACCESS OBJECT AOCURRR0)                            *   S01194
      *       TO PICK UP NUMBER OF DECIMALS FOR BASE CURRENCY WHICH   *
      *       IS THEN STORED IN THE FIELD @@NDPB.                     *
      *                                                               *
      *       This process is only EXSR'ed from a 'Top Level' Program *
      *       not in Common (ZA) routines, where it is considered     *
      *                                          'Expected'           *
      *       This routine runs at First Cycle Only and should only   *
      *       run once.                                               *
      *                                                               *
      *
     C*****************************************************************
     C*                                                               *
     C********FIELDS*USED*:*IDCYDL*-*CURRENCY*CODE*FROM*FDINSTLL**********S01319
     C*       FIELDS USED : BNCYDL - CURRENCY CODE FROM SDDEALPD      *   S01319
     C*                     @@NDPB - NO.OF DEC.PLACES IN BASE CURR.   *
     C*                                                               *
     C********INPUT*FIELDS:*IDCYDL****************************************S01319
     C*       INPUT FIELDS: BNCYDL                                    *   S01319
     C*                                                               *
     C*       OUTPUT FIELD: @@NDPB                                    *
     C*                                                               *
     C*   CHECKS MADE ARE :                                           *
     C*                                                               *
     C*   A) IF RECORD NOT FOUND ON LOGICAL FILE 'FDCCYDL' OR         *
     C*          'FDINSTLL' SETON INDICATORS U7 , U8 & 80             *
     C*            AND EXIT                                           *
     C*      ELSE                                                     *
     C*           STORE CDP IN FIELD @@NDPB.                          *
     C*                                                               *
     C*****************************************************************
     C*
     C           ZA0870    BEGSR
     C*
     C********** *LIKE     DEFN CDP       @@NDPB                          S01194
     C           *LIKE     DEFN A6NBDP    @@NDPB                          S01194
     C                     Z-ADD0         @@NDPB
      *
     C***Access*Installation*control*data*for*Base*Currency*Dealing.******S01319
     C*********************OPEN*FDINSTLL**********************************S01319
     C***********1*********SETLLFDINSTLL**********************************S01319
     C*********************READ*FDINSTLL*****************80***************S01319
     C********************************************************************S01319
     C************IN80*****IFEQ*'1'************************B1*************S01319
     C*********************SETON*********************U7U8***1*************S01319
     C*********************MOVEL'FDINSTLL'DBFILE************1*************S01319
     C*********************MOVEL'922'*****DBASE*************1*************S01319
     C*********************MOVEL*BLANKS***DBKEY*************1*************S01319
     C*********************GOTO*ZA0879************************************S01319
     C*********************END********************************************S01319
     C** Access Deal details via access program                           S01319
      *  (database error handling done in access program)                 S01319
     C**********           CALL 'AODEALR0'                                             S01319 CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01319
     C                     PARM '*FIRST ' @OPTN   7                       S01319
     C********** SDDEAL    PARM SDDEAL    DSFDY                                        S01319 CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
      *
     C**********           MOVEL'20      '@@1200 12                       S01194
     C**********           MOVE '1'       @@1201  4                       S01194
     C**********           MOVELIDCYDL    @@1201                          S01194
     C**********           MOVE @@1201    @@1200                          S01194
      **********                                                          S01194
      ***Access*Currency*file*for*Base*decimal*places***                  S01194
     C**********           OPEN FDCCYTLL                                  S01194
     C********** @@1200    CHAINFDCCYTLL             80                   S01194
      **********                                                          S01194
     C********** *IN80     IFEQ '1'                        B1             S01194
     C**********           SETON                     U7U8  *1             S01194
     C**********           MOVEL'FDCCYTLL'DBFILE           *1             S01194
     C**********           MOVEL'921'     DBASE            *1             S01194
     C**********           MOVEL@@1200    DBKEY            *1             S01194
     C**********           GOTO ZA0879                                    S01194
     C**********           END                                            S01194
     C*                                                                   S01194
      * Set up currency parameter for call to Access Object               S01194
     C*********************MOVELIDCYDL****@KCCY***3*****************S01194S01319
     C                     MOVELBNCYDL    @KCCY   3                       S01319
      *                                                                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @KCCY                           S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
      *
     C**********           Z-ADDCDP       @@NDPB
     C                     Z-ADDA6NBDP    @@NDPB
     C*
     C           ZA0879    ENDSR
     C*****************************************************************
      /EJECT
     C****************************************************************
     C*
     C*  SUBROUTINE: #BA  - THIS ROUTINE IS RUN WHEN A DATABASE
     C*                     HAS OCCURED
     C*
     C*  CALLED BY : #B
     C*
     C*  FIELDS OUTPUT : LDA   LOCAL DATA AREA (AUTOMATICALLY ON LR)
     C*
     C****************************************************************
     C           #BA       BEGSR
     C*
     C***                  MOVE 'E'       @TERM                           S01166
     C                     MOVE '1'       *INU7                           S01166
     C                     MOVE '1'       *INU8                           S01166
     C                     MOVE '1'       *INLR
     C                     DUMP                                           S01277
     C                     RETRN                                          S01166
     C*
     C           #BA9      ENDSR                           *** TAG #BA9 **
     C****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: INFSR  - Handle error on file handling.          *
     C*                                                               *
     C*  FIELDS USED:        @ERR2  - Field to prevent looping.       *
     C*                                                               *
     C*  CALLED BY :                                                  *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           INFSR     BEGSR
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C***                  MOVE 'E'       @TERM                           S01166
     C*
     C**  Set up fields in local data area.
     C                     MOVEL@FILE     DBFILE
     C**********           MOVEL'DL3150'  DBPGM                    S01166 S01117
     C                     MOVEL'TM3150'  DBPGM                           S01117
     C                     MOVEL'006'     DBASE
     C                     DUMP
     C*
     C**  Terminate processing immediately.
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C           INFSR9    ENDSR                           **INFSR9**
     C*                                                               *
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: *PSSR - Error handling subroutine.               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*  CALLED BY : This routine is called if there are any program  *
     C*              or file errors.                                  *
     C*  CALLS :                                                      *
     C*                                                               *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C**  Set @ERR1 to 'Y' to prevent looping if further errors occur.
     C           @ERR1     IFNE 'Y'                        B1
     C*
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
     C***                  MOVE 'E'       @TERM            *1             S01166
     C*
     C**  Set up fields in local data area.
     C**********           MOVEL'DL3150'  DBPGM            *1      S01166 S01117
     C                     MOVEL'TM3150'  DBPGM            *1             S01117
     C                     MOVEL'005'     DBASE            *1
     C                     DUMP                            *1
     C*
     C                     END                             E1
     C*
     C**  Terminate processing immediately.
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C           #PSSR9    ENDSR                           *** TAG #PSSR9
**  @DP  DECIMAL PLACES CORRECTION ARRAY
1000000010000000100000001000000010000000100000001
** @OVR  CL COMMAND FOR CALL TO QCMDEXC                             S01166E20774
OVRDSPF FILE(TM3150DD) WAITRCD(9999)                                S01166S01117
** Scaling factors array - @SF
0000000001
0000000010
0000000100
0000001000
0000010000
0000100000
0001000000
0010000000
0100000000
1000000000
** @YD  USED BY SR. ZA0710 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZA0710 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** @@AY   - Array of powers of 10.
0000000001
0000000010
0000000100
0000001000
0000010000
0000100000
0001000000
0010000000
0100000000
1000000000
** @IN   USED TO INITIALISE SCALE RATE TO 99999.99999999
9999999999999
** ERROR DESCRIPTION  - @TXT
HIGH/LOW RATE UNABLE TO SCALE
** CPY@ - COPYRIGHT STATEMENT                                             S01117
(c) Finastra International Limited 2001
** @TTL  Titles array for cross/base ccy titles                           S01277
OPEN POSITION - ALL CURRENCIES                                            S01277
CROSS CURRENCY POSITION -                                                 S01277
OPEN POSN                                                                 S01277
CROSS POSN                                                                S01277
COR BCE                                                                   S01277
COR CCE                                                                   S01277
NET BCE                                                                   S01277
NET CCE                                                                   S01277
