     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MM Book Daily Summary Enqy (was DL3190)')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Treasury Management Module                       *
     F*                                                               *
     F*  TM3190 - MM FORWARD BOOK - DAILY SUMMARY.                    *
     F*           (FORMERLY DL3190)                                   *
     F*                                                               *
     F*  Function: This enquiry shows cash value date and maturity    *
     F*  (I/C)     date cash flow movements for each day forward      *
     F*            including today.                                   *
     F*                                                               *
     F*  Called by: TMC0311 - TM Enquiry control                      *
     F*        via: DL3100  - Treasury management controller          *
     F*                                                               *
     F*  Calls    : ZA0250  - Clear program message queue.            *
     F*           : ZA0240  - Display program message queue.          *
     F*           : ZA0270  - Convert date to Midas day number.       *
     F*                                                               *
     F*  Linked enquiries: TM3180 - MM Monthly summary                *
     F*                    TM3200 - MM Daily deals                    *
     F*                    DL0170 - MM Deal details                   *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Last Amend No. CRE026             Date 09Jun06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 TDA035             Date 02Apr04               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 04Oct01               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 065473             Date 22Jun94               *
     F*                 S01319             DATE 06JAN92               *
     F*                 E28491             DATE 24SEP91               *
     F*                 E26595             DATE 06SEP91               *
     F*                 S01319             DATE 14AUG91               *
     F*                 S01280             DATE  2APR91               *
     F*                 S01194             DATE 30OCT90               *
     F*                 S01117             DATE 30OCT90               *
     F*                 E20774             DATE 15MAR90               *
     F*                 S01199             DATE 28FEB90               *
     F*                 E21044             DATE 14FEB90               *
     F*                 E20001             DATE 23NOV89               *
     F*                 E19844             DATE 07NOV89               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CRE026 - Consumer Banking                                    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CPK014 - Release 4 packaging.  Rename of field which is too  *
      *           long for OPM program.                               *
     F*  065473 - The market rate displayed is completely false for   *
     F*           certain dates.  Field COEF in subroutine MM1002 is  *
     F*           changed to be larger, from 6N to 15N.               *
     F*  S01319 - (HY0029) Bring in values for literals for           *
     F*           display file from multi-language message file.      *
     F*           This replaces fix E28491.                           *
     F*  E28491 - IBM feature/omission will not show literals on      *
     F*           subfile after multilanguage compile.                *
     F*  E26595 - S01280 uses @OPT in position 17 to 19 in @PRAM      *
     F*           in DL3100 which is already used by the FRA/IRS      *
     F*           enquiry programs. Change to position 50 onwards     *
     F*           in @STRNG.                                          *
     F*  S01319 - Remove redundant processing                         *
     F*  S01280 - Include FRA,IRS,FUTURES and CUSTOMER LENDING        *
     F*  AND:   - REPLACE 'CASH/GAP' TEXT, IT IS MISLEADING           *
     F*         - CLOSED P/L CALCULATION GETS WRONG SIGN              *
     F*         - CLEAR INTEREST TOTALLING FIELD IF NO INT.           *
     F*         - Net balance field displaying wrong total            *
     F*         - CLEAR LNKED ENQ PARMS                               *
     F*         - PREVENT DISPLAY OF MRK RATES PRIOR TO SPOT          *
     F*         - INHIBIT F12 IF NO DETAILS TO DISPLAY FOR            *
     F*           CCY/DATE COMBINATION SELECTED                       *
     F*         - START/END FIELD IN HEADER DISPLAYED AS 'STEND'      *
     F*           IF NO RECORDS ON FILE FOR A NEW CURRENCY            *
     F*         - EXISTING SUBFILE BEING CLEARED FROM SCREEN IF       *
     F*           INVALID CURRENCY ENTERED                            *
     F*         - IF CURRENCY CHANGED AND RECORDS EXIST FOR           *
     F*           CHOSEN CURRENCY BUT NOT FOR CHOSEN DEAL TYPE,       *
     F*           NO ERROR MESSAGE DISPLAYED. INSTEAD BLANK           *
     F*           SUBFILE DISPLAYED WITH ROLLUP/ROLLDOWN KEYS         *
     F*           DISABLED, CAUSING ERROR IF THESE ARE ATTEMPTED      *
     F*         - IF CURRENCY SELECTED HAS NO RECORDS TO DISPLAY      *
     F*           THE SUBFILE IS CLEARED BUT HEADER CURRENCY AND      *
     F*           DEAL TYPES STILL DISPLAYED AS FOR PREVIOUS          *
     F*           SELECTION                                           *
     F*  S01117 - NEW COPYRIGHT STATEMENT                             *
     F*           DEALING PROGRAMS USED ONLY IN TREASURY MGMT.        *
     F*           MODULE NOW PREFIXED WITH 'TM'                       *
     F*  S01194 - NEW STANDING DATA PROCESSING                        *
     F*  E20774 - REPLACE QCAEXEC WITH QCMDEXC                        *
     F*  S01199 -  HELP SYSTEM.                                    *
     F*  E21044 - Program fell over when enter pressed with no        *
     F*           details. Check on work ccy field corrected.         *
     F*  E20001 - a) The daily interest amount is displayed 10X       *
     F*              larger than the actual amount.                   *
     F*           b) The most significant figure for the market       *
     F*              rate is missed out if the no. of decimal         *
     F*              places for the rate is = 7,and the value is      *
     F*              > 10.                                            *
     F*           c) Change the No. of decimal places to 4 for        *
     F*              Cost to close Rate.                              *
     F*  E19844 - COST TO CLOSE,MARKET RATES AND P/L = ZERO           *
     F*           FOR DATE UP TO AND INCLUDING SPOT.                  *
     F*                                                               *
     F*****************************************************************
     F*
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*       01         EXIT PROGRAM
     F*       05         REFRESH SCREEN
     F*       10         HELP KEY HAS BEEN PRESSED
     F*       12         PROFITABILITY SCREEN                             S01280
     F*       15         PROTECT SELECT FIELD
     F*       25         ROLLUP REQUESTED
     F*       26         ROLLDOWN REQUESTED
     F*       27         INHIBIT ROLL KEYS
     F*
     F*       30         ACTIVATE SUBFILE END
     F*       35         ACTIVATE SUBFILE DISPLAY
     F*       36         ACTIVATE SUBFILE DISPLAY CONTROL
     F*
     F*       40         ACTIVATE MESSAGE SUBFILE END
     F*       41         CUSTOMER LENDING ON SYSTEM                       S01280
     F*       42         FRA/IRS ON SYSTEM                                S01280
     F*       43         FUTURES AND OPTIONS ON SYSTEM                    S01280
     F*       46         ACTIVATE MESSAGE SUBFILE DISPLAY CONTROL
     F*
     F*       60         ERROR ON CURRENCY SELECTED
     F*       61         ERROR ON DATE SELECTED
     F*       62         ERROR ON DEAL TYPES INCLUDED
     F*       63         ERROR ON INTERPOLATION METHOD
     F*       69         GENERAL ERROR ON VALIDATION OF PROMPT SCREEN
     F*
     F*       71         CHAIN AND DB ERROR INDICATOR
     F*       72         NO RECORDS ON FILE
     F*       U6         PROGRAM ERROR - *PSSR EXECUTED
     F*       U7         DATA BASE ERROR
     F*       U8         DATA BASE ERROR
     F*
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F*FDINSTLLIF**E*******************DISK***************************UC**S01319
     FFDINTDLLIF  E           K        DISK                           UC
     F***FDICDRLLIF**E*          K        DISK         KINFSR INFSR  UC   S01194
     F**********  TABTB11F                          KIGNORE               S01194
     F**********  TABTB20F                          KIGNORE               S01194
     F***FDCCYTLLIF**E*          K        DISK         KINFSR INFSR  UC   S01194
     FFDMNTHLLIF  E                    DISK         KINFSR INFSR      UC
     FMMFWDDLLIF  E           K        DISK         KINFSR INFSR      UC
     F*FDUSSILLIF**E**********K********DISK*********KINFSR*INFSR******UC**S01319
     FMUSER   IF  E           K        DISK         KINFSR INFSR      UC  S01319
     FDLMMTOLLIF  E                    DISK         KINFSR INFSR      UC  S01280
     F***DL3190DDCF**E*                   WORKSTN                    UC   S01117
     F**********                              RRN   KSFILE DL3190S1       S01117
     F**********                                    KNUM        1         S01117
     FTM3190DDCF  E                    WORKSTN                        UC  S01117
     F                                        RRN   KSFILE TM3190S1       S01117
     F                                        RRN   KSFILE TM3190S2       S01280
     F                                              KNUM        1         S01117
     E*
     E** ARRAY TO HOLD CALCULATED DATES
     E                    @CD        16  8 0
     E*
     E**  ARRAY FOR SR. ZA0710 - CUMULATIVE DAYS IN YEAR FOR 4 YEAR PERIOD
     E                    @YD     4   4  5 0A
     E*
     E**  ARRAY FOR MONTH SHORTNAMES                                   IOD
     E                    @MT        12  3
     E*
     E*   ARRAY FOR DISPLAY AMOUNT (SIGNED)(MM1016)
     E                    @A         13  1
     E*
     E*   ARRAY FOR RATE TO DISPLAY SUBROUTINE #ZH                        S01280
     E                    @B          9  1                                S01280
     E*
     E*   ARRAY FOR RATE TO DISPLAY SUBROUTINE MM1017
     E                    @W         13  1
     E*
     E**  ARRAY FOR SR. ZA0710 - CUMULATIVE DAYS IN YEAR PER MONTH
     E                    @MD    13  13  5 0A
     E*
     E****Array*of*scaling*factors****                                    S01280
     E*   Array to remove decimals from total/open/closed p/l             S01280
     E**********          @SF     1  10 10 0                              S01280
     E                    @CP     1   5 10 0                              S01280
     E*
     E*   ARRAY FOR AMOUNT INPUT - MM1015
     E                    @D         15  1
     E*
     E*   ARRAY FOR DISPLAY AMOUNT - MM1015
     E                    @J         12  1
     E*
     E**  ARRAY TO HOLD OUTPUT AMOUNT FOR ZA0860
     E                    @K         16  1
      *                                                                   S01280
      **  Array to hold trade types (for display).                        S01280
     E                    @C          6  4                                S01280
     E*                                                                   S01280
     E**  Array to hold workfields from @STORE.                           S01280
     E                    @H         16241                                S01280
     E*                                                                   S01280
     E**  Array to hold workfields from @STOR1.(SECOND WORKFIELD ARRAY)   S01280
     E                    @I         16 45                                S01280
     E*
     E****ARRAY*TO*SET*UP*PARAMETER*FOR*CALL*TO*QCAEXEC                   E20774
     E**  ARRAY TO SET UP PARAMETER FOR CALL TO QCMDEXC                   E20774
     E                    @OVR    1   1 36
     E*                                                                   S01117
     E                    CPY@    1   1 80                                S01117
     E* Copyright array                                                   S01117
     E****************************                                  E28491S01319
     E********************@TXT****1   1 18                          E28491S01319
     E**Array*for*literals*on*format*TM3190C1*                      E28491S01319
      *                                                                                       CPK014
     IFDINTRP0                                                                                CPK014
     I              HWTMESTMP                       HWTMST                                    CPK014
     I*
     I**  RENAME FIELDS ON FDMNTHLL AS ARRAY
     IFDMNTHP0
     I              MNNM1                           @MT,1
     I              MNNM2                           @MT,2
     I              MNNM3                           @MT,3
     I              MNNM4                           @MT,4
     I              MNNM5                           @MT,5
     I              MNNM6                           @MT,6
     I              MNNM7                           @MT,7
     I              MNNM8                           @MT,8
     I              MNNM9                           @MT,9
     I              MNNM10                          @MT,10
     I              MNNM11                          @MT,11
     I              MNNM12                          @MT,12
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@Z71Y
     I            DS
     I                                        1   40@@Z71Y
     I                                        1   10@@SSY1
     I                                        2   20@@SSY2
     I                                        3   30@@SSY3
     I                                        4   40@@SSY4
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@VDT
     I            DS
     I                                        1   80@@VDT
     I                                        1   40@@YR
     I                                        5   60@@Z71M
     I                                        7   80@@Z71D
     I*
     I** DATASTUCTURE TO CONVERT @@IAMT DECIMAL FIELD TO ALPHA FIELD
     I*  FOR SUBROUTINE MM1015
     I@@AMDS      DS                             15
     I                                        1  150@@IAMT
     I**  DATA STRUCTURE FOR SR. ZA0720 - DATE INPUT TO SUBROUTINE
     I            DS
     I                                        1   80@@DTIN
     I                                        1   40@@YYYY
     I                                        3   40@@YY
     I                                        1   20@@CC
     I                                        5   60@@MTH
     I                                        7   80@@DAY
     I*
     I****D/S*TO*HOLD*CURRENT*PROMPT***                                   S01280
     I**********                                                          S01280
     I**********  DS                                                      S01280
     I**********                              1   7 @CPDAY                S01280
     I**********                              1   20@DD                   S01280
     I**********                              3   5 @MMM                  S01280
     I**********                              6   70@YY                   S01280
     I**********                              6   7 @YYA                  S01280
     I*
     I**  DATA STRUCTURE TO SUBDIVIDE ROLL/REFRESH INPUT PARAMETER
     I                                        1   80@RRFSH
     I                                        1   40@RRYR
     I                                        5   60@RRMTH
     I                                        7   80@RRDAY
     I**  DATE FORMAT DATA STRUCTURE
     I*
     I            DS                              8
     I                                        1   80@DTIN
     I                                        1   40HSFBYY
     I                                        5   60HSFBMM
     I                                        7   80HSFBDD
     I**  D/S to provide date breakdown for MMFWDDLL KLIST
     I            DS
     I                                        1   80@KDATE
     I                                        1   40@KCCYY
     I                                        5   60@KMM
     I                                        7   80@KDD
     I**  INPUT TO EDIT DATA STRUCTURE
     I            DS
     I                                        1   80@GDATE
     I                                        1   40@CCYY
     I                                        5   60@MM
      *                                                                   S01280
     I**  DATA STRUCTURE TO CONVERT RECORD FOUND DATE FROM DDMMMYY TO     S01280
     I**  YYYYMMDD.                                                       S01280
     I            DS                                                      S01280
     I                                        1   80@RDATE                S01280
     I                                        1   40@RCYY                 S01280
     I                                        5   60@RMM                  S01280
     I*
     I** DATA STRUCTURE FOR INPUT PARAMETERS (SUBDIVIDE DATE)
     I*
     I@STRNG      DS                            256
     I                                        1   3 @STCCY
     I                                        4   5 @STDAY
     I                                        6   8 @STMTH
     I                                        9  10 @STYR
     I                                       11  160@STDNO
     I******************                     17  19 @STTYP                E26595
     I******************                     20  20 @LKNA           S01280E26595
     I******************                     21  21 @LKLD           S01280E26595
     I******************                     22  22 @LKLEN          S01280E26595
     I******************                     23  23 @LKFRA          S01280E26595
     I******************                     24  24 @LKIRS          S01280E26595
     I******************                     25  25 @LKFUT          S01280E26595
     I******************                     26  26 @LKALL          S01280E26595
     I                                       50  52 @STTYP                E26595
     I                                       53  53 @LKNA                 E26595
     I                                       54  54 @LKLD                 E26595
     I                                       55  55 @LKLEN                E26595
     I                                       56  56 @LKFRA                E26595
     I                                       57  57 @LKIRS                E26595
     I                                       58  58 @LKFUT                E26595
     I                                       59  59 @LKALL                E26595
     I                                       20 256 @STREM
     I*
     I*
     I@PRMCP      DS                             19
     I*
     I** DATA STRUCTURE FOR PROMPT FIELDS FOR CONTROL PROGRAM
     I*
     I*
     I                                        1   3 @CPCCY
     I                                        4  10 @CPDAT
     I                                       11  16 @CPDNO
     I**********                             17  19 @CPTYP                S01280
     I*
     I@SRDAT      DS
     I*
     I*   DATA STRUCTURE FOR PROMPT DATE
     I                                        1   2 @SRDAY
     I                                        3   5 @SRMTH
     I                                        6   7 @SRYR
      *                                                                   S01280
     I@SDATE      DS                                                      S01280
     I*                                                                   S01280
     I*   DATA STRUCTURE USED TO HOLD DATE OF RECORD FOUND FROM           S01280
     I*   DATA STRUCTURE @STORE.                                          S01280
     I                                        1   2 @RECDD                S01280
     I                                        3   5 @RECMM                S01280
     I                                        6   7 @RECYY                S01280
     I*                                                                   S01280
     I            DS                                                      S01280
     I*   DATA STRUCTURE FOR PASSING DATE INPUT FOR VALIDATION(ZA0270)    S01280
     I                                        1   2 @@DD                  S01280
     I                                        3   40@@MM                  S01280
     I                                        5   6 @@YEAR                S01280
     I                                        1   60@@DMYY                S01280
     I*
     I@WORK       DS
     I*
     I** DATA STRUCTURE FOR DISPLAY FIELDS
     I*
     I**********                              1   9 DDIN                  S01280
     I**********                             10  18 DDOUT                 S01280
     I**********                             19  33 DDNET                 S01280
     I**********                             34  42 DDCTC                 S01280
     I**********                             43  52 DDMKT                 S01280
     I**********                             53  63 DDPLU                 S01280
     I                                        1   9 DDMIN                 S01280
     I                                       10  18 DDMUT                 S01280
     I                                       19  27 DDVIN                 S01280
     I                                       28  36 DDVUT                 S01280
     I                                       37  45 DDNET1                S01280
     I                                       46  54 DDINT                 S01280
     I                                       55  63 DDBAL                 S01280
     I                                       64  71 DDMATI                S01280
     I                                       72  80 DDAVIN                S01280
     I                                       81  88 DDMATO                S01280
     I                                       89  97 DDAVOT                S01280
     I                                       98 106 DDNET                 S01280
     I                                      107 116 DDMKT                 S01280
     I                                      117 127 DDPLU                 S01280
     I*
     I**@MMNET****  DS                                                    S01280
     I**********                                                          S01280
     I****DATA*STRUCTURE TO SUBDIVIDE DDNET                               S01280
     I**********                              1   9 @NET                  S01280
     I**********                             10  10 @SLSH                 S01280
     I**********                             11  15 @INT                  S01280
     I**********                                                          S01280
     I**@DSLDN****  DS                          3                         S01280
     I**********                                                          S01280
     I****DATA*STRUCTURE TO SUBDIVIDE INPUT DEAL TYPE - TO REMOVE '/'     S01280
     I**********                              1   3 @DTYPE                S01280
     I**********                              1   1 @LNCH                 S01280
     I**********                              3   3 @DACH                 S01280
     I*
     I** DATA STRUCTURE TO HOLD INFORMATION ON DATABASE ERROR.
     I           UDS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 183 DBASE
     I*
     I@OVRID      DS                             36
     I*
     I*   DATA STRUCTURE FOR COMMAND IN ARRAY @OVR
     I                                       32  350@WAIT
     I@LTONT      DS                             23                       S01280
     I**  Data structure for DLMMTOLL title(1).                           S01280
     I                                        1  13 @LTON                 S01280
     I                                       14  15 @BLNK                 S01280
     I                                       16  170@SEC                  S01280
     I                                       18  18 @DASH1                S01280
     I                                       19  200@MIN                  S01280
     I                                       21  21 @DASH2                S01280
     I                                       22  230@HOUR                 S01280
     I@TOIP       DS                             23                       S01280
     I**  Data structure for DLMMTOLL title(2).                           S01280
     I                                        1  13 @TKON                 S01280
     I                                       14  15 @PR                   S01280
     I                                       16  23 @OGR                  S01280
     I            DS                                                      S01280
     I**  Data structure for DLMMTOLL time.                               S01280
     I                                        1   20@@SEC                 S01280
     I                                        3   40@@MIN                 S01280
     I                                        5   60@@HOUR                S01280
     I                                        1   60TOTLTO                S01280
     I@STORE      DS                                                      S01280
     I**  Data structure to hold work amounts.                            S01280
     I**  (N.B @STOR1 ALSO REQUIRED AS LENGTH TOO LARGE FOR ARRAY @H)     S01280
     I                                        1  150@VIN                  S01280
     I                                       16  300@VOUT                 S01280
     I                                       31  450@VNET                 S01280
     I                                       46  608@SAVIN                S01280
     I                                       61  758@SAVOT                S01280
     I                                       76  900@SMAIN                S01280
     I                                       91 1050@MAOUT                S01280
     I                                      106 1200@IINT                 S01280
     I                                      121 1350@OBSI                 S01280
     I                                      136 1500@MNET                 S01280
     I                                      151 1650@CLOP                 S01280
     I                                      166 1800@OPNP                 S01280
     I                                      181 1958@CARAT                S01280
     I                                      196 2108@OARAT                S01280
     I                                      211 2257@MRATE                S01280
     I                                      226 232 @DATE                 S01280
     I                                      233 241 @DMKT                 S01280
     I@STOR1      DS                                                      S01280
     I**  Data structure to hold work amounts. (SECOND STORE ARRAY)       S01280
     I                                        1  152@CLOPL                S01280
     I                                       16  302@OPNPL                S01280
     I                                       31  452@TOTPL                S01280
     I@@DATE      DS                                                      S01280
     I**  Data structure used to output date down left hand side.      s. S01280
     I                                        1   2 @DAY                  S01280
     I                                        3   7 @SCRDT                S01280
     I*
     I** PROGRAM STATUS D/S TO HOLD FILE NAME FOR FILE ERROR.
     IPSDS       SDS
     I                                      201 208 @FILE
     I                                      244 253 @JOB
     I                                      254 263 @USER
     I*
     ISDCURR    E DSSDCURRPD                                              S01194
     I* External DS for Currency Details                                  S01194
     ISDBANK    E DSSDBANKPD                                              S01194
     I* External DS for Bank Details                                      S01194
     ISDMMOD    E DSSDMMODPD                                              S01194
     I* External DS for Module Details                                    S01194
     ISDDEAL    E DSSDDEALPD                                              S01319
     I** EXTERNAL DS FOR DEALING DETAILS                                  S01319
     IDSSDY     E DSDSSDY                                                 S01194
     I* DS used by Access Objects (long records)                          S01194
     IDSFDY     E DSDSFDY                                                 S01194
     I* DS used by Access Objects (short records)                         S01194
     C/EJECT
     C                     MOVEACPY@      BIS@   80                       S01117
     C*
     C**  Initial processing.
     C                     EXSR #A
     C*
     C**  Main processing
     C           *INLR     CASEQ'0'       #B
     C                     END
     C*
     C**  Termination processing
     C                     EXSR #C
     C*
     C           ENDPGM    TAG                             **ENDPGM**
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*  Index to subroutines - Order of listing due to frequency of  *
     C*                         usage.                                *
     C*                                                               *
     C****1.*#ZB****-*Edit*fields*for*display****                     *   S01280
     C*   1. #ZG    - Edit and fill subfile.                          *   S01280
     C*   2. MM1016 - Convert amount to display.                      *
     C*   3. MM1015 - Convert amount to display.                      *
     C*   4. ZA0860 - Convert amount to display.                      *
     C*   5. MM1000 - Calculate forward MM borrow and lend points.    *
     C*   6. MM1002 - Determine a broken date rate.                   *
     C*   7. MM1017 - Convert rate to display - no sign.              *
     C*   8. #B     - Main processing.                                *
     C*   9. #BA    - Read forwards processing.                       *
     C*   10.#BB    - Read backwards processing.                      *
     C*   11.#BC    - ENTER processing.                               *
     C*   12.#BD    - Rollup processing.                              *
     C*   13.#BE    - Rolldown processing.                            *
     C*   14.#ZE    - Access LF/MMFWDDLL.                             *
     C*   15.#ZA    - Reset Error indicators and clear message queue. *
     C*   16.ZA0720 - Convert YYYYMMDD to DDMMMYY or MMMDDYYYY.       *
     C*   17.#A     - Initial processing.                             *
     C*   18.#C     - Termination processing.                         *
     C****19*ZA0150***Accesses*ICD*file********************************   S01194
     C*   20.ZA0710 - Calculate YYYYMMDD from Midas day number.       *
     c*   21.ZA0680 - Convert Midas day number to YYYYMMDD.
     C*   22.#ZD    - Database file error handling sub- routine.      *
     C*   23.INFSR  - File error handling sub- routine.               *
     C*   24.*PSSR  - Program error handling sub- routine.            *
     C*   25.#ZF    - Totals processing.                              *   S01280
     C*   26.#ZH    - Convert rate to display - no sign.              *   S01280
     C*                                                               *
     C****************************************************************
     C/EJECT
     C****************************************************************    S01280
     C**********                                                     *    S01280
     C*****#ZB*EDIT FIELDS FOR DISPLAY                               *    S01280
     C*********CALLED BY  : #BA #BB                                  *    S01280
     C*********CALLS      :                                          *    S01280
     C**********                                                     *    S01280
     C*********WORK FIELDS:                                               S01280
     C**********          : @INT  - EDITED INTEREST                  *    S01280
     C**********          : @MKT  - EDITED MARKET RATE               *    S01280
     C**********          : @NET  - EDITED NET CURRENCY              *    S01280
     C**********          : @SLSH - SLASH FOR DEAL TYPE              *    S01280
     C**********                                                     *    S01280
     C****************************************************************    S01280
     C**********                                                          S01280
     C********** #ZB       BEGSR                                          S01280
     C**********                                                          S01280
     C**********           MOVE '0'       *IN15                           S01280
     C****Edit*date                                                       S01280
     C**********           MOVEL@DTIN     @@DTIN                          S01280
     C**********           EXSR ZA0720                                    S01280
     C**********           MOVE @@DATE    DDDAT                           S01280
     C**********                                                          S01280
     C****Edit*daily cash in - remove sign using the MOVEL op code        S01280
     C**********           Z-ADDHSDCIN    @@IAMT                          S01280
     C**********           MOVE CCY       @@CCY                           S01194
     C**********           MOVE A6CYCD    @@CCY                    S01194 S01280
     C**********           MOVE CDP       @@CDP                           S01194
     C**********           MOVE A6NBDP    @@CDP                    S01194 S01280
     C**********           EXSR MM1016                                    S01280
     C**********           MOVEL@@AMOU    @@IN   13                       S01280
     C**********           MOVE @@IN      DDIN                            S01280
     C**********                                                          S01280
     C****Edit*daily cash out                                             S01280
     C**********           Z-ADDHSDCOT    @@IAMT                          S01280
     C**********           EXSR MM1016                                    S01280
     C**********           MOVEL@@AMOU    @@OUT  13                       S01280
     C**********           MOVE @@OUT     DDOUT                           S01280
     C**********                                                          S01280
     C****Daily*net currency movement                                     S01280
     C**********           Z-ADDHSDNMT    @@IAMT                          S01280
     C**********           EXSR MM1016                                    S01280
     C**********           MOVE @@AMOU    @NET                            S01280
     C**********                                                          S01280
     C****Daily*net interest movement                                     S01280
     C****E20001 - HSDNIM IS STORED 10X BIGGER THAN ACTUAL AMOUNT  E20001 S01280
     C**********   DIV BY 10 TO OBTAIN THE ACTUAL INTEREST TO DISPLE20001 S01280
     C**********           Z-ADDHSDNIM    @@IAMT                   E20001 S01280
     C********** HSDNIM    DIV  10        @@DNIM 151H              E20001 S01280
     C**********           Z-ADD@@DNIM    @@IAMT    H              E20001 S01280
     C**********           EXSR MM1016                                    S01280
     C**********           MOVE @@AMOU    @INT                            S01280
     C**********                                                          S01280
     C**********           MOVE '/'       @SLSH                           S01280
     C**********           MOVE @MMNET    DDNET                           S01280
     C**********                                                          S01280
     C**********                                                          S01280
     C***Calculate market rates(check for database error in subroutine)   S01280
     C***From*spot to day in qustion.                                     S01280
     C********** @KDATE    IFGT MSPD                       B1      ME1123 S01194
     C********** @KDATE    IFGT A6MMSD                     B1      S01194 S01280
     C**********           MOVE @DTIN     @@VDT            *1             S01280
     C**********           MOVE @SRCCY    @@CCY            *1             S01280
     C**********           MOVE @INTM     @@INTM           *1             S01280
     C**********           MOVE MSPD      @@MSPD           *1      ME1160 S01194
     C**********           MOVE A6MMSD    @@MSPD           *1      S01194 S01280
     C**********           EXSR MM1000                     *1             S01280
     C********** *INU7     IFEQ '1'                        B*2            S01280
     C**********           EXSR #ZD                        **2            S01280
     C**********           END                             E*2            S01280
     C**********                                                          S01280
     C***If*net*movement is positive use lending rate                     S01280
     C**********            negative use borrowing rate                   S01280
     C********** HSDNMT    IFGE *ZERO                      B*2     ME2324 S01280
     C**********           Z-ADD@@LERC    @@INPR           **2            S01280
     C**********           Z-ADD@@INPR    @MKT   117       **2            S01280
     C**********           EXSR MM1017                     **2            S01280
     C****E20001 - SINCE THE LAST POSITION IN @@OUTR IS ALLWAYS = 'E20001 S01280
     C**********   REMOVING TRAILING BLANK TO GIVE ONE MORE DIGIT. E20001 S01280
     C**********           MOVE @@OUTR    DDMKT            **2     E20001 S01280
     C**********           MOVEL@@OUTR    @@C12  12        **2     E20001 S01280
     C**********           MOVE @@C12     DDMKT            **2     E20001 S01280
     C**********           ELSE                            X*2            S01280
     C********** HSDNMT    IFLT *ZERO                      B**3           S01280
     C**********           Z-ADD@@BORC    @@INPR           ***3           S01280
     C**********           Z-ADD@@INPR    @MKT             ***3           S01280
     C**********           EXSR MM1017                     ***3           S01280
     C****E20001 - SINCE THE LAST POSITION IN @@OUTR IS ALLWAYS = 'E20001 S01280
     C**********   REMOVING TRAILING BLANK TO GIVE ONE MORE DIGIT. E20001 S01280
     C**********           MOVE @@OUTR    DDMKT            ***3    E20001 S01280
     C**********           MOVEL@@OUTR    @@C12            ***3    E20001 S01280
     C**********           MOVE @@C12     DDMKT            ***3    E20001 S01280
     C**********           END                             E**3           S01280
     C**********           END                             E*2            S01280
     C***If*date is before spot date - display zero                       S01280
     C**********           ELSE                            X1             S01280
     C**********           Z-ADD*ZERO     @@INPR           *1             S01280
     C**********           Z-ADD@@INPR    @MKT             *1             S01280
     C**********           EXSR MM1017                     *1             S01280
     C****E20001 - SINCE THE LAST POSITION IN @@OUTR IS ALLWAYS = 'E20001 S01280
     C**********   REMOVING TRAILING BLANK TO GIVE ONE MORE DIGIT. E20001 S01280
     C**********           MOVE @@OUTR    DDMKT            *1      E20001 S01280
     C**********           MOVEL@@OUTR    @@C12            *1      E20001 S01280
     C**********           MOVE @@C12     DDMKT            *1      E20001 S01280
     C**********                                                   E19844 S01280
     C****E19844 - COST TO CLOSE, MARKET RATES AND P/L = ZERO      E19844 S01280
     C**********   FOR DATE UP TO AND INCLUDING SPOT               E19844 S01280
     C**********                                                   E19844 S01280
     C****E20001 - TO KEEP ALL FIGURES ALIGNED WHEN THE TRAILING SPE20001 S01280
     C**********   IS REMOVED                                      E20001 S01280
     C**********           MOVE @@OUTR    DDCTC            *1      E19844 E20001
     C**********           MOVE @@C12     DDCTC            *1      E20001 S01280
     C**********           Z-ADD*ZERO     @@NUM            *1      E19844 S01280
     C**********           EXSR ZA0860                     *1      E19844 S01280
     C**********           MOVE @@ALPH    DDPLU            *1      E19844 S01280
     C**********           GOTO #ZB9                       *1      E19844 S01280
     C**********           END                             E1             S01280
     C**********                                                          S01280
     C***Move*days in forward period (from MM1000) to display store       S01280
     C**********           Z-ADD@@PER     @DAYS   50                      S01280
     C**********                                                          S01280
     C***Edit*date from YYYYMMDD to DDMMMYY or MMMDDYY                    S01280
     C**********           MOVEL@DTIN     @@DTIN                          S01280
     C**********           EXSR ZA0720                                    S01280
     C**********                                                          S01280
     C***Edit*cost to close rate = DAYS IN YEAR X 100 X NET INTEREST,     S01280
     C***DIVIDED BY NET CASH FLOW X DAYS IN PERIOD                        S01280
     C***Work*out days in year according to default interest              S01280
     C***calculation method                                               S01280
     C********** DICM      IFEQ 1                          B1             S01194
     C********** A6DICB    IFEQ '1'                        B1      S01194 S01280
     C********** DICM      OREQ 4                          *1             S01194
     C********** A6DICB    OREQ '4'                        *1      S01194 S01280
     C**********           Z-ADD365       @DYR    30       *1             S01280
     C**********           END                             E1             S01280
     C********** DICM      IFEQ 2                          B1             S01194
     C********** A6DICB    IFEQ '2'                        B1      S01194 S01280
     C********** DICM      OREQ 3                          *1             S01194
     C********** A6DICB    OREQ '3'                        *1      S01194 S01280
     C********** DICM      OREQ 5                          *1             S01194
     C********** A6DICB    OREQ '5'                        *1      S01194 S01280
     C**********           Z-ADD360       @DYR             *1             S01280
     C**********           END                             E1             S01280
     C********** DICM      IFEQ 6                          B1             S01194
     C********** A6DICB    IFEQ '6'                        B1      S01194 S01280
     C**********           Z-ADD366       @DYR             *1             S01280
     C**********           END                             E1             S01280
     C***Do*calculations                                                  S01280
     C**********                                                          S01280
     C********** @DYR      MULT 100       @@DYR   50                      S01280
     C****E20001 - USE THE ACTUAL AMOUNT FOR THE CALCULATION       E20001 S01280
     C********** @@DYR     MULT HSDNIM    @CTC1  150               E20001 S01280
     C********** @@DYR     MULT @@DNIM    @CTC1  150               E20001 S01280
     C**********                                                          S01280
     C********** HSDNMT    MULT @DAYS     @CTC2  150                      S01280
     C**********                                                          S01280
     C********** @CTC2     IFNE 0                          B1             S01280
     C****E20001 - DEFINE COST TO CLOSE RATE WITH 4 DECIMAL POINT  E20001 S01280
     C********** @CTC1     DIV  @CTC2     @CTCR  150H      *1      E20001 S01280
     C********** @CTC1     DIV  @CTC2     @CTCR  154H      *1      E20001 S01280
     C**********           ELSE                            X1             S01280
     C**********           Z-ADD*ZERO     @CTCR            *1             S01280
     C**********           END                             E1             S01280
     C**********                                                          S01280
     C***Edit*the result                                                  S01280
     C**********           Z-ADD@CTCR     @@INPR                          S01280
     C**********           EXSR MM1017                                    S01280
     C****E20001 - SINCE THE LAST POSITION IN @@OUTR IS ALLWAYS = 'E20001 S01280
     C**********   REMOVING TRAILING BLANK TO GIVE ONE MORE DIGIT. E20001 S01280
     C**********           MOVE @@OUTR    DDCTC                    E20001 S01280
     C**********           MOVEL@@OUTR    @@C12                    E20001 S01280
     C**********           MOVE @@C12     DDCTC                    E20001 S01280
     C**********                                                          S01280
     C***Calculate the market rate interest for use in the profit         S01280
     C***and*loss calculations. MARKET RATE =(NET CASH FLOW X MARKET      S01280
     C***RATE*FOR THE PERIOD X DAYS IN PERIOD) DIV (DAYS IN YEAR X        S01280
     C***100)***                                                          S01280
     C********** HSDNMT    MULT @MKT      @MRI1  150                      S01280
     C********** @MRI1     MULT @DAYS     @MRI1                           S01280
     C**********                                                          S01280
     C********** @DYR      MULT 100       @MRI2  150                      S01280
     C********** @MRI2     IFNE 0                          B1             S01280
     C********** @MRI1     DIV  @MRI2     @MRI   150H      *1             S01280
     C**********           ELSE                            X1             S01280
     C**********           Z-ADD*ZERO     @MRI             *1             S01280
     C**********           END                             E1             S01280
     C**********                                                          S01280
     C****PROFIT AND LOSS = NET INTEREST - MARKET RATE INTEREST           S01280
     C**********                                                          S01280
     C****E20001 - USE THE ACTUAL AMOUNT FOR CALCULATING P/L       E20001 S01280
     C********** HSDNIM    SUB  @MRI      @PLOSS 150               E20001 S01280
     C********** @@DNIM    SUB  @MRI      @PLOSS 150H              E20001 S01280
     C**********                                                          S01280
     C***Edit*the result                                                  S01280
     C********** 1         ADD  CDP       @S      10       *1             S01194
     C********** 1         ADD  A6NBDP    @S      10       *1      S01194 S01280
     C**********           Z-ADD@SF,@S    @SCAL1 100       *1             S01280
     C********** @PLOSS    DIV  @SCAL1    @PLOSS    H      *1             S01280
     C**********           Z-ADD@PLOSS    @@NUM                           S01280
     C**********           EXSR ZA0860                                    S01280
     C**********           MOVE @@ALPH    DDPLU                           S01280
     C**********                                                          S01280
     C********** #ZB9      ENDSR                           ****#ZB9****   S01280
     C**********                                                          S01280
     C****************************************************************    S01280
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*                                                              *
     C*     MIDAS/DRS - MONEY MARKET MODULE                          *
     C*                                                              *
     C*     MM1016 -  CONVERT AMOUNT TO DISPLAY -38                  *
     C*                                                              *
     C*     This routine converts a 15N amount with up to 3 implied  *
     C*     decimal places into a 13A field with thousands integer   *
     C*     half adjusted , leading zeroes suppressed & signed(+ or  *
     C*     -).                                                      *
     C*                                                              *
     C*     AMEND NO. XXXXXX                  DATE   XX/XX/XX        *
     C*                                                              *
     C*       CALLS: NONE                                            *
     C*                                                              *
     C*       INPUT: @@IAMT 15,0  INPUT AMOUNT                       *
     C*              @@CCY  3A    INPUT CURRENCY                     *
     C*                                                              *
     C*      OUTPUT: @@AMOU 13A   SIGNED AMOUNT TO DISPLAY           *
     C*                                                              *
     C*        USES: @@AMNT       AMOUNT TO DISPLAY                  *
     C*              @@SIGN       SIGN OF AMOUNT                     *
     C*              @A           ARRAY OF DISPLAY AMOUNT (SIGNED)   *
     C*                                                              *
     C*                                                              *
     C****************************************************************
     C*
     C           MM1016    BEGSR
     C*
     C** Initialise fields
     C                     MOVEA*BLANKS   @A
     C                     MOVE *BLANKS   @@AMOU 13
     C                     MOVE *BLANK    @@SIGN
     C*
     C** Find sign of input field
     C           @@IAMT    IFGT *ZERO                      B1
     C                     MOVE '+'       @@SIGN  1        *1
     C                     ELSE                            X1
     C           @@IAMT    IFLT *ZERO                      B*2
     C                     MOVE '-'       @@SIGN           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  Execute MM1015 to convert the input amount to display format.
     C                     EXSR MM1015
     C*
     C** If a database error was discovered by MM1015 exit routine.
     C           *INU7     IFEQ '1'                        B1
     C                     GOTO M10169                     *1
     C                     END                             E1
     C*
     C** Place output amount into array @A
     C                     MOVEL@@AMNT    @@AMOU
     C                     MOVEA@@AMOU    @A
     C*
     C** Place sign into array & move to output field.
     C                     MOVE @@SIGN    @A,13
     C                     MOVEA@A        @@AMOU
     C*
     C           M10169    ENDSR                           **M10169**
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*                                                              *
     C*     MIDAS/DRS - MONEY MARKET MODULE                          *
     C*                                                              *
     C*     MM1015 -  CONVERT AMOUNT TO DISPLAY -38                  *
     C*                                                              *
     C*     This routine converts a 15N amount with up to 3 implied  *
     C*     decimal places into a 12A field with thousands integer   *
     C*     half adjusted & leading zeroes suppressed.               *
     C*                                                              *
     C*     AMEND NO. XXXXXX                  DATE   XX/XX/XX        *
     C*                                                              *
     C*       CALLS: NONE                                            *
     C*                                                              *
     C*       INPUT: @@IAMT 15,0  INPUT AMOUNT                       *
     C*              @@CCY  3A    INPUT CURRENCY                     *
     C*              @@CDP  1,0   CURRENCY DECIMAL PLACES            *
     C*                                                              *
     C*      OUTPUT: @@AMNT 12A   AMOUNT TO DISPLAY                  *
     C*                                                              *
     C*        USES: @@I          INDEX TO ARRAY OF AMOUNT           *
     C*              @@C          INDEX TO ARRAY OF DISPLAY AMOUNT   *
     C*              @D           ARRAY OF AMOUNT                    *
     C*              @J           ARRAY OF DISPLAY AMOUNT            *
     C*                                                              *
     C*                                                              *
     C****************************************************************
     C*
     C           MM1015    BEGSR
     C*
     C*          INITIALISE ARRAYS
     C*
     C                     MOVEA*BLANKS   @D
     C                     MOVEA*BLANKS   @J
     C*
     C** IF -VE AMOUNT THEN MAKE +VE
     C           @@IAMT    IFLT 0
     C                     Z-SUB@@IAMT    @@IAMT
     C                     END
     C*
     C** Round up figures to the nearest thousand.
     C** & store initial array index value
     C           @@CDP     IFEQ 0                          B1
     C                     ADD  500       @@IAMT 150       *1
     C                     Z-ADD12        @@I              *1
     C                     END                             E1
     C*
     C           @@CDP     IFEQ 1                          B1
     C                     ADD  5000      @@IAMT           *1
     C                     Z-ADD11        @@I              *1
     C                     END                             E1
     C*
     C           @@CDP     IFEQ 2                          B1
     C                     ADD  50000     @@IAMT           *1
     C                     Z-ADD10        @@I              *1
     C                     END                             E1
     C*
     C           @@CDP     IFEQ 3                          B1
     C                     ADD  500000    @@IAMT           *1
     C                     Z-ADD9         @@I              *1
     C                     END                             E1
     C*
     C**  Place input amount into a 15 x 1 byte array
     C                     MOVEA@@AMDS    @D
     C*
     C**  Load output amount into a 12 x 1 byte array
     C                     Z-ADD12        @@C
     C           @@I       DOWGT0                          B1
     C                     MOVE @D,@@I    @J,@@C           *1
     C                     SUB  1         @@C     20       *1
     C                     SUB  1         @@I     20       *1
     C                     END                             E1
     C*
     C** Test successive elements of output amount setting zeroes to
     C** blanks until the first element or a 'non zero' is reached.
     C                     Z-ADD1         @@C
     C*
     C           @J,@@C    DOUNE'0'                        B1
     C           @J,@@C    ANDNE*BLANK                     *1
     C           @@C       OREQ 12                         *1
     C                     MOVE *BLANK    @J,@@C           *1
     C                     ADD  1         @@C              *1
     C                     END                             E1
     C*
     C** MOVE @J TO DISPLAY FIELD
     C                     MOVEA@J        @@AMNT 12
     C                     GOTO M10159
     C*
     C** DUMMY MOVES TO DEFINE FIELDS NOT DEFINED ELSEWHERE
     C                     MOVE @@CCY     @@CCY   3
     C                     MOVE @@CDP     @@CDP   10
     C           M10159    ENDSR                           **M10159**
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*     ZA0860 -  CONVERT SHORT AMOUNT TO DISPLAY FORMAT         *
     C*                                                              *
     C*       CALLS:                                                 *
     C*                                                              *
     C*       INPUT: @@NUM  15N    (NUMERIC INPUT AMOUNT)            *
     C*                                                              *
     C*      OUTPUT: @@ALPH 16A    (ALPHA OUTPUT AMOUNT)             *
     C*                                                              *
     C*        USES: @K     15A  - ARRAY TO HOLD INPUT AMOUNT        *
     C*              @@I     1N  - INDEX TO @K                       *
     C*              @@WORK 15A  - ALPHA INPUT AMOUNT                *
     C*                                                              *
     C*     AMEND NO. 000001                  DATE   14/07/86        *
     C*       Amendment to correct output if its value is zero.      *
     C*                                                              *
     C****************************************************************
     C*
     C           ZA0860    BEGSR
     C*
     C                     Z-ADD@@NUM     @@NUM  150
     C*
     C**  IF THE NUMBER IS ZERO, PLACE A SINGLE ZERO IN THE LAST PLACE
     C**  OF THE ARRAY, AND SET THE SIGN TO BLANK.  THEN BY-PASS
     C**  FURTHER SUBROUTINE PROCESSING.
     C           @@NUM     IFEQ 0                          B1
     C                     MOVEA*BLANKS   @K               *1
     C                     MOVE '0'       @K,15            *1
     C                     GOTO ZA0868                     *1
     C                     END                             E1
     C*
     C** SET UP SIGN OF OUTPUT AMOUNT
     C           @@NUM     IFLT 0                          B1
     C                     MOVE '-'       @K,16            *1
     C                     Z-SUB@@NUM     @@NUM            *1
     C                     ELSE                            X1
     C                     MOVE '+'       @K,16            *1
     C                     END                             E1
     C*
     C**  SET UP INPUT AMOUNT ARRAY
     C                     MOVE @@NUM     @@WORK 15
     C                     MOVEA@@WORK    @K
     C*
     C**  BLANK OUT EACH ELEMENT OF @K FROM LEFT TO RIGHT
     C**  UNTIL FIRST NON-ZERO ELEMENT OR 15TH ELEMENT
     C                     MOVE '0'       *IN90
     C                     Z-ADD1         @@I     20
     C           *IN90     DOUEQ'1'                        B1
     C           @@I       OREQ 15                         *1
     C*                                                    *1
     C** IF ARRAY ELEMENT ZERO, SET TO BLANKS              *1
     C           @K,@@I    IFEQ '0'                        B*2
     C                     MOVE *BLANK    @K,@@I           **2
     C                     ELSE                            X*2
     C                     MOVE '1'       *IN90            **2
     C                     END                             E*2
     C                     ADD  1         @@I              *1
     C                     END                             E1
     C*
     C** TAG ZA0868
     C           ZA0868    TAG                             **ZA0868**
     C*
     C** SET UP OUTPUT AMOUNT
     C                     MOVEA@K        @@ALPH 16
     C*
     C           ZA0869    ENDSR                           **ZA0869**
     C*
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C* MM1000 - THIS SUBROUTINE CALCULATES FORWARD MONEY MARKET     *
     C*          BORROW & LEND RATES.                                *
     C*                                                              *
     C* CALLED BY:                                                   *
     C*                                                              *
     C* CALLS :   ZA0680      CONVERT DATE TO MIDAS DAY NUMBER       *
     C*       :   MM1002      DETERMINE A BROKEN DATE RATE           *
     C*                                                              *
     C* INPUT  :  @@VDT  VALUE DATE   'YYYYMMDD'               (8N)  *
     C*           @@CCY  CURRENCY CODE                         (3A)  *
     C*           @@INTM INTERPOLATION METHOD LINEAR/WEIGHTED  (1A)  *
     C*           @@MSPD MONEY MARKET SPOT DATE                (8N)  *
     C*                                                              *
     C*                                                              *
     C* OUTPUT :  @@BORC BORROW RATE                          (11N)  *
     C*           @@LERC LEND RATE                            (11N)  *
     C*           @@PER  DAYS IN PERIOD                        (5N)  *
     C*                                                              *
     C*                                                              *
     C* ADDITIONAL WORK FIELDS USED WITHIN THIS ROUTINE :            *
     C*                                                              *
     C*     INPUT:   @@BORA - Borrow rate for start date.            *
     C*              @@BORB - Borrow rate for end date.              *
     C*              @@LERA - Lend rate for start date.              *
     C*              @@LERB - Lend rate for end date.                *
     C*              @@DYTA - Number of days to start date.          *
     C*              @@DYTB - Number of days to end date.            *
     C*              @@DYTC - Number of days to required date.       *
     C*              @@DTIN - Field required by SR/ZA0680            *
     C*              @@MDNO - Day # returned from SR/ZA0680          *
     C*                                                              *
     C*                                                              *
     C**  Indicator Function Summary                                 *
     C*                                                              *
     C* ID F  C  H  L    FUNCTION OF INDICATORS                      *
     C* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*
     C*       80         End of file indicator.                      * UT
     C*       81         Database error indicator.                   *
     C*                                                              *
     C*     AMEND NO. XXXXX                    DATE XX/XX/XX         *
     C*                                                              *
     C****************************************************************
     C*
     C           MM1000    BEGSR
     C*
     C**  Initialisation - Set up the key list parameters.
     C**                   Re-set fields.
     C*
     C           @@K11     KLIST
     C                     KFLD           @@CCY
     C                     KFLD           @@VDT
     C*
     C                     Z-ADD0         @@LERC 117
     C                     Z-ADD0         @@BORC 117
     C                     Z-ADD0         @@PER   50
     C*
     C**  Use the key of currency and date to determine if data base
     C**  error has occurred.
     C*
     C           @@CCY     SETLLFDINTDLL             80
     C  N80      @@CCY     READEFDINTDLL               8180
     C           *IN80     IFEQ '1'                        B1
     C           *IN81     OREQ '1'                        *1
     C                     GOTO M10008                     *1
     C                     END                             E1
     C*
     C**  Convert input date to MIDAS day number.
     C*
     C                     Z-ADD@@VDT     @@DTIN
     C                     EXSR ZA0680
     C                     Z-ADD@@MDNO    @@DYTC
     C*
     C                     Z-ADD@@MSPD    @@DTIN                          ME1160
     C                     EXSR ZA0680                                    ME1160
     C                     Z-ADD@@MDNO    @@SPD1  50                      ME1160
     C*
     C** Calculate the period.
     C*
     C*******    @@DYTC    SUB  RUND      @@PER                           ME1160
     C           @@DYTC    SUB  @@SPD1    @@PER                           ME1160
     C*
     C** MATCH DATE SITUATION.
     C** IF     valid chain then calculate the number of days in
     C**        the period, set up the output fields and terminate
     C**        the process.
     C** END
     C*****NB***LF/FDCCYTLL*should*have*been*accessed*in*mainline**ME1160 S01194
     C**********and*MSPD*obtained*****                             ME1160 S01194
     C*                                                                   S01194
     C** N.B. A6MMSD (MM Spot Date) will have already been accessed       S01194
     C**      in main processing via access object AOCURRR0               S01194
     C*
     C           @@K11     CHAINFDINTDLL             80
     C           *IN80     IFEQ '0'                        B1
     C                     MOVE HWBRRT    @@BORC           **2
     C                     MOVE HWLDRT    @@LERC           **2
     C                     GOTO M10009                     **2
     C                     END                             E1
     C*
     C** Re-set the file pointer to record nearest the key.
     C*
     C           @@K11     SETGTFDINTDLL
     C*
     C** INPUT DATE EXCEEDS DATE ON FILE.
     C** IF     the value input is greater than that on file for
     C**          that currency IE: next currency accessed
     C** THEN   access the largest dated record on LF/FDINTDLL
     C**        using READP (NB: re-check currency)
     C**        then calculate the number of days in the period,
     C**        set up the output fields and terminate the process.
     C** END
     C*****NB***LF/FDCCYTLL*should*have*been*accessed*in*mainline**ME1160 S01194
     C**********and*MSPD*obtained****                              ME1160 S01194
     C**
     C** N.B. A6MMSD (MM Spot Date) will have already been accessed       S01194
     C**      in main processing via access object AOCURRR0               S01194
     C*
     C                     READ FDINTDLL                 80
     C           *IN80     IFEQ '1'                        B1
     C           @@K11     SETGTFDINTDLL                   *1
     C                     READPFDINTDLL                 80*1
     C                     MOVE HWBRRT    @@BORC           *1
     C                     MOVE HWLDRT    @@LERC           *1
     C                     GOTO M10009                     *1
     C                     ELSE                            X1
     C           HWCCY     IFNE @@CCY                      B*2
     C                     READPFDINTDLL                 80**2
     C           @@CCY     IFEQ HWCCY                      B**3
     C                     MOVE HWBRRT    @@BORC           ***3
     C                     MOVE HWLDRT    @@LERC           ***3
     C                     GOTO M10009                     ***3
     C                     END                             E**3
     C*
     C** DATE BRACKET SITUATION.
     C** IF     the value input does not match a record exactly
     C**        and is infact bracketed by two records
     C** THEN          execute subroutine MM10029 to calculate
     C**               linear or weighted interpolation
     C*
     C                     ELSE                            X*2
     C                     MOVE HWBRRT    @@BORB           **2
     C                     MOVE HWLDRT    @@LERB           **2
     C                     Z-ADDHWPRDD    @@DTIN           **2
     C                     EXSR ZA0680                     **2
     C                     Z-ADD@@MDNO    @@DYTB           **2
     C*
     C                     READPFDINTDLL                 81
     C           HWCCY     IFNE @@CCY                      B**3
     C                     MOVE '1'       *IN80            ***3
     C                     GOTO M10008                     ***3DBERROR 932
     C                     ELSE                            X**3
     C                     MOVE HWBRRT    @@BORA           ***3
     C                     MOVE HWLDRT    @@LERA           ***3
     C                     Z-ADDHWPRDD    @@DTIN           ***3
     C                     EXSR ZA0680                     ***3
     C                     Z-ADD@@MDNO    @@DYTA           ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Execute subroutine MM1002 to calculate the weighted or
     C** linear rate value depending on the interpolation method
     C** submitted by the user.
     C*
     C                     EXSR MM1002
     C*
     C                     GOTO M10009
     C*
     C** DATA BASE ERROR SITUATION.
     C** Data base error occured either because the file was empty     .
     C*  OR no records exist on file for that currency.
     C           M10008    TAG
     C                     MOVEL'FDINTDLL'DBFILE           *1
     C                     MOVEL'932'     DBASE            ***************
     C                     MOVEL@@CCY     DBKEY            *             *
     C                     MOVE '1'       *INU7            * DBERROR 932 *
     C                     MOVE '1'       *INU8            *             *
     C                     ADD  0         @@MSPD  80       ***************ME1160
     C                     GOTO M10009
     C*
     C** Unexecuted processing to define fields used by this subroutine.
     C                     MOVE @@MDNO    @@MDNO  50
     C*
     C           M10009    ENDSR
     C****************************************************************
      /EJECT
     C****************************************************************
     C*                                                              *
     C*     MM1002 -  Determine a broken date rate                   *
     C*                                                              *
     C*     CALLS:                                                   *
     C*                                                              *
     C*     INPUT:   @@BORA - Borrow rate for start date.            *
     C*              @@BORB - Borrow rate for end date.              *
     C*              @@LERA - Lend rate for start date.              *
     C*              @@LERB - Lend rate for end date.                *
     C*              @@DYTA - Number of days to start date.          *
     C*              @@DYTB - Number of days to end date.            *
     C*              @@DYTC - Number of days to required date.       *
     C*              @@INTM - Interpolation method required.         *
     C*                                                              *
     C*     OUTPUT:  @@BORC - Borrow rate for required date.         *
     C*              @@LERC - Lend rate for required date.           *
     C*                                                              *
     C*     USES:    @@TCSA - (Tc-Ta)                                *
     C*              @@TBSA - (Tb-Ta)                                *
     C*              @@RATA - Ra*Ta                                  *
     C*              @@RBTB - Rb*Tb                                  *
     C*              @@COEF - @@TBSA*Tc                              *
     C*              @@ELM1 - @@COEF*(@@RBTB-@@RATA)                 *
     C*              @@DLM1 - 1st element of equation.               *
     C*              @@DLM2 - 2nd element of equation.               *
     C*              @@EINT - Integer part of (RbTb-RaTa)*(Tc-Ta)    *
     C*              @@EDEC - Decimal part of (RbTb-RaTa)*(Tc-Ta)    *
     C*              @@DINT - @@EINT/@@COEF                          *
     C*              @@DDEC - @@EINT/@@COEF                          *
     C*                                                              *
     C****************************************************************
     C**
     C**  This routine uses two equations:
     C**
     C**  1. Linear interpolation.
     C**
     C**                  Ra + (Tc-Ta)*(Rb-Ra)
     C**     Rc =              -------
     C**                       (Tb-Ta)
     C**
     C**
     C**  2. Weighted interpolation.
     C**
     C**                  TaRa    (Tc-Ta)  *(TbRb-TaRa)
     C**     Rc =         ---- + ----------
     C**                   Tc    (Tb-Ta)*Tc
     C**
     C**
     C**     where   Rc = rate at required no. of days forward.
     C**             Ra = rate at start no. of days forward.
     C**             Rb = rate at end no. of days forward.
     C**             Tc = required no. of days forward.
     C**             Ta = start no. of days forward.
     C**             Tb = end no. of days forward.
     C**
     C*
     C*
     C           MM1002    BEGSR
     C*
     C**  Define and initialise fields used.
     C                     Z-ADD@@BORA    @@BORA 117
     C                     Z-ADD@@BORB    @@BORB 117
     C                     Z-ADD@@LERA    @@LERA 117
     C                     Z-ADD@@LERB    @@LERB 117
     C                     Z-ADD@@DYTA    @@DYTA  50
     C                     Z-ADD@@DYTB    @@DYTB  50
     C                     Z-ADD@@DYTC    @@DYTC  50
     C                     MOVE @@INTM    @@INTM  1
     C*
     C                     Z-ADD*ZEROS    @@BORC 117
     C                     Z-ADD*ZEROS    @@LERC 117
     C*
     C                     Z-ADD*ZEROS    @@TCSA  50
     C                     Z-ADD*ZEROS    @@TBSA  50
     C                     Z-ADD*ZEROS    @@RATA 157
     C                     Z-ADD*ZEROS    @@RBTB 157
     C***********          Z-ADD*ZEROS    @@COEF  60                      065473
     C                     Z-ADD*ZEROS    @@COEF 150                      065473
     C                     Z-ADD*ZEROS    @@ELM1 157
     C                     Z-ADD*ZEROS    @@DLM1 159
     C                     Z-ADD*ZEROS    @@DLM2 159
     C                     Z-ADD*ZEROS    @@EINT 100
     C                     Z-ADD*ZEROS    @@EDEC  99
     C                     Z-ADD*ZEROS    @@DINT 139
     C                     Z-ADD*ZEROS    @@DDEC  99
     C*
     C**  Calculate     (Tc-Ta) and (Tb-Ta).
     C           @@DYTC    SUB  @@DYTA    @@TCSA
     C           @@DYTB    SUB  @@DYTA    @@TBSA
     C*
     C**  If the interpolation method field holds an 'L', the inter-
     C**  polation method is linear.
     C           @@INTM    IFEQ 'L'                        B1
     C*
     C**  Calculate Borrow rate.
     C**  Calculate (Rb-Ra)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@BORB    SUB  @@BORA    @@BORC           *1
     C           @@BORC    MULT @@TCSA    @@EINT           *1
     C           @@BORC    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((Rb-Ra)*(Tc-Ta))/(Tb-Ta)) + Ra.
     C           @@EINT    DIV  @@TBSA    @@DINT           *1
     C           @@EDEC    DIV  @@TBSA    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C           @@DLM2    ADD  @@BORA    @@BORC    H      *1
     C*
     C**  Calculate Lend rate.
     C**  Calculate (Rb-Ra)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@LERB    SUB  @@LERA    @@LERC           *1
     C           @@LERC    MULT @@TCSA    @@EINT           *1
     C           @@LERC    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((Rb-Ra)*(Tc-Ta))/(Tb-Ta)) + Ra.
     C           @@EINT    DIV  @@TBSA    @@DINT           *1
     C           @@EDEC    DIV  @@TBSA    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C           @@DLM2    ADD  @@LERA    @@LERC    H      *1
     C*
     C**  The interpolation method is weighted.
     C                     ELSE                            X1
     C*
     C**  Calculate     (Tb-Ta)*Tc
     C           @@TBSA    MULT @@DYTC    @@COEF           *1
     C*
     C**  Calculate Borrow rate.
     C*
     C**  Calculate (RbTb-RaTa)
     C           @@BORA    MULT @@DYTA    @@RATA           *1
     C           @@BORB    MULT @@DYTB    @@RBTB           *1
     C           @@RBTB    SUB  @@RATA    @@ELM1           *1
     C*
     C**  Calculate (RbTb-RaTa)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@ELM1    MULT @@TCSA    @@EINT           *1
     C           @@ELM1    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((RbTb-RaTa)*(Tc-Ta))/((Tb-Ta)*Tc)
     C           @@EINT    DIV  @@COEF    @@DINT           *1
     C           @@EDEC    DIV  @@COEF    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C*
     C**  Calculate RaTa/Tc and add to the figure just calculated
     C**  to obtain the rate.
     C           @@RATA    DIV  @@DYTC    @@DLM1           *1
     C           @@DLM1    ADD  @@DLM2    @@BORC    H      *1
     C*
     C**  Calculate Lend rate.
     C*
     C**  Calculate (RbTb-RaTa)
     C           @@LERA    MULT @@DYTA    @@RATA           *1
     C           @@LERB    MULT @@DYTB    @@RBTB           *1
     C           @@RBTB    SUB  @@RATA    @@ELM1           *1
     C*
     C**  Calculate (RbTb-RaTa)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@ELM1    MULT @@TCSA    @@EINT           *1
     C           @@ELM1    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((RbTb-RaTa)*(Tc-Ta))/((Tb-Ta)*Tc)
     C           @@EINT    DIV  @@COEF    @@DINT           *1
     C           @@EDEC    DIV  @@COEF    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C*
     C**  Calculate RaTa/Tc and add to the figure just calculated
     C**  to obtain the rate.
     C           @@RATA    DIV  @@DYTC    @@DLM1           *1
     C           @@DLM1    ADD  @@DLM2    @@LERC    H      *1
     C*
     C                     END                             E1
     C*
     C           M10029    ENDSR                           **M10029**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MM1017 - Subroutine to convert a rate to display, no sign     *
     C*                                                               *
     C* CALLED BY :                                                   *
     C*                                                               *
     C* CALLS :                                                       *
     C*                                                               *
     C* INPUT  : @@INPR Rate to be edited.                            *
     C*                                                               *
     C* OUTPUT : @@OUTR Edited output rate.                           *
     C*                                                               *
     C* USES :   @@INPR Rate to be edited.                            *
     C*          @@OUTR Edited output rate.                           *
     C*          @@DECS Field to hold decimal digits for input rate.  *
     C*          @@INTS Field to hold integers for input rate.        *
     C*          @@N    Counter field.                                *
     C*          @@Q    Second counter field.                         *
     C*          @@STRP Rate start position after zero suppression.   *
     C*          @W     Work array.                                   *
     C*                                                               *
     C*****************************************************************
     C           MM1017    BEGSR
     C*
     C**  Define fields used.
     C                     Z-ADD@@INPR    @@INPR 117
     C                     MOVE *BLANKS   @@OUTR 13
     C                     MOVE *BLANKS   @@DECS  7
     C                     MOVE *BLANKS   @@INTS  4
     C                     Z-ADD0         @@N     20
     C                     Z-ADD0         @@Q     20
     C                     Z-ADD0         @@STRP  20
     C*
     C**  Initialise work array.
     C                     MOVEA*BLANKS   @W
     C*
     C**  If the rate is negative reverse the sign.
     C           @@INPR    IFLT 0                          B1
     C                     Z-SUB@@INPR    @@INPR           *1
     C                     END                             E1
     C*
     C**  Seperate integers and decimal digits into two fields.
     C*
     C                     MOVEL@@INPR    @@INTS
     C                     MOVE @@INPR    @@DECS
     C*
     C**  Move integers, decimal seperator and decimal digits into
     C**  work array.
     C                     MOVEA@@INTS    @W
     C*********************MOVE*IDDCSP****@W,5****************************S01319
     C                     MOVE BNDCSP    @W,5                            S01319
     C                     MOVEA@@DECS    @W,6
     C*
     C**  Remove leading zeros from the rate and replace with blanks.
     C                     Z-ADD1         @@N
     C           @@N       DOWLE3                          B1
     C           @W,@@N    ANDEQ'0'                        X1
     C                     MOVE *BLANK    @W,@@N           *1
     C                     ADD  1         @@N              *1
     C                     END                             E1
     C*
     C                     Z-ADD@@N       @@STRP
     C*
     C**  Truncate trailing zeros and replace with blanks. If rate is
     C**  an integer a single zero after the decimal place should be
     C**  displayed.
     C                     Z-ADD12        @@N
     C           @@N       DOWGE7                          B1
     C           @W,@@N    ANDEQ'0'                        X1
     C                     MOVE *BLANK    @W,@@N           *1
     C                     SUB  1         @@N              *1
     C                     END                             E1
     C*
     C**  Right justify the array.
     C                     Z-ADD12        @@Q
     C           @@N       IFNE @@Q                        B1
     C           @@N       DOWGE@@STRP                       B2
     C                     MOVE @W,@@N    @W,@@Q             *2
     C                     MOVE *BLANK    @W,@@N             *2
     C                     SUB  1         @@N                *2
     C                     SUB  1         @@Q                *2
     C                     END                               E1
     C                     END                             E2
     C*
     C**  Move the final array into the output field.
     C                     MOVEA@W        @@OUTR
     C*
     C           M10179    ENDSR                           **M10179**
     C****************************************************************
      /EJECT
     C****************************************************************
     C*                                                              *
     C*     #B CARRIES OUT THE MAIN PROCESSING.                      *
     C*        CALLED BY  : MAIN PROGRAM.                            *
     C*        CALLS      : #BC #BD #BE                              *
     C*                                                              *
     C*        WORK FIELDS: @CPDAT- DATE FOR FILE KEY                *
     C*                   : @RRFSH- INPUT PARAMETER FOR ROLL REFRESH *
     C*                   : @STEND- START/END FIELD FOR DISPLAY      *
     C*                   : @@DTIN- INPUT FIELD TO ZA0720            *
     C*                   : @@SLCT- SELECTION PROCESSED INDICATOR    *
     C*                   : @STRNG- PARAMETER STRING                 *
     C*                   : @ERROR- ERROR LEFT FROM VALIDATION       *
     C*                   : @TOPRD- TOP RECORD FOR ROLL/REFRESH      *
     C*                   : @BOTRD- BOTTOM RECORD FOR ROLL/REFRESH   *
     C*                                                              *
     C****************************************************************
     C*
     C           #B        BEGSR
     C*
     C**  If termination code = T, terminate program.
     C           @T        IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     GOTO #B9                        *1
     C                     END                             E1
     C*
     C*   Continue processing until CMD/3 or CMD/12 is pressed
     C           *IN01     DOWNE'1'                        B1
     C           *IN02     ANDNE'1'                        *1
     C*
     C**  Set off the selection-processed indicator
     C*
     C                     MOVE 'N'       @@SLCT  1        *1
     C*
     C*   Set up error indicator
     C                     MOVE '0'       @ERROR  1
     C           *IN69     IFEQ '1'                        B*2
     C                     MOVE '1'       @ERROR           **2
     C                     END                             E*2
     C*
     C*   Clear the message queue of any old messages and reset
     C*   any error indicators
     C                     EXSR #ZA                        *1
      *
      ** Move prompt fields                                               S01280
     C                     MOVE DDALL     @DALL                           S01280
     C                     MOVE DDNA      @DNA                            S01280
     C                     MOVE DDLD      @DLD                            S01280
     C                     MOVE DDLEN     @DLEN                           S01280
     C                     MOVE DDFRA     @DFRA                           S01280
     C                     MOVE DDIRS     @DIRS                           S01280
     C                     MOVE DDFUT     @DFUT                           S01280
      *                                                                   S01280
      **  Set up '* TAKE ON IN PROGRESS *' or 'LAST TAKE ON xx:xx:xx      S01280
      *                                                                   S01280
     C           1         SETLLDLMMTOLL                                  S01280
     C                     READ DLMMTOLL                 79               S01280
      *                                                                   S01280
     C           TOTOIP    IFEQ 'Y'                                       S01280
     C                     MOVEL'* TAKE ' @TKON                           S01280
     C                     MOVE 'ON IN '  @TKON                           S01280
     C                     MOVE 'PR'      @PR                             S01280
     C                     MOVEL'OGRESS ' @OGR                            S01280
     C                     MOVE '*'       @OGR                            S01280
     C                     MOVE @TOIP     DDSTS                           S01280
     C                     ELSE                                           S01280
     C                     MOVEL' LAST T' @LTON                           S01280
     C                     MOVE 'AKE ON'  @LTON                           S01280
     C                     MOVE *BLANKS   @BLNK                           S01280
     C                     MOVE @@SEC     @SEC                            S01280
     C                     MOVE ':'       @DASH1                          S01280
     C                     MOVE @@MIN     @MIN                            S01280
     C                     MOVE ':'       @DASH2                          S01280
     C                     MOVE @@HOUR    @HOUR                           S01280
     C                     MOVE @LTONT    DDSTS                           S01280
     C                     END                                            S01280
      *                                                                   S01280
      * Set up toggle                                                     S01280
      *                                                                   S01280
      * First time through                                                S01280
      *         @TOGLE = ' ' move A to @TOGLE                             S01280
      *         DDTOG should be 'TOTAL P/L'                               S01280
      *         DDOPTP should be 'open p/l'                               S01280
      *                                                                   S01280
      * If F10 then pressed move B to @TOGLE                              S01280
      *         DDTOG should be 'OPEN P/L'                                S01280
      *         DDOPTP should be 'closed p/l'                             S01280
      *                                                                   S01280
      * If F10 then pressed move C to @TOGLE                              S01280
      *         DDTOG should be 'CLOSED P/L                               S01280
      *         DDOPTP should be 'total p/l'                              S01280
      *                                                                   S01280
      * If F10 then pressed move A to @TOGLE                              S01280
      *                                                                   S01280
      *                                                                   S01280
      ** If not first time through and CMD/10 pressed set @CMD10 to       S01280
      ** Y so that later on the date at the top of the screen rather than S01280
      ** the input prompt is passed for processing.(When rolling + CMD10  S01280
      ** do not want to return to the date of the input prompt.)          S01280
     C           @TOGLE    IFNE *BLANK                                    S01280
     C           *IN10     ANDEQ'1'                                       S01280
     C                     MOVE 'Y'       @CMD10                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ *BLANK                                    S01280
     C           @TOGLE    OREQ 'C'                                       S01280
     C           *IN10     ANDEQ'1'                                       S01280
     C                     MOVE 'A'       @TOGLE  1                       S01280
     C                     SETOF                     10                   S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'A'                                       S01280
     C           *IN10     ANDEQ'1'                                       S01280
     C                     MOVE 'B'       @TOGLE                          S01280
     C                     SETOF                     10                   S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'B'                                       S01280
     C           *IN10     ANDEQ'1'                                       S01280
     C                     MOVE 'C'       @TOGLE                          S01280
     C                     SETOF                     10                   S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'A'                                       S01280
     C                     MOVEL'TOTAL P/'DDTOG                           S01280
     C                     MOVE 'L '      DDTOG                           S01280
     C                     MOVEL'open p/l'DDOPTP                          S01280
     C                     MOVE '  '      DDOPTP                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'B'                                       S01280
     C                     MOVEL'OPEN P/L'DDTOG                           S01280
     C                     MOVE '  '      DDTOG                           S01280
     C                     MOVEL'closed p'DDOPTP                          S01280
     C                     MOVE '/l'      DDOPTP                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'C'                                       S01280
     C                     MOVEL'CLOSED P'DDTOG                           S01280
     C                     MOVE '/L'      DDTOG                           S01280
     C                     MOVEL'total p/'DDOPTP                          S01280
     C                     MOVE 'l '      DDOPTP                          S01280
     C                     END                                            S01280
      ** If linked enquiry the selection is passed in through parameter   S01280
      ** @PRMPT.Set up deal types selected for linked enquiry.            S01280
     C           @LKNA     IFNE *BLANK                                    S01280
     C           @LKLD     ANDNE*BLANK                                    S01280
     C           @LKLEN    ANDNE*BLANK                                    S01280
     C           @LKFRA    ANDNE*BLANK                                    S01280
     C           @LKIRS    ANDNE*BLANK                                    S01280
     C           @LKFUT    ANDNE*BLANK                                    S01280
     C           @LKALL    ORNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDALL                           S01280
     C                     MOVE 'Y'       @DALL                           S01280
     C                     MOVE *BLANK    @LKALL                          S01280
     C                     MOVE *BLANK    @LKNA                           S01280
     C                     MOVE *BLANK    @LKLD                           S01280
     C                     MOVE *BLANK    @LKLEN                          S01280
     C                     MOVE *BLANK    @LKFRA                          S01280
     C                     MOVE *BLANK    @LKIRS                          S01280
     C                     MOVE *BLANK    @LKFUT                          S01280
     C                     ELSE                                           S01280
      *                                                                   S01280
     C           @LKNA     IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDNA                            S01280
     C                     MOVE 'Y'       @DNA                            S01280
     C                     MOVE *BLANK    @LKNA                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @LKLD     IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDLD                            S01280
     C                     MOVE 'Y'       @DLD                            S01280
     C                     MOVE *BLANK    @LKLD                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @LKLEN    IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDLEN                           S01280
     C                     MOVE 'Y'       @DLEN                           S01280
     C                     MOVE *BLANK    @LKLEN                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @LKFRA    IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDFRA                           S01280
     C                     MOVE 'Y'       @DFRA                           S01280
     C                     MOVE *BLANK    @LKFRA                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @LKIRS    IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDIRS                           S01280
     C                     MOVE 'Y'       @DIRS                           S01280
     C                     MOVE *BLANK    @LKIRS                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @LKFUT    IFNE *BLANK                                    S01280
     C                     MOVE 'Y'       DDFUT                           S01280
     C                     MOVE 'Y'       @DFUT                           S01280
     C                     MOVE *BLANK    @LKFUT                          S01280
     C                     END                                            S01280
     C                     END                                            S01280
      *                                                                   S01280
      *                                                                   S01280
      *  If no deal types selected - select all (subject to module        S01280
      *  installed.                                                       S01280
     C           @DALL     IFEQ *BLANK                                    S01280
     C           @DNA      ANDEQ*BLANK                                    S01280
     C           @DLD      ANDEQ*BLANK                                    S01280
     C           @DLEN     ANDEQ*BLANK                                    S01280
     C           @DFRA     ANDEQ*BLANK                                    S01280
     C           @DIRS     ANDEQ*BLANK                                    S01280
     C           @DFUT     ANDEQ*BLANK                                    S01280
     C           @DALL     ORNE *BLANK                                    S01280
     C                     MOVE 'Y'       @DNA                            S01280
     C                     MOVE 'Y'       @DLD                            S01280
      *                                                                   S01280
     C           BGCSLN    IFEQ 'Y'                                       S01280
     C                     MOVE 'Y'       @DLEN                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           BGFIIN    IFEQ 'Y'                                       S01280
     C                     MOVE 'Y'       @DFRA                           S01280
     C                     MOVE 'Y'       @DIRS                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           BGFUOP    IFEQ 'Y'                                       S01280
     C                     MOVE 'Y'       @DFUT                           S01280
     C                     END                                            S01280
     C                     END                                            S01280
      *                                                                   S01280
      *  Set up trade types for display.                                  S01280
      *                                                                   S01280
     C                     MOVE *BLANKS   @C                              S01280
     C                     Z-ADD1         @M      10                      S01280
      *                                                                   S01280
      ** If 'ALL' selected and all modules installed.                     S01280
     C           @DALL     IFNE *BLANK                                    S01280
     C           BGCSLN    ANDEQ'Y'                                       S01280
     C           BGFUOP    ANDEQ'Y'                                       S01280
     C           BGFIIN    ANDEQ'Y'                                       S01280
     C                     MOVEA'N/A L/D '@C,1                            S01280
     C                     MOVEA'LEN FRA '@C,3                            S01280
     C                     MOVEA'IRS FUT '@C,5                            S01280
     C                     ELSE                                           S01280
      *                                                                   S01280
     C           @DNA      IFNE *BLANK                                    S01280
     C                     MOVE 'N/A '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @DLD      IFNE *BLANK                                    S01280
     C                     MOVE 'L/D '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @DLEN     IFNE *BLANK                                    S01280
     C                     MOVE 'LEN '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @DFRA     IFNE *BLANK                                    S01280
     C                     MOVE 'FRA '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @DIRS     IFNE *BLANK                                    S01280
     C                     MOVE 'IRS '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @DFUT     IFNE *BLANK                                    S01280
     C                     MOVE 'FUT '    @C,@M                           S01280
     C                     ADD  1         @M                              S01280
     C                     END                                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C                     MOVEA@C,1      @DTYP  24                       S01280
      *                                                                   S01280
      *   Check to see if input prompts have changed.                     S01280
      *   (If F11 pressed and input prompts have changed then #BC. If     S01280
      *   F11 pressed with input prompts unchanged bypass #BC do not      S01280
      *   process #BC as the array has already been stored.)              S01280
     C                     MOVE 'N'       @CHG    1                       S01280
      *                                                                   S01280
     C           @SRCCY    IFNE @SECCY                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @SRDAT    IFNE @SEDAT                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDALL     IFNE @SEALL                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDNA      IFNE @SENA                                     S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDLD      IFNE @SELD                                     S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDLEN     IFNE @SELEN                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDFRA     IFNE @SEFRA                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDIRS     IFNE @SEIRS                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           DDFUT     IFNE @SEFUT                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
     C           @INTM     IFNE @SENTM                                    S01280
     C                     MOVE 'Y'       @CHG                            S01280
     C                     END                                            S01280
      *                                                                   S01280
      ** If 'all' selected blank out all other prompts.                   S01280
     C           @DALL     IFNE *BLANK                                    S01280
     C                     MOVE *BLANK    DDLD                            S01280
     C                     MOVE *BLANK    DDNA                            S01280
     C                     MOVE *BLANK    DDLEN                           S01280
     C                     MOVE *BLANK    DDFRA                           S01280
     C                     MOVE *BLANK    DDIRS                           S01280
     C                     MOVE *BLANK    DDFUT                           S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Establish which screen is to be displayed.(FIRST = initial)     S01280
     C           *IN11     IFEQ '1'                                       S01280
     C           *IN05     ANDNE'1'                                       S01280
      *                                                                   S01280
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C                     MOVE 'SECOND'  @SCRN                           S01280
     C                     ELSE                                           S01280
     C                     MOVE 'FIRST '  @SCRN                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Set up screen toggle.                                           S01280
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C                     MOVEL'profitab'DDOPTN                          S01280
     C                     MOVE 'ility'   DDOPTN                          S01280
     C                     ELSE                                           S01280
     C*********************MOVEL'gap/cash'DDOPTN                    S01280S01280
     C*********************MOVE ' flow'   DDOPTN                    S01280S01280
     C                     MOVEL'screen o'DDOPTN                          S01280
     C                     MOVE 'ne   '   DDOPTN                          S01280
     C                     END                                            S01280
     C*
     C**  Initialise @RRFSH                                               E21044
     C           DDCCY     IFNE @SRCCY                     B*2            E21044
     C           DDCCY     OREQ *BLANKS                    B*2            E21044
     C                     Z-ADD*ZEROS    @RRFSH           **2            E21044
     C                     END                             E*2            E21044
     C*
     C*   If REFRESH requested,use top record and process as for rollup
     C*
     C           *IN05     IFEQ '1'                        B*2
     C                     Z-ADD@TOPRD    @RRFSH           **2
     C*
     C                     EXSR #BD                        **2
     C*
     C*   If not REFRESH,it must either be 'ENTER',ROLLUP or
     C*   ROLLDOWN. In this case selection takes priority.ie,if
     C*   a selection has been made,ROLLUP/ROLLDOWN behave as 'ENTER'
     C*   and the selection is processed over and above any prompts
     C*   that might have been entered
     C*
     C                     ELSE                            X*2
     C*
     C*   If no subfile written yet,IE still on prompt screen
     C*   then cannot read subfile
     C           *IN27     IFEQ '0'                        B**3
     C*
     C*   Do until either a selection is found on the subfile or
     C*   the end of the subfile is reached
     C           @@SLCT    DOUEQ'Y'                        B***4
     C           *IN70     OREQ '1'                        X***4
     C*
     C*   Read the subfile for the first changed record
     C*
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C**********           READCDL3190S1                 70***4           S01117
     C                     READCTM3190S1                 70***4           S01117
     C                     ELSE                                           S01280
     C                     READCTM3190S2                 70***4           S01280
     C                     END                                            S01280
     C*
     C*   If record found and select field not blank return to
     C*   controlling program with parameters set up as data of
     C*   record selected from subfile
     C           *IN70     IFNE '1'                        B***5
     C           SSSLCT    ANDNE' '                        X***5
     C                     MOVE 'D'       @T               ****5
     C                     MOVE DDCCY     @CPCCY           ****5
     C                     MOVE DDHID     @CPDAT           ****5          S01280
     C**********           MOVE DDDAT     @CPDAT           ****5          S01280
     C**********           MOVE DDTYPE    @CPTYP           ****5          S01280
     C                     MOVEL@PRMCP    @STRNG           ****5
      * move deal types selected to parameter so that when returns from   S01280
      * detailed enquiry reverts to correct selected deals displayed.     S01280
     C                     MOVE DDALL     @LKALL           ****5          S01280
     C                     MOVE DDNA      @LKNA            ****5          S01280
     C                     MOVE DDLD      @LKLD            ****5          S01280
     C                     MOVE DDLEN     @LKLEN           ****5          S01280
     C                     MOVE DDFRA     @LKFRA           ****5          S01280
     C                     MOVE DDIRS     @LKIRS           ****5          S01280
     C                     MOVE DDFUT     @LKFUT           ****5          S01280
     C*
     C*   Set the select field for the record just processed to
     C*   blank and update the subfile.
     C*   Set on the selection processed indicator for when this
     C*   program is recalled
     C*
     C                     MOVE ' '       SSSLCT           ****5
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C**********           UPDATDL3190S1                   ****5          S01117
     C                     UPDATTM3190S1                   ****5          S01117
     C                     ELSE                                           S01280
     C                     UPDATTM3190S2                   ****5          S01280
     C                     END                                            S01280
     C                     MOVE 'Y'       @@SLCT           ****5
     C                     RETRN                           ****5
     C*
     C*   Set off ROLLUP/ROLLDOWN indicators so that if program is
     C*   recalled a roll will not be processed
     C*
     C                     MOVE '0'       *IN25            ****5
     C                     MOVE '0'       *IN26            ****5
     C*
     C                     END                             E****5
     C                     END                             E***4
     C                     END                             E**3
     C*
     C                     MOVE '0'       *IN72            **2
     C*
     C*   If no selection has been found in the subfile then process
     C*   an 'ENTER',ROLLUP or ROLLDOWN.
     C*
     C*   'ENTER' processing
     C*
     C           *IN25     IFNE '1'                        B**3
     C           *IN26     ANDNE'1'                        X**3
     C           *IN05     ANDNE'1'                        ***3
     C           *IN11     ANDNE'1'                        ***3           S01280
     C           *IN11     OREQ '1'                        ***3           S01280
     C           @CHG      ANDEQ'Y'                        ***3           S01280
     C                     EXSR #BC                        ***3
     C                     END                             E**3
     C*
     C*   If rollup has been pressed
     C*
     C           *IN25     IFEQ '1'                        B**3
     C                     Z-ADD@BOTRD    @RRFSH           ***3
     C                     EXSR #BD                        ***3
     C                     END                             E**3
     C*
     C*   If rolldown has been pressed
     C*
     C           *IN26     IFEQ '1'                        B**3
     C                     Z-ADD@TOPRD    @RRFSH           ***3
     C                     EXSR #BE                        ***3
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C*   If the ROLL/REFRESH keys are still inhibited then
     C*   set off the indicator and write header
     C*
      * (only enable rollup/rolldown if subfile has been written)         S01280
     C           @SFILE    IFEQ 'Y'                        B2             S01280
     C                     MOVE '0'       *IN27            *2             S01280
     C                     END                             E2             S01280
     C*
     C** Prevent subfile being displayed (stops screen flashing)
     C*
     C                     MOVE '0'       *IN36            *1             S01280
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C**********           WRITEDL3190F0               63  *1             S01117
     C                     WRITETM3190F0               63  *1             S01117
     C                     ELSE                                           S01280
     C                     WRITETM3190F2               63  *1             S01280
     C                     END                                            S01280
     C*
     C*   Write the message subfile if there is an error to
     C*   display otherwise it will remove any previous error
     C*   messages on the screen
     C*
     C                     MOVE '1'       *IN46            *1
     C**********           WRITEDL3190C0               63  *1             S01117
     C                     WRITETM3190C0               63  *1             S01117
     C*
     C*   Write the command keys test if no error
     C*   (12 = display interpolation + 'closed/open/total pl)            S01280
     C*
     C           @@ERMS    IFEQ 'N'                        B*2
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C                     SETOF                     12                   S01280
     C                     ELSE                                           S01280
     C                     SETON                     12                   S01280
     C                     END                                            S01280
      *                                                                   S01280
     C**********           WRITEDL3190F1               63  **2            S01117
     C                     WRITETM3190F1               63  **2            S01117
     C                     END                             E*2
     C*
     C*    If error leave previous subfile on screen
     C*    If still on prompt screen (is top right hand currency
     C*    field is blank) just write subfile control
     C*
     C********** DDCCY     IFNE @SRCCY                     B*2            S01280
     C********** @RRFSH    ANDEQ*ZERO                      B*2            S01280
     C********** DDCCY     OREQ *BLANKS                    B*2     E21044 S01280
     C           DDCCY     IFEQ *BLANKS                    B*2            S01280
     C           @RRFSH    ANDEQ*ZERO                      B*2            E21044
     C                     MOVE '0'       *IN35            **2
     C                     MOVE '1'       *IN27            **2
     C                     ELSE                            X*2
      *                                                                   S01280
      * Check subfile exists before allowing subfile display to           S01280
      * prevent device error                                              S01280
     C           @SFILE    IFEQ 'Y'                        B*3            S01280
     C                     MOVE '1'       *IN35            **3
     C                     END                             E*3            S01280
      *                                                                   S01280
     C                     END                             E*2
     C*
     C*    Write the subfile control
     C*
     C                     MOVE '1'       *IN36            *1
     C           @SCRN     IFEQ 'FIRST '                                  S01280
     C**********           WRITEDL3190C1               63  *1             S01117
     C                     WRITETM3190C1               63  *1             S01117
     C                     ELSE                                           S01280
     C                     WRITETM3190C2               63  *1             S01280
     C                     END                                            S01280
     C*
     C*   Read the enquiry subfile control for ROLLS/REFRESH/prompts
     C*
     C**********           READ DL3190DD               0573*1             S01117
     C                     READ TM3190DD               0573*1             S01117
     C*
     C*   Process HELP while it is requested and re-read the screen
     C*
     C**         *IN10     DOWEQ'1'                         B*2           S01199
     C**                   CALL 'SDMENU'                    **2           S01199
     C**                   MOVE '0'       *IN10             **2           S01199
     C**                   READ DL3190DD               0573 **2           S01199
     C**                   END                              E*2           S01199
     C*
     C                     END                              E1
     C*
     C           #B9       ENDSR                           ****#B9****
     C*
     C****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                              *
     C*    #BA CARRIES OUT READ FORWARDS PROCESSING.                 *
     C*        CALLED BY  : #BC   #BD                                *
     C*        CALLS      :                                          *
     C*                                                              *
     C*        WORK FIELDS: @CD   - ARRAY OF DATES                   *
     C*                   : @STEND- START/END FOR DISPLAY            *
     C*                   : @DTIN - DATE OF RECORD ON FILE           *
     C*                   : @SDAY - START DATE                       *
     C*                                                              *
     C****************************************************************
     C*
     C           #BA       BEGSR
     C**   Generate dates for the enquiry, going forwards.
     C**    Store start Date.
     C                     Z-ADD@SDAY     @CD,1
     C                     MOVE @SDAY     @@DTIN
     C                     EXSR ZA0680
     C                     MOVE @@MDNO    @@MNO   50
     C                     Z-ADD2         @V      20
     C*
     C**  Store next 15 dates
     C                     DO   15                         B1
     C                     ADD  1         @@MNO            *1
     C                     Z-ADD@@MNO     @@DAYN           *1
     C                     EXSR ZA0710                     *1
     C                     Z-ADD@@VDT     @CD,@V           *1
     C                     ADD  1         @V               *1
     C                     END                             E1
     C*
     C**  Read forward book file
     C                     EXSR #ZE
     C*
     C           #BA9      ENDSR                           ****#BA9****
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*    #BB CARRIES OUT READ BACKWARDS PROCESSING.                *
     C*        CALLED BY  : #BE                                      *
     C*        CALLS      :                                          *
     C*                                                              *
     C*        WORK FIELDS: @CD   - ARRAY OF DATES                   *
     C*                   : @STEND- START/END FOR DISPLAY            *
     C*                   : @DTIN - DATE OF RECORD ON FILE           *
     C*                   : @SDAY - START DATE                       *
     C*                                                              *
     C****************************************************************
     C*
     C           #BB       BEGSR
     C**   Generate dates for the enquiry, going backwards.
     C**    Store start Date.
     C                     Z-ADD@SDAY     @CD,16
     C                     MOVE @SDAY     @@DTIN
     C                     EXSR ZA0680
     C                     MOVE @@MDNO    @@MNO
     C                     Z-ADD15        @Y
     C*
     C**  Calculate previous 15 dates
     C                     DO   15                         B1
     C                     SUB  1         @@MNO            *1
     C                     Z-ADD@@MNO     @@DAYN           *1
     C                     EXSR ZA0710                     *1
     C                     Z-ADD@@VDT     @CD,@Y           *1
     C                     SUB  1         @Y               *1
     C                     END                             E1
     C*
     C**  Read forward book file
     C                     EXSR #ZE
     C*
     C           #BB9      ENDSR                           ****#BB9****
     C*
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*    #BC CARRIES OUT 'ENTER' PROCESSING                        *
     C*        CALLED BY  : #B                                       *
     C*        CALLS      : #BA #BCA                                 *
     C*                                                              *
     C*        WORK FIELDS: @@SRYR- YEAR IN NUMERIC FORM             *
     C*                   : @LDNA - DEAL TYPE FLAG                   *
     C*                   : @DTYPE- DEAL TYPES INCLUDED              *
     C*                   : @SRCCY- CURRENCY SELECTED                *
     C*                   : @SDAY - START DATE                       *
     C*                   : @LDAY - DATE OF LAST RECORD ON FILE      *
     C*                   : @FDAY - DATE OF FIRST RECORD ON FILE     *
     C*                                                              *
     C****************************************************************
     C*
     C           #BC       BEGSR
     C*
     C*
     C*   Validate the prompts entered
     C*
     C                     EXSR #BCA
     C*
     C*   If there was an error set the subfile end indicator on
     C           *IN69     IFEQ '1'                        B1
     C                     MOVE '1'       *IN30            *1
     C                     GOTO #BC9                       *1
     C                     END                             E1
     C*
     C*
     C*   Else clear the subfile and write enquiry subfile control
     C*   format
     C                     MOVE '0'       *IN35
     C                     MOVE '0'       *IN36
     C**********           WRITEDL3190C1               63                 S01117
     C                     WRITETM3190C1               63                 S01117
     C                     WRITETM3190C2               63                 S01280
     C*
     C**  If current year is less than 72 add 1 to current century
     C                     MOVE @SRYR     @@SRYR  20
     C           @@SRYR    IFLT 72                         B1
     C                     ADD  1         @CC              *1
     C                     END                             E1
     C                     Z-ADD@@SRYR    @CCYY
     C                     MOVEL@CC       @CCYY
     C*
     C                     Z-ADD1         X       20
     C           @SRMTH    LOKUP@MT,X                    71
     C                     Z-ADDX         @MM
     C                     MOVE @SRDAY    @GDATE
     C*
     C****Remove '/' from deal type field for use in key to MMFWDDLL      S01280
     C**********                                                          S01280
     C**********           MOVEL@LNCH     @LDNA   2                       S01280
     C**********           MOVE @DACH     @LDNA                           S01280
     C**********                                                          S01280
     C****See*if any records exist for enquiry.                           S01280
     C********** @SRCCY    SETGTMMFWDDLL                                  S01280
     C**********           READPMMFWDDLL                 71               S01280
      *   Set up @PRO if eq N no records to process for file(s)           S01280
      *   selected.                                                       S01280
     C                     MOVE 'N'       @PRO    1                       S01280
     C*                                                                   S01280
      *   If NA selected.                                                 S01280
     C           @DNA      IFNE *BLANK                     B1             S01280
     C                     MOVE 'NA'      @LDNA                           S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DNA                            S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
      *   If LD selected.                                                 S01280
     C           @DLD      IFNE *BLANK                     B1             S01280
     C                     MOVE 'LD'      @LDNA   2                       S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DLD                            S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
      *   If LENDING selected.                                            S01280
     C           @DLEN     IFNE *BLANK                     B1             S01280
     C                     MOVE 'LE'      @LDNA                           S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DLEN                           S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
      *   If FRA selected.                                                S01280
     C           @DFRA     IFNE *BLANK                     B1             S01280
     C                     MOVE 'FR'      @LDNA                           S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DFRA                           S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
      *   If IRS selected.                                                S01280
     C           @DIRS     IFNE *BLANK                     B1             S01280
     C                     MOVE 'IR'      @LDNA                           S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DIRS                           S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
      *   If FUTURES selected.                                            S01280
     C           @DFUT     IFNE *BLANK                     B1             S01280
     C                     MOVE 'FU'      @LDNA                           S01280
     C           @SRCCY    SETGTMMFWDDLL                                  S01280
     C                     READPMMFWDDLL                 71               S01280
      *   If rec found.                                                   S01280
     C           *IN71     IFEQ '0'                        B*2            S01280
     C                     MOVE 'Y'       @PRO                            S01280
      *   No record found.Deselect deal type to prevent future            S01280
      *   processing of this file.                                        S01280
     C                     ELSE                                           S01280
     C                     MOVE *BLANK    @DFUT                           S01280
     C                     END                             E*2            S01280
     C                     END                             E1             S01280
     C*
     C********** *IN71     IFEQ '1'                        B1             S01280
     C           @PRO      IFEQ 'N'                        B1             S01280
     C           @SRCCY    ORNE HSCCY                      *1
     C                     MOVE '1'       *IN30            *1
     C                     MOVEL'RTM0009' @MSGID 10        *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     MOVE 'Y'       @@ERMS  1        *1
     C                     MOVE *BLANKS   @STEND           *1             S01280
     C                     MOVE 'END'     @STEND           *1
     C*                                                                   S01280
     C**  Inhibit Cmd/12                                                  S01280
     C                     MOVE '0'       *IN28            *1             S01280
     C*                                                                   S01280
     C**********           GOTO #BC9                       *1             S01280
     C                     GOTO NORECS                     *1             S01280
     C                     ELSE                            X1
     C                     Z-ADD@DTIN     @LDAY   80       *1
     C*                                                                   S01280
     C**  Allow   Cmd/12                                                  S01280
     C                     MOVE '1'       *IN28            *1             S01280
     C*                                                                   S01280
     C                     END                             E1
     C                     MOVE @SRCCY    @@CCY
     C****If*enquiry is not for all types find the last deal for the      S01280
     C****required type within the currency                               S01280
     C********** @DTYPE    IFNE *BLANKS                    B1             S01280
     C********** @DTYPE    ANDNE'ALL'                      *1             S01280
     C**********                                                          S01280
     C********** *IN71     DOWEQ'0'                        B*2            S01280
     C********** @LDNA     ANDNEHSLDNA                     **2            S01280
     C**********           READPMMFWDDLL                 71**2            S01280
     C**********           END                             E*2            S01280
     C**********           END                             E1             S01280
     C*
     C                     MOVE *BLANKS   @STEND
     C**********                                                          S01280
     C****If*no*records found set on subfile end indicator and set        S01280
     C****START/END indicator to 'END',else save last date                S01280
     C********** *IN71     IFEQ '1'                        B1             S01280
     C********** @SRCCY    ORNE HSCCY                      *1             S01280
     C**********           MOVE '1'       *IN30            *1             S01280
     C**********           MOVE 'END'     @STEND           *1             S01280
      **********                                                   TM0002 S01280
      **Send*error message and set error flag                      TM0002 S01280
     C**********           MOVEL'RTM0009' @MSGID 10        *1      TM0002 S01280
     C**********           CALL 'ZA0240'                   *1      TM0002 S01280
     C**********           PARM           @MSGID           *1      TM0002 S01280
     C**********           MOVE 'Y'       @@ERMS  1        *1      TM0002 S01280
     C**********           GOTO #BC9                       *1      TM0001 S01280
     C**********           GOTO NORECS                     *1      TM0001 S01280
     C**********           END                             E1             S01280
     C*
     C*  Use date from prompts and convert it to a
     C*  MIDAS day number
     C*
     C**********           Z-ADDRUND      @@DAYN                   E12937 S01194
     C                     Z-ADDBJRDNB    @@DAYN                          S01194
     C                     EXSR ZA0710
     C                     Z-ADD@@VDT     @FDAY   80
     C                     MOVE @GDATE    @@DTIN
     C                     EXSR ZA0680
     C                     Z-ADD@@MDNO    @@DAYN                          E12937
     C                     EXSR ZA0710
     C                     Z-ADD@@VDT     @SDAY   80
     C*
     C** If a Date was entered for a new enquiry, see if
     C** is past the last on file. If so perform as LAST.
     C           @SDAY     IFGT @LDAY                      B1
     C                     Z-ADD@LDAY     @SDAY            *1
     C**********           MOVE 'END'     @STEND           *1             S01280
     C                     MOVE 'END  '   @STEND           *1             S01280
     C                     END                             E1
     C** If Date prior to file Start, set to Start.
     C           @SDAY     IFLT @FDAY                      B1
     C                     Z-ADD@FDAY     @SDAY            *1
     C                     MOVE 'START'   @STEND           *1
     C                     END                             E1
     C                     MOVE 'N'       @EQUAL           *1
      *                                                                   S01280
      ** If CMD10 pressed and the input prompts have not changed move     S01280
      ** the date at the top of the screen to @SDAY(rather than the       S01280
      ** date from the input prompts)                                     S01280
     C           @CMD10    IFEQ 'Y'                                       S01280
     C           @CHG      ANDEQ'N'                                       S01280
     C                     MOVE @DAY10    @SDAY                           S01280
     C                     END                                            S01280
     C*
     C                     EXSR #BA
     C*
     C           NORECS    TAG                                            S01280
      *                                                                   S01280
      * If no records found ensure header record set up with new          S01280
      * currency, deal type and interpolation method                      S01280
     C           @@ERMS    IFEQ 'Y'                                       S01280
      *                                                                   S01280
     C                     MOVE *BLANKS   DDMETH                          S01280
     C           @INTM     IFEQ 'L'                                       S01280
     C                     MOVE '*LINEAR*'DDMETH                          S01280
     C                     ELSE                                           S01280
     C                     MOVEL'*WEIGH'  DDMETH                          S01280
     C                     MOVE 'TED*'    DDMETH                          S01280
     C                     END                                            S01280
     C*                                                                   S01280
     C                     MOVE @SRCCY    DDCCY                           S01280
     C**********           MOVE @DTYPE    DDTYPE                   TM0001 S01280
     C                     MOVE @DTYP     DDTYPE                          S01280
     C*                                                                   S01280
     C                     END                                            S01280
     C*                                                                   S01280
     C           #BC9      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*  #BCA- THIS ROUTINE CONTROLS THE VALIDATION OF THE PROMPTS    *
     C*                                                               *
     C*  CALLED BY - #BC                                              *
     C*                                                               *
     C*        WORK FIELDS: @MDIN - MULTIPLY/DIVIDE INDICATOR         *
     C*                   : @@ERMS- ERROR MESSAGE TO DISPLAY          *
     C*                   : @MSGID- MESSAGE ID                        *
     C*                   : @DTYPE- DEAL TYPES INCLUDED               *
     C*                   : @INTM - INTERPOLAITON METHOD              *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BCA      BEGSR
     C*
     C*
     C***Set*up*key*to*obtain*format*TABTG10F*'20******CCY1'***           S01194
     C**********           MOVEL'20'      @KEY   12                       S01194
     C**********           MOVEL@SRCCY    @ENDKY  4                       S01194
     C**********           MOVE '1'       @ENDKY                          S01194
     C**********           MOVE @ENDKY    @KEY                            S01194
     C**********                                                          S01194
     C***Chain*to*file*FDCCYTLL***                                        S01194
     C********** @KEY      CHAINFDCCYTLL             80                   S01194
      *                                                                   S01194
      * Call Access Object for currency details                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           @SRCCY  3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*
     C********** *IN80     IFNE '1'                        B1             S01194
     C           @RTCD     IFNE *BLANKS                    B1             S01194
     C**********           Z-ADDMDIN      @MDIN   10       *1             S01194
     C****If*error*has*occurred***                                        S01194
     C**********           ELSE                            X1             S01194
     C*
     C*   Display message,set on error on validation indicator,reverse
     C*   image the field and position the cursor to show error
     C*
     C                     MOVEL'RTM0002' @MSGID 10        *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C                     MOVE '1'       *IN69            *1
     C                     MOVE '1'       *IN60            *1
     C                     MOVE 'Y'       @@ERMS  1        *1
     C                     END                             E1
     C*
     C*   Validate month
     C                     Z-ADD1         @O      20                      S01280
     C********** @SRMTH    LOKUP@MT                      71               S01280
     C           @SRMTH    LOKUP@MT,@O                   71               S01280
     C*
     C*   Validate yeat - it must be numeric
     C                     TESTN          @SRYR      7373
     C*
     C*   Validate day - it must be numeric
     C                     TESTN          @SRDAY     7373
      *                                                                   S01280
      *   If still valid set up for call to ZA0270.                       S01280
     C           *IN71     IFEQ '1'                                       S01280
     C           *IN73     ANDEQ'1'                                       S01280
      *                                                                   S01280
     C                     MOVE @SRDAY    @@DD                            S01280
     C                     Z-ADD@O        @@MM                            S01280
     C                     MOVE @SRYR     @@YEAR                          S01280
     C                     MOVE 'D'       @DATF   1                       S01280
      *   Convert DDMMYY zoned(from datastructure) to packed for ZA0270   S01280
     C                     Z-ADD@@DMYY    DDMMYY  60                      S01280
      *                                                                   S01280
     C                     CALL 'ZA0270'                                  S01280
     C                     PARM           DDMMYY                          S01280
     C                     PARM           @DATF                           S01280
     C           @RTCDE    PARM           @RTCDE  1                       S01280
     C                     PARM           @@@MNO  50                      S01280
      *                                                                   S01280
     C                     END                                            S01280
     C*
     C*   If error has occurred
     C           *IN71     IFEQ '0'                        B1
     C           *IN73     OREQ '0'                        *1
     C           @RTCDE    OREQ '1'                                       S01280
     C*
     C*   Display message,set on error on validation indicator,reverse
     C*   image the field and position the cursor to show error
     C*
     C                     MOVEL'RTM0003' @MSGID 10        *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C                     MOVE '1'       *IN69            *1
     C                     MOVE '1'       *IN61            *1
     C                     MOVE 'Y'       @@ERMS           *1
     C                     END                             E1
     C*
     C****Validate included deal types - this field must be               S01280
     C****either N/A,L/D or 'ALL'.If it is left blank it should default   S01280
     C****to*'ALL'                                                        S01280
     C**********                                                          S01280
     C********** @DTYPE    IFNE 'N/A'                      B1             S01280
     C********** @DTYPE    ANDNE'L/D'                      *1             S01280
     C********** @DTYPE    ANDNE'ALL'                      *1             S01280
     C********** @DTYPE    ANDNE*BLANKS                    *1             S01280
     C**********                                                          S01280
     C****Display message,set on error on validation indicator,reverse    S01280
     C****image*the field and position the cursor to show error           S01280
     C**********                                                          S01280
     C**********           MOVEL'MMM0582' @MSGID           *1             S01280
     C**********           CALL 'ZA0240'                   *1             S01280
     C**********           PARM           @MSGID           *1             S01280
     C**********                                                          S01280
     C**********           MOVE '1'       *IN69            *1             S01280
     C**********           MOVE '1'       *IN62            *1             S01280
     C**********           MOVE 'Y'       @@ERMS           *1             S01280
     C**********           END                             E1             S01280
     C**********                                                          S01280
     C****If*the field is blank,default to ALL                            S01280
     C********** @DTYPE    IFEQ *BLANKS                    B1             S01280
     C**********           MOVE 'ALL'     @DTYPE           *1             S01280
     C**********           END                             E1             S01280
     C*
     C*  Validate interpolation method - this must be 'W' 'L' or blank.
     C*  If it is blank, default to 'W' - WEIGHTED
     C           @INTM     IFNE *BLANKS                    B1
     C           @INTM     ANDNE'W'                        *1
     C           @INTM     ANDNE'L'                        *1
     C*   If error-
     C*   Display message,set on error on validation indicator,reverst
     C*   image the field and position the cursor to show error
     C*
     C                     MOVEL'MMM0581' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C                     MOVE '1'       *IN69            *1
     C                     MOVE '1'       *IN63            *1
     C                     MOVE 'Y'       @@ERMS           *1
     C                     END                             E1
     C*
     C           @INTM     IFEQ *BLANKS                    B1
     C                     MOVE 'W'       @INTM            *1
     C                     END                             E1
     C*
     C           #BCA9     ENDSR
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*    #BD CARRIES OUT ROLLUP PROCESSING                         *
     C*        CALLED BY  : #B                                       *
     C*        CALLS      : #BA                                      *
     C*                                                              *
     C*        WORK FIELDS: @RRFSH- ROLL/REFRESH PARAMETER           *
     C*                   : @ERROR- ERROR MESSAGE ON VALIDATION      *
     C*                   : @SDAY - START DATE                       *
     C*                                                              *
     C****************************************************************
     C*
     C           #BD       BEGSR
     C*
     C*  If bottom line was blank or if there are no records on
     C*  file after the last record,there are no records to ROLLUP
     C           @RRFSH    IFEQ *ZERO                      B1
     C           @ERROR    OREQ '1'                        *1
     C                     MOVE '1'       *IN30            *1
     C                     ELSE                            X1
     C                     Z-ADD@RRFSH    @SDAY            *1
     C                     Z-ADD@RRFSH    @KDATE           *1
     C*
     C**  See if any records exist for enquiry.
     C           @KEY1     SETLLMMFWDDLL                   *1
     C                     READ MMFWDDLL                 71*1
     C*
     C*   If last record indicator is on,check that this is not
     C*   the last record
     C           *IN71     IFEQ '1'                        B*2
     C           @SDAY     ANDEQ@LDAY                      **2
     C           @EQUAL    ANDNE'Y'                        **2
     C                     MOVE 'Y'       @EQUAL  1        **2
     C                     MOVE '0'       *IN71            **2
     C                     END                             E*2
     C*
     C*  If no records for ROLLUP,or parameters blank
     C           *IN71     IFEQ '1'                        B*2
     C           @SRCCY    ORNE HSCCY                      **2
     C           @TOPRD    OREQ @BOTRD                     **2
     C*  Set subfile end indicator on and display message
     C           *IN05     IFEQ '0'                        B**3
     C                     MOVEL'RTM0001' @MSGID           ***3
     C*
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     MOVE 'Y'       @@ERMS           ***3
     C                     END                             E**3
     C                     MOVE '1'       *IN30            **2
     C                     MOVE 'N'       @EQUAL           **2
     C                     GOTO #BD9                       **2
     C                     END                             E*2
     C                     MOVE *BLANKS   @STEND
     C*
     C*   If not end of file then clear the subfile,set off the
     C*   subfile end indicator
     C*
     C                     MOVE '0'       *IN35            *1
     C                     MOVE '0'       *IN36            *1
     C**********           WRITEDL3190C1               63  *1             S01117
     C                     WRITETM3190C1               63  *1             S01117
     C                     WRITETM3190C2               63  *1             S01280
     C                     MOVE '0'       *IN30            *1
     C*
     C                     EXSR #BA                        *1
     C*
     C                     END                             E1
     C*
     C           #BD9      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*    #BE CARRIES OUT ROLLDOWN PROCESSING                       *
     C*        CALLED BY  : #B                                       *
     C*        CALLS      : #BB                                      *
     C*                                                              *
     C*        WORK FIELDS: @RRFSH- ROLL/REFRESH PARAMETER           *
     C*                   : @ERROR- ERROR MESSAGE ON VALIDATION      *
     C*                   : @SDAY - START DATE                       *
     C*                   : @FDAY - DATE OF FIRST RECORD ON FILE     *
     C*                                                              *
     C****************************************************************
     C*
     C           #BE       BEGSR
     C*
     C*  If top line was blank or if there are no records on
     C*  file after the last record,there are no records to ROLLUP
     C           @RRFSH    IFNE *ZERO                      B1
     C                     Z-ADD@RRFSH    @SDAY            *1
     C*
     C*  If record before first record on file
     C*
     C           @SDAY     IFLE @FDAY                      B*2
     C*
     C*  Set subfile end indicator on and display message
     C                     MOVEL'RTM0001' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     MOVE '1'       *IN30            **2
     C                     MOVE 'Y'       @@ERMS           **2
     C                     GOTO #BE9                       **2
     C                     END                             E*2
     C*
     C*   If not end of file then clear the subfile,set off the
     C*   subfile end indicator
     C*
     C                     MOVE '0'       *IN35            *1
     C                     MOVE '0'       *IN36            *1
     C**********           WRITEDL3190C1               63  *1             S01117
     C                     WRITETM3190C1               63  *1             S01117
     C                     WRITETM3190C2               63  *1             S01280
     C                     MOVE '0'       *IN30            *1
     C*
     C                     EXSR #BB                        *1
     C*
     C           @STEND    IFNE 'START'                    B*2
     C                     MOVE *BLANKS   @STEND           **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C           #BE9      ENDSR
     C*
     C****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*    #ZE Retreive MMFWDDLL records.                            *
     C*        CALLED BY  : #BA #BB                                  *
     C*        CALLS      : #ZB                                      *
     C*                                                              *
     C*        WORK FIELDS: @WORK - DATA STRUCTURE OF DISPLAY FIELDS *
     C*                     @CD   - ARRAY OF DATES                   *
     C*                     @LDNA - DEAL TYPES INCLUDED(WITHOUT SLASH)
     C*                     @STEND- START/END DISPLAY                *
     C*                     @DCIN - STORE DAILY CASH IN              *
     C*                     @DCOT - STORE DAILY CASH OUT             *
     C*                     @DNMT - STORE DAILY NET MOVEMENT         *
     C*                     @DNIM - STORE DAILY NET INTEREST MOVEMENT*
     C*                     @FIXM - STORE FIXED MOVEMENTS            *
     C*                                                              *
     C****************************************************************
      *                                                                   S01280
      *          Notes on the processing in this subroutine:              S01280
      *                                                                   S01280
      *  The calculation for average rate, cash in  is:                   S01280
      *  average rate, cash in  @SAVIN =                                  S01280
      *                                                                   S01280
      *  (Current value * cash in at mdat) + (HSAVIN X HSMAIN)            S01280
      *  -------------------------------------------------------          S01280
      *                       (Total HSMAIN so far)                       S01280
      *                                                                   S01280
      *    ie. =  @WRK1 + @WRK2      in this coding.                      S01280
      *           -------------                                           S01280
      *               @WRK3                                               S01280
      *                                                                   S01280
      *                                                                   S01280
      *  The calculation for average rate, cash out  is:                  S01280
      *  average rate, cash out  @SAVOT =                                 S01280
      *                                                                   S01280
      *  (Current value * cash out at mdat) + (HSAVOT X HSMAOT)           S01280
      *  -------------------------------------------------------          S01280
      *                    (Total HSMAOT so far)                          S01280
      *                                                                   S01280
      *    ie. =  @WRK1 + @WRK2      in this coding.                      S01280
      *           -------------                                           S01280
      *               @WRK3                                               S01280
      *                                                                   S01280
     C****************************************************************    S01280
     C*
     C           #ZE       BEGSR
     C*
      *   Clear out storage arrays.                                       S01280
     C                     MOVE *BLANKS   @H                              S01280
     C                     MOVE *BLANKS   @I                              S01280
     C*
     C*   Fill the subfile in DO-loop
     C**********           Z-ADD0         RRN     20                      S01280
     C                     DO   16        @Y      20       B1
     C                     MOVE *BLANKS   @WORK            *1
     C                     Z-ADD*ZEROS    @VIN             *1             S01280
     C                     Z-ADD*ZEROS    @VOUT            *1             S01280
     C                     Z-ADD*ZEROS    @VNET            *1             S01280
     C                     Z-ADD*ZEROS    @SAVIN           *1             S01280
     C                     Z-ADD*ZEROS    @SAVOT           *1             S01280
     C                     Z-ADD*ZEROS    @SMAIN           *1             S01280
     C                     Z-ADD*ZEROS    @MAOUT           *1             S01280
     C                     Z-ADD*ZEROS    @IINT            *1             S01280
     C                     Z-ADD*ZEROS    @OBSI            *1             S01280
     C                     Z-ADD*ZEROS    @MNET            *1             S01280
     C                     Z-ADD*ZEROS    @CLOP            *1             S01280
     C                     Z-ADD*ZEROS    @OPNP            *1             S01280
     C                     Z-ADD*ZEROS    @CARAT           *1             S01280
     C                     Z-ADD*ZEROS    @OARAT           *1             S01280
     C                     Z-ADD*ZEROS    @MRATE           *1             S01280
     C                     MOVE *BLANKS   @DATE            *1             S01280
     C                     MOVE *BLANKS   @DMKT            *1             S01280
     C                     Z-ADD@CD,@Y    @KDATE           *1
     C                     MOVE 'N'       @FOUND  1        *1             S01280
     C*
     C****If*both deal types are required first retrieve those with       S01280
     C****dela*type 'LD'                                                  S01280
     C********** @DTYPE    IFEQ 'ALL'                      B*2            S01280
     C**********           MOVE 'LD'      @LDNA            **2            S01280
     C**********           END                             E*2            S01280
     C**********                                                          S01280
     C********** @KEY1     CHAINMMFWDDLL             71    *1             S01280
     C**********                                                   S01149 S01280
     C****If*both deal types are required access file again for deaS01149 S01280
     C****type*'NA'                                                S01149 S01280
     C********** @DTYPE    IFEQ *BLANKS                    B*2     S01149 S01280
     C********** @DTYPE    OREQ 'ALL'                      **2     S01149 S01280
     C**********                                                   S01149 S01280
     C********** *IN71     IFEQ '1'                        B**3    S01149 S01280
     C**********           MOVE '0'       *IN71            ***3           S01280
     C**********           MOVE 'F'       @LDFLG  1        ***3           S01280
     C**********           ELSE                            X**3           S01280
     C**********           MOVE 'T'       @LDFLG           ***3           S01280
     C**********                                                   S01149 S01280
     C****Store*'LD' data from MMFWDDLL data fields                S01149 S01280
     C**********           Z-ADDHSDCIN    @DCIN            ***3    S01149 S01280
     C**********           Z-ADDHSDCOT    @DCOT            ***3    S01149 S01280
     C**********           Z-ADDHSDNMT    @DNMT            ***3    S01149 S01280
     C**********           Z-ADDHSDNIM    @DNIM            ***3    S01149 S01280
     C**********           Z-ADDHSFIXM    @FIXM            ***3    S01149 S01280
     C**********           END                             E**3    S01149 S01280
     C**********                                                   S01149 S01280
     C****Retrieve deal type 'NA'                                  S01149 S01280
     C**********           MOVE 'NA'      @LDNA            **2     S01149 S01280
     C********** @KEY1     CHAINMMFWDDLL             71    **2     S01149 S01280
     C**********                                                   S01149 S01280
     C********** @LDFLG    IFEQ 'T'                        B**3    S01149 S01280
     C********** *IN71     IFEQ '0'                        B***4   S01149 S01280
     C**********                                                   S01149 S01280
     C****Add*store of 'LD' data back into to MMFWDDLL data fields S01149 S01280
     C**********           ADD  @DCIN     HSDCIN           ****4   S01149 S01280
     C**********           ADD  @DCOT     HSDCOT           ****4   S01149 S01280
     C**********           ADD  @DNMT     HSDNMT           ****4   S01149 S01280
     C**********           ADD  @DNIM     HSDNIM           ****4   S01149 S01280
     C**********           ADD  @FIXM     HSFIXM           ****4   S01149 S01280
     C**********           ELSE                            X***4   S01149 S01280
     C**********                                                   S01149 S01280
     C****Move*store of 'LD' data back to MMFWDDLL data fields     S01149 S01280
     C**********           MOVE '0'       *IN71            ****4   S01149 S01280
     C**********           Z-ADD@DCIN     HSDCIN           ****4   S01149 S01280
     C**********           Z-ADD@DCOT     HSDCOT           ****4   S01149 S01280
     C**********           Z-ADD@DNMT     HSDNMT           ****4   S01149 S01280
     C**********           Z-ADD@DNIM     HSDNIM           ****4   S01149 S01280
     C**********           Z-ADD@FIXM     HSFIXM           ****4   S01149 S01280
     C**********           END                             E***4   S01149 S01280
     C**********           END                             E**3    S01149 S01280
     C**********                                                   S01149 S01280
     C**********           END                             E*2     S01149 S01280
      **                                                                  S01280
      ** Process Negotiable Assets.                                       S01280
     C           @DNA      IFNE *BLANK                     B*2            S01280
     C                     MOVE 'NA'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1  308                      S01280
     C           HSAVIN    MULT HSMAIN    @WRK2  308                      S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3  308                      S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
     C           @IINT     ADD  HSDNIM    @IINT                           S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      **                                                                  S01280
      ** Process Loans/Deposits.                                          S01280
     C           @DLD      IFNE *BLANK                     B*2            S01280
     C                     MOVE 'LD'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1                           S01280
     C           HSAVIN    MULT HSMAIN    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
     C           @IINT     ADD  HSDNIM    @IINT                           S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      **                                                                  S01280
      ** Process Lending.                                                 S01280
     C           @DLEN     IFNE *BLANK                     B*2            S01280
     C                     MOVE 'LE'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1                           S01280
     C           HSAVIN    MULT HSMAIN    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
     C           @IINT     ADD  HSDNIM    @IINT                           S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      **                                                                  S01280
      ** Process FRA's.                                                   S01280
     C           @DFRA     IFNE *BLANK                     B*2            S01280
     C                     MOVE 'FR'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1                           S01280
     C           HSAVIN    MULT HSMAIN    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
     C           @OBSI     ADD  HSDNIM    @OBSI                           S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      **                                                                  S01280
      ** Process IRS's.                                                   S01280
     C           @DIRS     IFNE *BLANK                     B*2            S01280
     C                     MOVE 'IR'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1                           S01280
     C           HSAVIN    MULT HSMAIN    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
      *                                                                   S01280
      * Interest not reflected for IRS                                    S01280
     C********** @IINT     ADD  HSDNIM    @IINT                    S01280 S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      **                                                                  S01280
      ** Process Futures.                                                 S01280
     C           @DFUT     IFNE *BLANK                     B*2            S01280
     C                     MOVE 'FU'      @LDNA                           S01280
     C           @KEY1     CHAINMMFWDDLL             71                   S01280
      *                                                                   S01280
      *  If record found.                                                 S01280
     C           *IN71     IFEQ '0'                        B**3           S01280
      *  Set record found flag to Y.                                      S01280
     C                     MOVE 'Y'       @FOUND                          S01280
      *  Accumulate totals.                                               S01280
     C           @VIN      ADD  HSDCIN    @VIN                            S01280
     C           @VOUT     ADD  HSDCOT    @VOUT                           S01280
     C           @VNET     ADD  HSDNMT    @VNET                           S01280
      *                                                                   S01280
      *  Calculate Average Rate In.                                       S01280
     C           HSMAIN    IFNE *ZEROS                     B***4          S01280
     C           @SAVIN    MULT @SMAIN    @WRK1                           S01280
     C           HSAVIN    MULT HSMAIN    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @SMAIN    ADD  HSMAIN    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVIN                          S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      *  Calculate Average Rate Out.                                      S01280
     C           HSMAOT    IFNE *ZEROS                     B***4          S01280
     C           @SAVOT    MULT @MAOUT    @WRK1                           S01280
     C           HSAVOT    MULT HSMAOT    @WRK2                           S01280
     C           @WRK1     ADD  @WRK2     @WRK1                           S01280
     C           @MAOUT    ADD  HSMAOT    @WRK3                           S01280
     C           @WRK1     DIV  @WRK3     @SAVOT                          S01280
     C                     END                             E***4          S01280
      *  Accumulate totals.                                               S01280
     C           @SMAIN    ADD  HSMAIN    @SMAIN                          S01280
     C           @MAOUT    ADD  HSMAOT    @MAOUT                          S01280
     C           @OBSI     ADD  HSDNIM    @OBSI                           S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
     C                     END                             E*2            S01280
      *                                                                   S01280
      *   Store data from data structure into an array.                   S01280
     C           @FOUND    IFEQ 'Y'                                       S01280
      *   Convert date to screen format.                                  S01280
     C                     Z-ADD@CD,@Y    @@DTIN                          S01280
     C                     EXSR ZA0720                                    S01280
     C                     MOVE @@DATE    @DATE                           S01280
      *                                                                   S01280
     C                     SETOF                     71                   S01280
     C                     MOVE @STORE    @H,@Y                           S01280
     C                     ELSE                                           S01280
     C                     SETON                     71                   S01280
     C                     END                                            S01280
     C*
     C*   Store/edit fields
     C********** *IN71     IFEQ '0'                        B*2            S01280
     C           *IN71     IFEQ '1'                        B*2            S01280
     C**********           EXSR #ZB                        **2            S01280
     C**********           ELSE                            X*2            S01280
      *  If no record found, Convert date and store.
     C                     Z-ADD@CD,@Y    @@DTIN           **2
     C                     EXSR ZA0720                     **2
     C                     MOVE @@DATE    DDDAT            **2
     C*
     C                     MOVE *BLANKS   @WORK            **2
     C                     MOVE '1'       *IN15            **2
     C                     END                             E*2
      *
     C*
     C*   Make sure last subfile record is blank (to avoid
     C*   obscuring some of the data)
     C*
     C           @Y        IFEQ 16                         B*2
     C                     MOVE *BLANKS   @WORK            **2
     C                     MOVE *BLANKS   DDDAT            **2
     C                     MOVE '1'       *IN15            **2
     C                     END                             E*2
      *
      *  Store Roll Top/Bottom.
     C           @Y        IFEQ 1                          B*2
     C                     MOVEL@CD,@Y    @TOPRD  80       **2
     C                     END                             E*2
     C           @Y        IFEQ 16                         B*2
     C                     MOVEL@CD,@Y    @BOTRD  80       **2
     C                     END                             E*2
     C*
     C*  If the start date is the last date on file,set the
     C*  bottom record parameter to the start date
     C*
     C           @SDAY     IFEQ @LDAY                      B*2
     C                     MOVE @SDAY     @BOTRD           **2
     C                     END                             E*2
     C*  Set START/END of Currency legend.
     C           @LDAY     IFEQ @CD,@Y                     B*2
     C**********           MOVE 'END'     @STEND           **2            S01280
     C                     MOVE 'END  '   @STEND           **2            S01280
     C                     END                             E*2
     C           @FDAY     IFEQ @CD,@Y                     B*2
     C********** @STEND    ANDNE'END'                      B*2            S01280
     C           @STEND    ANDNE'END  '                    B*2            S01280
     C                     MOVE 'START'   @STEND           **2
     C                     END                             E*2
     C*
     C                     MOVE *ZEROS    @DTIN            *1
     C*
     C*   Set up interpolation method,currency and deal type to display
     C*
     C                     MOVE *BLANKS   DDMETH
     C           @INTM     IFEQ 'L'                        B*2
     C                     MOVE '*LINEAR*'DDMETH           **2
     C                     ELSE                            X*2
     C                     MOVEL'*WEIGH'  DDMETH           **2
     C                     MOVE 'TED*'    DDMETH           **2
     C                     END                             E*2
     C*
     C                     MOVE @SRCCY    DDCCY            *1
     C**********           MOVE @DTYPE    DDTYPE           *1             S01280
     C                     MOVE @DTYP     DDTYPE           *1             S01280
     C*
     C**********           ADD  1         RRN              *1             S01280
     C**********           WRITEDL3190S1                   *1             S01117
     C**********           WRITETM3190S1                   *1      S01117 S01280
     C                     END                             E1
      *                                                                   S01280
      *  Store the input prompts.                                         S01280
     C                     MOVE @SRCCY    @SECCY  3                       S01280
     C                     MOVE @SRDAT    @SEDAT  7                       S01280
     C                     MOVE DDALL     @SEALL  1                       S01280
     C                     MOVE DDNA      @SENA   1                       S01280
     C                     MOVE DDLD      @SELD   1                       S01280
     C                     MOVE DDLEN     @SELEN  1                       S01280
     C                     MOVE DDFRA     @SEFRA  1                       S01280
     C                     MOVE DDIRS     @SEIRS  1                       S01280
     C                     MOVE DDFUT     @SEFUT  1                       S01280
     C                     MOVE @INTM     @SENTM  1                       S01280
      *                                                                   S01280
      *  Once the information has been stored(@STORE) do totals processingS01280
     C                     EXSR #ZF                                       S01280
     C*                                                                   S01280
     C*  Edit and write to subfile.                                       S01280
     C                     EXSR #ZG                                       S01280
     C*
      * Set on subfile written flag used in #B                            S01280
     C                     MOVEL'Y'       @SFILE  1                       S01280
      *                                                                   S01280
     C           #ZE9      ENDSR
     C*
     C****************************************************************
     C/EJECT
     C*****************************************************************   S01280
      *                                                               *   S01280
      * #ZF      - TOTALS PROCESSING.                                 *   S01280
      *                                                               *   S01280
      *                                                               *   S01280
      * CALLS    -  MM1000                                            *   S01280
      *             #ZD                                               *   S01280
      *             MM1017                                            *   S01280
      *                                                               *   S01280
      * CALLED BY  #ZE     -  ACCESS LF/MMFWDDLL                      *   S01280
      *                                                               *   S01280
      * FLDS USED                                                     *   S01280
      *                                                               *   S01280
      *                     @MNET - NET                               *   S01280
      *                     @CLOP - CLOSED POSITION                   *   S01280
      *                     @OPNP - OPEN POSITION                     *   S01280
      *                     @CARAT- CLOSED AVERAGE RATE               *   S01280
      *                     @OARAT- OPEN AVERAGE RATE                 *   S01280
      *                     @MRATE- MARKET RATE                       *   S01280
      *                                                               *   S01280
      ****************************************************************    S01280
      *                                                                   S01280
      *          Notes on the processing in this subroutine:              S01280
      *                                                                   S01280
      * The calculation for closed P/L is:                                S01280
      * closed P/L              @CLOPL =                                  S01280
      * _                                              _                  S01280
      *| @closed avrate   days in period                |    @off         S01280
      *| -------------- x ---------------  x @closed pos| +  balance      S01280
      *|      100           days in year                |    sheet        S01280
      *|_                                              _|    interest     S01280
      *                                                                   S01280
      *  which equals                                                     S01280
      * _                                              _                  S01280
      *|    @CARAT            @@PER                     |                 S01280
      *| ------------- x ---------------- x  @CLOP      | +   @OBSI       S01280
      *|      100             @DYR                      |                 S01280
      *|_                                              _|                 S01280
      *                                                                   S01280
      * The calculation for open P/L is:                                  S01280
      * open P/L                @OPNPL =                                  S01280
      *                                                                   S01280
      *                                                                   S01280
      *  @open av. rate   days in period                                  S01280
      *  -------------- x ---------------  x @open pos                    S01280
      *       100           days in year                                  S01280
      *                                                                   S01280
      *                                                                   S01280
      *  which equals                                                     S01280
      *                                                                   S01280
      *     @OARAT            @@PER                                       S01280
      *  ------------- x ---------------- x  @OPNP                        S01280
      *       100             @DYR                                        S01280
      *                                                                   S01280
      *                                                                   S01280
      * The calculation for total P/L is:                                 S01280
      * total P/L               @TOTPL =                                  S01280
      *                                                                   S01280
      *         @OPEN P/L  + @CLOSED P/L                                  S01280
      *                                                                   S01280
      *                                                                   S01280
     C*****************************************************************   S01280
      *                                                                   S01280
     C           #ZF       BEGSR                                          S01280
      *                                                                   S01280
      *                                                                   S01280
      *  Do 16 times.                                                     S01280
     C                     DO   16        @X      20       B1             S01280
      *  Retrieve 1 day's worth of data from @H                           S01280
     C                     MOVEA@H,@X     @STORE                          S01280
      *                                                                   S01280
      *  Only do if details exist(If details exist @DATE will always be   S01280
      *  nonblank.                                                        S01280
     C           @DATE     IFNE *BLANKS                    B*2            S01280
      *                                                                   S01280
      *  Calculate further workfields to be stored on @STORE.             S01280
     C           @SMAIN    SUB  @MAOUT    @MNET                           S01280
     C           @MNET     ADD  @VNET     @MNET                           S01280
      *                                                                   S01280
      *  Convert date from data structure DDMMMYY to YYYYMMDD.            S01280
      *                                                                   S01280
     C                     Z-ADD*ZEROS    @RDATE                          S01280
     C                     MOVE @DATE     @SDATE                          S01280
     C                     MOVE @RECYY    @@RECY  20                      S01280
     C                     Z-ADD@@RECY    @RCYY                           S01280
     C                     MOVEL@CC       @RCYY                           S01280
      *                                                                   S01280
     C                     Z-ADD1         @S      20                      S01280
     C           @RECMM    LOKUP@MT,@S                   71               S01280
     C                     Z-ADD@S        @RMM                            S01280
     C                     MOVE @RECDD    @RDATE                          S01280
     C                     MOVE @RDATE    @DTIN                           S01280
      *                                                                   S01280
      *  Calculate market rates(check for database error in subroutine)   S01280
      *  From spot to day in qustion.                                     S01280
     C           @RDATE    IFGT A6MMSD                     B**3           S01280
     C                     MOVE @DTIN     @@VDT                           S01280
     C                     MOVE @SRCCY    @@CCY                           S01280
     C                     MOVE @INTM     @@INTM                          S01280
     C                     MOVE A6MMSD    @@MSPD                          S01280
     C                     EXSR MM1000                                    S01280
      *  If database error                                                S01280
     C           *INU7     IFEQ '1'                        B***4          S01280
     C                     EXSR #ZD                                       S01280
     C                     END                             E***4          S01280
      *                                                                   S01280
      ** If prior to spot, then show zeros                                S01280
     C                     ELSE                            X**3           S01280
     C                     Z-ADD*ZERO     @@LERC                          S01280
     C                     Z-ADD*ZERO     @@BORC                          S01280
     C                     END                             E**3           S01280
      *                                                                   S01280
      *  The following calculations depends on the relationship between   S01280
      *  the day's 'Maturity In' and the day's 'Maturity Out'.            S01280
      *                                                                   S01280
      *  Maturity In > Maturity Out.                                      S01280
     C           @SMAIN    IFGT @MAOUT                     B**3           S01280
      *                                                                   S01280
     C                     Z-ADD@MAOUT    @CLOP                           S01280
     C           @SMAIN    SUB  @MAOUT    @OPNP                           S01280
     C***********@SAVIN    SUB  @SAVOT    @CARAT                    S01280S01280
     C           @SAVIN    SUB  @@LERC    @OARAT                          S01280
     C                     Z-ADD@@LERC    @MRATE                          S01280
     C                     END                             B**3           S01280
      *                                                                   S01280
      *  Maturity In < Maturity Out.                                      S01280
     C           @SMAIN    IFLT @MAOUT                     B**3           S01280
      *                                                                   S01280
     C                     Z-ADD@SMAIN    @CLOP                           S01280
     C           @MAOUT    SUB  @SMAIN    @OPNP                           S01280
     C***********@SAVOT    SUB  @SAVIN    @CARAT                    S01280S01280
     C           @@BORC    SUB  @SAVOT    @OARAT                          S01280
     C                     Z-ADD@@BORC    @MRATE                          S01280
     C                     END                             B**3           S01280
      *                                                                   S01280
      *  Maturity In = Maturity Out.                                      S01280
     C           @SMAIN    IFEQ @MAOUT                     B**3           S01280
      *                                                                   S01280
     C                     Z-ADD@SMAIN    @CLOP                           S01280
     C                     Z-ADD*ZEROS    @OPNP                           S01280
     C***********@SAVIN    SUB  @SAVOT    @CARAT                    S01280S01280
     C                     Z-ADD*ZEROS    @OARAT                          S01280
     C                     Z-ADD@@LERC    @MRATE                          S01280
     C                     END                             B**3           S01280
      *                                                                   S01280
      ** Obtain difference between the in/out average rates for closed    S01280
      ** p/l. In at mdate is equivalent to a loan placed. So if in av.    S01280
      ** rate > out average rate will get a profit (+ve) result.          S01280
     C           @SAVIN    SUB  @SAVOT    @CARAT                          S01280
      *                                                                   S01280
     C*  Work out days in year according to default interest              S01280
     C*  calculation method                                               S01280
     C           A6DICB    IFEQ '1'                        B**3           S01280
     C           A6DICB    OREQ '4'                                       S01280
     C                     Z-ADD365       @DYR    30                      S01280
     C                     END                             E**3           S01280
     C           A6DICB    IFEQ '2'                        B**3           S01280
     C           A6DICB    OREQ '3'                                       S01280
     C           A6DICB    OREQ '5'                                       S01280
     C                     Z-ADD360       @DYR                            S01280
     C                     END                             E**3           S01280
     C           A6DICB    IFEQ '6'                        B**3           S01280
     C                     Z-ADD366       @DYR                            S01280
     C                     END                             E**3           S01280
      *                                                                   S01280
      *  If current day is less than mm spot date @closed/@open/@total    S01280
      *  p/l are blank.                                                   S01280
     C           @RDATE    IFLE @@MSPD                     B**3           S01280
     C                     Z-ADD*ZEROS    @CLOPL                          S01280
     C                     Z-ADD*ZEROS    @OPNPL                          S01280
     C                     Z-ADD*ZEROS    @TOTPL                          S01280
     C                     ELSE                            X**3           S01280
      *  Calculate @closed P/L.                                           S01280
      *  Check that @CARAT is not zero,if zero @closed P/L = @OBSI     .  S01280
     C           @CARAT    IFEQ *ZEROS                     B***4          S01280
     C                     Z-ADD@OBSI     @CLOPL                          S01280
     C                     ELSE                            X***4          S01280
     C           @CARAT    MULT @@PER     @WRK1                           S01280
     C           @WRK1     MULT @CLOP     @WRK2                           S01280
     C           @DYR      MULT 100       @WRK3                           S01280
     C           @WRK2     DIV  @WRK3     @CLOPL    H                     S01280
     C           @CLOPL    ADD  @OBSI     @CLOPL                          S01280
     C                     END                             E***4          S01280
      *  Calculate @open P/L.                                             S01280
      *  Check that @OARAT & @OPNP are not zero,if zero @closed P/L = 0.  S01280
     C           @OARAT    IFEQ *ZEROS                     B***4          S01280
     C           @OPNP     OREQ *ZEROS                                    S01280
     C                     Z-ADD*ZEROS    @OPNPL                          S01280
     C                     ELSE                            X***4          S01280
     C           @OARAT    MULT @@PER     @WRK1                           S01280
     C           @WRK1     MULT @OPNP     @WRK2                           S01280
     C           @DYR      MULT 100       @WRK3                           S01280
     C           @WRK2     DIV  @WRK3     @OPNPL    H                     S01280
     C                     END                             E***4          S01280
      *  Calculate @total P/L.                                            S01280
     C           @CLOPL    ADD  @OPNPL    @TOTPL                          S01280
      *                                                                   S01280
     C                     END                             E**3           S01280
      *                                                                   S01280
      *  Store the data into the array.                                   S01280
      *  2 STORE ARRAYS USED AS CAN ONLY HANDLE 256 CHARACTERS.           S01280
     C                     MOVE @STORE    @H,@X                           S01280
     C                     MOVE @STOR1    @I,@X                           S01280
      *                                                                   S01280
     C                     END                             E*2            S01280
      *                                                                   S01280
     C                     END                             E1             S01280
      *                                                                   S01280
     C                     ENDSR                                          S01280
      *                                                                   S01280
     C****************************************************************
     C/EJECT
     C*****************************************************************
      *                                                               *   S01280
      * #ZG      - EDIT AND FILL SUBFILES                             *   S01280
      *                                                               *   S01280
      *                                                               *   S01280
      * CALLS    -                                                    *   S01280
      *                                                               *   S01280
      *                                                               *   S01280
      *                                                               *   S01280
      * CALLED BY  #ZE     -  ACCESS LF/MMFWDDLL                      *   S01280
      *                                                               *   S01280
      * FLDS USED                                                     *   S01280
      *                                                               *   S01280
      ****************************************************************    S01280
     C*                                                                   S01280
     C           #ZG       BEGSR                                          S01280
     C*   Fill the subfile in DO-loop                                     S01280
     C                     Z-ADD0         RRN     20                      S01280
     C                     Z-ADD0         @N      20                      S01280
     C                     DO   16        @N               B1             S01280
      *                                                                   S01280
      *   Retrieve data.                                                  S01280
     C                     MOVEA@H,@N     @STORE                          S01280
      *                                                                   S01280
      **  Edit date.                                                      S01280
     C                     Z-ADD@CD,@N    @KDATE                          S01280
     C                     MOVEL@KDATE    @@DTIN                          S01280
     C                     EXSR ZA0720                                    S01280
      *                                                                   S01280
      *   If first time through set up month at top of screen.            S01280
     C           @N        IFEQ 1                                         S01280
     C                     MOVE @SCRDT    DDMTH                           S01280
      *   store this top date for later processing                        S01280
     C                     Z-ADD@KDATE    @DAY10  80                      S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Set up days down the left hand edge of the screen.              S01280
     C                     MOVE @DAY      DDDAT                           S01280
      *                                                                   S01280
      *   Only do if details exist(@DATE = nonblank).                     S01280
     C           @DATE     IFEQ *BLANKS                                   S01280
     C                     MOVE *BLANKS   @WORK                           S01280
      *  Set up select field to non display.                              S01280
     C                     MOVE '1'       *IN15                           S01280
     C                     ELSE                                           S01280
      *  Record found set select field to display.                        S01280
     C                     MOVE '0'       *IN15                           S01280
      *                                                                   S01280
      *   Edit Maturity in.                                               S01280
     C                     Z-ADD@SMAIN    @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1015                                    S01280
     C                     MOVE @@AMNT    @@IN1   9                       S01280
     C                     MOVE @@IN1     DDMIN                           S01280
     C                     MOVE @@IN1     DDMATI                          S01280
      *                                                                   S01280
      *   Edit Maturity out.                                              S01280
     C                     Z-ADD@MAOUT    @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1015                                    S01280
     C                     MOVE @@AMNT    @@OUT1  9                       S01280
     C                     MOVE @@OUT1    DDMUT                           S01280
     C                     MOVE @@OUT1    DDMATO                          S01280
      *                                                                   S01280
      *   Edit Value in.                                                  S01280
     C                     Z-ADD@VIN      @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1015                                    S01280
     C                     MOVE @@AMNT    @@IN2   9                       S01280
     C                     MOVE @@IN2     DDVIN                           S01280
      *                                                                   S01280
      *   Edit Value out.                                                 S01280
     C                     Z-ADD@VOUT     @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1015                                    S01280
     C                     MOVE @@AMNT    @@OUT2  9                       S01280
     C                     MOVE @@OUT2    DDVUT                           S01280
      *                                                                   S01280
      *   Edit Net.                                                       S01280
     C                     Z-ADD@MNET     @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1016                                    S01280
     C                     MOVE @@AMOU    @@IN3   9                       S01280
     C                     MOVE @@IN3     DDNET1                          S01280
      *                                                                   S01280
      *   Edit Interest.                                                  S01280
      *                                                                   S01280
      *   Interest on file is stored 10 times greater than actually is,   S01280
      *   therefore divide by 10.                                         S01280
      *   (N.B This does not apply to off balance sheet interest (FRA's   S01280
      *   and FUTURES) where DL3340 updates their interest correctly to beS01280
      *   used in the profit and loss calculations.)                      S01280
     C           @IINT     IFNE *ZERO                                     S01280
     C           @IINT     DIV  10        @@DNIM 151H                     S01280
     C                     Z-ADD@@DNIM    @@IAMT    H                     S01280
     C                     ELSE                                           S01280
     C*****                Z-ADD@IINT     @@IAMT                   S01280 S01280
     C                     Z-ADD*ZERO     @@IAMT                          S01280
     C                     Z-ADD*ZERO     @@DNIM                          S01280
     C                     END                                            S01280
      *                                                                   S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1016                                    S01280
     C                     MOVE @@AMOU    @@IN4   9                       S01280
     C                     MOVE @@IN4     DDINT                           S01280
      *                                                                   S01280
      *   Add Net to Interest to obtain Balance.                          S01280
      * Use correct interest amount as set up above                       S01280
     C********** @MNET     ADD  @IINT     @@IN5  150               S01280 S01280
     C           @MNET     ADD  @@DNIM    @@IN5  150                      S01280
     C                     Z-ADD@@IN5     @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1016                                    S01280
     C                     MOVE @@AMOU    @@IN13  9                       S01280
     C                     MOVE @@IN13    DDBAL                           S01280
      *                                                                   S01280
      *   Edit Average Interest In.                                       S01280
      *                                                                   S01280
      *   If @SAVIN = 0 set DDAVIN to 0.0(otherwise would be 0.)          S01280
     C           @SAVIN    IFEQ *ZEROS                                    S01280
     C                     MOVE *BLANKS   DDAVIN                          S01280
     C                     MOVE '0.0'     DDAVIN                          S01280
     C                     ELSE                                           S01280
     C                     Z-ADD@SAVIN    @@INP1    H                     S01280
     C                     EXSR #ZH                                       S01280
     C                     MOVE @@OUT3    DDAVIN                          S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Edit Average Interest Out.                                      S01280
      *                                                                   S01280
      *   If @SAVOT = 0 set DDAVOT to 0.0(otherwise would be 0.)          S01280
     C           @SAVOT    IFEQ *ZEROS                                    S01280
     C                     MOVE *BLANKS   DDAVOT                          S01280
     C                     MOVE '0.0'     DDAVOT                          S01280
     C                     ELSE                                           S01280
     C                     Z-ADD@SAVOT    @@INP1    H                     S01280
     C                     EXSR #ZH                                       S01280
     C                     MOVEL@@OUT3    DDAVOT                          S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Edit Net Interest.                                              S01280
     C           @SMAIN    SUB  @MAOUT    @@IN8  150                      S01280
     C                     Z-ADD@@IN8     @@IAMT                          S01280
     C                     MOVE A6CYCD    @@CCY                           S01280
     C                     MOVE A6NBDP    @@CDP                           S01280
     C                     EXSR MM1016                                    S01280
     C                     MOVE @@AMOU    @@IN9   9                       S01280
     C                     MOVE @@IN9     DDNET                           S01280
      *                                                                   S01280
      *   Edit Market Rate.                                               S01280
     C                     Z-ADD@MRATE    @@INPR                          S01280
     C                     EXSR MM1017                                    S01280
     C                     MOVEL@@OUTR    @@C12  12                       S01280
     C                     MOVE @@C12     DDMKT                           S01280
      *                                                                   S01280
      *   Retrieve data from second array for TOTAL/OPEN/CLOSED P/L       S01280
     C                     MOVEA@I,@N     @STOR1                          S01280
      *                                                                   S01280
      *   @TOGLE = A = TOTAL. @TOGLE = B = OPEN. @TOGLE = C = CLOSED P/L  S01280
     C           @TOGLE    IFEQ 'A'                        B*2            S01280
     C                     Z-ADD@TOTPL    @@IN11 150                      S01280
     C                     END                             E*2            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'B'                        B*2            S01280
     C                     Z-ADD@OPNPL    @@IN11                          S01280
     C                     END                             E*2            S01280
      *                                                                   S01280
     C           @TOGLE    IFEQ 'C'                        B*2            S01280
     C                     Z-ADD@CLOPL    @@IN11                          S01280
     C                     END                             E*2            S01280
      *                                                                   S01280
      *   Edit P/L.                                                       S01280
     C                     Z-ADD@@IN11    @PLOSS 150                      S01280
      *                                                                   S01280
     C           1         ADD  A6NBDP    @U      10                      S01280
     C                     Z-ADD@CP,@U    @SCAL1 100                      S01280
     C           @PLOSS    DIV  @SCAL1    @PLOSS    H                     S01280
     C                     Z-ADD@PLOSS    @@NUM                           S01280
      *                                                                   S01280
     C                     EXSR ZA0860                                    S01280
     C                     MOVE @@ALPH    DDPLU                           S01280
     C                     END                                            S01280
      *                                                                   S01280
     C                     ADD  1         RRN                             S01280
      *                                                                   S01280
      *   Blank out last subfile record.                                  S01280
     C           @N        IFEQ 16                                        S01280
     C                     MOVE *BLANKS   @WORK                           S01280
     C                     MOVE *BLANKS   DDDAT                           S01280
     C                     MOVE '1'       *IN15                           S01280
     C                     END                                            S01280
      *                                                                   S01280
      *   Move date to hidden subfile field for use if record selected.   S01280
     C                     MOVE @DATE     DDHID                           S01280
      *                                                                   S01280
     C                     WRITETM3190S1                                  S01280
     C                     WRITETM3190S2                                  S01280
     C                     END                             E1             S01280
     C*                                                                   S01280
     C           #ZG9      ENDSR                                          S01280
     C*****************************************************************   S01280
     C/EJECT                                                              S01280
     C*****************************************************************   S01280
     C*                                                               *   S01280
     C* #ZH    - Subroutine to convert a rate to display, no sign     *   S01280
     C*          It is based on MM1017 and is needed to format the    *   S01280
     C*          rate to a 9 long field as opposed to a 13 long field.*   S01280
     C*                                                               *   S01280
     C* CALLED BY :                                                   *   S01280
     C*                                                               *   S01280
     C* CALLS :                                                       *   S01280
     C*                                                               *   S01280
     C* INPUT  : @@INP1  Rate to be edited.                           *   S01280
     C*                                                               *   S01280
     C* OUTPUT : @@OUT3  Edited output rate.                          *   S01280
     C*                                                               *   S01280
     C* USES :   @@INP1  Rate to be edited.                           *   S01280
     C*          @@OUT3  Edited output rate.                          *   S01280
     C*          @@DEC1  Field to hold decimal digits for input rate. *   S01280
     C*          @@INT1  Field to hold integers for input rate.       *   S01280
     C*          @N1    Counter field.                                *   S01280
     C*          @Q1    Second counter field.                         *   S01280
     C*          @@STR1 Rate start position after zero suppression.   *   S01280
     C*          @B     Work array.                                   *   S01280
     C*                                                               *   S01280
     C*****************************************************************   S01280
     C           #ZH       BEGSR                                          S01280
     C*                                                                   S01280
     C**  Define fields used.                                             S01280
     C                     Z-ADD@@INP1    @@INP1  86                      S01280
     C                     MOVE *BLANKS   @@OUT3  9                       S01280
     C                     MOVE *BLANKS   @@DEC1  6                       S01280
     C                     MOVE *BLANKS   @@INT1  2                       S01280
     C                     Z-ADD0         @N1     20                      S01280
     C                     Z-ADD0         @Q1     20                      S01280
     C                     Z-ADD0         @@STR1  20                      S01280
     C*                                                                   S01280
     C**  Initialise work array.                                          S01280
     C                     MOVEA*BLANKS   @B                              S01280
     C*                                                                   S01280
     C**  If the rate is negative reverse the sign.                       S01280
     C           @@INP1    IFLT 0                          B1             S01280
     C                     Z-SUB@@INP1    @@INP1           *1             S01280
     C                     END                             E1             S01280
     C*                                                                   S01280
     C**  Seperate integers and decimal digits into two fields.           S01280
     C*                                                                   S01280
     C                     MOVEL@@INP1    @@INT1                          S01280
     C                     MOVE @@INP1    @@DEC1                          S01280
     C*                                                                   S01280
     C**  Move integers, decimal seperator and decimal digits into        S01280
     C**  work array.                                                     S01280
     C                     MOVEA@@INT1    @B                              S01280
     C*********************MOVE*IDDCSP****@B,3**********************S01280S01319
     C                     MOVE BNDCSP    @B,3                            S01319
     C                     MOVEA@@DEC1    @B,4                            S01280
     C*                                                                   S01280
     C**  Remove leading zeros from the rate and replace with blanks.     S01280
     C                     Z-ADD1         @N1                             S01280
     C           @N1       DOWLE1                          B1             S01280
     C           @B,@N1    ANDEQ'0'                        X1             S01280
     C                     MOVE *BLANK    @B,@N1           *1             S01280
     C                     ADD  1         @N1              *1             S01280
     C                     END                             E1             S01280
     C*                                                                   S01280
     C                     Z-ADD@N1       @@STR1                          S01280
     C*                                                                   S01280
     C**  Truncate trailing zeros and replace with blanks. If rate is     S01280
     C**  an integer a single zero after the decimal place should be      S01280
     C**  displayed.                                                      S01280
     C                     Z-ADD8         @N1                             S01280
     C           @N1       DOWGE2                          B1             S01280
     C           @B,@N1    ANDEQ'0'                        X1             S01280
     C                     MOVE *BLANK    @B,@N1           *1             S01280
     C                     SUB  1         @N1              *1             S01280
     C                     END                             E1             S01280
     C*                                                                   S01280
     C**  Right justify the array.                                        S01280
     C                     Z-ADD8         @Q1                             S01280
     C           @N1       IFNE @Q1                        B1             S01280
     C           @N1       DOWGE@@STR1                       B2           S01280
     C                     MOVE @B,@N1    @B,@Q1             *2           S01280
     C                     MOVE *BLANK    @B,@N1             *2           S01280
     C                     SUB  1         @N1                *2           S01280
     C                     SUB  1         @Q1                *2           S01280
     C                     END                               E1           S01280
     C                     END                             E2             S01280
     C*                                                                   S01280
     C**  Move the final array into the output field.                     S01280
     C                     MOVEA@B        @@OUT3                          S01280
     C*                                                                   S01280
     C                     ENDSR                                          S01280
     C****************************************************************    S01280
     C/EJECT                                                              S01280
     C*****************************************************************
     C*                                                               *
     C* #ZA      - RESET ERROR INDICATORS AND CLEAR MESSAGE QUEUE     *
     C*                                                               *
     C*                                                               *
     C* CALLS    - ZA0250  -  CLEAR PROGRAM SUBFILE MESSAGE QUEUE     *
     C*                                                               *
     C* CALLED BY  #B      -  MAIN PROCESSING                         *
     C*                                                               *
     C* FLDS USED  @@ERMS  - ERROR-MESSAGE-TO-DISPLAY INDICATOR       *
     C*                                                               *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C** Reset all field error indicators.
     C*
     C                     MOVE '0'       *IN60
     C                     MOVE '0'       *IN61
     C                     MOVE '0'       *IN62
     C                     MOVE '0'       *IN63
      ** Reset screen input indicators.                                   S01280
     C                     MOVE *BLANKS   @DALL                           S01280
     C                     MOVE *BLANKS   @DNA                            S01280
     C                     MOVE *BLANKS   @DLD                            S01280
     C                     MOVE *BLANKS   @DLEN                           S01280
     C                     MOVE *BLANKS   @DFRA                           S01280
     C                     MOVE *BLANKS   @DIRS                           S01280
     C                     MOVE *BLANKS   @DFUT                           S01280
      ** Reset CMD10 pressed indicator                                    S01280
     C                     MOVE 'N'       @CMD10  1                       S01280
     C*
     C** Reset the general-error-on-validation indicator
     C*
     C                     MOVE '0'       *IN69
     C*
     C*
     C** reset the error-message-to-display indicator
     C*
     C                     MOVE 'N'       @@ERMS  1
     C*
     C** Clear screen message queue.
     C*
     C                     CALL 'ZA0250'
     C*
     C           #ZA9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C* ZA0720 - THIS SUBROUTINE CONVERTS DATE FORMAT YYYYMMDD TO
     C*          DDMMMYY OR TO MMMDDYY DEPENDING UPON THE VALUE OF
     C***********TABTB10*-*ICDR1***                                       S01194
     C*          BJDFIN (DATE FORMAT INDICATOR FROM SDBANKPD)             S01194
     C*
     C* CALLED BY :
     C*
     C* CALLS :
     C*
     C* INPUT  : @@DTIN DATE INPUT (YYYYMMDD)  - IN DATA STRUCTURE
     C*
     C* OUTPUT : @@DATE DATE OUTPUT 7 DIGIT FORMAT EITHER
     C*          DDMMMYY OR MMMDDYY
     C*
     C* USES :   @@MTH  MONTH NUMBER
     C*          @@MNM  MONTH SHORTNAME
     C*          @@DAY  DAY NUMBER
     C*          @@YYYY YEAR (4 CHARACTER)
     C*          @MT    RUN TIME ARRAY FOR MONTH SHORTNAMES
     C*          @@DAY5 DAY NUMBER WITH THREE LEADING BLANKS
     C*          @@MTH5 MONTH SHORTNAME WITH TWO LEADING BLANKS
     C*          @@DATE OUTPUT DATE FIELD
     C********************************************************************
     C           ZA0720    BEGSR
     C*
     C**   TABTB10F  IS EXPECTED FILE MOVE CODING 2 LEFT TO REMOVE **
     C**           KEY       CHAINTABTB10F             80
     C*
     C**   FDMNTHP0  IS EXPECTED FILE MOVE CODING 2 LEFT TO REMOVE **
     C**           SS0720    CHAINFDMNTHP0             80
     C*
     C**  CONVERT DATE FORMAT
     C********** DATF      IFEQ 'M'                        B1             S01194
     C           BJDFIN    IFEQ 'M'                        B1             S01194
     C*
     C**  CONVERT TO MMMDDYY
     C                     MOVE @@DAY     @@DAY5  5        *1
     C                     MOVE @@YYYY    @@DATE  7        *1
     C                     MOVEL@@DAY5    @@DATE           *1
     C                     MOVEL@MT,@@MTH @@DATE           *1
     C                     ELSE                            X1
     C*
     C**  CONVERT TO DDMMMYY
     C                     MOVE @MT,@@MTH @@MTH5  5
     C                     MOVE @@YYYY    @@DATE  7        *1
     C                     MOVEL@@MTH5    @@DATE           *1
     C                     MOVEL@@DAY     @@DATE           *1
     C                     END                             E1
     C*
     C**  END OF SUBROUTINE
     C           ZA0729    ENDSR                              *** ZA0720 T
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*     #A CARRIES OUT INITIALISATION PROCESSING.                *
     C*        CALLED BY  : MAIN PROGRAM                             *
     C*        CALLS      :                                          *
     C*                                                              *
     C*        WORK FIELDS: @T       - TERMINATION INPUT PARAMETER   *
     C*                   : @STRNG   - ENTRY PARAMETER (CURRENCY,    *
     C*                                DATE AND DEAL NO.)            *
     C****************************************************************
     C           #A        BEGSR
      *                                                                   S01319
      * Bring in values to be displayed on screen.                        S01319
     C                     MOVEL'ZZGBMSGF'MSGNM                           S01319
     C                     MOVEL'ZZM0267' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB  7                       S01319
     C                     PARM           MSGNM  10                       S01319
     C                     PARM           MSGTXT 80                       S01319
     C                     MOVELMSGTXT    ZZM030                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM0612' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM031                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM6143' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM032                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM3879' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM033                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5001' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM034                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5002' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM035                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5003' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM036                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5004' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM037                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5005' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM038                          S01319
      *                                                                   S01319
     C                     MOVEL'ZZM5006' MSGDNB                          S01319
     C                     CALL 'SDRTVTXT'                                S01319
     C                     PARM           MSGDNB                          S01319
     C                     PARM           MSGNM                           S01319
     C                     PARM           MSGTXT                          S01319
     C                     MOVELMSGTXT    ZZM039                          S01319
     C*
     C**  Initialise screen message queue
     C                     MOVEL'*'       DDPGMQ
     C*
     C**  Receive input parameters
     C           *ENTRY    PLIST
     C                     PARM           @T      1
     C                     PARM           @STRNG
     C*
     C**  Move program name into status data structure field.
     C**********           MOVEL'DL3190'  DBPGM                           S01117
     C                     MOVEL'TM3190'  DBPGM                           S01117
     C*
     C**  If termination paramtere is 'T', set LR. No further
     C**  processing in this routine.
     C           @T        IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     GOTO #A9                        *1
     C                     END                             E1
     C*
     C**  Key list for LF/FXFDDLLL
     C           @KEY1     KLIST
     C                     KFLD           @SRCCY
     C                     KFLD           @KCCYY  40
     C                     KFLD           @KMM    20
     C                     KFLD           @KDD    20
     C                     KFLD           @LDNA
     C*
     C********** *LIKE     DEFN RUND      @@DAYN                          S01194
     C           *LIKE     DEFN BJRDNB    @@DAYN                          S01194
     C           *LIKE     DEFN HSDCIN    @DCIN
     C           *LIKE     DEFN HSDCOT    @DCOT
     C           *LIKE     DEFN HSDNMT    @DNMT
     C           *LIKE     DEFN HSDNIM    @DNIM
     C           *LIKE     DEFN HSFIXM    @FIXM
     C           *LIKE     DEFN DDALL     @DALL                           S01280
     C           *LIKE     DEFN DDNA      @DNA                            S01280
     C           *LIKE     DEFN DDLD      @DLD                            S01280
     C           *LIKE     DEFN DDLEN     @DLEN                           S01280
     C           *LIKE     DEFN DDFRA     @DFRA                           S01280
     C           *LIKE     DEFN DDIRS     @DIRS                           S01280
     C           *LIKE     DEFN DDFUT     @DFUT                           S01280
     C*
     C*
     C**  Check if this is the first time this program has been
     C**  called in the current invocation and perform the appropriate
     C**  processing.
     C           @FCYC     IFNE 'Y'                        B1
     C*                                                    *1
     C*
     C**  Open files
     C**********           OPEN FDICDRLL                   *1             S01194
     C*********************OPEN*FDINSTLL********************1*************S01319
     C                     OPEN FDINTDLL                   *1
     C**********           OPEN FDCCYTLL                   *1             S01194
     C                     OPEN FDMNTHLL                   *1
     C                     OPEN MMFWDDLL                   *1
     C*********************OPEN*FDUSSILL********************1*************S01319
     C                     OPEN MUSER                      *1             S01319
     C                     OPEN DLMMTOLL                   *1             S01280
     C*                                                    *1
     C*********************MOVEL@USER*****@USER3**3*********1*************S01319
     C********************************************************************S01319
     C***********@USER3****CHAINFDUSSILL*************71*****1*************S01319
     C********************************************************************S01319
     C**Database*error*of*user*not*found:*********************************S01319
     C************IN71*****IFEQ*'1'************************B*2************S01319
     C*********************MOVE*'901'*****DBASE**************2************S01319
     C*********************MOVE*'FDUSSILL'DBFILE*************2************S01319
     C*********************MOVEL@USER3****DBKEY**************2*ERROR******S01319
     C*********************MOVE*'1'********INU7**************2**901*******S01319
     C*********************MOVE*'1'********INU8**************2************S01319
     C*********************GOTO*#A9**************************2************S01319
     C*********************END*****************************E*2************S01319
     C           @USER     CHAINMUSER                71                   S01319
     C*                                                                   S01319
     C           *IN71     IFEQ '1'                        B*2            S01319
     C*                                                                   S01319
     C                     MOVEL'MUSER'   DBFILE           ***************S01319
     C                     MOVE '901'     DBASE            *             *S01319
     C                     MOVEL@USER     DBKEY            * DBERROR 901 *S01319
     C                     MOVE '1'       *INU7                           S01319
     C                     MOVE '1'       *INU8            ************** S01319
     C                     GOTO #A9                                       S01319
     C*                                                                   S01319
     C                     END                             E*2            S01319
     C*
     C* Do display file override before open
     C***********USREF*****IFEQ*'Y'                        B*2            S01319
     C           AURF      IFEQ 'Y'                        B*2            S01319
     C                     MOVEL@OVR,1    @OVRID           **2
     C*********************Z-ADDUSRFPD****@WAIT**************2************S01319
     C                     Z-ADDREFP      @WAIT            **2            S01319
     C                     Z-ADD36        QCALEN 155       **2
     C*********************CALL 'QCAEXEC'                  **2            E20774
     C                     CALL 'QCMDEXC'                  **2            E20774
     C                     PARM           @OVRID           **2
     C                     PARM           QCALEN           **2
     C                     END                             E*2
     C*
     C**********           OPEN DL3190DD                                  S01117
     C                     OPEN TM3190DD                                  S01117
     C*
     C*   Access installation control record for decimal separator
     C***********1*********CHAINFDINSTLL*************71*******************S01319
     C********************************************************************S01319
     C****Deal*with*data*base*error***************************************S01319
     C************IN71*****IFEQ*'1'************************B*2************S01319
     C***********MNDLTF****OREQ*'*'**************************2************S01319
     C*********************MOVE*'FDINSTLL'DBFILE*************2************S01319
     C*********************MOVE*'004'*****DBASE**************DB*ERR*004***S01319
     C*********************EXSR*#ZD**************************2************S01319
     C*********************GOTO*#A9**************************2************S01319
     C*********************END*****************************E*2************S01319
     C** Access Deal details via access program                           S01319
      *  (database error handling done in access program)                 S01319
     C**********           CALL 'AODEALR0'                                             S01319 CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01319
     C                     PARM '*FIRST ' @OPTN   7                       S01319
     C********** SDDEAL    PARM SDDEAL    DSFDY                                        S01319 CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
     C**  Access month shortnames file
     C           1         CHAINFDMNTHLL             71
     C*
     C**  Deal with data base error
     C           *IN71     IFEQ '1'                        B*2
     C           MNDLTF    OREQ '*'                        **2
     C                     MOVE 'FDMNTHLL'DBFILE           **2*********
     C                     MOVE '001'     DBASE            * DB ERR 001
     C                     EXSR #ZD                        **2*********
     C                     GOTO #A9                        **2
     C                     END                             E*2
     C*
     C****Call*S/R*to*access*ICD*file***                                  S01194
     C**********           EXSR ZA0150                     *1             S01194
      *                                                                   S01194
      * Get Bank's details from SDBANKPD via Access Object                S01194
      * (Note that *DBERR is used as standard return code although        S01194
      * this will not normally produce a DB error due to access           S01194
      * object having already been called in SD1600)                      S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C*                                                                   S01194
     C****Check*for*database*error***                                     S01194
     C********** *IN80     IFEQ '1'                        B*2            S01194
     C**********           EXSR #ZD                        **2            S01194
     C**********           GOTO #A9                        **2            S01194
     C**********           END                             E*2            S01194
      *                                                                   S01280
      *   Pre S01280 date displayed down left hand side was DDMMMYY       S01280
      *   when DATF was D and MMMDDYY when DATF was M.Now with just       S01280
      *   the days down the left hand side and the month and year         S01280
      *   shown at the top,DATF as MMMDDYY is no longer relevant.         S01280
     C           BJDFIN    IFEQ 'M'                                       S01280
     C                     MOVE 'D'       BJDFIN                          S01280
     C                     END                                            S01280
      *                                                                   S01194
      * Get Module details via Access Object                              S01194
     C                     CALL 'AOMMODR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01194
      *                                                                   S01280
      * Check whether Lending, Futures and FRA/IRS modules present        S01280
      *                                                                   S01280
      * Lending                                                           S01280
     C           BGCSLN    IFEQ 'Y'                                       S01280
     C                     MOVE '1'       *IN41                           S01280
     C                     END                                            S01280
     C** Futures                                                          S01280
     C           BGFUOP    IFEQ 'Y'                                       S01280
     C                     MOVE '1'       *IN43                           S01280
     C                     END                                            S01280
      **  FRA/IRS                                                         S01280
     C           BGFIIN    IFEQ 'Y'                                       S01280
     C                     MOVE '1'       *IN42                           S01280
     C                     END                                            S01280
     C************************************************************* E28491S01319
     C****Avoid*IBM*subfile*fault/omission*re*multilanguage*subfilesE28491S01319
     C****initialising*literals*used*by*format*TM3190C1*************E28491S01319
     C*********************MOVE 'Currency'@TXT1                     E28491S01319
     C*********************MOVE 'Date'    @TXT2                     E28491S01319
     C*********************MOVEA@TXT,1    @TXT3                     E28491S01319
     C*********************MOVE 'ALL'     @TXT4                     E28491S01319
     C*********************MOVE 'N/A'     @TXT5                     E28491S01319
     C*********************MOVE 'L/D'     @TXT6                     E28491S01319
     C*********************MOVE 'LEN'     @TXT7                     E28491S01319
     C*********************MOVE 'FRA'     @TXT8                     E28491S01319
     C*********************MOVE 'IRS'     @TXT9                     E28491S01319
     C*********************MOVE 'FUT'     @TXT10                    E28491S01319
     C*
     C**  Set flag to indicate first invocation processing has
     C**  been successfully completed                      *1
     C                     MOVE 'Y'       @FCYC   1        *1
     C                     END                             E1
     C*
     C**  Find current century
     C**********           Z-ADDRUND      @@DAYN                          S01194
     C                     Z-ADDBJRDNB    @@DAYN                          S01194
     C                     EXSR ZA0710
     C                     MOVEL@@SSY1    @CC     20
     C                     MOVE @@SSY2    @CC
     C*
     C*  Initialize Data Structure.
     C                     Z-ADD*ZEROS    @GDATE
     C**********           Z-ADD*ZEROS    @DD                             S01280
     C**********           Z-ADD*ZEROS    @YY                             S01280
      *                                                                   S01280
      **  Set up '* TAKE ON IN PROGRESS *' or 'LAST TAKE ON xx:xx:xx      S01280
      *                                                                   S01280
     C           1         SETLLDLMMTOLL                                  S01280
     C                     READ DLMMTOLL                 79               S01280
      *                                                                   S01280
     C           TOTOIP    IFEQ 'Y'                                       S01280
     C                     MOVEL'* TAKE ' @TKON                           S01280
     C                     MOVE 'ON IN '  @TKON                           S01280
     C                     MOVE 'PR'      @PR                             S01280
     C                     MOVEL'OGRESS ' @OGR                            S01280
     C                     MOVE '*'       @OGR                            S01280
     C                     MOVE @TOIP     DDSTS                           S01280
     C                     ELSE                                           S01280
     C                     MOVEL' LAST T' @LTON                           S01280
     C                     MOVE 'AKE ON'  @LTON                           S01280
     C                     MOVE *BLANKS   @BLNK                           S01280
     C                     MOVE @@SEC     @SEC                            S01280
     C                     MOVE ':'       @DASH1                          S01280
     C                     MOVE @@MIN     @MIN                            S01280
     C                     MOVE ':'       @DASH2                          S01280
     C                     MOVE @@HOUR    @HOUR                           S01280
     C                     MOVE @LTONT    DDSTS                           S01280
     C                     END                                            S01280
     C*                                                                   S01280
     C*
     C*   Set off all indicators
     C                     MOVE '0'       *IN,01
     C*
     C*   Inhibit roll keys and set on end of message and enquiry
     C*   subfile indicators
     C                     MOVE '1'       *IN27
     C                     MOVE '1'       *IN40
     C                     MOVE '1'       *IN30
      *                                                                   S01280
      *   Set up F11 screen togle.                                        S01280
     C                     MOVEL'profitab'DDOPTN                          S01280
     C                     MOVE 'ility'   DDOPTN                          S01280
      *                                                                   S01280
      *   Clear screen select prompts in case returning from DL3200       S01280
      *   and prompts have been changed.                                  S01280
     C                     MOVE *BLANK    DDALL                           S01280
     C                     MOVE *BLANK    DDNA                            S01280
     C                     MOVE *BLANK    DDLD                            S01280
     C                     MOVE *BLANK    DDLEN                           S01280
     C                     MOVE *BLANK    DDFRA                           S01280
     C                     MOVE *BLANK    DDIRS                           S01280
     C                     MOVE *BLANK    DDFUT                           S01280
     C*
     C*   Retrieve workstation ID and write out the screen header
     C*   and command key text
     C                     MOVEL@JOB      @WSID
     C**********           WRITEDL3190F0               63                 S01117
     C                     WRITETM3190F0               63                 S01117
     C**********           WRITEDL3190F1               63                 S01117
     C                     WRITETM3190F1               63                 S01117
     C*
     C*   Clear the subfile by setting off the subfile display
     C*   and subfile control indicators, then write enquiry
     C*   subfile control format
     C*
     C                     MOVE '0'       *IN35
     C                     MOVE '0'       *IN36
     C**********           WRITEDL3190C1               63                 S01117
     C                     WRITETM3190C1               63                 S01117
     C*
     C*  Set up prompts
     C                     MOVE @STCCY    @SRCCY
     C                     MOVE @STDAY    @SRDAY
     C                     MOVE @STMTH    @SRMTH
     C                     MOVE @STYR     @SRYR
     C**********           MOVE @STTYP    @DTYPE                          S01280
     C                     MOVE @SRCCY    DDCCY
     C*
     C*  If parameters blank,write the prompt screen by setting on
     C*  the subfile display control indicator,otherwise set on
     C*  the 'PARAMETERS PASSED' field.
     C           @STRNG    IFEQ *BLANKS                    B1
     C                     MOVE '1'       *IN36            *1
     C**********           EXFMTDL3190C1               63  *1             S01117
     C                     EXFMTTM3190C1               63  *1             S01117
     C                     ELSE                            X1
     C                     MOVE @STDNO    @CPDNO           *1
     C**********           MOVE *BLANKS   @STRNG           *1             S01280
     C                     END                             E1
      *                                                                   S01280
     C                     MOVE 'FIRST '  @SCRN   6                       S01280
     C*
     C** Process HELP while it is requested and re-read the screen
     C*
     C**         *IN10     DOWEQ'1'                        B1             S01199
     C**                   CALL 'SDMENU'                   *1             S01199
     C**                   MOVE '0'       *IN10            *1             S01199
     C**                   READ DL3190C1               0573*1             S01199
     C**                   END                             E1             S01199
     C*
     C           #A9       ENDSR                           ***#A9***
     C****************************************************************
      /EJECT
     C****************************************************************
     C*                                                              *
     C*     #C CARRIES OUT THE TERMINATION PROCESSING.               *
     C*        CALLED BY  : MAIN PROGRAM                             *
     C*        CALLS      :                                          *
     C*                                                              *
     C*        WORK FIELDS:                                          *
     C*                                                              *
     C****************************************************************
     C           #C        BEGSR
     C*
     C           *INU7     IFEQ '1'                        B1
     C                     MOVE 'E'       @T               *1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C*
     C           @T        IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C*
     C           *IN01     IFEQ '1'                        B1
     C                     MOVE 'Q'       @T               *1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C*
     C           *IN02     IFEQ '1'                        B1
     C                     MOVE DDCCY     @CPCCY           *1
     C**********           MOVE DDTYPE    @CPTYP           *1             S01280
     C                     MOVEL@TOPRD    @@DTIN           *1
     C                     EXSR ZA0720                     *1
     C                     MOVE @@DATE    @CPDAT           *1
     C                     MOVEL@PRMCP    @STRNG           *1
     C                     MOVE DDALL     @LKALL           *1             S01280
     C                     MOVE DDNA      @LKNA            *1             S01280
     C                     MOVE DDLD      @LKLD            *1             S01280
     C                     MOVE DDLEN     @LKLEN           *1             S01280
     C                     MOVE DDFRA     @LKFRA           *1             S01280
     C                     MOVE DDIRS     @LKIRS           *1             S01280
     C                     MOVE DDFUT     @LKFUT           *1             S01280
     C                     MOVE 'U'       @T               *1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C*
     C                     RETRN
     C*
     C           #C9       ENDSR                           ***#C9***
     C/EJECT
     C*****************************************************************   S01194
     C**********                                                      *   S01194
     C***SUBROUTINE ZA0150 - THIS SUBROUTINE CHAINS TO FILE LF        *   S01194
     C***FDICDRLL TO GET THE INSTALLATION CONTROL DETAILS RECORD 1    *   S01194
     C***(HELD*ON PF/TABTB10)                                         *   S01194
     C***INDICATOR 80 IS SET ON IF THE CHAIN FAILS OR THE RECORD IS   *   S01194
     C***FLAGGED FOR DELETION.                                        *   S01194
     C***IF*INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED ACCESS    *   S01194
     C***ARE*PLACED IN THE LDA.                                       *   S01194
     C**********                                                      *   S01194
     C***FIELDS*USED : SS0150 - KEY USED TO ACCESS FDICDRLL           *   S01194
     C**********                                                      *   S01194
     C*****************************************************************   S01194
     C**********                                                          S01194
     C********** ZA0150    BEGSR                                          S01194
     C**********                                                          S01194
     C***Set*up*key to obtain format TABTB10F '01        10'              S01194
     C**********           MOVEL'01'      SS0150 12                       S01194
     C**********           MOVE '10'      SS0150                          S01194
     C**********                                                          S01194
     C***CHAIN*TO FILE FDICDRLL                                           S01194
     C********** SS0150    CHAINFDICDRLL             80                   S01194
     C********** RECI      IFNE 'D'                        B1             S01194
     C**********           MOVE '1'       *IN80            *1             S01194
     C**********           END                             E1             S01194
     C**********                                                          S01194
     C***DEAL*WITH DATA BASE ERROR                                        S01194
     C********** *IN80     IFEQ '1'                        ***************S01194
     C**********           MOVEL'FDICDRLL'DBFILE           *             *S01194
     C**********           MOVEL'900'     DBASE            * DBERROR 900 *S01194
     C**********           MOVELSS0150    DBKEY            *             *S01194
     C**********           END                             ***************S01194
     C**********                                                          S01194
     C********** ZA0159    ENDSR                                          S01194
     C/EJECT
     C*****************************************************************
      *                                                               *
      *       TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *
      *                                                               *
      *       SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *
      *       PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *
      *       THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *
      *       SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *
      *       IF '@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *
      *       '@@VDT'  IN 'YYYYMMDD' FORMAT.                          *
      *                                                               *
      * NOTE: FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS
      *                                                               *
      *       1) @@DAYN   LENGTH 5,0.                                 *
      *                                                               *
      *       FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *
      *                                                               *
      *       1) @@VDT    LENGTH 8,0 DEFINED BY A DS.                 *
      *       2) @@RTN    LENGTH 1,0.                                 *
      *       3) @@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *
      *       4) @@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *
      *       5) @@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *
      *       6) @@RDAY   LENGTH 5,0.                                 *
      *       7) @@LEAP   LENGTH 1,0.
      *                                                               *
      *       INDICATORS USED ARE:                                    *
      *                                                               *
      *       1) 80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *
      *       2) 81       CHECK FOR LOW ON ARRAY @MD.                 *
      *                                                               *
      * INPUT FIELD:       @@DAYN                                     *
      *                                                               *
      * OUTPUT FIELD:      @@VDT                                      *
      *                                                               *
      * WORK FIELDS:       @@RTN                                      *
      *                    @@Z71Y                                     *
      *                    @@RDAY                                     *
      *                    @@LEAP                                     *
      *                    @@I                                        *
      *                    @@J                                        *
      *                                                               *
      * ARRAYS USED:       @YD COMPILE TIME ARRAY.
      *                    @MD COMPILE TIME ARRAY.
      *
      *****************************************************************
     C*
     C           ZA0710    BEGSR
     C*
     C                     SETOF                     8081
     C                     Z-ADD0         @@RTN   10
     C                     Z-ADD0         @@VDT
     C                     Z-ADD1         @@I     20
     C                     Z-ADD1         @@J     20
     C                     Z-ADD1         @@LEAP  10
     C*
     C           @@DAYN    IFLT 1
     C                     Z-ADD1         @@RTN
     C                     GOTO ZA0719
     C                     END
     C*
     C* DIVISION TO DETERMINE WETHER LEAP YEAR.
     C*
     C           @@DAYN    DIV  1461      @@Z71Y
     C                     MVR            @@RDAY  50
     C*
     C* CALCULATING YEAR.
     C*
     C           @@Z71Y    MULT 4         @@Z71Y
     C                     ADD  1972      @@Z71Y
     C*
     C* CHECKING IF YEAR IS GREATER THAN OR EQUAL TO 2100
     C*
     C           @@Z71Y    IFGE 2100
     C                     ADD  @@SSY2    @@RDAY
     C                     END
     C*
     C* LOKUP ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE
     C* HAVE PASSED.
     C*
     C           @@RDAY    LOKUP@YD,@@I                8080
     C*
     C* IF YEAR IS A LEAP YEAR SSLEAP IS SET TO ZERO.
     C*
     C           *IN80     IFEQ '0'
     C                     Z-ADD0         @@LEAP
     C                     END
     C*
     C* ADD INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.
     C*
     C           @@LEAP    IFEQ 1
     C           @@RDAY    SUB  @YD,@@I   @@RDAY
     C                     ADD  @@I       @@Z71Y
     C                     END
     C*
     C* PROCESSING FOR A LEAP YEAR.
     C*
     C           @@LEAP    IFEQ 0
     C*
     C* IF '@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.
     C*
     C           @@RDAY    IFEQ 60
     C                     Z-ADD29        @@Z71D
     C                     Z-ADD2         @@Z71M
     C                     GOTO ZA0711
     C                     END
     C*
     C* IF '@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN
     C* PROCEED AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP
     C* YEAR. NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.
     C*
     C           @@RDAY    IFGT 60
     C           @@RDAY    SUB  1         @@RDAY
     C                     END
     C*
     C                     END
     C*
     C* IF DAY '@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS
     C* IN 4 YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR
     C* GROUP.
     C*
     C           @@RDAY    IFEQ 0
     C                     Z-ADD31        @@Z71D
     C                     Z-ADD12        @@Z71M
     C                     SUB  1         @@Z71Y
     C                     GOTO ZA0711
     C                     END
     C*
     C* LOOK UP ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'
     C* OCCURS IN
     C*
     C           @@RDAY    LOKUP@MD,@@J                81
     C                     Z-ADD@@J       @@Z71M
     C           @@RDAY    SUB  @MD,@@J   @@Z71D
     C*
     C* DS @@VDT  IS RETURNED IN YYYYMMDD FORMAT
     C*
     C           ZA0711    TAG
     C*
     C                     MOVE @@Z71Y    @@YR
     C*
     C           ZA0719    ENDSR
     C*
     C*****************************************************************   SO1166
     C/EJECT
     C*****************************************************************
     C*
     C* ZA0680 - THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO
     C*          MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)
     C*
     C* CALLED BY :
     C*
     C* CALLS :
     C*
     C* INPUT  : @@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)
     C*
     C* OUTPUT : @@MDNO MIDAS DAY NUMBER  (SIZE : 5N)
     C*
     C* USES :   @@CC   NUMBER OF CENTURIES IN DATE
     C*          @@DAY  DAY NUMBER
     C*          @@REM  REMAINDER FROM DIVIDE
     C*          @@MTH  MONTH NUMBER
     C*          @MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN
     C*                 MONTH
     C*          @@WK2  WORK FIELD (2,0)
     C*          @@WK5  WORK FIELD (5,0)
     C*          @@YYYY YEAR (4 CHARACTER)
     C*          @@YY   YEAR (2 CHARACTER)
     C*          @YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN
     C*                 A FOUR YEAR PERIOD
     C*
     C*******************************************************************
     C*
     C           ZA0680    BEGSR
     C*
     C**  CLEAR OUT ANY 'OLD' DATA IN FIELD
     C                     Z-ADD0         @@MDNO  50
     C*
     C**   IF DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING
     C           @@YYYY    IFGE 2072                       B1
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)
     C           @@CC      SUB  19        @@WK2   20       *1
     C           @@WK2     MULT 36524     @@MDNO           *1
     C*
     C**  YEAR 2000 IS A LEAP YEAR MUST ALLOW EXTRA DAY
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C           @@YYYY    ADD  28        @@WK2
     C*
     C           @@WK2     DIV  4         @@WK2
     C                     MVR            @@REM   10
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD
     C           @@WK2     MULT 1461      @@WK5   50
     C                     ADD  @@WK5     @@MDNO
     C*
     C**  CHECK REMAINDER AND MONTH NUMBER
     C           @@REM     IFEQ 0                          B1
     C           @@MTH     ANDGT2                          B1
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C**  YEAR NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR
     C           @@REM     IFNE 0                          B1
     C                     ADD  @YD,@@REM @@MDNO           *1
     C                     END                             E1
     C*
     C**  ADD MONTHS THIS YEAR
     C                     ADD  @MD,@@MTH @@MDNO
     C*
     C**  ADD DAYS THIS MONTH
     C                     ADD  @@DAY     @@MDNO
     C*
     C           ZA0689    ENDSR                           **ZA0689 TAG**
     C*****************************************************************
     C*****************************************************
     C*                                                   *
     C*   EXCEPTION ERROR SUBROUTINE                      *
     C*                                                   *
     C*   SUBROUTINE CALLED: EXECUTES WHENEVER            *
     C*   A DATABASE FILE ERROR OCCURS                    *
     C*                                                   *
     C*   SUBROUTINE CALLS : NO OTHER SUBROUTINES         *
     C*                                                   *
     C*****************************************************
     C           #ZD       BEGSR
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE 'E'       @T
     C**********           MOVEL'DL3190'  DBPGM                           S01117
     C                     MOVEL'TM3190'  DBPGM                           S01117
     C*
     C                     DUMP
     C*
     C**  TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           ****#ZD*****
     C/EJECT
     C*****************************************************
     C*                                                   *
     C*   EXCEPTION ERROR SUBROUTINE                      *
     C*                                                   *
     C*   SUBROUTINE CALLED: EXECUTES WHENEVER            *
     C*   A PROGRAM ERROR OCCURS                          *
     C*                                                   *
     C*   SUBROUTINE CALLS : NO OTHER SUBROUTINES         *
     C*                                                   *
     C*****************************************************
     C           *PSSR     BEGSR
     C*
     C**  SET @ERR1 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR1     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
     C                     MOVE 'E'       @T               *1
     C*
     C**  SET UP FIELDS IN LOCAL DATA AREA
     C**********           MOVEL'DL3190'  DBPGM            *1             S01117
     C                     MOVEL'TM3190'  DBPGM            *1             S01117
     C                     MOVE '991'     DBASE            *1
     C*
     C                     DUMP                            *1
     C                     END                             E1
     C*
     C**  TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           ****PSSR****
     C/EJECT
     C*****************************************************
     C*                                                   *
     C*   EXCEPTION ERROR SUBROUTINE                      *
     C*                                                   *
     C*   SUBROUTINE CALLED: EXECUTES WHENEVER            *
     C*   A FILE ERROR OCCURS                             *
     C*                                                   *
     C*   SUBROUTINE CALLS : NO OTHER SUBROUTINES         *
     C*                                                   *
     C*****************************************************
     C           INFSR     BEGSR
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE 'E'       @T
     C*
     C**  SET UP FIELDS IN LOCAL DATA AREA
     C**********           MOVEL'DL3190'  DBPGM                           S01117
     C                     MOVEL'TM3190'  DBPGM                           S01117
     C                     MOVE '992'     DBASE
     C                     MOVE @FILE     DBFILE
     C*
     C                     DUMP
     C*
     C**  TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           ***INFSR***
     C/EJECT
      ***       ** Scaling factors array - @SF                            S01280
      ***       0000000001  Removed by S01280 and renamed @CP             S01280
      ***       0000000010                                                S01280
      ***       0000000100                                                S01280
      ***       0000001000                                                S01280
      ***       0000010000                                                S01280
      ***       0000100000                                                S01280
      ***       0001000000                                                S01280
      ***       0010000000                                                S01280
      ***       0100000000                                                S01280
      ***       1000000000                                                S01280
** @YD  USED BY SR. ZA0710 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZA0710 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** Scaling factors array - @SF(RENAMED @CP S01280)
0000000001
0000000010
0000000100
0000001000
0000010000
** @OVR  CL COMMAND FOR CALL TO QCMDEXC                                   E20774
OVRDSPF FILE(TM3190DD) WAITRCD(    )
** CPY@ - COPYRIGHT STATEMENT                                             S01117
(c) Misys International Banking Systems Ltd. 2001
