     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas DL Money Market - Near Dates Summary')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Treasury Management Module
     F*                                                               *
     F*  TM3220 - MONEY MARKET BOOK - NEAR DATES SUMMARY              *   S01166
     F*           (FORMERLY DL3220)                                   *   S01117
     F*                                                               *
     F*  Function: This enquiry supports the management of short      *
     F*  (I/C)     date dealing activity.                             *
     F*                                                               *
     F*  Called by: TMC0311 - TM Enquiry control                      *
     F*        via: DL3100  - Treasury management controller          *
     F*                                                               *
     F*  Calls    : ZA0250  - Clear program message queue.            *
     F*           : ZA0240  - Display program message queue.          *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Last Amend No. CRE026             Date 09Jun06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD031             Date 10Apr06               *
      *                 CSE071             Date 19Jul05               *
      *                 TDA035             Date 02Apr04               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 04Oct01               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 065473             Date 08Jul94               *
     F*                 046303             DATE 16JAN94               *
     F*                 E38323             DATE 31JUL92               *
     F*                 S01319             DATE 14AUG91               *
     F*                 S01280             DATE 23APR91               *
     F*                 S01117             DATE 28NOV90               *
     F*                 S01194             DATE 28NOV90               *
     F*                 S01195             DATE 28NOV90               *
     F*                 E20774             DATE 15MAR90               *
     F*                 S01199             DATE 28FEB90               *
     F*                 E20003             DATE 24NOV89               *
     F*                 S01166             DATE 25/05/88              *
     F*                 E12205             DATE 11/02/88              *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CRE026 - Consumer Banking                                    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CPK014 - Release 4 packaging.  Rename of field which is too  *
      *           long for OPM program.                               *
     F*  065473 - The market rate displayed is completely false for   *
     F*           certain dates.  Field COEF in subroutine MM1002 is  *
     F*           changed to be larger, from 6N to 15N.               *
     F*  046303 - /COPY source subr. ZFWDT amended to prevent array   *
     F*           error if no holiday record found - fixed by S01434. *
     F*           Program recompiled.                                 *
     F*  E38323 - Recompiled over changed copy source ZFWDT subr      *
     F*  S01319 - Remove redundant processing                         *
     F*  S01280 - IF NO RECORDS FOR CURRENCY ERROR MESSAGE            *
     F*           SHOULD BE DISPLAYED AND ANY EXISTING DATA           *
     F*           CLEARED                                             *
     F*  S01117 - NEW COPYRIGHT STATEMENT                             *
     F*           DEALING PROGRAMS USED ONLY IN TREASURY MGMT.        *
     F*           MODULE NOW PREFIXED WITH 'TM'                       *
     F*  S01194 - NEW STANDING DATA PROCESSING                        *
     F*  S01195 - NEW HOLIDAY PROCESSING                              *
     F*  E20774 - REPLACE QCAEXEC WITH QCMDEXC                        *
     F*  S01199 -  HELP SYSTEM.                                    *
     F*  E20003 - Funds in Nostro figure not displayed. Wrong         *
     F*           field is being used. HRNOSN (Funds in Nostro :      *
     F*           Start of Day) should be used instead of HVMMFN.     *
     F*           With this change,there would be no need to          *
     F*           access the Forward Book Totals file MMFWDTLL.       *
     F*  E12205 - 11/02/88 - REWRITE OF MARKET RATES CALC             *
     F*                                                               *
     F*****************************************************************
     F* ID F  C  H  L    FUNCTION OF INDICATORS                       *
     F*       80         CHAIN AND DB ERROR INDICATOR                 *
     F*       U6         PROGRAM ERROR - *PSSR EXECUTED               *
     F*       U7         DATA BASE ERROR                              *
     F*       U8         DATA BASE ERROR                              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F***FDICDRLLIF**E***        K        DISK         KINFSR INFSR  UC   S01194
     F**********  TABTB11F                          KIGNORE               S01194
     F**********  TABTB20F                          KIGNORE               S01194
     F***FDTABJLLIF**E***        K        DISK         KINFSR INFSR  UC   S01194
     F***CA38CPLLIF  E                 DISK         KINFSR INFSR      UC  S01166
     F***FDCCYTLLIF**E***        K        DISK         KINFSR INFSR  UC   S01194
     F**  E20003 - NO NEED TO ACCESS MMFWDTLL ANY MORE                    E20003
     F***MMFWDTLLIF  E        K        DISK         KINFSR INFSR      UC  E20003
     FMMFNRDLLIF  E           K        DISK         KINFSR INFSR      UC
     FFDINTDLLIF  E           K        DISK         KINFSR INFSR      UC
     F****        FDINTRP0                          KRENAMEFDINTDL0       E12205
     F****FDINTRLLIF  E           K        DISK     KINFSR INFSR      UC  E12205
     F***DL3220DDCF**E***                 WORKSTN          UC      S01166 S01117
     FTM3220DDCF  E                    WORKSTN                        UC  S01117
     F                                              KNUM        1         S01166
     F*FDUSSILLIF**E**********K********DISK*********KINFSR*INFSRUC**S01166S01319
     FMUSER   IF  E           K        DISK         KINFSR INFSR      UC  S01319
     F*FDINSTLLIF**E*******************DISK*********KINFSR*INFSR****S01166S01319
     E/EJECT
     E*
     E** Array to hold average rates.
     E                    @AV         9 12
     E*
     E** Array to hold borrow rates.
     E                    @BR        10 11 7
     E*
     E** Array to hold lend rates.
     E                    @LR        10 11 7
     E*
     E** Array to hold market rates.
     E                    @MR         9 11 7
     E*
     E** Array to hold edited market rates.
     E                    @MK         9 12
     E*
     E** Array to hold balances.
     E                    @BA         9 15 0
     E*
     E** Array to hold formatted balances.
     E                    @BL         9 19
     E*
     E** Array to hold interest amounts.
     E                    @IN         9 15 0
     E*
     E** Array to hold formatted interest amounts.
     E                    @IA         9 19
     E*
     E** Array to hold MIDAS day numbers.                                 E12205
     E*****               @DY        10  5 0                              E12205
     E*****                                                               E12205
     E** Array to hold dates in YYYYMMDD format.                          E12205
     E*****               @DT        10  8 0                              E12205
     E*
     E** Array to hold days in period.
     E                    @DP         9  3 0
     E*
     E**  ARRAY FOR SR. ZA0680 - CUMULATIVE DAYS IN YEAR FOR 4 YEAR PERIOD
     E                    @YD     4   4  5 0A
     E*
     E**  ARRAY FOR SR. ZA0680 - CUMULATIVE DAYS IN YEAR PER MONTH
     E                    @MD    13  13  5 0A
     E*
     E****USED*BY*SR**ZA0830***CURRENCY*RECORDS***                        S01195
     E**********          @CY        50  3                                S01195
     E*
     E**  ARRAY FIELD TO HOLD FORMATTED AMOUNT (MM1014)                   S01166
     E****                @O         19  1                                S01166
     E*                                                                   S01166
     E** Array to hold profit/loss amounts.                               S01166
     E                    @PN         9 15 0                              S01166
     E*                                                                   S01166
     E** Array to hold formatted profit/loss amounts.                     S01166
     E                    @PL         9 11                                S01166
     E*                                                                   S01166
     E                    @OVR    1   1 36                                S01166
     E*                                                                   S01166
     E****ARRAY FOR AMOUNT INPUT                                   S01166 S01117
     E*****               @Q         15  1                         S01166 S01117
     E*****                                                        S01166 S01117
     E****ARRAY FOR DISPLAY AMOUNT                                 S01166 S01117
     E*****               @E         21  1                         S01166 S01117
     E*****                                                        S01166 S01117
     E****WORK ARRAY                                               S01166 S01117
     E*****               @D         21  1                         S01166 S01117
     E*                                                                   S01166
     E**  ARRAY FOR RATE EDITING                                          S01166
     E                    @Z         14  1                                S01166
     E*                                                                   S01166
     E**  ARRAY FOR RATE EDITING                                          S01166
     E                    @Y         13  1 0                              S01166
     E*                                                                   S01166
     E**  ARRAY OF POWERS OF TEN                                          S01166
     E                    @PW     1   9 10 0                              S01166
     E*                                                                   S01166
     E**  ARRAY FOR NUMERIC CONVERSION                                    S01166
     E                    @K         16  1                                S01166
     E*
     E                    CPY@    1   1 80                                S01117
     E* Copyright array                                                   S01117
     E/COPY ZSRSRC,ZHOLE                                                  S01195
      * New holiday array                                                 S01195
     E/EJECT
      *                                                                                       CPK014
     IFDINTRP0                                                                                CPK014
     I              HWTMESTMP                       HWTMST                                    CPK014
     I*
     IMMFNRDP0
     I              HRNBTD                          @BA,1
     I              HRNBD1                          @BA,2
     I              HRNBD2                          @BA,3
     I              HRNBD3                          @BA,4
     I              HRNBD4                          @BA,5
     I              HRNBW1                          @BA,6
     I              HRNBM1                          @BA,7
     I              HRNBM2                          @BA,8
     I              HRNBM3                          @BA,9
     I              HRIATD                          @IN,1
     I              HRIAD1                          @IN,2
     I              HRIAD2                          @IN,3
     I              HRIAD3                          @IN,4
     I              HRIAD4                          @IN,5
     I              HRIAW1                          @IN,6
     I              HRIAM1                          @IN,7
     I              HRIAM2                          @IN,8
     I              HRIAM3                          @IN,9
     I              HRDPTD                          @DP,1
     I              HRDPD1                          @DP,2
     I              HRDPD2                          @DP,3
     I              HRDPD3                          @DP,4
     I              HRDPD4                          @DP,5
     I              HRDPW1                          @DP,6
     I              HRDPM1                          @DP,7
     I              HRDPM2                          @DP,8
     I              HRDPM3                          @DP,9
     I*
     I**  Data structure for calculating M4 date.                         S12205
     I*****       DS                                                      S12205
     I*****                                   1   80@DATE                 S12205
     I*****                                   1   40@YR                   S12205
     I*****                                   5   60@MTH                  S12205
     I*****                                   7   80@DAY                  S12205
     I*
     I**  DATA STRUCTURE FOR SR. ZA0680 - DATE INPUT TO SUBROUTINE
     I            DS
     I                                        1   80@@DTIN
     I                                        1   40@@YYYY
     I                                        3   40@@YY
     I                                        1   20@@CC
     I                                        5   60@@MTH
     I                                        7   80@@DAY
     I*
     I****@@RATE      DS                             11                   S01117
     I*****                                   1  117@@RATI                S01117
     I*
     I**  USED BY SR. MM1014 - ARRAY DATA STRUCTURE                       S01166
     I****@@AMTA      DS                             15                   S01166
     I****                                    1  150@@AMTI                S01166
     I*
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@Z71Y                 E12205
     I*****       DS                                                      E12205
     I*****                                   1   40@@Z71Y                E12205
     I*****                                   1   10@@SSY1                E12205
     I*****                                   2   20@@SSY2                E12205
     I*****                                   3   30@@SSY3                E12205
     I*****                                   4   40@@SSY4                E12205
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@VDT                  E12205
     I*****       DS                                                      E12205
     I*****                                   1   80@@VDT                 E12205
     I*****                                   1   40@@YR                  E12205
     I*****                                   5   60@@Z71M                E12205
     I*****                                   7   80@@Z71D                E12205
     I*
     I**********  DS                                                      S01195
     I**********                                                          S01195
     I****USED*BY*SR**ZA0830***ARRAY*DATA*STRUCTURE***                    S01195
     I**********                              1 150 @CY                   S01195
     I**********                              1  75 @@CY1                 S01195
     I**********                             76 150 @@CY2                 S01195
     I*
     I**  DATA AREA MASK - AMENQ1AA                                       S01166
     I****AMENQ1  DS                            728                       S01166
     I****                                    1  19 BAL1                  S01166
     I****                                   20  38 INT1                  S01166
     I****                                   40  51 AVR1                  S01166
     I****                                   53  71 BAL2                  S01166
     I****                                   72  90 INT2                  S01166
     I****                                   92 103 AVR2                  S01166
     I****                                  105 123 BAL3                  S01166
     I****                                  124 142 INT3                  S01166
     I****                                  144 155 AVR3                  S01166
     I****                                  157 175 BAL4                  S01166
     I****                                  176 194 INT4                  S01166
     I****                                  196 207 AVR4                  S01166
     I****                                  209 227 BAL5                  S01166
     I****                                  228 246 INT5                  S01166
     I****                                  248 259 AVR5                  S01166
     I****                                  261 279 BAL6                  S01166
     I****                                  280 298 INT6                  S01166
     I****                                  300 311 AVR6                  S01166
     I****                                  313 331 BAL7                  S01166
     I****                                  332 350 INT7                  S01166
     I****                                  352 363 AVR7                  S01166
     I****                                  365 383 BAL8                  S01166
     I****                                  384 402 INT8                  S01166
     I****                                  404 415 AVR8                  S01166
     I****                                  417 435 BAL9                  S01166
     I****                                  436 454 INT9                  S01166
     I****                                  456 467 AVR9                  S01166
     I****                                  469 480 MAI1                  S01166
     I****                                  481 492 MAI2                  S01166
     I****                                  493 504 MAI3                  S01166
     I****                                  505 516 MAI4                  S01166
     I****                                  521 532 MAI5                  S01166
     I****                                  533 544 MAI6                  S01166
     I****                                  545 556 MAI7                  S01166
     I****                                  557 568 MAI8                  S01166
     I****                                  573 584 MAI9                  S01166
     I****                                  585 603 NSIN                  S01166
     I****                                  700 7010DIP1                  S01166
     I****                                  702 7030DIP2                  S01166
     I****                                  704 7050DIP3                  S01166
     I****                                  706 7070DIP4                  S01166
     I****                                  708 7090DIP5                  S01166
     I****                                  710 7110DIP6                  S01166
     I****                                  712 7130DIP7                  S01166
     I****                                  714 7150DIP8                  S01166
     I****                                  716 7170DIP9                  S01166
     I****                                  718 720 @DCCY                 S01166
     I****                                  721 728 @INMTH                S01166
     I*
     I**  DATA STRUCTURE TO SET UP FILE KEY.
     I****        DS                                                      S01166
     I****                                    1  80 FAEPT1                S01166
     I****                                    2   4 @@CCY                 S01166
     I****                                   48  48 @@INTM                S01166
     I*
     I** DATA STRUCTURE TO HOLD INFORMATION ON DATABASE ERROR.
     I           UDS
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 183 DBASE
     I*
     I** PROGRAM STATUS D/S TO HOLD FILE NAME FOR FILE ERROR.
     IPSDS       SDS
     I                                      201 208 @FILE
     I** field containing workstation id                                  S01166
     I                                      244 253 @JOB                  S01166
     I** field containing user id                                         S01166
     I                                      254 263 @USER                 S01166
     I**                                                                  S01166
     I** data structure for command in array @ovr                         S01166
     I@OVRID      DS                             36                       S01166
     I                                       32  350@WAIT                 S01166
     I**                                                                  S01166
     I***data*structure*for*currency*key***                        S01166 S01194
     I**********  DS                             12                S01166 S01194
     I**********                              1  12 CCYKEY         S01166 S01194
     I**********                              1   2 K20            S01166 S01194
     I**********                              9  11 KCCY           S01166 S01194
     I**********                             12  12 K1             S01166 S01194
     I**                                                                  S01166
     I** data structure for rate editing                                  S01166
     I            DS                             14                       S01166
     I                                        1  14 @@AMTD                S01166
     I                                        1  14 @Z                    S01166
     I** data structure for rate editing                                  S01166
     I            DS                             13                       S01166
     I                                        1  130@@AMTW                S01166
     I                                        1  130@Y                    S01166
     I*
     ISDCURR    E DSSDCURRPD                                              S01194
     I* External DS for Currency Details                                  S01194
     ISDBANK    E DSSDBANKPD                                              S01194
     I* External DS for Bank Details                                      S01194
     ISDDEAL    E DSSDDEALPD                                              S01319
     I** EXTERNAL DS FOR DEALING DETAILS                                  S01319
     IDSSDY     E DSDSSDY                                                 S01194
     I* DS used by Access Objects (long records)                          S01194
     IDSFDY     E DSDSFDY                                                 S01194
     I* DS used by Access Objects (short records)                         S01194
      /COPY ZSRSRC,ZHOLI                                                  S01195
     I* Copy standard holiday data structure                              S01195
     C/EJECT
     C                     MOVEACPY@      BIS@   80                       S01117
     C*
     C**  Initial processing.
     C****       @TERM     IFNE 'T'                        B1             S01166
     C                     EXSR #A                         *1
     C*
     C**  Main processing
     C****       @TERM     IFNE 'E'                        B*2            S01166
     C           *IN01     DOWEQ'0'                        B**3           S01166
     C                     EXSR #B                         ***3           S01166
     C                     END                             E**3           S01166
     C****                 END                             E*2            S01166
     C****                 END                             E1             S01166
     C*
     C**  Termination processing
     C                     EXSR #C
     C*
     C           ENDPGM    TAG                             **ENDPGM**
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*  Index to subroutines - Order of listing due to frequency of  *
     C*                         usage.                                *
     C*                                                               *
     C*   1. #B     - Main processing.                                *
     C*   2. #BA    - Calculates market rates.                        *
     C****3.*#BAA***-*Fills in gaps in rates arrays.                  *   E12205
     C*   3. #BAA   - Calculates an actual number of days between     *   E12205
     C*   3.          MM spot date and number of working days forward *   E12205
     C*   4. MM1001 - Determine a forward forward interest rate.      *
     C*   5. MM1011 - Determines number of days in year.              *
     C*   6. MM1002 - Determine a broken date rate.                   *
     C****7.*ZA1030***Format an interest rate for download.           *   S01166
     C****8.*MM1014***Format an amount for download.                  *   S01166
     C*   7. #ZA    - Scale numeric input before display formatting.  *   S01166
     C*   8. ZA0860 - Convert short amount to display format.         *   S01166
     C*   9. ZA0920 - Format an amount with specified number of       *   S01166
     C*   9.          decimal places.                                 *   S01166
     C*  10. ZA0680 - Convert YYYYMMDD to midas day number format.    *
     C***10.*ZA0710*-*Calculates midas day number.                    *   E12205
     C*  11. MM1022 - Calculates average interest rate.               *
     C***12.*ZA0830*-*Determines*if*day*is*a*holiday.******************   S01195
     C*  12. ZCHKH  - Determines if day is a holiday.                 *   S01195
     C*      ZACCH  - Access new holidays file SDHOLPD                *   S01195
     C*  13. #A     - Initial processing.                             *
     C*  14. #C     - Termination processing.                         *
     C***15.*ZA0150*-*Accesses*ICD*file.*******************************   S01195
     C*  16. INFSR  - File error handling sub- routine.               *
     C*  17. *PSSR  - Program error handling sub- routine.            *
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*     #B CARRIES OUT THE MAIN PROCESSING.                      *
     C*                                                              *
     C*        CALLED BY   : MAIN PROGRAM.                           *
     C*                                                              *
     C*********CALLS*********#BA,MM1014,MM1011,ZA0710,MM1022,ZA1030  *    S01166
     C*        CALLS       : #BA,#ZA,MM1011,ZA0710,MM1022,ZA0920.    *    S01166
     C*                                                              *
     C*        WORK FIELDS : @BA    - Numeric balance array.         *
     C*                    : @BL    - Display balance array.         *
     C*                    : @IN    - Numeric interest amount array. *
     C*                    : @IA    - Display interest amount array. *
     C******************   : @DY    - Day number array.              *    E12205
     C******************   : @DT    - Date array.                    *    E12205
     C*                    : @AV    - Display average rate array.    *
     C*                    : @MK    - Display market rate array.     *
     C*                    : @N     - Array pointer.                 *
     C*                    : @W2DAY - Number of days forward for -2W.*
     C*                                                              *
     C****************************************************************
     C*
     C           #B        BEGSR
     C*
     C*                                                                   S01166
     C           *IN05     IFEQ '0'                                       S01166
     C**********           WRITEDL3220S0               80          S01166 S01117
     C                     WRITETM3220S0               80                 S01117
     C                     END                                            S01166
     C*                                                                   S01166
     C**********           WRITEDL3220F1               80          S01166 S01117
     C                     WRITETM3220F1               80                 S01117
     C*                                                                   S01166
     C**********           READ DL3220DD               0580        S01166 S01117
     C                     READ TM3220DD               0580               S01117
     C*                                                                   S01166
     C**         *IN10     DOWEQ'1'                                S01166 S01199
     C**                   SETOF                     10            S01166 S01199
     C**                   CALL 'SDMENU'                           S01166 S01199
     C**                   READ DL3220DD               0580        S01166 S01199
     C**                   END                                     S01166 S01199
     C*                                                                   S01166
     C           *IN05     IFEQ '1'                                       S01166
     C                     MOVELDDCURR    DDCCY            REFRESH        S01166
     C                     MOVEL@@SVIM    DDINTM           PROMPT FIELDS  S01166
     C                     SETOF                     05                   S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C           DDCCY     IFEQ *BLANKS                                   S01166
     C*********************MOVELIDCYDL****DDCCY*********************S01166S01319
     C                     MOVELBNCYDL    DDCCY                           S01319
     C                     END                                            S01166
     C*                                                                   S01166
     C           DDINTM    IFEQ *BLANKS                                   S01166
     C                     MOVEL'W'       DDINTM                          S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C                     SETOF                     40  50               S01166
     C                     CALL 'ZA0250'                                  S01166
     C*                                                                   S01166
     C**********           MOVEL'20'      K20                      S01166 S01194
     C**********           MOVELDDCCY     KCCY                     S01166 S01194
     C**********           MOVEL'1'       K1                       S01166 S01194
     C**********                                                   S01166 S01194
     C********** CCYKEY    CHAINTABTG10F             40            S01166 S01194
      *                                                                   S01194
      * Validate currency via call to access object                       S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM           DDCCY                           S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01166
     C********** *IN40     IFEQ '1'                                S01166 S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
     C                     MOVE '1'       *IN40                           S01194
     C                     MOVEL'BBM0013' @MSGID 10                       S01166
     C                     CALL 'ZA0240'                                  S01166
     C                     PARM           @MSGID                          S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C*  Validate interpolation method - must be linear or weighted       S01166
     C           DDINTM    IFNE 'L'                                       S01166
     C           DDINTM    ANDNE'W'                                       S01166
     C                     SETON                     50                   S01166
     C                     MOVEL'MMM0581' @MSGID                          S01166
     C                     CALL 'ZA0240'                                  S01166
     C                     PARM           @MSGID                          S01166
     C                     GOTO #B9                                       S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C           *IN40     IFEQ '1'                                       S01166
     C                     GOTO #B9                                       S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C* update ddcurr and save interpolation method field                 S01166
     C                     MOVELDDCCY     DDCURR                          S01166
     C                     MOVELDDINTM    @@SVIM  1                       S01166
     C*                                                                   S01166
     C****Access current prompts file.                                    S01166
     C****       1         CHAINCA38CPLL             80                   S01166
     C*                                                                   S01166
     C****Deal with database error.                                       S01166
     C****       *IN80     IFEQ '1'                        B1             S01166
     C****                 MOVE 'CA38CPLL'DBFILE           ************** S01166
     C****                 MOVE '001'     DBASE            *            * S01166
     C****                 MOVE '1'       *INU7            *DB ERROR 001* S01166
     C****                 MOVE '1'       *INU8            *            * S01166
     C****                 MOVE 'E'       @TERM            ************** S01166
     C****                 GOTO #B9                        *1             S01166
     C****                 END                             E1             S01166
     C*                                                                   S01166
     C****Access data area.                                               S01166
     C****       *LOCK     IN   AMENQ1                                    S01166
     C****                 MOVE *BLANK    AMENQ1                          S01166
     C*
     C** Access near dates summary file.
     C******     @@CCY     CHAINMMFNRDLL             80                   S01166
     C           DDCCY     CHAINMMFNRDLL             80                   S01166
     C*
     C***If*no*record*on*file*for*currency*return*blank*record*to*PC      S01280
     C* If no record for currency, send message and blank out any         S01280
     C* existing data on screen                                           S01280
     C           *IN80     IFEQ '1'                        B1
     C           HRDLTF    OREQ '*'                        *1
     C                     MOVEL'RTM0009' @MSGID           *1             S01280
     C                     CALL 'ZA0240'                   *1             S01280
     C                     PARM           @MSGID           *1             S01280
     C                     MOVEA*BLANKS   @MK              *1             S01280
     C                     MOVEA*BLANKS   @BL              *1             S01280
     C                     MOVEA*BLANKS   @IA              *1             S01280
     C                     MOVEA*BLANKS   @AV              *1             S01280
     C                     MOVEA*BLANKS   @PL              *1             S01280
     C                     MOVE *BLANKS   DDNSIN           *1             S01280
     C                     GOTO #B8                        *1
     C                     END                             E1
     C*
     C***Set*up*key*to*obtain*format*TABTG10F*'20******CCY1'***           S01194
     C**********           MOVEL'20'      @KEY   12                       S01194
     C******               MOVEL@@CCY     @ENDKY  4                       S01166
     C**********           MOVELDDCCY     @ENDKY  4                S01166 S01194
     C**********           MOVE '1'       @ENDKY                          S01194
     C**********           MOVE @ENDKY    @KEY                            S01194
     C**********                                                          S01194
     C***Access*currencies*file.***                                       S01194
     C********** @KEY      CHAINFDCCYTLL             80                   S01194
     C**********                                                          S01194
     C***Deal*with*database*error***                                      S01194
     C********** *IN80     IFEQ '1'                        B1             S01194
     C********** RECI      ORNE 'D'                        *1             S01194
     C**********           MOVEL'FDCCYTLL'DBFILE           ************** S01194
     C**********           MOVEL'003'     DBASE            *            * S01194
     C**********           MOVEL@KEY      DBKEY            *DB ERROR 003* S01194
     C**********           MOVE '1'       *INU7            *            * S01194
     C**********           MOVE '1'       *INU8            *            * S01194
     C****                 MOVE 'E'       @TERM            ************** S01166
     C**********           MOVE '1'       *IN01            *1      S01166 S01194
     C**********           GOTO #B9                        *1             S01194
     C**********           END                             E1             S01194
     C*
     C** Move number of decimal places into conversion routine field.
     C****                 Z-ADDCDP       @@CDP                           S01166
     C**********           Z-ADDMSPD      @@MSPD  80                      S01194
     C                     Z-ADDA6MMSD    @@MSPD  80                      S01194
     C*
     C** Access forward book totals file.
     C****       @@CCY     CHAINMMFWDTLL             80                   S01166
     C**  E20003 - NO NEED TO ACCESS THE FORWARD BOOK TOTALS FILE         E20003
     C**           BECAUSE OF CHANGE OF FIELD USED FOR DISPLAY            E20003
     C********** DDCCY     CHAINMMFWDTLL             80                   S01166
     C********** *IN80     IFEQ '1'                        B1             E20003
     C********** HVDLTF    ORNE ' '                        *1             E20003
     C**********           MOVE 'MMFWDTLL'DBFILE           ************** E20003
     C**********           MOVE '004'     DBASE            *            * E20003
     C****                 MOVEL@@CCY     DBKEY            *            * S01166
     C**********           MOVELDDCCY     DBKEY            *     * S01166 E20003
     C**********           MOVE '1'       *INU7            *DB ERROR 004* E20003
     C**********           MOVE '1'       *INU8            *            * E20003
     C****                 MOVE 'E'       @TERM            ************** S01166
     C**********           MOVE '1'       *IN01            *1      S01166 E20003
     C**********           GOTO #B9                        *1             E20003
     C**********           END                             E1             E20003
     C*
     C** Convert funds in nostro to display format.
     C****                 Z-ADDHVMMFN    @@AMTI                          S01166
     C****                 EXSR MM1014                                    S01166
     C****                 MOVE @@AMTO    NSIN                            S01166
     C**  E20003 - USE HRNOSN TO REPLACE HVMMFN                           E20003
     C**********           Z-ADDHVMMFN    @INPUT 150               S01166 E20003
     C                     Z-ADDHRNOSN    @INPUT 150                      E20003
     C**  SCALE FOR CDP AND THOUSANDS                                     S01166
     C********** CDP       ADD  3         @S      20               S01166 S01194
     C           A6NBDP    ADD  3         @S      20                      S01194
     C                     Z-ADD@PW,@S    @SCALE 100                      S01166
     C                     EXSR #ZA                                       S01166
     C                     MOVE @@ALPH    DDNSIN 11                       S01166
     C*
     C***Add*one to day number for periods Today to D4 since the          E12205
     C***day*numbers for these periods on the near dates summary          E12205
     C***file*are for the day before the next working day.                E12205
     C**ALSO*THE CASE FOR 1W TO 3M                                        E12205
     C********                                                            E12205
     C********   HRPDTD    ADD  1         @DY,1                           E12205
     C********   HRPDD1    ADD  1         @DY,2                           E12205
     C********   HRPDD2    ADD  1         @DY,3                           E12205
     C********   HRPDD3    ADD  1         @DY,4                           E12205
     C********   HRPDD4    ADD  1         @DY,5                           E12205
     C********   HRPDW1    ADD  1         @DY,6                           E12205
     C********   HRPDM1    ADD  1         @DY,7                           E12205
     C********   HRPDM2    ADD  1         @DY,8                           E12205
     C********   HRPDM3    ADD  1         @DY,9                           E12205
     C********                                                            E12205
     C***Set*up key to chain to LF/FDINTDLL                               E12205
     C********   @IRKEY    KLIST                                          E12205
     C********             KFLD           @@CCY                           E12205
     C********             KFLD           @DT,@N                          E12205
     C*
     C** Move interest calculation method into MM1011 field and call
     C** subroutine to get number of days in year field @@DAYO.
     C                     MOVE HRDICM    @@CALC
     C                     EXSR MM1011
     C*
     C                     DO   9         @N      30       B1
     C*
     C** Convert balance to display format.
     C****                 Z-ADD@BA,@N    @@AMTI           *1             S01166
     C****                 EXSR MM1014                     *1             S01166
     C****                 MOVE @@AMTO    @BL,@N           *1             S01166
     C                     Z-ADD@BA,@N    @INPUT                          S01166
     C**  SCALE FOR CDP AND THOUSANDS                                     S01166
     C********** CDP       ADD  3         @S                       S01166 S01194
     C           A6NBDP    ADD  3         @S                              S01194
     C                     Z-ADD@PW,@S    @SCALE                          S01166
     C                     EXSR #ZA                                       S01166
     C                     MOVE @@ALPH    @BL,@N                          S01166
     C*
     C** Convert interest amount to display format.
     C****       @IN,@N    DIV  100       @@AMTI    H      *1             S01166
     C****                 EXSR MM1014                     *1             S01166
     C****                 MOVE @@AMTO    @IA,@N           *1             S01166
     C                     Z-ADD@IN,@N    @INPUT                          S01166
     C**  SCALE FOR CDP, THOUSANDS AND ADDITIONAL TWO PLACES OF ACCURACY  S01166
     C********** CDP       ADD  5         @S                       S01166 S01194
     C           A6NBDP    ADD  5         @S                              S01194
     C                     Z-ADD@PW,@S    @SCALE                          S01166
     C                     EXSR #ZA                                       S01166
     C                     MOVE @@ALPH    @IA,@N                          S01166
     C*
     C***Convert MIDAS day number to YYYYMMDD format.                     E12205
     C*********            Z-ADD@DY,@N    @@DAYN  50       *1             E12205
     C*********            EXSR ZA0710                     *1             E12205
     C*********            MOVE @@VDT     @DT,@N           *1             E12205
     C*********                                                           E12205
     C***Calculate number of days forward.                                E12205
     C*********  @DY,@N    SUB  RUND      @DY,@N           *1             E12205
     C*
     C** Calculate average rate.
     C                     Z-ADD@IN,@N    @@NINT           *1
     C                     Z-ADD@BA,@N    @@NBAL           *1
     C                     Z-ADD@@DAYO    @@DAYY           *1
     C                     Z-ADD@DP,@N    @@DAYP           *1
     C           @@NBAL    IFNE 0                          B1
     C                     MOVE DDINTM    @@INTM           *1             S01166
     C                     EXSR MM1022                     *1
     C                     ELSE                            X1
     C                     Z-ADD*ZERO     @@AVRT           *1
     C                     END                             E1
     C*
     C** Convert average rate to display.
     C****                 Z-ADD@@AVRT    @@RATI           *1             S01166
     C****                 EXSR ZA1030                     *1             S01166
     C****                 MOVE @@RATO    @AV,@N           *1             S01166
     C*                                                                   S01166
     C           1000000   MULT @@AVRT    @@AMTW           *1             S01166
     C                     Z-ADD6         @@QECN           *1             S01166
     C                     EXSR ZA0920                     *1             S01166
     C                     MOVE @@AMTD    @AV,@N           *1             S01166
     C                     END                             E1
     C*
     C**  Calculate market rates.
     C                     MOVE DDCCY     @@CCY   3                       S01166
     C                     EXSR #BA
     C*
     C**  Exit this routine if a database error has occured.
     C           *INU7     CABEQ'1'       #B9
     C*
     C*                                                                   S01166
     C*   Calculate profit/loss = Interest for period + A                 S01166
     C*                                                                   S01166
     C*                 balance * market rate * days in period            S01166
     C*             A = --------------------------------------            S01166
     C*                          days in year * 100                       S01166
     C*                                                                   S01166
     C           1         DO   9         @N                              S01166
     C*                                                                   S01166
     C                     Z-ADD0         @AA    150                      S01166
     C*                                                                   S01166
     C           @BA,@N    MULT @DP,@N    @AA                             S01166
     C           @AA       MULT @MR,@N    @AA                             S01166
     C           @AA       DIV  @@DAYO    @AA                             S01166
     C           @AA       DIV  100       @AA                             S01166
     C*                                                                   S01166
     C*             Profit/loss = Interest for period + A                 S01166
     C*                                                                   S01166
     C           @IN,@N    DIV  100       @PN,@N                          S01166
     C           @PN,@N    ADD  @AA       @PN,@N                          S01166
     C*                                                                   S01166
     C                     Z-ADD@PN,@N    @INPUT                          S01166
     C*                                                                   S01166
     C**  SCALE FOR CDP                                                   S01166
     C********** CDP       IFNE 0                                  S01166 S01194
     C           A6NBDP    IFNE 0                                         S01194
     C**********           Z-ADDCDP       @S                       S01166 S01194
     C                     Z-ADDA6NBDP    @S                              S01194
     C                     Z-ADD@PW,@S    @SCALE                          S01166
     C                     ELSE                                           S01166
     C                     Z-ADD1         @SCALE                          S01166
     C                     END                                            S01166
     C                     EXSR #ZA                                       S01166
     C*                                                                   S01166
     C                     MOVE @@ALPH    @PL,@N                          S01166
     C*                                                                   S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C****Move array fields into data area mask.                          S01166
     C****                 MOVE @MK,1     MAI1                            S01166
     C****                 MOVE @MK,2     MAI2                            S01166
     C****                 MOVE @MK,3     MAI3                            S01166
     C****                 MOVE @MK,4     MAI4                            S01166
     C****                 MOVE @MK,5     MAI5                            S01166
     C****                 MOVE @MK,6     MAI6                            S01166
     C****                 MOVE @MK,7     MAI7                            S01166
     C****                 MOVE @MK,8     MAI8                            S01166
     C****                 MOVE @MK,9     MAI9                            S01166
     C****                 MOVE @BL,1     BAL1                            S01166
     C****                 MOVE @BL,2     BAL2                            S01166
     C****                 MOVE @BL,3     BAL3                            S01166
     C****                 MOVE @BL,4     BAL4                            S01166
     C****                 MOVE @BL,5     BAL5                            S01166
     C****                 MOVE @BL,6     BAL6                            S01166
     C****                 MOVE @BL,7     BAL7                            S01166
     C****                 MOVE @BL,8     BAL8                            S01166
     C****                 MOVE @BL,9     BAL9                            S01166
     C****                 MOVE @IA,1     INT1                            S01166
     C****                 MOVE @IA,2     INT2                            S01166
     C****                 MOVE @IA,3     INT3                            S01166
     C****                 MOVE @IA,4     INT4                            S01166
     C****                 MOVE @IA,5     INT5                            S01166
     C****                 MOVE @IA,6     INT6                            S01166
     C****                 MOVE @IA,7     INT7                            S01166
     C****                 MOVE @IA,8     INT8                            S01166
     C****                 MOVE @IA,9     INT9                            S01166
     C****                 MOVE @AV,1     AVR1                            S01166
     C****                 MOVE @AV,2     AVR2                            S01166
     C****                 MOVE @AV,3     AVR3                            S01166
     C****                 MOVE @AV,4     AVR4                            S01166
     C****                 MOVE @AV,5     AVR5                            S01166
     C****                 MOVE @AV,6     AVR6                            S01166
     C****                 MOVE @AV,7     AVR7                            S01166
     C****                 MOVE @AV,8     AVR8                            S01166
     C****                 MOVE @AV,9     AVR9                            S01166
     C****                 Z-ADD@DP,1     DIP1                            S01166
     C****                 Z-ADD@DP,2     DIP2                            S01166
     C****                 Z-ADD@DP,3     DIP3                            S01166
     C****                 Z-ADD@DP,4     DIP4                            S01166
     C****                 Z-ADD@DP,5     DIP5                            S01166
     C****                 Z-ADD@DP,6     DIP6                            S01166
     C****                 Z-ADD@DP,7     DIP7                            S01166
     C****                 Z-ADD@DP,8     DIP8                            S01166
     C****                 Z-ADD@DP,9     DIP9                            S01166
     C*                                                                   S01166
     C           #B8       TAG                                            S01280
     C*                                                                   S01166
     C*   Move array fields into display fields.                          S01166
     C*                                                                   S01166
     C                     MOVE @MK,1     DDMK1  12                       S01166
     C                     MOVE @MK,2     DDMK2  12                       S01166
     C                     MOVE @MK,3     DDMK3  12                       S01166
     C                     MOVE @MK,4     DDMK4  12                       S01166
     C                     MOVE @MK,5     DDMK5  12                       S01166
     C                     MOVE @MK,6     DDMK6  12                       S01166
     C                     MOVE @MK,7     DDMK7  12                       S01166
     C                     MOVE @MK,8     DDMK8  12                       S01166
     C                     MOVE @MK,9     DDMK9  12                       S01166
     C                     MOVE @BL,1     BL1    11                       S01166
     C                     MOVE @BL,2     BL2    11                       S01166
     C                     MOVE @BL,3     BL3    11                       S01166
     C                     MOVE @BL,4     BL4    11                       S01166
     C                     MOVE @BL,5     BL5    11                       S01166
     C                     MOVE @BL,6     BL6    11                       S01166
     C                     MOVE @BL,7     BL7    11                       S01166
     C                     MOVE @BL,8     BL8    11                       S01166
     C                     MOVE @BL,9     BL9    11                       S01166
     C                     MOVELBL1       DDBI1  21                       S01166
     C                     MOVELBL2       DDBI2  21                       S01166
     C                     MOVELBL3       DDBI3  21                       S01166
     C                     MOVELBL4       DDBI4  21                       S01166
     C                     MOVELBL5       DDBI5  21                       S01166
     C                     MOVELBL6       DDBI6  21                       S01166
     C                     MOVELBL7       DDBI7  21                       S01166
     C                     MOVELBL8       DDBI8  21                       S01166
     C                     MOVELBL9       DDBI9  21                       S01166
     C                     MOVE @IA,1     @IA1   10                       S01166
     C                     MOVE @IA,2     @IA2   10                       S01166
     C                     MOVE @IA,3     @IA3   10                       S01166
     C                     MOVE @IA,4     @IA4   10                       S01166
     C                     MOVE @IA,5     @IA5   10                       S01166
     C                     MOVE @IA,6     @IA6   10                       S01166
     C                     MOVE @IA,7     @IA7   10                       S01166
     C                     MOVE @IA,8     @IA8   10                       S01166
     C                     MOVE @IA,9     @IA9   10                       S01166
      *                                                                   S01280
     C           *IN80     IFNE '1'                                       S01280
     C                     MOVEL'/'       @IA1                            S01166
     C                     MOVEL'/'       @IA2                            S01166
     C                     MOVEL'/'       @IA3                            S01166
     C                     MOVEL'/'       @IA4                            S01166
     C                     MOVEL'/'       @IA5                            S01166
     C                     MOVEL'/'       @IA6                            S01166
     C                     MOVEL'/'       @IA7                            S01166
     C                     MOVEL'/'       @IA8                            S01166
     C                     MOVEL'/'       @IA9                            S01166
     C                     END                                            S01280
      *                                                                   S01280
     C                     MOVE @IA1      DDBI1                           S01166
     C                     MOVE @IA2      DDBI2                           S01166
     C                     MOVE @IA3      DDBI3                           S01166
     C                     MOVE @IA4      DDBI4                           S01166
     C                     MOVE @IA5      DDBI5                           S01166
     C                     MOVE @IA6      DDBI6                           S01166
     C                     MOVE @IA7      DDBI7                           S01166
     C                     MOVE @IA8      DDBI8                           S01166
     C                     MOVE @IA9      DDBI9                           S01166
     C                     MOVE @AV,1     DDAV1  12                       S01166
     C                     MOVE @AV,2     DDAV2  12                       S01166
     C                     MOVE @AV,3     DDAV3  12                       S01166
     C                     MOVE @AV,4     DDAV4  12                       S01166
     C                     MOVE @AV,5     DDAV5  12                       S01166
     C                     MOVE @AV,6     DDAV6  12                       S01166
     C                     MOVE @AV,7     DDAV7  12                       S01166
     C                     MOVE @AV,8     DDAV8  12                       S01166
     C                     MOVE @AV,9     DDAV9  12                       S01166
     C                     MOVE @PL,1     DDPL1  11                       S01166
     C                     MOVE @PL,2     DDPL2  11                       S01166
     C                     MOVE @PL,3     DDPL3  11                       S01166
     C                     MOVE @PL,4     DDPL4  11                       S01166
     C                     MOVE @PL,5     DDPL5  11                       S01166
     C                     MOVE @PL,6     DDPL6  11                       S01166
     C                     MOVE @PL,7     DDPL7  11                       S01166
     C                     MOVE @PL,8     DDPL8  11                       S01166
     C                     MOVE @PL,9     DDPL9  11                       S01166
     C*
     C********** #B8       TAG                                            S01280
     C*
     C** Place text into interpolation method field
     C****       @@INTM    IFEQ 'L'                        B1             S01166
     C****                 MOVE 'LINEAR  '@INMTH           *1             S01166
     C****                 ELSE                            X1             S01166
     C****                 MOVE 'WEIGHTED'@INMTH           *1             S01166
     C****                 END                             E1             S01166
     C           DDINTM    IFEQ 'L'                        B1             S01166
     C                     MOVEL' *LIN'   DDINM  10        *1             S01166
     C                     MOVE 'EAR* '   DDINM            *1             S01166
     C                     ELSE                            X1             S01166
     C                     MOVEL'*WEIG'   DDINM            *1             S01166
     C                     MOVE 'HTED*'   DDINM            *1             S01166
     C                     END                             E1             S01166
     C*
     C** Currency
     C****                 MOVE @@CCY     @DCCY                           S01166
     C*
     C***Write the data area out.                                         S01166
     C****                 OUT  AMENQ1                                    S01166
     C*
     C****Send the data to the PC using the control module program.       S01166
     C****                 CALL 'CM0020'                                  S01166
     C****                 PARM *BLANK    @TERM                           S01166
     C****                 PARM 'ER'      @EMID   2                       S01166
     C****                 PARM '1'       @ENQ1   1                       S01166
     C****                 PARM @ENQ      @ENQR   1                       S01166
     C****                 PARM '104'     @ENQN   3                       S01166
     C****                 PARM *BLANK    @BLNK   1                       S01166
     C*
     C           #B9       ENDSR                           ***#B9***
     C/EJECT
     C****************************************************************    S12205
     C**********                                                     *    S12205
     C*     #BA     Calculates market rates.                         *    S12205
     C**********                                                     *    S12205
     C*        CALLED BY  : #B                                       *    S12205
     C**********                                                     *    S12205
     C*        CALLS      : #BAA,ZA0680,MM1001,ZA0830,MM1002.        *    S12205
     C**********                                                     *    S12205
     C*        WORK FIELDS : @BR    -  Borrow rate array.            *    S12205
     C**********           : @LR    -  Lend rate array.              *    S12205
     C**********           : @MR    -  Numeric market rate array.    *    S12205
     C**********           : @DY    -  Day number array.             *    S12205
     C**********           : @BA    -  Numeric balance array.        *    S12205
     C**********           : @MK    -  Display market rate array.    *    S12205
     C**********           : @STA   -  Start position for gap.       *    S12205
     C**********           : @END   -  End position for gap.         *    S12205
     C**********           : @IRKEY -  Key to access FDINTDLL.       *    S12205
     C**********           : @PKEY  -  Key to access FDINTRLL.       *    S12205
     C**********           : @PTYPE -  Period type.                  *    S12205
     C**********           : @PNUM  -  Period number.                *    S12205
     C**********           : @A     -  Array pointer.                *    S12205
     C**********           : @B     -  Array pointer.                *    S12205
     C**********           : @C     -  Array pointer.                *    S12205
     C**********           : @DATE  -  Data structure for 4M date.   *    S12205
     C**********                                                     *    S12205
     C****************************************************************    S12205
     C*********  #BA       BEGSR                                          S12205
     C**********                                                          S12205
     C*********            DO   9         @N               B1             S12205
     C**********                                                          S12205
     C** Chain to interest rates file to get rates for standard days.     S12205
     C*********  @IRKEY    CHAINFDINTDLL             80    *1             S12205
     C**********                                                          S12205
     C** If a record exists move borrow and lend rates into arrays.       S12205
     C*********  *IN80     IFEQ '0'                        B*2            S12205
     C*********            Z-ADDHWBRRT    @BR,@N           **2            S12205
     C*********            Z-ADDHWLDRT    @LR,@N           **2            S12205
     C**********                                                          S12205
     C** If a record exists for days up to +4 move the appropriate        S12205
     C** rate into the market rate array.                                 S12205
     C*********  @N        IFLT 6                          B**3           S12205
     C*********  @BA,@N    IFLT 0                          B***4          S12205
     C*********            Z-ADDHWLDRT    @MR,@N           ****4          S12205
     C*********            END                             E***4          S12205
     C*********  @BA,@N    IFGT 0                          B***4          S12205
     C*********            Z-ADDHWBRRT    @MR,@N           ****4          S12205
     C*********            END                             E***4          S12205
     C**********                                                          S12205
     C*********            END                             E**3           S12205
     C**********                                                          S12205
     C*********            END                             E*2            S12205
     C**********                                                          S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C** The following code identifies gaps in the rates arrays           S12205
     C** and calls a routine to fill them with the appropriate values     S12205
     C** (only applicable for the periods up to and including +4 days)    S12205
     C*********  @STA      DOUEQ0                          B1             S12205
     C**********                                                          S12205
     C** Initialise start and end of gap pointers.                        S12205
     C*********            Z-ADD0         @STA    10       *1             S12205
     C*********            Z-ADD0         @END    10       *1             S12205
     C**********                                                          S12205
     C*********            DO   5         @A      30       B*2            S12205
     C**********                                                          S12205
     C** If a rate exists and the start pointer has been set then the     S12205
     C** end of the gap has been reached, so exit loop.                   S12205
     C*********  @BR,@A    IFNE 0                          B**3           S12205
     C*********  @STA      IFNE 0                          B***4          S12205
     C*********            Z-ADD6         @A               ****4          S12205
     C*********            END                             E***4          S12205
     C**********                                                          S12205
     C** If a rate does not exist and the start pointer has not           S12205
     C** been set then this is the start of a gap so set both start       S12205
     C** and end pointers.                                                S12205
     C*********            ELSE                            X**3           S12205
     C*********  @STA      IFEQ 0                          B***4          S12205
     C*********            Z-ADD@A        @STA             ****4          S12205
     C*********            Z-ADD@A        @END             ****4          S12205
     C**********                                                          S12205
     C** If a rate does not exist and the start pointer has been set      S12205
     C** then this is another element in the gap so reset end pointer.    S12205
     C*********            ELSE                            X***4          S12205
     C*********            Z-ADD@A        @END             ****4          S12205
     C*********            END                             E***4          S12205
     C**********                                                          S12205
     C*********            END                             E**3           S12205
     C**********                                                          S12205
     C*********            END                             E*2            S12205
     C**********                                                          S12205
     C** If the start pointer has been set then a gap exists so call      S12205
     C** routine to fill the gap.                                         S12205
     C*********  @STA      IFNE 0                          B*2            S12205
     C*********            EXSR #BAA                       **2            S12205
     C*********            END                             E*2            S12205
     C**********                                                          S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C** Set up key to chain to LF/FDINTRLL(need to get rates for W2).    S12205
     C*********  @PKEY     KLIST                                          S12205
     C*********            KFLD           @@CCY                           S12205
     C*********            KFLD           @PTYPE  1                       S12205
     C*********            KFLD           @PNUM   20                      S12205
     C**********                                                          S12205
     C** Move in key field values.                                        S12205
     C*********            MOVE 'W'       @PTYPE                          S12205
     C*********            Z-ADD2         @PNUM                           S12205
     C**********                                                          S12205
     C*********  @PKEY     CHAINFDINTRLL             80                   S12205
     C*********  *IN80     IFEQ '1'                        B1             S12205
     C*********  HWDLTF    ORNE ' '                        *1             S12205
     C*********            MOVE 'FDINTRLL'DBFILE           ************** S12205
     C*********            MOVE '005'     DBASE            *            * S12205
     C*********            MOVEL'W2'      DBKEY            *            * S12205
     C*********            MOVE '1'       *INU7            *DB ERROR 005* S12205
     C*********            MOVE '1'       *INU8            *            * S12205
     C*********            MOVE 'E'       @TERM            ************** S12205
     C*********            GOTO #BA9                       *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  Convert date to MIDAS day number.                               S12205
     C*********            Z-ADDHWPRDD    @@DTIN                          S12205
     C*********            EXSR ZA0680                                    S12205
     C*********  @@MDNO    SUB  RUND      @W2DAY  50                      S12205
     C**********                                                          S12205
     C**  Set up fields to be submitted to MM1001                         S12205
     C*********            Z-ADD@BR,6     @@BORA 117                      S12205
     C*********            Z-ADDHWBRRT    @@BORB 117                      S12205
     C*********            Z-ADD@LR,6     @@LERA 117                      S12205
     C*********            Z-ADDHWLDRT    @@LERB 117                      S12205
     C*********            Z-ADD@DY,6     @@DYTA  50                      S12205
     C*********            Z-ADD@W2DAY    @@DYTB  50                      S12205
     C**********                                                          S12205
     C**  Call  subroutine MM1001 (to get forward forward rate from       S12205
     C**  W1 to W2)                                                       S12205
     C*********            EXSR MM1001                                    S12205
     C**********                                                          S12205
     C**  Exit routine if a database error has occured.                   S12205
     C*********  *INU7     CABEQ'1'       #BA9                            S12205
     C**********                                                          S12205
     C**  Move the appropriate market rate for -1W into array.            S12205
     C*********  @BA,6     IFLT 0                          B1             S12205
     C*********            Z-ADD@@LERC    @MR,6            *1             S12205
     C*********            END                             E1             S12205
     C*********  @BA,6     IFGT 0                          B1             S12205
     C*********            Z-ADD@@BORC    @MR,6            *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  Calculate the market rates for -1M and -2M.                     S12205
     C*********  7         DO   8         @B                              S12205
     C*********  @B        ADD  1         @C               *1             S12205
     C**********                                                          S12205
     C**  Setup fields to be submitted to MM1001                          S12205
     C*********            Z-ADD@BR,@B    @@BORA 117       *1             S12205
     C*********            Z-ADD@BR,@C    @@BORB 117       *1             S12205
     C*********            Z-ADD@LR,@B    @@LERA 117       *1             S12205
     C*********            Z-ADD@LR,@C    @@LERB 117       *1             S12205
     C*********            Z-ADD@DY,@B    @@DYTA  50       *1             S12205
     C*********            Z-ADD@DY,@C    @@DYTB  50       *1             S12205
     C**********                                                          S12205
     C**  Call  subroutine MM1001                                         S12205
     C*********            EXSR MM1001                     *1             S12205
     C**********                                                          S12205
     C*********  *INU7     CABEQ'1'       #BA9             *1             S12205
     C**********                                                          S12205
     C**  Move the appropriate rate into market rate array.               S12205
     C*********  @BA,@B    IFLT 0                          B*2            S12205
     C*********            Z-ADD@@LERC    @MR,@B           **2            S12205
     C*********            END                             E*2            S12205
     C*********  @BA,@B    IFGT 0                          B*2            S12205
     C*********            Z-ADD@@BORC    @MR,@B           **2            S12205
     C*********            END                             E*2            S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  To calculate date for -4M, chain to FDINTRLL to get value       S12205
     C**  of spot date...                                                 S12205
     C**********                                                          S12205
     C**********                                                          S12205
     C**  ...move spot date into data structure...                        S12205
     C*********            Z-ADD@@MSPD    @DATE                           S12205
     C**********                                                          S12205
     C**  ... add four months to spot date...                             S12205
     C*********            ADD  4         @MTH                            S12205
     C*********  @MTH      IFGT 12                         B1             S12205
     C*********            SUB  12        @MTH             *1             S12205
     C*********            ADD  1         @YR              *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  ...subtract 1 from day until date is valid...                   S12205
     C*********  @@RTN     DOUNE1                          B1             S12205
     C*********            SUB  1         @DAY             *1             S12205
     C*********            Z-ADD@DATE     @@DTIN           *1             S12205
     C*********            EXSR ZA0680                     *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C** ...add 1 to MIDAS day number until day is not a holiday.         S12205
     C*********  @@HIND    DOUNE'H'                        B1             S12205
     C*********            ADD  1         @@MDNO           *1             S12205
     C*********            Z-ADD@@MDNO    @@MNO   50       *1             S12205
     C*********            EXSR ZA0830                     *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  Subtract today's day number to give number of days forward.     S12205
     C*********  @@MDNO    SUB  RUND      @DY,10                          S12205
     C**********                                                          S12205
     C**  Move in key field values to get rate for -M6 from FDINTRLL.     S12205
     C*********            MOVE 'M'       @PTYPE                          S12205
     C*********            Z-ADD6         @PNUM                           S12205
     C**********                                                          S12205
     C**  Chain to LF/FDINTRLL to retrieve M6 rates.                      S12205
     C*********  @PKEY     CHAINFDINTRLL             80                   S12205
     C*********  *IN80     IFEQ '1'                        B1             S12205
     C*********  HWDLTF    ORNE ' '                        *1             S12205
     C*********            MOVE 'FDINTRLL'DBFILE           ************** S12205
     C*********            MOVE '007'     DBASE            *            * S12205
     C*********            MOVEL'M6'      DBKEY            *            * S12205
     C*********            MOVE '1'       *INU7            *DB ERROR 007* S12205
     C*********            MOVE '1'       *INU8            *            * S12205
     C*********            MOVE 'E'       @TERM            ************** S12205
     C*********            GOTO #BA9                       *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C**  Set up input fields for subroutine MM1002 (interpolation of M4  S12205
     C**  broken date rates,using file rates for M3 and M6).              S12205
     C*********            Z-ADD@BR,9     @@BORA                          S12205
     C*********            Z-ADD@LR,9     @@LERA                          S12205
     C*********            Z-ADDHWBRRT    @@BORB                          S12205
     C*********            Z-ADDHWLDRT    @@LERB                          S12205
     C*********            Z-ADD@DY,9     @@DYTA                          S12205
     C*********            Z-ADD@DY,10    @@DYTC                          S12205
     C**********                                                          S12205
     C**  Calculate number of days forward and place in input field       S12205
     C*********            Z-ADDHWPRDD    @@DTIN                          S12205
     C*********            EXSR ZA0680                                    S12205
     C*********  @@MDNO    SUB  RUND      @@DYTB                          S12205
     C**********                                                          S12205
     C*********            EXSR MM1002                                    S12205
     C**********                                                          S12205
     C*********            Z-ADD@@BORC    @BR,10                          S12205
     C*********            Z-ADD@@LERC    @LR,10                          S12205
     C**********                                                          S12205
     C**  Set up input fields for MM1001 to calculate the forward forward S12205
     C**  rate for M3.                                                    S12205
     C*********            Z-ADD@BR,9     @@BORA                          S12205
     C*********            Z-ADD@BR,10    @@BORB                          S12205
     C*********            Z-ADD@LR,9     @@LERA                          S12205
     C*********            Z-ADD@LR,10    @@LERB                          S12205
     C*********            Z-ADD@DY,9     @@DYTA                          S12205
     C*********            Z-ADD@DY,10    @@DYTB                          S12205
     C**********                                                          S12205
     C**  Call  subroutine MM1001                                         S12205
     C*********            EXSR MM1001                                    S12205
     C**********                                                          S12205
     C*********  *INU7     CABEQ'1'       #BA9                            S12205
     C**********                                                          S12205
     C**  Move appropriate rate into market rate array.                   S12205
     C*********  @BA,@B    IFLT 0                                         S12205
     C*********            Z-ADD@@LERC    @MR,9                           S12205
     C*********            END                                            S12205
     C*********  @BA,@B    IFGT 0                                         S12205
     C*********            Z-ADD@@BORC    @MR,9                           S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C**  Convert market rates to display.                                S12205
     C*********            DO   9         @A               B1             S12205
     C*********            Z-ADD@MR,@A    @@RATI           *1             S12205
     C*********            EXSR ZA1030                     *1             S12205
     C*********            MOVE @@RATO    @MK,@A           *1             S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C*********  #BA9      ENDSR                           ***#BA9***     S12205
     C/EJECT
     C****************************************************************    S12205
     C**********                                                     *    S12205
     C*     #BAA    Fills gaps in rates arrays.                      *    S12205
     C**********                                                     *    S12205
     C*        CALLED BY   : #BA                                     *    S12205
     C**********                                                     *    S12205
     C*        CALLS       : MM1002,MM1001.                          *    S12205
     C**********                                                     *    S12205
     C*        WORK FIELDS : @STA   -  Start position for gap.       *    S12205
     C**********           : @END   -  End position for gap.         *    S12205
     C**********           : @FST   -  Position before gap starts.   *    S12205
     C**********           : @LST   -  Position after gap ends.      *    S12205
     C**********           : @BR    -  Borrow rate array.            *    S12205
     C**********           : @LR    -  Lend rate array.              *    S12205
     C**********           : @MR    -  Numeric market rate array.    *    S12205
     C**********           : @DY    -  Day number array.             *    S12205
     C**********           : @BA    -  Numeric balance array.        *    S12205
     C**********           : @B     -  Array pointer.                *    S12205
     C**********           : @C     -  Array pointer.                *    S12205
     C**********                                                     *    S12205
     C****************************************************************    S12205
     C*********  #BAA      BEGSR                                          S12205
     C**********                                                          S12205
     C**  Add 1 to start pointer and subtract 1 from end pointer to get   S12205
     C**  positions of first and last elements of gap.                    S12205
     C*********  @STA      SUB  1         @FST    10                      S12205
     C*********  @END      ADD  1         @LST    10                      S12205
     C**********                                                          S12205
     C*********  @STA      DO   @END      @B      10       B1             S12205
     C**********                                                          S12205
     C**  @B is pointer for current record and @C for previous record.    S12205
     C*********  @B        SUB  1         @C      10       *1             S12205
     C**********                                                          S12205
     C**  Setup fields to be submitted to MM1002                          S12205
     C*********            Z-ADD@BR,@FST  @@BORA           *1             S12205
     C*********            Z-ADD@LR,@FST  @@LERA           *1             S12205
     C*********            Z-ADD@BR,@LST  @@BORB           *1             S12205
     C*********            Z-ADD@LR,@LST  @@LERB           *1             S12205
     C*********            Z-ADD@DY,@FST  @@DYTA           *1             S12205
     C*********            Z-ADD@DY,@LST  @@DYTB           *1             S12205
     C*********            Z-ADD@DY,@B    @@DYTC           *1             S12205
     C**********                                                          S12205
     C**  Call  subroutine MM1002.                                        S12205
     C*********            EXSR MM1002                     *1             S12205
     C**********                                                          S12205
     C**  Move borrow and lend rates into array.                          S12205
     C*********            Z-ADD@@BORC    @BR,@B           *1             S12205
     C*********            Z-ADD@@LERC    @LR,@B           *1             S12205
     C**********                                                          S12205
     C**  Setup fields to be submitted to MM1001                          S12205
     C*********            Z-ADD@BR,@C    @@BORA 117       *1             S12205
     C*********            Z-ADD@BR,@B    @@BORB 117       *1             S12205
     C*********            Z-ADD@LR,@C    @@LERA 117       *1             S12205
     C*********            Z-ADD@LR,@B    @@LERB 117       *1             S12205
     C*********            Z-ADD@DY,@C    @@DYTA  50       *1             S12205
     C*********            Z-ADD@DY,@B    @@DYTB  50       *1             S12205
     C**********                                                          S12205
     C**  Call  subroutine MM1001                                         S12205
     C*********            EXSR MM1001                     *1             S12205
     C**********                                                          S12205
     C*********  *INU7     CABEQ'1'       #BAA9            *1             S12205
     C**********                                                          S12205
     C**  Move appropriate rate into market rate array.                   S12205
     C*********  @BA,@B    IFLT 0                          B*2            S12205
     C*********            Z-ADD@@LERC    @MR,@B           **2            S12205
     C*********            END                             E*2            S12205
     C*********  @BA,@B    IFGT 0                          B*2            S12205
     C*********            Z-ADD@@BORC    @MR,@B           **2            S12205
     C*********            END                             E*2            S12205
     C**********                                                          S12205
     C*********            END                             E1             S12205
     C**********                                                          S12205
     C*********  #BAA9     ENDSR                           ***#BAA9***    S12205
     C/EJECT                                                              S12205
     C****************************************************************    S12205
     C*NEW VERSION OF SR.                                                 S12205
     C*   #BA     Calculates market rates.                                S12205
     C*                                                                   S12205
     C*    CALLED BY  : #B                                                S12205
     C*                                                                   S12205
     C*    CALLS      : MM1001, MM1002                                    S12205
     C*                                                                   S12205
     C*    WORK FIELDS: @BR     - borrow rate                             S12205
     C*         @LR     - Lend rate                                       S12205
     C*         @MR     - Market Rate                                     S12205
     C*         @PR     - Period date                                     S12205
     C**********SPDY****-*Spot*days*for*ccy******                  S12205 S01194
     C*         A6SPDY  - Spot days for ccy                               S01194
     C*         @@MDNO  - MM Spot Date (Midas day no) (from ZA0680)       S12205
     C*         @S4LD   - MKT +4 lend rate                                S12205
     C*         @S4BW   - MKT +4 borrow rate                              S12205
     C*         @S3LD   - MKT +3 lend rate                                S12205
     C*         @S3BW   - MKT +3 borrow rate                              S12205
     C*         @S2LD   - MKT +2 lend rate                                S12205
     C*         @S2BW   - MKT +2 borrow rate                              S12205
     C*         @S1LD   - MKT +1 lend rate                                S12205
     C*         @S1BW   - MKT +1 borrow rate                              S12205
     C*         @DAY1   - no. actual days to RUND +1  from spot           S12205
     C*         @DAY2   - no. actual days to RUND +2  from spot           S12205
     C*         @DAY3   - no. actual days to RUND +3  from spot           S12205
     C*         @DAY4   - no. actual days to RUND +4  from spot           S12205
     C*                                                                   S12205
     C****************************************************************    S12205
     C           #BA       BEGSR                                          S12205
      *                                                                   S12205
      ** zeroise working fields from last call to program                 S12205
     C                     Z-ADD*ZEROS    @DAY1   10                      S12205
     C                     Z-ADD*ZEROS    @DAY2   10                      S12205
     C                     Z-ADD*ZEROS    @DAY3   10                      S12205
     C                     Z-ADD*ZEROS    @DAY4   10                      S12205
      *                                                                   S12205
      ** Must convert MM spot date to MIDAS day no.                       S12205
     C**********           Z-ADDMSPD      @@DTIN                   S12205 S01194
     C                     Z-ADDA6MMSD    @@DTIN                          S01194
     C                     EXSR ZA0680                                    S12205
      *                                                                   S12205
      ** Set up key to chain to LF/FDINTDLL                               S12205
     C           @IRKEY    KLIST                                          S12205
     C****                 KFLD           @@CCY                    S12205 S01166
     C                     KFLD           DDCCY                           S01166
     C                     KFLD           @KYFLD  80                      S12205
     C                     MOVE *LOVAL    @KYFLD                          S12205
     C           @IRKEY    SETLLFDINTDLL                                  S12205
      *                                                                   S12205
      ** Obtain Interest Rates for periods required by this enquiry       S12205
     C                     DO   9         @N               B1             S12205
      *                                                                   S12205
     C                     READ FDINTDLL                 80*1             S12205
      *                                                                   S12205
      ** If a record exists move borrow and lend rates into arrays.       S12205
      ** and Period date                                                  S12205
     C           *IN80     IFEQ '0'                        B*2            S12205
     C                     Z-ADDHWBRRT    @BR,@N           **2            S12205
     C                     Z-ADDHWLDRT    @LR,@N           **2            S12205
      *                                                                   S12205
     C                     END                             E*2            S12205
     C                     END                             E1             S12205
      *                                                                   S12205
      **  Some Rates may be used from the file without Forward Forward    S12205
      **  calculations:                                                   S12205
      **  NB. If Net Balance at period date is -ve use lend rate          S12205
      **      Else use borrow rate                                        S12205
      *                                                                   S12205
      **  Market Rate for TDY is always overnight rate (D1)               S12205
     C           @BA,1     IFLT *ZERO                      B1             S12205
     C                     Z-ADD@LR,1     @MR,1            *1             S12205
     C                     ELSE                            X1             S12205
     C                     Z-ADD@BR,1     @MR,1            *1             S12205
     C                     END                             E1             S12205
      *                                                                   S12205
      **  If Spot Days are 1 for this ccy                                 S12205
      **  Market Rate +1 is Spot/Next (D3)                                S12205
     C********** SPDY      IFEQ 1                          B1      S12205 S01194
     C           A6SPDY    IFEQ 1                          B1             S01194
     C           @BA,3     IFLT *ZERO                      B*2            S12205
     C                     Z-ADD@LR,3     @MR,2            **2            S12205
     C                     ELSE                            X*2            S12205
     C                     Z-ADD@BR,3     @MR,2            **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
      ** Save both rates for forward forward rates calculation            S12205
     C                     Z-ADD@BR,3     @S1BW  117       *1             S12205
     C                     Z-ADD@LR,3     @S1LD  117       *1             S12205
      *                                                                   S12205
      ** If Spot Days are 2 - 9 for this ccy                              S12205
     C                     ELSE                            X1             S12205
      *                                                                   S12205
      **  Market Rate +1 is Tommorow/Next rate (D2)                       S12205
     C           @BA,2     IFLT *ZERO                      B*2            S12205
     C                     Z-ADD@LR,2     @MR,2            **2            S12205
     C                     ELSE                            X*2            S12205
     C                     Z-ADD@BR,2     @MR,2            **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
      **  Market Rate +2 is Spot/Next rate (D3)                           S12205
     C           @BA,3     IFLT *ZERO                      B*2            S12205
     C                     Z-ADD@LR,3     @MR,3            **2            S12205
     C                     ELSE                            X*2            S12205
     C                     Z-ADD@BR,3     @MR,3            **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
      ** Save both rates for forward forward rates calculation            S12205
     C                     Z-ADD@BR,3     @S2BW  117       *1             S12205
     C                     Z-ADD@LR,3     @S2LD  117       *1             S12205
      *                                                                   S12205
      ** If Spot Days are 3 - 9 for this ccy                              S12205
      **  Market Rate +3 is Spot/Next rate (D3)                           S12205
     C********** SPDY      IFGE 3                          B*2     S12205 S01194
     C           A6SPDY    IFGE 3                          B*2            S01194
     C           @BA,4     IFLT *ZERO                      B**3           S12205
     C                     Z-ADD@LR,3     @MR,4            ***3           S12205
     C                     ELSE                            X**3           S12205
     C                     Z-ADD@BR,3     @MR,4            ***3           S12205
     C                     END                             E**3           S12205
      *                                                                   S12205
      ** Save both rates for forward forward rates calculation            S12205
     C                     Z-ADD@BR,3     @S3BW  117       **2            S12205
     C                     Z-ADD@LR,3     @S3LD  117       **2            S12205
      *                                                                   S12205
      ** If Spot Days are 4 - 9 for this ccy                              S12205
      **  Market Rate +4 is Spot/Next rate (D3)                           S12205
     C********** SPDY      IFGE 4                          B**3    S12205 S01194
     C           A6SPDY    IFGE 4                          B**3           S01194
     C           @BA,5     IFLT *ZERO                      B***4          S12205
     C                     Z-ADD@LR,3     @MR,5            ****4          S12205
     C                     ELSE                            X***4          S12205
     C                     Z-ADD@BR,3     @MR,5            ****4          S12205
     C                     END                             E***4          S12205
      *                                                                   S12205
      ** Save both rates for forward forward rates calculation            S12205
     C                     Z-ADD@LR,3     @S4LD  117       ***3           S12205
     C                     Z-ADD@BR,3     @S4BW  117       ***3           S12205
     C                     END                             E**3           S12205
     C                     END                             E*2            S12205
     C                     END                             E1             S12205
      *                                                                   S12205
      ** Dates between Spot and 1 Week do not have rates on               S12205
      ** LF/FDINTDLL so they must be calculated using Broken Dates        S12205
      ** Rate Calculation before the Forward Forward Rate may be          S12205
      ** calculated if the spot days is not >= 4                          S12205
      *                                                                   S12205
      ** Calculate no. days from spot date to both forward dates          S12205
      ** Add 1 to result because day numbers on LF/MMFNRDLL are           S12205
      ** for the day before Next Working Day                              S12205
      ** Next (working) day after spot =    @@DYTA                        S12205
      *                                                                   S12205
      ** Setup the common parameters for SR. MM1002                       S12205
      *                                                                   S12205
     C********** SPDY      IFLE 3                          B1      S12205 S01194
     C           A6SPDY    IFLE 3                          B1             S01194
     C                     Z-ADD1         @@DYTA           *1             S12205
     C           HRPDW1    SUB  @@MDNO    @@DYTB           *1             S12205
     C                     ADD  1         @@DYTB           *1             S12205
      *                                                                   S12205
      ** Obtain the lend and borrow rates from array                      S12205
      ** Spot/Next rate                                                   S12205
     C                     Z-ADD@BR,3     @@BORA           *1             S12205
     C                     Z-ADD@LR,3     @@LERA           *1             S12205
      ** 1 Week rate                                                      S12205
     C                     Z-ADD@BR,4     @@BORB           *1             S12205
     C                     Z-ADD@LR,4     @@LERB           *1             S12205
     C                     END                             E1             S12205
      *                                                                   S12205
     C********** SPDY      IFEQ 3                          B1      S12205 S01194
     C********** SPDY      OREQ 2                          B1      S12205 S01194
     C********** SPDY      OREQ 1                          B1      S12205 S01194
     C           A6SPDY    IFEQ 3                          B1             S01194
     C           A6SPDY    OREQ 2                          B1             S01194
     C           A6SPDY    OREQ 1                          B1             S01194
      *                                                                   S12205
      ** S/+4 Market Rate   (for spot days = 1, 2 or 3)                   S12205
      ** ie 4 working days from today forward, this may be more than      S12205
      ** 4 actual days from today; also work in days from spot date       S12205
      ** 4 - SPDY + 1 = full days from spot date   ie. 5 - SPDY           S12205
     C********** 5         SUB  SPDY      @DAYS   10       *1      S12205 S01194
     C           5         SUB  A6SPDY    @DAYS   10       *1             S01194
      ** find MIDAS day no. of @DAYS working days from spot               S12205
     C                     EXSR #BAA                       *1             S12205
      *                                                                   S12205
      **  store actual no. days for Forward forward calculation           S12205
     C                     Z-ADD@@DYTC    @DAY4            *1             S12205
      *                                                                   S12205
      * Broken Dates Rate Calculation                                     S12205
     C                     EXSR MM1002                     *1             S12205
      *                                                                   S12205
      * Save calculated rates for Forward forward calculation             S12205
     C                     Z-ADD@@LERC    @S4LD            *1             S12205
     C                     Z-ADD@@BORC    @S4BW            *1             S12205
      *                                                                   S12205
     C********** SPDY      IFEQ 1                          B*2     S12205 S01194
     C********** SPDY      OREQ 2                          B*2     S12205 S01194
     C           A6SPDY    IFEQ 1                          B*2            S01194
     C           A6SPDY    OREQ 2                          B*2            S01194
      *                                                                   S12205
      ** S/+3 Market Rate   (for spot days = 1 or 2)                      S12205
      ** ie 3 working days from today forward, this may be more than      S12205
      ** 3 actual days from today; also work in days from spot date       S12205
      ** 3 - SPDY + 1 = full days from spot date   ie. 4 - SPDY           S12205
     C********** 4         SUB  SPDY      @DAYS            **2     S12205 S01194
     C           4         SUB  A6SPDY    @DAYS            **2            S01194
      ** find MIDAS day no. of @DAYS working days from spot               S12205
     C                     EXSR #BAA                       **2            S12205
      *                                                                   S12205
      **  store actual no. days for Forward forward calculation           S12205
     C                     Z-ADD@@DYTC    @DAY3            **2            S12205
      *                                                                   S12205
     C                     EXSR MM1002                     **2            S12205
      *                                                                   S12205
      * Save calculated rates for Forward forward calculation             S12205
     C                     Z-ADD@@BORC    @S3BW            **2            S12205
     C                     Z-ADD@@LERC    @S3LD            **2            S12205
      *                                                                   S12205
     C********** SPDY      IFEQ 1                          B**3    S12205 S01194
     C           A6SPDY    IFEQ 1                          B**3           S01194
      *                                                                   S12205
      ** S/+2 Market Rate   (for spot days = 1)                           S12205
      ** ie 2 working days from today forward, this may be more than      S12205
      ** 2 actual days from today; also work in days from spot date       S12205
      ** 2 - SPDY + 1 = full days from spot date   ie. 3 - SPDY           S12205
     C********** 3         SUB  SPDY      @DAYS            ***3    S12205 S01194
     C           3         SUB  A6SPDY    @DAYS            ***3           S01194
      ** find MIDAS day no. of @DAYS working days from spot               S12205
     C                     EXSR #BAA                       ***3           S12205
      *                                                                   S12205
      **  store actual no. days for Forward forward calculation           S12205
     C                     Z-ADD@@DYTC    @DAY2            ***3           S12205
      *                                                                   S12205
      * Broken Dates Rate Calculation                                     S12205
     C                     EXSR MM1002                     ***3           S12205
      *                                                                   S12205
      * Save calculated rates for Forward forward calculation             S12205
     C                     Z-ADD@@LERC    @S2LD            ***3           S12205
     C                     Z-ADD@@BORC    @S2BW            ***3           S12205
      *                                                                   S12205
     C                     END                             E**3           S12205
     C                     END                             E*2            S12205
     C                     END                             E1             S12205
      *                                                                   S12205
      ** Forward forward calculations may be run using Broken Date        S12205
      ** Rates just calculated or rates from file                         S12205
     C********** SPDY      IFEQ 3                          B1      S12205 S01194
     C********** SPDY      OREQ 2                          B1      S12205 S01194
     C********** SPDY      OREQ 1                          B1      S12205 S01194
     C           A6SPDY    IFEQ 3                          B1             S01194
     C           A6SPDY    OREQ 2                          B1             S01194
     C           A6SPDY    OREQ 1                          B1             S01194
      *                                                                   S12205
      ** +4 Market rate                                                   S12205
     C           @DAY3     IFEQ *ZEROS                     B*2            S12205
      **  must calculate actual days from spot date excluding             S12205
      **  non working days for +3 days from spot                          S12205
     C********** 4         SUB  SPDY      @DAYS            **2     S12205 S01194
     C           4         SUB  A6SPDY    @DAYS            **2            S01194
      ** find actual days = @DAYS working days from spot                  S12205
     C                     EXSR #BAA                       **2            S12205
     C                     Z-ADD@@DYTC    @@DYTA           **2            S12205
     C                     ELSE                            X*2            S12205
     C                     Z-ADD@DAY3     @@DYTA           **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
     C                     Z-ADD@DAY4     @@DYTB           *1             S12205
     C                     Z-ADD@S3BW     @@BORA           *1             S12205
     C                     Z-ADD@S3LD     @@LERA           *1             S12205
     C                     Z-ADD@S4BW     @@BORB           *1             S12205
     C                     Z-ADD@S4LD     @@LERB           *1             S12205
     C                     EXSR MM1001                     *1             S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,5     IFLT *ZERO                      B*2            S12205
     C                     Z-ADD@@LERC    @MR,5            **2            S12205
     C                     ELSE                            **2            S12205
     C                     Z-ADD@@BORC    @MR,5            **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
      **  +3 market rate  (spot days = 1 or 2)                            S12205
     C********** SPDY      IFEQ 2                          B*2     S12205 S01194
     C********** SPDY      OREQ 1                          B*2     S12205 S01194
     C           A6SPDY    IFEQ 2                          B*2            S01194
     C           A6SPDY    OREQ 1                          B*2            S01194
      *                                                                   S12205
     C           @DAY2     IFEQ *ZEROS                     B*2            S12205
      **  must calculate actual days from spot date excluding             S12205
      **  non working days for +2 days from spot, note @DAY2 will be      S12205
      **  non blank for SPDY = 1 (ie calculate S/N date)                  S12205
     C                     Z-ADD1         @DAYS            **2            S12205
      ** find actual days = @DAYS working days from spot                  S12205
     C                     EXSR #BAA                       **2            S12205
     C                     Z-ADD@@DYTC    @@DYTA           **2            S12205
     C                     ELSE                            X*2            S12205
     C                     Z-ADD@DAY2     @@DYTA           **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
     C                     Z-ADD@DAY3     @@DYTB           **2            S12205
     C                     Z-ADD@S2BW     @@BORA           **2            S12205
     C                     Z-ADD@S2LD     @@LERA           **2            S12205
     C                     Z-ADD@S3BW     @@BORB           **2            S12205
     C                     Z-ADD@S3LD     @@LERB           **2            S12205
     C                     EXSR MM1001                     **2            S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,4     IFLT *ZERO                      B**3           S12205
     C                     Z-ADD@@LERC    @MR,4                           S12205
     C                     ELSE                            ***3           S12205
     C                     Z-ADD@@BORC    @MR,4            ***3           S12205
     C                     END                             E**3           S12205
      *                                                                   S12205
     C********** SPDY      IFEQ 1                          B**3    S12205 S01194
     C           A6SPDY    IFEQ 1                          B**3           S01194
      *                                                                   S12205
      ** S/+2 Market Rate   (for spot days = 1)                           S12205
      *                                                                   S12205
      ** non working days                                                 S12205
      **  must calculate actual days from spot date excluding             S12205
      ** non working days                                                 S12205
     C                     Z-ADD1         @DAYS            ***3           S12205
      ** find MIDAS day no. of @DAYS working days from spot               S12205
     C                     EXSR #BAA                       ***3           S12205
     C                     Z-ADD@@DYTC    @@DYTA           ***3           S12205
      *                                                                   S12205
     C                     Z-ADD@DAY2     @@DYTB           ***3           S12205
     C                     Z-ADD@S1BW     @@BORA           ***3           S12205
     C                     Z-ADD@S1LD     @@LERA           ***3           S12205
     C                     Z-ADD@S2BW     @@BORB           ***3           S12205
     C                     Z-ADD@S2LD     @@LERB           ***3           S12205
     C                     EXSR MM1001                     ***3           S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,3     IFLT *ZERO                      B***4          S12205
     C                     Z-ADD@@LERC    @MR,3            ****4          S12205
     C                     ELSE                            ****4          S12205
     C                     Z-ADD@@BORC    @MR,3            ****4          S12205
     C                     END                             E***4          S12205
     C                     END                             E**3           S12205
     C                     END                             E*2            S12205
     C                     END                             E1             S12205
      *                                                                   S12205
      ** Calculation of 1W, 1M, 2M and 3M Market Rates is the same for    S12205
      ** all values of spot days:                                         S12205
      *                                                                   S12205
      ** 1W Market Rate                                                   S12205
      *                                                                   S12205
      ** Calculate no. days from spot date to both forward dates          S12205
     C           @DAY4     IFEQ *ZEROS                     B1             S12205
      **  must calculate actual days from spot date excluding             S12205
      **  non working days for +4 days from spot                          S12205
     C********** 5         SUB  SPDY      @DAYS            *1      S12205 S01194
     C           5         SUB  A6SPDY    @DAYS            *1             S01194
      *                                                                   S12205
      **If spot days > 4 must assume M+4 (from rund) is 0 day from spdt   S12205
     C********** SPDY      IFLT *ZERO                      B*2     S12205 S01194
     C           A6SPDY    IFLT *ZERO                      B*2            S01194
     C                     Z-ADD*ZERO     @DAYS            **2            S12205
     C                     END                             E*2            S12205
      *                                                                   S12205
      ** find actual days = @DAYS working days from spot                  S12205
     C                     EXSR #BAA                       *1             S12205
      * actual days                                                       S12205
     C                     Z-ADD@@DYTC    @@DYTA           *1             S12205
     C                     ELSE                            X1             S12205
     C                     Z-ADD@DAY4     @@DYTA           *1             S12205
     C                     END                             E1             S12205
      *                                                                   S12205
     C           HRPDW1    SUB  @@MDNO    @@DYTB                          S12205
     C                     ADD  1         @@DYTB                          S12205
      *                                                                   S12205
      ** Obtain the lend and borrow rates from array                      S12205
      ** +4 rate                                                          S12205
     C                     Z-ADD@S4BW     @@BORA                          S12205
     C                     Z-ADD@S4LD     @@LERA                          S12205
      ** 1 Week rate                                                      S12205
     C                     Z-ADD@BR,4     @@BORB                          S12205
     C                     Z-ADD@LR,4     @@LERB                          S12205
      *                                                                   S12205
      ** Forward Forward Interest Rate Calculation                        S12205
     C                     EXSR MM1001                                    S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,6     IFLT *ZERO                                     S12205
     C                     Z-ADD@@LERC    @MR,6                           S12205
     C                     ELSE                                           S12205
     C                     Z-ADD@@BORC    @MR,6                           S12205
     C                     END                                            S12205
      *                                                                   S12205
      ** 1M Market Rate                                                   S12205
      *                                                                   S12205
      ** Calculate no. days from spot date to both forward dates          S12205
      ** Add 1 to result because day numbers on LF/MMFNRDLL are           S12205
      ** for the day before Next Working Day                              S12205
     C           HRPDW1    SUB  @@MDNO    @@DYTA                          S12205
     C                     ADD  1         @@DYTA                          S12205
      *                                                                   S12205
     C           HRPDM1    SUB  @@MDNO    @@DYTB                          S12205
     C                     ADD  1         @@DYTB                          S12205
      *                                                                   S12205
      ** Obtain the lend and borrow rates from array                      S12205
      ** 1 Week rate                                                      S12205
     C                     Z-ADD@BR,4     @@BORA                          S12205
     C                     Z-ADD@LR,4     @@LERA                          S12205
      ** 1 Month rate                                                     S12205
     C                     Z-ADD@BR,7     @@BORB                          S12205
     C                     Z-ADD@LR,7     @@LERB                          S12205
      *                                                                   S12205
      ** Forward Forward Interest Rate Calculation                        S12205
     C                     EXSR MM1001                                    S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,7     IFLT *ZERO                                     S12205
     C                     Z-ADD@@LERC    @MR,7                           S12205
     C                     ELSE                                           S12205
     C                     Z-ADD@@BORC    @MR,7                           S12205
     C                     END                                            S12205
      *                                                                   S12205
      ** 2M Market Rate                                                   S12205
      *                                                                   S12205
      ** Calculate no. days from spot date to both forward dates          S12205
      ** Add 1 to result because day numbers on LF/MMFNRDLL are           S12205
      ** for the day before Next Working Day                              S12205
     C           HRPDM1    SUB  @@MDNO    @@DYTA                          S12205
     C                     ADD  1         @@DYTA                          S12205
      *                                                                   S12205
     C           HRPDM2    SUB  @@MDNO    @@DYTB                          S12205
     C                     ADD  1         @@DYTB                          S12205
      *                                                                   S12205
      ** Obtain the lend and borrow rates from array                      S12205
      ** 1 Month rate                                                     S12205
     C                     Z-ADD@BR,7     @@BORA                          S12205
     C                     Z-ADD@LR,7     @@LERA                          S12205
      ** 2 Month rate                                                     S12205
     C                     Z-ADD@BR,8     @@BORB                          S12205
     C                     Z-ADD@LR,8     @@LERB                          S12205
      *                                                                   S12205
      ** Forward Forward Interest Rate Calculation                        S12205
     C                     EXSR MM1001                                    S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,8     IFLT *ZERO                                     S12205
     C                     Z-ADD@@LERC    @MR,8                           S12205
     C                     ELSE                                           S12205
     C                     Z-ADD@@BORC    @MR,8                           S12205
     C                     END                                            S12205
      *                                                                   S12205
      ** 3M Market Rate                                                   S12205
      *                                                                   S12205
      ** Calculate no. days from spot date to both forward dates          S12205
      ** Add 1 to result because day numbers on LF/MMFNRDLL are           S12205
      ** for the day before Next Working Day                              S12205
     C           HRPDM2    SUB  @@MDNO    @@DYTA                          S12205
     C                     ADD  1         @@DYTA                          S12205
      *                                                                   S12205
     C           HRPDM3    SUB  @@MDNO    @@DYTB                          S12205
     C                     ADD  1         @@DYTB                          S12205
      *                                                                   S12205
      ** Obtain the lend and borrow rates from array                      S12205
      ** 2 Month rate                                                     S12205
     C                     Z-ADD@BR,8     @@BORA                          S12205
     C                     Z-ADD@LR,8     @@LERA                          S12205
      ** 3 Month rate                                                     S12205
     C                     Z-ADD@BR,9     @@BORB                          S12205
     C                     Z-ADD@LR,9     @@LERB                          S12205
      *                                                                   S12205
      ** Forward Forward Interest Rate Calculation                        S12205
     C                     EXSR MM1001                                    S12205
      *                                                                   S12205
      ** Use lend or borrow rate depending on Net Balance sign            S12205
     C           @BA,9     IFLT *ZERO                                     S12205
     C                     Z-ADD@@LERC    @MR,9                           S12205
     C                     ELSE                                           S12205
     C                     Z-ADD@@BORC    @MR,9                           S12205
     C                     END                                            S12205
      *                                                                   S12205
      **  Convert market rates to display.                                S12205
     C                     DO   9         @A      20       B1             S12205
     C****                 Z-ADD@MR,@A    @@RATI           *1      S12205 S01166
     C****                 EXSR ZA1030                     *1      S12205 S01166
     C****                 MOVE @@RATO    @MK,@A           *1      S12205 S01166
     C           1000000   MULT @MR,@A    @@AMTW           *1             S01166
     C                     Z-ADD6         @@QECN           *1             S01166
     C                     EXSR ZA0920                     *1             S01166
     C                     MOVE @@AMTD    @MK,@A           *1             S01166
     C                     END                             E1             S12205
     C           #BA9      ENDSR                                          S12205
     C/EJECT                                                              S12205
     C****************************************************************    S12205
      *                                                                   S12205
      *   #BAA Calculates an actual number of days between MM spot        S12205
      *        date and number of working days forward                    S12205
      *                                                                   S12205
      *  INPUT:  @@MDNO - MM Spot date                                    S12205
      *          @@DAYS - number of working days from spot required       S12205
      *                                                                   S12205
      *  USES:   @@MNO  - midas day no of actual days from spot           S12205
      *          ZDAYNO - Date input to ZFWDT                             S01195
      *          ZCCY   - Currency input to ZFWDT                         S01195
      *          ZLOC   - Currency location input to ZFWDT                S01195
      *          ZNRDYS - No. of forward days input to ZFWDT              S01195
      *          ZDYNBR - Calculated working day output from ZFWDT        S01195
      *                                                                   S12205
      *  OUTPUT: @@DYTC - number of actual days                           S12205
      *                                                                   S12205
     C***CALLS:**ZA0830*-*Is*day*a*holiday************************ S12205 S01195
      *  CALLS:  ZFWDT  - Find no. of working days forward                S01195
      *                                                                   S12205
     C****************************************************************    S12205
      *                                                                   S12205
     C           #BAA      BEGSR                                          S12205
      **  set day number to MM spot date                                  S12205
     C**********           Z-ADD@@MDNO    @@MNO   50               S12205 S01195
     C                     Z-ADD@@MDNO    ZDAYNO                          S01195
      *                                                                   S12205
      **  look for @DAYS working days forward                             S12205
     C                     Z-ADD@DAYS     ZNRDYS                          S01195
     C                     MOVELA6CYCD    ZCCY                            S01195
      * Set up currency location as system location code                  S01195
     C                     MOVELBJSLCD    ZLOC                            S01195
     C                     EXSR ZFWDT                                     S01195
     C**********           DO   @DAYS                      B1      S12205 S01195
     C**********           ADD  1         @@MNO            *1      S12205 S01195
      **********                                                   S12205 S01195
      ****is*day*a*holiday***                                      S12205 S01195
     C**********           EXSR ZA0830                     *1      S12205 S01195
      **********                                                   S12205 S01195
      ***if*day*is*a*holiday*find*next*working*day***              S12205 S01195
     C********** @@HIND    IFEQ 'H'                        B*2     S12205 S01195
     C********** @@HIND    DOUEQ'W'                        B**3    S12205 S01195
     C**********           ADD  1         @@MNO            ***3    S12205 S01195
     C**********           EXSR ZA0830                     ***3    S12205 S01195
     C**********           END                             E**3    S12205 S01195
     C**********           END                             E*2     S12205 S01195
     C**********           END                             E1      S12205 S01195
     C                     Z-ADDZDYNBR    @@MNO   50                      S01195
      *                                                                   S12205
      ** calculate actual no days forward                                 S12205
     C           @@MNO     SUB  @@MDNO    @@DYTC                          S12205
      *                                                                   S12205
     C           #BAA9     ENDSR                                          S12205
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*   MM1001 - Determine a Forward Forward Interest Rate          *
     C*                                                               *
     C*  CALLED BY :     #BA.                                         *
     C*                                                               *
     C*  CALLS :         MM1011                                       *
     C*                                                               *
     C*  FIELDS INPUT @@BORA - Borrow rate for start date             *
     C*               @@BORB - Borrow rate for end date               *
     C*               @@LERA - Lend rate for start date               *
     C*               @@LERB - Lend rate for end date                 *
     C*               @@DYTA - Number of days to start date           *
     C*               @@DYTB - Number of days to end date             *
     C*               @@CCY  - Deal currency                          *
     C*                                                               *
     C*  FIELDS OUTPUT @@BORC - Borrow rate for specified date        *
     C*                @@LERC - Lend rate for specified date          *
     C*                                                               *
     C*  WORKFIELDS   @@FLD1  - Borrow end rate X Number to End days  *
     C*               @@FLD2  - Lend start rate X Number to start days*
     C*               @@FLD3  - Number of days from Start to end      *
     C*               @@FLD5  - Number of Days X 100                  *
     C*               @@FLD6  - 1 plus @@FLD5                         *
     C*               @@NUMA  - Numerator work field of equation      *
     C*               @@DEM   - Denominator work field of equation    *
     C*               @@DAYO  - Number of days in year                *
     C*                                                               *
     C*****************************************************************
     C           MM1001    BEGSR
     C**  Call  SUBROUTINE MM1011
     C                     EXSR MM1011
     C           *INU7     CABEQ'1'       M10019
     C*
     C**  Calculate MARKET BORROW RATE                                    ME1221
     C           @@BORB    MULT @@DYTB    @@FLD1 157
     C           @@LERA    MULT @@DYTA    @@FLD2 157
     C           @@FLD1    SUB  @@FLD2    @@NUMA 157
     C*
     C**  Number of days from Start to End date
     C           @@DYTB    SUB  @@DYTA    @@FLD3  50
     C*
     C           @@DAYO    MULT 100       @@FLD5  50
     C           @@FLD2    DIV  @@FLD5    @@FLD6 157
     C                     ADD  1         @@FLD6
     C*
     C           @@FLD3    MULT @@FLD6    @@DEM  157
     C*
     C           @@NUMA    DIV  @@DEM     @@BORC 117H                     ME1221
     C*
     C**  Calculate MARKET LENDING RATE                                   ME1221
     C           @@LERB    MULT @@DYTB    @@FLD1 157
     C           @@BORA    MULT @@DYTA    @@FLD2 157
     C           @@FLD1    SUB  @@FLD2    @@NUMA 157
     C*
     C           @@FLD2    DIV  @@FLD5    @@FLD6 157
     C                     ADD  1         @@FLD6
     C*
     C           @@FLD3    MULT @@FLD6    @@DEM  157
     C*
     C           @@NUMA    DIV  @@DEM     @@LERC 117H                     ME1221
     C**
     C           M10019    ENDSR                           ***M10019***
     C/EJECT
     C*****************************************************************
     C*   MM1011 - DETERMINE NUMBER OF DAYS IN A YEAR FOR DEFAULT     *
     C*            INTEREST CALCULATION METHOD                        *
     C*                                                               *
     C*  CALLED BY :  #B,MM1001.                                      *
     C*                                                               *
     C*  CALLS :                                                      *
     C*                                                               *
     C*  FIELDS INPUT @@CALC  - DEFAULT INPUT CALCULATION METHOD      *
     C*                                                               *
     C*  FIELDS OUTPUT @@DAYO - DAYS IN YR FOR DFLT INTEREST CALC METH*
     C*                                                               *
     C*  WORKFIELDS           - NONE                                  *
     C*                                                               *
     C*****************************************************************
     C           MM1011    BEGSR
     C*
     C** IF DFLT INTEREST CALCULATION METHOD '1' OR '4' SET DAYS IN
     C** TO '365'
     C           @@CALC    IFEQ '1'                        B1
     C           @@CALC    OREQ '4'                        *1
     C                     MOVE 365       @@DAYO           *1
     C                     END                             E1
     C*
     C** IF DFLT INTEREST CALCULATION METHOD '2' '3' OR '5' SET DAYS IN
     C** TO '360'
     C           @@CALC    IFEQ '2'                        B1
     C           @@CALC    OREQ '3'                        *1
     C           @@CALC    OREQ '5'                        *1
     C                     MOVE 360       @@DAYO           *1
     C                     END                             E1
     C*
     C** IF DFLT INTEREST CALCULATION METHOD '6' SET DAYS IN YEAR '360'
     C           @@CALC    IFEQ '6'                        B1
     C                     MOVE 366       @@DAYO  30       *1
     C                     END                             E1
     C*
     C**  SET ATTRIBUTES OF DEFAULT INTEREST CALCULATION METHOD
     C                     MOVEL@@CALC    @@CALC  1
     C*
     C           M10119    ENDSR                           ***M10119***
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*     MM1002 -  Determine a broken date rate                   *
     C*                                                              *
     C*     CALLED BY:  #BA,#BAA.                                    *
     C*                                                              *
     C*     CALLS:                                                   *
     C*                                                              *
     C*     INPUT:   @@BORA - Borrow rate for start date.            *
     C*              @@BORB - Borrow rate for end date.              *
     C*              @@LERA - Lend rate for start date.              *
     C*              @@LERB - Lend rate for end date.                *
     C*              @@DYTA - Number of days to start date.          *
     C*              @@DYTB - Number of days to end date.            *
     C*              @@DYTC - Number of days to required date.       *
     C*              @INTM  - Interpolation method required.         *
     C*                                                              *
     C*     OUTPUT:  @@BORC - Borrow rate for required date.         *
     C*              @@LERC - Lend rate for required date.           *
     C*                                                              *
     C*     USES:    @@TCSA - (Tc-Ta)                                *
     C*              @@TBSA - (Tb-Ta)                                *
     C*              @@RATA - Ra*Ta                                  *
     C*              @@RBTB - Rb*Tb                                  *
     C*              @@COEF - @@TBSA*Tc                              *
     C*              @@ELM1 - @@COEF*(@@RBTB-@@RATA)                 *
     C*              @@DLM1 - 1st element of equation.               *
     C*              @@DLM2 - 2nd element of equation.               *
     C*              @@EINT - Integer part of (RbTb-RaTa)*(Tc-Ta)    *
     C*              @@EDEC - Decimal part of (RbTb-RaTa)*(Tc-Ta)    *
     C*              @@DINT - @@EINT/@@COEF                          *
     C*              @@DDEC - @@EINT/@@COEF                          *
     C*                                                              *
     C****************************************************************
     C**
     C**  This routine uses two equations:
     C**
     C**  1. Linear interpolation.
     C**
     C**                  Ra + (Tc-Ta)*(Rb-Ra)
     C**     Rc =              -------
     C**                       (Tb-Ta)
     C**
     C**
     C**  2. Weighted interpolation.
     C**
     C**                  TaRa    (Tc-Ta)  *(TbRb-TaRa)
     C**     Rc =         ---- + ----------
     C**                   Tc    (Tb-Ta)*Tc
     C**
     C**
     C**     where   Rc = rate at required no. of days forward.
     C**             Ra = rate at start no. of days forward.
     C**             Rb = rate at end no. of days forward.
     C**             Tc = required no. of days forward.
     C**             Ta = start no. of days forward.
     C**             Tb = end no. of days forward.
     C**
     C*
     C*
     C           MM1002    BEGSR
     C*
     C**  Define and initialise fields used.
     C                     Z-ADD@@BORA    @@BORA 117
     C                     Z-ADD@@BORB    @@BORB 117
     C                     Z-ADD@@LERA    @@LERA 117
     C                     Z-ADD@@LERB    @@LERB 117
     C                     Z-ADD@@DYTA    @@DYTA  50
     C                     Z-ADD@@DYTB    @@DYTB  50
     C                     Z-ADD@@DYTC    @@DYTC  50
     C                     MOVE @@INTM    @@INTM  1
     C*
     C                     Z-ADD*ZEROS    @@BORC 117
     C                     Z-ADD*ZEROS    @@LERC 117
     C*
     C                     Z-ADD*ZEROS    @@TCSA  50
     C                     Z-ADD*ZEROS    @@TBSA  50
     C                     Z-ADD*ZEROS    @@RATA 157
     C                     Z-ADD*ZEROS    @@RBTB 157
     C***********          Z-ADD*ZEROS    @@COEF  60                      065473
     C                     Z-ADD*ZEROS    @@COEF 150                      065473
     C                     Z-ADD*ZEROS    @@ELM1 157
     C                     Z-ADD*ZEROS    @@DLM1 159
     C                     Z-ADD*ZEROS    @@DLM2 159
     C                     Z-ADD*ZEROS    @@EINT 100
     C                     Z-ADD*ZEROS    @@EDEC  99
     C                     Z-ADD*ZEROS    @@DINT 139
     C                     Z-ADD*ZEROS    @@DDEC  99
     C*
     C**  Calculate     (Tc-Ta) and (Tb-Ta).
     C           @@DYTC    SUB  @@DYTA    @@TCSA
     C           @@DYTB    SUB  @@DYTA    @@TBSA
     C*
     C**  If the interpolation method field holds an 'L', the inter-
     C**  polation method is linear.
     C           @@INTM    IFEQ 'L'                        B1
     C*
     C**  Calculate Borrow rate.
     C**  Calculate (Rb-Ra)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@BORB    SUB  @@BORA    @@BORC           *1
     C           @@BORC    MULT @@TCSA    @@EINT           *1
     C           @@BORC    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((Rb-Ra)*(Tc-Ta))/(Tb-Ta)) + Ra.
     C           @@EINT    DIV  @@TBSA    @@DINT           *1
     C           @@EDEC    DIV  @@TBSA    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C           @@DLM2    ADD  @@BORA    @@BORC    H      *1
     C*
     C**  Calculate Lend rate.
     C**  Calculate (Rb-Ra)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@LERB    SUB  @@LERA    @@LERC           *1
     C           @@LERC    MULT @@TCSA    @@EINT           *1
     C           @@LERC    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((Rb-Ra)*(Tc-Ta))/(Tb-Ta)) + Ra.
     C           @@EINT    DIV  @@TBSA    @@DINT           *1
     C           @@EDEC    DIV  @@TBSA    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C           @@DLM2    ADD  @@LERA    @@LERC    H      *1
     C*
     C**  The interpolation method is weighted.
     C                     ELSE                            X1
     C*
     C**  Calculate     (Tb-Ta)*Tc
     C           @@TBSA    MULT @@DYTC    @@COEF           *1
     C*
     C**  Calculate Borrow rate.
     C*
     C**  Calculate (RbTb-RaTa)
     C           @@BORA    MULT @@DYTA    @@RATA           *1
     C           @@BORB    MULT @@DYTB    @@RBTB           *1
     C           @@RBTB    SUB  @@RATA    @@ELM1           *1
     C*
     C**  Calculate (RbTb-RaTa)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@ELM1    MULT @@TCSA    @@EINT           *1
     C           @@ELM1    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((RbTb-RaTa)*(Tc-Ta))/((Tb-Ta)*Tc)
     C           @@EINT    DIV  @@COEF    @@DINT           *1
     C           @@EDEC    DIV  @@COEF    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C*
     C**  Calculate RaTa/Tc and add to the figure just calculated
     C**  to obtain the rate.
     C           @@RATA    DIV  @@DYTC    @@DLM1           *1
     C           @@DLM1    ADD  @@DLM2    @@BORC    H      *1
     C*
     C**  Calculate Lend rate.
     C*
     C**  Calculate (RbTb-RaTa)
     C           @@LERA    MULT @@DYTA    @@RATA           *1
     C           @@LERB    MULT @@DYTB    @@RBTB           *1
     C           @@RBTB    SUB  @@RATA    @@ELM1           *1
     C*
     C**  Calculate (RbTb-RaTa)*(Tc-Ta) - results placed in integer
     C**  and decimal fields to allow enough decimal places to maintain
     C**  accuracy and enough integers to prevent truncation.  The
     C**  fields are subsequently recombined into a field of the
     C**  correct size.
     C           @@ELM1    MULT @@TCSA    @@EINT           *1
     C           @@ELM1    MULT @@TCSA    @@EDEC           *1
     C*
     C**  Calculate ((RbTb-RaTa)*(Tc-Ta))/((Tb-Ta)*Tc)
     C           @@EINT    DIV  @@COEF    @@DINT           *1
     C           @@EDEC    DIV  @@COEF    @@DDEC           *1
     C           @@DDEC    ADD  @@DINT    @@DLM2           *1
     C*
     C**  Calculate RaTa/Tc and add to the figure just calculated
     C**  to obtain the rate.
     C           @@RATA    DIV  @@DYTC    @@DLM1           *1
     C           @@DLM1    ADD  @@DLM2    @@LERC    H      *1
     C*
     C                     END                             E1
     C*
     C           M10029    ENDSR                           **M10029**
     C/EJECT
     C*****************************************************************   S01166
     C****                                                            *   S01166
     C****ZA1030 - FORMAT AN INTEREST RATE FOR DOWNLOAD               *   S01166
     C****                                                            *   S01166
     C***CALLED BY :    #B,#BA.                                       *   S01166
     C****                                                            *   S01166
     C***CALLS :                                                      *   S01166
     C****                                                            *   S01166
     C***FIELDS USED  @@RATA - ALPHAMERIC INPUT RATE                  *   S01166
     C****            @@RATI - NUMERIC INPUT INTEREST RATE            *   S01166
     C****            @@RATO - FORMATTED INTEREST RATE FOR DOWNLOAD   *   S01166
     C****                                                            *   S01166
     C*****************************************************************   S01166
     C****       ZA1030    BEGSR                                          S01166
     C****                                                                S01166
     C***SET SIGN IN LAST CHAR OF O/P RATE - EITHER +/-                   S01166
     C***IF INPUT RATE IS GREATER THAN OR EQUAL TO 0 PVE ELSE NVE         S01166
     C****       @@RATI    IFGE 0                          B1             S01166
     C****                 MOVE '+'       @@RATO           *1             S01166
     C****                 ELSE                            *1             S01166
     C****                 MOVE '-'       @@RATO           *1             S01166
     C****                 Z-SUB@@RATI    @@RATI           *1             S01166
     C****                 END                             E1             S01166
     C****                                                                S01166
     C** MOVE 11 CHAR RATE TO FIRST 11 CHARS OF OUTPUT RATE               S01166
     C****                 MOVEL@@RATE    @@RATO 12                       S01166
     C****                                                                S01166
     C****       ZA1039    ENDSR                                          S01166
     C/EJECT                                                              S01166
     C*****************************************************************   S01166
     C****                                                            *   S01166
     C****MM1014 - FORMAT AN AMOUNT FOR DOWNLOAD                      *   S01166
     C****                                                            *   S01166
     C***CALLED BY  :   #B.                                           *   S01166
     C****                                                            *   S01166
     C***CALLS :                                                      *   S01166
     C****                                                            *   S01166
     C***FIELDS INPUT @@CDP  - CURRENCY DECIMAL PLACES                *   S01166
     C****            @@AMTI - NUMERIC INPUT AMOUNT                   *   S01166
     C****            @@AMTA - CHARACTER FORMAT INPUT AMOUNT          *   S01166
     C****                                                            *   S01166
     C***FIELD OUTPUT @@AMTO - FORMATTED AMOUNT FOR DOWNLOAD          *   S01166
     C****                                                            *   S01166
     C***WORKFIELDS   @O     - ARRAY FIELD HOLDING FORMATTED AMOUNT   *   S01166
     C****            @@A    - INDEX FIELD FOR REFERENCING @O         *   S01166
     C****                                                            *   S01166
     C*****************************************************************   S01166
     C****       MM1014    BEGSR                                          S01166
     C****                                                                S01166
     C****                 MOVEA*ZEROS    @O,1                            S01166
     C****                                                                S01166
     C***SET SIGN IN LAST CHAR OF O/P AMOUNT - EITHER +/-                 S01166
     C***IF INPUT AMOUNT IS GREATER THAN OR EQUAL TO 0 PVE ELSE NVE       S01166
     C****       @@AMTI    IFGE 0                          B1             S01166
     C****                 MOVE '+'       @O,19            *1             S01166
     C****                 ELSE                            X1             S01166
     C****                 MOVE '-'       @O,19            *1             S01166
     C****                 Z-SUB@@AMTI    @@AMTI           *1             S01166
     C****                 END                             E1             S01166
     C****                                                                S01166
     C***SETUP INDEX FOR REFERENCING @O                                   S01166
     C****       @@CDP     ADD  1         @@A     10                      S01166
     C****                                                                S01166
     C***MOVE INPUT AMOUNT TO RELEVANT POSITION IN OUTPUT ARRAY           S01166
     C****                 MOVEA@@AMTA    @O,@@A                          S01166
     C****                                                                S01166
     C***MOVE FORMATTED AMOUNT TO OUTPUT FIELD                            S01166
     C****                 MOVEA@O,1      @@AMTO 19                       S01166
     C****                 ADD  0         @@CDP   10                      S01166
     C****                                                                S01166
     C****       M10149    ENDSR                                          S01166
     C*****************************************************************   S01166
     C/EJECT                                                              S01166
     C****************************************************************    S01166
     C*                                                              *    S01166
     C*     #ZA EDITS INPUT BEFORE IT IS LOADED INTO DATA STRUCTURE. *    S01166
     C*        CALLED BY  : #Z                                       *    S01166
     C*        CALLS      : ZA0860                                   *    S01166
     C*                                                              *    S01166
     C*        WORK FIELDS: @INPUT - AMOUNT TO BE EDITED             *    S01166
     C*                   : @SCALE - SCALE FACTOR FOR DP / 1000S     *    S01166
     C*                   : @@NUM  - INPUT TO ZA0860                 *    S01166
     C*                   : @@ALPH - OUTPUT FROM ZA0860              *    S01166
     C*                                                              *    S01166
     C****************************************************************    S01166
     C           #ZA       BEGSR                                          S01166
     C*                                                                   S01166
     C*                                                                   S01166
     C           @INPUT    DIV  @SCALE    @@NUM     H                     S01166
     C*                                                                   S01166
     C*                                                                   S01166
     C                     EXSR ZA0860                                    S01166
     C*                                                                   S01166
     C*                                                                   S01166
     C           #ZA9      ENDSR                            ***#ZA9***    S01166
     C*                                                                   S01166
     C*                                                                   S01166
     C/EJECT                                                              S01166
     C*****************************************************************   S01166
     C****************************************************************    S01166
     C*                                                              *    S01166
     C*     ZA0860 -  CONVERT SHORT AMOUNT TO DISPLAY FORMAT         *    S01166
     C*                                                              *    S01166
     C*       CALLS:                                                 *    S01166
     C*                                                              *    S01166
     C*       INPUT: @@NUM  15N    (NUMERIC INPUT AMOUNT)            *    S01166
     C*                                                              *    S01166
     C*      OUTPUT: @@ALPH 16A    (ALPHA OUTPUT AMOUNT)             *    S01166
     C*                                                              *    S01166
     C*        USES: @K     15A  - ARRAY TO HOLD INPUT AMOUNT        *    S01166
     C*              @@I     1N  - INDEX TO @K                       *    S01166
     C*              @@WORK 15A  - ALPHA INPUT AMOUNT                *    S01166
     C*                                                              *    S01166
     C*     AMEND NO. 000001                  DATE   14/07/86        *    S01166
     C*       Amendment to correct output if its value is zero.      *    S01166
     C*                                                              *    S01166
     C****************************************************************    S01166
     C*                                                                   S01166
     C           ZA0860    BEGSR                                          S01166
     C*                                                                   S01166
     C                     Z-ADD@@NUM     @@NUM  150                      S01166
     C*                                                                   S01166
     C**  IF THE NUMBER IS ZERO, PLACE A SINGLE ZERO IN THE LAST PLACE    S01166
     C**  OF THE ARRAY, AND SET THE SIGN TO BLANK.  THEN BY-PASS          S01166
     C**  FURTHER SUBROUTINE PROCESSING.                                  S01166
     C           @@NUM     IFEQ 0                          B1             S01166
     C                     MOVEA*BLANKS   @K               *1             S01166
     C                     MOVE '0'       @K,15            *1             S01166
     C                     GOTO ZA0868                     *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C** SET UP SIGN OF OUTPUT AMOUNT                                     S01166
     C           @@NUM     IFLT 0                          B1             S01166
     C                     MOVE '-'       @K,16            *1             S01166
     C                     Z-SUB@@NUM     @@NUM            *1             S01166
     C                     ELSE                            X1             S01166
     C                     MOVE '+'       @K,16            *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C**  SET UP INPUT AMOUNT ARRAY                                       S01166
     C                     MOVE @@NUM     @@WORK 15                       S01166
     C                     MOVEA@@WORK    @K                              S01166
     C*                                                                   S01166
     C**  BLANK OUT EACH ELEMENT OF @K FROM LEFT TO RIGHT                 S01166
     C**  UNTIL FIRST NON-ZERO ELEMENT OR 15TH ELEMENT                    S01166
     C                     MOVE '0'       *IN90                           S01166
     C                     Z-ADD1         @@I     20                      S01166
     C           *IN90     DOUEQ'1'                        B1             S01166
     C           @@I       OREQ 15                         *1             S01166
     C*                                                    *1             S01166
     C** IF ARRAY ELEMENT ZERO, SET TO BLANKS              *1             S01166
     C           @K,@@I    IFEQ '0'                        B*2            S01166
     C                     MOVE *BLANK    @K,@@I           **2            S01166
     C                     ELSE                            X*2            S01166
     C                     MOVE '1'       *IN90            **2            S01166
     C                     END                             E*2            S01166
     C                     ADD  1         @@I              *1             S01166
     C                     END                             E1             S01166
     C*                                                                   S01166
     C** TAG ZA0868                                                       S01166
     C           ZA0868    TAG                             **ZA0868**     S01166
     C*                                                                   S01166
     C** SET UP OUTPUT AMOUNT                                             S01166
     C                     MOVEA@K        @@ALPH 16                       S01166
     C*                                                                   S01166
     C           ZA0869    ENDSR                           **ZA0869**     S01166
     C*                                                                   S01166
      /EJECT                                                              S01166
     C*****************************************************************   S01166
     C*                                                               *   S01166
     C*       TITLE:BACK OFFICE AMOUNT EDITOR .                       *   S01166
     C*                                                               *   S01166
     C*       SUBROUTINE ZA0920 ACCEPTS AN AMOUNT FIELD (13N) AND     *   S01166
     C*       A FIELD (1N) SPECIFYING NO. OF DECIMALS AND WITH THIS   *   S01166
     C*       CONVERTS THE AMOUNT INTO AN ALPHAMERIC FIELD (14A)      *   S01166
     C*       WITH THE REQUIRED DECIMAL PLACE.                        *   S01166
     C*                                                               *   S01166
     C*                                                               *   S01166
     C* INPUT  :@@AMTW AMOUNT      FORMAT(13N)                     *      S01166
     C*         @@QECN DECIMAL NO. FORMAT(1N)                     *       S01166
     C*                                                               *   S01166
     C* OUTPUT :@@AMTD AMOUNT WITH DECIMAL FORMAT(14A)                *   S01166
     C*                                                               *   S01166
     C* USES :  @@AMTW AMOUNT FIELD PASSED                            *   S01166
     C*         @@QECN NO. OF DECIMAL FIELD                           *   S01166
     C*         @@QECW POSITION ON ARRAY @Z  FOR A DECIMAL POINT     *    S01166
     C*         @@SIG  POSITION ON ARRAY THAT CANNOT BE BLANK         *   S01166
     C*         @@Z    INDEX FOR ARRAY @Z                             *   S01166
     C*         @@Q    INDEX FOR ARRAY @Y                             *   S01166
     C*         @@SWT  SWITCH SAYING ZERO HAS BEEN SUPPRESSED         *   S01166
     C*         @@SWT1 SWITCH SAYING ZERO SUPPRESSION OVER            *   S01166
     C*                                                               *   S01166
     C* ARRAYS:  @Z ARRAY USED FOR DECIMAL ALIGNMENT                  *   S01166
     C*          @Y ARRAY USED FOR STORING AMOUNT PASSED TO THE SR    *   S01166
     C*                                                               *   S01166
     C*****************************************************************   S01166
     C*                                                               *   S01166
     C           ZA0920    BEGSR                                          S01166
     C*                                                                   S01166
     C* INITIALIZATION                                                    S01166
     C                     MOVE '0'       @@SWT1  1                       S01166
     C*                                                                   S01166
     C* FINDING WHERE DECIMAL POSITION IS                                 S01166
     C*                                                                   S01166
     C           14        SUB  @@QECN    @@QECW  20                      S01166
     C*                                                                   S01166
     C* FINDING OUT MOST SIGNIFICANT POSITION                             S01166
     C*                                                                   S01166
     C           @@QECW    SUB  1         @@SIG   20                      S01166
     C                     MOVEA*BLANKS   @Z                              S01166
     C                     Z-ADD1         @@Q     20                      S01166
     C*                                                                   S01166
     C* CHECK TO SEE IF NO.OF DECIMAL PLACES IS ZERO. IF ZERO             S01166
     C* THEN SIGNIFICANT POSITION IS 14 AND POSITION 1 IS BLANK           S01166
     C           @@QECW    IFEQ 14                                        S01166
     C                     Z-ADD14        @@SIG                           S01166
     C                     Z-ADD2         @@Z     20                      S01166
     C                     ELSE                                           S01166
     C                     Z-ADD1         @@Z     20                      S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C* PERFORMING ACTUAL MOVEMENT                                        S01166
     C           @@Z       DOWLT15                                        S01166
     C           @@Q       ANDLT14                                        S01166
     C*                                                                   S01166
     C* SWITCH FOR ZERO SUPPRESSION                                       S01166
     C                     MOVE '0'       @@SWT                           S01166
     C*                                                                   S01166
     C* IF ELEMENT OF ARRAY @Q  IS ZERO AND INDEX @@Z FOR ARRAY @Z        S01166
     C* IS *LT SIG.POSITION AND ALSO *LT DECIMAL POSITION THEN ZERO       S01166
     C* CAN BE SUPPRESSED AND ZERO SUPPRESSION SWITCH IS SETON            S01166
     C*                                                                   S01166
     C           @Y,@@Q    IFEQ 0                                         S01166
     C           @@SWT1    ANDEQ'0'                                       S01166
     C           @@Z       ANDLT@@SIG                                     S01166
     C           @@Z       ANDLT@@QECW                                    S01166
     C                     MOVE *BLANK    @Z,@@Z                          S01166
     C                     MOVE '1'       @@SWT   1                       S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C* IF INDEX @@Z FOR ARRAY @Z IS EQUAL TO THE DECIMAL POSITION        S01166
     C* AND NOT EQUAL TO THE LENGTH OF THE ARRAY @Z(14) THEN MOVE         S01166
     C* DECIMAL POSITION AND INCREMENT @@Z BY 1                           S01166
     C*                                                                   S01166
     C           @@Z       IFEQ @@QECW                                    S01166
     C           @@Z       ANDNE14                                        S01166
     C                     MOVE '.'       @Z,@@Z                          S01166
     C                     ADD  1         @@Z                             S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C* IF ZERO HAS NOT BEEN SUPPRESSED THEN MOVE ELEMENT FROM ARRAY      S01166
     C* @Q TO @Z.SETON ZERO SUPPRESSION SWITCH OVER(@@SWT1)               S01166
     C           @@SWT     IFEQ '0'                                       S01166
     C                     MOVE @Y,@@Q    @Z,@@Z                          S01166
     C                     MOVE '1'       @@SWT1                          S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C                     ADD  1         @@Q                             S01166
     C                     ADD  1         @@Z                             S01166
     C*                                                                   S01166
     C                     END                                            S01166
      *                                                                   S01166
      * Dummy moves for definition of work fields.                        S01166
     C                     GOTO ZA0929                                    S01166
     C                     MOVE @@QECN    @@QECN  10                      S01166
      *                                                                   S01166
     C           ZA0929    ENDSR                                          S01166
     C/EJECT
     C*******************************************************************
     C*                                                                 *
     C* ZA0680 - THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO       *
     C*          MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)       *
     C*                                                                 *
     C* CALLED BY :  #BA.                                               *
     C*                                                                 *
     C* CALLS :                                                         *
     C*                                                                 *
     C* INPUT  : @@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N) *
     C*                                                                 *
     C* OUTPUT : @@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                   *
     C*                                                                 *
     C* USES :   @@CC   NUMBER OF CENTURIES IN DATE                     *
     C*          @@DAY  DAY NUMBER                                      *
     C*          @@REM  REMAINDER FROM DIVIDE                           *
     C*          @@MTH  MONTH NUMBER                                    *
     C*          @MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN   *
     C*                 MONTH                                           *
     C*          @@WK2  WORK FIELD (2,0)                                *
     C*          @@WK5  WORK FIELD (5,0)                                *
     C*          @@YYYY YEAR (4 CHARACTER)                              *
     C*          @@YY   YEAR (2 CHARACTER)                              *
     C*          @YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN   *
     C*                 A FOUR YEAR PERIOD                              *
     C*                                                                 *
     C*******************************************************************
     C*
     C           ZA0680    BEGSR
     C*
     C**  CLEAR OUT ANY 'OLD' DATA IN FIELD
     C                     Z-ADD0         @@MDNO  50
     C*
     C**   IF DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING
     C           @@YYYY    IFGE 2072                       B1
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)
     C           @@CC      SUB  19        @@WK2   20       *1
     C           @@WK2     MULT 36524     @@MDNO           *1
     C*
     C**  YEAR 2000 IS A LEAP YEAR MUST ALLOW EXTRA DAY
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C           @@YYYY    ADD  28        @@WK2
     C*
     C           @@WK2     DIV  4         @@WK2
     C                     MVR            @@REM   10
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD
     C           @@WK2     MULT 1461      @@WK5   50
     C                     ADD  @@WK5     @@MDNO
     C*
     C**  CHECK REMAINDER AND MONTH NUMBER
     C           @@REM     IFEQ 0                          B1
     C           @@MTH     ANDGT2                          B1
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C**  YEAR NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR
     C           @@REM     IFNE 0                          B1
     C                     ADD  @YD,@@REM @@MDNO           *1
     C                     END                             E1
     C*
     C**  ADD MONTHS THIS YEAR
     C                     ADD  @MD,@@MTH @@MDNO
     C*
     C**  ADD DAYS THIS MONTH
     C                     ADD  @@DAY     @@MDNO
     C*
     C           ZA0689    ENDSR                           **ZA0689 TAG**
     C/EJECT
     C*****************************************************************   S12205
     C**********                                                      *   S12205
     C*       TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   S12205
     C**********                                                      *   S12205
     C*       SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   S12205
     C*       PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   S12205
     C*       THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   S12205
     C*       SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   S12205
     C*       IF '@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   S12205
     C*       '@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   S12205
     C**********                                                      *   S12205
     C* NOTE: FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  S12205
     C**********                                                      *   S12205
     C*       1) @@DAYN   LENGTH 5,0.                                 *   S12205
     C**********                                                      *   S12205
     C*       FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   S12205
     C**********                                                      *   S12205
     C*       1) @@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   S12205
     C*       2) @@RTN    LENGTH 1,0.                                 *   S12205
     C*       3) @@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   S12205
     C*       4) @@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   S12205
     C*       5) @@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   S12205
     C*       6) @@RDAY   LENGTH 5,0.                                 *   S12205
     C*       7) @@LEAP   LENGTH 1,0.                                     S12205
     C**********                                                      *   S12205
     C*       INDICATORS USED ARE:                                    *   S12205
     C**********                                                      *   S12205
     C*       1) 80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   S12205
     C*       2) 81       CHECK FOR LOW ON ARRAY @MD.                 *   S12205
     C**********                                                      *   S12205
     C* INPUT FIELD:       @@DAYN                                     *   S12205
     C**********                                                      *   S12205
     C* OUTPUT FIELD:      @@VDT                                      *   S12205
     C**********                                                      *   S12205
     C* WORK FIELDS:       @@RTN                                      *   S12205
     C**********           @@Z71Y                                     *   S12205
     C**********           @@RDAY                                     *   S12205
     C**********           @@LEAP                                     *   S12205
     C**********           @@I                                        *   S12205
     C**********           @@J                                        *   S12205
     C**********                                                      *   S12205
     C* ARRAYS USED:       @YD COMPILE TIME ARRAY.                    *   S12205
     C**********           @MD COMPILE TIME ARRAY.                    *   S12205
     C**********                                                      *   S12205
     C*****************************************************************   S12205
     C**********                                                          S12205
     C*********  ZA0710    BEGSR                                          S12205
     C**********                                                          S12205
     C*********            SETOF                     8081                 S12205
     C*********            Z-ADD0         @@RTN   10                      S12205
     C*********            Z-ADD0         @@VDT                           S12205
     C*********            Z-ADD1         @@I     20                      S12205
     C*********            Z-ADD1         @@J     20                      S12205
     C*********            Z-ADD1         @@LEAP  10                      S12205
     C**********                                                          S12205
     C*********  @@DAYN    IFLT 1                                         S12205
     C*********            Z-ADD1         @@RTN                           S12205
     C*********            GOTO ZA0719                                    S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* DIVISION TO DETERMINE WETHER LEAP YEAR.                           S12205
     C**********                                                          S12205
     C*********  @@DAYN    DIV  1461      @@Z71Y                          S12205
     C*********            MVR            @@RDAY  50                      S12205
     C**********                                                          S12205
     C* CALCULATING YEAR.                                                 S12205
     C**********                                                          S12205
     C*********  @@Z71Y    MULT 4         @@Z71Y                          S12205
     C*********            ADD  1972      @@Z71Y                          S12205
     C**********                                                          S12205
     C* CHECKING IF YEAR IS GREATER THAN OR EQUAL TO 2100                 S12205
     C**********                                                          S12205
     C*********  @@Z71Y    IFGE 2100                                      S12205
     C*********            ADD  @@SSY2    @@RDAY                          S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* LOKUP ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        S12205
     C* HAVE PASSED.                                                      S12205
     C**********                                                          S12205
     C*********  @@RDAY    LOKUP@YD,@@I                8080               S12205
     C**********                                                          S12205
     C* IF YEAR IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     S12205
     C**********                                                          S12205
     C*********  *IN80     IFEQ '0'                                       S12205
     C*********            Z-ADD0         @@LEAP                          S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* ADD INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       S12205
     C**********                                                          S12205
     C*********  @@LEAP    IFEQ 1                                         S12205
     C*********  @@RDAY    SUB  @YD,@@I   @@RDAY                          S12205
     C*********            ADD  @@I       @@Z71Y                          S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* PROCESSING FOR A LEAP YEAR.                                       S12205
     C**********                                                          S12205
     C*********  @@LEAP    IFEQ 0                                         S12205
     C**********                                                          S12205
     C* IF '@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   S12205
     C**********                                                          S12205
     C*********  @@RDAY    IFEQ 60                                        S12205
     C*********            Z-ADD29        @@Z71D                          S12205
     C*********            Z-ADD2         @@Z71M                          S12205
     C*********            GOTO ZA0711                                    S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* IF '@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    S12205
     C* PROCEED AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     S12205
     C* YEAR. NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          S12205
     C**********                                                          S12205
     C*********  @@RDAY    IFGT 60                                        S12205
     C*********  @@RDAY    SUB  1         @@RDAY                          S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* IF DAY '@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      S12205
     C* IN 4 YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      S12205
     C* GROUP.                                                            S12205
     C**********                                                          S12205
     C*********  @@RDAY    IFEQ 0                                         S12205
     C*********            Z-ADD31        @@Z71D                          S12205
     C*********            Z-ADD12        @@Z71M                          S12205
     C*********            SUB  1         @@Z71Y                          S12205
     C*********            GOTO ZA0711                                    S12205
     C*********            END                                            S12205
     C**********                                                          S12205
     C* LOOK UP ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         S12205
     C* OCCURS IN                                                         S12205
     C**********                                                          S12205
     C*********  @@RDAY    LOKUP@MD,@@J                81                 S12205
     C*********            Z-ADD@@J       @@Z71M                          S12205
     C*********  @@RDAY    SUB  @MD,@@J   @@Z71D                          S12205
     C**********                                                          S12205
     C* DS @@VDT  IS RETURNED IN YYYYMMDD FORMAT                          S12205
     C**********                                                          S12205
     C*********  ZA0711    TAG                                            S12205
     C**********                                                          S12205
     C*********            MOVE @@Z71Y    @@YR                            S12205
     C**********                                                          S12205
     C*********  ZA0719    ENDSR                                          S12205
     C*****************************************************************   S12205
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MM1022 - Subroutine to calculate the average interest rate.   *
     C*           Accurate to 7 decimal places.                       *
     C*                                                               *
     C* CALLED BY :  #B.                                              *
     C*                                                               *
     C* CALLS :                                                       *
     C*                                                               *
     C* INPUT  : @@NINT - Net interest amount.                        *
     C*          @@NBAL - Net balance.                                *
     C*          @@DAYY - No. of days in year.                        *
     C*          @@DAYP - No. of days in period.                      *
     C*                                                               *
     C* OUTPUT : @@AVRT - Average interest rate.                      *
     C*          @@RTNC - Error return code.                          *
     C*                                                               *
     C* USES :   @@159A - Work field. (15,9)                          *
     C*          @@159B - Work field. (15,9)                          *
     C*          @@099A - Work field. ( 9,9)                          *
     C*          @@087A - Work field. ( 8,7)                          *
     C*          @@150A - Work field. (15,0)                          *
     C*          @@099B - Work field. ( 9,9)                          *
     C*          @@150B - Work field. (15,0)                          *
     C*          @@099C - Work field. ( 9,9)                          *
     C*          @@09RD - Work field. (15,9)                          *
     C*          @@06RD - Work field. (15,6)                          *
     C*          @@DY00 - Days in year * 100                          *
     C*                                                               *
     C* NOTE:    If the return code has been set to 'Y', this means   *
     C*          the calculated rate is too large for the rate field. *
     C*          The rate output to the dealer should be set up to    *
     C*          hold all '*' in the calling program.                 *
     C*                                                               *
     C*****************************************************************
     C           MM1022    BEGSR
     C*
     C**  Define fields used.
     C                     Z-ADD@@NINT    @@NINT 150
     C                     Z-ADD@@NBAL    @@NBAL 150
     C                     Z-ADD@@DAYY    @@DAYY  50
     C                     Z-ADD@@DAYP    @@DAYP  50
     C                     Z-ADD*ZEROS    @@AVRT 117
     C                     MOVE 'N'       @@RTNC  1
     C*
     C                     Z-ADD*ZEROS    @@159A 159
     C                     Z-ADD*ZEROS    @@159B 159
     C                     Z-ADD*ZEROS    @@099A  99
     C                     Z-ADD*ZEROS    @@087A  87
     C                     Z-ADD*ZEROS    @@150A 150
     C                     Z-ADD*ZEROS    @@099B  99
     C                     Z-ADD*ZEROS    @@150B 150
     C                     Z-ADD*ZEROS    @@099C  99
     C                     Z-ADD*ZEROS    @@DY00  50
     C*
     C**  The average rate is calculated according to the following
     C**  equation.
     C**
     C**
     C**                   @@NINT   @@DAYY
     C**    Average Rate = ------ * ------ * 100
     C**                   @@NBAL   @@DAYP
     C**
     C**
     C*
     C*   ------------------------------------------------------------
     C**  Carry out main calculation.
     C*   ------------------------------------------------------------
     C*
     C**  Divide the net interest by the net balance.
     C           @@NINT    DIV  @@NBAL    @@159A
     C*
     C**  Check that no truncation has occurred.
     C           @@NINT    DIV  @@NBAL    @@150A
     C*
     C**  If the field @@150A (15,0) is greater than 999999, the
     C**  field has been truncated.  Set the return code to 'Y' and
     C**  by-pass further processing.
     C           @@150A    IFGT 999999                     B1
     C                     MOVE 'Y'       @@RTNC           *1
     C                     GOTO M10229                     *1
     C                     END                             E1
     C*
     C**  Multiply @@159A by the no. of days in the year, and by 100,
     C**  splitting the result into integers and decimals.
     C*
     C**  Remove multiply by 100 b'cos two extra decimal places
     C**  included in the interest figure
     C*
     C           @@DAYY    MULT 100       @@DY00
     C           @@159A    MULT @@DY00    @@150A
     C           @@159A    MULT @@DY00    @@099B
     C*
     C*   ------------------------------------------------------------
     C**  Calculate an adjustment figure to maintain accuracy to 7
     C**  decimal places.  Find the average rate.
     C*   ------------------------------------------------------------
     C*
     C**  Divide the net balance field by 1,000,000,000.
     C           @@NBAL    DIV  1000000000@@159B
     C*
     C**  Divide the net interest field by @@159B, to obtain the
     C**  decimal places after those stored in @@159A.(Decs. 10-18)
     C           @@NINT    DIV  @@159B    @@099A
     C*
     C**  Multiply @@099A by the no. of days in the year, and divide
     C**  by 10,000,000 in order to return the number to the same
     C**  magnitude as the original figures.
     C           @@099A    MULT @@DAYY    @@159B
     C           @@159B    DIV  10000000  @@099A
     C*
     C**  Total up all the figures to obtain the Average Rate -
     C**   integers in one field, decimals in another.
     C           @@099A    ADD  @@099B    @@150B
     C           @@099A    ADD  @@099B    @@099C
     C                     ADD  @@150A    @@150B
     C*
     C**  Divide @@150B, @@099C by the no. of days in the period.
     C           @@150B    DIV  @@DAYP    @@159A
     C                     DIV  @@DAYP    @@099C
     C*
     C**  Total up the integers and decimals into the rate field.
     C           @@159A    ADD  @@099C    @@09RD 159
     C                     Z-ADD@@09RD    @@AVRT
     C*
     C*   ------------------------------------------------------------
     C**  Check for leading figure truncation in rate.
     C*   ------------------------------------------------------------
     C*
     C**  Find the calculated integers value, taking into account any
     C**  half adjusting carried out on the decimals.
     C                     DIV  @@DAYP    @@150B
     C           @@150B    DIV  @@DAYP    @@099B
     C           @@099B    ADD  @@099C    @@087A    H
     C                     ADD  @@087A    @@150B
     C*
     C**  If the integers field is > than 9999, set the error indicator
     C**  to 'Y'.  By-pass further processing.
     C           @@150B    IFGT 9999                       B1
     C                     MOVE 'Y'       @@RTNC           *1
     C                     Z-ADD*ZEROS    @@AVRT           *1
     C                     GOTO M10229                     *1
     C                     END                             E1
     C*
     C**  Take the modulus of the Average Rate.
     C           @@AVRT    IFLT *ZERO                      B1
     C                     Z-SUB@@AVRT    @@AVRT           *1
     C                     END                             E1
     C*
     C** Reduce rate by a factor of 100 to allow for extra d.p. on int.
     C           @@AVRT    DIV  100       @@06RD 156H
     C                     Z-ADD@@06RD    @@AVRT
     C*
     C           M10229    ENDSR                           **M10229**
     C/EJECT
     C********************************************************************S01195
     C**********                                                          S01195
     C**ZA0830*- THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DAY       S01195
     C********** IS A HOLIDAY IN A PARTICULAR CURRENCY                    S01195
     C**********                                                          S01195
     C**CALLED*BY :    #BA.                                               S01195
     C**********                                                          S01195
     C**CALLS*:*                                                          S01195
     C**********                                                          S01195
     C**INPUT**: @@MNO  MIDAS DAY NUMBER 5N                               S01195
     C********** @@CCY  CURRENCY CODE 3A                                  S01195
     C**********                                                          S01195
     C**OUTPUT*: @@HIND HOLIDAY/WORKING DAY INDICATOR 1A                  S01195
     C**********                                                          S01195
     C**USES*:** @@MNO  MIDAS DAY NUMBER                                  S01195
     C********** @@CCY  CURRENCY CODE                                     S01195
     C********** @@ONCE FIRST TIME THROUGH INDICATOR                      S01195
     C********** @@CY1  FIRST HALF OF CURRENCY ARRAY                      S01195
     C********** @@CY2  SECOND HALF OF CURRENCY ARRAY                     S01195
     C********** @@MNO6 MIDAS NUMBER WITH TRAILING BLANK                  S01195
     C********** @@HIND HOLIDAY/WORKING DAY INDICATOR                     S01195
     C********** @@INEX INCLUDE/EXCLUDE INDICATOR                         S01195
     C**********                                                          S01195
     C********** INDICATORS                                               S01195
     C********** 80 RECORD NOT FOUND                                      S01195
     C********** 81 CURRENCY NOT FOUND ON RECORD                          S01195
     C**********                                                          S01195
     C********************************************************************S01195
     C********** ZA0830    BEGSR                                          S01195
     C**********                                                          S01195
     C***OPEN*CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH                 S01195
     C********** @@ONCE    IFNE 'Y'                        B1             S01195
     C**********           OPEN FDTABJLL                   *1             S01195
     C**********           MOVE 'Y'       @@ONCE  1        *1             S01195
     C**********           END                             E1             S01195
     C**********                                                          S01195
     C***BLANK*OUT ARRAY                                                  S01195
     C**********           MOVE *BLANKS   @@CY1                           S01195
     C**********           MOVE *BLANKS   @@CY2                           S01195
     C**********                                                          S01195
     C***ACCESS*TABLE ON FIRST KEY                                        S01195
     C**********           MOVEL@@MNO     @@MNO6  6                       S01195
     C**********           MOVE @@MNO6    @@0830 12                       S01195
     C**********           MOVEL'22    '  @@0830                          S01195
     C**********           MOVE '1'       @@0830                          S01195
     C********** @@0830    CHAINTABLETJF             80                   S01195
     C**********                                                          S01195
     C***IF*RECORD NOT FOUND OR DELETED                                   S01195
     C********** *IN80     IFEQ '1'                        B1             S01195
     C********** RECI      OREQ '*'                        *1             S01195
     C**********           MOVE 'W'       @@HIND           *1             S01195
     C**********           GOTO ZA0839                     *1             S01195
     C**********           END                             E1             S01195
     C**********                                                          S01195
     C***MOVE*FIRST 25 CURRENCIES TO ARRAY                                S01195
     C**********           MOVE HCCY      @@CY1                           S01195
     C**********                                                          S01195
     C***ACCESS*TABLE ON SECOND KEY                                       S01195
     C**********           MOVE '2'       @@0830                          S01195
     C********** @@0830    CHAINTABLETJF             80                   S01195
     C**********                                                          S01195
     C***IF*SECOND RECORD FOUND AND NOT DELETED                           S01195
     C********** *IN80     IFEQ '0'                        B1             S01195
     C********** RECI      ANDNE'*'                        *1             S01195
     C**********           MOVE HCCY      @@CY2            *1             S01195
     C**********           END                             E1             S01195
     C**********                                                          S01195
     C***SEARCH*ARRAY FOR INPUT CURRENCY                                  S01195
     C********** @@CCY     LOKUP@CY                      81               S01195
     C**********                                                          S01195
     C***IF*INPUT CURRENCY IS IN ARRAY                                    S01195
     C********** *IN81     IFEQ '1'                        B1             S01195
     C**********                                                          S01195
     C***IF*INCLUDE/EXCLUDE INDICATOR EQ 'E'                              S01195
     C********** INEX      IFEQ 'E'                        B*2            S01195
     C**********           MOVE 'W'       @@HIND  1        **2            S01195
     C**********           ELSE                            X*2            S01195
     C**********           MOVE 'H'       @@HIND           **2            S01195
     C**********           END                             E*2            S01195
     C**********           END                             E1             S01195
     C**********                                                          S01195
     C***IF*INPUT CURRENCY IS NOT IN ARRAY                                S01195
     C********** *IN81     IFEQ '0'                        B1             S01195
     C**********                                                          S01195
     C***IF*INCLUDE/EXCLUDE INDICATOR EQ 'I'                              S01195
     C********** INEX      IFEQ 'I'                        B*2            S01195
     C**********           MOVE 'W'       @@HIND           **2            S01195
     C**********           ELSE                            X*2            S01195
     C**********           MOVE 'H'       @@HIND           **2            S01195
     C**********           END                             E*2            S01195
     C**********           END                             E1             S01195
     C********** ZA0839    ENDSR                                          S01195
     C/COPY ZSRSRC,ZFWDT                                                  S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
     C****************************************************************
     C*                                                              *
     C*     #A CARRIES OUT INITIALISATION PROCESSING.                *
     C*                                                              *
     C*        CALLED BY   : MAIN PROGRAM                            *
     C*                                                              *
     C*********CALLS*******:*ZA0150.**********************************    S01194
     C*                                                              *
     C*        WORK FIELDS : @FIRST -  First run flag.               *
     C*                    : @BR    -  Borrow rate array.            *
     C*                    : @LR    -  Lend rate array.              *
     C*                    : @MR    -  Numeric market rate array.    *
     C*                                                              *
     C****************************************************************
     C           #A        BEGSR
     C*
     C**  RECEIVE INPUT PARAMETERS
     C****       *ENTRY    PLIST                                          S01166
     C****                 PARM           @TERM   1                       S01166
     C****                 PARM           @ENQ    1                       S01166
     C**  set on subfile end indicator                                    S01166
     C                     MOVE '1'       *IN20                           S01166
     C**  initialise screen message queue                                 S01166
     C                     MOVEL'*'       DDPGMQ                          S01166
     C**  Move workstation id into screen field                           S01166
     C                     MOVEL@JOB      DDWSID                          S01166
     C*                                                                   S01166
     C**  Move program name into status data structure field.             S01166
     C**********           MOVEL'DL3220'  DBPGM                    S01166 S01117
     C                     MOVEL'TM3220'  DBPGM                           S01117
     C*
     C***Data area name.                                                  S01166
     C****       *NAMVAR   DEFN AMENQ1AA  AMENQ1                          S01166
     C*
     C**  Check if this is the first run of the program.
     C           @FIRST    IFEQ *BLANK                     B1
     C                     MOVE 'N'       @FIRST  1        *1
     C*
     C**  If it is the first run open all files...
     C**********           OPEN FDICDRLL                   *1             S01194
     C*********************OPEN CA38CPLL                   *1             S01166
     C**********           OPEN FDCCYTLL                   *1             S01194
     C                     OPEN MMFNRDLL                   *1
     C                     OPEN FDINTDLL                   *1
     C*******************  OPEN FDINTRLL                   *1             E12205
     C**********           OPEN MMFWDTLL                   *1             E20003
     C*********************OPEN*FDUSSILL********************1*******SO1166S01319
     C                     OPEN MUSER                                     S01319
     C*********************OPEN*FDINSTLL********************1*******S01166S01319
     C*
     C*******and*access*ICD*file***                                       S01194
     C**********           EXSR ZA0150                     *1             S01194
     C**********                                                          S01194
     C****Check*for*database*error***                                     S01194
     C********** *IN80     IFEQ '1'                        B*2            S01194
     C**********           MOVE '1'       *INU7            **2         2* S01194
     C**********           MOVE '1'       *INU8            **2          * S01194
     C****                 MOVE 'E'       @TERM            **2         ** S01166
     C**********           MOVE '1'       *IN01            **2     S01166 S01194
     C**********           GOTO #A9                        **2            S01194
     C**********           END                             E*2            S01194
      *                                                                   S01194
      * Get Bank's details from SDBANKPD via Access Object                S01194
      * (Note that *DBERR is used as standard return code although        S01194
      * this will not normally produce a DB error due to access           S01194
      * object having already been called in SD1600)                      S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C**************************************************************S01166S01319
     C*********************MOVEL@USER*****@USER3**3*****************S01166S01319
     C**************************************************************S01166S01319
     C***********@USER3****CHAINFDUSSIP0*************61*************S01166S01319
     C**DATABASE*ERROR*IF*USER*NOT*FOUND****************************S01166S01319
     C**************************************************************S01166S01319
     C************IN61*****IFEQ*'1'*********************************S01166S01319
     C*********************MOVE*'FDUSSIP0'DBFILE********************S01166S01319
     C*********************MOVE*'009'*****DBASE************DB*ERR*00S01166S01319
     C*********************MOVEL@USER3****DBKEY*********************S01166S01319
     C*********************MOVE*'FDUSSILL'@FILE*********************S01166S01319
     C*********************EXSR*INFSR*******************************S01166S01319
     C*********************END**************************************S01166S01319
     C           @USER     CHAINMUSER                61                   S01319
     C*                                                                   S01319
     C           *IN61     IFEQ '1'                        B1             S01319
     C*                                                                   S01319
     C                     MOVEL'MUSER'   DBFILE           ***************S01319
     C                     MOVE '009'     DBASE            *             *S01319
     C                     MOVEL@USER     DBKEY            * DBERROR 009 *S01319
     C                     EXSR INFSR                      ***************S01319
     C*                                                                   S01319
     C                     END                             E1             S01319
     C*                                                                   S01166
     C***********USREF*****IFEQ*'Y'                                 S01166S01319
     C           AURF      IFEQ 'Y'                                       S01319
     C                     MOVEL@OVR,1    @OVRID                          S01166
     C*********************Z-ADDUSRFPD****@WAIT*********************S01166S01319
     C                     Z-ADDREFP      @WAIT                           S01319
     C                     Z-ADD36        QCALEN 155                      S01166
     C*********************CALL 'QCAEXEC'                           S01166E20774
     C                     CALL 'QCMDEXC'                                 E20774
     C                     PARM           @OVRID                          S01166
     C                     PARM           QCALEN                          S01166
     C                     END                                            S01166
     C*                                                                   S01166
     C**********           OPEN DL3220DD                           S01166 S01194
     C                     OPEN TM3220DD                                  S01194
     C*                                                                   S01166
     C*                                                                   S01166
     C**ACCESS*INSTALLATION*CONTROL*FOR*BASE*CURRENCY*IDCYDL*********S0116601319
     C***********IDRCID****IFEQ**BLANKS*****************************S01166S01319
     C***********1*********CHAINFDINSTLL*************61*************S01166S01319
     C**DATABASE*ERROR*IF*USER*NOT*FOUND****************************S01166S01319
     C************IN61*****IFEQ*'1'*********************************S01166S01319
     C*********************MOVE*'FDINSTLL'DBFILE********************S01166S01319
     C*********************MOVE*'010'*****DBASE************DB*ERR*01S01166S01319
     C*********************MOVEL'1'*******DBKEY*********************S01166S01319
     C*********************MOVE*'FDINSTLL'@FILE*********************S01166S01319
     C*********************EXSR*INFSR*******************************S01166S01319
     C*********************END**************************************S01166S01319
     C**************************************************************S01166S01319
     C*********************END**************************************S01166S01319
     C*                                                                   S01319
     C** Access Deal details via access program                           S01319
      *  (database error handling done in access program)                 S01319
     C**********           CALL 'AODEALR0'                                             S01319 CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01319
     C                     PARM '*FIRST ' @OPTN   7                       S01319
     C********** SDDEAL    PARM SDDEAL    DSFDY                                        S01319 CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
     C*                                                                   S01166
     C**  If this is not the first cycle initialise arrays.
     C                     ELSE                            X1
     C                     Z-ADD*ZEROS    @BR              *1
     C                     Z-ADD*ZEROS    @LR              *1
     C                     Z-ADD*ZEROS    @MR              *1
     C                     END                             E1
     C*
     C           #A9       ENDSR                           ***#A9***
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*     #C CARRIES OUT THE TERMINATION PROCESSING.               *
     C*                                                              *
     C*        CALLED BY   : MAIN PROGRAM                            *
     C*                                                              *
     C*        CALLS       :                                         *
     C*                                                              *
     C*        WORK FIELDS : @TERM  -  Termination flag.             *
     C*                                                              *
     C****************************************************************
     C           #C        BEGSR
     C*
     C****       @TERM     IFEQ 'T'                        B1             S01166
     C****       @TERM     OREQ 'E'                        *1             S01166
     C                     MOVE '1'       *INLR            *1
     C****                 ELSE                            X1             S01166
     C****                 RETRN                           *1             S01166
     C****                 END                             E1             S01166
     C*                                                                   S01166
     C           #C9       ENDSR                           ***#C9***      S01166
     C/EJECT
     C*****************************************************************   S01194
     C**********                                                      *   S01194
     C***SUBROUTINE ZA0150 - THIS SUBROUTINE CHAINS TO FILE LF/       *   S01194
     C***FDICDRLL TO GET THE INSTALLATION CONTROL DETAILS RECORD 1    *   S01194
     C***(HELD*ON PF/TABTB10)                                         *   S01194
     C***INDICATOR 80 IS SET ON IF THE CHAIN FAILS OR THE RECORD IS   *   S01194
     C***FLAGGED FOR DELETION.                                        *   S01194
     C***IF*INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED ACCESS    *   S01194
     C***ARE*PLACED IN THE LDA.                                       *   S01194
     C**********                                                      *   S01194
     C***FIELDS*USED : SS0150 - KEY USED TO ACCESS FDICDRLL           *   S01194
     C**********                                                      *   S01194
     C*****************************************************************   S01194
     C**********                                                          S01194
     C********** ZA0150    BEGSR                                          S01194
     C**********                                                          S01194
     C***Set*up*key to obtain format TABTB10F '01        10'              S01194
     C**********           MOVEL'01'      SS0150 12                       S01194
     C**********           MOVE '10'      SS0150                          S01194
     C**********                                                          S01194
     C***CHAIN*TO FILE FDICDRLL                                           S01194
     C********** SS0150    CHAINFDICDRLL             80                   S01194
     C********** RECI      IFNE 'D'                        B1             S01194
     C**********           MOVE '1'       *IN80            *1             S01194
     C**********           END                             E1             S01194
     C**********                                                          S01194
     C***DEAL*WITH DATA BASE ERROR                                        S01194
     C********** *IN80     IFEQ '1'                        ***************S01194
     C**********           MOVEL'FDICDRLL'DBFILE           *             *S01194
     C**********           MOVEL'900'     DBASE            * DBERROR 900 *S01194
     C**********           MOVELSS0150    DBKEY            *             *S01194
     C**********           END                             ***************S01194
     C**********                                                          S01194
     C********** ZA0159    ENDSR                                          S01194
     C/EJECT
     C*****************************************************
     C*                                                   *
     C*   EXCEPTION ERROR SUBROUTINE                      *
     C*                                                   *
     C*   SUBROUTINE CALLED: EXECUTES WHENEVER            *
     C*   A FILE ERROR OCCURS                             *
     C*                                                   *
     C*   SUBROUTINE CALLS : NO OTHER SUBROUTINES         *
     C*                                                   *
     C*****************************************************
     C           INFSR     BEGSR
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C****                 MOVE 'E'       @TERM                           S01166
     C*
     C**  SET UP FIELDS IN LOCAL DATA AREA
     C**********           MOVEL'DL3220'  DBPGM                    S01166 S01117
     C                     MOVEL'TM3220'  DBPGM                           S01117
     C                     MOVE '992'     DBASE
     C                     MOVE @FILE     DBFILE
     C*
     C                     DUMP
     C*
     C**  TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           ***INFSR***
     C/EJECT
     C*****************************************************
     C*                                                   *
     C*   EXCEPTION ERROR SUBROUTINE                      *
     C*                                                   *
     C*   SUBROUTINE CALLED: EXECUTES WHENEVER            *
     C*   A PROGRAM ERROR OCCURS                          *
     C*                                                   *
     C*   SUBROUTINE CALLS : NO OTHER SUBROUTINES         *
     C*                                                   *
     C*****************************************************
     C           *PSSR     BEGSR
     C*
     C**  SET @ERR1 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR1     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
     C                     MOVE '1'       *IN01            *1             S01166
     C*
     C**  SET UP FIELDS IN LOCAL DATA AREA
     C**********           MOVEL'DL3220'  DBPGM            *1      S01166 S01117
     C                     MOVEL'TM3220'  DBPGM            *1             S01117
     C                     MOVE '991'     DBASE            *1
     C*
     C                     DUMP                            *1
     C                     END                             E1
     C*
     C**  TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           ****PSSR****
** @YD  USED BY SR. ZA0680 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZA0680 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** @OVR                                                                   S01166
OVRDSPF FILE(TM3220DD) WAITRCD(    )                                      S01117
**  @PWR - ARRAY OF POWERS OF 10
0000000010
0000000100
0000001000
0000010000
0000100000
0001000000
0010000000
0100000000
1000000000
** CPY@ - COPYRIGHT STATEMENT                                             S01117
(c) Misys International Banking Systems Ltd. 2001
