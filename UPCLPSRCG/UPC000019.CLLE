/*********************************************************************/
/*XBI    OVRDBF FILE(UPC000019F) TOFILE(UPFDBATPD)                   */                   /*CUP034*/
/*STD    CLPBASEBND                                                  */
/*EXI    DBGVIEW(*LIST)                                              */
/*EXI *  TEXT('Midas UP Work out priorities for SQL views')          */
/*********************************************************************/
/*                                                                   */
/*       Midas - Upgrade Module                                      */
/*                                                                   */
/*       UPC000019 - Work out priorities for SQL views               */
/*                                                                   */
/*       (c) Misys International Banking Systems Ltd. 2004           */
/*                                                                   */
/* Bank Fusion Midas 1.4 Base ---------------------------------------*/
/* Midas Plus 1.4 Base 04 -------------------------------------------*/
/*       Last Amend No. CSM010             Date 22Jun07              */
/*       Prev Amend No. CPK027             Date 21May07              */
/*                      CUP034             Date 28Feb07              */
/* Midas Plus 1.4 Base ----------------------------------------------*/
/* Midas Plus 1.3 ---------------- Base -----------------------------*/
/*                      CPK021  *CREATE    Date 22Sep04              */
/*                                                                   */
/*********************************************************************/
/*                                                                   */
/*       CSM010 - Applied by CPK027.                                 */
/*       CPK027 - Message file spelt incorrectly.                    */
/*       CUP034 - Not all views are now named V_* so we have to cope */
/*                with all possibilities.                            */
/*       CPK021 - New utility to work out priorities for SQL views.  */
/*                                                                   */
/*********************************************************************/
             PGM        PARM(&LIBRARY)
 
             DCL        VAR(&LIBRARY) TYPE(*CHAR) LEN(10)
 
             DCL        VAR(&LAYER) TYPE(*CHAR) LEN(7)
             DCL        VAR(&MESSAGE) TYPE(*CHAR) LEN(50)
 
             DCLF       FILE(UPC000019F)                                                  /*CUP034*/
 
             COPYRIGHT TEXT('(c) Misys International Banking Systems Ltd. +
                          2004')
 
/* Global monitor message */
             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO +
                          CMDLBL(ERROR))
 
/**********  CHGJOB     LOG(4 0 *SECLVL) LOGCLPGM(*YES)                                */ /*CUP034*/
/**********  CHGJOB     SWS(XXXXXX00)                                                  */ /*CUP034*/
 
/**Create*data*area**MIDASMSG*in*QTEMP**/ /*                                           */ /*CUP034*/
/**********  DLTDTAARA  DTAARA(QTEMP/MIDASMSG)                                         */ /*CUP034*/
/**********  MONMSG     MSGID(CPF0000)                                                 */ /*CUP034*/
/**********  CRTDTAARA  DTAARA(QTEMP/MIDASMSG) TYPE(*CHAR) LEN(800) +                  */ /*CUP034*/
/**********               VALUE(' ')                                                   */ /*CUP034*/
 
             IF         COND(%SST(&LIBRARY 3 1) *EQ 'G') THEN(DO)
                CHGVAR     VAR(&LAYER) VALUE('*GLOBAL')
             ENDDO
             IF         COND(%SST(&LIBRARY 3 1) *EQ 'D') THEN(DO)
                CHGVAR     VAR(&LAYER) VALUE('*ZONE')
             ENDDO
 
/* Create copy of UPSFMTPD in QTEMP for updating. */
             CPYF       FROMFILE(UPSFMTPD) TOFILE(QTEMP/UPSFMTQT) +
                          MBROPT(*REPLACE) CRTFILE(*YES)
             CLRPFM     FILE(QTEMP/UPSFMTQT)
             CLRPFM     FILE(UPDBR1PD)                                                    /*CUP034*/
 
/* Set up file for outfile of all logicals and create outfile. */                         /*CUP034*/
             DLTF       FILE(QTEMP/UPC000019F)                                            /*CUP034*/
             MONMSG     MSGID(CPF0000)                                                    /*CUP034*/
             DLTF       FILE(QTEMP/UPFDBAT)                                               /*CUP034*/
             MONMSG     MSGID(CPF0000)                                                    /*CUP034*/
             CRTDUPOBJ  OBJ(UPFDBATPD) FROMLIB(*LIBL) OBJTYPE(*FILE) +
                          TOLIB(QTEMP) NEWOBJ(UPC000019F)                                 /*CUP034*/
             DSPFD      FILE(&LIBRARY/*ALL) TYPE(*BASATR) +
                          OUTPUT(*OUTFILE) FILEATR(*LF) +
                          OUTFILE(QTEMP/UPFDBAT)                                          /*CUP034*/
             CPYF       FROMFILE(QTEMP/UPFDBAT) +
                          TOFILE(QTEMP/UPC000019F) MBROPT(*REPLACE) +
                          FMTOPT(*MAP *DROP)                                              /*CUP034*/
 
DSPDBR:                                                                                   /*CUP034*/
             RCVF                                                                         /*CUP034*/
             MONMSG     MSGID(CPF0864) EXEC(DO)                                           /*CUP034*/
                GOTO       CMDLBL(CPYF)                                                   /*CUP034*/
             ENDDO                                                                        /*CUP034*/
 
/* Only take SQL views. */                                                                /*CUP034*/
             IF         COND(&ATSQLT *EQ 'V') THEN(DO)                                    /*CUP034*/
/* Create outfile for SQL views in library. */
/**********  DSPDBR     FILE(&LIBRARY/V_*) OUTPUT(*OUTFILE) +                          */ /*CUP034*/
/**********               OUTFILE(UPDBR1PD)                                            */ /*CUP034*/
/**********  MONMSG     MSGID(CPF3012) EXEC(DO)                                        */ /*CUP034*/
/**********     GOTO       CMDLBL(END)                                                 */ /*CUP034*/
                DSPDBR     FILE(&LIBRARY/&ATFILE) OUTPUT(*OUTFILE) +
                             OUTFILE(UPDBR1PD) OUTMBR(*FIRST *ADD)                        /*CUP034*/
             ENDDO
 
             GOTO       CMDLBL(DSPDBR)                                                    /*CUP034*/
 
CPYF:                                                                                     /*CUP034*/
             CPYF       FROMFILE(UPDBR1PD) TOFILE(UPDBR2PD) +
                          MBROPT(*REPLACE)
 
/* Call program to work out priorities and write out as shared format. */
             CALL       PGM(UP000019) PARM(&LAYER)
             IF         COND(%SWITCH(XXXXXX11)) THEN(DO)
                GOTO       CMDLBL(ERROR)
             ENDDO
 
             GOTO       CMDLBL(END)
 ERROR:
/* Set up messages for Midas Information Screen  */
/**********  RTVMSG     MSGID(UPM0001) MSGF(UTGMSGF) +                                 */ /*CPK027*/
/**********               MSGDTA('UPC000019') MSG(&MESSAGE)                            */ /*CPK027*/
             RTVMSG     MSGID(UPM0001) MSGF(UTMSGF) +
                          MSGDTA('UPC000019') MSG(&MESSAGE)                               /*CPK027*/
             MONMSG     MSGID(CPF0000)
             CHGDTAARA  DTAARA(MIDASMSG (101 50)) VALUE(&MESSAGE)
             MONMSG     MSGID(CPF0000)
             CHGDTAARA  DTAARA(MIDASMSG (201 50)) VALUE('Check +
                          joblog for details')
             MONMSG     MSGID(CPF0000)
             CALL       PGM(SCC0010) PARM('UPC000019' 'JOBLOG' 'Y')
             MONMSG     MSGID(CPF0000 MCH0000)
 
 END:
             ENDPGM
