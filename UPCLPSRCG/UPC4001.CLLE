/*********************************************************************/
/*STD    CLPBASEBND                                                  */
/*EXI    TEXT('Midas UP ADBU Compare Job Submission')                */
/*********************************************************************/
/*                                                                   */
/*       Midas - Upgrade Module                                      */
/*                                                                   */
/*       UPC4001 - ADBU Compare Job Submission                       */
/*                                                                   */
/*       (c) Finastra International Limited 2020                     */
/*                                                                   */
/*       Last Amend No. CUT017 *CREATE     Date 17Mar20              */
/*                                                                   */
/*********************************************************************/
/*                                                                   */
/*       CUT017 - Adapptive Database Upgrade                         */
/*                                                                   */
/*********************************************************************/
             PGM        PARM(&LIB1 &LIB2 &LAYER &BRGBRGLIB)

             DCL        VAR(&LIB1) TYPE(*CHAR) LEN(2)
             DCL        VAR(&LIB2) TYPE(*CHAR) LEN(2)
             DCL        VAR(&LAYER) TYPE(*CHAR) LEN(7)
             DCL        VAR(&PARM1) TYPE(*CHAR) LEN(10)
             DCL        VAR(&PARM2) TYPE(*CHAR) LEN(10)
             DCL        VAR(&BRGBRGLIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&LOGFILE) TYPE(*CHAR) LEN(10)
             DCL        VAR(&ERROR) TYPE(*CHAR) LEN(10)
             DCL        VAR(&RETURN) TYPE(*CHAR) LEN(10)
             DCL        VAR(&STIME) TYPE(*CHAR) LEN(6)
             DCL        VAR(&FLDVAL) TYPE(*CHAR) LEN(100)
             DCL        VAR(&PLIB) TYPE(*CHAR) LEN(10)


/** Global Monitor Message */

             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO CMDLBL(ABNOR))

             CLRPFM     FILE(UPCLOGPD)

             ADDLIBLE   LIB(&BRGBRGLIB) POSITION(*LAST)
             MONMSG     MSGID(CPF2103)

             STRSBS     SBSD(&BRGBRGLIB/&BRGBRGLIB)
             MONMSG     MSGID(CPF1010)

/* If ZONE mode, submit the zone jobs */
             IF         COND(&LAYER *EQ '*ZONE') THEN(DO)

/* Create DTAQ UPZADBCDTQ */
             CHGVAR     VAR(&PLIB) VALUE(&LIB1 *TCAT 'DPLIB')
             DLTDTAQ    DTAQ(&PLIB/UPZADBCDTQ)
             MONMSG     MSGID(CPF2105)
             CRTDTAQ    DTAQ(&PLIB/UPZADBCDTQ) MAXLEN(50) TEXT('UP +
                           Zone Adaptive Database Upgrade DTAQ')

/* Submit server */
             SBMJOB     CMD(CALL PGM(UPC4005) PARM(&LIB1 &LIB2 +
                          &BRGBRGLIB &LAYER)) JOB(UPZADBUSVR) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)

/* Compare DM  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'DM')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'DMLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'DMLIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPZCMPWR ('*UPDATE   ' &LIB1 'UPDMSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare DP  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'DP')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'DPLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'DPLIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPZCMPWR ('*UPDATE   ' &LIB1 'UPDPSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare DTA */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'DT')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'DTALIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'DTALIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPZCMPWR ('*UPDATE   ' &LIB1 'UPDTSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare DV  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'DV')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'DVLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'DVLIB')
             SBMJOB     CMD(CALL PGM(UPC4003) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPZCMPWR ('*UPDATE   ' &LIB1 'UPDVSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

             ENDDO

/* If GLOBAL mode, submit the global jobs */
             IF         COND(&LAYER *EQ '*GLOBAL') THEN(DO)

/* Create DTAQ UPGADBCDTQ */
             CHGVAR     VAR(&PLIB) VALUE(&LIB1 *TCAT 'GPLIB')
             DLTDTAQ    DTAQ(&PLIB/UPGADBCDTQ)
             MONMSG     MSGID(CPF2105)
             CRTDTAQ    DTAQ(&PLIB/UPGADBCDTQ) MAXLEN(50) TEXT('UP +
                           Global Adaptive Database Upgrade DTAQ')

/* Submit server */
             SBMJOB     CMD(CALL PGM(UPC4005) PARM(&LIB1 &LIB2 +
                          &BRGBRGLIB &LAYER)) JOB(UPGADBUSVR) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)

/* Compare GM  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'GM')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'GMLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'GMLIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPGCMPWR ('*UPDATE   ' &LIB1 'UPGMSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare GP  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'GP')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'GPLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'GPLIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPGCMPWR ('*UPDATE   ' &LIB1 'UPGPSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare GTA */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'GT')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'GTALIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'GTALIB')
             SBMJOB     CMD(CALL PGM(UPC4002) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPGCMPWR ('*UPDATE   ' &LIB1 'UPGTSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

/* Compare GV  */
             CHGVAR     VAR(&LOGFILE) VALUE('LOG' *TCAT &LIB1 *TCAT +
                          &LIB2 *TCAT 'GV')
             DLTF       FILE(&BRGBRGLIB/&LOGFILE)
             MONMSG     MSGID(CPF0000)
             CPYF       FROMFILE(UPCLOGPD) TOFILE(&BRGBRGLIB/&LOGFILE) +
                          CRTFILE(*YES)
             CHGVAR     VAR(&PARM1) VALUE(&LIB1 *TCAT 'GVLIB')
             CHGVAR     VAR(&PARM2) VALUE(&LIB2 *TCAT 'GVLIB')
             SBMJOB     CMD(CALL PGM(UPC4003) PARM(&PARM1 &PARM2 +
                          &LOGFILE &LAYER)) JOB(&PARM1) +
                          JOBQ(&BRGBRGLIB/SMJOBQNM)
/* Update Compare Work File */
             RTVSYSVAL  SYSVAL(QTIME) RTNVAR(&STIME)
             CHGVAR     VAR(&FLDVAL) VALUE(&STIME)
             CALL UPGCMPWR ('*UPDATE   ' &LIB1 'UPGVSB' &FLDVAL &ERROR &RETURN)
             IF         COND(&ERROR *NE '          ') THEN(GOTO ABNOR)

             ENDDO


             GOTO       CMDLBL(END)

/* Abnormal termination */

 ABNOR:      CHGJOB     SWS(XXXXXX11)

             SNDPGMMSG  MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('Program UPC4001 ended +
                          abnormally - see job log') TOMSGQ(MOPERQ)
             MONMSG     MSGID(CPF0000 MCH0000)

/* End program */

 END:        ENDPGM
