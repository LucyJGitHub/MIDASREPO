/*********************************************************************/
/*STD    CLPBASE                                                     */
/*EXI    TEXT('CL program for datapatch UTLE0493')                   */
/*********************************************************************/
/*                                                                   */
/*       Midas - Customer Lending Module                             */
/*                                                                   */
/*       UTCLE493 - CL Program of Datapatch program UT000493         */
/*                                                                   */
/*       (c) Misys Banking Systems 2012                              */
/*                                                                   */
/*       Last Amend No. AR316215           Date 01Aug12              */
/*       Prev Amend No. CLE134  *CREATE    Date 01Aug12              */
/*                                                                   */
/*-------------------------------------------------------------------*/
/*                                                                   */
/*       AR316215 - Calls UT000493 datapatch program                 */
/*                  (Child: AR316218)                                */
/*       CLE134 - Past Due Call Loan Processing                      */
/*                                                                   */
/*********************************************************************/
 
             PGM        PARM(&MODE)
 
             DCL        VAR(&MODE) TYPE(*CHAR) LEN(1)
             DCL        VAR(&DMLIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&DPLIB) TYPE(*CHAR) LEN(10)
             DCL        VAR(&PREF) TYPE(*CHAR) LEN(2)
             DCL        VAR(&RUNP) TYPE(*CHAR) LEN(3) VALUE('NO')
             DCL        VAR(&CPYFLD) TYPE(*CHAR) LEN(64) VALUE('(c) +
                          Misys Banking Systems 2012')
 
/** Global monitor message  */
 
             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO +
                          CMDLBL(ABNOR1))
 
/** Start of program */
 
             SNDPGMMSG  MSG('UTCLE493 - Utility to update History +
                          files with invalid data in numeric +
                          fields') TOMSGQ(MRUNQ MOPERQ)
 
/** Create LDA if it doesn't exist */
 
             CHKOBJ     OBJ(QTEMP/LDA) OBJTYPE(*DTAARA)
             MONMSG     MSGID(CPF9815 CPF9801) EXEC(DO)
               CRTDTAARA  DTAARA(QTEMP/LDA) TYPE(*CHAR) LEN(256)
             ENDDO
 
/** Passed parameter is invalid */
 
             IF         COND((&MODE *NE 'A') *AND (&MODE *NE 'a') +
                          *AND (&MODE *NE 'U') *AND (&MODE *NE +
                          'u')) THEN(DO)
 
               SNDPGMMSG  MSG('Invalid parameter passed to UTCLE493') +
                            TOMSGQ(MOPERQ MRUNQ)
               SNDPGMMSG  MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('Invalid +
                            parameter passed. It should either be ''U'' +
                            ''u'' for Update and ''A'' or ''a'' for +
                            Audit.') MSGTYPE(*ESCAPE)
               GOTO       CMDLBL(END)
             ENDDO
 
/** Get system prefix */
 
             RTVDTAARA  DTAARA(SDSTAT (6 2)) RTNVAR(&PREF)
             CHGVAR     VAR(&DPLIB) VALUE(&PREF *TCAT 'DPLIB')
             CHGVAR     VAR(&DMLIB) VALUE(&PREF *TCAT 'DMLIB')
 
/** Check if Backup files already exists */
 
             CHKOBJ     OBJ(&DPLIB/RRHISTSHM) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK1))
             DLTF       FILE(RRHISTSHM)
 
CHK1:        CHKOBJ     OBJ(&DPLIB/RRHISTSHN) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK2))
             DLTF       FILE(RRHISTSHN)
 
CHK2:        CHKOBJ     OBJ(&DPLIB/RRHISTSHP) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK3))
             DLTF       FILE(RRHISTSHP)
 
CHK3:        CHKOBJ     OBJ(&DPLIB/RRHISTSHQ) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK4))
             DLTF       FILE(RRHISTSHQ)
 
CHK4:        CHKOBJ     OBJ(&DPLIB/RRMHISTHM) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK5))
             DLTF       FILE(RRMHISTHM)
 
CHK5:        CHKOBJ     OBJ(&DPLIB/RRMHISTHN) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK6))
             DLTF       FILE(RRMHISTHN)
 
CHK6:        CHKOBJ     OBJ(&DPLIB/RRMHISTHP) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(CHK7))
             DLTF       FILE(RRMHISTHP)
 
CHK7:        CHKOBJ     OBJ(&DPLIB/RRMHISTHQ) OBJTYPE(*FILE)
             MONMSG     MSGID(CPF9801) EXEC(GOTO CMDLBL(BACKUP))
             DLTF       FILE(RRMHISTHQ)
 
 
/** Create backup of History files for update mode */
 
 BACKUP:     IF         COND((&MODE *EQ 'U') *OR (&MODE *EQ 'u')) +
                          THEN(DO)
 
               CPYF       FROMFILE(&DMLIB/HISTSHM) +
                            TOFILE(&DPLIB/RRHISTSHM) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG  MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                    CLRPFM  FILE(RRHISTSHM)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/HISTSHN) +
                            TOFILE(&DPLIB/RRHISTSHN) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRHISTSHN)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/HISTSHP) +
                            TOFILE(&DPLIB/RRHISTSHP) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRHISTSHP)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/HISTSHQ) +
                            TOFILE(&DPLIB/RRHISTSHQ) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRHISTSHQ)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/MHISTHM) +
                            TOFILE(&DPLIB/RRMHISTHM) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRMHISTHM)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/MHISTHN) +
                            TOFILE(&DPLIB/RRMHISTHN) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRMHISTHN)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/MHISTHP) +
                            TOFILE(&DPLIB/RRMHISTHP) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRMHISTHP)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
               CPYF       FROMFILE(&DMLIB/MHISTHQ) +
                            TOFILE(&DPLIB/RRMHISTHQ) MBROPT(*REPLACE) +
                            CRTFILE(*YES)
 
               MONMSG     MSGID(CPF2817) CMPDTA(CPF2869) EXEC(DO)
                 CLRPFM     FILE(RRMHISTHQ)
               ENDDO
 
               MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                 GOTO       CMDLBL(ABNOR1)
               ENDDO
 
             ENDDO
 
/** Call PGM/UTLE0493  */
 
             CHGJOB     SWS(XXXXXX00)
             CHGVAR     VAR(&RUNP) VALUE('YES')
 
             CALL       PGM(UT000493) PARM(&MODE)
 
/** Error occurred in audit program  */
 
             IF         COND(%SWITCH(XXXXXX11)) THEN(GOTO +
                          CMDLBL(ABNOR))
 
             SNDPGMMSG  MSG('UTCLE493 completed normally.') +
                          TOPGMQ(*EXT) TOMSGQ(MOPERQ MRUNQ)
 
             GOTO       CMDLBL(END)
 
/** Abnormal Termination of the program or  */
/** Restore backup if an error occurred in update mode  */
 
 ABNOR:      IF         COND((&MODE *EQ 'U') *OR (&MODE *EQ 'u')) +
                          THEN(DO)
 
               IF         COND(&RUNP *EQ 'YES') THEN(DO)
                 CPYF       FROMFILE(&DPLIB/RRHISTSHM) +
                               TOFILE(&DMLIB/HISTSHM) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred in restoring +
                               PF/HISTSHM from PF/RRHISTSHM. Process +
                               terminated. Please restore manually +
                               PF/HISTSHM from PF/RRHISTSHM.') +
                               MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRHISTSHN) +
                               TOFILE(&DMLIB/HISTSHN) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred in restoring +
                               PF/HISTSHN from PF/RRHISTSHN. Process +
                               terminated. Please restore manually +
                               PF/HISTSHN from PF/RRHISTSHN.') +
                               MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRHISTSHP) +
                               TOFILE(&DMLIB/HISTSHP) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred in restoring +
                               PF/HISTSHP from PF/RRHISTSHP. +
                               Process terminated. +
                               Please restore manually +
                               PF/HISTSHP from +
                               PF/RRHISTSHP.') MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRHISTSHQ) +
                               TOFILE(&DMLIB/HISTSHQ) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred +
                               in restoring PF/HISTSHQ +
                               from PF/RRHISTSHQ. Process terminated.  +
                               Please restore manually PF/HISTSHQ from +
                               PF/RRHISTSHQ.') MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRMHISTHM) +
                               TOFILE(&DMLIB/MHISTHM) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred +
                               in restoring PF/MHISTHM +
                         from PF/RRMHISTHM. Process terminated.  +
                         Please restore manually PF/MHISTHM from +
                         PF/RRMHISTHM.') +
                         MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRMHISTHN) +
                               TOFILE(&DMLIB/MHISTHN) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred +
                               in restoring PF/MHISTHN +
                               from PF/RRMHISTHN. Process terminated.  +
                               Please restore manually PF/MHISTHN from +
                               PF/RRMHISTHN.') +
                               MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRMHISTHP) +
                               TOFILE(&DMLIB/MHISTHP) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG  MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                            SNDUSRMSG  MSG('Error occurred +
                            in restoring PF/MHISTHP +
                            from PF/RRMHISTHP. Process terminated.  +
                            Please restore manually PF/MHISTHP from +
                            PF/RRMHISTHP.') +
                            MSGTYPE(*INFO)
                 ENDDO
 
                 CPYF       FROMFILE(&DPLIB/RRMHISTHQ) +
                               TOFILE(&DMLIB/MHISTHQ) MBROPT(*REPLACE) +
                               FMTOPT(*NONE)
 
                 MONMSG     MSGID(CPF2817 CPF3130 CPF2909) EXEC(DO)
                               SNDUSRMSG  MSG('Error occurred +
                               in restoring PF/MHISTHQ +
                               from PF/RRMHISTHQ. Process terminated.  +
                               Please restore manually PF/MHISTHQ from +
                               PF/RRMHISTHQ.') +
                               MSGTYPE(*INFO)
                 ENDDO
 
               ENDDO
 
             ENDDO
 
ABNOR1:      SNDPGMMSG  MSG('Error +
                occurred in UTCLE493 program') +
                TOPGMQ(*EXT) TOMSGQ(MOPERQ MRUNQ)
 
END:         CHGVAR     VAR(&CPYFLD) VALUE('(c) Misys Banking +
                          Systems 2010')
             SNDPGMMSG  MSG('End of UTCLE493') TOMSGQ(MRUNQ MOPERQ)
 
             ENDPGM
