     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas GL Automatic Account Closure')                   *
      *****************************************************************
      *                                                               *
      *  Midas - General Ledger Module                                *
      *                                                               *
      *  XX0083 - Midas GL Automatic Account Closure                  *
      *                                                               *
      *  Program Function: This program will close General Ledger     *
      *                    Accounts which have not moved since the    *
      *                    pre-defined in-activity period and have    *
      *                    a balance of zero. Details of Accounts     *
      *                    closed will be output to a report.         *
      *                                                               *
      *  Phase(s): COB - Automatic.                                   *
      *                                                               *
      *  Called By: XXC0083 - Midas GL Automatic Account Closure      *
      *                                                               *
      *  (c) Finastra International Systems Ltd. 2020                 *
      *                                                               *
      *                                                               *
      *  Last Amend No. MD058366           Date 23Jul21               *
      *  Prev Amend No. MD057325           Date 04Dec20               *
      *                 FVT106 *Create     Date 14Sep20               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD058366 - Failed component GLC48 - Terminated Abnormally.   *
      *           - LCD must be next working day instead of run date. *
      *  MD057325 - Closure of Dealing accounts (FVT106)              *
      *  FVT106 - Automatic Account Closure & Account re-opening      *
      *           Includes AR1034170:                                 *
      *    AR1034170 - Due to inactivity, computer suspense a/c was   *
      *                closed automatically. Amended pgm to exclude   *
      *                suspense a/cs from FVT106 processing.          *
      *                (Child: AR1034171)                             *
      *                                                               *
      *****************************************************************
      *
     FACCBR   UF  E           K        DISK         KINFSR *PSSR
      ** Midas GL Accounts by Branch
      *
     FACCNTAC UF  E                    DISK         KINFSR *PSSR
      ** Midas GL Accounts Master Trailer
      *
     FXX0083P1O   E                    PRINTER
     F                                              KINFDS SPOOL1
      ** Midas GL Automatic Account Closure Report
      *
     FXX0083AUO   E                    PRINTER
     F                                              KINFDS SPOOLU
      ** Midas GL Automatic Account Closure Audit
      *
      *****************************************************************
      *                                                               *
      *                    FUNCTION OF INDICATORS                     *
      *                    **********************                     *
      *                                                               *
      *   50  - No Record to Report                                   *
      *   80  - End of File ACCBR                                     *
      *   98  - Date Format: DDMMYY (off); MMDDYY (on)                *
      * 90-99 - Used by Standard Subroutines                          *
      *                                                               *
      * U7+U8 - Database Error                                        *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *                      SUBROUTINE INDEX                         *
      *                      ****************                         *
      *                                                               *
      *  SRINIT   - Subroutine to do Program Initialisation.          *
      *  SRPROC   - Subroutine to do Detail Processing.               *
      *  SRCLAC   - Subroutine to Close General Ledger Account        *
      *  SRPRNT   - Subroutine to Print detail record.                *
      *  SREND    - Subroutine to Write End of Report.                *
      *  SRAUDT   - Subroutine to Output Audit report and End Program.*
      *  SRRCFA   - Subroutine to register XX0083AU via RCF.          *
      *  SRRCFP   - Subroutine to register XX0083P1 via RCF.          *
      *  SRTERM   - Subroutine to Terminate program                   *
      *  *PSSR    - Program exception error routine.                  *
      *                                                               *
      *  ZTNLU1   - To Retrieve the next Transaction Number           *
      *  ZDATE2   - To Format a Midas Number in Alpha Date            *
      *                                                               *
      *****************************************************************
      *
     E/EJECT
      *
      ** Array containing Copyright statement
      *
     E                    SVL     1   1 20
     E                    CPY@    1   1 80
      *
      /COPY ZSRSRC,ZDATE2Z1
      *
      /SPACE 3
      *
      ** Local data area for database error details
      *
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      *                                     134 141 DBFILE
      *                                     142 170 DBKEY
      *                                     171 180 DBPGM
      *                                     181 1830DBASE
      *
     IPSDS       SDS
      *
      ** Program Status Data Structure
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
      **  Short data structure for access programs
      *
     IDSFDY     E DSDSFDY
      ** First DS for access programs, short data structure
      *
     IDSSDY     E DSDSSDY
      ** Second DS for access programs, long data structure
      *
     ISDBANK    E DSSDBANKPD
      ** Data Structure to receive Bank Details
      *
     ISDGELR    E DSSDGELRPD
      ** Data Structure to receive General Ledger Details
      *
      ***  File Information Data Structure for XX0083P1.
      *
     ISPOOL1      DS
      *
     I                                       83  92 SFILE1
     I                                    B 123 1240SFNUM1
     I                                    B 188 1890OFLLN1
     I                                    B 367 3680PRTLN1
      *
      ***  File Information Data Structure for XX0083AU.
      *
     ISPOOLU      DS
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
      /COPY ZSRSRC,ZTNLU1Z1
      *
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      **  Perform Initialisation.
      *
     C                     EXSR SRINIT
      *
      **  Perform Detail Processing.
      *
     C                     EXSR SRPROC
      *
      **  Output Audit Report and End Program.
      *
     C                     EXSR SRAUDT
      *
      **  Perform Termination Processing.
      *
     C                     EXSR SRTERM
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *================================================================
      *
      *****************************************************************
      *  SRINIT   - Subroutine to do Program Initialisation.          *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls:     AOBANKR0                                          *
      *****************************************************************
      *
     C           SRINIT    BEGSR
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ** Define LDA
      *
     C           *NAMVAR   DEFN           LDA
      *
      **  Receive Parameter List
      *
     C           *ENTRY    PLIST
     C                     PARM           PSEQ    5
      *
      ** Initialise LDA field.
      *
     C                     MOVEL'XX0083'  DBPGM
      *
      ** Access Bank details via access program
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '       ' ULRTCD  7
     C                     PARM '*FIRST ' ULOPTN  7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           ULRTCD    IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           *************
     C                     Z-ADD1         DBASE            *DB ERROR 01*
     C                     MOVELULOPTN    DBKEY            *************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Check System Date Format, DDMMYY (*IN98 off)
      *                            MMDDYY (*IN98 on).
      *
     C           BJDFIN    IFEQ 'M'
     C                     SETON                     98
     C                     ENDIF
      *
      ** Get General Ledger Details
      *
     C                     CALL 'AOGELRR0'
     C                     PARM '*MSG   ' ULRTCD  7
     C                     PARM '*FIRST ' ULOPTN  7
     C           SDGELR    PARM SDGELR    DSFDY
      *
     C           ULRTCD    IFNE *BLANK
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD2         DBASE            *DB ERROR 02*
     C                     MOVEL'SDGELRPD'DBFILE           *************
     C                     MOVELULOPTN    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           E1
      *
     C                     MOVELBKACCD    BKACDN 100                                       AR1034170
      *
      **  Access SAR details file to see if FVT106 SAR is installed.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'FVT106'  @KEY    6
      *
     C           @RTCD     IFEQ *BLANK
     C                     MOVE 'Y'       FVT106  1
     C                     ELSE
     C                     MOVE 'N'       FVT106
     C                     ENDIF
      *
      *  Access System Value
     C                     CLEARLINPD
     C           FVT106    IFEQ 'Y'                        B* FVT106
     C                     MOVELSVL,1     SVALK1
     C                     CALL 'AOSVALR0'
     C                     PARM           RTNCDE  7
     C                     PARM           SVALK1 20
     C                     PARM           SVAL1 200
     C                     PARM           SVALK2 20
     C                     PARM           SVAL2 200
     C                     PARM           SVALK3 20
     C                     PARM           SVAL3 200
     C                     PARM           SVALK4 20
     C                     PARM           SVAL4 200
     C                     PARM           SVALK5 20
     C                     PARM           SVAL5 200
     C                     PARM           SVALK6 20
     C                     PARM           SVAL6 200
     C                     PARM           SVALK7 20
     C                     PARM           SVAL7 200
     C                     PARM           SVALK8 20
     C                     PARM           SVAL8 200
     C                     PARM           SVALK9 20
     C                     PARM           SVAL9 200
     C                     PARM           SVAL10 20
     C                     PARM           SVAL11200
      *
     C           RTNCDE    IFEQ *BLANKS                    B* RTNCDE
     C                     MOVELSVAL1     FIELD4  4
     C                     MOVE FIELD4    LINPD   40
     C                     ELSE
     C                     MOVE 'N'       FVT106
     C                     END                             E* RTNCDE
     C                     END                             E* FVT106
      *
      ** RCF Processing for Printer File
      *
     C                     EXSR SRRCFP
      *
      ** RCF Processing for Audit File.
      *
     C                     EXSR SRRCFA
      *
      ** Report Work fields.
      *
     C                     Z-ADD0         RQDLN1  30
     C                     Z-ADD0         DIFLN1  30
      *
      ** Initialise all working fields
      *
     C                     Z-ADD*ZERO     ULRCNT  40       No of Rejn Code
      *
      ** Write Report header and column headings
      *
     C                     WRITEPGHEADER                   Report header
     C                     WRITEDTHEADER                   Columns Header
      *
     C                     ENDSR
      *
      /TITLE SR/SRPROC
      *****************************************************************
      *  SRPROC   - Subroutine to do Detail Processing.               *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls:                                                       *
      *****************************************************************
      *
     C           SRPROC    BEGSR
      *
      ** Read Accounts file
      *
     C           *LOVAL    SETLLACCBR
     C                     READ ACCBR                    80
      *
     C           *IN80     DOWEQ*OFF
      *
      ** Only process open General Ledger Accounts with Balance of Zero
     C           ATYP      IFEQ 'G'
     C           LDBL      ANDEQ*ZERO
     C           ACST      ANDNE'C'
     C           ACOD      ANDNEBKACDN                                                     AR1034170
     C           ATYP      OREQ 'D'                                                        MD057325
     C           LDBL      ANDEQ*ZERO                                                      MD057325
     C           ACST      ANDNE'C'                                                        MD057325
     C           ACOD      ANDNEBKACDN                                                     MD057325
     C           ATYP      OREQ 'C'                                                        MD057325
     C           LDBL      ANDEQ*ZERO                                                      MD057325
     C           ACST      ANDNE'C'                                                        MD057325
     C           ACOD      ANDNEBKACDN                                                     MD057325
      *
      ** Calculate Inactivity period of Account.
      ** If Last Movement Date is Zero use Date Acoount opened.
     C           LMVD      IFNE *ZERO
     C           BJRDNB    SUB  LMVD      UINPD   50
     C                     ELSE
     C           BJRDNB    SUB  DACO      UINPD
     C                     ENDIF
      *
      ** Close Account if inactive period has been exceeded
     C           UINPD     IFGT LINPD
     C           LINPD     ANDGT0
     C           FVT106    ANDEQ'Y'
      *
      ** Output details to Report
     C                     ADD  1         ULRCNT
     C                     EXSR SRPRNT
      ** Close Account
     C                     EXSR SRCLAC
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     READ ACCBR                    80
     C                     ENDDO
      *
      ** End of file so write trailer
      *
     C                     EXSR SREND
      *
      ** Produce Audit Report.
      *
     C                     EXSR SRAUDT
      *
     C                     ENDSR
      *
      /TITLE SR/SRCLAC
      *****************************************************************
      *  SRCLAC - Subroutine to Close an Account                      *
      *                                                               *
      *  Called By: SRPROC                                            *
      *  Calls:                                                       *
      *****************************************************************
      *
     C           SRCLAC    BEGSR
      *
      ** Update ACCNTAB
      *
     C                     MOVELCHTP      PCHTP   1
     C                     Z-ADDLCD       PLCD    50
      *
     C                     MOVEL'C'       ACST
      *
     C**********           Z-ADDBJRDNB    LCD                                               MD058366
     C                     Z-ADDBJDNWD    LCD                                               MD058366
     C                     Z-ADDBJRDNB    DACC
      *
     C                     MOVEL'C'       CHTP
      *
      ** Force NATN in TNLU
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      TNLU
     C                     UPDATACCNTABF
      *
      ** Update ACCNTAC
      *
     C           1         SETLLACCNTAC
     C                     READ ACCNTAC                  82
      *
     C           *IN82     IFEQ '0'
     C           NOCL      ADD  1         NOCL
     C           NOAU      SUB  1         NOAU
      *
     C           PLCD      IFEQ BJRDNB
     C           PCHTP     ANDEQ'I'
     C                     ADD  1         NORE
     C                     SUB  1         NINU
     C                     ENDIF
      *
     C           PLCD      IFEQ BJRDNB
     C           PCHTP     ANDEQ'A'
     C                     SUB  1         NOAM
     C                     ENDIF
      *
      ** Force Run Date in LCD
     C                     Z-ADDBJRDNB    LCD
     C                     Z-ADDNATN      TNLU
     C                     UPDATACCNTACF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      /TITLE SR/SRPRNT
      *****************************************************************
      *  SRPRNT - Subroutine to write detail record                   *
      *                                                               *
      *  Called By: SRPROC                                            *
      *  Calls:                                                       *
      *****************************************************************
      *
     C           SRPRNT    BEGSR
      *
      ** Check that sufficient lines remain for the Format. If not,
      ** write out the Main Headings on a new page.
      *
     C                     Z-ADD1         RQDLN1
     C           OFLLN1    SUB  PRTLN1    DIFLN1
     C           DIFLN1    IFLE RQDLN1
     C                     WRITEPGHEADER                   Page Header
     C                     WRITEDTHEADER                   Customer Detail
     C                     ENDIF
      *
      ** Output Account detail
      *
     C                     MOVE BRCA      P1BRCA
     C                     MOVE CNUM      P1CNUM
     C                     MOVE CCY       P1CCY
     C                     MOVE ACOD      P1ACOD
     C                     MOVE ACSQ      P1ACSQ
     C                     MOVE ANAM      P1ANAM
      *
      ** Output Last Movement Date/Date Account opened in DDMMMYY format
     C           LMVD      IFNE *ZERO
     C                     Z-ADDLMVD      ZDAYNO
     C                     ELSE
     C                     Z-ADDDACO      ZDAYNO
     C                     ENDIF
      *
     C                     EXSR ZDATE2
      *
     C           LMVD      IFNE *ZERO
     C                     MOVE ZADATE    P1LMVD
     C                     MOVE *BLANKS   P1DACO
     C                     ELSE
     C                     MOVE ZADATE    P1DACO
     C                     MOVE *BLANKS   P1LMVD
     C                     ENDIF
      *
     C                     WRITER1DETAIL
      *
     C                     ENDSR
      *
      /TITLE SR/SREND
      *****************************************************************
      *  SREND - Subroutine to Write End of Report.                   *
      *                                                               *
      *  Called By: SRPROC                                            *
      *  Calls    : None                                              *
      *****************************************************************
      *
     C           SREND     BEGSR
      *
      ** Check that sufficient lines remain for the Format. If not,
      ** write out the Main Headings on a new page.
      *
     C                     Z-ADD4         RQDLN1
     C           OFLLN1    SUB  PRTLN1    DIFLN1
     C           DIFLN1    IFLE RQDLN1
     C                     WRITEPGHEADER
     C                     ENDIF
      *
      ** If no record processed then write 'NO RECORD TO REPORT'
      *  on the Rejection Code List report.
      *
     C           ULRCNT    IFEQ 0
     C                     MOVE *ON       *IN50
     C                     ENDIF
      *
      ** Write Trailer
      *
     C                     WRITETRAILER
      *
     C                     ENDSR
      *
      /TITLE SR/SRAUDT
      *****************************************************************
      *  SRAUDT - Subroutine to Output Audit report and End Program.  *
      *                                                               *
      *  Called By: Main Processing, SRPROC, *PSSR                    *
      *  Calls: None.                                                 *
      *****************************************************************
      *
     C           SRAUDT    BEGSR
      *
      ** Output Report Header and File Controls.
      *
     C                     WRITEHEADERAU
     C                     WRITECONTROL
      *
      ** If there is a DB Error, Output the DB Error Information.
      *
     C           *INU7     IFEQ *ON
     C                     WRITEDBERROR
     C                     ELSE
      *
      ** Or, if no records read, Output "No Details" message.
      *
     C           ULRCNT    IFEQ 0
     C                     WRITENODTLS
     C                     ENDIF
     C                     ENDIF
      *
      ** Write Trailer for Audit Report.
      *
     C                     WRITEAUTRAIL
      *
      ** End Program and Return.
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *
      *
      /TITLE SR/SRRCFP
      *****************************************************************
      *  SRRCFP  - Subroutine to register XX0083P1 via RCF.           *
      *                                                               *
      *  Called By: SRINIT                                            *
      *  Calls: None.                                                 *
      *****************************************************************
      *
     C           SRRCFP    BEGSR
      *
      ** Ensure Report Spool File recorded by RCF.
      *
     C                     Z-ADDSFNUM1    ZSNUM   60
      *
     C                     CALL 'ZSFILE'
     C                     PARM           PSEQ
     C                     PARM           PRENT   3
     C                     PARM           SFILE1
     C                     PARM           ZSNUM
     C                     PARM *BLANKS   ZSERR   1
      *
      ** If Error occurs during ZSFILE processing, then return to the
      *  Calling Program.
      *
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      /TITLE SR/SRRCFA
      *****************************************************************
      *  SRRCFA - Subroutine to register XX0083AU via RCF.            *
      *                                                               *
      *  Called By: SRINIT                                            *
      *  Calls: None.                                                 *
      *****************************************************************
      *
     C           SRRCFA    BEGSR
      *
      ** Ensure Audit Spool File recorded by RCF.
      *
     C                     Z-ADDSFNUMU    ZSNUMU  60
      *
     C                     CALL 'ZSFILE'
     C                     PARM           PSEQ
     C                     PARM           PRENT
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM *BLANK    ZSERR
      *
      ** If Error occurs during ZSFILE processing, then return to the
      ** Calling Program.
      *
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      /TITLE SR/*PSSR
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           ULRUN     IFEQ *BLANK
     C                     MOVE 'Y'       ULRUN   1
     C                     SETON                     U7U8LR
     C                     DUMP
      *
     C                     EXSR SRAUDT
     C                     RETRN
     C                     ENDIF
      *
      ** If *PSSR already run, then just end the program here.
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *
      /TITLE SR/#LTERM
      *****************************************************************
      *  SRTERM   - Subroutine to do Terminate program                *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls:                                                       *
      *****************************************************************
      *
     C           SRTERM    BEGSR
     C                     SETON                     LR
     C                     RETRN
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *
      /COPY ZSRSRC,ZTNLU1Z2
      /EJECT
      /COPY ZSRSRC,ZDATE2Z2
      *
**  SVL
GLAccInactDays
**  CPY@
(c) Finastra International Systems Ltd. 2020
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
