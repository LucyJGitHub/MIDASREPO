     H        1
     F*****************************************************************
/*STD *  RPGBASE                                                      *
/*OVRF*: OVRDBF FILE(SECET) SHARE(*NO)                              : *   S01486
/*OVRF*: OVRDBF FILE(SEEVNT) TOFILE(SECED) SHARE(*NO)               : *   S01486
      *****************************************************************
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  XX118008 - Generate Position Settlements - Customers         *
      *                                                               *
      *  Function: This program reads through the Security Diary and  *
      *   (COB/IC) Non Diary File. For each Security Event extracted  *
      *            today, accesses the Customer Positions by Security *
      *            File. For each Depot Pos found where the Pos Date  *
      *            is before the Event Date, Position Settlements are *
      *            generated.                                         *
      *                                                               *
      *  Called By: XXC118003 - SE on-line Positions Generation       *
      *                                                               *
      *  Calls: XX118006 - SE Position Settlement Check/Delete        *
      *         XX118009 - SE Position Settlement Split for Treaty WHT*
      *         SEC8100  - SE Position Calculation Routine            *
      *         XX2400   - SE Gen a/c keys posn settles CAR Pgm       *
      *                                                               *
      *  (c) Finastra International Limited 2020                      *
      *                                                               *
      *****************************************************************
      * NOTE:                                                         *
      * Changes related to Pos. Settl. should be evaluated and then   *
      * implemented in SE2400 as well. Account keys generation changes*
      * are not needed in SE2400                                      *
      *****************************************************************
      *                                                               *
      *  Last Amend No. HUT118   *Create   Date 16Dec20               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  AR324886 - Implement 4-eyes processing in Position           *
      *             Settlement Maintenance.                           *
      *  HUT103 - Position Settlement Account Defaulting              *
      *  HUT118 - Position Settlements Online Generation              *
      *---------------------------------------------------------------*
     F*
     F*EPSDNL0IF  E           K        DISK                               236617
     F*******SEPSDNL0UF  E           K        DISK                 236617 HUT118
     FXXPSDNV0UF  E           K        DISK                               HUT118
     F                                              KCOMIT                HUT118
     FSECDEPL0IF  E           K        DISK                               189942
     F            CDEPPDF                           KRENAMECDEPP0         189942
     FCDEPS   IF  E           K        DISK                               189942
     F            CDEPPDF                           KRENAMECDEPPS         189942
     FSECDEPL5IF  E           K        DISK                               189942
     F            CDEPPDF                           KRENAMECDEPP5         189942
     FPOSETA  UF  E                    DISK         KINFSR *PSSR A    UC
     F                                              KCOMIT
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     FTABSE   IF  E           K        DISK
     F* ICD 1     TABTB10F                          KIGNORE
      * ICD 2     TABTB11F                          KIGNORE
     F            TABTB40F                          KIGNORE
     F            TABTG20F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F            TABLETLF                          KIGNORE
     F            TABLETRF                          KIGNORE
     F            TABLETXF                          KIGNORE
     F            TABLET2F                          KIGNORE
     F            TABLET3F                          KIGNORE
     F            TABLET5F                          KIGNORE
     F            TABTE10F                          KIGNORE
     F            TABLETNF                          KIGNORE
     F            TABLETKF                          KIGNORE
     F            TABLETPF                          KIGNORE
     F            TABLETAF                          KIGNORE
     F            TABTE20F                          KIGNORE
      *  SE Non Diary Event Audit file
     FSNDEVA  UF  E                    DISK
     F                                              KCOMIT
     F*******SE4860AUO   E                    PRINTER      KINFSR *PSSR   HUT118
     FXX1188AUO   E                    PRINTER      KINFSR *PSSR          HUT118
     FSECTY   IF  E           K        DISK
     FSESWHTL0IF  E           K        DISK                               S01447
      * Securities WHT details file                                       S01447
     FSEDEV   IF  E           K        DISK
     F            SEDEVDF                           KRENAMESEDEVDV
     FSEDEVL3 UF  E           K        DISK                           UC
     F                                              KCOMIT                                HUT118
      *                                                                                   CSE053
     F*******SEDEVLD IF  E           K        DISK                                 CSE053 HUT118
     F******XXDEVLV0IF  E           K        DIS                                          HUT118
     F******      SEDEVDF                           KRENAMESEDEVDD                 CSE053 HUT118
      *                                                                                   CSE053
      * RECORD ID PN                                                      S01486
     FPMPORTPDIF  E           K        DISK                           UC  S01486
      *                                                                   S01486
     FSECET   IF  E           K        DISK                           UC  S01486
     F            SEDEVDF                           KRENAMESEDEVD1        S01486
      *                                                                   S01486
     FSEEVNT  IF  E           K        DISK                           UC  S01486
     F            SNDEVDF                           KRENAMESNDEVD2        S01486
     F            SEDEVDF                           KRENAMESEDEVD2        S01486
      *                                                                   S01486
      **   ACCOUNT DETAILS                                                S01486
     FPMACCNL0IF  E           K        DISK                           UC  S01486
      *                                                                   S01486
     FPMACCNL1IF  E           K        DISK                           UC  219688
     F            ACCNTABF                          KRENAMEACCNTL1F       219688
      *                                                                   219688
     FSDCURRL0IF  E           K        DISK                               081336
     F******SECEO   IF  E           K        DISK         KINFSR *PSSR A  E36391 HUT118
     *******      SEDEVDF                           KRENAMESEDEVDO        E36391 HUT118
     F******      SNDEVDF                           KRENAMESNDEVDO        E36391 HUT118
     FSEPCCD  IF  E           K        DISK                               S01117
     FINVTP   IF  E           K        DISK
     FSTDSED  IF  E           K        DISK
      * Historic + Current + Fwd Cust Positions
     F*******SECUOFL0IF  E           K        DISK         KINFSR *PSSR   HUT118
     FXXCUOFV0IF  E           K        DISK         KINFSR *PSSR          HUT118
      *
      * Cust & Depot Positions - Depot Positions extract
     F*******SECDUDL1IF  E           K        DISK         KINFSR *PSSR   HUT118
     FXXCDUDV1IF  E           K        DISK         KINFSR *PSSR          HUT118
      *
     FSECGT   IF  E           K        DISK                               S01519
      ** Charge/commissions Rates Table.                                  S01519
     FSEDFTCL2IF  E           K        DISK                               S01519
      ** Default charges table.                                           S01519
     FSEDFGRL0IF  E           K        DISK                           UC  CSE026
     F            SEDFTCD0                          KRENAMESEDFTGD0       CSE026
     FPOSETD  O   E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     FPSAUTD  O   E           K        DISK                               AR324886
     F                                              KINFSR *PSSR                              HUT118
     F                                              KCOMIT                                    HUT118
      ** SE POSITION SETTLEMENT AUTHORISATION DETAIL                      AR324886
      *
     F/COPY WNCPYSRC,SE4860FFP1
      *
      /EJECT
     F*****************************************************************
      *                                                               *
      *****************************************************************
      /EJECT
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZPOWERZ1                                               S01509
     E/COPY ZSRSRC,ZHASHZ1
     E/COPY ZSRSRC,ZHOLE                                                  S01512
     E/COPY ZSRSRC,ZCCAL1Z1                                               S01519
     E/COPY ZSRSRC,ZDAYSZ1                                                S01486
     E/COPY ZSRSRC,ZDATE2Z1                                               S01486
     E                    CPY@    1   1 80
     E/COPY ZSRSRC,ZACCRZ0                                                S01486
     E/COPY ZSRSRC,ZNCDZ1                                                 S01486
     E/COPY WNCPYSRC,SE4860E001
      /EJECT
      *                                                                   033988
     I*******SEPSDEP0    09                                        236617 HUT118
     IXXPSDEP0    09                                                      HUT118
      *                                                                   236617
     I*******SEPSNDP0    10                                        236617 HUT118
     IXXPSNDP0    10                                                      HUT118
      *                                                                   236617
     ISECTYDF                                                             033988
     I              RECI                            RECIS                 033988
     I*                                                                   033988
      *
     ISEDEVDF                                                             E20086
     I              NMCY                            SNMCY                 E20086
     I******SEDEVDO                                                       E36391 HUT118
     I******        NMCY                            SNMCY                 E36391 HUT118
     ISEDEVD1                                                             095548
     I              NMCY                            SNMCY                 095548
     ISEDEVD2                                                             095548
     I              NMCY                            SNMCY                 095548
     ISEDEVDV                                                                                 CSE073
     I              NMCY                            SNMCY                                     CSE073
     I*****SEDEVDD                                                                     CSE073 HUT118
     I*****         NMCY                            SNMCY                              CSE073 HUT118
     IACCNTABF                                                            S01486
     I              PTFR                            RNPTFR                S01486
     IACCNTL1F                                                            219688
     I              PTFR                            L1PTFR                219688
     ICLINTCBF                                                            186906
     I              CTYP                            CTYPXX                186906
     ISEPCCDF                                                             189942
     I              PTFR                            PCPTFR                189942
     ICDEPP0                                                              189942
     I              RECI                            CDRECI                189942
     ICDEPPS                                                              189942
     I              RECI                            CDRECI                189942
     ICDEPP5                                                              189942
     I              RECI                            CDRECI                189942
      *                                                                                       CSE028
     IINVTPDF                                                             HUT118
     I              SFLG                            ISFLG                 HUT118
      ** DS for customer/book standard settlement instruction                                 CSE028
      **  to be passed to SESSIR0                                                             CSE028
      *                                                                                       CSE028
     IPCBSTD    E DSSTDSED                    2                                               CSE028
     I              RECI                            WRECI                                     CSE028
     I              LCD                             WLCD                                      CSE028
     I              CHTP                            WCHTP                                     CSE028
     I              TNLU                            WTNLU                                     CSE028
      *                                                                                       CSE028
      ** Data structure for standard additional settlement details                            CSE028
      ** for customer/book to be passed to SESSIR0                                            CSE028
      *                                                                                       CSE028
     IPCBSAD    E DSSTDADSED                  8                                               CSE028
      *
     ITABLKY      DS
      *
      *  TABTB11 TABLE KEY FIELD DATA STRUCTURE FOR DB ERROR
      *
     I                                        1  12 TABKEY
     I                                        1   20RECT
     I                                        3  10 ZZ008
     I                                       11  120RCDE
      *
     IPOSDDS      DS                            366
      *
      *  POSITION SETTLEMENTS  FILE ERROR EXCEPTION  DATA STRUCT.
      *
      *    MIDAS 'Next Available Transaction No.' Data Area  MNATN .      S01486
     IDNATN       DS                              5                       S01486
     I                                        1   50FNATN                 S01486
     I/COPY ZSRSRC,ZHASHZ2
     I/COPY ZSRSRC,ZNCDZ2                                                 S01486
      *
      *
     IINVKEY      DS
      *
      * INVESTMENT TYPE FILE KEY FOR DB ERROR PRINTOUT
      *
     I                                        1   3 NMCY
     I                                        4   6 SITP
      *
      *                                                                   S01117
     ILDA         DS                            256                       S01117
      *                                                                   S01117
      ** Local Data area for Database Error Reporting                     S01117
      *                                                                   S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
      *
     IPOSDDB      DS
      *
      * FILE POSETD DB ERROR KEY - OUTPUT FILE
      *
     I                                        1   3 PBCAK                 CSE023
     I                                        4  13 PSSHK                 CSE023
     I                                       14  190PCPYK                 CSE023
      *                                                                   103361
      * Prime account code                                                103361
     I            DS                                                      103361
     I                                        1  12 PRACCT                103361
     I                                        1   6 PRCNUM                103361
     I                                        7  10 PRACOD                103361
     I                                       11  12 PRACSQ                103361
      *                                                                   S01117
     IKSEPCR      DS                                                      S01117
      *                                                                   S01117
      * File SEPCCD database error key                                    S01117
      *                                                                   S01117
     I*******                                 1   60CSCN           S01117 HUT118
     I                                        1   6 CSCN                  HUT118
     I                                        1   6 ZCUST                 E37051
     I                                        7   9 CSBA                  S01117
     I                                       10  19 CSSC                  S01117
      *                                                                   087178
     I/COPY WNCPYSRC,SE4860I002
     IP@DATA      DS                            128                       CAC002
     I/COPY WNCPYSRC,SE4860I004
      ** Data structure of the parameter passed to and from SEZ010        087178
     I                                        1   1 P@CLAS                087178
     I                                        2   2 P@PPRE                087178
     I                                        3  150P@PAMD                087178
     I                                       16  280P@PCHA                087178
     I                                       29  410P@PCAM                087178
     I                                       42  540P@TASO                087178
     I                                       55  670P@TAUS                087178
     I                                       68  808P@PSXR                087178
     I                                       81  81 P@PMDI                087178
     I                                       82  84 P@PNCY                087178
     I                                       85  87 P@PSCU                087178
     I                                       88 1000P@PSAT                087178
     I                                      101 1138P@FXMR                CAC002
     I                                      114 1260P@MAMT                CAC002
     I                                      127 128 P@TDTP                CAC002
     I            DS                                                      CSE073
     I********                                1   60CDCNZN                CSE073 HUT118
     I                                        1   6 CDCNZN                HUT118
     I/COPY WNCPYSRC,SE4860I003
      *
     ICPYR@#      DS
      *
      *  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
      *
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                   S01408
     C/COPY WNCPYSRC,SE4860IIP2                                           S01408
      *                                                                   S01408
     ISDBRCH    E DSSDBRCHPD                                              S01447
      ** Branch Details                                                   S01447
      *                                                                   S01446
     ISDCURR    E DSSDCURRPD                                              S01446
      ** Currency Details                                                 S01446
      *                                                                   063199
     ISDGELR    E DSSDGELRPD                                              063199
      ** General Ledger details                                           063199
      *                                                                   063199
     ISDSTRD    E DSSDSTRDPD                                              S01519
      ** Securities Trading ICD                                           S01519
      *                                                                   S01447
     ISECNTR    E DSSECNTRPD                                              S01447
      ** SE Country tax rate details                                      S01447
      *                                                                   S01447
     ISECBTX    E DSSECBTXPD                                              S01447
      ** SE Country to Branch tax rate details                            S01447
     ISDMMOD    E DSSDMMODPD                                              S01486
      **  Data structure for module details                               S01486
      *                                                                   S01486
     ISDPORT    E DSSDPORTPD                                              S01486
      **  Data structure for portfolio management details                 S01486
      *                                                                   S01486
     ISDPLCS    E DSSDPLCSPD                                              S01486
      **  Data structure for portfolio client                             S01486
      *                                                                   S01486
     ISECSPD    E DSSDSECSPD                                              S01486
     I              QQACCD                          Q1ACCD                HUT118
      ** Securities Trading Customer Details access object                S01486
      *                                                                   S01486
     ISDRETL    E DSSDRETLPD                                              103361
     I              QQACCD                          Q2ACCD                HUT118
      ** Retail ICD details                                               103361
      *                                                                   S01447
      *                                                                   S01408
     ISDBANK    E DSSDBANKPD
      ***  Data structure for bank details                 Prefix - BJ
      *
     ISCSARD    E DSSCSARDPD                                              CSE026
      ** Data structure for switchable features file                      CSE026
      *                                                                   CSE026
     I              LCD                             SCLCD                 CSE026
     I/COPY WNCPYSRC,SE4860IIP1                                           S01408
      *                                                                   S01408
     IDSFDY     E DSDSFDY                                                 S01447
      *  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE               S01447
      *                                                                   S01447
     IDSSDY     E DSDSSDY                                                 S01447
      *  SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE               S01447
      *                                                                   S01447
     IPPOSET    E DSPOSETD                                                CSE023
      *  Position Settlement record for calling SE2310                    CSE023
     I              LCD                             LCDP                  CSE023
     IDATA2       DS                           1024                                           HUT103
     I                                        1   5 UPSEQ                                     HUT103
     I                                        6  11 DPCPY                                     HUT103
     I                                       12  21 DPSSH                                     HUT103
     I                                       22  23 DSDET                                     HUT103
     I                                       24  26 DPBCA                                     HUT103
     I                                       27  29 DPNCY                                     HUT103
     I                                       30  420DPAMD                                     HUT103
     I                                       43  470DPSVL                                     HUT103
     I                                       48  49 DPEVT                                     HUT103
     I                                       50  564DUTXRU                                    HUT103
     I                                       57  690DTAUS                                     HUT103
     I                                       70  710DPBCD                                     HUT103
     I                                       72  72 DIN80W                                    HUT103
     I                                       73  78 DCNUM                                     HUT103
     I                                       79  82 DPTFR                                     HUT103
     I                                       83  85 DBRCD                                     HUT103
     I                                       86  88 DCURR                                     HUT103
     I                                       89  89 DFOND                                     HUT103
     I                                       90 107 DSETA                                     HUT103
     IDATAI       DS                             99                                           HUT103
     I                                        1   1 DIN01                                     HUT103
     I                                        2   2 DIN02                                     HUT103
     I                                        3   3 DIN03                                     HUT103
     I                                        4   4 DIN04                                     HUT103
     I                                        5   5 DIN05                                     HUT103
     I                                        6   6 DIN06                                     HUT103
     I                                        7   7 DIN07                                     HUT103
     I                                        8   8 DIN08                                     HUT103
     I                                        9   9 DIN09                                     HUT103
     I                                       10  10 DIN10                                     HUT103
     I                                       11  11 DIN11                                     HUT103
     I                                       12  12 DIN12                                     HUT103
     I                                       13  13 DIN13                                     HUT103
     I                                       14  14 DIN14                                     HUT103
     I                                       15  15 DIN15                                     HUT103
     I                                       16  16 DIN16                                     HUT103
     I                                       17  17 DIN17                                     HUT103
     I                                       18  18 DIN18                                     HUT103
     I                                       19  19 DIN19                                     HUT103
     I                                       20  20 DIN20                                     HUT103
     I                                       21  21 DIN21                                     HUT103
     I                                       22  22 DIN22                                     HUT103
     I                                       23  23 DIN23                                     HUT103
     I                                       24  24 DIN24                                     HUT103
     I                                       25  25 DIN25                                     HUT103
     I                                       26  26 DIN26                                     HUT103
     I                                       27  27 DIN27                                     HUT103
     I                                       28  28 DIN28                                     HUT103
     I                                       29  29 DIN29                                     HUT103
     I                                       30  30 DIN30                                     HUT103
     I                                       31  31 DIN31                                     HUT103
     I                                       32  32 DIN32                                     HUT103
     I                                       33  33 DIN33                                     HUT103
     I                                       34  34 DIN34                                     HUT103
     I                                       35  35 DIN35                                     HUT103
     I                                       36  36 DIN36                                     HUT103
     I                                       37  37 DIN37                                     HUT103
     I                                       38  38 DIN38                                     HUT103
     I                                       39  39 DIN39                                     HUT103
     I                                       40  40 DIN40                                     HUT103
     I                                       41  41 DIN41                                     HUT103
     I                                       42  42 DIN42                                     HUT103
     I                                       43  43 DIN43                                     HUT103
     I                                       44  44 DIN44                                     HUT103
     I                                       45  45 DIN45                                     HUT103
     I                                       46  46 DIN46                                     HUT103
     I                                       47  47 DIN47                                     HUT103
     I                                       48  48 DIN48                                     HUT103
     I                                       49  49 DIN49                                     HUT103
     I                                       50  50 DIN50                                     HUT103
     I                                       51  51 DIN51                                     HUT103
     I                                       52  52 DIN52                                     HUT103
     I                                       53  53 DIN53                                     HUT103
     I                                       54  54 DIN54                                     HUT103
     I                                       55  55 DIN55                                     HUT103
     I                                       56  56 DIN56                                     HUT103
     I                                       57  57 DIN57                                     HUT103
     I                                       58  58 DIN58                                     HUT103
     I                                       59  59 DIN59                                     HUT103
     I                                       60  60 DIN60                                     HUT103
     I                                       61  61 DIN61                                     HUT103
     I                                       62  62 DIN62                                     HUT103
     I                                       63  63 DIN63                                     HUT103
     I                                       64  64 DIN64                                     HUT103
     I                                       65  65 DIN65                                     HUT103
     I                                       66  66 DIN66                                     HUT103
     I                                       67  67 DIN67                                     HUT103
     I                                       68  68 DIN68                                     HUT103
     I                                       69  69 DIN69                                     HUT103
     I                                       70  70 DIN70                                     HUT103
     I                                       71  71 DIN71                                     HUT103
     I                                       72  72 DIN72                                     HUT103
     I                                       73  73 DIN73                                     HUT103
     I                                       74  74 DIN74                                     HUT103
     I                                       75  75 DIN75                                     HUT103
     I                                       76  76 DIN76                                     HUT103
     I                                       77  77 DIN77                                     HUT103
     I                                       78  78 DIN78                                     HUT103
     I                                       79  79 DIN79                                     HUT103
     I                                       80  80 DIN80                                     HUT103
     I                                       81  81 DIN81                                     HUT103
     I                                       82  82 DIN82                                     HUT103
     I                                       83  83 DIN83                                     HUT103
     I                                       84  84 DIN84                                     HUT103
     I                                       85  85 DIN85                                     HUT103
     I                                       86  86 DIN86                                     HUT103
     I                                       87  87 DIN87                                     HUT103
     I                                       88  88 DIN88                                     HUT103
     I                                       89  89 DIN89                                     HUT103
     I                                       90  90 DIN90                                     HUT103
     I                                       91  91 DIN91                                     HUT103
     I                                       92  92 DIN92                                     HUT103
     I                                       93  93 DIN93                                     HUT103
     I                                       94  94 DIN94                                     HUT103
     I                                       95  95 DIN95                                     HUT103
     I                                       96  96 DIN96                                     HUT103
     I                                       97  97 DIN97                                     HUT103
     I                                       98  98 DIN98                                     HUT103
     I                                       99  99 DIN99                                     HUT103
     IDATAF1      DS                           5000                                           HUT103
     IDATAF2      DS                           5000                                           HUT103
     IDATAF3      DS                           5000                                           HUT103
     IDATAF4      DS                           5000                                           HUT103
      *                                                                                       HUT103
     ISDSTAT    E DSSDSTAT                                                AR324886
      ** SD DATA AREA                                                     AR324886
     I/COPY ZSRSRC,ZHOLI                                                  S01512
      *                                                                   S01512
     I/COPY WNCPYSRC,SE4860I001
      /EJECT
      *                                                                                    CSE053
     IKEYFLD      DS                                                                       CSE053
     I                                        3  05 SPBCA                                  CSE053
     I                                        6  15 SPSSH                                  CSE053
     I                                       16  25 SPCPY                                  CSE053
     I                                       26  300SPDUD                                  CSE053
      *                                                                                    CSE053
     IZ#BSTS    E DSZ#BST                                                                  CSE053
     IZ#ASTS    E DSZ#AST                                                                  CSE053
      *                                                                                    CSE053
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      *  Initial process
     C                     EXSR SRINIT
     C           @WSECU    IFNE *BLANKS                                                  247246
     C           @WSECU    ANDNE'*ALL'                                                   247246
     C*********  @WSECU    SETLLSEPSDNL0                                  247246         HUT118
     C*********  @WSECU    READESEPSDNL0                 89               236617 247246  HUT118
     C           @WSECU    SETLLXXPSDNV0                                                 HUT118
     C           @WSECU    READEXXPSDNV0                 89                              HUT118
     C                     ELSE                                                          247246
     C*********  *LOVAL    SETLLSEPSDNL0                                                 HUT118
     C*********            READ SEPSDNL0                 89               236617         HUT118
     C           *LOVAL    SETLLXXPSDNV0                                                 HUT118
     C                     READ XXPSDNV0                 89                              HUT118
     C                     END                                                           247246
      *
      * LOOP ROUND PROCESSING FOR EACH ACTION RECORD READ LF/SECAC
      *
     C           *IN89     DOWEQ'0'
      *
      * READ ACTION FILE OF SECURITY ACTIONS
      *
     C                     MOVE *BLANKS   WWCNUM                          206604
     C                     MOVE *BLANKS   WWPTFR                          206604
     C                     MOVE *BLANKS   WWTDSS                          206604
     C                     MOVE *BLANKS   WWCDPT                          206604
      *
     C**********           READ SEPSDNL0                 89               236617
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     Z-ADDP9SDED    ECD     50                      S01486
     C                     END                                            S01486
      *
      * IF ACTION RECORD DELETED GOTO END OF LOOP FOR NEXT ACTION
      *
     C  N89      P9RECI    CABEQ'*'       ENDLP
     C  N89      P9RECI    CABEQ'M'       ENDDE                           236617
      *
      * AT END OF FILE -
      *
     C           *IN89     CABEQ'1'       ENDLP
      *
     C                     MOVE P9RECI    WSRECI
      *
      ** ADD TO COUNTER FOR EACH RECORD READ
      *      SECURITY ACTION COUNT
      *
     C                     ADD  1         WCSECT  50
     C                     MOVE '1'       WNEWSC  1
     C********             MOVE *ZEROS    WNEWCU  60                      HUT118
     C                     MOVE *BLANKS   WNEWCU  6                       HUT118
     C                     MOVE *ZEROS    PRVCUS
     C*******              MOVE *ZEROS    PRVDEP           HUT118
     C                     MOVE *BLANKS   PRVDEP           HUT118
     C                     MOVE *BLANKS   WNEWBR  3
     C                     MOVE *BLANKS   PRVBRA
     C                     MOVE *BLANKS   PRVPTF
     C                     MOVE *BLANKS   WNEWPT  4
     C                     MOVE '0'       *IN79
     C                     MOVE P9SDSN    WCSSC
      *
      * GET EACH CUST WHO HOLDS THIS SECURITY  - EXSR GETDEP
      *
     C           *IN79     DOWEQ'0'
      *
     C                     EXSR GETDEP
      *
      * IND 79 IS SET ON WHEN NO MORE CUSTS FOR THIS SECURITY
      *
     C           *IN79     CABEQ'1'       PRCPTF                          S01486
      *
      ** PROCESS SELECTED SECURITY / CUST /DATE RECORD
      *
      *
      *  NOTE THAT XX118008 WILL PROCESS ALL SECURITY ACTIONS NEW 'TODAY'   E15549
      *  (AS DEFINED BY THE EVENT CONTROL DATE IN SE2100).                E15549
      * ((LINES ASTERISKED BELOW BY E14506 RELEVANT TO E15549))           E15549
      *
      *
      ** IF THIS POSITION DATE IS LESS THAN OR EQUAL TO THE               E15549
      ** LAST COUPON DATE THEN THE EX-COUPON NOMINAL WILL BE ZERO         E15549
      *                                                                   E15549
     C           CSDA      IFLE P9LCCP                                    E15549
     C                     Z-ADD*ZERO     CSEX                            E15549
     C                     END                                            E15549
      *
     C           CSCN      IFNE PRVCUS                     B* SELECTED
     C           CSDA      ANDLEP9SDED
     C           CSBA      ORNE PRVBRA
     C           CSDA      ANDEQCMPDAT
      *
      *                                                                   E15549
      * Get New Nominal Position from SEC8100
     C                     EXSR #GETNP
      *
      ** CALCULATE CUM-COUPON VALUE
      *
     C           CSNV      SUB  CSEX      WCUMCP 150
      *
      *
      ** EXECUTE SUBROUTINE SECPPC TO RETRIEVE CUSTOMER POSITION          S01117
      ** PROFIT CENTRE DETAILS                                            S01117
      *                                                                   S01117
     C           BKPRCU    IFEQ 'Y'                                       063199
     C           WCUMCP    ANDNE0                                         121921
     C                     EXSR SECPPC                                    S01117
     C                     END                                            063199
     C*
      *** For efficiency purposes, make calls to following subroutines    S01447
      *** dependant on change of security.                                S01447
      *                                                                   S01447
     C           CSSC      IFNE UCSSC                                     S01447
      *                                                                   S01447
      ** EXECUTE SUBROUTINE SECTIN TO RETRIEVE SECURITY RECORD
      *
     C                     MOVE P9SDSN    SASN                            189942
     C                     EXSR SECTIN
      *
      ** Execute Subroutine INVTIN to retrieve INVESTMENT Record          E23169
      *                                                                   E23169
     C                     EXSR INVTIN                                    E23169
      *                                                                   S01447
     C                     MOVE CSSC      UCSSC  10                       S01447
     C                     END                                            S01447
      *                                                                   E23169
      *** IF THE BOOKING BRANCH READ IS DIFFERENT FROM PREVIOUS RECORD,   S01447
      *** GET COUNTRY LOCATION OF BRANCH.                                 S01447
      *                                                                   S01447
     C           CSBA      IFNE UCSBA                                     S01447
     C                     EXSR GETCTY                                    S01447
     C                     MOVE CSBA      UCSBA   3                       S01447
     C                     END                                            S01447
      *                                                                   S01447
     C** EXECUTE SUBROUTINES DEPENDING ON ACTION TYPE
      *
     C           P9SDET    CASEQ'DV'      DIVIDN
     C                     END
      *
     C                     END                             E* SELECTED
     C                     END                                            080741
      *
      * ADD TO COUNT OF POSITIONS PROCESSED
      *
     C                     ADD  1         WCPOSN  50
      *
     C           PRCPTF    TAG                                            S01486
      *                                                                   S01486
      * CHECK THAT PORTFOLIO MANAGEMENT IS PRESENT IN THE SYSTEM          S01486
      * OR PRIVATE BANKING MODULE IS ACTVE                                CPB001
      *                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                        B2             S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
      *                                                                   S01486
      * GENERATE POSITION SETTLEMENTS FOR ALL PORTFOLIO POSITIONS         S01486
      * SET FLAG FOR FIRST SECURITY POSITION                              S01486
      *                                                                   S01486
     C                     MOVE 'Y'       WSPOSN  1                       S01486
      *                                                                   S01486
      * SET FLAG FOR POSITIONS TO PROCESS                                 S01486
      *                                                                   S01486
     C                     MOVE 'Y'       WPORTP  1                       S01486
      *                                                                   S01486
      * GET NEXT PORTFOLIO POSITION FOR SECURITY ACTION                   S01486
      *                                                                   S01486
     C                     EXSR GETPTF                                    S01486
      *                                                                   S01486
      * SET FIRST SECURITY FLAG TO 'N'                                    S01486
      *                                                                   S01486
     C                     MOVE 'N'       WSPOSN                          S01486
      *                                                                   S01486
      * DO WHILE PORTFOLIO POSITIONS FOUND                                S01486
      *                                                                   S01486
     C           WPORTP    DOWEQ'Y'                        B3             S01486
      *                                                                   S01486
      * IF THE POSITION DATE IS LESS THAN OR EQUAL TO THE LAST COUPON     S01486
      * DATE THEN THE EX-COUPON NOMINAL WILL BE ZERO                      S01486
      *                                                                   S01486
     C           DDTE      IFLE P9LCCP                     B4             189942
     C                     Z-ADD0         CSEX                            189942
     C                     END                             E4             189942
      *                                                                   189942
      *                                                                   189942
      * CALCULATE CUMULATIVE COUPON NOMINAL VALUE                         S01486
      *                                                                   189942
      *
     C           CDCN      IFNE PRVCUS                     B* SELECTED
     C           CDPA      ORNE PRVBRA
      *
     C           CDCN      OREQ PRVCUS
     C           CDPA      ANDEQPRVBRA
     C           WWPTFR    ANDNEPRVPTF
      *
     C           CDCN      OREQ PRVCUS
     C           CDPA      ANDEQPRVBRA
     C           CDPT      ANDNEPRVDEP
      *
      * select only if date is less than or equal to event date
     C           DDTE      IFEQ CMPDAT                     B* Ddte
      *
      * Get New Nominal Position from SEC8100
     C                     EXSR #GETNP
      *
      * CALCULATE CUMULATIVE COUPON NOMINAL VALUE                         S01486
     C*                                                                   189942
     C           CDNV      SUB  CSEX      WCUMCP                          189942
      ** EXECUTE SUBROUTINE SECPPC TO RETRIEVE CUSTOMER POSITION          080741
      ** PROFIT CENTRE DETAILS                                            080741
      *                                                                   080741
     C           BKPRCU    IFEQ 'Y'                                       080741
     C                     EXSR SECPPC                                    080741
     C                     END                                            080741
      *                                                                   S01486
      ** EXECUTE SUBROUTINE SECTIN TO RETRIEVE SECURITY RECORD            S01486
      *                                                                   S01486
     C                     MOVE CDSN      SASN                            189942
     C                     EXSR SECTIN                                    S01486
      *                                                                   S01486
     C                     EXSR INVTIN                                    S01486
      *                                                                   S01486
      ** EXECUTE SUBROUTINES DEPENDING ON ACTION TYPE                     S01486
      *                                                                   S01486
      *                                                                   S01486
     C           P9SDET    CASEQ'DV'      DIVIDN           B4             S01486
     C                     END                             E4             S01486
      *                                                                   S01486
     C                     END                             E* Ddte
     C                     END                             E* SELECTED
      *                                                                   S01486
      * GET NEXT PORTFOLIO POSITION FOR SECURITY ACTION                   S01486
      *                                                                   S01486
     C                     EXSR GETPTF                                    S01486
      *                                                                   S01486
     C                     END                             E3             S01486
     C                     END                             E2             S01486
     C                     MOVE 'M'       P9RECI                          236617
     C***09                UPDATSEPSDEP0                           236617 HUT118
     C   09                UPDATXXPSDEP0                                  HUT118
     C***10                UPDATSEPSNDP0                           236617 HUT118
     C   10                UPDATXXPSNDP0                                  HUT118
     C           ENDDE     TAG                                            236617
     C           @WSECU    IFNE *BLANKS                                                  247246
     C           @WSECU    ANDNE'*ALL'                                                   247246
     C*******    @WSECU    READESEPSDNL0                 89               236617 247246 HUT118
     C           @WSECU    READEXXPSDNV0                 89               HUT118
     C                     ELSE                                                          247246
     C*******              READ SEPSDNL0                 89               236617 HUT118
     C                     READ XXPSDNV0                 89               HUT118
     C                     END                                                           247246
     C                     END
      *
     C           ENDLP     TAG                             ** ENDLP **    S01486
      *
     C           EAUDIT    TAG                             ** EAUDIT **
      *
      * OUTPUT RUN CONTROL REPORT
      *
     C                     EXSR SRENDP
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     C/COPY WNCPYSRC,SE4860C001
     C                     SETON                     LR
      *                                                               *
      *****************************************************************
      *                                                               *
      *  SRINIT - Initial Routine                                     *
      *                                                               *
      *  CALLED FROM: MAIN                                            *
      *                                                               *
      *****************************************************************
      *
     C           SRINIT    BEGSR
      *
     C           *ENTRY    PLIST
     C                     PARM           @PHASE  1
     C                     PARM           @WSECU 10                                      247246
     C                     PARM           @WNPOS  60                                     HUT118
      *
     C*
     C* KEYLISTS FOR CHAINING TO FILES
      *
      * CUST. POSITIONS -   SHORT KEY,CURRENT ONLY LF/CPOSS
      *
     C           CPOSKY    KLIST
     C                     KFLD           WCSSC
      *
      * CUST. POSITIONS -  HISTORY AND CURRENT   LF/CPOSH
      *
     C           CPOHKY    KLIST
     C                     KFLD           WCSBA                           S01117
     C                     KFLD           WCSSC
     C                     KFLD           WCSCN
     C                     KFLD           WCSDA
      *
     C           SECDKY    KLIST
     C                     KFLD           P9SDSN
     C                     KFLD           SDED
     C                     KFLD           SDET
      *
     C           SECDK1    KLIST
     C                     KFLD           P9SDSN
     C                     KFLD           SDET
     C                     KFLD           SDED
      *                                                                   E36391
      *                                                                   E36391
      *  - SECURITY DIARY EVENTS                                          E36391
     C           SEDKEY    KLIST                                          E36391
     C                     KFLD           P9SDSN                          E36391
     C                     KFLD           P9SDET                          E36391
     C                     KFLD           P9SDED                          E36391
      *
      * SECURITIES LF/SECTY
      *
     C           SECTKY    KLIST
     C                     KFLD           SASN
      *
      * INVESTMENT TYPES LF/INVTP
      *
     C           INVTKY    KLIST
     C                     KFLD           NMCY
     C                     KFLD           SITP
      *
      * STANDARD SETTLEMENT INSTRUCTIONS PF/STDSED
      *
     C           STDSKY    KLIST
     C                     KFLD           SBRA                            S01117
     C                     KFLD           CSTM
     C                     KFLD           WBKCD   2                                           CSE028
     C                     KFLD           CYSI
     C                     KFLD           ITSI
     C                     KFLD           WPTFR   4                                           CSE028
      *                                                                   S01117
      * Customer Position Profit Centre Record PF/SEPCCD                  S01117
      *                                                                   S01117
     C           KSEPCC    KLIST                                          S01117
     C                     KFLD           CSCN                            S01117
     C                     KFLD           CSBA                            S01117
     C                     KFLD           CSSC                            S01117
      *                                                                   S01519
      ** Default charges table.  LF/SEDFTCPD                              S01519
      *                                                                   S01519
     C           DFTKY1    KLIST                                          S01519
     C                     KFLD           DCCLAS                          S01519
     C                     KFLD           DCINVT                          S01519
     C                     KFLD           DCCUST                          S01519
      *                                                                   CSE026
     C           DFTKYG    KLIST                                          CSE026
     C                     KFLD           DCCLGR                          CSE026
     C                     KFLD           DCINVT                          CSE026
     C                     KFLD           DCCUST                          CSE026
      *                                                                   S01519
      ** Security details                                                 S01519
      *                                                                   S01519
     C           @CCOD     KLIST                                          S01519
     C                     KFLD           @CCY                            S01519
     C                     KFLD           @CAM    2                       S01519
      *                                                                   S01486
      *                                                                   189942
      * FIRST CUSTOMER POSITION FILE             LF/SECDEPL0              189942
      *                                                                   189942
     C           PMFPKY    KLIST                                          189942
     C                     KFLD           CSCN                            189942
     C                     KFLD           WWCDPA                          189942
      *                                                                   189942
      * CURRENT CUSTOMER POSITION FILE           LF/CDEPS                 189942
      *                                                                   189942
     C           PMCPSS    KLIST                                          189942
     C                     KFLD           P9SDSN                          189942
      *                                                                   189942
      * ALL VALUE DATE PORTFOLIO POSITIONS       LF/SECDEPL5              189942
      *                                                                   189942
     C           PMVPKY    KLIST                                          189942
     C                     KFLD           WWCDPA  3                       189942
     C********             KFLD           WWCNUM  60               189942 HUT118
     C                     KFLD           WWCNUM  6                       HUT118
     C                     KFLD           WWPTFR  4                       189942
     C                     KFLD           WWTDSS 10                       189942
     C********             KFLD           WWCDPT  60               189942 HUT118
     C                     KFLD           WWCDPT  6                       HUT118
     C                     KFLD           WWCDMK  1                       189942
     C                     KFLD           WWDDTE  50                      189942
      *                                                                   S01486
      ** PORTFOLIO DETAILS PMPORTPD                                       S01486
     C           PMPORT    KLIST                                          S01486
     C********             KFLD           WWCNU1  60               S01486 HUT118
     C                     KFLD           WWCNU1  6                       HUT118
     C                     KFLD           WWPTF1  4                       S01486
      *                                                                   S01486
      ** ACCOUNT DETAILS PMACCNL0                                         S01486
     C           ACCNTP    KLIST                                          S01486
     C                     KFLD           WZCNUM                          S01486
     C                     KFLD           WZCCY                           S01486
     C                     KFLD           WZPTFR                          S01486
     C                     KFLD           WZACSQ  20                      S01486
      *                                                                   219688
      ** ACCOUNT DETAILS PMACCNL1                                         219688
     C           ACCNTL    KLIST                                          219688
     C                     KFLD           WZCNUM                          219688
     C                     KFLD           WZPTFR                          219688
     C                     KFLD           WZCCY                           219688
     C                     KFLD           WZACOD                          219688
     C                     KFLD           WZACSQ                          219688
      *                                                                   219688
     C/COPY WNCPYSRC,SE4860C002
      *
      * ACCESS ICD INFORMATION IN SUBROUTINE FIRST
      *
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE *BLANK    DBLOT
     C                     Z-ADD0         DBASE
      *** Correct setup of DBPGM                                          S01447
     C                     MOVE *BLANKS   DBPGM                           S01447
     C                     MOVEL'XX118008'DBPGM                           S01447
     C                     OUT  LDA                                       S01117
     C           *NAMVAR   DEFN           SDSTAT                          AR324886
     C                     IN   SDSTAT                                    AR324886
      *** Correct setup of DBPGM                                          S01447
     C                     MOVE '1'       WLIT1
     C                     MOVE 'A'       WRTYP                           S01447
      *
      * ACCESS ICD    TABTB10
      *
     C                     EXSR ZSYSTM
     C           *IN99     IFEQ '1'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY            * DB ERROR 01 *
     C                     Z-ADD1         DBASE            ***************
     C                     DUMP                                           S01117
     C                     ELSE
      *
      * ACCESS ICD2   TABTB11
      *
     C                     EXSR ZICD2
     C           *INU7     IFEQ '1'
     C                     MOVE '1'       *IN99
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELTABKEY    DBKEY            * DB ERROR 02 *
     C                     Z-ADD2         DBASE            ***************
     C                     DUMP                                           S01117
     C                     ELSE
      *                                                                   103361
      **Retrieve*account*code                                      103361 114458
      *                                                                   103361
      *
      * ACCESS ICDSE  TABTB36
      *
     C                     EXSR ZICDSE
     C           *INU7     IFEQ '1'
     C                     MOVE '1'       *IN99
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY            * DB ERROR 03 *
     C                     Z-ADD3         DBASE            ***************
     C                     DUMP                                           S01117
     C                     END
     C                     END
     C                     END
     C/COPY WNCPYSRC,SE4860C003
      *                                                                   S01486
      **  Get module details using access object                          S01486
     C                     CALL 'AOMMODR0'                                S01486
     C                     PARM '*MSG   ' @RTCD                           S01486
     C                     PARM '*FIRST ' @OPTN                           S01486
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01486
      *                                                                   S01486
      **  Check if error occurred                                         S01486
      *                                                                   S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVEL'SDMMODPD'DBFILE           ***************S01486
     C                     Z-ADD23        DBASE            * DB ERROR 22 *S01486
     C                     SETON                       U7U8***************S01486
     C                     OUT  LDA                                       081239
     C                     EXSR *PSSR                                     S01486
     C                     END                                            S01486
      *                                                                   S01486
      *                                                                   063199
      ** Access SDGELRPD for profit centres used flag                     063199
      *                                                                   063199
     C                     CALL 'AOGELRR0'                                063199
     C                     PARM '*MSG   ' @RTCD   7                       063199
     C                     PARM '*FIRST ' @OPTN   7                       063199
     C           SDGELR    PARM SDGELR    DSFDY                           063199
      *                                                                   063199
     C           @RTCD     IFNE *BLANKS                                   063199
     C           *LOCK     IN   LDA                                       063199
     C                     MOVEL'SDGELRPD'DBFILE           ***************063199
     C                     Z-ADD22        DBASE            * DB ERROR 22 *063199
     C                     SETON                       U7U8***************063199
     C                     EXSR *PSSR                                     063199
     C                     END                                            063199
      *                                                                   S01486
      * CHECK IF PORTFOLIO MANAGEMENT IS INSTALLED                        S01486
      *                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
      *                                                                   S01486
      * READ PM INSTALLATION AND CONTROL DATA                             S01486
      *                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM '*MSG'    @RTCD                           S01486
     C                     PARM '*FIRST ' @OPTN                           S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
      *                                                                   S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVEL'SDPORTPD'DBFILE           ***************S01486
     C                     Z-ADD24        DBASE            * DB ERROR 24 *S01486
     C                     SETON                       U7U8***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                                            S01486
     C                     ENDIF                                          CPB001
      *                                                                   S01486
      **  Open Portfolio Management files                                 S01486
      *                                                                   S01486
     C                     OPEN PMPORTPD                                  S01486
     C                     OPEN PMACCNL0                                  S01486
     C                     OPEN PMACCNL1                                  219688
     C                     OPEN SECET                                     S01486
     C                     OPEN SEEVNT                                    S01486
      *                                                                   S01486
     C                     END                                            S01486
     C                     OPEN SEDEVL3
     C********             OPEN SEPSDNL0               46                  HUT118
     C                     OPEN XXPSDNV0               46                  HUT118
      *
      *
      ***  Access bank details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD13        DBASE            *****************
     C                     MOVE *BLANKS   DBFILE           ** DB ERROR 13 **
     C                     MOVEL'SDBANKPD'DBFILE    P      *****************
     C                     MOVEL'*FIRST  'DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE *OFF      *IN98
     C           BJDFIN    IFEQ 'M'
     C                     MOVE *ON       *IN98
     C                     END
      *                                                                   114458
      * Retrieve account code                                             114458
      *                                                                   114458
     C           BGRTBN    IFEQ 'Y'                                       114458
     C                     CALL 'AORETLR0'                                114458
     C                     PARM *BLANKS   @RTCD   7                       114458
     C                     PARM '*FIRST'  @OPTN   7                       114458
     C           SDRETL    PARM SDRETL    DSFDY                           114458
     C           @RTCD     IFNE *BLANKS                                   114458
     C           *LOCK     IN   LDA                                       114458
     C                     MOVEL*BLANK    DBKEY            ***************114458
     C                     Z-ADD43        DBASE            * DB ERROR 43 *114458
     C                     MOVEL'SDRETLL1'DBFILE           ***************114458
     C                     SETON                       U7U8               114458
     C                     EXSR *PSSR                                     114458
     C                     END                                            114458
     C                     END                                            114458
      *                                                                   S01519
      ** Access Securities Trading file for the Autocharge option         S01519
      *                                                                   S01519
     C                     CALL 'AOSTRDR0'                                S01519
     C                     PARM *BLANKS   @RTCD   7                       S01519
     C                     PARM '*FIRST ' @OPTN   7                       S01519
     C********** SDSTRD    PARM SDSTRD    DSFDY                                        S01519 CSE073
     C           SDSTRD    PARM SDSTRD    DSSDY                                               CSE073
      *                                                                   S01519
     C           @RTCD     IFNE *BLANKS                                   S01519
     C                     SETON                     U7U899               S01519
     C           *LOCK     IN   LDA                                       S01519
     C                     MOVE 'SDSTRDPD'DBFILE           ***************S01519
     C                     MOVEL'*FIRST'  DBKEY            * DB ERROR 23 *S01519
     C                     Z-ADD23        DBASE            ***************S01519
     C                     EXSR *PSSR                                     S01519
     C                     END                                            S01519
      *                                                                   S01446
      ** If Autocharge option is set to 'Y', check if Customer            S01446
      ** Commission (Courtage) is installed                               S01446
      *                                                                   S01446
     C           BVACOP    IFEQ 'Y'                                       S01446
     C                     MOVE 'N'       S01446                          S01446
     C                     CALL 'AOSARDR0'                                S01446
     C                     PARM *BLANKS   @RTCD                           S01446
     C                     PARM '*VERIFY' @OPTN                           S01446
     C                     PARM 'S01446'  @SARD   6                       S01446
      *                                                                   S01446
     C           @RTCD     IFEQ *BLANK                                    S01446
     C                     MOVE 'Y'       S01446  1                       S01446
      *                                                                   S01446
      ** If it is and charge ccy is defined, get the spot rate            S01446
      ** and save multiply/divide indicator and number of dec places      S01446
      ** from SDCURRPD                                                    S01446
      *                                                                   S01446
     C           BVCHRC    IFNE *BLANKS                                   S01446
     C                     MOVE BVCHRC    WCURR                           S01446
     C                     Z-ADD24        WDBAS1                          S01446
     C                     EXSR #LCURR                                    S01446
     C                     Z-ADDA6SPRT    TXSPOT 138                      S01446
     C                     MOVE A6MDIN    TXMDI   1                       S01446
     C                     MOVE A6NBDP    TXCDP   10                      S01446
     C                     END                                            S01446
     C                     END                                            S01446
     C                     END                                            S01446
      *                                                                   CSE026
      ** Check if Posn Settlement Default Charges by Customer Grp is On.  CSE026
      *                                                                   CSE026
     C                     CALL 'AOSARDR0'                                CSE026
     C                     PARM *BLANKS   @RTCD                           CSE026
     C                     PARM '*VERIFY' @OPTN                           CSE026
     C                     PARM 'S01496'  @SARD                           CSE026
     C           SCSARD    PARM SCSARD    DSSDY                           CSE026
      *                                                                   CSE026
     C           @RTCD     IFEQ *BLANKS                                   CSE026
     C                     MOVE 'Y'       S01496  1                       CSE026
     C                     ELSE                                           CSE026
      *                                                                   CSE026
      ** Error if return code other than '*NRF'                           CSE026
      *                                                                   CSE026
     C           @RTCD     IFNE '*NRF'                                    CSE026
     C           *LOCK     IN   LDA                                       CSE026
     C                     Z-ADD52        DBASE                           CSE026
     C                     MOVE 'SCSARDPD'DBFILE                          CSE026
     C                     MOVEL'*VERIFY' DBKEY                           CSE026
     C                     MOVE *ON       *INU7                           CSE026
     C                     MOVE *ON       *INU8                           CSE026
     C                     EXSR *PSSR                                     CSE026
     C                     ELSE                                           CSE026
     C                     MOVE 'N'       S01496                          CSE026
     C                     ENDIF                                          CSE026
      *                                                                   CSE026
     C                     ENDIF                                          CSE026
      *                                                                   CSE026
      ** If S01496 is On & Autocharge flag on Securities Trading ICD is   CSE026
      ** 'Y', set on Indicator 40.                                        CSE026
      *                                                                   CSE026
     C           S01496    IFEQ 'Y'                                       CSE026
     C           BVACOP    ANDEQ'Y'                                       CSE026
     C                     MOVE *ON       *IN40                           CSE026
     C                     OPEN SEDFGRL0                                  CSE026
     C                     ELSE                                           CSE026
     C                     MOVE *OFF      *IN40                           CSE026
     C                     ENDIF                                          CSE026
      *
      *** Check Withholding tax is installed                              S01447
      *                                                                   S01447
     C                     CALL 'AOSARDR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*VERIFY' @OPTN                           S01447
     C                     PARM 'S01447'  @SARD   6                       S01447
      *                                                                   S01447
     C           @RTCD     IFEQ *BLANK                                    S01447
     C                     MOVE 'Y'       S01447  1                       S01447
     C                     ELSE                                           S01447
     C                     MOVE 'N'       S01447                          S01447
     C                     END                                            S01447
      *                                                                   S01509
      ** Check if Value currency is installed                             S01509
      *                                                                   S01509
     C                     CALL 'AOSARDR0'                                S01509
     C                     PARM *BLANKS   @RTCD                           S01509
     C                     PARM '*VERIFY' @OPTN                           S01509
     C                     PARM 'S01509'  @SARD   6                       S01509
      *                                                                   S01509
     C           @RTCD     IFEQ *BLANK                                    S01509
     C                     MOVE 'Y'       S01509  1                       S01509
     C                     ELSE                                           S01509
     C                     MOVE 'N'       S01509                          S01509
     C                     END                                            S01509
      *                                                                   S01510
      ** Check if Dividend Payments is installed                          S01510
      *                                                                   S01510
     C                     CALL 'AOSARDR0'                                S01510
     C                     PARM *BLANKS   @RTCD                           S01510
     C                     PARM '*VERIFY' @OPTN                           S01510
     C                     PARM 'S01510'  @SARD   6                       S01510
      *                                                                   S01510
     C           @RTCD     IFEQ *BLANK                                    S01510
     C                     MOVE 'Y'       S01510  1                       S01510
     C                     ELSE                                           S01510
     C                     MOVE 'N'       S01510                          S01510
     C                     END                                            S01510
      *                                                                   S01512
      ** Check if Position Settlements is installed                       S01512
      *                                                                   S01512
     C                     CALL 'AOSARDR0'                                S01512
     C                     PARM *BLANKS   @RTCD                           S01512
     C                     PARM '*VERIFY' @OPTN                           S01512
     C                     PARM 'S01512'  @SARD   6                       S01512
      *                                                                   S01512
     C           @RTCD     IFEQ *BLANK                                    S01512
     C                     MOVE 'Y'       S01512  1                       S01512
     C                     ELSE                                           S01512
     C                     MOVE 'N'       S01512                          S01512
     C                     END                                            S01512
      *                                                                   S01519
      ** Check if Position Settlements Automatic Charges is installed     S01519
      *                                                                   S01519
     C                     CALL 'AOSARDR0'                                S01519
     C                     PARM *BLANKS   @RTCD                           S01519
     C                     PARM '*VERIFY' @OPTN                           S01519
     C                     PARM 'S01519'  @SARD   6                       S01519
      *                                                                   S01519
     C           @RTCD     IFEQ *BLANK                                    S01519
     C                     MOVE 'Y'       S01519  1                       S01519
     C                     ELSE                                           S01519
     C                     MOVE 'N'       S01519                          S01519
     C                     END                                            S01519
      *                                                                   CEU005
      ** Check if EMU Settlement Ccy Conversion is installed              CEU005
      *                                                                   CEU005
     C                     CALL 'AOSARDR0'                                CEU005
     C                     PARM *BLANKS   @RTCD                           CEU005
     C                     PARM '*VERIFY' @OPTN                           CEU005
     C                     PARM 'CEU005'  @SARD   6                       CEU005
      *                                                                   CEU005
     C           @RTCD     IFEQ *BLANK                                    CEU005
     C                     MOVE 'Y'       CEU005  1                       CEU005
     C                     ELSE                                           CEU005
     C                     MOVE 'N'       CEU005                          CEU005
     C                     END                                            CEU005
      *                                                                   CSE023
      ** Check if CSE023 - Treaty withholding Tax is switched ON          CSE023
      *                                                                   CSE023
     C                     CALL 'AOSARDR0'                                CSE023
     C                     PARM *BLANKS   @RTCD                           CSE023
     C                     PARM '*VERIFY' @OPTN                           CSE023
     C                     PARM 'CSE023'  @SARD   6                       CSE023
      *                                                                   CSE023
     C           @RTCD     IFEQ *BLANK                                    CSE023
     C                     MOVE 'Y'       CSE023  1                       CSE023
     C                     ELSE                                           CSE023
     C                     MOVE 'N'       CSE023                          CSE023
     C                     ENDIF                                          CSE023
      *                                                                                       CSE028
      ** Check if CSE028 - MT5xx Standing Settlements Instructions is                         CSE028
      **   is switched on.                                                                    CSE028
      *                                                                                       CSE028
     C                     CALL 'AOSARDR0'                                                    CSE028
     C                     PARM *BLANKS   @RTCD                                               CSE028
     C                     PARM '*VERIFY' @OPTN                                               CSE028
     C                     PARM 'CSE028'  @SARD                                               CSE028
      *                                                                                       CSE028
     C           @RTCD     IFEQ *BLANK                                                        CSE028
     C                     MOVE 'Y'       CSE028  1                                           CSE028
     C                     ELSE                                                               CSE028
     C                     MOVE 'N'       CSE028                                              CSE028
     C                     ENDIF                                                              CSE028
      *                                                                   S01447
      ***  Define like field definitions                                  S01447
      *                                                                   S01447
      *                                                                   S01408
     C/COPY WNCPYSRC,SE4860C004                                           S01408
      *                                                                   S01408
     C                     MOVE ' '       WWDATA  1
      *                                                                   CSE023
     C           *LIKE     DEFN SRAC      STLA
     C           *LIKE     DEFN SRSM      STLT
     C           *LIKE     DEFN SDCP      PCFA
     C           *LIKE     DEFN CPDP      UCPDP
     C           *LIKE     DEFN CFCT      UCFCT
     C           *LIKE     DEFN CLOC      UBRLOC           brch ctry      S01447
     C           *LIKE     DEFN S1RASO    UTXRSR           src tax rate   S01447
     C           *LIKE     DEFN TBRASR    UTXRRF           ref tax rate   S01447
     C           *LIKE     DEFN TBRAUS    UTXRUS           usr tax rate   S01447
     C           *LIKE     DEFN TBDLOR    UDLOR            ded.tax local  S01447
     C           *LIKE     DEFN PTFR      PRVPTF
     C           *LIKE     DEFN CDPT      PRVDEP
     C           *LIKE     DEFN CDCN      PRVCUS
     C           *LIKE     DEFN CDPA      PRVBRA
      *
     C* Set up the pgm name                                                                   234440
     C*                                                                                       234440
     C                     MOVEL'SEETCPRT'WPGM    9                                           234440
     C                     MOVE 'V'       WPGM                                                234440
     C*                                                                                       234440
      *  DEPOT NAME INFORMATION - LF/CLINT (PF/CLINTSE)
      *
     C           CLINTK    KLIST
     C*******              KFLD           WCLNTK  60                      HUT118
     C                     KFLD           WCLNTK  6                       HUT118
     C                     KFLD           WLIT1   1
      *
      * GET COUNTRY LOCATION - LF/CLINT (PF/CLINTCB)                      S01447
      *                                                                   S01447
     C           CLKYCB    KLIST                                          S01447
     C**********           KFLD           WCUST   60               S01447 HUT118
     C                     KFLD           WCUST   6                       HUT118
     C                     KFLD           WRTYP   1                       S01447
      *                                                                   S01447
      * CHECK FOR DATABASE ERRORS
      *
     C           *IN99     IFEQ '1'
     C                     GOTO EAUDIT
     C                     END
      *
      * DEFINE AND CLEAR WORK FIELDS
      *
     C           *LIKE     DEFN P9SDSN    K9SDSN
     C           *LIKE     DEFN P9SDED    K9SDED
     C           *LIKE     DEFN P9SDET    K9SDET
      *
     C           *LIKE     DEFN P9SDSN    SASN
     C           *LIKE     DEFN CSSC      WCSSC
     C           *LIKE     DEFN CSCN      WCSCN
     C           *LIKE     DEFN CSBA      WCSBA                           S01117
     C           *LIKE     DEFN CSDA      WCSDA
     C           *LIKE     DEFN RECI      WSRECI
     C           *LIKE     DEFN CFCT      WACF                            052254
      *                                                                   095066
      *** Check if Value date position is to be used for Dividend.        095066
      *                                                                   095066
     C                     CALL 'AOSARDR0'                                095066
     C                     PARM '       ' @RTCD   7                       095066
     C                     PARM '*VERIFY' @OPTN   7                       095066
     C                     PARM 'CSE008'  @SARD   6                       095066
      *                                                                   095066
     C           @RTCD     IFEQ *BLANKS                                   095066
     C                     MOVE 'Y'       CSE008  1                       095066
     C                     ELSE                                           095066
     C                     MOVE 'N'       CSE008                          095066
     C                     ENDIF                                          095066
      *
      ** Access SC Switchable features of SCSARDPD if HUT103 is installed                     HUT103
      *                                                                                       HUT103
     C                     CALL 'AOSARDR0'                                                    HUT103
     C                     PARM *BLANKS   @RTCD                                               HUT103
     C                     PARM '*VERIFY' @OPTN                                               HUT103
     C                     PARM 'HUT103'  @SARD                                               HUT103
     C           SCSARD    PARM SCSARD    DSSDY                                               HUT103
      *                                                                                       HUT103
     C           @RTCD     IFEQ *BLANKS                                                       HUT103
     C                     MOVE 'Y'       HUT103  1                                           HUT103
     C                     ELSE                                                               HUT103
     C                     MOVE 'N'       HUT103                                              HUT103
     C                     ENDIF                                                              HUT103
      *                                                                                       HUT103
     C                     ENDSR
      *
      *================================================================
      /EJECT
      *****************************************************************   S01447
      *                                                               *   S01447
      *  GETCTY - Get Country of Branch                               *   S01447
      *                                                               *   S01447
      *  CALLED FROM: MAIN                                            *   S01447
      *                                                               *   S01447
      *****************************************************************   S01447
      *                                                                   S01447
     C           GETCTY    BEGSR                                          S01447
      *                                                                   S01447
     C                     CALL 'AOBRCHR0'                                S01447
     C                     PARM *BLANKS   @RTCD   7                       S01447
     C                     PARM '*KEY   ' @OPTN   7                       S01447
     C                     PARM CSBA      @BRCD   3                       S01447
     C           SDBRCH    PARM SDBRCH    DSFDY                           S01447
      *                                                                   S01447
     C           @RTCD     IFNE *BLANKS                    *B1            S01447
     C           *LOCK     IN   LDA                                       S01447
     C                     MOVEL'SDBRCHL1'DBFILE           ***************S01447
     C                     MOVELCSBA      DBKEY            ** DBERROR 019 S01447
     C                     Z-ADD19        DBASE            ***************S01447
     C                     SETON                       U7U8               S01447
     C                     EXSR *PSSR                                     S01447
     C                     GOTO EAUDIT                                    S01447
     C                     ELSE                            *X1            S01447
      *                                                                   S01447
     C                     MOVE A8BICN    WCUST                           S01447
     C           CLKYCB    CHAINCLINT                54    *B2            S01447
     C           *IN54     IFEQ '1'                                       S01447
     C           RECI      OREQ '*'                                       S01447
     C           *LOCK     IN   LDA                        ***************S01447
     C                     Z-ADD20        DBASE            * DBERROR 020 *S01447
     C                     MOVEL'CLINTCBF'DBFILE           ***************S01447
     C                     MOVELA8BICN    DBKEY                           S01447
     C                     SETON                       U7U8               S01447
     C                     EXSR *PSSR                                     S01447
     C                     GOTO EAUDIT                                    S01447
     C                     ELSE                            *X2            S01447
      *                                                                   S01447
     C                     MOVE CLOC      UBRLOC                          S01447
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C                     ENDSR                                          S01447
      *****************************************************************   S01447
      /EJECT                                                              S01447
      *****************************************************************
      *                                                               *
      * GETDEP   - GET CUST. POSITION RECORD TO UPDATE NEXT FOR THIS  *
      *            SECURITY ACTION.                                   *
      *                                                               *
      *****************************************************************
      *
     C           GETDEP    BEGSR                           ** GETDEP **
      *
     C                     Z-ADD*ZEROS    CMPDAT  50
      *
      *  IF,IN THIS SUBR,A CUST. IS IGNORED BECAUSE DATE OF EARLIEST
      *  POSITION IS GREATER THAN ACTION DATE, SEARCH FOR NEXT CUSTOMER
      *  RESUMES AT GETIN
      *                                                                   E21715
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE *BLANKS   PTFR                            S01486
     C                     END                                            S01486
      *
     C           GETIN     TAG                             ** GETIN  **
      *
      ** IF NEW SECURITY ACTION RECORD, USE SHORT KEY TO SETLL ON
      *  CPOSS FILE - LATEST DATES ONLY ARE ACCESSED VIA THIS LOGICAL
      *
     C           WNEWSC    IFEQ '1'
     C                     MOVE '0'       WNEWSC
     C                     CLEARWNEWCU
     C                     CLEARWNEWPT
     C                     CLEARWNEWBR
      *
      *
     C           @PHASE    IFEQ 'C'
      *
     C******     CPOSKY    SETLLSECUOFL0                 77       HUT118
     C           CPOSKY    SETLLXXCUOFV0                 77       HUT118
     C                     ELSE
     C******     CPOSKY    SETLLSECDUDL1                 77       HUT118
     C           CPOSKY    SETLLXXCDUDV1                 77       HUT118
     C                     END
      *
     C           *IN77     IFEQ '0'
     C                     MOVE '1'       *IN79
     C                     GOTO ENDDEP
     C                     END
     C                     END
      *
      ** READ THE NEXT SECURITY/CUST./BRANCH/LAST POSITION DATE
      *
     C           @PHASE    IFEQ 'C'
     C*******    CPOSKY    READESECUOFL0                 79       HUT118
     C           CPOSKY    READEXXCUOFV0                 79       HUT118
     C                     ELSE
     C*******    CPOSKY    READESECDUDL1                 79       HUT118
     C           CPOSKY    READEXXCDUDV1                 79       HUT118
     C                     END
     C           *IN79     CABEQ'1'       ENDDEP
     C           RECI      CABEQ'*'       GETIN
      *
     C           CSCN      IFEQ WNEWCU
     C           CSBA      ANDEQWNEWBR
     C                     GOTO GETIN
     C                     END
      *
      * SELECT THIS RECORD FOR UPDATE IF THE POSITION DATE (CSDA)
      * IS LESS THAN SECURITY ACTION DATE OR EQUAL TO IT IF ACTION TYPE
      * IS VALUE 'PP'.& S01486 ON
      *
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
      *
     C           P9SDET    IFEQ 'DV'                                      099266
     C           CSDA      ANDLEP9SDXD                                    099266
     C           S01510    ANDEQ'Y'                                       099266
      *
     C           P9SDET    ORNE 'MA'                                      S01486
     C           P9SDET    ANDNE'MG'                                      S01486
     C           CSDA      ANDLTP9SDED                                    S01486
     C           S01510    ANDEQ'N'                                       099266
      *
     C                     Z-ADDCSDA      CMPDAT  50
     C                     GOTO ENDDEP                                    S01486
     C                     END                                            S01486
     C                     ELSE                                           S01486
      *                                                                   S01510
      ** Select the record based on the following                         S01510
      ** ..event type is DV AND position date < ex-dividend date          S01510
      **        AND S01510 is active                                      S01510
      ** ..OR event type = MA AND position date <= security action date   S01510
      ** ..OR event type <> MA and position date < security action date   S01510
      **        AND S01510 is not active                                  S01510
      ** ..OR event type <> MA and DV and position < security action      S01510
      **        date AND S01510 is active                                 S01510
      *                                                                   S01510
     C           P9SDET    IFEQ 'DV'                                      S01510
     C           CSDA      ANDLTP9SDXD                                    164901
     C           S01510    ANDEQ'Y'                                       S01510
      *                                                                   S01510
     C           P9SDET    ORNE 'MA'                                      S01510
     C           P9SDET    ANDNE'MG'                                      S01510
     C           CSDA      ANDLTP9SDED                                    S01510
     C           S01510    ANDEQ'N'                                       S01510
      *                                                                   S01510
     C                     Z-ADDCSDA      CMPDAT  50
     C                     GOTO ENDDEP
     C                     END
     C                     END
      *
      ** SET UP KEY WITH BRANCH,CUST. AND ACTION DATE
      *
     C                     MOVE CSBA      WCSBA                           S01117
     C                     MOVE CSCN      WCSCN
      *
      ** If S01510 is active AND event type = DV, use ex-dividend date    S01510
      *                                                                   S01510
     C           S01510    IFEQ 'Y'                                       S01510
     C           P9SDET    ANDEQ'DV'                                      S01510
     C                     Z-ADDP9SDXD    WCSDA                           164901
     C                     ELSE                                           S01510
     C                     Z-ADDP9SDED    WCSDA
     C                     END                                            S01510
      *                                                                   S01486
      * CHECK WHETHER PORTFOLIO POSITIONS EXISTED FOR THE SECURITY        S01486
      * ON THE SECURITY ACTION EVENT DATE                                 S01486
      * SET PORTFOLIO POSITION FLAG                                       S01486
      *                                                                   S01486
     C           ENDDEP    TAG                                            S01486
     C                     MOVE 'N'       WPPOSN  1                       S01486
      *                                                                   S01486
      * CHECK IF CUSTOMER POSITION AND IF PM IS PRESENT ON THE SYSTEM     S01486
      * OR IF CUSTOMER POSITION AND IF PB IS PRESENT ON THE SYSTEM        CPB001
      *                                                                   S01486
     C           *IN79     IFEQ '0'                                       S01486
     C           BGPFMG    ANDEQ'Y'                                       S01486
     C           *IN79     OREQ '0'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
      *                                                                   S01486
      * SET POSITION DATE TO *LOVAL                                       S01486
      *                                                                   S01486
     C                     MOVE CSBA      WWCDPA  3                       189942
      *                                                                   S01486
      * SET LOWER LIMITS ON SECDEPL0 USING CUST. NO/ DEPOT REF            189942
      *                                                                   189942
     C           PMFPKY    SETLLSECDEPL0                                  189942
     C                     READ SECDEPL0                 75               189942
      *                                                                   189942
      * CHECK THAT RECORD EXISTS ON THE FILE FOR THE CUSTOMER             S01486
      *                                                                   S01486
     C           *IN75     IFEQ '0'                                       S01486
     C           CDCN      ANDEQCSCN                                      189942
     C           CDPA      ANDEQCSBA                                      189942
      *                                                                   S01486
      * CHECK SECURITY ACTION AND POSTING DATE                            S01486
      *                                                                   S01486
     C           P9SDET    IFEQ 'DV'                                      099266
     C           DDTE      ANDLTP9SDXD                                    189942
     C           S01510    ANDEQ'Y'                                       099266
      *                                                                   S01486
     C           P9SDET    ORNE 'MA'                                      S01486
     C           P9SDET    ANDNE'MG'                                      S01486
     C           DDTE      ANDLTP9SDED                                    189942
     C           S01510    ANDEQ'N'                                       099266
      *                                                                   S01486
      ** EXECUTE SUBROUTINE SECTIN TO RETRIEVE SECURITY RECORD            S01486
      *                                                                   S01486
     C                     MOVE P9SDSN    SASN                            189942
     C                     EXSR SECTIN                                    S01486
      *                                                                   S01486
      * CHECK SECURITY FOR MATURITY EVENT                                 S01486
      *                                                                   S01486
     C*****      P9SDET    IFEQ 'MA'                               S01486 CSE053
     C****                 MOVE 'Y'       WPPOSN                   S01486 CSE053
      *                                                                   S01486
      **  .... OTHERWISE THIS CUSTOMER POSITION SHOULD NOT BE PROCESSED   S01486
     C***********          ELSE                                   S01486  CSE053
      *                                                                   S01486
      ** RETURN TO SEARCH FOR NEXT CUSTOMER POSITION                      S01486
     C                     GOTO GETIN                                     S01486
     C************         END                                     S01486 CSE053
     C                     END                                            S01486
      *                                                                   S01486
     C                     END                                            S01486
     C                     END                                            S01486
     C/COPY WNCPYSRC,SE4860C005
      *
     C                     ENDSR                                          S01486
      *
      *
      *****************************************************************
      /EJECT
      ********************************************************************S01486
      *                                                                   S01486
      * GETPTF   - GET PORTFOLIO POSITIONS FOR A SECURITY.                S01486
      *                                                                   S01486
     C           GETPTF    BEGSR                           ** GETPTF **   S01486
      *          ******                                                   S01486
      *                                                                   S01486
     C                     Z-ADD*ZEROS    CMPDAT  50
      * CHECK THAT THIS IS THE FIRST SECURITY POSITION                    S01486
      *                                                                   S01486
     C           WSPOSN    IFEQ 'Y'                        B1             S01486
      *                                                                   S01486
      *                                                                   189942
      * SET LOWER LIMITS ON CURRENT POSITION FILE. LF/CDEPS               189942
      *                                                                   189942
     C           PMCPSS    SETLLCDEPS                                     189942
     C                     END                             E1             S01486
      *                                                                   S01486
      * READ CURRENT POSITIONS BY SECURITY FILE                           S01486
      *                                                                   S01486
     C           RDNEXT    TAG                                            S01486
      *                                                                   S01486
     C           PMCPSS    READECDEPS                    76               189942
      *                                                                   S01486
      * DO WHILE RECORDS EXIST FOR THE SECURITY                           S01486
      *                                                                   S01486
     C           *IN76     IFEQ '0'                        B1             S01486
      *
      *                                                                   S01486
     C                     MOVE CDCN      WWCNUM                          189942
     C                     MOVE PTFR      WWPTFR                          189942
     C                     MOVE CDSN      WWTDSS                          189942
     C                     MOVE CDPT      WWCDPT                          206604
      *                                                                   S01486
      * CHECK SECURITY ACTION AND POSTING DATE                            S01486
      *                                                                   S01486
     C           P9SDET    IFNE 'MA'                                      S01486
     C           P9SDET    ANDNE'MG'                                      S01486
     C           DDTE      ANDLTP9SDED                                    189942
     C           S01510    ANDEQ'N'                                       099266
      *                                                                   S01486
     C           P9SDET    OREQ 'DV'                                      094839
     C           DDTE      ANDLEP9SDXD                                    189942
     C           S01510    ANDEQ'Y'                                       094839
      *                                                                   S01486
      * VALID RECORD - EXIT TO GENERATE POSITION SETTLEMENTS              S01486
      *                                                                   S01486
     C                     Z-ADDDDTE      CMPDAT  50
     C                     GOTO ENDPTF                                    S01486
     C                     END                             E2             S01486
      *                                                                   S01486
      * DETERMINE WHETHER POSITION EXISTED BEFORE SECURITY ACTION         S01486
      * SET GREATER THAN ON PMVPOSLL WITH KEY OF CUSTOMER/                S01486
      * PORTFOLIO REF./ SECURITY/ SECURITY ACTION DATE                    S01486
      *                                                                   S01486
     C                     MOVE CDPA      WWCDPA                          189942
     C                     MOVE CDCN      WWCNUM                          189942
     C                     MOVE PTFR      WWPTFR                          189942
     C                     MOVE CDSN      WWTDSS                          189942
     C                     MOVE CDPT      WWCDPT                          189942
     C                     MOVE CDMK      WWCDMK                          189942
     C                     MOVE P9SDED    WWDDTE                          189942
      ** If S01510 is active AND event type = DV, use ex-dividend date    206604
      *                                                                   206604
     C           S01510    IFEQ 'Y'                                       206604
     C           P9SDET    ANDEQ'DV'                                      206604
     C                     MOVE P9SDXD    WWDDTE                          206604
     C                     END                                            206604
      *                                                                   189942
     C           PMVPKY    SETGTSECDEPL5                                  189942
     C                     READPSECDEPL5                 74               189942
      *                                                                   189942
      * CHECK RECORD EXISTS FOR CUST/PORTFOLIO REFERENCE/SECURITY         S01486
      *                                                                   S01486
     C           *IN74     IFEQ '0'                        B2             S01486
     C           CDCN      ANDEQWWCNUM                                    189942
     C           PTFR      ANDEQWWPTFR                                    189942
     C           CDSN      ANDEQWWTDSS                                    189942
      *                                                                   S01486
      * CHECK SECURITY ACTION                                             S01486
      *                                                                   S01486
      *                                                                   S01486
      * CHECK POSTING DATE IS LESS THAN EVENT DATE                        S01486
      *                                                                   S01486
     C           DDTE      IFLT P9SDXD                                    189942
     C           P9SDET    ANDEQ'DV'                                      099266
     C*                                                                   S01486
      * VALID RECORD - EXIT TO GENERATE POSITION SETTLEMENTS              S01486
      *                                                                   S01486
     C                     Z-ADDDDTE      CMPDAT  50
     C                     GOTO ENDPTF                                    S01486
     C                     END                             E4             S01486
      *                                                                   S01486
      * READ PREVIOUS RECORD                                              S01486
      *                                                                   S01486
     C                     READPSECDEPL5                 74               189942
      *                                                                   S01486
      * CHECK RECORD EXISTS FOR CUST/PORTFOLIO REFERENCE/SECURITY         S01486
      *                                                                   S01486
     C           *IN74     IFEQ '0'                        B3             S01486
     C           CDCN      ANDEQWWCNUM                                    189942
     C           PTFR      ANDEQWWPTFR                                    189942
     C           CDSN      ANDEQWWTDSS                                    189942
      *                                                                   S01486
      * RECORD EXISTS - EXIT PROCESS                                      S01486
      *                                                                   S01486
     C                     Z-ADDDDTE      CMPDAT  50
     C                     GOTO ENDPTF                                    S01486
     C                     END                             E3             S01486
      *                                                                   S01486
     C                     END                             E2             S01486
     C                     GOTO RDNEXT                                    S01486
     C                     END                             E1             S01486
      *                                                                   S01486
      * SET NO MORE POSITIONS TO PROCESS FLAG                             S01486
      *                                                                   S01486
     C                     MOVE 'N'       WPORTP                          S01486
      *                                                                   S01486
     C           ENDPTF    ENDSR                            **ENDPTF**    S01486
      *                                                                   S01486
      ********************************************************************S01486
      /EJECT                                                              S01486
      *****************************************************************
      *                                                               *
      *  DIVIDN - Subroutine to produce Dividend Account Keys and/or  *
      *           Position Settlements.                               *
      *                                                               *
      *****************************************************************
      *
     C           DIVIDN    BEGSR                           ** DIVIDN **
      *
      ** CALCULATE DIVIDEND DUE
      *
      * NOMINAL DECIMAL PLACES RETRIEVED - NOW USE CCY TO GET CCY DP
      ** IF S01509 is active, user value ccy instead of nominal ccy       S01509
      *
     C           S01509    IFEQ 'Y'                                       S01509
     C                     MOVE VLCY      WCURR   3                       S01509
     C                     ELSE                                           S01509
     C                     MOVE NMCY      WCURR   3
     C                     END                                            S01509
     C                     EXSR TG10
      *                                                                   S01446
      ** For Courtage Enhancement, if Autocharge option is 'Y' and        S01446
      ** charge currency is not blank, update fields                      S01446
      *                                                                   S01446
     C           S01446    IFEQ 'Y'                                       S01446
     C           BVACOP    ANDEQ'Y'                                       S01446
     C           BVCHRC    ANDNE*BLANKS                                   S01446
      *                                                                   S01446
      ** Get M/D indicator and spot rate of input ccy from SDCURRPD       S01446
      *                                                                   S01446
     C                     Z-ADD25        WDBAS1  30                      S01446
     C                     EXSR #LCURR                                    S01446
     C                     Z-ADDA6SPRT    ZRATE2 138                      S01446
     C                     MOVE A6MDIN    ZMDI2   1                       S01446
     C                     Z-ADDTXSPOT    ZRATE1 138                      S01446
     C                     MOVE TXMDI     ZMDI1   1                       S01446
     C                     EXSR ZXRATE                                    S01446
     C                     MOVE ZRATEX    TRATEX 138                      S01446
     C                     MOVE ZMDIX     TMDIX   1                       S01446
     C                     END                                            S01446
      *                                                                   E19610
      *  FOR DIVIDENDS, CALCULATE CUM-COUPON VALUE USING THE TRADE DATE   E19610
      *  POSITION INSTEAD OF THE VALUE DATE.                              E19610
      ** If S01510 is active, the cum-coupon value must be the trade      S01510
      ** nominal                                                          S01510
      *** (Use Value date position if required)                           095066
      *                                                                   095066
      *                                                                   E19610
     C           S01510    IFEQ 'Y'                                       S01510
     C           CSE008    IFNE 'Y'                                       095066
     C                     Z-ADDCSNT      WCUMCP                          S01510
     C                     ELSE                                           095066
     C                     Z-ADDCSNV      WCUMCP                          095066
     C                     END                                            095066
     C                     ELSE                                           S01510
     C           CSE008    IFNE 'Y'                                       095066
     C           CSNT      SUB  CSEX      WCUMCP                          E19610
     C                     ELSE                                           095066
     C           CSNV      SUB  CSEX      WCUMCP                          095066
     C                     END                                            093385
     C                     END                                            095066
     C*                                                                   093385
     C           WPORTP    IFEQ 'Y'                                       S01486
     C           BGPFMG    ANDEQ'Y'                                       S01486
     C           WPORTP    OREQ 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           CDNT      SUB  CSEX      WCUMCP                          189942
     C                     END                                            S01486
      *
      ** Check if Position Settlement already existing
     C                     EXSR #CHKPS
      *
      *
      * If Positions found, and returned value is zero, then do not create Position
      *    Settlement and skip to end routine
     C           ZFOUND    IFEQ 'Y'
     C           ZNWCMP    ANDEQ0
     C                     GOTO ENDDIV
     C                     END
      *
      *
      * IF an Adjustment amount has been found on POSETD (by XX118006)
      *    then replace amount
      *
     C           ZFOUND    IFEQ 'Y'                        B* ZFOUND
     C           ZNWCMP    ANDNE0
     C                     Z-ADDZNWCMP    WCUMCP 150
     C                     END
      *
      *
      * DIVIDEND DUE CALCULATION
      * CUM-COUPON MULTIPLIED BY AMOUNT PER UNIT (P9SDED
      * GIVING WORK (15/4). MULTIPLY BY POWER VALUE AND RESULT IN 13/0
      *
      ** IF PRICE BASIS (SECTYD) IS 'P', DIVIDE BY 100
      *
     C                     Z-ADDWCUMCP    ZNOML                           E22638
     C                     Z-ADDP9SDVA    ZPRC                            E22638
     C                     EXSR ZCNSD                                     E22638
     C                     Z-ADDZCONS     WDIVDU 150                      E22638
     C/COPY WNCPYSRC,SE4860C006
      *
      ** IF POSITION SETTLEMENT REQUIRED WRITE POSN SETLL.IN SUBR W02
      *
     C/COPY WNCPYSRC,SE4860C007
     C           CDSN      IFEQ CSSC                                      206604
     C                     MOVE 'DV'      PEVT
     C                     Z-ADDWCUMCP    PNMP
     C           WDIVDU    IFLT 0
     C                     Z-SUBWDIVDU    PAMD
     C/COPY WNCPYSRC,SE4860C008
     C                     ELSE
     C                     Z-ADDWDIVDU    PAMD
     C/COPY WNCPYSRC,SE4860C009
     C                     END
     C           WCUMCP    IFGT 0
     C                     MOVE 'P'       PPRE                            E14704
     C                     ELSE
     C                     MOVE 'R'       PPRE                            E14704
     C                     END
     C                     EXSR W02
     C                     END                                            206604
     C/COPY WNCPYSRC,SE4860C010
      *
      * Check if SDDT is to be update
     C                     EXSR #EVUPD
      *
     C           ENDDIV    ENDSR                           **ENDDIV**
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W02    - Subroutine to Write a Position Settlement.          *
      *                                                               *
      *****************************************************************
      *
     C           W02       BEGSR                           **   W02  **
     C/COPY WNCPYSRC,SE4860C022
      *
      ** DO NOT OUPUT RECORDS IF AMOUNT DUE IS ZERO
      *
     C           PAMD      CABEQ0         ENDW02                          144812
      *                                                                   156491
     C           WSRECI    IFEQ 'R'                                       156491
     C           PPRE      IFEQ 'R'                                       156491
     C                     MOVEL'P'       PPRE                            156491
     C                     ELSE                                           156491
     C           PPRE      IFEQ 'P'                                       156491
     C                     MOVEL'R'       PPRE                            156491
     C                     ENDIF                                          156491
     C                     ENDIF                                          156491
     C                     ENDIF                                          156491
     C/COPY WNCPYSRC,SE4860C023
      *
      * COUNT RECORDS WRITTEN
      *
      *
     C                     MOVE 'D'       RECI
     C                     MOVE MKTI      PMAR                            162208
     C                     MOVE CSBA      PBCA                            E33032
     C                     MOVE CSSC      PSSH
     C                     MOVELCSCN      PCPY             ??10A/6N
     C                     MOVE *BLANKS   DEPT
      *                                                                   CSE023
      ** Set up of field CTYP moved to before call to SE2310 to           187805
      ** avoid corruption when CLINTCB is read.                           187805
     C                     Z-ADD0         BAUS                            CSE023
     C                     Z-ADD0         MAMT                            CSE023
     C                     Z-ADD0         DAMT                            CSE023
     C                     Z-ADD0         PSEQ                            CSE023
     C                     Z-ADD0         SABC                            CSE023
     C                     Z-ADD0         TXNM                            HUT118
     C                     Z-ADD0         TXST                            HUT118
     C                     Z-ADD0         TAXA                            HUT118
     C           WPORTP    IFEQ 'Y'                                       081336
     C           BGPFMG    ANDEQ'Y'                                       081336
     C           WPORTP    OREQ 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE CDSN      PSSH                            189942
     C                     MOVE CDCN      PCPY                            189942
     C                     MOVE CDPT      DEPT                            HUT118
     C********             Z-ADDCDCN      WCLNTK                   189942 HUT118
     C                     MOVELCDCN      WCLNTK                          HUT118
      *                                                                   189942
      ** SETUP BRANCH CODE FROM CDEPPD                                    189942
     C                     MOVE CDPA      PBCA                            189942
     C                     END                                            081336
      *                                                                   S01512
      ** If S01512 is active, the payment value date for dividends must   S01512
      ** be the value date entered in the diary                           S01512
      *                                                                   S01512
     C           P9SDET    IFEQ 'DV'
     C           S01512    ANDNE'Y'                                       088423
     C                     Z-ADDP9SDPD    PDUD
     C                     ELSE
     C                     Z-ADDP9SDED    PDUD
     C                     END
     C/COPY WNCPYSRC,SE4860C024
      *                                                                   S01512
      ** Value date - initially defaulted to PDUD.                        S01512
      ** If S01512 is active, value date should be the date of the next   S01512
      ** working day after value date in value currency.  For dividends   S01512
      ** payment value date must be the value date entered in the diary   S01512
      *                                                                   S01512
      *                                                                   S01512
     C           APNS      IFEQ 'Y'
     C                     MOVE 'Y'       PAUI
     C                     MOVE 'Y'       PSMI                            S01401
     C                     ELSE
     C                     MOVE ' '       PAUI
     C                     END
     C           BGPFMG    IFEQ 'Y'                                       081336
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE VLCY      PNCY                            081336
     C                     ELSE                                           081336
     C                     MOVE NMCY      PNCY
     C                     END                                            081336
      *                                                                   S01509
      ** If S01509 is active, position currency could be equal to value   S01509
      ** ccy, redemption ccy or nominal ccy depending on the event type   S01509
      *                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C                     SELEC                                          S01509
     C           P9SDET    WHEQ 'DV'                                      S01509
     C                     MOVE VLCY      PNCY                            S01509
     C                     ENDSL                                          S01509
      *                                                                   S01509
     C                     ELSE                                           S01509
     C                     MOVE NMCY      PNCY
     C                     ENDIF                                          S01509
      **
      ** Value date - initially defaulted to PDUD.                        105035
      ** If S01512 is active, value date should be the date of the next   105035
      ** working day after value date in value currency.  For dividends   105035
      ** payment value date must be the value date entered in the diary   105035
      *                                                                   105035
     C           S01512    IFEQ 'Y'                                       105035
     C           P9SDET    IFEQ 'DV'                                      105035
     C           P9SDPD    SUB  1         ZDAYNO                          105035
     C                     ELSE                                           105035
     C           PDUD      SUB  1         ZDAYNO                          105035
     C                     ENDIF                                          105035
     C                     Z-ADD1         ZNRDYS                          105035
     C                     MOVE PNCY      ZCCY                            105035
     C                     EXSR ZFWDT                                     105035
     C                     Z-ADDZDYNBR    PSVL                            105035
     C                     ELSE                                           105035
     C           P9SDET    IFEQ 'DV'                                      105035
     C                     Z-ADDP9SDPD    PSVL                            105035
     C                     ELSE                                           105035
     C                     Z-ADDPDUD      PSVL                            105035
     C                     ENDIF                                          105035
     C                     END                                            105035
      *                                                                   S01509
     C                     MOVE DPFB      PBCD                            E14718
     C                     MOVE '0'       PYCUSD  1
      *                                                                   E23169
      ** Payment currency and settlement exchange rate are held on        E23169
      ** SECTYD for straight, dual- and multi-currency securities.        E23169
      ** Exchange rate=1 for straight securities.                         E23169
      ** If S01509 is active, settle = pos currency, exchange rate is     S01509
      ** 1 with mult/div indicator as 'M'                                 S01509
      *                                                                   E23169
     C           S01509    IFEQ 'Y'                                       S01509
     C                     MOVE PNCY      PSCU                            S01509
     C                     Z-ADD1         PSXR                            S01509
     C                     MOVE 'M'       PMDI                            S01509
     C                     ELSE                                           S01509
     C                     MOVE SPYC      PSCU                            E23169
     C                     Z-ADDSEXR      PSXR                            E23169
     C                     MOVE SMDI      PMDI                            E23169
     C                     END                                            S01509
      *                                                                   E23169
      *                                                                   E23169
      ***CALCULATE*SETTLEMENT*EXCHANGE*RATE*-*CHECK*FLAG*PYCUSD********** E23169
      *                                                                   E23169
      *                                                                   E23169
      *                                                                   E23169
     C/COPY WNCPYSRC,SE4860C025
      *
      ** BASIC CURR EXCHANGE RATE IS SPOT RATE FOR SETTLEMENT CURRCY
      *
     C                     MOVE PSCU      WCURR
     C                     EXSR TG10
     C                     Z-ADDSPOT      PBRX
     C/COPY WNCPYSRC,SE4860C026
      *
      ** ACCESS STANDARD SETTLEMENT INSTRUCTIONS FILE
      *
     C                     MOVE PBCA      SBRA                            E33032
     C                     MOVELPCPY      CSTM
     C                     MOVE PSCU      CYSI
     C                     MOVE SITP      ITSI
     C                     MOVE *BLANK    PSEA
     C                     MOVE *BLANK    PSEB
     C                     MOVE *BLANK    PCPN
     C                     MOVE *BLANK    PFAC
     C                     MOVE *BLANK    PSPI
     C                     MOVE *ZEROS    PSMT                            048612
      *                                                                                       CSE028
      ** If CSE028 is on, call SESSIR0 for default of MT5xx information                       CSE028
      *                                                                                       CSE028
     C           CSE028    IFEQ 'Y'                                                           CSE028
      *                                                                                       CSE028
     C                     MOVEL*BLANKS   WBKCD                                               CSE028
     C                     MOVELPTFR      WPTFR                                               CSE028
     C                     MOVELCSTM      WCUST2  6                                           CSE028
      *                                                                                       CSE028
     C                     CALL 'SESSIR0'                                                     CSE028
     C                     PARM 'D'       POTYP   1                                           CSE028
     C                     PARM SBRA      PSBRA   3                                           CSE034
     C                     PARM           WCUST2                                              CSE028
     C                     PARM           WBKCD                                               CSE028
     C                     PARM CYSI      PCYSI   3                                           CSE034
     C                     PARM SMCC      PMKTC   2                                           CSE034
     C                     PARM ITSI      PITSI   3                                           CSE034
     C                     PARM           WPTFR                                               CSE028
     C                     PARM           PCBSTD                                              CSE028
     C                     PARM           PCBSAD                                              CSE028
     C                     PARM *BLANKS   PRTCD   5                                           CSE028
      *                                                                                       CSE028
     C           PRTCD     IFNE '*NCRF'                                                       CSE028
     C           PRTCD     ANDNE'*NRF '                                                       CSE028
     C           2         OCUR PCBSTD                                                        CSE028
     C                     MOVE '0'       *IN77                                               CSE028
     C                     ELSE                                                               CSE028
     C                     MOVE '1'       *IN77                                               CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C                     ELSE                                                               CSE028
      *                                                                                       CSE028
     C                     MOVEL*BLANKS   WBKCD                                               CSE028
     C                     MOVEL*BLANKS   WPTFR                                               CSE028
      *                                                                                       CSE028
     C                     MOVE PCPY      WCLNTK                          E16085
     C           CLINTK    CHAINCLINT                99                   E16085
     C           *IN99     IFEQ '0'                                       E16085
     C           C1DI      ANDNE'M'                                       E16085
     C                     MOVE *BLANK    ITSI                            E16085
     C                     END                                            E16085
     C/COPY WNCPYSRC,SE4860C027
     C           STDSKY    CHAINSTDSED               77
      *                                                                                       CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C/COPY WNCPYSRC,SE4860C028
     C           *IN77     IFNE '1'
     C           RECI      ANDNE'*'
      *                                                                   147514
     C                     MOVE *OFF      *IN88                           147514
      *                                                                   CEU005
      * CEU005 active and Settlement Ccy used on STDSED.                  CEU005
     C           CEU005    IFEQ 'Y'                                       CEU005
     C           SCCY      ANDNE*BLANKS                                   CEU005
      *                                                                   CEU005
      * Access currencies file for EURO rate, EURO M/D indicator and      CEU005
      * Transition Date for 'In' Ccy.                                     CEU005
      * Settlement Currency is 'IN' ccy.                                  CEU005
      *                                                                   CEU005
     C           PSCU      IFEQ BKEURO                                    CEU005
     C                     CALL 'AOCURRR0'                                CEU005
     C                     PARM           @RTCD   7                       CEU005
     C                     PARM '*KEY   ' @OPTN   7                       CEU005
     C                     PARM SCCY      @AJCD   3                       CEU005
     C           SDCURR    PARM SDCURR    DSSDY                           CEU005
      * Database error                                                    CEU005
     C           @RTCD     IFNE *BLANKS                                   CEU005
     C                     Z-ADD44        DBASE            ************** CEU005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 44* CEU005
     C                     MOVELSCCY      DBKEY            ************** CEU005
     C                     EXSR *PSSR                                     CEU005
     C                     ENDIF                                          CEU005
      *                                                                   CEU005
      * Due currency is 'IN' ccy.                                         CEU005
      *                                                                   CEU005
     C                     ELSE                                           CEU005
     C           SCCY      IFEQ BKEURO                                    CEU005
     C                     CALL 'AOCURRR0'                                CEU005
     C                     PARM           @RTCD   7                       CEU005
     C                     PARM '*KEY   ' @OPTN   7                       CEU005
     C                     PARM PSCU      @AJCD   3                       CEU005
     C           SDCURR    PARM SDCURR    DSSDY                           CEU005
      * Database error                                                    CEU005
     C           @RTCD     IFNE *BLANKS                                   CEU005
     C                     Z-ADD45        DBASE             ************* CEU005
     C                     MOVEL'SDCURRPD'DBFILE            * DB ERROR 45*CEU005
     C                     MOVELPSCU      DBKEY             **************CEU005
     C                     EXSR *PSSR                                     CEU005
     C                     ENDIF                                          CEU005
     C                     ENDIF                                          CEU005
     C                     ENDIF                                          CEU005
      *                                                                   CEU005
      * Value date is later than Transition Start Date.                   CEU005
     C           PSVL      IFGE A6TPSD                                    CEU005
     C           A6INCY    ANDEQ'Y'                                       143690
     C                     Z-ADDA6EUER    PSXR                            CEU005
      *                                                                   CEU005
      **Settlement*ccy*is*Euro*currency,*reverse*M/D*indicator.    CEU005 143690
      ** Nominal ccy is Euro currency, reverse M/D indicator.             143690
     C           PSCU      IFEQ BKEURO                                    143690
     C           A6EUMD    IFEQ 'M'                                       CEU005
     C                     MOVE 'D'       PMDI                            CEU005
     C                     ELSE                                           CEU005
     C                     MOVE 'M'       PMDI                            CEU005
     C                     ENDIF                                          CEU005
      *                                                                   CEU005
      **Settlement*ccy*not*Euro*ccy,*use*Euro*M/D*indicator.       CEU005 143690
      ** Settlement ccy is Euro ccy, use Euro M/D indicator.              143690
     C                     ELSE                                           CEU005
     C                     MOVE A6EUMD    PMDI                            CEU005
     C                     ENDIF                                          CEU005
      *                                                                   CEU005
      * Use standard settlement ccy for position settlement ccy           CEU005
     C                     MOVE SCCY      PSCU                            CEU005
      * Chain STDSED again.                                               CEU005
     C                     MOVE SCCY      CYSI                            CEU005
      *                                                                                       CSE028
      ** If CSE028 is on, call SESSIR0 for default of MT5xx information                       CSE028
      *                                                                                       CSE028
     C           CSE028    IFEQ 'Y'                                                           CSE028
      *                                                                                       CSE028
     C                     CALL 'SESSIR0'                                                     CSE028
     C                     PARM 'D'       POTYP   1                                           CSE028
     C                     PARM SBRA      PSBRA                                               CSE034
     C                     PARM           WCUST2                                              CSE028
     C                     PARM           WBKCD                                               CSE028
     C                     PARM CYSI      PCYSI                                               CSE034
     C                     PARM SMCC      PMKTC                                               CSE034
     C                     PARM ITSI      PITSI                                               CSE034
     C                     PARM           WPTFR                                               CSE028
     C                     PARM           PCBSTD                                              CSE028
     C                     PARM           PCBSAD                                              CSE028
     C                     PARM *BLANKS   PRTCD                                               CSE028
      *                                                                                       CSE028
     C           PRTCD     IFNE '*NCRF'                                                       CSE028
     C           PRTCD     ANDNE'*NRF '                                                       CSE028
     C           2         OCUR PCBSTD                                                        CSE028
     C                     MOVE '0'       *IN88                                               CSE028
     C                     ELSE                                                               CSE028
     C                     MOVE '1'       *IN88                                               CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C                     ELSE                                                               CSE028
      *                                                                                       CSE028
     C           STDSKY    CHAINSTDSED               88                   147514
      *                                                                                       CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C/COPY WNCPYSRC,SE4860C029
     C                     ENDIF                                          175400
     C                     ENDIF                                          175400
      *                                                                   CEU005
      * If no record found ensure fields from last chain not loaded       CEU005
      * to output fields.                                                 CEU005
     C           *IN88     IFEQ *ON                                       147514
     C           CEU005    ANDEQ'Y'                                       175400
     C                     MOVE *BLANKS   STLA                            CEU005
     C                     Z-ADD0         STLT                            CEU005
     C                     MOVE *BLANKS   PSMT                            CEU005
     C                     MOVE *BLANKS   PSEA                            CEU005
     C                     MOVE *BLANKS   PSEB                            CEU005
     C                     MOVE *BLANKS   PCPN                            CEU005
     C                     MOVE *BLANKS   PFAC                            CEU005
     C                     MOVE *BLANKS   PSPI                            CEU005
     C                     MOVE *BLANKS   PRCNUM                          CEU005
     C                     MOVE *BLANKS   PRACOD                          CEU005
     C                     MOVE *BLANKS   PRACSQ                          CEU005
     C                     MOVE *BLANKS   PPFC                            CEU005
     C                     ELSE                                           CEU005
      *
      ** USE RECEIVE FIELDS IF PAY/RECEIVE IND IS SET TO P
      *
     C           PPRE      IFEQ 'P'
     C                     MOVE SPSM      PSMT
     C                     MOVE SPAT      PSEA
     C                     MOVE SPBA      PSEB                            S01117
     C                     MOVE SPCB      PCPN
     C                     MOVE SPFA      PFAC
     C                     MOVE SPSI      PSPI
      *                                                                   103361
     C                     MOVE SPAT      STLA                            103361
     C                     Z-ADDSPSM      STLT                            103361
      *                                                                   103361
      *                                                                   103361
      ** If settlement method is '04' and settlement account is blank,    103361
      ** retrieve prime account number                                    103361
      *                                                                   103361
     C           SPSM      IFEQ 04                                        103361
     C           SPAT      ANDEQ*BLANKS                                   103361
      *                                                                   103361
      * Retrieve prime account                                            103361
      *                                                                   103361
     C                     MOVE CSTM      PRCNUM                          103361
     C                     MOVE BMACCD    PRACOD                          103361
     C                     MOVE '01'      PRACSQ                          103361
      *                                                                   103361
     C                     MOVE PRACCT    STLA                            103361
     C                     MOVE PRACCT    PSEA                            103361
     C                     END                                            103361
      *                                                                   103361
     C                     ELSE
     C*
     C** USE PAY FIELDS IF PAY/RECEIVE IND IS SET TO R
     C*
     C           PPRE      IFEQ 'R'
     C                     MOVE SRSM      PSMT
     C                     MOVE SRAC      PSEA
     C                     MOVE SRAB      PSEB                            S01117
     C                     MOVE SRCB      PCPN
     C                     MOVE *BLANK    PFAC
     C                     MOVE *BLANK    PSPI
      *                                                                   103361
     C                     MOVE SRAC      STLA                            103361
     C                     Z-ADDSRSM      STLT                            103361
      *                                                                   103361
      ** If settlement method is '04' and settlement account is blank,    103361
      ** retrieve prime account number                                    103361
      *                                                                   103361
     C           STLT      IFEQ 04                                        103361
     C           STLA      ANDEQ*BLANKS                                   103361
      *                                                                   103361
      * Retrieve prime account                                            103361
      *                                                                   103361
     C                     MOVE CSTM      PRCNUM                          103361
     C                     MOVE BMACCD    PRACOD                          103361
     C                     MOVE '01'      PRACSQ                          103361
      *                                                                   103361
     C                     MOVE PRACCT    STLA                            103361
     C                     MOVE PRACCT    PSEA                            103361
     C                     END                                            103361
      *                                                                   103361
     C                     END
     C                     END
     C                     END                                            CEU005
      *                                                                   093817
      * OTHERWISE CHECK FOR ACCOUNT IN CUSTOMER CURRENCY                  093817
     C                     ELSE                                           093817
     C*********            Z-ADDPCPY      WCLNTK                   093817 HUT118
     C                     MOVELPCPY      WCLNTK                          HUT118
     C                     MOVE '1'       WLIT1                           093817
     C                     EXSR CLNTIN                                    093817
      * PERFORM P07 TO SET UP SETTLEMENT DETAILS                          093817
     C                     EXSR P07                                       093817
      *                                                                   093817
     C/COPY WNCPYSRC,SE4860C030
     C                     END
     C*                                                                   084669
     C           PSEB      IFEQ *BLANKS                                   084669
     C                     MOVE PBCA      PSEB                            084669
     C                     END                                            084669
     C/COPY WNCPYSRC,SE4860C031
      *                                                                   S01117
      * Output profit centre from related customer position               S01117
      *                                                                   S01117
      **    If Analytical Accounting is installed and customer            CAC002
      **    position profit centre is blank, set the profit centre to     CAC002
      **    SE ICD default profit centre.                                 CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C           PCCU      ANDEQ*BLANKS                                   CAC002
     C                     MOVE BVSEPC    PPFC                            CAC002
     C                     ELSE                                           CAC002
     C                     MOVE PCCU      PPFC                            S01117
     C                     ENDIF                                          CAC002
      *
     C                     Z-ADDRUND      PDTG
      *
      *** If S01447 installed, and settlement type = Dividend or Coupon   S01447
      *** and a security WHT record  for the security exists, and         S01447
      *** settlement is a payment, calculate tax amounts.                 S01447
      *                                                                   S01447
     C           S01447    IFEQ 'N'                                       S01447
     C           *IN80     OREQ '1'                                       S01447
     C           PPRE      OREQ 'R'                                       S01447
     C           P9SDET    ORNE 'DV'                                      S01447
     C           P9SDET    ANDNE'CP'                                      S01447
     C           P9SDET    ANDNE'CG'                                      CSE053
     C/COPY WNCPYSRC,SE4860C032
     C                     CLEARTASO                                      S01447
     C                     CLEARTASR                                      S01447
     C                     CLEARTAUS                                      S01447
     C                     ELSE                                           S01447
     C/COPY WNCPYSRC,SE4860C033
     C                     EXSR CALCTX                                    S01447
     C/COPY WNCPYSRC,SE4860C034
     C                     END                                            S01447
      *                                                                   S01447
      * ZEROISE NUMERIC FIELDS WITH NO SPECIFIED VALUE
      *
     C                     Z-ADD0         PCHA
     C/COPY WNCPYSRC,SE4860C035
     C                     Z-ADD0         PCAM
     C/COPY WNCPYSRC,SE4860C036
     C                     MOVE *BLANKS   PCHC                            S01519
     C                     MOVE *BLANKS   PCCD                            S01519
     C                     Z-ADD0         PSAT
     C                     Z-ADDRUND      LCD                             066777
     C                     Z-ADD0         TNLU
     C                     MOVE 'I'       CHTP                            E18221
     C/COPY WNCPYSRC,SE4860C037
     C                     MOVE 'D'       RECI                            103017
      *                                                                   S01519
      ** If S01519 is active AND autocharge option is Y, calculate        S01519
      ** the default charge/commission amount and settlement amount       S01519
      *                                                                   S01519
     C           S01519    IFEQ 'Y'                                       S01519
     C           BVACOP    ANDEQ'Y'                                       S01519
     C                     EXSR P04                                       S01519
     C           WSRECI    IFEQ 'R'                                       161063
     C                     Z-SUBPCHA      PCHA                            161063
     C                     Z-SUBPCAM      PCAM                            161063
     C                     ENDIF                                          161063
     C                     END                                            S01519
     C/COPY WNCPYSRC,SE4860C038
     C                     EXSR P06                                       094229
     C/COPY WNCPYSRC,SE4860C039
      *
      * WRITE POSITION SETTLMENT RECORD
      *
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C/COPY WNCPYSRC,SE4860C040
     C                     Z-ADDTNLU      PTNLU   50                      S01486
     C                     EXSR ZTNLU1                                    S01486
     C                     MOVELNATN      TNLU                            S01486
     C                     MOVE 'I'       CHTP                            S01486
      *                                                                   S01486
      ** IF MATURITY POSITION SETTLEMENT FOR ZERO AMOUNT DUE FOR          S01486
      ** PORTFOLIO WITH PERFORMANCE SET ALL AMOUNT FIELDS TO ZERO         S01486
     C           PEVT      IFEQ 'MT'                       B1             S01486
     C           PAMD      ANDEQ0                                         S01486
      *                                                                   S01486
     C           WPORTP    IFEQ 'Y'                        B2             S01486
     C           PTFR      ANDNE'9997'                                    189942
     C           PNPSDT    ANDLTRUND                                      S01486
     C                     MOVE *BLANKS   PCHC                            S01486
     C                     MOVE *BLANKS   PCCD                            S01486
     C                     Z-ADD0         PCHA                            S01486
     C                     Z-ADD0         PCAM                            S01486
     C/COPY WNCPYSRC,SE4860C041
     C                     Z-ADD0         PSAT                            S01486
     C                     Z-ADD0         TASO                            S01486
     C                     Z-ADD0         TASR                            S01486
     C                     Z-ADD0         TAUS                            S01486
      *                                                                   S01486
      ** ....OTHERWISE DO NOT OUTPUT POSITION SETTLEMENT RECORED          S01486
     C                     ELSE                            X2             S01486
     C                     GOTO ENDW02                                    S01486
     C                     END                             E2             S01486
     C                     END                             E1             S01486
     C                     END                                            S01486
      *                                                                   046500
     C                     Z-ADD0         FXMP                            CAC002
     C                     Z-ADD0         FXMR                            CAC002
     C                     Z-ADD0         MAMT                            CAC002
     C/COPY WNCPYSRC,SE4860C042
      *                                                                   CAC002
      ** If CSE023 is not installed or if CSE023 is installed and         CSE023
      ** the events is not for Coupon, Dividend or Maturity then          CSE023
      ** use the normal processing.                                       CSE023
      *                                                                   CSE023
     C                     MOVE 'C'       CTYP                            187805
      *                                                                   187805
     C           CSE023    IFEQ 'N'                                       CSE023
      *                                                                   CSE023
     C           CSE023    OREQ 'Y'                                       CSE023
     C           PEVT      ANDNE'CP'                                      CSE023
     C           PEVT      ANDNE'MT'                                      CSE023
     C           PEVT      ANDNE'DV'                                      CSE023
      *                                                                   CSE023
     C           CRTT      OREQ *BLANKS                                   CSE023
      *                                                                   CSE023
     C*                                                                   CAC002
     C                     ADD  1         W02CNT  50                      046500
     C                     WRITEPOSETDF
     C                     EXSR PSAUDT                                    AR324886
     C                     MOVE 'Y'       WWDATA  1
      *                                                                   CSE053
      * Set data for On-line Projected movements update                   CSE053
      *                                                                   CSE053
     C           @PHASE    IFNE 'C'                                       CSE053
     C           PAUI      ANDEQ'Y'                                       CSE053
     C                     MOVEL*BLANK    Z#BSTS                          CSE053
     C                     MOVELPPOSET    Z#ASTS                          CSE053
      *                                                                   CSE053
      * Do On-line Updates                                                CSE053
      *                                                                   CSE053
     C                     CALL 'AOOUPSU0'                                CSE053
     C                     PARM           @RTCD   7                       CSE053
     C                     PARM           Z#BSTS                          CSE053
     C                     PARM           Z#ASTS                          CSE053
     C           @RTCD     IFEQ '*ERROR*'                                 CSE053
     C           *LOCK     IN   LDA                                       CSE053
     C                     SETON                     U7U8                 CSE053
     C                     MOVE PBCA      SPBCA                           CSE053
     C                     MOVE PSSH      SPSSH                           CSE053
     C                     MOVE PCPY      SPCPY                           CSE053
     C                     Z-ADDPDUD      SPDUD                           CSE053
      *                                                                   CSE053
     C                     Z-ADD80        DBASE            ***************CSE053
     C                     MOVEL'AOOUPSU0'DBFILE           * DB ERROR 80 *CSE053
     C                     MOVE *BLANKS   DBKEY            ***************CSE053
     C                     MOVELKEYFLD    DBKEY            ***************CSE053
     C                     OUT  LDA                                       CSE053
     C                     EXSR *PSSR                                     CSE053
     C                     END                                            CSE053
     C                     END                                            CSE053
      *                                                                   CSE023
     C                     ELSE                                           CSE023
      *                                                                   CSE023
      ** If Treaty Withholding Tax is installed, then set up fields       CSE023
      ** for SE2310.                                                      CSE023
      *                                                                   CSE023
      ** For Coupon Event, @DIVDT is the Last Coupon Date.                CSE023
      ** For Dividend Event, @DIVDT is equal to the dividend date.        CSE023
      *                                                                   CSE023
     C                     Z-ADD0         @DIVDT                          CSE023
     C                     MOVE ' '       @TVBAS                          CSE023
      *                                                                   CSE023
     C           PEVT      IFEQ 'CP'                                      CSE023
     C                     Z-ADDP9LCCP    @DIVDT                          CSE023
     C                     END                                            CSE023
      *                                                                   CSE023
     C           PEVT      IFEQ 'DV'                                      CSE023
      *                                                                   CSE023
      ** If S01510 is active AND event type = DV, use ex-dividend date    CSE023
      *                                                                   CSE023
     C           S01510    IFEQ 'Y'                                       CSE023
     C                     Z-ADDP9SDXD    @DIVDT                          188958
     C                     ELSE                                           CSE023
     C                     Z-ADDP9SDED    @DIVDT                          CSE023
     C                     END                                            CSE023
      *                                                                   CSE023
      ** If CSE008 is ON then use value date position for dividend.       CSE023
      *                                                                   CSE023
     C           CSE008    IFEQ 'Y'                                       CSE023
     C                     MOVE 'V'       @TVBAS                          CSE023
     C                     ELSE                                           CSE023
     C                     MOVE 'T'       @TVBAS                          CSE023
     C                     END                                            CSE023
     C                     END                                            CSE023
     C                     Z-ADDLCD       LCDP                            185732
      *                                                                   CSE023
     C                     CALL 'XX118009'                                CSE023
     C                     PARM           PPOSET                          CSE023
     C                     PARM           @TVBAS  1                       CSE023
     C                     PARM           @DIVDT  50                      CSE023
     C                     PARM           @NREC   30                      CSE023
     C                     PARM           @ERR    1                       CSE023
      *                                                                   CSE023
     C           @ERR      IFEQ 'N'                                       CSE023
     C                     ADD  @NREC     W02CNT                          CSE023
     C                     ELSE                                           CSE023
     C           *LOCK     IN   LDA                                       187183
     C                     MOVE 'XX118009'DBFILE           ***************CSE023
     C                     MOVEL'*CALL'   DBKEY            * DB ERROR 48 *CSE023
     C                     Z-ADD48        DBASE            ***************CSE023
     C                     SETON                     U7U8                 CSE023
     C                     EXSR *PSSR                                     CSE023
     C                     MOVE '1'       *INLR                           CSE023
     C                     END                                            CSE023
     C                     END                                            CSE023
      *                                                                   S01408
     C/COPY WNCPYSRC,SE4860C043                                           S01408
      *                                                                   S01408
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     Z-ADDPTNLU     TNLU                            S01486
     C                     END                                            S01486
      *
      * Save Customer and Branch
     C                     MOVE CSCN      WNEWCU
     C                     MOVE CSBA      WNEWBR
     C           WPORTP    IFEQ 'Y'
     C           BGPFMG    ANDEQ'Y'
     C           WPORTP    OREQ 'Y'
     C           BGN4ST    ANDEQ'Y'
     C                     MOVE PTFR      WNEWPT
     C                     MOVE CDCN      WNEWCU
     C                     MOVE CDPA      WNEWBR
     C                     END
      *
     C           ENDW02    ENDSR                           ** ENDW02 **
      *
      *****************************************************************
     C/EJECT                                                              S01519
      *****************************************************************   S01519
      *                                                               *   S01519
      *  P04   - SUBROUTINE TO CALCULATE CHARGE/COMMISSION AMOUNTS    *   S01519
      *                                                               *   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C           P04       BEGSR                                          S01519
      *                                                                   S01519
     C                     MOVE *ZEROS    PCHA                            S01519
     C/COPY WNCPYSRC,SE4860C044
     C                     MOVE *ZEROS    PCAM                            S01519
     C                     MOVE CSCN      DCCUST                          S01519
      *                                                                   S01519
      ** Only access file if PEVT is coupon, dividend, or maturity.       S01519
      *                                                                   S01519
     C           PEVT      IFEQ 'CP'                                      S01519
     C           PEVT      OREQ 'DV'                                      S01519
     C           PEVT      OREQ 'MT'                                      S01519
      *                                                                   S01408
     C/COPY WNCPYSRC,SE4860C045                                           S01408
      *                                                                   S01408
      *                                                                   S01519
      ** Set up key for chaining to default charges table (SEDFTCL2).     S01519
      ** If *IN40 is On, chain SEDFRGL0 instead.                          CSE026
      *                                                                   S01519
     C           *IN40     IFEQ *ON                                       CSE026
     C                     MOVELBFPSCG    DCCLGR                          CSE026
     C                     ELSE                                           CSE026
     C                     MOVE C1DI      DCCLAS                          S01519
     C                     ENDIF                                          CSE026
      *                                                                   CSE026
     C                     MOVE SITP      DCINVT                          S01519
     C                     MOVE CSCN      DCCUST                          S01519
      *                                                                   S01519
     C           *IN40     IFEQ *ON                                       CSE026
     C           DFTKYG    CHAINSEDFGRL0             70                   CSE026
     C                     ELSE                                           CSE026
     C           DFTKY1    CHAINSEDFTCL2             70                   S01519
     C                     ENDIF                                          CSE026
      *                                                                   S01519
     C           *IN70     IFEQ '0'                                       S01519
     C                     EXSR P05                                       S01519
     C                     ELSE                                           S01519
      *                                                                   S01519
     C                     MOVE *ZEROS    DCCUST                          S01519
     C           *IN40     IFEQ *ON                                       CSE026
     C           DFTKYG    CHAINSEDFGRL0             70                   CSE026
     C                     ELSE                                           CSE026
     C           DFTKY1    CHAINSEDFTCL2             70                   S01519
     C                     ENDIF                                          CSE026
      *                                                                   S01519
     C           *IN70     IFEQ '0'                                       S01519
     C                     EXSR P05                                       S01519
     C                     ELSE                                           S01519
      *                                                                   S01519
     C                     MOVE *BLANKS   DCINVT                          S01519
     C           *IN40     IFEQ *ON                                       CSE026
     C           DFTKYG    CHAINSEDFGRL0             70                   CSE026
     C                     ELSE                                           CSE026
     C           DFTKY1    CHAINSEDFTCL2             70                   S01519
     C                     ENDIF                                          CSE026
      *                                                                   CSE026
     C           *IN70     IFEQ '0'                                       S01519
     C                     EXSR P05                                       S01519
     C                     ELSE                                           S01519
      *                                                                   S01519
      ** If no records found zeroise default charge/commission            S01519
      ** amount fields.                                                   S01519
      *                                                                   S01519
     C                     MOVE *ZEROS    PCHA                            S01519
     C                     MOVE *ZEROS    PCAM                            S01519
     C/COPY WNCPYSRC,SE4860C046
     C                     END                                            S01519
      *                                                                   S01519
     C                     END                                            S01519
     C                     END                                            S01519
      *                                                                   S01408
     C/COPY WNCPYSRC,SE4860C047                                           S01408
      *                                                                   S01408
     C                     END                                            S01519
      *                                                                   S01519
     C                     ENDSR                           ** P04    **   S01519
      *                                                                   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C/EJECT                                                              S01519
     C/COPY WNCPYSRC,SE4860C048
      *****************************************************************   S01519
      *                                                               *   S01519
      *  P05   - SUBROUTINE TO CALCULATE DEFAULT AMOUNTS              *   S01519
      *                                                               *   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C           P05       BEGSR                                          S01519
     C/COPY WNCPYSRC,SE4860C049
      *                                                                   S01519
     C                     SELEC                                          S01519
      *                                                                   S01519
      ** Event type if equal to coupon.                                   S01519
      *                                                                   S01519
     C           PEVT      WHEQ 'CP'                                      S01519
      *                                                                   S01519
      ** Update commissions amount.                                       S01519
      *                                                                   S01519
     C           DCCPCM    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCAM                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCCPCM    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCAM                            S01519
     C                     END                                            S01519
     C                     MOVE DCCPCM    PCCD                            S01519
      *                                                                   S01519
      ** Update charge amount.                                            S01519
      *                                                                   S01519
     C           DCCPCC    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCHA                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCCPCC    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCHA                            S01519
     C                     END                                            S01519
     C                     MOVE DCCPCC    PCHC                            S01519
     C/COPY WNCPYSRC,SE4860C050
      *                                                                   S01519
      ** Event type if equal to dividend                                  S01519
      *                                                                   S01519
     C           PEVT      WHEQ 'DV'                                      S01519
      *                                                                   S01519
      ** Update commissions amount.                                       S01519
      *                                                                   S01519
     C           DCDVCM    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCAM                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCDVCM    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCAM                            S01519
     C                     END                                            S01519
     C                     MOVE DCDVCM    PCCD                            S01519
      *                                                                   S01519
      ** Update charge amount.                                            S01519
      *                                                                   S01519
     C           DCDVCC    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCHA                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCDVCC    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCHA                            S01519
     C                     END                                            S01519
     C                     MOVE DCDVCC    PCHC                            S01519
     C/COPY WNCPYSRC,SE4860C051
      *                                                                   S01519
      ** Event type if equal to maturity.                                 S01519
      *                                                                   S01519
     C           PEVT      WHEQ 'MT'                                      S01519
      *                                                                   S01519
      ** Update commissions amount.                                       S01519
      *                                                                   S01519
     C           DCMTCM    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCAM                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCMTCM    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCAM                            S01519
     C                     END                                            S01519
     C                     MOVE DCMTCM    PCCD                            S01519
      *                                                                   S01519
      ** Update charge amount.                                            S01519
      *                                                                   S01519
     C           DCMTCC    IFEQ *BLANKS                                   S01519
     C                     Z-ADD*ZEROS    PCHA                            S01519
     C                     ELSE                                           S01519
     C                     MOVE DCMTCC    @CAM                            S01519
     C                     EXSR CALAMT                                    S01519
     C                     Z-ADDZCHGA     PCHA                            S01519
     C                     END                                            S01519
     C                     MOVE DCMTCC    PCHC                            S01519
     C/COPY WNCPYSRC,SE4860C052
      *                                                                   S01519
     C                     ENDSL                                          S01519
      *                                                                   132348
      ** CHECK IF CHARGE+COMMISSION ARE GREATER THAN AMOUNT DUE. IN THIS  132348
      ** CASE READJUST CHARGE/COMMISSION.                                 132348
      *                                                                   132348
     C           PCHA      ADD  PCAM      WTOTC  130                      132348
     C           WTOTC     IFGT PAMD                                      132348
     C           PAMD      IFLT PCHA                                      132348
     C                     Z-ADD0         PCAM                            132348
     C                     Z-ADDPAMD      PCHA                            132348
     C                     ELSE                                           132348
     C           PAMD      SUB  PCHA      PCAM                            132348
     C                     ENDIF                                          132348
     C                     ENDIF                                          132348
      *                                                                   S01519
     C                     ENDSR                           ** P05    **   S01519
      *                                                                   S01519
      *****************************************************************   S01519
     C/EJECT                                                              S01519
      *****************************************************************   S01519
      *                                                               *   S01519
      *  P06   - SUBROUTINE TO CALCULATE SETTLEMENT AMOUNTS           *   S01519
      *                                                               *   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C           P06       BEGSR                                          S01519
      *                                                                   087178
      ** Set up parameter for call to SEZ010                              087178
      *                                                                   087178
     C                     MOVELC1DI      P@CLAS                          087178
     C                     MOVELPPRE      P@PPRE                          087178
     C                     Z-ADDPAMD      P@PAMD                          087178
     C                     Z-ADDPCHA      P@PCHA                          087178
     C                     Z-ADDPCAM      P@PCAM                          087178
     C                     Z-ADDTASO      P@TASO                          087178
     C                     Z-ADDTAUS      P@TAUS                          087178
     C                     Z-ADDPSXR      P@PSXR                          087178
     C                     MOVELPMDI      P@PMDI                          087178
     C                     MOVELPNCY      P@PNCY                          087178
     C                     MOVELPSCU      P@PSCU                          087178
     C/COPY WNCPYSRC,SE4860C053
      *                                                                   CAC002
     C                     MOVE 'TS'      P@TDTP                          CAC002
     C                     Z-ADD0         P@FXMR                          CAC002
     C                     Z-ADD0         P@MAMT                          CAC002
      *                                                                   087178
      ** Call SEZ010 to calculate the settlement amount in settle ccy     087178
      *                                                                   087178
     C                     CALL 'SEZ010'                                  087178
     C                     PARM *BLANKS   P@RCDE  7                       087178
     C                     PARM           P@DATA                          087178
     C           P@RCDE    IFEQ *BLANKS                                   087178
     C                     Z-ADDP@PSAT    PSAT                            087178
     C                     ELSE                                           087178
     C                     EXSR *PSSR                                     087178
     C                     MOVE '1'       *INLR                           087178
     C                     ENDIF                                          087178
      *                                                                   S01519
     C                     ENDSR                           ** P06    **   S01519
      *                                                                   S01519
      *****************************************************************   S01519
     C/EJECT                                                              S01519
      *****************************************************************   S01486
      *                                                               *   S01486
      *  P07  DETERMINE SETTLEMENT INFORMATION                        *   S01486
      *                                                               *   S01486
      *****************************************************************   S01486
      *                                                                   S01486
     C           P07       BEGSR                                          S01486
      *Store Settlement ccy.                                              165021
     C                     MOVELPSCU      WPSCU   3                       165021
      *                                                                   165021
     C                     MOVE 'N'       WWPMCS  1                       192099
      *                                                                   S01486
      ** IF POSITION SETTLEMENT FOR A PORTFOLIO POSITION OBTAIN           S01486
      ** PORTFOLIO CURRENCY AND CUSTOMER CURRENCY                         S01486
     C           WPORTP    IFEQ 'Y'                        B1             S01486
     C           PTFR      ANDNE*BLANKS                                   189942
     C********             MOVE *BLANKS   WZACOD  40                      219688
     C                     MOVE *BLANKS   WZACOD 100                      219688
      *                                                                   S01486
      ** IF POSITION SETTLEMENT FOR A DEFINED PORTFOLIO OBTAIN PORTFOLIO  S01486
      ** CURRENCY                                                         S01486
     C           PTFR      IFNE '9997'                     B2             189942
     C                     MOVE CDCN      WWCNU1                          189942
     C                     MOVE PTFR      WWPTF1                          189942
      *                                                                   S01486
     C           PMPORT    CHAINPMPORTPD             83                   081383
     C           *IN83     IFEQ '1'                        B3             081383
     C           *LOCK     IN   LDA                                       081239
     C                     MOVEL'PMPORTPD'DBFILE           ***************081239
     C                     MOVELCDCN      DBKEY            ** DB ERROR 04 189942
     C                     MOVE PTFR      DBKEY            ***************189942
     C                     Z-ADD40        DBASE                           S01486
     C                     SETON                       U7U8               081239
     C                     GOTO EAUDIT                                    S01486
     C                     END                             E3             S01486
      *                                                                   S01486
     C                     END                             E2             S01486
      *                                                                   S01486
      ** ACCESS PORTFOLIO CUSTOMER DETAILS                                S01486
     C                     MOVE CDCN      WWCNUA  6                       189942
      *                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C                     MOVELWWCNUA    WWCLIN 10                       S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*KEY   ' @OPTN                           S01486
     C                     PARM WWCLIN    WWKY10 10                       S01486
     C           SDPLCS    PARM SDPLCS    DSSDY                           S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           BGN4ST    IFNE 'Y'                                       192099
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVEL'SDPLCSPD'DBFILE           ***************081239
     C                     MOVELWWCNUA    DBKEY            ** DB ERROR 04 S01486
     C                     Z-ADD41        DBASE            ***************S01486
     C                     SETON                       U7U8               S01486
     C                     EXSR *PSSR                                     S01486
     C                     GOTO EAUDIT                                    S01486
     C                     ENDIF                                          192099
     C                     ELSE                                           192099
     C                     MOVE 'Y'       WWPMCS                          192099
     C                     END                             E2             S01486
     C                     ENDIF                                          CPB001
     C                     MOVE CDCN      WWCNUA  6                       189942
      *                                                                   133844
     C                     MOVELWWCNUA    @CUST  10                       133844
     C                     CALL 'AOSECSR0'                                133844
     C                     PARM *BLANKS   @RTCD                           133844
     C                     PARM '*KEY   ' @OPTN                           133844
     C                     PARM           @CUST                           133844
     C           SECSPD    PARM SECSPD    DSSDY                           133844
      *                                                                   133844
     C           @RTCD     IFNE *BLANKS                    *B3            133844
     C           *LOCK     IN   LDA                                       133844
     C                     MOVEL'SDSECSL0'DBFILE           ***************133844
     C                     MOVEL@CUST     DBKEY            ** DBERROR 044 133844
     C                     Z-ADD44        DBASE            ***************133844
     C                     SETON                       U7U8               133844
     C                     EXSR *PSSR                                     133844
     C                     GOTO EAUDIT                                    133844
     C                     END                                            133844
      *                                                                   219688
     C                     MOVE BFACCD    WZACOD                          219688
      *                                                                   219688
      *                                                                   S01486
      ** ... OTHERWISE POSITION SETTLEMENT FOR A NON-PORTFOLIO CUSTOMER   S01486
      ** HENCE ACCES SDSECSL0 FOR SECURITY CUSTOMER BASE CURRENCY         S01486
     C                     ELSE                            X1             S01486
      *                                                                   S01486
     C                     MOVE CSCN      WWCNUA  6                       S01486
      *                                                                   S01486
      *                                                                   S01486
     C                     MOVELWWCNUA    @CUST  10                       S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*KEY   ' @OPTN                           S01486
     C                     PARM           @CUST                           S01486
     C           SECSPD    PARM SECSPD    DSSDY                           S01486
      *                                                                   S01486
     C           @RTCD     IFNE *BLANKS                    *B3            S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVEL'SDSECSL0'DBFILE           ***************S01486
     C                     MOVEL@CUST     DBKEY            ** DBERROR 010 S01486
     C                     Z-ADD42        DBASE            ***************S01486
     C                     SETON                       U7U8               S01486
     C                     EXSR *PSSR                                     S01486
     C                     GOTO EAUDIT                                    S01486
     C                     END                                            S01486
     C                     END                             E1             S01486
      *                                                                   S01486
      ** USE FIRST ACCOUNT IN FOUND FOR CUSTOMER / PORTFOLIO AS           S01486
      ** APPROPRIATE IN VALUE, PORTFOLIO OR CUSTOMER CURRENCY VIA P08     S01486
     C           WPORTP    IFEQ 'Y'                        B1             S01486
     C           PTFR      ANDNE*BLANKS                                   189942
     C*********            Z-ADDCDCN      WZCNUM  60               189942 HUT118
     C                     MOVELCDCN      WZCNUM  6                       HUT118
     C                     MOVE PTFR      WZPTFR  4                       189942
     C                     MOVE PNCY      WWCCY1  3                       S01486
     C           WWPMCS    IFEQ 'Y'                                       192099
     C                     MOVE QBCSBY    WWCCY3  3                       S01486
     C                     ELSE                                           192099
     C                     MOVE PNCY      WWCCY3                          192099
     C                     ENDIF                                          192099
      *                                                                   S01486
     C           PTFR      IFNE '9997'                     B2             189942
     C                     MOVE PNPTCY    WWCCY2  3                       S01486
     C                     ELSE                            X2             S01486
     C           WWPMCS    IFEQ 'Y'                                       192099
     C                     MOVE QBCSBY    WWCCY2  3                       S01486
     C                     ELSE                                           192099
     C                     MOVE PNPTCY    WWCCY2                          192099
     C                     ENDIF                                          192099
     C                     END                             E2             S01486
      *                                                                   S01486
     C                     ELSE                            X1             S01486
     C*********            Z-ADDCSCN      WZCNUM  60               S01486 HUT118
     C                     MOVELCSCN      WZCNUM  6                       HUT118
     C                     MOVE *BLANKS   WZPTFR  4                       S01486
     C                     MOVE PNCY      WWCCY1  3                       S01486
     C                     MOVE BFPCYC    WWCCY2  3                       S01486
     C                     MOVE BFPCYC    WWCCY3  3                       S01486
     C                     END                             E1             S01486
      *                                                                   S01486
      ** CHECK WHETHER ACCOUNT EXISTS IN VALUE CURRENCY                   S01486
      ***********WPORTP    IFEQ 'Y'                        B1      S01486 101317
     C           BGPFMG    IFEQ 'Y'                        B1             111922
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE WWCCY1    WZCCY   3                       S01486
     C                     EXSR P08                                       S01486
      *                                                                   097890
      ** If no account in security currency, do NOT post to account       097890
      ** in customer currency or portfolio currency with sett. method     097890
      ** '05' - post to suspense account with sett. method '00' instead   097890
      *                                                                   S01486
      *                                                                   S01486
     C                     ENDIF                           E1             111922
      *                                                                   S01486
      ** IF A SETTLEMENT ACCOUNT HAS BEEN FOUND OUTPUT SETTLEMENT         S01486
      ** DETAILS                                                          S01486
     C           WZFOND    IFEQ 'Y'                        B1             S01486
     C                     MOVE WZCCY     PSCU                            S01486
      *                                                                   S01486
     C                     MOVE '05'      PSMT                            S01486
     C                     MOVE WZSETA    PSEA                            S01486
     C                     MOVE WZBRCD    PSEB                            S01486
     C                     ELSE                            X1             S01486
     C                     MOVE PNCY      PSCU                            S01486
     C                     MOVE *BLANKS   PSEA                            S01486
     C                     MOVE *BLANKS   PSMT                            S01486
     C                     MOVE *BLANKS   PSEB                            S01486
     C                     END                             E1             S01486
      *                                                                   S01486
      *  BASE CURR EXCHANGE RATE IS SPOT RATE FOR SETTLEMENT CURRCY       S01486
      *                                                                   S01486
     C           TPBRY     TAG                                            SA9108
      *  PBRX IS NOW EXCHANGE RATE BETWEEN VALUE AND BASE                 S01486
     C                     MOVE PSCU      WCURR                           S01486
     C                     EXSR TG10                                      S01486
     C                     Z-ADDSPOT      PBRX                            S01486
     C                     Z-ADD1         ZAMTF                           S01486
     C                     MOVE PNCY      ZCCYF                           S01486
     C                     MOVE PSCU      ZCCYT                           S01486
     C                     Z-ADDSPOT      PBRX                            S01486
      * If Settlement ccy has changed, recalculate Xrate and M/Dind.      165021
     C           WPSCU     IFNE PSCU                                      165021
     C                     CALL 'AOCURRR0'                                165021
     C                     PARM '*DBERR'  @RTCD   7                       165021
     C                     PARM '*KEY   ' @OPTN   7                       165021
      ***                  PARM PSCU      @AJCD   3                165021 179847
     C                     PARM PNCY      @AJCD   3                       179847
     C           SDCURR    PARM SDCURR    DSSDY                           165021
      *                                                                   165021
     C                     Z-ADDA6SPRT    ZRATE1 138                      165021
     C                     MOVE A6MDIN    ZMDI1   1                       165021
      *                                                                   165021
      * Get position currency spot rate                                   165021
      *                                                                   165021
     C                     CALL 'AOCURRR0'                                165021
     C                     PARM '*DBERR'  @RTCD   7                       165021
     C                     PARM '*KEY   ' @OPTN   7                       165021
      ***                  PARM PNCY      @AJCD   3                165021 179847
     C                     PARM PSCU      @AJCD   3                       179847
     C           SDCURR    PARM SDCURR    DSSDY                           165021
      *                                                                   165021
     C                     Z-ADDA6SPRT    ZRATE2 138                      165021
     C                     MOVE A6MDIN    ZMDI2   1                       165021
     C                     EXSR ZXRATE                                    165021
      *                                                                   165021
     C                     Z-ADDZRATEX    PSXR                            165021
     C                     MOVE ZMDIX     PMDI                            165021
     C                     ENDIF                                          165021
      *                                                                   165021
      *                                                                   S01486
     C                     ENDSR                                          S01486
      ********************************************************************S01486
      /EJECT                                                              S01486
      *****************************************************************   S01486
      *                                                               *   S01486
      *  P08  DETERMINE SETTLEMENT ACCOUNT                            *   S01486
      *                                                               *   S01486
      *****************************************************************   S01486
      *                                                                   S01486
     C           P08       BEGSR                                          S01486
      *                                                                   S01486
     C                     MOVE 'N'       WZFOND  1                       S01486
     C                     Z-ADD0         WZACSQ                          S01486
      *                                                                   S01486
      ** READ FIRST RECORD FOR ACCOUNT FOR THE SDSECSPD ACCOUNT CODE      219688
     C           ACCNTL    SETLLPMACCNL1                                  219688
     C                     READ PMACCNL1                 83               219688
     C           *IN83     IFEQ '0'                                       219688
     C           CNUM      ANDEQWZCNUM                                    219688
     C           CCY       ANDEQWZCCY                                     219688
     C           ACOD      ANDEQWZACOD                                    219688
     C           L1PTFR    ANDEQWZPTFR                                    219688
     C                     MOVE 'Y'       WZFOND                          219688
     C                     MOVELBRCA      WZBRCD                          219688
     C                     MOVELCNUM      WRK16                     219688HUT118
     C                     MOVE ACOD      WRK16                     219688HUT118
     C                     MOVELWRK16     WZSETA                    219688HUT118
     C                     MOVE ACSQ      WZSETA                          219688
     C                     ELSE                                           219688
      *                                                                   219688
      ** READ FIRST RECORD FOR ACCOUNT                                    S01486
     C           ACCNTP    SETLLPMACCNL0                                  S01486
     C                     READ PMACCNL0                 83        S01486 081383
      *                                                                   S01486
      ** IF DETAILS READ FOR SAME CUSTOMER CURRENCY AND PORTFOLIO         S01486
      ** SET UP OUTPUT DETAILS                                            S01486
     C           *IN83     IFEQ '0'                                       081383
     C           CNUM      ANDEQWZCNUM                                    S01486
     C           CCY       ANDEQWZCCY                                     S01486
     C           RNPTFR    ANDEQWZPTFR                                    S01486
     C                     MOVE 'Y'       WZFOND                          S01486
     C                     MOVELBRCA      WZBRCD  3                       081239
     C                     MOVELCNUM      WRK16  16                 S01486HUT118
     C                     MOVE ACOD      WRK16                     S01486HUT118
     C                     MOVELWRK16     WZSETA 18                 S01486HUT118
     C                     MOVE ACSQ      WZSETA                          S01486
     C                     ELSE                                           219566
      ** ELSE RETRIEVE AN ACCOUNT FROM THIS CLIENT                        219566
     C                     MOVE *BLANKS   WZPTFR                          219566
     C           ACCNTP    SETLLPMACCNL0                                  219566
     C                     READ PMACCNL0                 79               219566
      *                                                                   219566
      ** IF DETAILS READ FOR SAME CUSTOMER CURRENCY AND PORTFOLIO         219566
      ** SET UP OUTPUT DETAILS                                            219566
     C           *IN79     IFEQ '0'                                       219566
     C           CNUM      ANDEQWZCNUM                                    219566
     C           CCY       ANDEQWZCCY                                     219566
     C                     MOVE 'Y'       WZFOND                          219566
     C                     MOVELBRCA      WZBRCD  3                       219566
     C                     MOVELCNUM      WRK16  16                 219566HUT118
     C                     MOVE ACOD      WRK16                     219566HUT118
     C                     MOVELWRK16     WZSETA 18                 219566HUT118
     C                     MOVE ACSQ      WZSETA                          219566
     C                     END                                            219566
      *                                                                   219566
     C                     END                                            S01486
      *                                                                   S01486
     C                     END                                            219688
      *                                                                   219688
     C           HUT103    IFEQ 'Y'                                                           HUT103
      *                                                                                       HUT103
     C***Call*non-visible*window*program                                                      HUT103
      *                                                                                       HUT103
     C                     MOVEL'00004'   UPSEQ                                               HUT103
     C                     MOVE PEVT      DPEVT                                               HUT103
     C                     MOVE WZCNUM    DCNUM                                               HUT103
     C                     MOVE WZPTFR    DPTFR                                               HUT103
     C                     MOVE WZBRCD    DBRCD                                               HUT103
     C                     MOVE WZCCY     DCURR                                               HUT103
     C                     MOVE WZFOND    DFOND                                               HUT103
     C                     MOVE WZSETA    DSETA                                               HUT103
      *                                                                                       HUT103
     C                     CALL 'XX2400'                                                      HUT103
     C                     PARM 'I'       ACTION  1                                           HUT103
     C                     PARM           DATA2                                               HUT103
     C                     PARM           DATAI                                               HUT103
     C                     PARM           DATAF1                                              HUT103
     C                     PARM           DATAF2                                              HUT103
     C                     PARM           DATAF3                                              HUT103
     C                     PARM           DATAF4                                              HUT103
     C                     PARM *BLANKS   #RTRN   7                                           HUT103
      *                                                                                       HUT103
     C           #RTRN     IFNE *BLANKS                                                       HUT103
     C                     MOVE '900'     DBASE                                               HUT103
     C                     MOVEL'*CALL'   DBKEY                                               HUT103
     C                     MOVEL'XX2400'  DBFILE                                              HUT103
     C                     EXSR *PSSR                                                         HUT103
     C                     GOTO EAUDIT                                                        HUT103
     C                     ENDIF                                                              HUT103
      *                                                                                       HUT103
     C                     MOVE DFOND     WZFOND                                              HUT103
     C                     MOVE DSETA     WZSETA                                              HUT103
     C                     MOVE DBRCD     WZBRCD                                            MD042648
      *                                                                                       HUT103
     C                     ENDIF                                                              HUT103
      *                                                                                       HUT103
     C                     ENDSR                                          S01486
      ********************************************************************S01486
      /EJECT                                                              S01447
      *****************************************************************   S01519
      *                                                               *   S01519
      *  CALAMT  SUB ROUTINE TO DETERMINE IF AMOUNTS NEED TO BE       *   S01519
      *          DEFAULTED FOR CHARGES                                *   S01519
      *                                                               *   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C           CALAMT    BEGSR                                          S01519
      *                                                                   S01519
      ** Charges to be displayed in nominal currency whether the          S01519
      ** security is single, dual or multi currency (ref amend to FS)     S01519
      *                                                                   S01519
     C                     MOVE PNCY      @CCY    3                       S01519
     C           @CCOD     CHAINSECGT                21                   S01519
      *                                                                   S01519
      ** If no live record found, field defaults to blank                 S01519
      *                                                                   S01519
     C           *IN21     IFEQ '1'                                       S01519
     C           RECI      ORNE 'D'                                       S01519
     C                     Z-ADD*ZEROS    ZCHGA                           S01519
     C                     END                                            S01519
      *                                                                   S01519
     C           *IN21     IFEQ '0'                                       S01519
     C           RECI      ANDEQ'D'                                       S01519
      *                                                                   S01519
      ** If trade type is purchase and levy on sale or trade type is      S01519
      ** sale and levy on purchase field is blank, otherwise calculate    S01519
      ** amount                                                           S01519
      *                                                                   S01519
     C           LPSI      IFEQ 'S'                                       S01519
     C           LPSI      OREQ 'P'                                       S01519
     C                     Z-ADD*ZEROS    ZCHGA                           S01519
     C                     ELSE                                           S01519
     C                     EXSR CALAM2                                    S01519
     C                     END                                            S01519
      *                                                                   S01519
     C                     END                                            S01519
      *                                                                   S01519
     C                     ENDSR                                          S01519
      *                                                                   S01519
      *****************************************************************   S01519
     C/EJECT                                                              S01519
      *****************************************************************   S01519
      *                                                               *   S01519
      *  CALAM2  SUB ROUTINE TO CALCULATE CHARGE AMOUNTS              *   S01519
      *                                                               *   S01519
      *****************************************************************   S01519
      *                                                                   S01519
     C           CALAM2    BEGSR                                          S01519
      *                                                                   S01519
      ** Charge details                                                   S01519
      *                                                                   S01519
     C                     MOVE CHGB      ZCHGB                           S01519
     C                     MOVE THRI      ZTHRI                           S01519
     C                     Z-ADDMNCH      ZMNCH                           S01519
     C                     Z-ADDMXCH      ZMXCH                           S01519
      *                                                                   S01519
      ** Set up array for upper range limits                              S01519
      *                                                                   S01519
     C                     Z-ADDSTU1      ZRA,1                           S01519
     C                     Z-ADDSTU2      ZRA,2                           S01519
     C                     Z-ADDSTU3      ZRA,3                           S01519
     C                     Z-ADDSTU4      ZRA,4                           S01519
     C                     Z-ADDSTU5      ZRA,5                           S01519
     C                     Z-ADDSTU6      ZRA,6                           S01519
     C                     Z-ADDSTU7      ZRA,7                           S01519
     C                     Z-ADDSTU8      ZRA,8                           S01519
     C                     Z-ADDSTU9      ZRA,9                           S01519
     C                     Z-ADDST10      ZRA,10                          S01519
     C                     Z-ADDST11      ZRA,11                          S01519
     C                     Z-ADDST12      ZRA,12                          S01519
     C                     Z-ADDST13      ZRA,13                          S01519
     C                     Z-ADDST14      ZRA,14                          S01519
      *                                                                   S01519
      ** Set up array for percentage levels                               S01519
      *                                                                   S01519
     C                     Z-ADDPL01      ZPC,1                           S01519
     C                     Z-ADDPL02      ZPC,2                           S01519
     C                     Z-ADDPL03      ZPC,3                           S01519
     C                     Z-ADDPL04      ZPC,4                           S01519
     C                     Z-ADDPL05      ZPC,5                           S01519
     C                     Z-ADDPL06      ZPC,6                           S01519
     C                     Z-ADDPL07      ZPC,7                           S01519
     C                     Z-ADDPL08      ZPC,8                           S01519
     C                     Z-ADDPL09      ZPC,9                           S01519
     C                     Z-ADDPL10      ZPC,10                          S01519
     C                     Z-ADDPL11      ZPC,11                          S01519
     C                     Z-ADDPL12      ZPC,12                          S01519
     C                     Z-ADDPL13      ZPC,13                          S01519
     C                     Z-ADDPL14      ZPC,14                          S01519
     C                     Z-ADDPL15      ZPC,15                          S01519
      *                                                                   S01519
      ** Set up array for flat charges                                    S01519
      *                                                                   S01519
     C                     Z-ADDFC01      ZCG,1                           S01519
     C                     Z-ADDFC02      ZCG,2                           S01519
     C                     Z-ADDFC03      ZCG,3                           S01519
     C                     Z-ADDFC04      ZCG,4                           S01519
     C                     Z-ADDFC05      ZCG,5                           S01519
     C                     Z-ADDFC06      ZCG,6                           S01519
     C                     Z-ADDFC07      ZCG,7                           S01519
     C                     Z-ADDFC08      ZCG,8                           S01519
     C                     Z-ADDFC09      ZCG,9                           S01519
     C                     Z-ADDFC10      ZCG,10                          S01519
     C                     Z-ADDFC11      ZCG,11                          S01519
     C                     Z-ADDFC12      ZCG,12                          S01519
     C                     Z-ADDFC13      ZCG,13                          S01519
     C                     Z-ADDFC14      ZCG,14                          S01519
     C                     Z-ADDFC15      ZCG,15                          S01519
      *                                                                   S01519
      ** Get nominal currency dec. places from TABTG10                    S01519
      *                                                                   S01519
     C                     MOVE PNCY      WCURR                           S01519
     C                     EXSR TG10                                      S01519
     C                     MOVE CDP       ZDECS                           S01519
     C                     MOVE CDP       ZCDP                            S01519
      *                                                                   S01519
      ** Nominal decimal places                                           S01519
      *                                                                   S01519
     C                     Z-ADDNMDP      ZNMDP                           S01519
      *                                                                   S01519
      ** Use SR/ZAVPR to calculate the price                              S01519
      *                                                                   S01519
     C           PNMP      IFNE 0                                         EMFIX
     C                     MOVE PNMP      ZNOML                           S01519
     C                     Z-ADDPAMD      ZAPNC                           S01519
     C                     EXSR ZAVPR                                     S01519
     C                     Z-ADDZPRC      ZPRICE                          S01519
     C                     ELSE                                           EMFIX
     C                     Z-ADD1         ZPRICE                          EMFIX
     C                     ENDIF                                          EMFIX
      *                                                                   S01519
     C                     Z-ADD1         ZTCFC                           S01519
     C                     MOVE PROT      ZPROT                           S01519
     C                     MOVE SPBS      ZSPBS                           S01519
      *                                                                   S01446
      ** For courtage enhancements, convert charge to value currency      S01446
      *                                                                   S01446
     C           S01446    IFEQ 'Y'                                       S01446
      *                                                                   S01446
      ** Purchase interest and total consideration                        S01446
      *                                                                   S01446
     C                     Z-ADD*ZEROS    ZTPI                            S01446
     C                     Z-ADD*ZEROS    ZTCON                           S01446
      *                                                                   S01446
     C           BVCHRC    IFNE *BLANKS                                   S01446
     C                     MOVE BVCHRC    ZCCYI                           S01446
     C                     MOVE PNCY      ZCCYO                           S01446
     C                     MOVE TRATEX    ZEXCH                           S01446
     C                     MOVE TMDIX     ZMD                             S01446
     C                     MOVE TXCDP     ZCDPI                           S01446
     C                     MOVE ZDECS     ZCDPO                           S01446
      *                                                                   S01446
     C                     ELSE                                           S01446
     C                     MOVE *BLANKS   ZCCYI                           S01446
     C                     MOVE *BLANKS   ZCCYO                           S01446
     C                     MOVE *BLANKS   ZEXCH                           S01446
     C                     MOVE *BLANKS   ZMD                             S01446
     C                     MOVE *BLANKS   ZCDPI                           S01446
     C                     MOVE *BLANKS   ZCDPO                           S01446
     C                     END                                            S01446
     C                     END                                            S01446
      *                                                                   S01446
      ** Total nominal                                                    S01446
      *                                                                   S01446
     C                     Z-ADD*ZEROS    ZTNOM  150                      S01446
     C/COPY WNCPYSRC,SE4860C054
      *                                                                   S01446
     C                     EXSR ZCCAL1                                    S01519
     C/COPY WNCPYSRC,SE4860C055
      *                                                                   S01519
     C                     ENDSR                                          S01519
      *                                                                   S01519
      *****************************************************************   S01519
      /EJECT                                                              S01447
      *****************************************************************   S01447
      *                                                               *   S01447
      *  CALCTX - Subroutine to calculate tax amounts for dividends   *   S01447
      *           and Coupons                                         *   S01447
      *                                                               *   S01447
      *  CALLED FROM: W02                                             *   S01447
      *  CALLS:       NONE                                            *   S01447
      *                                                               *   S01447
      *****************************************************************   S01447
      *                                                                   S01447
     C           CALCTX    BEGSR                                          S01447
      *                                                                   S01447
      *** Initialise work tax rate and amount fields                      S01447
      *                                                                   S01447
     C                     CLEARUTXRSR                                    S01447
     C                     CLEARUTXRRF                                    S01447
     C                     CLEARUTXRUS                                    S01447
     C                     CLEARUDLOR                                     S01447
      *                                                                   S01447
      *** If tax band at source is zero, then take rate from security     S01447
      *** WHT file; Otherwise access SEcountry tax rate file to           S01447
      *** get tax rate at source                                          S01447
      *                                                                   S01447
     C           S1TABD    IFEQ *ZERO                      *B1            S01447
     C                     Z-ADDS1RASO    UTXRSR                          S01447
     C                     ELSE                            *X1            S01447
      *                                                                   S01447
     C                     MOVELS1CTTA    UKEY    3                       S01447
     C                     MOVE S1TABD    UKEY                            S01447
      *                                                                   S01447
     C                     CALL 'AOSCTXR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*KEY   ' @OPTN                           S01447
     C                     PARM S1CTTA    @CTTA   2                       S01447
     C                     PARM S1TABD    @TABD   10                      S01447
     C           SECNTR    PARM SECNTR    DSSDY                           S01447
      *                                                                   S01447
     C           @RTCD     IFNE *BLANKS                    *B2            S01447
     C           TXRECI    ORNE 'D'                                       S01447
     C           *LOCK     IN   LDA                                       S01447
     C                     MOVEL'SECNTRL0'DBFILE           ***************S01447
     C                     MOVELUKEY      DBKEY            ** DBERROR 018 S01447
     C                     Z-ADD18        DBASE            ***************S01447
     C                     SETON                       U7U8               S01447
     C                     EXSR *PSSR                                     S01447
     C                     GOTO EAUDIT                                    S01447
     C                     ELSE                            *X2            S01447
     C                     Z-ADDTXRASO    UTXRSR                          S01447
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
      *** If tax band by user is not zero, then access country to         S01447
      *** branch tax rate file to get tax rate by user                    S01447
      *** Otherwise set to zero.                                          S01447
      *                                                                   S01447
     C           S1TABU    IFNE *ZERO                      *B1            S01447
     C/COPY WNCPYSRC,SE4860C056
     C                     CALL 'AOCBTXR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*KEY   ' @OPTN                           S01447
     C                     PARM CSBA      @BRCA   3                       S01447
     C                     PARM S1CTTA    @CTTA                           S01447
     C                     PARM S1TABU    @TABU   10                      S01447
     C           SECBTX    PARM SECBTX    DSFDY                           S01447
     C/COPY WNCPYSRC,SE4860C057
      *                                                                   S01447
     C           @RTCD     IFEQ *BLANKS                    *B2            S01447
     C           TBRECI    ANDEQ'D'                                       S01447
     C                     Z-ADDTBRASR    UTXRRF                          S01447
     C                     Z-ADDTBRAUS    UTXRUS                          S01447
     C                     MOVE TBDLOR    UDLOR                           S01447
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
      *** calculate amount deducted at source                             S01447
      *                                                                   S01447
     C           UTXRSR    DIV  100       URATE   54                      S01447
     C           PAMD      MULT URATE     TASO      H                     S01447
      *                                                                   S01447
      *** calculate amount deducted refundable                            S01447
      *                                                                   S01447
     C           UTXRRF    DIV  100       URATE                           S01447
     C           PAMD      MULT URATE     TASR      H                     S01447
      *                                                                   S01447
      *** calculate amount deducted by user                               S01447
      *                                                                   S01447
     C                     CLEARTAUS                                      S01447
      *                                                                   S01447
     C           UTXRUS    IFGT *ZERO                      *B1            S01447
      *                                                                   S01447
     C           UDLOR     IFEQ 'N'                        *B2            S01447
     C                     MOVE PCPY      WCUST                           S01447
     C           CLKYCB    CHAINCLINT                54                   S01447
     C           *IN54     IFEQ '1'                        *B3            S01447
     C           RECI      OREQ '*'                                       S01447
     C           *LOCK     IN   LDA                                       S01447
     C                     MOVEL'CLINTCB 'DBFILE           ***************S01447
     C                     MOVELPCPY      DBKEY            ** DBERROR 021 S01447
     C                     Z-ADD21        DBASE            ***************S01447
     C                     SETON                       U7U8               S01447
     C                     EXSR *PSSR                                     S01447
     C                     GOTO EAUDIT                                    S01447
     C                     END                             *E3            S01447
     C                     END                             *E2            S01447
      *                                                                   S01447
     C           UDLOR     IFEQ 'Y'                        *B2            S01447
     C           UDLOR     OREQ 'N'                                       S01447
     C           CLOC      ANDNEUBRLOC                                    S01447
      *                                                                   S01447
     C           UTXRUS    DIV  100       URATE                           S01447
     C/COPY WNCPYSRC,SE4860C058
     C           PAMD      MULT URATE     TAUS      H                     S01447
     C/COPY WNCPYSRC,SE4860C059
     C                     END                             *E2            S01447
      *                                                                   S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C                     ENDSR                                          S01447
      *                                                                   S01447
      *****************************************************************   S01117
      *                                                               *   S01117
      *  SECPPC - Subroutine to get customer position profit centre   *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           SECPPC    BEGSR                           ** SECPPC **   S01117
      *                                                                   S01117
      ** Chain for customer position profit centre record                 S01117
      *                                                                   S01117
     C           KSEPCC    CHAINSEPCCDF              79            S01117 081336
     C           *IN79     IFNE '1'                                S01117 081336
     C           RECI      COMP '*'                      79        S01117 081336
     C                     END                                     S01117 081336
      *                                                                   S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
     C*****************************************************************   S01117
      /EJECT
      *****************************************************************
      *                                                               *
      *  SECTIN - Subroutine to get Security record.                  *
      *                                                               *
      *****************************************************************
      *
     C           SECTIN    BEGSR                           ** SECTIN **
      *
      ** CHAIN FOR SECURITY RECORD AND DATA BASE ERROR
      *
     C           SECTKY    CHAINSECTY                82                   081383
     C           *IN82     IFNE '1'                                       081383
     C           RECIS     COMP '*'                      82               033988
     C                     END                                            081383
     C           *IN82     IFEQ '1'                                       081383
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SECTY'   DBFILE           ***************
     C                     MOVELSASN      DBKEY            * DB ERROR 04 *
     C                     Z-ADD4         DBASE            ***************
     C                     SETON                     U7U8                 S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C                     ELSE                                           E37289
     C                     MOVE RECI      SCRECI  1                       E37289
     C                     MOVE CPDP      UCPDP
     C                     MOVE CFCT      UCFCT
     C                     END
      *                                                                   S01447
      *** Access security WHT details file                                S01447
      *                                                                   S01447
     C           SECTKY    CHAINSESWHTL0             80                   S01447
      *
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  INVTIN - Subroutine to get Investment Type record.           *
      *                                                               *
      *****************************************************************
      *
     C           INVTIN    BEGSR                           ** INVTIN **
      *
      ** CHAIN FOR INVESTMENT TYPE RECORD AND DATA BASE ERROR
      *
     C           INVTKY    CHAININVTP                82                   081383
     C           *IN82     IFNE '1'                                       081383
     C           RECI      COMP '*'                      82               081383
     C                     END                                            081383
     C           *IN82     IFEQ '1'                                       081383
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'INVTP'   DBFILE           ***************
     C                     MOVELINVKEY    DBKEY            * DB ERROR 05 *
     C                     Z-ADD5         DBASE            ***************
     C                     SETON                     U7U8                 S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  TG10   - Subroutine to get Security Currency Decimal Places  *
      *           from TABTG10.                                       *
      *                                                               *
      *****************************************************************
      *
     C           TG10      BEGSR                           ** TG10   **
      *
      ** CHAIN FOR CURRENCY RECORD IN TABLE TABTG10
      ** FIELD WCURR CONTAINS THE CURRENCY WHEN THIS SUBROUTINE EXECUTED
      *
      * IF WCURR IS EQUAL TO WLSTCY (LAST CCY TO ACCESS TABTG10) IGNORE
      *
     C           WCURR     CABEQWLSTCY    ENDT10
     C                     MOVE WCURR     WLSTCY  3
      *
     C                     MOVEL'20      'ZTABKY 12
     C                     MOVE '1'       WRK4    4
     C                     MOVELWCURR     WRK4
     C                     MOVE WRK4      ZTABKY
      **
     C           ZTABKY    CHAINTABTG10F             99
      *
      * ERROR IF NO RECORD FOUND OR IF IT IS DELETED
      *
     C           *IN99     IFEQ '1'
     C                     SETON                     U7U8
     C                     ELSE
     C           RECI      IFEQ '*'
     C                     SETON                     U7U8
     C                     END
     C                     END
     C           *INU7     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY            * DB ERROR 07 *
     C                     Z-ADD7         DBASE            ***************
     C                     SETON                     U7U8                 S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C                     END
      *                                                                   S01117
      **  Set up new output parameter for use in SR.ZCNSD                 S01117
      *                                                                   S01117
     C                     Z-ADDCDP       ZCDP                            S01117
      *
     C           ENDT10    ENDSR                           ** ENDT10 **
      *
      *****************************************************************
      /EJECT                                                              S01446
     C*****************************************************************   S01446
      *                                                               *   S01446
      *  #LCURR - Subroutine to get currency details from SDCURRPD    *   S01446
      *                                                               *   S01446
      *****************************************************************   S01446
      *                                                                   S01446
     C           #LCURR    BEGSR                                          S01446
      *                                                                   S01446
     C                     CALL 'AOCURRR0'                                S01446
     C                     PARM *BLANKS   @RTCD   7                       S01446
     C                     PARM '*KEY   ' @OPTN   7                       S01446
     C                     PARM WCURR     @AJCD   3                       S01446
     C           SDCURR    PARM SDCURR    DSSDY                           S01446
      *                                                                   S01446
     C           @RTCD     IFNE *BLANKS                                   S01446
     C                     SETON                     U7U899               S01446
     C           *LOCK     IN   LDA                                       S01446
     C                     MOVE 'SDCURRPD'DBFILE           ***************S01446
     C                     MOVELWCURR     DBKEY            * DB ERROR    *S01446
     C                     Z-ADDWDBAS1    DBASE            ***************S01446
     C                     DUMP                                           S01446
     C                     GOTO EAUDIT                                    S01446
     C                     END                                            S01446
      *                                                                   S01446
     C                     ENDSR                                          S01446
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  #EVUPD - Access SE Diary and Non Diary File to update        *
      *  ------   Positon Settlement generated date or new event      *
      *                                                               *
      *  Called by :                                                  *
      *  Calls     : *PSSR                                            *
      *                                                               *
      *****************************************************************
      *
     C           #EVUPD    BEGSR                           ** SECEDI **
      *
      ** CHAIN FOR SECURITY EVENT RECORD AND DATA BASE ERROR
      *
     C                     MOVE P9SDSN    K9SDSN
     C                     MOVE P9SDED    K9SDED
     C                     MOVE P9SDET    K9SDET
      *
     C           SEDEVE    CHAINSEDEVDV              7877
     C           *IN78     IFNE '1'
     C           *IN77     ANDNE'1'
     C           SDDT      ANDEQ*ZERO
      *
     C           SEDEVE    CHAINSEDEVDF              7877
     C           *IN78     IFNE '1'
     C           *IN77     ANDNE'1'
     C           RECI      COMP '*'                      78
     C  N78      RECI      COMP 'C'                      78
     C                     END
      *
     C           *IN78     IFNE '1'
     C           SDDT      IFEQ *ZERO
     C                     Z-ADDBJRDNB    SDDT
     C                     ADD  1         WDEVEU  50
     C                     END
     C           *IN77     IFNE '1'
     C                     UPDATSEDEVDF
     C                     END
     C                     END
      *
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #GETNP - Get Depot Nominal Position using new Position       *
      *  ------   Calculation Routine.                                *
      *                                                               *
      *  Called by : SRMAIN                                           *
      *  Calls     :          *PSSR                                   *
      *                                                               *
      *****************************************************************
     C           #GETNP    BEGSR
      *
     C                     MOVE 'N'       CALSEP  1
     C**********           MOVE *BLANKS   PERROR           HUT118
     C                     MOVE *BLANKS   PERROR  1        HUT118
     C                     MOVE *OFF      *IN55
      * Save fields
     C                     MOVE *BLANKS   PRVPTF
     C**********           Z-ADD*ZEROS    PRVDEP           HUT118
     C                     MOVEL*BLANKS   PRVDEP           HUT118
     C                     MOVE CSCN      PRVCUS
     C                     MOVE CSBA      PRVBRA
      *
      *
      * SEC8100 : if called with PTYPE = 'C', Customer Position is returned
      *           if called with PTYPE = 'E', Customer/Depot Position is returned
      *
     C*********            MOVE CSCN      ZCUST6           HUT118
     C                     MOVE CSCN      ZCUST6  6        HUT118
     C                     MOVE *BLANKS   ZCUDEP
     C                     MOVE CSBA      ZBRCH
     C*********            MOVE *BLANKS   PPTFR            HUT118
     C                     MOVE *BLANKS   PPTFR   4        HUT118
     C*********            Z-ADD*ZEROS    ZDEPOT  60       HUT118
     C                     MOVEL*BLANKS   ZDEPOT  6        HUT118
     C                     MOVE 'C'       PTYPE   1
      *
      *  If Portfolio Position, then set PTYP = 'E' to get the Cust/Depo Position
     C           WPORTP    IFEQ 'Y'
     C           BGPFMG    ANDEQ'Y'
     C           WPORTP    OREQ 'Y'
     C           BGN4ST    ANDEQ'Y'
     C                     MOVE WWPTFR    PRVPTF
     C                     MOVE CDCN      PRVCUS
     C                     MOVE CDPA      PRVBRA
     C                     MOVE CDPT      PRVDEP
      *
     C                     MOVE CDPT      ZCUDEP
     C                     MOVE WWPTFR    PPTFR
     C                     MOVE CDCN      ZCUST6
     C                     MOVE CDPA      ZBRCH
     C********             Z-ADDCDPT      ZDEPOT  60       HUT118
     C                     MOVELCDPT      ZDEPOT  6        HUT118
     C                     MOVE 'E'       PTYPE   1
     C                     END
      *
      * set parameters to call Nominal Position Calculation Routine
      *
      * set Date = Event Date - 1
     C*********  P9SDED    SUB  1         ZWDDTE                            HUT118
     C           P9SDED    SUB  1         ZWDDTE  50                        HUT118
      *
      * If Dividend, set Date = Ex-date - 1
     C           P9SDET    IFEQ 'DV'
     C           S01510    ANDEQ'Y'
     C           P9SDXD    SUB  1         ZWDDTE
     C                     END
      *
      * Value/Trade Date basis
      *
     C                     MOVE 'V'       PBASIS  1
      *
     C           CSE008    IFNE 'Y'
     C           P9SDET    ANDEQ'DV'
     C                     MOVE 'T'       PBASIS  1
     C                     END
      *
      * ************************************************************************
      * At the moment - SEC8100  is only called if function runs in I/C
      *
     C           @PHASE    IFEQ 'I'                        B* CALL SEP
      * ************************************************************************
      *
     C                     MOVE 'Y'       CALSEP  1
      *
      * Input  Parameter
     C                     CALL 'SEC8100'              55
     C                     PARM           ZBRCH   3
     C                     PARM P9SDSN    ZSECT  10
     C                     PARM '  '      PBOOK   2
     C                     PARM MKTI      FMKT    1
     C****                 PARM           ZDEPOT  60                      HUT118
     C                     PARM           ZDEPOT  6                       HUT118
     C****                 PARM           ZCUST6  60                      HUT118
     C                     PARM           ZCUST6  6                       HUT118
     C                     PARM           PPTFR   4
     C                     PARM           PBASIS  1
     C                     PARM           ZWDDTE  50
     C                     PARM           PTYPE   1
     C                     PARM ' '       PREPO   1
     C                     PARM ' '       PUNAU   1
      *
      * Output Parameter
     C                     PARM *ZEROS    ZNOMNL 150
     C                     PARM *ZEROS    ZEXCPB 150
     C                     PARM *ZEROS    ZPRICE 158
     C                     PARM ' '       PERROR  1
      *
      * Set Nominals returned from Nominal Position Calculation Routine
      *
     C           PERROR    IFEQ '1'
     C           @PHASE    ANDEQ'I'
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD5         DBASE
     C           'NOM PS R'CAT  'OUTINE'  DBKEY     P
     C                     MOVE 'Rt '     DBFILE
     C                     MOVELZCUST6    DBKEY     P
     C                     MOVEL'XX118008'DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      * If error on call to SEC8100 , and if function is running in I/C, then set
      *    Nominal to zero
     C           *IN55     IFEQ *ON
     C           @PHASE    ANDEQ'I'
     C                     Z-ADD0         ZEXCPB
     C                     Z-ADD0         ZNOMNL
     C                     END
      *
     C                     END                             E* CALL SEP
      *
      *
      * IF error when calling SEC8100  and program is running during Cob, or if Pgm SEC8100
      *    not called when @Phase is 'C', then set  ZNOMML to the value read from file
      *
     C           @PHASE    IFEQ 'C'                        B* PHASE COB
      *
     C           *IN55     IFEQ *ON
     C           PERROR    OREQ '1'
     C           CALSEP    OREQ 'N'
      *
     C                     Z-ADDCSEX      ZEXCPB
     C           WPORTP    IFEQ 'Y'
     C           BGPFMG    ANDEQ'Y'
     C           WPORTP    OREQ 'Y'
     C           BGN4ST    ANDEQ'Y'
      *
     C           PBASIS    IFEQ 'V'
     C                     MOVE CDNV      ZNOMNL
     C                     ELSE
     C                     MOVE CDNT      ZNOMNL
     C                     END
      *
     C                     ELSE
      *
     C           PBASIS    IFEQ 'V'
     C                     MOVE CSNV      ZNOMNL
     C                     ELSE
     C                     MOVE CSNT      ZNOMNL
     C                     END
     C                     END
     C                     END
      *
     C                     ENDIF                           E* PHASE COB
      *
      * Set fields
     C                     MOVE ZEXCPB    CSEX
     C           WPORTP    IFEQ 'Y'
     C           BGPFMG    ANDEQ'Y'
     C           WPORTP    OREQ 'Y'
     C           BGN4ST    ANDEQ'Y'
      *
     C           PBASIS    IFEQ 'V'
     C                     MOVE ZNOMNL    CDNV
     C                     ELSE
     C                     MOVE ZNOMNL    CDNT
     C                     END
      *
     C                     ELSE
      *
     C           PBASIS    IFEQ 'V'
     C                     MOVE ZNOMNL    CSNV
     C                     ELSE
     C                     MOVE ZNOMNL    CSNT
     C                     END
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *
      *****************************************************************
      *  #CHKPO - Check if Position Settlement already exist          *
      *  ------                                                       *
      *  Called by : #DIVID                                           *
      *  Calls     :                                                  *
      *****************************************************************
      *
     C           #CHKPS    BEGSR
      *
      * Clear fields
      *
     C                     MOVE 'N'       ZFOUND
     C                     CLEARZNWCMP
     C                     CLEARZNWPRE
     C                     CLEARZNWDUE
      *
      * Position Settlement existing check is not done for Treaty Tax
      *
     C********   CRTT      IFEQ *BLANKS                    B* Treaty Tax
      *
      * set parameters
     C           P9SDET    IFEQ 'DV'
     C           S01512    ANDNE'Y'
     C                     MOVE P9SDPD    ZDUEDT
     C                     ELSE
     C                     MOVE P9SDED    ZDUEDT
     C                     END
      *
      * Set Pay/Receive indicator
     C           WCUMCP    IFGT 0
     C                     MOVE 'P'       ZPPRE   1
     C                     ELSE
     C                     MOVE 'R'       ZPPRE
     C                     END
      * Input  Parameter
      * ZCHKFL = 'U', if Position settlements are found, they are deleted according to the
      *          Position Settlement Adjustmnet System Value
      * ZCHKFL = 'C', if Position settlements are found, they are not deleted
      *
     C           ZAUDIT    IFNE 'F'
     C                     MOVE 'F'       ZAUDIT  1
     C                     MOVE 'F'       ZOPEN   1
     C                     ELSE
     C                     MOVE ' '       ZOPEN
     C                     END
      *
     C                     MOVE P9SDET    ZSDET
      *
     C                     CALL 'XX118006'             55
     C                     PARM           ZBRCH   3
     C                     PARM P9SDSN    ZSECT  10
     C********             PARM ZCUST6    ZDEPOT  60                      HUT118
     C                     PARM ZCUST6    ZDEPOT  6                       HUT118
     C                     PARM           ZDUEDT  50
     C                     PARM           ZSDET   2
     C                     PARM           PTFR
     C                     PARM 'U'       ZCHKFL  1
     C                     PARM           WCUMCP
     C                     PARM           ZPPRE
     C                     PARM           ZCUDEP  6
     C                     PARM CRTT      ZCRTT   2
     C                     PARM           @PHASE  1                       CSE053
      *
      * Output Parameters
     C                     PARM *BLANKS   ZFOUND  1
     C                     PARM *ZEROS    ZNWCMP 150
     C                     PARM ' '       ZNWPRE  1
     C                     PARM *ZEROS    ZNWDUE 150
     C                     PARM           ZOPEN   1
     C                     PARM *BLANKS   ZRTNCD  7
      *
      * Check if error occurred
     C           *IN55     IFEQ '1'
     C           ZRTNCD    ORNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD22        DBASE
     C           'XX118006'CAT  'ROUTINE' DBKEY     P
     C                     MOVE 'Rt '     DBFILE
     C                     MOVELZCUST6    DBKEY     P
     C                     MOVEL'XX118008'DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C************         END                             E* Treaty Tax
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *  SRENDP -  Termination processing                             *
      *  ------                                                       *
      *  Called by : Main processing                                  *
      *  Calls     : None                                             *
      *****************************************************************
      *
     C           SRENDP    BEGSR
      *
      * Allow XX118006 to generate AUDIT printer file
     C                     CALL 'XX118006'             55
     C                     PARM           ZBRCH   3
     C                     PARM P9SDSN    ZSECT  10
     C********             PARM ZCUST6    ZDEPOT  60                      HUT118
     C                     PARM ZCUST6    ZDEPOT  6                       HUT118
     C                     PARM           ZDUEDT  50
     C                     PARM '  '      ZSDET
     C                     PARM           PTFR
     C                     PARM 'U'       ZCHKFL  1
     C                     PARM           WCUMCP
     C                     PARM           ZPPRE
     C                     PARM *BLANKS   ZCUDEP  6
     C                     PARM *BLANKS   ZCRTT   2
     C                     PARM           @PHASE  1                       CSE053
      *
      * Output Parameters
     C                     PARM *BLANKS   ZFOUND  1
     C                     PARM *ZEROS    ZNWCMP 150
     C                     PARM ' '       ZNWPRE  1
     C                     PARM *ZEROS    ZNWDUE 150
     C                     PARM 'L'       ZOPEN   1
     C                     PARM *BLANKS   ZRTNCD  7
      *
      * Check if error occurred
      *
     C           *IN55     IFEQ *ON
     C           ZRTNCD    ORNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD23        DBASE
     C           'XX118006'CAT  'EOF   '  DBKEY     P
     C                     MOVEL'XX118008'DBPGM     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Update Position Settlement audit file
     C                     OPEN POSETA
     C                     READ POSETAF                  02
     C           *IN02     IFEQ *OFF
     C                     ADD  W02CNT    NORE
     C                     ADD  W02CNT    NOIN                                   CSE053
     C                     Z-ADD*ZEROS    TNLU
     C                     UPDATPOSETAF
     C                     ELSE
     C                     Z-ADDW02CNT    NOIN                                   CSE053
     C                     Z-ADDW02CNT    NORE
     C                     Z-ADD*ZEROS    TNLU
     C                     WRITEPOSETAF
     C                     ENDIF
     C                     CLOSEPOSETA
      *
      *                                                                   S01486
      **  If Portfolio Management is on, close PM files                   S01486
      *                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     CLOSEPMPORTPD                                  S01486
     C                     CLOSEPMACCNL0                                  S01486
     C                     CLOSEPMACCNL1                                  219688
     C                     CLOSESECET                                     S01486
     C                     CLOSESEEVNT                                    S01486
     C                     END                                            S01486
     C                     CLOSESEDEVL3
     C*******              CLOSESEPSDNL0               46                            HUT118
     C                     CLOSEXXPSDNV0               46                            HUT118
      *
      * Output Control Report
      *
     C           WWDATA    IFEQ 'N'
     C                     WRITEHEADAU
     C                     WRITENODTLS                     No detail to report
     C                     ELSE
     C                     WRITEHEADAU
     C                     WRITECONTROL
     C                     ENDIF
     C/COPY WNCPYSRC,SE4859C051
      *
      * UPDATE SNDEVA AUDIT RECORD
      *
      *
     C           1         CHAINSNDEVAF              99
      *
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8            ***************
     C                     Z-ADD50        DBASE            **DB ERROR 50**
     C                     MOVEL'SNDEVA'  DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C*
     C                     ADD  0         WNDADD  50       HUT118
     C                     ADD  WNDADD    NORE
      *
     C                     UPDATSNDEVAF
     C*
     C                     MOVE *ON       *INLR
      *
     C                     ADD  W02CNT    @WNPOS                                     HUT118
      *                                                                              HUT118
      ***  Return out of the program
      *
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CLNTIN - Subroutine to get CLINTSE Client record.            *
      *                                                               *
      *****************************************************************
      *
     C           CLNTIN    BEGSR                           ** CLNTIN **
      *
     C           CLINTK    CHAINCLINT                76
     C           *IN76     IFNE '1'
     C           RECI      COMP '*'                      76
     C                     END
     C           *IN76     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'CLINT'   DBFILE           ***************
     C                     MOVELWCLNTK    DBKEY            * DB ERROR 10 *
     C                     SETON                     U7U8  ***************
     C                     Z-ADD10        DBASE
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
     C********************************************************************AR324886
     C           PSAUDT    BEGSR                                          AR324886
      *                                                                   AR324886
     C                     MOVE RECI      PARECI                          AR324886
     C                     MOVE PBCA      PAPBCA                          AR324886
     C                     MOVE PSSH      PAPSSH                          AR324886
     C                     MOVE PCPY      PAPCPY                          AR324886
     C                     MOVE PDUD      PAPDUD                          AR324886
     C                     MOVE PEVT      PAPEVT                          AR324886
     C                     MOVE PTFR      PAPTFR                          AR324886
     C                     MOVE TNLU      PATNLU                          AR324886
     C                     MOVE TXBS      PATXBS                          AR324886
     C                     MOVE BNFO      PABNFO                          AR324886
     C                     MOVE EXCD      PAEXCD                          AR324886
     C           LIBR      CAT  'OWNER'   PALUSR                          AR324886
     C                     MOVE LCD       PALCD                           AR324886
     C                     MOVE CHTP      PALCTP                          AR324886
     C                     WRITEPSAUTDF                                   AR324886
      *                                                                   AR324886
     C                     ENDSR                                          AR324886
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  *PSSR  - Error control subroutine                            *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
      **                                                                  S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
      **                                                                  S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
     C*****************************************************************
      /EJECT                                                              S01512
      *                                                                   S01486
      ********************************************************************S01486
      **  ZTNLU1     :       TO LOCK THE TRANSACTION NUMBER DATA AREA,    S01486
      **                     ACCESS THE NEXT AVAILABLE TRANSACTION NUMBER,S01486
      **                     THEN UPDATE AND RELEASE THE DATA AREA.       S01486
      ********************************************************************S01486
     C           ZTNLU1    BEGSR                            ** ZTNLU1 BSR*S01486
      *                                                                   S01486
     C           *NAMVAR   DEFN MNATN     DNATN                           S01486
     C           *LOCK     IN   DNATN                                     S01486
     C                     MOVE FNATN     NATN    50                      S01486
     C                     MOVE FNATN     ZZWK05  50                      S01486
     C                     ADD  1         ZZWK05                          S01486
     C                     MOVE ZZWK05    FNATN                           S01486
     C                     OUT  DNATN                                     S01486
      *                                                                   S01486
     C                     ENDSR                            ** ZTNLU1 ESR*S01486
     C********************************************************************S01486
     C/COPY WNCPYSRC,SE4860C060
      /EJECT                                                              064754
     C/COPY ZSRSRC,ZNCDZ3                                                 064754
      /EJECT
     C/COPY ZSRSRC,ZACCH                                                  S01512
      /EJECT                                                              S01519
     C/COPY ZSRSRC,ZAVPRZ1                                                S01519
      /EJECT                                                              S01519
     C/COPY ZSRSRC,ZCCAL1Z2                                               S01519
      /EJECT                                                              S01519
     C/COPY ZSRSRC,ZCCAL2Z1                                               S01519
      /EJECT
     C/COPY ZSRSRC,ZCNSDZ1                                                E22638
      /EJECT                                                              S01512
     C/COPY ZSRSRC,ZCONVZ1                                                S01509
      /EJECT                                                              S01512
     C/COPY ZSRSRC,ZFWDT                                                  S01512
     C/EJECT                                                              E22638
     C/COPY ZSRSRC,ZCCYGBZ1                                               S01486
     C/COPY ZSRSRC,ZCCYCN                                                 S01486
     C/COPY ZSRSRC,ZCCYXR                                                 S01486
     C/COPY ZSRSRC,ZAINSH                                                 S01486
      *****************************************************************   S01486
      *                                                               *   S01486
      *  ZAISCH - CALCULATE SE ACCRUED INTEREST - SCHULDSCHEIN        *   S01486
      *                                                               *   S01486
      *  PURPOSE : TO CALCULATE SE ACCRUED INTEREST FOR               *   S01486
      *            SCHULDSCHEIN SECURITIES                            *   S01486
      *                                                               *   S01486
      *  FILE USED                                                    *   S01486
      *       LF/SEEVNT: SECURITY EVENTS FILE OVERRIDEN IN CALLING PGM*   S01486
      *       FIELDS TO BE RENAMED IN I SPECS:                        *   S01486
      *         SNDT (SNDEVD) TO SDED                                 *   S01486
      *         SNET (SNDEVD) TO SDET                                 *   S01486
      *       LF/PMAPOSLL:ALL PORTFOLIO POSITIONS                     *   S01486
      *                                                               *   S01486
      *  FILES NEEDED (THESE FILES AND DATA AREA MUST HAVE BEEN       *   S01486
      *                ACCESSED BEFORE THIS SUBROUTINE IS EXECUTED)   *   S01486
      *       LF/SECTY: SECURITIES                                    *   S01486
      *       LF/INVTP: INVESTMENT TYPES                              *   S01486
      *       LF/SDCURRL0: CURRENCIES, FOR NOMINAL CURRENCY D.P.      *   S01486
      *       DTAARA/PMSTAT: FOR EVENT CONTROL DATE                   *   S01486
      *                                                               *   S01486
      *  SUBROUTINES NEEDED                                           *   S01486
      *       ZNCD MUST HAVE BEEN CALLED BEFORE CALLING THIS SUBR.    *   S01486
      *                                                               *   S01486
      *  INPUT  FIELDS                                                *   S01486
      *       ZFMDAT  5 0     FROM DATE                               *   S01486
      *       ZTODAT  5 0     TO DATE                                 *   S01486
      ******  XCUST   6 0     CUSTOMER                                *   HUT118
      *       XCUST   6       CUSTOMER                                *   HUT118
      *       ZPTRF   4       PORTFOLIO REFERENCE                     *   S01486
      *       ZSSNM  10       SECURITY SHORTNAME                      *   S01486
      *                                                               *   S01486
      *  OUTPUT  FIELDS                                               *   S01486
      *       ZTOAI  15 0     TOTAL ACCRUED INTEREST                  *   S01486
      *       ZTOND   5 0     TOTAL NUMBER OF INTEREST DAYS           *   S01486
      *                                                               *   S01486
      *  WORK FIELDS:                                                 *   S01486
      *                                                               *   S01486
      *  CALLS:  ZRATE, ZACCR                                         *   S01486
      *****************************************************************   S01486
     C           ZAISCH    BEGSR                           *** ZAISCH *** S01486
      *                                                                   S01486
      ** DEFINE FIELDS                                                    S01486
     C                     Z-ADDZFMDAT    ZFMDAT  50                      S01486
     C                     Z-ADDZTODAT    ZTODAT  50                      S01486
     C                     MOVE ZCDPA     ZCDPA   3                       189942
     C********             Z-ADDXCUST     XCUST   60               S01486 HUT118
     C                     MOVELXCUST     XCUST   6                       HUT118
     C                     MOVE ZPTRF     ZPTRF   4                       S01486
     C                     MOVE ZSSNM     ZSSNM  10                       S01486
     C********             Z-ADDZCDDP     ZCDDP   60               189942 HUT118
     C                     MOVELZCDDP     ZCDDP   6                       HUT118
     C                     MOVE ZCDMK     ZCDMK   1                       189942
      *                                                                   S01486
      ** SET THE TOTAL ACCRUED INTEREST ZTOAI AND TOTAL NUMBER OF         S01486
      ** INTEREST DAYS ZTOND EQUAL TO ZERO                                S01486
     C                     Z-ADD0         ZTOAI  150                      S01486
     C                     Z-ADD0         ZTOND   50                      S01486
     C                     Z-ADD0         ZSINP  150                      S01486
      *                                                                   S01486
      *  - Security Diary Events
     C           SEDEVE    KLIST
     C                     KFLD           K9SDSN
     C                     KFLD           K9SDED
     C                     KFLD           K9SDET
      *                                                                                CSE053
      *  - Security Diary Events                                                       CSE053
     C           SEDEVS    KLIST                                                       CSE053
     C                     KFLD           K9SDSN                                       CSE053
     C                     KFLD           K9SDED                                       CSE053
     C                     KFLD           K9SDET                                       CSE053
      *
      *  - Security Non Diary Events
     C           SEDNDE    KLIST
     C                     KFLD           K9SDSN
     C                     KFLD           K9SDET
     C                     KFLD           K9SDED
      *
     C           KSEE1     KLIST                                          S01486
     C                     KFLD           ZSSNM                           S01486
     C                     KFLD           ZFMDAT                          S01486
     C                     KFLD           ZTYP                            S01486
      *                                                                   S01486
      *                                                                   189942
     C           KPMA1     KLIST                                          189942
     C                     KFLD           ZCDPA                           189942
     C                     KFLD           XCUST                           189942
     C                     KFLD           ZPTRF                           189942
     C                     KFLD           ZSSNM                           189942
     C                     KFLD           ZCDDP                           189942
     C                     KFLD           ZCDMK                           189942
     C                     KFLD           ZFMDAT                          189942
      *                                                                   189942
     C           KPMA1     SETGTSECDEPL5                                  189942
      *                                                                   189942
      ** READ PREVIOUS FROM LF/SECDEPL5                                   189942
     C                     READPSECDEPL5                 91               189942
      *                                                                   S01486
     C           ZCDPA     IFEQ CDPA                                      189942
     C           XCUST     ANDEQCDCN                                      189942
     C           ZPTRF     ANDEQPTFR                                      189942
     C           ZPTRF     ANDEQPTFR                                      189942
     C           ZSSNM     ANDEQCDSN                                      189942
     C           ZCDDP     ANDEQCDPT                                      189942
     C           ZCDMK     ANDEQCDMK                                      189942
      *                                                                   S01486
     C           CDNV      SUB  CSEX      ZAMT                            189942
     C                     ELSE                                           S01486
      *                                                                   S01486
      ** IF THEY ARE DIFFERENT OR EOF IS REACHED, SET THE PRINCIPAL       S01486
      ** AMOUNT ZAMT EQUAL TO ZERO                                        S01486
     C                     Z-ADD0         ZAMT                            S01486
     C                     END                                            S01486
      *                                                                   S01486
      ** SET THE FOLLOWING FIELDS FOR STANDARD SUBROUTINE ZRATE           S01486
      ** SET ZPPCP EQUAL TO CPDP FROM LF/SECTY                            S01486
     C                     Z-ADDCPDP      ZPPCP                           S01486
      ** SET ZSFPP EQUAL TO SFPP FROM LF/SECTY                            S01486
     C                     Z-ADDSFPP      ZSFPP                           S01486
      ** SET ZSINP EQUAL TO SINP FROM LF/SECTY                            S01486
     C                     Z-ADDSINP      ZSINP                           S01486
      ** SET ZPPDI EQUAL TO PPDI FROM LF/SECTY                            S01486
     C                     MOVE PPDI      ZPPDI                           S01486
      ** SET ZCPNR EQUAL TO CPNR FROM LF/SECTY                            S01486
     C                     Z-ADDCPNR      ZCPNR                           S01486
      ** SET ZCFCT EQUAL TO CFCT FROM LF/SECTY                            S01486
     C                     Z-ADDCFCT      ZCFCT                           S01486
      ** SET ZPROT EQUAL TO PROT FROM LF/INVTP                            S01486
     C                     MOVE PROT      ZPROT                           S01486
      *                                                                   S01486
      ** SET THE FOLLOWING FIELDS FOR STANDARD SUBROUTINE ZACCR           S01486
     C                     Z-ADDA6NBDP    ZCDP                            S01486
      *                                                                   S01486
      ** ACCESS LF/SEEVNT USING A KEY OF SECURITY ZSSNM, FROM DATE        S01486
      ** ZFMDAT AND EVENT TYPE EQUAL TO 'CP'                              S01486
     C                     MOVEL'CP'      ZTYP    2                       S01486
     C           KSEE1     CHAINSEEVNT               91                   S01486
     C           *IN91     IFEQ '0'                                       S01486
      *                                                                   S01486
      ** IF A LAST COUPON DATE EVENT IS READ ABOVE, (NOTE THAT ZFMDAT     S01486
      ** WILL BE A COUPON DATE) THEN SET THE FIELDS USED BY ZRATE         S01486
      ** AS FOLLOWS:                                                      S01486
      ** SET ZCPNR EQUAL TO SNCR FROM LF/SEEVNT                           S01486
     C                     Z-ADDSNCR      ZCPNR                           S01486
      ** SET ZCFCT EQUAL TO SNCF FROM LF/SEEVNT                           S01486
     C                     Z-ADDSNCF      ZCFCT                           S01486
      ** SET ZPPCP EQUAL TO SNCP FROM LF/SEEVNT                           S01486
     C                     Z-ADDSNCP      ZPPCP                           S01486
     C                     END                                            S01486
      *                                                                   S01486
      ** SET START OF INTEREST PERIOD DATE ZSDATE EQUAL TO THE FROM       S01486
      ** DATE ZFMDAT                                                      S01486
     C                     Z-ADDZFMDAT    ZSDATE                          S01486
      *                                                                   S01486
      ** SET GREATER THAN LIMITS ON LF/SEEVNT USING A KEY OF SECURITY     S01486
      ** ZSSNM, FROM DATE ZFMDAT AND EVENT TYPE EQUAL TO 'CP'             S01486
     C           KSEE1     SETGTSEEVNT                                    S01486
      *                                                                   S01486
      ** READ EQUAL FROM LF/SEEVNT WITH A KEY EQUAL TO THE SECURITY       S01486
      ** SHORTNAME ZSSNM                                                  S01486
     C           ZSSNM     READESEEVNT                   91               S01486
      *                                                                   S01486
      ** READ UNTIL THE EVENT HAS AN EVENT TYPE SDET EQUAL TO 'PP' 'MP' OR 'IR'
      *                                                                   S01486
     C           *IN91     DOWEQ'0'                                       S01486
     C           SDET      ANDNE'PP'                                      S01486
     C           SDET      ANDNE'MP'                                      S01486
     C           SDET      ANDNE'IR'                                      S01486
     C           ZSSNM     READESEEVNT                   91               S01486
     C                     END                                            S01486
      *                                                                   S01486
      ** SET GREATER THAN LIMITS ON LF/PMAPOSLL WITH A KEY OF CUSTOMER    S01486
      ***ZCUST,*PORTFOLIO*ZPTRF,*SECURITY*ZSSNM*AND*TRADE/VALUE*DATE      S01486
      ** XCUST, PORTFOLIO ZPTRF, SECURITY ZSSNM AND TRADE/VALUE DATE      S01486
      ** BASIS ZTVBS AND A DATE EQUAL TO THE FROM DATE ZFMDAT             S01486
     C           KPMA1     SETGTSECDEPL5                                  189942
      *                                                                   S01486
     C           KPMA2     KLIST                                          189942
     C                     KFLD           ZCDPA                           189942
     C                     KFLD           XCUST                           189942
     C                     KFLD           ZPTRF                           189942
     C                     KFLD           ZSSNM                           189942
     C                     KFLD           ZCDDP                           189942
     C                     KFLD           ZCDMK                           189942
     C           KPMA2     READESECDEPL5                 92               189942
      *                                                                   S01486
      ** DO WHILE NOT END OF FILE (IE. SAME SECURITY) ON LF/SEEVNT        S01486
      ** AND NOT END OF FILE (IE. SAME CUSTOMER, PORTFOLIO, SECURITY,     S01486
      ** TRADE/VALUE BASIS) ON LF/PMAPOSLL                                S01486
     C           *IN91     DOWEQ'0'                                       S01486
     C           *IN92     OREQ '0'                                       S01486
      *                                                                   S01486
      ** IF NOT END OF FILE ON LF/SEEVNT                                  S01486
     C           *IN91     IFEQ '0'                                       S01486
      *                                                                   S01486
      ** IF NOT END OF FILE ON LF/PMAPOSLL AND THE EVENT DATE SDED        S01486
      ** FROM LF/SEEVNT IS LESS THAN OR EQUAL TO THE POSITION DATE        S01486
      ** FROM LF/PMAPOSLL OR END OF FILE ON LF/PMAPOSLL                   S01486
     C           *IN92     IFEQ '0'                                       S01486
     C           SDED      ANDLEDDTE                                      189942
     C           SDED      ANDLTZTODAT                                    S01486
     C           *IN92     OREQ '1'                                       S01486
     C           SDED      ANDLTZTODAT                                    S01486
      *                                                                   S01486
      ** SET THE END OF INTEREST PERIOD DATE ZEDATE EQUAL TO THE EVENT    S01486
      ** DATE SDED FROM LF/SEEVNT                                         S01486
     C                     Z-ADDSDED      ZEDATE                          S01486
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZRATE TO GET THE EFFECTIVE           S01486
      ** INTEREST RATE FOR THE PERIOD                                     S01486
     C                     EXSR ZRATE                                     S01486
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZACCR TO CALCULATE THE INTEREST      S01486
      ** FOR THE PERIOD                                                   S01486
     C                     EXSR ZACCR                                     S01486
     C/COPY WNCPYSRC,SE4860C061
      *                                                                   S01486
      ** ADD THE ACCRUED INTEREST ZACCRD FROM ZACCR TO THE TOTAL          S01486
      ** ACCRUED INTEREST ZTOAI                                           S01486
     C                     ADD  ZACCRD    ZTOAI                           S01486
      *                                                                   S01486
      ** ADD THE NUMBER OF DAYS ZDDAYS FROM ZACCR TO THE TOTAL NUMBER     S01486
      ** OF INTEREST DAYS ZTOND                                           S01486
     C                     ADD  ZDDAYS    ZTOND                           S01486
      *                                                                   S01486
      ** SET THE START OF INTEREST PERIOD DATE ZSDATE EQUAL TO THE        S01486
      ** EVENT DATE SDED FROM LF/SEEVNT                                   S01486
     C                     Z-ADDSDED      ZSDATE                          S01486
      *                                                                   S01486
      ** SET THE FOLLOWING FIELDS USED BY ZRATE AS FOLLOWS:               S01486
      ** SET ZCPNR EQUAL TO SDNC FROM LF/SEEVNT                           S01486
      ** SET ZCFCT EQUAL TO SDCP FROM LF/SEEVNT                           S01486
      ** SET ZPPCP EQUAL TO SDTP FROM LF/SEEVNT                           S01486
     C                     Z-ADDSDNC      ZCPNR                           S01486
     C                     Z-ADDSDCP      ZCFCT                           S01486
     C                     MOVE SDTP      ZPPCP                           S01486
      *                                                                   S01486
      ** READ EQUAL FROM LF/SEEVNT WITH THE SECURITY SHORTNAME ZSSNM      S01486
     C           ZSSNM     READESEEVNT                   91               S01486
      *                                                                   S01486
      ** READ UNTIL THE EVENT HAS AN EVENT TYPE SDET EQUAL TO 'PP' 'MP' OR 'IR'
      *                                                                   S01486
     C           *IN91     DOWEQ'0'                                       S01486
     C           SDET      ANDNE'PP'                                      S01486
     C           SDET      ANDNE'MP'                                      S01486
     C           SDET      ANDNE'IR'                                      S01486
     C           ZSSNM     READESEEVNT                   91               S01486
     C                     END                                            S01486
      *                                                                   S01486
      ** ELSE, IF EVENT DATE SDED FROM LF/SEEVNT IS GREATER THAN OR       S01486
      ** EQUAL TO TO DATE PARAMETER, TREAT AS END OF FILE ON LF/SEEVNT    S01486
     C                     ELSE                                           S01486
     C           SDED      IFGE ZTODAT                                    S01486
     C                     MOVE '1'       *IN91                           S01486
     C                     END                                            S01486
      *                                                                   S01486
     C                     END                                            S01486
     C                     END                                            S01486
      *                                                                   S01486
      ***IF*NOT*END*OF*FILE ON LF/PMAPOSLL                         S01486 189942
      ** IF NOT END OF FILE ON LF/SECDEPL5                                189942
     C           *IN92     IFEQ '0'                                       S01486
      *                                                                   S01486
      ** IF NOT END OF FILE ON LF/SEEVNT AND THE POSITION DATE FROM       S01486
      ***LF/PMAPOSLL*IS*LESS THAN THE EVENT DATE SDED FROM         S01486 189942
      ** LF/SECDEPL5 IS LESS THAN THE EVENT DATE SDED FROM                189942
      ** LF/SEEVNT OR END OF FILE ON LF/SEEVNT                            S01486
     C           *IN91     IFEQ '0'                                       S01486
     C           DDTE      ANDLTSDED                                      189942
     C           DDTE      ANDLTZTODAT                                    189942
     C           *IN91     OREQ '1'                                       S01486
     C           DDTE      ANDLTZTODAT                                    189942
      *                                                                   S01486
      ** SET THE END OF INTEREST PERIOD DATE ZEDATE EQUAL TO THE          S01486
      ** POSITION DATE DDTE FROM LF/SECDEPL5                              189942
     C                     Z-ADDDDTE      ZEDATE                          189942
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZRATE TO GET THE EFFECTIVE           S01486
      ** INTEREST RATE FOR THE PERIOD                                     S01486
     C                     EXSR ZRATE                                     S01486
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZACCR TO CALCULATE THE INTEREST      S01486
      ** FOR THE PERIOD                                                   S01486
     C                     EXSR ZACCR                                     S01486
     C/COPY WNCPYSRC,SE4860C062
      *                                                                   S01486
      ** ADD THE ACCRUED INTEREST ZACCRD FROM ZACCR TO THE TOTAL          S01486
      ** ACCRUED INTEREST ZTOAI                                           S01486
     C                     ADD  ZACCRD    ZTOAI                           S01486
      *                                                                   S01486
      ** ADD THE NUMBER OF DAYS ZDDAYS FROM ZACCR TO THE TOTAL NUMBER     S01486
      ** OF INTEREST DAYS ZTOND                                           S01486
     C                     ADD  ZDDAYS    ZTOND                           S01486
      *                                                                   S01486
      ** SET THE START OF INTEREST PERIOD DATE ZSDATE EQUAL TO THE        S01486
      ***POSITION*DATE*QAPDAT FROM LF/PMAPOSLL                     S01486 189942
      ** POSITION DATE DDTE   FROM LF/SECDEPL5                            189942
     C                     Z-ADDDDTE      ZSDATE                          189942
      *                                                                   S01486
      ** SUBTRACT THE EX-COUPON NOMINAL FROM THE NOMINAL (BOTH FROM       S01486
      ***LF/PMAPOSLL)*AND*PUT THE RESULT IN PRINCIPAL AMOUNT ZAMT  S01486 189942
      ** LF/SECDEPL5) AND PUT THE RESULT IN PRINCIPAL AMOUNT ZAMT         189942
     C           CDNV      SUB  CSEX      ZAMT                            189942
      *                                                                   S01486
      ** READ EQUAL FROM LF/SECDEPL5 WITH THE CUSTOMER XCUST, PORTFOLIO   189942
      ** ZPTRF, SECURITY ZSSNM AND TRADE/VALUE BASIS ZTVBS                S01486
     C           KPMA2     READESECDEPL5                 92               189942
      *                                                                   S01486
      ** ELSE, IF POSITION DATE DDTE FROM LF/SECDEPL5 IS GREATER THAN     189942
      ** OR EQUAL TO TO DATE PARAMETER, TREAT AS END OF FILE ON           S01486
      ** LF/SECDEPL5                                                      189942
     C                     ELSE                                           S01486
     C           DDTE      IFGE ZTODAT                                    189942
     C                     MOVE '1'       *IN92                           S01486
     C                     END                                            S01486
      *                                                                   S01486
     C                     END                                            S01486
     C                     END                                            S01486
     C                     END                                            S01486
      *                                                                   S01486
      ** SET THE END OF INTEREST PERIOD DATE ZEDATE EQUAL TO THE TO       S01486
      ** DATE ZTODAT                                                      S01486
     C                     Z-ADDZTODAT    ZEDATE                          S01486
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZRATE TO GET THE EFFECTIVE           S01486
      ** INTEREST RATE FOR THE PERIOD                                     S01486
     C                     EXSR ZRATE                                     S01486
      *                                                                   S01486
      ** EXECUTE STANDARD SUBROUTINE ZACCR TO CALCULATE THE INTEREST      S01486
      ** FOR THE PERIOD                                                   S01486
     C                     EXSR ZACCR                                     S01486
     C/COPY WNCPYSRC,SE4860C063
      *                                                                   S01486
      ** ADD THE ACCRUED INTEREST ZACCRD FROM ZACCR TO THE TOTAL          S01486
      ** ACCRUED INTEREST ZTOAI                                           S01486
     C                     ADD  ZACCRD    ZTOAI                           S01486
     C*                                                                   S01486
      ** ADD THE NUMBER OF DAYS ZDDAYS FROM ZACCR TO THE TOTAL NUMBER     S01486
      ** OF INTEREST DAYS ZTOND                                           S01486
     C                     ADD  ZDDAYS    ZTOND                           S01486
      *                                                                   S01486
     C           EAISCH    ENDSR                                          S01486
      *****************************************************************   S01486
     C/COPY ZSRSRC,ZACCRZ1                                                S01486
     C/COPY ZSRSRC,ZRATEZ1                                                S01486
     C/COPY ZSRSRC,ZDYYRZ3                                                S01486
     C/COPY ZSRSRC,ZDAYSZ2                                                S01486
     C/COPY ZSRSRC,ZDATE1Z2                                               S01486
     C/COPY ZSRSRC,ZDATE2Z2                                               S01486
     C/COPY ZSRSRC,ZLCDZ1                                                 S01486
      /EJECT                                                              S01509
     C/COPY ZSRSRC,ZHASHZ3
      /EJECT
     C/COPY ZSRSRC,ZICD2Z1
      /EJECT
     C/COPY ZSRSRC,ZICDSEZ1
      /EJECT
     C/COPY ZSRSRC,ZSYSTMZ1
      /EJECT
      * *XRATEsubroutine now redundant                                    E23169
     C/COPY ZSRSRC,ZXRATEZ1                                               S01446
     C/COPY WNCPYSRC,SE4860C064
      /EJECT
      ***
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  POWER - Array of powers for currency conversion
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)                      S01486
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN                      S01486
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR                        S01486
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES                                            S01486
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
