      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas DL Dealing forward rate calculation')
      *****************************************************************
      *                                                               *
      *  Midas - FRA/IRS Module                                       *
      *                                                               *
      ***DLZFWR*-*DEALING*FORWARD*RATE*CALCULATION*********************   LUC109
      *  XXDLLZFWR - Midas XX Dealing Fwd Rate Calculation            *   LUC109
      *                                                               *
      ***(c)*Misys*International*Banking*Systems*Ltd.*2001*************   LUC109
      *  (c) Finastra International Limited 2016                      *   LUC109
      *                                                               *
      * *** THIS PROGRAM MUST BE COMPILED WITH XXINTFLIB AT THE TOP   *   LUC109
      * OF LIBL ***                                                   *   LUC109
      *                                                               *
      *  Last Amend No. LUC109             Date 23Oct16               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 247544             Date 16May07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CIR013             Date 25Apr05               *
      *                 228543             Date 31Aug04               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAS001             Date 23Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 182370             Date 05Jun01               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 100317             Date 13Mar96               *
      *                 CIR001             Date 13Jun95               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  LUC109 - HO Reporting (Upgrade to FBM 2.1)                   *
      *  247544 - Increase definition of W@NLP2 to match w/ ZINTDYZ2  *
      *           processing as amended by 242286.  (Recompile)       *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZCBDYS.                              *
      *  228543 - Rounding off error for the interest rate            *
      *  CAS001 - Net Present Value (NPV) Accounting                  *
      *  182370 - Incorrect calculation of number of days for calcu-  *
      *           lation basis 6. Amended /COPY such that for calcu-  *
      *           lation basis 6, the number of days per year is      *
      *           equal to 366 when the year in question is a leap    *
      *           year, and 365 days/year for non-leap years. Calcu-  *
      *           lation was made so that processing would be in-line *
      *           with that of /COPY ZINTDY.                          *
      *  CIR004 - Dealing Calculation Method Change (Recompiled due   *
      *           change in ZCBDYSZ1)                                 *
     F*  100317 - The straight-line method of interpolating discount  *
     F*           factors using SR/ZINTPL did not provide satisfatory *
     F*           results. As the discount factors curve is           *
     F*           exponential, an PL1 program (ZEXPIN) is used to     *
     F*           perform an exponential interpolation. This program  *
     F*           has been amended to calculate the currency spot     *
     F*           date and pass it on to PGM/DLZNPV.                  *
     F*  CIR001 - Interest Rate Calendars                             *
     F*                                                               *
     F*****************************************************************
     FSDCURRL1IF  E           K        DISK                               LUC109
      *----------------------------------------------------------------
      * ID  F  C  H  L    FUNCTION OF INDICATORS
      *
      *       90-99       STANDARD SUBROUTINES
      *----------------------------------------------------------------
      /SPACE 5
     E                    CPY@    1   1 80
     E                    ZF29   14  32  5 0
     E                    ZYDY    4   4  4 0
     E                    ZMDY   13  13  3 0
     E                    ZMNM   12  12  3
     E/COPY ZSRSRC,ZDATE9Z1                                               182370
      /SPACE 5
     ISDCURR    E DSSDCURRPD
      * CURRENCY DETAILS ACCESSED VIA ACCESS PROGRAM
     IDSSDY     E DSDSSDY
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE
      *                                                                   182370
      ** Data structure for subroutine ZCBDYS                             182370
     I            DS                                                      182370
     I                                        1   80ZZDAT1                182370
     I                                        1   40ZZYYA                 182370
     I                                        5   60ZZMMA                 182370
     I                                        7   80ZZDDA                 182370
      *                                                                   182370
     I            DS                                                      182370
     I                                        1   80ZZDAT2                182370
     I                                        1   40ZZYYB                 182370
     I                                        5   60ZZMMB                 182370
     I                                        7   80ZZDDB                 182370
      *                                                                   182370
     I/COPY ZSRSRC,ZDATE9Z2                                               182370
     I/COPY ZSRSRC,ZDAT10Z1                                               182370
      /SPACE 5
     C**************************************************************************
     C                     MOVEACPY@      BIS@   80
      *
     C           *ENTRY    PLIST
     C                     PARM           ZFWRTC  5
     C                     PARM           ZFWCCY  3        * CURRENCY
     C                     PARM           ZFWINC  1        * INT.CALC.METH.
     C                     PARM           ZFWSDT  50       * SPOT DATE    100317
     C                     PARM           ZFWNDT  50       * NEXT DATE
     C                     PARM           ZFWFDT  50       * FAR DATE
     C                     PARM           ZFWOUT 117
     C                     PARM           ZFYLDC  5                                           CAS001
      *
      ***  Initialise fields.
      *
     C                     Z-ADD0         ZFWOUT
     C*
     C                     MOVE '0'       *IN98
     C*
     C** On change of currency
     C** Read currency file for default interest calculation method
     C*
     C           ZFWCCY    IFNE @CCY
     C           ZFWCCY    CHAINSDCURRL1             20                   LUC109
     C           *IN20     IFEQ *ON                                       LUC109
     C                     EXSR *PSSR                                     LUC109
     C                     ENDIF                                          LUC109
     C                     MOVELZFWCCY    @CCY    3
     C**********           CALL 'AOCURRR0'                                LUC109
     C**********           PARM '*MSG    '@RTCD   7                       LUC109
     C**********           PARM '*KEY    '@OPTN   7                       LUC109
     C**********           PARM           @CCY                            LUC109
     C********** SDCURR    PARM SDCURR    DSSDY                           LUC109
     C********** @RTCD     IFNE *BLANK                                    LUC109
     C**********           EXSR *PSSR                                     LUC109
     C**********           END                                            LUC109
     C                     END
     C*
     C** IF INTEREST CALCULATION METHOD NOT PRESENT, USE CURRENCY DEFAULT
     C*
     C           ZFWINC    IFEQ ' '
     C           ZFWINC    OREQ '0'
     C                     MOVELA6DICB    ZFWINC
     C                     END
     C*
     C** CALCULATE DISCOUNT FACTOR AS AT NEAR DATE
     C*
     C**********           Z-ADDZFWNDT    ZNPSDT                          100317
     C                     Z-ADDZFWNDT    ZNPFDT
     C                     EXSR CALDF
     C                     Z-ADDZNPDF     ZFWNEA 119H
     C*
     C** CALCULATE DISCOUNT FACTOR AS AT FAR DATE
     C*
     C**********           Z-ADDZFWFDT    ZNPSDT                          100317
     C                     Z-ADDZFWFDT    ZNPFDT
     C                     EXSR CALDF
     C                     Z-ADDZNPDF     ZFWFAR 119H
     C*
     C** Calculate the number of days/divisor basis
     C** from near date to far date
     C*
     C                     Z-ADDZFWNDT    ZCBSDT
     C                     Z-ADDZFWFDT    ZCBEDT
     C                     MOVELZFWINC    ZCBCBS
     C                     EXSR ZCBDYS
     C*
     C** FORWARD RATE = {(NEAR DISCOUNT FACTOR/FAR DISCOUNT FACTOR) - 1}
     C**                X DIVISOR BASIS / DAY BASIS
     C*
     C           ZFWFAR    IFNE *ZERO
     C           ZFWNEA    DIV  ZFWFAR    ZFWWRK 219H
     C                     SUB  1         ZFWWRK
     C                     ELSE
     C                     Z-ADD*ZERO     ZFWWRK
     C                     END
      *
     C**********           MULT ZCBDIV    ZFWWRK                                              228543
     C                     MULT ZCBDIV    ZFWWRK    H                                         228543
     C                     MULT 100       ZFWWRK
      *
     C           ZCBDAY    IFNE *ZERO
     C**********           DIV  ZCBDAY    ZFWWRK                                              228543
     C                     DIV  ZCBDAY    ZFWWRK    H                                         228543
     C                     ELSE
     C                     Z-ADD*ZERO     ZFWWRK
     C                     END
      *
      ** OUTPUT FORWARD RATE
      *
     C                     Z-ADDZFWWRK    ZFWOUT
      *
     C                     RETRN
      *
     C**************************************************************************
      /SPACE 5
     C********************************************************************
     C* CALCULATE DISCOUNT FACTOR
     C********************************************************************
     C           CALDF     BEGSR
     C                     CALL 'DLZNPV'
     C                     PARM *BLANK    ZNPRTC  5
     C                     PARM ZFWCCY    ZNPCCY  3        * CURRENCY
     C                     PARM ZFWINC    ZNPINC  1        * INT.CALC.METH.
     C**********           PARM           ZNPSDT  50       * SPOT DATE    100317
     C                     PARM ZFWSDT    ZNPSDT  50       * SPOT DATE    100317
     C                     PARM           ZNPFDT  50       * FORWARD DATE
     C                     PARM *ZERO     ZNPAMT 130       * AMOUNT
     C                     PARM *ZERO     ZNPRAT 117
     C**********           PARM *ZERO     ZNPDF  119                                          CAS001
     C                     PARM *ZERO     ZNPDF  139                                          CAS001
     C                     PARM *ZERO     ZNPOUT 130
     C                     PARM           ZFYLDC                                              CAS001
     C*
     C           ZNPRTC    IFEQ '*ERR*'
     C                     EXSR *PSSR
     C                     END
     C*
     C           ZNPRTC    IFEQ '*NRCD'
     C                     MOVEL'*NRCD'   ZFWRTC
     C                     END
     C*
     C                     ENDSR
     C**************************************************************************
      /SPACE 5
     C**************************************************************************
     C           *PSSR     BEGSR
     C           ZFWRTC    IFEQ *BLANK
     C                     MOVE '*ERR*'   ZFWRTC
     C                     DUMP
     C                     SETON                     LR
     C                     RETRN
     C                     END
     C                     ENDSR
     C********************************************************************
     C/COPY ZSRSRC,ZCBDYSZ1
     C/COPY ZSRSRC,ZDATE2Z2
     C/COPY ZSRSRC,ZDATE9Z3                                               182370
     C/COPY ZSRSRC,ZDAT10Z2                                               182370
**  CPY@
(c) Finastra International Limited 2016
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE IN FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
     X/COPY ZSRSRC,ZDATE9Z4                                               182370
